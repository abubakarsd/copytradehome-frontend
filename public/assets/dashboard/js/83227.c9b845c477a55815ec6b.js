(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[83227,75635,41679],{521481:e=>{e.exports={screen:"screen-otjoFNF2",fade:"fade-otjoFNF2",screenfade:"screenfade-otjoFNF2"}},415555:e=>{e.exports={}},308225:e=>{e.exports={css_value_currency_label_radius:"4",css_wrapper_margin:"4",css_row_left_right_padding:"3",css_fade_height:"10","price-axis-currency-label-wrapper":"price-axis-currency-label-wrapper-y5H41VPj",hidden:"hidden-y5H41VPj","price-axis-currency-label":"price-axis-currency-label-y5H41VPj",row:"row-y5H41VPj",expanded:"expanded-y5H41VPj","price-axis-currency-label-arrow-down":"price-axis-currency-label-arrow-down-y5H41VPj","price-axis-currency-label-text":"price-axis-currency-label-text-y5H41VPj"}},846013:e=>{e.exports={}},717189:e=>{e.exports={}},644329:e=>{e.exports={"css-value-chart-controls-bar-height-with-border":"39px","css-value-chart-controls-bar-border":"1px"}},173251:e=>{e.exports={css_value_chart_gui_wrapper_column_gap:"4"}},93061:(e,t,i)=>{"use strict";i.d(t,{TOAST_ANIMATION_DURATION:()=>s});const s=500},859217:(e,t,i)=>{"use strict";i.d(t,{getSetToastUserActivityBasedRemovalTimeout:()=>r});var s=i(654233);function o(e,t){const i=new Set,o=new s.WatchedValue("hidden"!==document.visibilityState),r=t?.timers||{setTimeout,clearTimeout},n=r.setTimeout,a=r.clearTimeout;let l;const c=t?.ignoreVisibilityChange;o.subscribe((e=>{i.forEach((t=>t(!!e)))}),{callWithLast:!0});const h=()=>{o.setValue(!0),a(l),l=n((()=>{o.setValue(!1)}),e)},d=()=>{"hidden"===document.visibilityState?o.setValue(!1):h()};return{subscribe:t=>{i.size>0||(a(l),l=n((()=>{o.setValue(!1)}),e),document.addEventListener("click",h,{passive:!0}),document.addEventListener("mousemove",h,{passive:!0}),document.addEventListener("keydown",h,{passive:!0}),document.addEventListener("touchstart",h,{passive:!0}),document.addEventListener("wheel",h,{passive:!0}),c||document.addEventListener("visibilitychange",d,{passive:!0})),i.add(t)},unsubscribe:e=>{i.delete(e),0===i.size&&(document.removeEventListener("click",h),document.removeEventListener("mousemove",h),document.removeEventListener("keydown",h),document.removeEventListener("touchstart",h),document.removeEventListener("wheel",h),c||document.removeEventListener("visibilitychange",d),a(l))},value:()=>!!o.value()}}function r(e,t,i,s){const r=o(i);return function(i,o=2e4){const{start:n,reset:a}=function(e,t){let i;return{start:()=>{i=setTimeout(e,t)},reset:()=>{clearTimeout(i),i=void 0}}}((()=>{e.removeToast(i,s)}),o),l=()=>{const e=r.value(),i=t.value;e&&!i?n():a()};r.subscribe(l),l();const c=t.subscribe(l),h=e.subscribeOnToast(i,(e=>{"RemoveAnimationStart"===e.type&&(a(),h(),r.unsubscribe(l),c())}))}}},111516:(e,t,i)=>{"use strict";i.d(t,{isSignedExchangeAgreement:()=>a,saveExchangeAgreement:()=>r});var s=i(131890),o=i(915503);function r(e){return(0,s.fetch)("/exchange-agreement/",{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(e)}).then((e=>e.ok?e.json():e.json().then((t=>{throw new o.AggregateError((0,o.accumulateErrors)(t.errors,e.status))}))))}
const n={};async function a(e){let t="/is-signed-exchange-agreement/";if(e.exchange&&(t+=`?exchange=${e.exchange}`,n[e.exchange]))return n[e.exchange];const i=await(0,s.fetch)(t);if(!i.ok){const e=await i.json();throw Error(e.detail)}const o=await i.json();return e.exchange&&(n[e.exchange]=o),o}},990221:(e,t,i)=>{"use strict";i.d(t,{ResizerDetacherState:()=>r});var s=i(185842),o=i(168509);class r{constructor(e){this._alive=new o.WatchedValue,this._container=new o.WatchedValue,this._width=new o.WatchedValue,this._height=new o.WatchedValue,this._fullscreen=new o.WatchedValue,this._detachable=new o.WatchedValue,this._fullscreenable=new o.WatchedValue,this._visible=new o.WatchedValue,this._availWidth=new o.WatchedValue,this._availHeight=new o.WatchedValue,this._owner=new o.WatchedValue,this._ownersStack=[],this.owner=this._owner.readonly(),this._bridge={alive:this._alive.readonly(),container:this._container.readonly(),width:this._width.readonly(),height:this._height.readonly(),fullscreen:this._fullscreen.readonly(),detachable:this._detachable.readonly(),fullscreenable:this._fullscreenable.readonly(),visible:this._visible.readonly(),availWidth:this._availWidth.readonly(),availHeight:this._availHeight.readonly(),remove:()=>{const e=this._owner.value();e&&e.remove&&e.remove()},negotiateWidth:e=>{const t=this._owner.value();t&&t.negotiateWidth&&t.negotiateWidth(e)},negotiateHeight:e=>{const t=this._owner.value();t&&t.negotiateHeight&&t.negotiateHeight(e)},requestFullscreen:()=>{const e=this._owner.value();e&&e.requestFullscreen&&e.requestFullscreen()},exitFullscreen:()=>{const e=this._owner.value();e&&e.exitFullscreen&&e.exitFullscreen()},detach:e=>{const t=this._owner.value();t&&t.detach&&t.detach(e)},attach:()=>{const e=this._owner.value();e&&e.attach&&e.attach()}},e&&this.pushOwner(e)}destroy(){for(const e of this._ownersStack)this._unsubscribeOwner(e)}bridge(){return this._bridge}pushOwner(e){if(!e.alive.value())return;for(const e of this._ownersStack)this._unsubscribeOwner(e);const t={owner:e};this._ownersStack.push(t),this._subscribeOwner(t)}_subscribeOwner(e){const t=e.owner;if(e.deathWatcher||(this._alive.setValue(!0),e.deathWatcher=t.alive.spawn(),e.deathWatcher.subscribe((t=>{t||this._deadHandler(e)}))),this._owner.setValue(t),!e.subscriptions){const i=e.subscriptions=[];this._visible.setValue(!1);const s=(e,t)=>{if(e){const s=e.spawn();i.push(s),s.subscribe((e=>{t.setValue(e)}),{callWithLast:!0})}else t.deleteValue()};s(t.container,this._container),s(t.width,this._width),s(t.height,this._height),s(t.fullscreen,this._fullscreen),s(t.detachable,this._detachable),s(t.fullscreenable,this._fullscreenable),s(t.availWidth,this._availWidth),s(t.availHeight,this._availHeight),s(t.visible,this._visible)}}_unsubscribeOwner(e,t){if(e.subscriptions){for(const t of e.subscriptions)t.unsubscribe();e.subscriptions=null}t&&e.deathWatcher&&(e.deathWatcher.unsubscribe(),e.deathWatcher=null)}_deadHandler(e){const t=this._ownersStack.indexOf(e);(0,s.assert)(-1!==t,"sanitized owner should be in stack")
;for(let e=this._ownersStack.length-1;e>=t;e--)this._unsubscribeOwner(this._ownersStack[e],!0);this._ownersStack.length=t,t>0?this._subscribeOwner(this._ownersStack[t-1]):(this._alive.setValue(!1),this._owner.deleteValue())}}},284133:(e,t,i)=>{"use strict";i.d(t,{VisibilityApi:()=>o});var s=i(168509);class o{constructor(e){let t;this.isVisible=new s.WatchedValue(!0);let i=null;for(const s of["","moz","ms","webkit"]){const o=s?`${s}Hidden`:"hidden";if(o in e){t=`${s}visibilitychange`,i=()=>{this.isVisible.setValue(!e[o])},i(),e.addEventListener(t,i,!1);break}}this.destroy=()=>{i&&(e.removeEventListener(t,i,!1),i=null)}}}},707597:(e,t,i)=>{"use strict";i.d(t,{CHART_WARNINIG_GROUP_ID:()=>a,showChartWarningNotification:()=>l});var s=i(100631),o=i(845887),r=i(361026);const n=1e4,a="chart_warning";function l(e,t){return new Promise((i=>{o.toastManager.addToast(e,a,t),(0,r.setToastUserActivityBasedRemovalTimeout)(e,n);const l=(0,s.subscribeOnToast)(e,(e=>{"Remove"!==e.type&&e.details!==r.CLOSE_DUE_TO_INACTIVITY_EVENT_DETAILS||(i(),l())}))}))}},100631:(e,t,i)=>{"use strict";i.d(t,{subscribeOnToast:()=>s});const s=i(845887).toastManager.subscribeOnToast},361026:(e,t,i)=>{"use strict";i.d(t,{CLOSE_DUE_TO_INACTIVITY_EVENT_DETAILS:()=>r,setToastUserActivityBasedRemovalTimeout:()=>n});var s=i(845887),o=i(859217);const r="userActivityTimeout",n=(0,o.getSetToastUserActivityBasedRemovalTimeout)(s.toastManager,s.toastUserInteractionStatus,15e3,r)},845887:(e,t,i)=>{"use strict";i.d(t,{toastManager:()=>o,toastUserInteractionStatus:()=>r});var s=i(93061);const o=function(){const e=new Set,t=new Map,i={groups:new Map};function o(e){const t=i.groups.get(e);if(t)return t;const s={id:e,list:new Map,added:new Set,removed:new Set};return i.groups.set(e,s),s}function r(e,s){t.delete(e),s.added.delete(e),s.removed.delete(e),s.list.delete(e),0===s.list.size?i.groups.delete(s.id):i.groups.set(s.id,{...s}),n({type:"Remove",toastId:e,groupId:s.id})}function n(t){i.groups=new Map(i.groups),e.forEach((e=>{e(t)}));const s=a.get(t.toastId);s&&s.forEach((e=>{e(t)}))}const a=new Map;return{addToast:function(e,s,r,a,l){if(t.get(e))return;const c=o(s);c.added.add(e);const h={id:e,...r,manualAnimationStart:l};c.list.set(e,h),t.set(e,s),i.groups.set(s,{...c}),n({type:"Add",toastId:e,groupId:s,data:r,details:a})},removeToast:function(e,o){const a=t.get(e);if(!a)return;const l=i.groups.get(a);l&&(l.removed.has(e)||(l.removed.add(e),i.groups.set(a,{...l}),n({type:"RemoveAnimationStart",toastId:e,groupId:a,details:o}),setTimeout((()=>{r(e,l)}),s.TOAST_ANIMATION_DURATION)))},removeGroup:function(e,t){const o=i.groups.get(e);if(!o)return;const a=[];o.list.forEach((i=>{const s=i.id;o.removed.has(s)||(a.push(s),o.removed.add(s),n({type:"RemoveAnimationStart",toastId:s,groupId:e,details:t}))})),i.groups.set(e,{...o}),setTimeout((()=>{a.forEach((e=>{r(e,o)}))}),s.TOAST_ANIMATION_DURATION)},startAddAnimation:function(e){const s=t.get(e);if(!s)return;const o=i.groups.get(s);o&&o.added.delete(e)&&(i.groups.set(s,{...o}),n({type:"AddAnimationStart",toastId:e,groupId:s}))
},subscribeOnToast:function(e,t){const i=function(e){const t=a.get(e);if(t)return t;const i=new Set;return a.set(e,i),i}(e);return i.add(t),()=>{i.delete(t),0===i.size&&a.delete(e)}},state:i,subscribe:function(t){return e.add(t),()=>{e.delete(t)}}}}(),r=function(){const e=new Set,t=new Set,i={update:function(s,o){s?t.add(o):t.delete(o);const r=t.size>0;i.value!==r&&(i.value=r,e.forEach((e=>{e(s)})))},value:!1,subscribe:function(t){return e.add(t),()=>{e.delete(t)}}};return i}()},524143:(e,t,i)=>{"use strict";async function s(){return(await Promise.all([i.e(25155),i.e(5709),i.e(22851),i.e(32387),i.e(28507)]).then(i.bind(i,826400))).ErrorCardRenderer}i.d(t,{getErrorCardRenderer:()=>s})},613092:(e,t,i)=>{"use strict";i.d(t,{trackTiming:()=>d});var s=i(246445),o=i(865392),r=i(598944),n=i(376596),a=i(982567);const l=()=>`https://www.googletagmanager.com/gtag/js?id=${(0,r.getInitData)().gaId}`;let c=!1;function h(){if(c||(0,n.isSymphonyEmbed)())return;(0,r.updateInitData)();const e=(0,r.getInitData)();if(!e.gaId)return void(window.gtag=()=>{});c=!0,(0,a.appendScript)(l()),window.dataLayer=window.dataLayer||[],window.gtag=function(){window.dataLayer.push(arguments)},window.gtag("js",new Date);const t={anonymize_ip:!0};window.TVD&&(t.app_name="TVD",t.app_version=(0,n.desktopAppVersion)()),e.gaVars&&window.gtag("set",e.gaVars),window.gtag("consent","default",{analytics_storage:(0,o.getCookieSetting)(o.CookieSettings.Analytics)?"granted":"denied"}),window.gtag("config",e.gaId,t),s.subscribe(o.cookieSettingsChangeEvent,((e,t)=>{e===o.CookieSettings.Analytics&&window.gtag("consent","update",{analytics_storage:t?"granted":"denied"})}),null)}function d(e,t,i,s){(0,n.isSymphonyEmbed)()||(h(),window.gtag("event","timing_complete",{name:t,value:i,event_category:e,event_label:s}))}},256990:(e,t,i)=>{"use strict";i.d(t,{getChartStorage:()=>g});var s=i(131890),o=i(123817),r=i(227719),n=i(254236),a=i(368203),l=i(312116),c=i(320542);function h(){const e=document.querySelector('link[rel~="chart-storage"]'),t=new URL(e?.href||"/charts-storage/",location.href);return t.pathname.endsWith("/")||(t.pathname+="/"),t}function d(e){const{charts:t={},countSourcesTotal:i=0,limitBytesTotal:s=0,sizeBytesTotal:o=0}=e,r=new Map;for(const[e,i]of Object.entries(t)){const{symbols:t={}}=i,s=new Map;for(const[e,{countSources:i,sizeBytes:o,ids:r}]of Object.entries(t))s.set(e,{countSources:i,sizeBytes:o,ids:r});r.set(e,s)}return{charts:r,countSourcesTotal:i,limitBytesTotal:s,sizeBytesTotal:o}}const u={sources:new Map,groups:new Map};class _{constructor(){this._lastSaveRequest=null,this._lastSharedToolsLoadingRequest=null,this._requestsCounter=0,this._layoutId=void 0}async saveLineToolsAndGroups(e,t,i,s,d){if(!_._checkLayoutId(e))throw new Error("Unnamed chart cannot be saved");this._cleanStateIfLayoutIdChanged(e);const u=`${e}.${t}.${this._requestsCounter++}`,m=`ChartStorage.Save.TotallyProcessing.${u}`,g=(0,r.perfMeasureOperation)(m,(async()=>{try{await this._lastSaveRequest}catch(e){}if(d?.aborted)throw(0,o.createAbortError)()
;const _=`ChartStorage.Save.GettingToken.${u}`,m=await(0,r.perfMeasureOperation)(_,(()=>(0,c.getStorageTarget)(e,t,s,d))),g=new URL(m.path,h());m.chartId&&g.searchParams.append("chart_id",m.chartId),g.searchParams.append("layout_id",e),g.searchParams.append("jwt",m.token);const S=`ChartStorage.Save.GettingResponse.${u}`;try{const r=await this._fetch(S,g,{method:"PUT",headers:{"Content-Type":"application/json","X-BUILD-TIME":window.BUILD_TIME},credentials:"include",signal:d,body:(0,l.stringifyLineToolsAndGroupsDTO)(i)});if(!r.ok){const e=429===r.status;throw new a.SavingLineToolsError(e,`Response status is not success: ${r.status}`)}const c=await p(r);if(d?.aborted)throw(0,o.createAbortError)();return n.telemetry.sendLineToolsStorageReport("line_tools_save_success"),{content:c,savedDto:i,layoutId:e,chartId:t,sharingMode:s,serverUpdateTime:1e3*c.serverUpdateTime}}catch(e){throw(0,o.isAbortError)(e)||n.telemetry.sendLineToolsStorageReport("line_tools_save_error"),e}}));return this._lastSaveRequest=g}async loadLineToolsAndGroups(e,t,i){if(!_._checkLayoutId(e))return u;this._cleanStateIfLayoutIdChanged(e);const s=`${e}.${t}.${i.requestType}.${this._requestsCounter++}`,o=`ChartStorage.Load.GettingToken.${s}`,a=await(0,r.perfMeasureOperation)(o,(()=>(0,c.getStorageTarget)(e,t,i.sharingMode))),d=new URL(`get/${a.path}`,h());switch(a.chartId&&d.searchParams.append("chart_id",a.chartId),d.searchParams.append("layout_id",e),d.searchParams.append("jwt",a.token),i.requestType){case"mainSeriesLineTools":d.searchParams.append("symbol",i.symbol),0===i.sharingMode&&d.searchParams.append("includeOwnerSource",i.seriesSourceId),d.searchParams.append("brokerName",i.brokerName);break;case"studiesLineTools":d.searchParams.append("excludeOwnerSource",i.seriesSourceId);break;case"lineToolsWithoutSymbol":d.searchParams.append("symbol",""),0===i.sharingMode&&d.searchParams.append("includeOwnerSource",i.seriesSourceId)}const p=0!==i.sharingMode&&!d.searchParams.get("symbol"),m=async()=>{if(p)try{await this._lastSharedToolsLoadingRequest}catch(e){}return this._fetchData(`ChartStorage.Load.GettingResponse.${s}`,d,{credentials:"include"})};try{const[e,t]=await(p?this._lastSharedToolsLoadingRequest=m():m());return n.telemetry.sendLineToolsStorageReport("line_tools_load_success"),(0,l.parseLineToolsAndGroupsDTO)(e||{},t)}catch(e){throw n.telemetry.sendLineToolsStorageReport("line_tools_load_error"),e}}async removeLineTools(e,t,i,s){if(!_._checkLayoutId(e))return!1;this._cleanStateIfLayoutIdChanged(e);const o=`${e}.${t}.${this._requestsCounter++}`,a=`ChartStorage.Remove.GettingToken.${o}`,l=await(0,r.perfMeasureOperation)(a,(()=>(0,c.getStorageTarget)(e,t,i))),d=new URL(l.path,h());l.chartId&&d.searchParams.append("chart_id",l.chartId),d.searchParams.append("layout_id",e),d.searchParams.append("symbol",s),d.searchParams.append("jwt",l.token);try{return await this._fetchData(`ChartStorage.Remove.GettingResponse.${o}`,d,{method:"DELETE",credentials:"include"}),n.telemetry.sendLineToolsStorageReport("line_tools_remove_by_symbol_success"),!0}catch(e){
throw n.telemetry.sendLineToolsStorageReport("line_tools_remove_by_symbol_error"),e}}async getLayoutDrawingsSizeInfo(e,t){if(!_._checkLayoutId(e))return{charts:new Map,countSourcesTotal:0,limitBytesTotal:0,sizeBytesTotal:0};this._cleanStateIfLayoutIdChanged(e);const i=`${e}.${t}.${this._requestsCounter++}`,s=`ChartStorage.GetSizes.GettingToken.${i}`,o=await(0,r.perfMeasureOperation)(s,(()=>(0,c.getStorageTarget)(e,t,0))),a=new URL(`layout/${e}/sizes`,h());a.searchParams.append("layout_id",e),a.searchParams.append("jwt",o.token);try{const[e]=await this._fetchData(`ChartStorage.GetSizes.GettingResponse.${i}`,a,{credentials:"include"});return n.telemetry.sendLineToolsStorageReport("line_tools_size_info_success"),d(e||{})}catch(e){throw n.telemetry.sendLineToolsStorageReport("line_tools_size_info_error"),e}}async getUserGlobalDrawingsSizeInfo(e){if(!_._checkLayoutId(e))return{charts:new Map,countSourcesTotal:0,limitBytesTotal:0,sizeBytesTotal:0};this._cleanStateIfLayoutIdChanged(e);const t=this._requestsCounter++,i=await(0,r.perfMeasureOperation)(`ChartStorage.GetGlobalSizes.GettingToken.${t}`,(()=>(0,c.getStorageTarget)(e,"",2))),s=new URL("user/sizes",h());s.searchParams.append("layout_id",e),s.searchParams.append("jwt",i.token);try{const[e]=await this._fetchData(`ChartStorage.GetGlobalSizes.GettingResponse.${t}`,s,{credentials:"include"});return n.telemetry.sendLineToolsStorageReport("global_line_tools_size_info_success"),d(e||{})}catch(e){throw n.telemetry.sendLineToolsStorageReport("global_line_tools_size_info_error"),e}}async _fetchData(e,t,i){const s=await this._fetch(e,t,i);if(!s.ok)throw new Error("Response status is not success");return[await p(s),s.headers.get("X-Request-Id")]}_fetch(e,t,i){return(0,r.perfMeasureOperation)(e,(()=>(0,s.fetch)(t.toString(),i)))}_cleanStateIfLayoutIdChanged(e){this._layoutId!==e&&(this._layoutId=e,this._lastSaveRequest=null,this._lastSharedToolsLoadingRequest=null)}static _checkLayoutId(e){return void 0!==e&&e.length>0}}async function p(e){const t=await e.json();if(null===t)throw new Error("Body is null");if(!t.success)throw new Error("Response is not success");return t.payload}let m=null;async function g(){return null===m&&(m=new _),m}},312116:(e,t,i)=>{"use strict";function s(e){const t={};return e.sources&&(t.sources={},e.sources.forEach(((e,i)=>{t.sources[i]=e}))),t.drawing_groups={},e.groups.forEach(((e,i)=>{t.drawing_groups[i]=e})),t.clientId=e.clientId,JSON.stringify(t)}function o(e,t){const i={sources:null,groups:new Map};if(null!==e.sources){i.sources=new Map;for(const t in e.sources||{}){const s=e.sources[t];i.sources.set(t,s)}}for(const t in e.drawing_groups||{}){const s=e.drawing_groups[t];i.groups.set(t,s)}return null!==t&&(i.serverRequestId=t),i.clientId=e.clientId,i.symbol=e.symbol,i}i.d(t,{parseLineToolsAndGroupsDTO:()=>o,stringifyLineToolsAndGroupsDTO:()=>s})},368203:(e,t,i)=>{"use strict";i.d(t,{SavingLineToolsError:()=>s});class s extends Error{constructor(e,t){super(t),this.shouldBeCooled=e}}Error},320542:(e,t,i)=>{"use strict";i.d(t,{getStorageTarget:()=>l,
globallySharedChartId:()=>a,sharedChartId:()=>n});var s=i(131890),o=i(254236),r=i(123817);const n="_shared",a="UserSync";async function l(e,t,i,a){try{const l=new URL("/chart-token/",location.href);l.searchParams.append("image_url",e),l.searchParams.append("user_id",String(window.user.id||-1));const c=await(0,s.fetch)(l.toString(),{signal:a});if(!c.ok)throw new Error(`Http response is not ok: ${c.status}}`);const h=await c.json();if(o.telemetry.sendLineToolsStorageReport("line_tools_token_request_success"),a?.aborted)throw(0,r.createAbortError)();const d=2===i?void 0:1===i?n:t;return{token:h.token,chartId:d,path:2===i?"user/sources":`layout/${e}/sources`}}catch(e){throw(0,r.isAbortError)(e)||o.telemetry.sendLineToolsStorageReport("line_tools_token_request_error"),e}}},753880:(e,t,i)=>{"use strict";i.d(t,{desktopVersionIsLess:()=>n,lessThan:()=>r});var s=i(376596);function o(e){const t=e.match(/^(\d+).(\d+).(\d+)/);if(!t)return null;const[,i,s,o]=t;return[parseInt(i),parseInt(s),parseInt(o)]}function r(e,t){const i=o(e),s=o(t);if(!i||!s)return!1;const[r,n,a]=i,[l,c,h]=s;return r!==l?r<l:n!==c?n<c:a!==h&&a<h}function n(e){const t=(0,s.desktopAppVersion)();return!!t&&r(t,e)}},305458:(e,t,i)=>{"use strict";i.d(t,{FeatureToggleWatchedValue:()=>r});var s=i(788312),o=i(168509);class r extends o.WatchedValue{constructor(e,t){super(function(e){return(0,s.isFeatureEnabled)(e)}(e)),(0,s.onFeaturesStateChanged)().subscribe(this,(t=>{e===t&&this.setValue((0,s.isFeatureEnabled)(e))}))}destroy(){(0,s.onFeaturesStateChanged)().unsubscribeAll(this),super.destroy()}}},913884:(e,t,i)=>{"use strict";i.d(t,{isNativeUIInteraction:()=>s.isNativeUIInteraction,isTextEditingField:()=>s.isTextEditingField});var s=i(252938)},449616:(e,t,i)=>{"use strict";i.d(t,{breakpoints:()=>s,mobileFirstBreakpoints:()=>o,mobileFirstLegacyBreakpoints:()=>r});const s={desktop:1/0,desktopHd:1919,phone:767,"phone-vertical":479,tablet:1019},o={base:0,"media-mf-phone-vertical":320,"media-mf-phone-landscape":568,"media-mf-tablet-vertical":768,"media-mf-tablet-landscape":1024,"media-mf-laptop":1280,"media-mf-desktop-medium":1440,"media-mf-desktop-large":1920,"media-mf-desktop-extra-large":2560},r={"media-mf-legacy-phone-vertical":330,"media-mf-legacy-phone":480,"media-mf-legacy-notebook":1020,"media-mf-legacy-desktop-medium":1480,"media-mf-legacy-desktop":1531}},499540:(e,t,i)=>{"use strict";i.d(t,{getCSSProperty:()=>a,getCSSPropertyNumericValue:()=>l,getContentWidth:()=>r,getScrollbarWidth:()=>s,matchMediaMinMax:()=>o,setStyle:()=>n});const s=(()=>{let e;return()=>{if(void 0===e){const t=document.createElement("div"),i=t.style;i.visibility="hidden",i.width="100px",i.msOverflowStyle="scrollbar",document.body.appendChild(t);const s=t.offsetWidth;t.style.overflow="scroll";const o=document.createElement("div");o.style.width="100%",t.appendChild(o);const r=o.offsetWidth;t.parentNode?.removeChild(t),e=s-r}return e}})();function o(e,t){return t===1/0?window.matchMedia(`(min-width: ${e}px)`):window.matchMedia(`(min-width: ${e}px) and (max-width: ${t}px)`)}function r(e){
return l(e,"width")-l(e,"padding-left")-l(e,"padding-right")}function n(e,t,i){null!==e&&e.style.setProperty(t,i)}function a(e,t){return getComputedStyle(e,null).getPropertyValue(t)}function l(e,t){return parseInt(a(e,t))}},389960:(e,t,i)=>{"use strict";i.d(t,{mediaState:()=>c});var s=i(527323),o=i.n(s),r=i(539424),n=i(449616),a=i(499540);class l extends(o()){constructor(){super(),this.width=0,this.height=0,this.device=null,this.breakpoints=n.breakpoints,this._checkDevice(),window.addEventListener("resize",this._checkDevice),Object.entries(n.breakpoints).sort((([e,t],[i,s])=>t-s)).forEach((([e,t],i,s)=>{let o;if(0!==i){const[,e]=s[i-1];o=e+1}else o=0;const r=(0,a.matchMediaMinMax)(o,t);r.matches&&this._setNewDevice(e),r.addEventListener("change",(t=>{t.matches&&(this._checkDevice(),this._setNewDevice(e))}))})),(0,r.whenDocumentReady)(this._checkDevice.bind(this)),this.isPhoneSizeDevice.bind(this)}isPhoneSizeDevice(){return"phone"===this.device||"phone-vertical"===this.device}_checkDevice(){this.width=window.innerWidth,this.height=window.innerHeight}_setNewDevice(e){const t=this.device;this.device=e,this.trigger("changeDevice",[e,t])}}const c=new l},227719:(e,t,i)=>{"use strict";i.d(t,{addPerfMark:()=>c,perfMeasureOperation:()=>h});var s=i(584104);function o(){}const r=console.timeStamp?console.timeStamp.bind(console):o,n=window.performance&&performance.mark?performance.mark.bind(performance):o,a=window.performance&&performance.measure?performance.measure.bind(performance):o,l=window.performance&&performance.clearMarks?performance.clearMarks.bind(performance):o;function c(e){r(e),n(e)}async function h(e,t){const i=`measure-${e}-${(0,s.randomHash)()}`;n(i);try{return await t()}finally{a(e,i),l(i)}}},17147:(e,t,i)=>{"use strict";i.d(t,{trackStudies:()=>n});var s=i(196806),o=i(127985),r=i(637581);function n(e,t,i,n){const a=!e.isPine()||e.isStandardPine()?e.description??e.name:e.scriptIdPart,l=e.productId,c=o.StudyMetaInfo.isScriptStrategy(e),h=window.user&&window.user.pro_plan||"",d=t.studiesWV().value().length+t.allLineTools().filter(s.isStudyLineTool).length,u=t.chartApi().getStudyCounter(),_=e.isPine()?e.scriptIdPart:e.id;(0,r.getTracker)().then((e=>{e&&e.trackStudiesAnalytics(a,l,i,c,d,u,n??null,_,h)}))}},257637:(e,t,i)=>{"use strict";i.d(t,{DEFAULT_THEME:()=>s});const s="light"},591688:(e,t,i)=>{"use strict";i.d(t,{themes:()=>a});var s=i(645303),o=i(729193)
;const r=JSON.parse('{"color-header-bg":"color-black","color-body-bg":"color-black","color-body-secondary-bg":"color-cold-gray-900","color-bg-primary":"color-cold-gray-850","color-bg-primary-hover":"color-cold-gray-800","color-bg-secondary":"color-cold-gray-900","color-bg-highlight":"color-cold-gray-900","color-bg-scroll-buttons":"color-cold-gray-800","color-legacy-bg-scroll-buttons":"color-cold-gray-550","color-legacy-bg-widget":"color-cold-gray-900","color-text-primary":"color-cold-gray-200","color-text-secondary":"color-cold-gray-450","color-text-tertiary":"color-cold-gray-400","color-text-disabled":"color-cold-gray-650","color-accent-content":"color-white","color-divider":"color-cold-gray-700","color-divider-hover":"color-cold-gray-800","color-divider-secondary":"color-cold-gray-800","color-box-shadow":"color-cold-gray-900","color-active-hover-text":"color-cold-gray-200","color-alert-text":"color-cold-gray-200","color-border":"color-cold-gray-750","color-border-chat-fields":"color-cold-gray-750","color-border-hover":"color-cold-gray-650","color-border-table":"color-cold-gray-800","color-brand":"color-tv-blue-500","color-brand-hover":"color-tv-blue-600","color-brand-active":"color-tv-blue-700","color-button-hover-bg":"color-cold-gray-850","color-chart-page-bg":"color-cold-gray-800","color-common-tooltip-bg":"color-cold-gray-750","color-danger":"color-ripe-red-600","color-danger-hover":"color-ripe-red-500","color-danger-active":"color-ripe-red-400","color-depthrenderer-fill-style":"color-cold-gray-150","color-depthrenderer-stroke-style":"color-cold-gray-650","color-disabled-border-and-color":"color-cold-gray-800","color-disabled-input":"color-cold-gray-750","color-empty-container-message":"color-cold-gray-450","color-halal":"color-iguana-green-400","color-continuous":"color-cold-gray-500","color-highlight-new":"color-tv-blue-a800","color-icons":"color-cold-gray-450","color-input-bg":"color-cold-gray-800","color-input-textarea-readonly":"color-cold-gray-650","color-input-placeholder-text":"color-cold-gray-700","color-input-publish-bg":"color-cold-gray-900","color-item-active-blue":"color-tv-blue-a900","color-item-hover-active-bg":"color-cold-gray-800","color-item-hover-bg":"color-cold-gray-800","color-item-hover-blue":"color-tv-blue-a800","color-item-selected-blue":"color-tv-blue-a800","color-item-active-text":"color-cold-gray-200","color-item-active-bg":"color-tv-blue-500","color-link":"color-tv-blue-500","color-link-hover":"color-tv-blue-600","color-link-active":"color-tv-blue-700","color-list-item":"color-cold-gray-450","color-list-nth-child-bg":"color-cold-gray-850","color-news-highlight":"color-cold-gray-800","color-pane-bg":"color-cold-gray-900","color-pane-secondary-bg":"color-cold-gray-850","color-placeholder":"color-cold-gray-650","color-popup-menu-item-hover-bg":"color-cold-gray-800","color-popup-menu-separator":"color-cold-gray-700","color-primary-symbol":"color-sky-blue-500","color-row-hover-active-bg":"color-cold-gray-800","color-sb-scrollbar-body-bg":"color-cold-gray-650","color-screener-description":"color-cold-gray-200","color-section-separator-border":"color-cold-gray-750","color-search-button-hover":"color-cold-gray-700","color-separator-table-chat":"color-cold-gray-750","color-success":"color-minty-green-700","color-success-hover":"color-minty-green-600","color-success-active":"color-minty-green-500","color-tag-active-bg":"color-cold-gray-750","color-tag-hover-bg":"color-cold-gray-800","color-text-regular":"color-cold-gray-200","color-toolbar-button-text":"color-cold-gray-200","color-toolbar-button-text-hover":"color-cold-gray-200","color-toolbar-button-text-active":"color-tv-blue-500","color-toolbar-button-text-active-hover":"color-tv-blue-600","color-toolbar-button-background-hover":"color-cold-gray-800","color-toolbar-button-background-secondary-hover":"color-cold-gray-750","color-toolbar-button-background-active":"color-tv-blue-a900","color-toolbar-button-background-active-hover":"color-tv-blue-a800","color-toolbar-toggle-button-background-active":"color-tv-blue-500","color-toolbar-toggle-button-background-active-hover":"color-tv-blue-600","color-toolbar-toggle-button-icon":"color-cold-gray-650","color-toolbar-interactive-element-text-normal":"color-cold-gray-200","color-toolbar-opened-element-bg":"color-cold-gray-800","color-toolbar-divider-background":"color-cold-gray-700","color-popup-background":"color-cold-gray-850","color-popup-element-text":"color-cold-gray-200","color-popup-element-text-hover":"color-cold-gray-250","color-popup-element-background-hover":"color-cold-gray-800","color-popup-element-secondary-text":"color-cold-gray-500","color-popup-element-hint-text":"color-cold-gray-600","color-popup-element-text-active":"color-cold-gray-200","color-popup-element-background-active":"color-tv-blue-500","color-popup-element-toolbox-text":"color-cold-gray-500","color-popup-element-toolbox-text-hover":"color-cold-gray-200","color-popup-element-toolbox-text-active-hover":"color-tv-blue-200","color-popup-element-toolbox-background-hover":"color-cold-gray-750","color-popup-element-toolbox-background-active-hover":"color-tv-blue-700","color-tooltip-bg":"color-cold-gray-750","color-tv-button-checked":"color-cold-gray-450","color-tv-dialog-caption":"color-cold-gray-50","color-tv-dropdown-item-hover-bg":"color-cold-gray-800","color-underlined-text":"color-cold-gray-450","color-widget-pages-bg":"color-cold-gray-900","color-warning":"color-tan-orange-700","color-forex-icon":"color-white","color-list-item-active-bg":"color-tv-blue-500","color-list-item-hover-bg":"color-cold-gray-800","color-list-item-text":"color-cold-gray-200","color-price-axis-label-back":"color-cold-gray-800","color-price-axis-label-text":"color-cold-gray-500","color-price-axis-gear":"color-cold-gray-200","color-price-axis-gear-hover":"color-cold-gray-400","color-price-axis-highlight":"color-cold-gray-800","color-bid":"color-tv-blue-500","color-scroll-bg":"color-cold-gray-750","color-scroll-border":"color-cold-gray-850","color-widget-border":"color-cold-gray-800","color-scroll-buttons-arrow":"color-white","color-control-intent-default":"color-cold-gray-650","color-control-intent-success":"color-minty-green-500","color-control-intent-primary":"color-tv-blue-500","color-control-intent-warning":"color-tan-orange-500","color-control-intent-danger":"color-ripe-red-500","color-growing":"color-minty-green-500","color-falling":"color-ripe-red-500","color-goto-label-background":"color-cold-gray-650","color-pre-market":"color-tan-orange-600","color-pre-market-bg":"color-tan-orange-400","color-post-market":"color-tv-blue-500","color-post-market-bg":"color-tv-blue-400","color-market-open":"color-minty-green-500","color-market-open-bg":"color-minty-green-400","color-market-closed":"color-cold-gray-400","color-market-holiday":"color-cold-gray-400","color-market-expired":"color-ripe-red-500","color-invalid-symbol":"color-ripe-red-400","color-invalid-symbol-hover":"color-ripe-red-500","color-delisted-symbol":"color-ripe-red-600","color-delisted-symbol-hover":"color-ripe-red-800","color-replay-mode":"color-tv-blue-500","color-replay-mode-point-select":"color-cold-gray-250","color-replay-mode-icon":"color-tv-blue-50","color-replay-mode-hover":"color-tv-blue-600","color-notaccurate-mode":"color-berry-pink-600","color-delay-mode":"color-tan-orange-700","color-delay-mode-bg":"color-tan-orange-400","color-eod-mode":"color-grapes-purple-700","color-eod-mode-bg":"color-grapes-purple-400","color-data-problem":"color-ripe-red-600","color-data-problem-bg":"color-ripe-red-400","color-data-problem-hover":"color-ripe-red-500","color-list-item-bg-highlighted":"color-tv-blue-a900","color-list-item-bg-selected":"color-tv-blue-a800","color-list-item-bg-highlighted-hover":"color-tv-blue-a800","color-list-item-bg-selected-hover":"color-tv-blue-a700","color-screener-header-bg":"color-cold-gray-850","color-screener-header-bg-hover":"color-cold-gray-800","color-overlay":"color-cold-gray-950","color-boost-button-content-selected":"color-tv-blue-100","color-boost-button-content-hover":"color-white","color-boost-button-bg-hover":"color-cold-gray-750","color-boost-button-border-hover":"color-cold-gray-750","color-boost-button-border-default":"color-cold-gray-700","color-x-twitter-content":"color-white","color-card-border":"color-cold-gray-700","color-card-border-hover":"color-cold-gray-600","color-background-special-primary":"color-black","color-stroke-special-primary":"color-cold-gray-800","color-selection-bg":"color-tv-blue-a700","color-default-gray":"color-cold-gray-450","color-featured-broker-badge-bg":"color-white","color-featured-broker-badge-bg-hover":"color-cold-gray-100","color-featured-broker-badge-text":"color-cold-gray-900"}')
;var n=i(823291);const a={[s.StdTheme.Light]:{name:s.StdTheme.Light,label:()=>o.t(null,{context:"colorThemeName"},i(247167)),order:2,getThemedColor:e=>(0,n.getHexColorByName)(e)},[s.StdTheme.Dark]:{name:s.StdTheme.Dark,label:()=>o.t(null,{context:"colorThemeName"},i(945362)),order:1,getThemedColor:e=>{const t=r[e]||e;return(0,n.getHexColorByName)(t)}}}},206478:(e,t,i)=>{"use strict";i.d(t,{default:()=>r});var s=i(858328);const o={filterNamesMap:{script_type:"Indicators and Strategies","script_type-indicators":"Indicators","script_type-strategies":"Strategies",stream:"All Markets","stream-stocks":"Stocks","stream-indices":"Indices","stream-commodities":"Commodities","stream-currencies":"Currencies","stream-bitcoin":"Bitcoin","interval-all":"All Intervals","interval-m":"Short Term","interval-h":"Medium Term","interval-dwm":"Long Term","sort-unmoderated":"Unmoderated","sort-trending":"Trending","sort-discussed":"Most Discussed","sort-viewed":"Most Viewed","sort-agreed":"Most Agreed","sort-suggested":"Suggested","sort-recent":"All Ideas","time-day":"Today","time-week":"This Week","time-month":"This Month","time-all":"All Time","by-everyone":"Everyone","by-following":"Following","by-me":"My Ideas"},goProFeaturesMap:{customIntervals:"Add Custom Interval",intradaySpread:"Inraday Spread",kagiRenko:"Japanese Intraday Chart",alerts:{prefix:"New Alerts Limit",widget:"Widget",chart:"Chart Header"},multipleCharts:"Multiple Charts Layout",savedChartsLimit:"Save Chart Limit",studyLimit:"Studies Limit",multipleWatchLists:{prefix:"Watchlists",new:"Create New List",rename:"Rename List",saveAs:"Save List As"},importWatchlist:"Watchlists Import Watchlist",exportWatchlist:"Watchlists Export Watchlist",BATSExchangePopup:"BATS Exchange Popup",DataQualityPopup:"Data Quality Popup",FreeDelayPopup:"Free Delay Popup",proRTProduct:"Volume Profile",studyOnStudy:"Unlimited Study on Study"},trackFeature:{savedChartsLimit:!0,BATSExchangePopup:!0,FreeDelayPopup:!0,DataQualityPopup:!0,intradaySpread:!0,studyOnStudy:!0},trackGoPro:function(e,t,i){i&&!t&&(t=i,i=null);var r=o.goProFeaturesMap[t];if(r){if(i){if("string"==typeof r)return;r="{0} {1}".format(r.prefix,r[i])}(0,s.trackEvent)(e,r)}}},r=o},797001:(e,t,i)=>{"use strict";i.d(t,{trackGoProFeature:()=>o});var s=i(206478);function o(e,t){s.default.trackGoPro("Gopro Features",e,t)}},322184:(e,t,i)=>{"use strict";i.d(t,{activateKeyPressHandler:()=>p,showDialog:()=>m});var s=i(266150),o=i(77357),r=i(713620),n=i(579454),a=i(952892),l=i(338866),c=i(858328),h=i(525282),d=i(151910);const u=(0,o.getLogger)("SymbolSearchDialog");function _(e){if(!(0,n.globalKeypressMatches)(e))return!1;e.preventDefault();const t=String.fromCharCode(e.charCode);return(0,s.isFeaturesetEnabled)("show_interval_dialog_on_key_press")&&function(e){return/[1-9]/.test(e)}(t)?(0,a.showChangeIntervalDialogAsync)({initVal:t}):(0,s.isFeaturesetEnabled)("symbol_search_hot_key")&&(m({defaultValue:t,selectSearchOnInit:!1,source:"keyboard",trackResultsOptions:{trackResults:!(0,s.isFeaturesetEnabled)("widget"),
emptySearchType:"empty_result__supercharts"},enableOptionsChain:(0,s.isFeaturesetEnabled)("symbol_search_option_chain_selector")}),(0,c.trackEvent)("GUI","SS","hotkey")),!0}function p(){(0,l.loadChangeIntervalDialog)(),r.pushBackListener("symbolEdit",_)}async function m(e){try{await(new d.SymbolSearchUI).show(e)}catch(e){u.logError(`Another SymbolSearchUI is already opened or CustomUI rejected symbol selection ${(0,h.getErrorMessage)(e)}`)}}},459481:(e,t,i)=>{"use strict";i.d(t,{isDetailsReady:()=>s});const s=new(i(168509).WatchedValue)(!1)},522232:(e,t,i)=>{"use strict";i.d(t,{createSymbolNote:()=>m,showMindsPage:()=>p,showSymbolIdeas:()=>_,showSymbolNews:()=>u,showSymbolNotes:()=>d});var s=i(459481),o=i(663957),r=i(486659);async function n(e){Promise.all([i.e(21870),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(46680),i.e(15365),i.e(18257),i.e(86834),i.e(92118),i.e(65790),i.e(15074),i.e(6437),i.e(5449),i.e(44591),i.e(24025),i.e(96793),i.e(34040),i.e(55394),i.e(41184),i.e(2738),i.e(32387),i.e(36295),i.e(44780),i.e(26279),i.e(77811),i.e(11435)]).then(i.bind(i,135459)).then((t=>{t.renderNotesDialog(e)}))}var a=i(893680);var l=i(371757);let c=null;function h(e,t){if(c&&s.isDetailsReady.unsubscribe(c),c=()=>{const i=window?.widgetbar?.layout?.getWidgetByType("detail")?.widgetObject;i.navigate(e,t)},s.isDetailsReady.value())return c(),void(c=null);s.isDetailsReady.subscribe(c,{once:!0})}function d(e=null,t){const i=(0,o.pathToGroup)(e??"");t?n(i):h(i)}function u(e,t){const s=(0,r.newsPathToGroup)(e??"");t?async function(e){(await Promise.all([i.e(32245),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(46680),i.e(45448),i.e(19133),i.e(18257),i.e(86834),i.e(33160),i.e(92118),i.e(75649),i.e(65790),i.e(5792),i.e(57350),i.e(90687),i.e(497),i.e(44591),i.e(12544),i.e(48749),i.e(24025),i.e(71430),i.e(59638),i.e(74274),i.e(25468),i.e(32387),i.e(44780),i.e(16005),i.e(6837),i.e(9663)]).then(i.bind(i,273631))).renderNewsDialog(e)}(s):h(s)}function _(e,t){const s=(0,a.ideasPathToGroup)(e??"");t?async function(e){(await Promise.all([i.e(19729),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(75828),i.e(97627),i.e(74354),i.e(5709),i.e(46680),i.e(45448),i.e(19133),i.e(92597),i.e(86834),i.e(33160),i.e(92118),i.e(65790),i.e(44591),i.e(12544),i.e(24025),i.e(37305),i.e(97085),i.e(18475),i.e(72488),i.e(47016),i.e(55394),i.e(60204),i.e(32387),i.e(44780),i.e(21658),i.e(2024),i.e(18886)]).then(i.bind(i,840539))).renderIdeasDialog(e)}(s):h(s)}function p(e,t,i){h((0,l.createMindsPath)(e??"",t,i))}function m(e=null,t){const i=(0,o.pathToGroup)(e??"")+"?new="+performance.now();t&&n(i),h(i)}},893680:(e,t,i)=>{"use strict";i.d(t,{IDEAS_GROUP_PATH_PATTERN:()=>s,ideasPathToGroup:()=>o});const s="/ideas/groups/:symbol/";function o(e){return s.replace(":symbol",encodeURIComponent(e))}},486659:(e,t,i)=>{"use strict";i.d(t,{NEWS_GROUP_PATH_PATTERN:()=>s,newsPathToGroup:()=>o
});const s="/news/groups/:symbol/";function o(e){return s.replace(":symbol",encodeURIComponent(e))}},663957:(e,t,i)=>{"use strict";i.d(t,{GROUP_PATH_PATTERN:()=>o,NOTES_PATH_PATTERN:()=>s,UNATTENDED_PATH_PATTERN:()=>r,pathToGroup:()=>n});const s="/notes/",o="/notes/groups/:symbol/",r="/notes/unattended/";function n(e){return e?o.replace(":symbol",encodeURIComponent(e)):r}},445250:(e,t,i)=>{"use strict";i.d(t,{showDetailsDialog:()=>n});var s=i(998918);let o;class r extends s.DialogRenderer{constructor(){super(...arguments),this._dialog=null,this._promise=null,this._subscribe=e=>{this._setVisibility(e)}}show(e){const t=this._promise=Promise.all([i.e(97754),i.e(59050),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(92597),i.e(18257),i.e(98729),i.e(27688),i.e(33160),i.e(92568),i.e(60627),i.e(96872),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(57350),i.e(47139),i.e(45587),i.e(90687),i.e(49654),i.e(87580),i.e(497),i.e(44591),i.e(12544),i.e(48749),i.e(27242),i.e(71430),i.e(59638),i.e(53482),i.e(61449),i.e(94938),i.e(1123),i.e(93213),i.e(70861),i.e(41758),i.e(44488),i.e(2176),i.e(74484),i.e(74274),i.e(93944),i.e(22837),i.e(69930),i.e(86626),i.e(41921),i.e(32387),i.e(36295),i.e(44780),i.e(21629),i.e(58934),i.e(40340),i.e(20560),i.e(39422),i.e(21438),i.e(93333),i.e(90384),i.e(26996),i.e(15e3),i.e(96955),i.e(6837),i.e(6342),i.e(90334),i.e(12035),i.e(80912)]).then(i.bind(i,872425)).then((i=>{this._promise===t&&(this._dialog&&(this._dialog.hide(),this._dialog.visible().unsubscribe(this._subscribe)),this._dialog=new i.DetailsDialogRenderer,this._dialog.visible().subscribe(this._subscribe),this._dialog.show(e))}))}hide(){this._dialog?.hide(),this._dialog?.visible().unsubscribe(this._subscribe)}static getInstance(){return o||(o=new r),o}}function n(e){r.getInstance().show(e)}},20686:(e,t,i)=>{"use strict";i.d(t,{hideStateChange:()=>s});const s=new(i(875500).Delegate)},120660:(e,t,i)=>{"use strict";i.r(t),i.d(t,{DELETED_SYMBOLS_LIST_ID:()=>a,DeletedSymbolsList:()=>h,isDeletedSymbolsList:()=>c});var s=i(724226),o=i(885760);const r="deleted_symbols_list",n="is_deleted_symbols_list_active",a="deleted_symbols_list_id",l="There was an error during attempt to set local storage value",c=e=>e===a;class h{constructor(){this._logError=(e,t)=>{e instanceof Error?o.logger.logError(e.message):o.logger.logError(t)}}createList(e){this._setList(e)}removeList(){try{s.TVLocalStorage.removeItem(r)}catch(e){this._logError(e,"There was an error during local storage item removal")}}addSymbols(e){const t=this.getList();if(!t)return;const i=new Set(t.symbols);for(const t of e)i.add(t);const s=Array.from(i);s.length>100?t.symbols=s.reverse().slice(0,100).reverse():t.symbols=s,this._setList(t)}removeSymbols(e){const t=this.getList();if(!t)return;const i=new Set(t.symbols);for(const t of e)i.delete(t);t.symbols=Array.from(i),this._setList(t)}replaceSymbols(e){const t=this.getList();t&&(t.symbols=e,
this._setList(t))}getIsActive(){try{return"true"===s.TVLocalStorage.getItem(n)}catch(e){return this._logError(e,l),!1}}setIsActive(e){try{s.TVLocalStorage.setItem(n,String(e))}catch(e){this._logError(e,l)}}getList(){try{const e=s.TVLocalStorage.getItem(r);return e?JSON.parse(e):null}catch(e){return this._logError(e,"There was an error during attempt to get local storage value"),null}}_setList(e){try{s.TVLocalStorage.setItem(r,JSON.stringify(e))}catch(e){this._logError(e,l)}}}},885760:(e,t,i)=>{"use strict";i.d(t,{logger:()=>s});const s=(0,i(77357).getLogger)("Platform.Model.Watchlist")},992847:(e,t,i)=>{"use strict";i.d(t,{initSymbolListService:()=>n});var s=i(266150),o=i(835228),r=i(560978);function n(){return Promise.all([Promise.all([i.e(58667),i.e(66831),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(74528),i.e(44589),i.e(32387),i.e(36295),i.e(53121),i.e(80056),i.e(99331),i.e(13349),i.e(26395),i.e(2243),i.e(25975),i.e(66503),i.e(19938)]).then(i.bind(i,486959)),Promise.all([i.e(58667),i.e(66831),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(74528),i.e(44589),i.e(32387),i.e(36295),i.e(53121),i.e(80056),i.e(99331),i.e(13349),i.e(26395),i.e(2243),i.e(25975),i.e(66503),i.e(19938)]).then(i.bind(i,607456)),Promise.all([i.e(58667),i.e(66831),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(74528),i.e(44589),i.e(32387),i.e(36295),i.e(53121),i.e(80056),i.e(99331),i.e(13349),i.e(26395),i.e(2243),i.e(25975),i.e(66503),i.e(19938)]).then(i.bind(i,63865)),Promise.all([i.e(58667),i.e(66831),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(74528),i.e(44589),i.e(32387),i.e(36295),i.e(53121),i.e(80056),i.e(99331),i.e(13349),i.e(26395),i.e(2243),i.e(25975),i.e(66503),i.e(19938)]).then(i.bind(i,715913)),(0,s.isFeaturesetEnabled)("widget")?null:Promise.all([i.e(58667),i.e(66831),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(74528),i.e(44589),i.e(32387),i.e(36295),i.e(53121),i.e(80056),i.e(99331),i.e(13349),i.e(26395),i.e(2243),i.e(25975),i.e(66503),i.e(19938)]).then(i.bind(i,794308))]).then((([e,t,i,s,n])=>{if((0,o.hasService)(r.SYMBOL_LIST_SERVICE))return(0,o.service)(r.SYMBOL_LIST_SERVICE);const{store:a,runner:l}=e.configureStore(),c=l.run(t.symbolListRepositorySaga);(0,o.registerService)(r.SYMBOL_LIST_SERVICE,{store:a,runner:l,actions:{addSymbols:s.addSymbolsThunk,initWidget:i.initWidget,saveListAs:s.saveListAsThunk,createNewWatchList:s.userCreateWatchlistThunk},task:c});const h=(0,o.service)(r.SYMBOL_LIST_SERVICE);return null!==n&&n.getCustomSymbolListSynchronizationServiceInstance(h),h}))}},506353:(e,t,i)=>{"use strict";i.d(t,{WATCHLIST_WIDGET_ID:()=>s});const s="watchlist-widget"},151910:(e,t,i)=>{"use strict";i.d(t,{SymbolSearchUI:()=>n});var s=i(185842),o=i(949903),r=i(110443);class n{async show(e){if(null!==n._provider){const t=await n._provider.getSymbol();return e.setSymbol?e.setSymbol(t.symbol,"symbol search UI"):r.linking.setSymbolAndLogInitiator(t.symbol,"symbol search UI"),t}
if(n._currentShowingInstance)throw new DOMException("SymbolSearchUI is already shown","InvalidStateError");try{n._currentShowingInstance=this,n.preload();const t=await n._implementation;return(0,s.assert)(null!==t),new Promise((i=>{t.showDefaultSearchDialog({...e,onSearchComplete:e=>{i({symbol:e})}})}))}finally{n._currentShowingInstance=null}}static setProvider(e){this._provider=e}static preload(){null===this._provider&&null===this._implementation&&(this._implementation=(0,o.loadNewSymbolSearch)())}}n._currentShowingInstance=null,n._provider=null,n._implementation=null},96670:(e,t,i)=>{"use strict";i.d(t,{runOrSignIn:()=>n,runOrSignInWithPromo:()=>a});var s=i(266150),o=i(302358);const r=(0,s.isFeaturesetEnabled)("widget");function n(e,t){r?e():window.runOrSignIn(e,t)}function a(e,t,i){r?i():(0,o.runOrSigninWithFeature)(i,{...t,feature:e})}},153069:(e,t,i)=>{"use strict";i.d(t,{safeShortName:()=>o});var s=i(521928);function o(e){try{return(0,s.shortName)(e)}catch(t){return e}}},784437:(e,t,i)=>{"use strict";i.d(t,{showWatchListsDialog:()=>n});var s=i(998918);let o;class r extends s.DialogRenderer{constructor(){super(...arguments),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)}}show(e){this._load().then((t=>t.show(e)))}hide(){this._dialog?.hide(),this._dialog?.visible().unsubscribe(this._subscribe)}static getInstance(){return o||(o=new r),o}async _load(){const e=await Promise.all([i.e(18513),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(74528),i.e(15365),i.e(22066),i.e(18257),i.e(86834),i.e(48011),i.e(56752),i.e(92568),i.e(60627),i.e(96872),i.e(44589),i.e(75649),i.e(68805),i.e(63935),i.e(80387),i.e(75174),i.e(87795),i.e(26729),i.e(66548),i.e(25947),i.e(85225),i.e(497),i.e(90128),i.e(49515),i.e(66985),i.e(11644),i.e(78399),i.e(24193),i.e(69631),i.e(7757),i.e(96793),i.e(25361),i.e(69441),i.e(75350),i.e(77202),i.e(99826),i.e(9161),i.e(97081),i.e(60205),i.e(32387),i.e(36295),i.e(80915),i.e(53121),i.e(49184),i.e(67890),i.e(13349),i.e(3535),i.e(8106),i.e(2243),i.e(25975),i.e(29997),i.e(96703),i.e(86378),i.e(13834)]).then(i.bind(i,313351));return this._dialog?.hide(),this._dialog?.visible().unsubscribe(this._subscribe),this._dialog=e.watchlistsDialogRenderer(),this._dialog.visible().subscribe(this._subscribe),this._dialog}}function n(e){r.getInstance().show(e)}},620257:e=>{e.exports={chartsSplitter:"chartsSplitter-L0xapso5",hovered:"hovered-L0xapso5"}},948654:e=>{e.exports={paneSeparator:"paneSeparator-uqBaC1Ki",handle:"handle-uqBaC1Ki",mobile:"mobile-uqBaC1Ki",hovered:"hovered-uqBaC1Ki",selected:"selected-uqBaC1Ki",active:"active-uqBaC1Ki"}},841270:e=>{e.exports={"css-value-small-size":"18px","css-value-medium-size":"22px","css-value-large-size":"28px","css-value-border-radius-small-size":"9px","css-value-border-radius-medium-size":"11px","css-value-border-radius-large-size":"8px",statusesWrap:"statusesWrap-Lgtz1OtS",statuses:"statuses-Lgtz1OtS",statusItem:"statusItem-Lgtz1OtS",
statuses_hidden:"statuses_hidden-Lgtz1OtS",small:"small-Lgtz1OtS",medium:"medium-Lgtz1OtS",large:"large-Lgtz1OtS",blinking:"blinking-Lgtz1OtS","blinking-animation":"blinking-animation-Lgtz1OtS",marketStatusOpen:"marketStatusOpen-Lgtz1OtS",marketStatusClose:"marketStatusClose-Lgtz1OtS",marketStatusPre:"marketStatusPre-Lgtz1OtS",marketStatusPost:"marketStatusPost-Lgtz1OtS",marketStatusHoliday:"marketStatusHoliday-Lgtz1OtS",marketStatusDelisted:"marketStatusDelisted-Lgtz1OtS",marketStatusExpired:"marketStatusExpired-Lgtz1OtS",marketStatusCustom:"marketStatusCustom-Lgtz1OtS",invalidSymbol:"invalidSymbol-Lgtz1OtS",activeStrategy:"activeStrategy-Lgtz1OtS",alert:"alert-Lgtz1OtS",alertItemsContainer:"alertItemsContainer-Lgtz1OtS",alertItem:"alertItem-Lgtz1OtS",replayModeAutoPlay:"replayModeAutoPlay-Lgtz1OtS",replayModePause:"replayModePause-Lgtz1OtS",replayModePointSelect:"replayModePointSelect-Lgtz1OtS","blinking-animation-custom":"blinking-animation-custom-Lgtz1OtS",notAccurate:"notAccurate-Lgtz1OtS",openedInPineEditor:"openedInPineEditor-Lgtz1OtS",openedInDetachedPineEditor:"openedInDetachedPineEditor-Lgtz1OtS",delay:"delay-Lgtz1OtS",eod:"eod-Lgtz1OtS",dataProblemHigh:"dataProblemHigh-Lgtz1OtS",dataProblemLow:"dataProblemLow-Lgtz1OtS",hasError:"hasError-Lgtz1OtS",updateAvailable:"updateAvailable-Lgtz1OtS"}},602699:(e,t,i)=>{"use strict";i.d(t,{LineToolsSynchronizer:()=>E,lineToolDTO:()=>x});var s=i(88434),o=i(860129),r=i(185842),n=i(77357),a=i(246445),l=i(227719),c=i(101458),h=i(368203),d=i(376596),u=i(256990),_=i(385955),p=i(222993);const m=(0,n.getLogger)("Chart.LinkKeyResolver");class g{constructor(e,t,i){this._pendingRequests=new Map,this._startRequestingDebounced=(0,s.default)((()=>this._startNextRequest()),500),this._layoutId=e,this._chartId=t,this._ownerSourceId=i}resolveLinkKey(e,t,i){const s=function(e,t){return JSON.stringify([e,t])}(e,i),o=this._pendingRequests.get(s)??new Map;if(o.has(t))return o.get(t).promise;const r=(0,p.createDeferredPromise)();return o.set(t,r),this._pendingRequests.set(s,o),this._startRequestingDebounced(),r.promise}async _startNextRequest(){if(0===this._pendingRequests.size)return;const e=await(0,u.getChartStorage)(),t=this._pendingRequests.entries().next().value,{symbol:i,brokerName:s}=function(e){const t=JSON.parse(e);return{symbol:t[0],brokerName:t[1]}}(t[0]),o=t[1],r={requestType:"mainSeriesLineTools",seriesSourceId:this._ownerSourceId,symbol:i,brokerName:s,sharingMode:0};try{const t=await e.loadLineToolsAndGroups(this._layoutId,this._chartId,r,i);null!==t&&null!==t.sources&&(t.sources.forEach(((e,t)=>{if(null===e)return;const i=e.state.linkKey;if(!i)return;const s=o.get(i);s?.resolve(e.id),o.delete(i)})),t.serverRequestId&&console.log(`PROCESSED:${t.serverRequestId}`))}catch(e){m.logError(`Error requesting line tools: ${e}`)}o.forEach((e=>{e.resolve(null)})),this._pendingRequests.delete(t[0]),await this._startNextRequest()}}var S=i(988079),v=i(97063),f=i(305458),b=i(123817),y=i(187614),w=i(917273);const C=[0,1,2],T=(0,n.getLogger)("LineToolsSynchronizer");function P(e){return{
lines:e.sourcesByGroup().lineSourcesForAllSymbols().map((e=>({id:e.id(),zOrder:e.zorder()})))}}function M(e){return{id:e.id,tools:e.lineTools().map((e=>e.id()))}}function x(e,t){const i=t.lineToolsGroupModel().groupForLineTool(e),s={id:e.id(),ownerSource:(0,r.ensureNotNull)(e.ownerSource()).id(),state:e.state(!1)};return e.boundToSymbol()&&(s.symbol=e.symbol()),s.serverUpdateTime=e.serverUpdateTime()??void 0,s.currencyId=e.properties().childs().currencyId.value(),s.unitId=e.properties().childs().unitId.value(),null!==i&&(s.groupId=i.id),s}function I(e,t){return{id:e.id,name:e.name().value(),symbol:e.symbol(),currencyId:e.currencyId(),unitId:e.unitId()}}function L(e,t,i){let s=!1;const o=new Map,r=new Set(i?.keys());return e.forEach(((e,n)=>{const a=!i||i.has(n);e.timestamp>t||!a?(o.set(n,e),r.delete(n)):s||=!!e.savedToChartContent})),{stillInvalidated:o,validated:Array.from(r),containResavedFromContent:s}}function A(e){return(0,c.isLineTool)(e)||(0,v.isStudyLineToolStub)(e)}const k=/(\w+)\/(\w+)\/(\w+)/;class E{constructor(e,t,i,o){this._invalidatedLineToolsAndStudyStubs=new Map,this._migratedSharedLineToolsDuplicates=new Set,this._allLineToolsAndStudyStubs=new Map,this._originalLineToolSharingMode=new Map,this._invalidatedLineToolGroups=new Map,this._originalLineToolGroupsSharingMode=new Map,this._ignoreInvalidatingEventsDepth=0,this._saveChartService=null,this._debouncedSave=(0,s.default)((()=>this._saveInvalidatedIfRequired(!1)),500),this._currentlyLoadedSymbol=new Map,this._linkKeyResolver=null,this._brokerName="",this._lastBanTime=null,this._invalidateViaSync=0,this._savingAbortControllersBySharingMode=new Map,this._tryToSaveChartStateMigrationsOnce=!0,this._pendingLoadRequestsCounter=0,this._pendingSaveRequestsCounter=0,this._mainSeriesDrawingsReady=["",Promise.resolve()],this._nextResolvedSymbolDeferredPromises=[],this._destroyed=!1,this._onChangeAutosave=e=>{e&&this._debouncedSave()},this._origin=e,this._chartModel=t,this._options=i,this._hasChanges=o,this._assignAllLineTools(this._chartModel.panes()),this._chartModel.panesCollectionChanged().subscribe(this,this._processPanesCollectionChanged.bind(this)),this._chartModel.dataSourceCollectionChanged().subscribe(this,this._processDataSourceCollectionChanged.bind(this)),this._chartModel.lineToolsGroupModel().onChanged().subscribe(this,this._processLineToolsGroupModelChanged.bind(this)),this._chartModel.mainSeries().dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved.bind(this)),this._chartModel.sourcePropertiesChanged().subscribe(this,this._processPropertiesChanged.bind(this)),this._chartModel.sourceZOrderChanged().subscribe(this,this._processPropertiesChanged.bind(this)),this._linkKeyResolver=new g(e.layoutId,e.chartId,t.mainSeries().id()),this._brokerIdSession=new f.FeatureToggleWatchedValue("broker_id_session",!1),this._autofixZOrder=new f.FeatureToggleWatchedValue("autofix_line_tools_zorder",!1);const r=this._loadAndMergeLineToolsWithoutSymbol(2,!1),n=this._loadAndMergeLineToolsWithoutSymbol(1,!1)
;this._loadAndMergeLineToolsWithoutSymbol(0,!1,[r,n]),this._loadAndMergeLineToolsOnStudies(0,!1),(0,d.onWidget)()||window.loginStateChange.subscribe(this,(()=>{window.is_authenticated&&this.reloadAllLineTools()}))}destroy(){this._debouncedSave.cancel(),(0,d.onWidget)()||window.loginStateChange.unsubscribeAll(this),this._brokerIdSession.destroy(),this._chartModel.mainSeries().dataEvents().symbolResolved().unsubscribeAll(this),this._chartModel.sourcePropertiesChanged().unsubscribeAll(this),this._chartModel.sourceZOrderChanged().unsubscribeAll(this),this._chartModel.panesCollectionChanged().unsubscribeAll(this),this._chartModel.dataSourceCollectionChanged().unsubscribeAll(this),this._chartModel.lineToolsGroupModel().onChanged().unsubscribeAll(this),this._saveChartService?.autoSaveEnabled().unsubscribe(this._onChangeAutosave),this._saveChartService?.chartSaved().unsubscribeAll(this),this._destroyed=!0}reloadAllLineTools(){this._currentlyLoadedSymbol.clear(),C.forEach((e=>{0===e&&this._loadAndMergeLineToolsOnStudies(e,!0),this._loadAndMergeLineToolsWithoutSymbol(e,!0)}));const e=this._chartModel.mainSeries().symbolInfo();e&&this._onSymbolResolved(e)}hasChanges(){return this._hasChanges}hasUnsavedMigrationsFromChartState(){return R(this._invalidatedLineToolsAndStudyStubs)||R(this._invalidatedLineToolGroups)}setSaveChartService(e){this._saveChartService&&(this._saveChartService.autoSaveEnabled().unsubscribe(this._onChangeAutosave),this._saveChartService.chartSaved().unsubscribeAll(this)),this._saveChartService=e,this._saveChartService.autoSaveEnabled().subscribe(this._onChangeAutosave),this._saveChartService.chartSaved().subscribe(this,(()=>{this._tryToSaveChartStateMigrationsOnce=!1,this._recalculateHasChanges()}),!0)}prepareDTO(e=!1){const t=new Map;return C.forEach((i=>{t.set(i,this._prepareDTOItem(e,i))})),t}getDTO(e=0,t=!1,i=!1){return i&&this.invalidateAll(),this._prepareDTOItem(t,e,i)}async applyDTO(e,t=0){this.resetInvalidated(Date.now().valueOf(),e,t),await this._applyLineToolsAndGroupsDTO(e,t)}markAsValidatedBecauseOfSavingToContent(){D(this._invalidatedLineToolsAndStudyStubs),D(this._invalidatedLineToolGroups),this._recalculateHasChanges()}resetInvalidated(e,t,i,s){const o=(e,t,s,o)=>{if(!s.has(o)||s.get(o))s.has(o)&&t(o,i);else{const s=e.get(o);s&&(s===i?t(o,null):0===i&&t(o,s))}};if(null===t.sources)return;const{groups:r,sources:n,lineToolsToValidate:l,groupsToValidate:c}=t,h=L(this._invalidatedLineToolsAndStudyStubs,e,new Set(l??n.keys()));this._invalidatedLineToolsAndStudyStubs=h.stillInvalidated,h.validated.forEach(o.bind(this,this._originalLineToolSharingMode,this._setOriginalLineToolSharingMode.bind(this),n));const d=L(this._invalidatedLineToolGroups,e,new Set(c??r.keys()));if(h.validated.forEach(o.bind(this,this._originalLineToolGroupsSharingMode,this._setOriginalLineToolGroupsSharingMode.bind(this),r)),this._invalidatedLineToolGroups=d.stillInvalidated,Array.from(n.keys()).forEach((e=>{const t=this._chartModel.dataSourceForId(e)
;t&&(void 0!==s?t.setServerUpdateTime(s):null===t.serverUpdateTime()&&t.setServerUpdateTime((new Date).valueOf()))})),0===i)for(const e of Array.from(this._migratedSharedLineToolsDuplicates))null===n.get(e)&&this._migratedSharedLineToolsDuplicates.delete(e);(h.containResavedFromContent||d.containResavedFromContent)&&a.emit("lineToolsResavedFromContent"),this._recalculateHasChanges()}async applyLineToolUpdateNotification(e,t){const i=function(e){const t=k.exec(e);return 4===t?.length?{layoutId:t[1],chartId:t[2],clientId:t[3]}:{layoutId:"",chartId:"",clientId:e}}(e.clientId??"");if(i.clientId!==this._origin.clientId||i.chartId!==this._origin.chartId)return void 0===e.symbol||null!==e.sources?this._applyLineToolsAndGroupsDTO(e,t,i):void this._withoutInvalidating((()=>{const i=this._chartModel.dataSources().filter(c.isLineTool).filter((i=>i.sharingMode().value()===t&&i.symbol()===e.symbol));i.length>0&&this._chartModel.undoModel().removeSources(i,!0,null)}))}startApplyingLineToolUpdateNotification(){this._ignoreInvalidatingEventsDepth++}endApplyingLineToolUpdateNotification(){this._ignoreInvalidatingEventsDepth--,this._ignoreInvalidatingEventsDepth<0&&(T.logError("Logic error, startApplyingLineToolUpdateNotification/endApplyingLineToolUpdateNotification mismatch, autofixing"),this._ignoreInvalidatingEventsDepth=0)}applyAlertIdByExternalSource(e,t){this._withoutInvalidating((()=>{const i=this._chartModel.dataSourceForId(e);i&&(0,c.isLineTool)(i)&&i.setAlert(t)}))}deleteAlertByExternalSource(e){this._withoutInvalidating((()=>{const t=this._chartModel.dataSourceForId(e);t&&(0,c.isLineTool)(t)&&t.removeAlert()}))}async markSyncedLineToolAsDeleted(e,t){if(this._linkKeyResolver){const i=await this._linkKeyResolver.resolveLinkKey(t,e,this._brokerName);if(this._destroyed)return null;if(null!==i){const t=this._chartModel.lineToolByLinkKey(e);null===t?this._invalidateLineToolOrStudyStub(i,performance.now()):this._withoutInvalidating((()=>{const e=(0,r.ensureNotNull)(this._chartModel.paneForSource(t)),i=this._allLineToolsAndStudyStubs.get(e.id())||new Map;t.detachAlert(),this._chartModel.removeSource(t),i.delete(t.id())})),this._debouncedSave()}return i}return null}invalidateAll(e=!1){const t=performance.now();this._allLineToolsAndStudyStubs.forEach((e=>{e.forEach(((e,i)=>{this._invalidateLineToolOrStudyStub(i,t)}))})),this._chartModel.lineToolsGroupModel().groupsForAllSymbols().forEach((e=>{this._invalidateLineToolGroup(e.id,t)})),e&&this.markAsValidatedBecauseOfSavingToContent()}async executeSynchronizationInLayoutAction(e){this._invalidateViaSync+=1;try{await e()}finally{this._invalidateViaSync-=1}}invalidateViaSync(){return this._invalidateViaSync>0}flushPendingSavings(){return this._invalidatedLineToolGroups.size||this._invalidatedLineToolsAndStudyStubs.size||this._migratedSharedLineToolsDuplicates.size?this._saveInvalidatedIfRequired(!1,!0):null}hasPendingLoadRequests(){const e=this._chartModel.mainSeries();for(const t of C){const i=this._currentlyLoadedSymbol.get(t)??"";if(!e.symbolSameAsCurrent(i))return!0}
return this._pendingLoadRequestsCounter>0}hasPendingSaveRequests(){return this._pendingSaveRequestsCounter>0||this.hasChanges().value()&&this._isAutosaveEnabled()}async mainSeriesDrawingsReady(e){let[t,i]=this._mainSeriesDrawingsReady;if(t===e)return i;const s=(0,p.createDeferredPromise)();return this._nextResolvedSymbolDeferredPromises.push([e,s]),await s.promise,[t,i]=this._mainSeriesDrawingsReady,(0,r.assert)(t===e,"Unexpected symbol pro_name"),i}_assignAllLineTools(e){e.forEach((e=>{const t=e.dataSources().filter(A).map((e=>[e.id(),e.linkKey().value()])),i=new Map(t);this._allLineToolsAndStudyStubs.set(e.id(),i)}))}_processPropertiesChanged(e,t){A(t)&&this._invalidateLineToolOrStudyStub(t.id(),performance.now())}_processLineToolsGroupModelChanged(e,t){const i=performance.now();this._invalidateLineToolGroup(e,i);const s=this._chartModel.lineToolsGroupModel().groupForId(e);let o=s?.lineTools().length?s.sharingMode().value():void 0;t&&((t.affectedLineTools||[]).forEach((e=>this._invalidateLineToolOrStudyStub(e,i))),t.affectedLineTools?.length>0&&void 0===o&&(o=this._originalLineToolSharingMode.get(t.affectedLineTools[0]))),this._originalLineToolGroupsSharingMode.has(e)||this._setOriginalLineToolGroupsSharingMode(e,o??0)}_processPanesCollectionChanged(e){const t=e.map((e=>e.id())),i=new Set(t),s=performance.now();Array.from(this._allLineToolsAndStudyStubs.keys()).filter((e=>!i.has(e))).forEach((e=>{Array.from((0,r.ensureDefined)(this._allLineToolsAndStudyStubs.get(e)).keys()).forEach((e=>{this._invalidateLineToolOrStudyStub(e,s)}))})),e.filter((e=>!this._allLineToolsAndStudyStubs.has(e.id()))).forEach((e=>{e.dataSources().filter(A).forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),s)))})),this._assignAllLineTools(e)}_processDataSourceCollectionChanged(e){const t=e.dataSources().filter(A),i=t.map((e=>[e.id(),e.linkKey().value()])),s=new Map(i);let o;const n=performance.now();if(this._allLineToolsAndStudyStubs.has(e.id())){const i=(0,r.ensureDefined)(this._allLineToolsAndStudyStubs.get(e.id()));o=t.filter((e=>!i.has(e.id()))),o.forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),n))),Array.from(i.entries()).filter((e=>!s.has(e[0]))).forEach((e=>{null!==e[1]&&this._debouncedSave(),this._invalidateLineToolOrStudyStub(e[0],n)}))}else o=t,t.forEach((e=>this._invalidateLineToolOrStudyStub(e.id(),n)));o.forEach((e=>{if((0,c.isLineTool)(e)){this._setOriginalLineToolSharingMode(e.id(),e.sharingMode().value());const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);t&&this._setOriginalLineToolGroupsSharingMode(t.id,e.sharingMode().value())}})),this._allLineToolsAndStudyStubs.set(e.id(),s)}_unloadLineTools(e,t,i){const s=e.filter((e=>!this._invalidatedLineToolsAndStudyStubs.has(e))).map((e=>this._chartModel.dataSourceForId(e))).filter(c.isLineTool).filter(_.notNull).filter((e=>e.sharingMode().value()===i)).filter(t).filter((e=>{const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);return null===t||!this._invalidatedLineToolGroups.has(t.id)}));this._withoutInvalidating((()=>{
this._chartModel.bulkActionMacro((()=>{s.forEach((e=>{e.hasAlert().value()&&e.detachAlert();const t=(0,r.ensureNotNull)(this._chartModel.paneForSource(e));this._chartModel.removeSource(e);(this._allLineToolsAndStudyStubs.get(t.id())??new Map).delete(e.id())})),this._chartModel.lineToolsGroupModel().removeLineTools(s)}))}))}_unloadLinesOnSeries(e,t,i){const s=this._chartModel.mainSeries();if(!i?.size)return;const o=Array.from(i.keys()).filter((t=>!e(t)));this._unloadLineTools(o,(e=>e.boundToSymbol()&&e.ownerSource()===s),t)}_isAutosaveEnabled(){return Boolean(this._saveChartService&&this._saveChartService.autoSaveEnabled().value())}async _saveInvalidatedIfRequired(e,t){if(null!==this._lastBanTime){if(!(performance.now()-this._lastBanTime>=3e5))return Promise.resolve();this._lastBanTime=null}if(!this._isAutosaveEnabled()&&!t||this._options.readOnlyMode||!window.is_authenticated||""===this._origin.layoutId)return;const i=this.prepareDTO(e),s=C.map((e=>{const t=i.get(e);if(!t||null===t.sources)return null;const s=t.lineToolsToValidate??Array.from(t.sources.keys()),o=t.groupsToValidate??Array.from(t.groups.keys());if(0===s.length&&0===o.length)return null;const n=performance.now();if(t.sources.size||t.groups.size){const i=this._savingAbortControllersBySharingMode.get(e);i&&i.abort();const s=new AbortController;return this._savingAbortControllersBySharingMode.set(e,s),t.sources.forEach(((t,i)=>{t&&this._setOriginalLineToolSharingMode(i,e)})),t.groups.forEach(((t,i)=>{t&&this._setOriginalLineToolGroupsSharingMode(i,e)})),this._pendingSaveRequestsCounter+=1,(0,r.ensureNotNull)(this._saveChartService).saveChartLineTools(this._origin.chartId,t,e,s.signal).then((({serverUpdateTime:i})=>{this._destroyed||this.resetInvalidated(n,t,e,i)})).catch((async t=>{if(!this._destroyed){if(t instanceof h.SavingLineToolsError&&t.shouldBeCooled&&(this._lastBanTime=performance.now()),!(0,b.isAbortError)(t))throw t;T.logDebug(`Save request has been aborted. ChartId: ${this._origin.chartId} sharingMode: ${e}`)}})).finally((()=>{this._pendingSaveRequestsCounter-=1}))}return this.resetInvalidated(n,t,e),null})).filter(_.notNull);return s.length?Promise.all(s).then((()=>{})):void 0}async _savePromise(e,t){return this._isAutosaveEnabled()?this._debouncedSave?.flush()??Promise.resolve():this._saveInvalidatedIfRequired(e,t)}_seriesLineToolsUnloader(e,t,i){const s=this._chartModel.mainSeries();"mainSeriesLineTools"===e.requestType&&s.symbolSameAsCurrent(e.symbol)&&(this._unloadLinesOnSeries(i,e.sharingMode,t),this._currentlyLoadedSymbol.set(e.sharingMode,e.symbol))}_mainPaneLineToolsAndStubs(){const e=this._chartModel.mainSeries(),t=(0,r.ensureNotNull)(this._chartModel.paneForSource(e));return new Map(this._allLineToolsAndStudyStubs.get(t.id()))}_onSymbolResolved(e){const t=(t,i)=>{const s={requestType:"mainSeriesLineTools",seriesSourceId:this._chartModel.mainSeries().id(),symbol:e.pro_name,brokerName:"",sharingMode:t}
;return this._makeLoadRequestAndMerge(s,this._seriesLineToolsUnloader.bind(this,s,this._mainPaneLineToolsAndStubs()),e.pro_name||e.ticker||e.full_name,i)},i=t(2),s=t(1),o=[i,s,t(0,[i,s])],r=Promise.all(o).then((()=>{var e;if(!this._destroyed&&(this._withoutInvalidating((()=>{this._chartModel.dataSources().filter(c.isLineTool).filter((e=>0===e.sharingMode().value()&&e.linkKey().value())).forEach((e=>{if(e.share(1),this._options.migrateSyncedLineTools){this._invalidateLineToolOrStudyStub(e.id(),performance.now(),!0);const t=this._chartModel.lineToolsGroupModel().groupForLineTool(e);t&&this._invalidateLineToolGroup(t.id,performance.now(),!0)}}))})),this._autofixZOrder.value()&&this._chartModel.lineToolsGroupModel().groupsForAllSymbols().length)){const t={panes:(e=this._chartModel).panes().map(P),groups:e.lineToolsGroupModel().groupsForAllSymbols().map(M)},i=(0,w.prepareZOrderFixIfRequired)(t);this._chartModel.bulkActionMacro((()=>{i.forEach(((e,t)=>{const i=this._chartModel.dataSourceForId(t);i?.setZorder(e)}))}))}}));this._mainSeriesDrawingsReady=[e.pro_name,r];for(const[t,i]of this._nextResolvedSymbolDeferredPromises)t===e.pro_name?i.resolve():i.reject(new Error("Symbol mismatch"));this._nextResolvedSymbolDeferredPromises=[]}async _makeLoadRequestAndMerge(e,t,i,s){const o=this._chartModel.mainSeries(),r=this._currentlyLoadedSymbol.get(e.sharingMode)??"";if(!!o.symbolSameAsCurrent(r))return;this._currentlyLoadedSymbol.delete(e.sharingMode);const n=await(0,u.getChartStorage)();return this._destroyed?void 0:this._savePromise("mainSeriesLineTools"===e.requestType).catch((()=>{})).then((()=>this._destroyed?null:(this._pendingLoadRequestsCounter+=1,n.loadLineToolsAndGroups(this._origin.layoutId,this._origin.chartId,e,i)))).catch((()=>null)).then((async i=>{if(!this._destroyed){if(s)try{if(await Promise.all(s),this._destroyed)return}catch(e){}if(this._pendingLoadRequestsCounter-=1,null!==i){const s=i.sources;s&&(t((e=>s.has(e))),await this._applyLineToolsAndGroupsDTO(i,e.sharingMode)),i.serverRequestId&&console.log(`PROCESSED:${i.serverRequestId}`)}}}))}_restoreGroups(e,t,i,s){const o=new Map;return(t.groups||new Map).forEach(((t,n)=>{const a=this._chartModel.lineToolsGroupModel().groupForId(n);if(null===t){if(a){const e=s&&s.layoutId===this._origin.layoutId&&s.chartId===this._origin.chartId;a.lineTools()[0].sharingMode().value()===i&&(e&&0!==i||(new S.ExcludeLineToolsFromGroupUndoCommand(this._chartModel,a,a.lineTools()).redo(),this._setOriginalLineToolGroupsSharingMode(n,null)))}}else{if(a&&t.serverUpdateTime){const i=(0,r.ensureDefined)(t.serverUpdateTime);if(null!==e&&e>=i)return;a.setName(t.name)}else o.set(n,t);this._setOriginalLineToolGroupsSharingMode(n,i)}})),o}_createNewLineTool(e){const t=this._chartModel.dataSourceForId(e.ownerSource);if(null===t)return null;const i=(0,r.ensureNotNull)(this._chartModel.paneForSource(t)),s=this._chartModel.panes().indexOf(i),o=this._chartModel.restoreSource(!1,s,null,e.state,null);if(null!==o){const e=this._allLineToolsAndStudyStubs.get(i.id())||new Map
;e.set(o.id(),o.linkKey().value()),this._allLineToolsAndStudyStubs.set(i.id(),e)}return o}_migrateStateFromMetainfo(e){const t=void 0!==e.symbol&&e.symbol!==e.state.state.symbol;t&&(e.state.state.symbol=e.symbol);const i=void 0!==e.currencyId&&e.currencyId!==e.state.state.currencyId;i&&(e.state.state.currencyId=e.currencyId);const s=void 0!==e.unitId&&e.unitId!==e.state.state.unitId;return s&&(e.state.state.unitId=e.unitId),t||i||s}_restoreLineTool(e,t,i,s){if((t.state.points??[]).some((e=>!(0,_.isNumber)(e.time_t))))return null;let o=this._chartModel.dataSourceForId(t.id);if(null===o&&t.state.linkKey&&(o=this._chartModel.lineToolByLinkKey(t.state.linkKey)),null!==o&&!(0,c.isLineTool)(o))return null;if(this._origin.clientId===s?.clientId&&!o)return null;if(o&&t.serverUpdateTime){const r=t.serverUpdateTime,n=o.serverUpdateTime();if(null!==e&&e>=r||null!==n&&n>=r)return 0!==i&&(o.share(i),this._setOriginalLineToolSharingMode(o.id(),i)),this._restoreLineToolAlert(o,t.state.alertId),null;this._origin.clientId!==s?.clientId&&(this._chartModel.restoreLineToolState(o,t.state,!1),o.sharingMode().value()!==i&&(o.share(i),this._setOriginalLineToolSharingMode(o.id(),i)),o.calcIsActualSymbol())}0!==i&&(t.ownerSource=this._chartModel.mainSeries().id(),t.state.ownerSource=this._chartModel.mainSeries().id()),0===i&&t.state.linkKey&&(t.state.sharingMode??=1);const r=this._migrateStateFromMetainfo(t);let n=o||this._createNewLineTool(t);if(n&&(r&&this._invalidateLineToolOrStudyStub(t.id,performance.now(),!0),t.serverUpdateTime&&n.setServerUpdateTime(t.serverUpdateTime),this._restoreLineToolAlert(n,t.state.alertId),0!==i&&n.share(i),void 0===s&&(0,c.isEditableTextLineTool)(n))){this._removeTextLineToolIfEmpty(n)&&(n=null)}return n}_restoreLineToolAlert(e,t){t?e.restoreAlert(+t).catch((e=>{T.logError(`Failed to restore lineTool alert: ${Error,e}`)})):e.detachAlert()}_removeLineTool(e){const t=this._chartModel.dataSourceForId(e);null!==t&&this._chartModel.removeSource(t)}_removeTextLineToolIfEmpty(e){return!(!e.removeIfEditableTextIsEmpty()||0!==e.editableTextProperties().text.value().length)&&(this._chartModel.removeSource(e),this._invalidateLineToolOrStudyStub(e.id(),performance.now(),!0),!0)}_restoreLineDTO(e,t,i,s,o,n){if(!this._invalidatedLineToolsAndStudyStubs.get(t))if(null===e){const e=this._chartModel.dataSourceForId(t);if(!e)return;if(!(0,c.isLineTool)(e))return;if(e.sharingMode().value()===o&&this._origin.clientId!==n?.clientId){const i=this._chartModel.lineToolsGroupModel().groupForLineTool(e);null!==i&&new S.ExcludeLineToolsFromGroupUndoCommand(this._chartModel,i,[e]).redo(),this._removeLineTool(t),this._setOriginalLineToolSharingMode(t,null)}}else{if(0===o&&null!=e.state.linkKey){if(this._chartModel.dataSourceForId(t))return void this._migratedSharedLineToolsDuplicates.add(e.id);this._invalidateLineToolOrStudyStub(e.id,performance.now(),!0)}if(0===e.state.points?.length&&["LineToolRiskRewardLong","LineToolRiskRewardShort"].includes(e.state.type))return this._invalidateLineToolOrStudyStub(t,performance.now(),!0),
void this._setOriginalLineToolSharingMode(t,o);const a=this._restoreLineTool(s,e,o,n);if(a)if(e.groupId){const t=this._chartModel.lineToolsGroupModel().groupForLineTool(a),s=this._chartModel.lineToolsGroupModel().groupForId(e.groupId);if(null!==t&&s===t)return;if(null!==t&&(t.excludeLineTool(a),0===t.lineTools().length&&this._chartModel.lineToolsGroupModel().removeGroup(t)),s&&!s.containsLineTool(a))s.addLineTools([a]);else if(!s&&i.has(e.groupId)){const t=(0,r.ensureDefined)(i.get(e.groupId));this._chartModel.lineToolsGroupModel().createGroup([a],t.name,t.id)}}else{this._chartModel.lineToolsGroupModel().removeLineTools([a]).forEach((e=>{this._invalidateLineToolGroup(e,performance.now(),!0)}))}this._setOriginalLineToolSharingMode(t,o)}}async _applyLineToolsAndGroupsDTO(e,t,i){const s=this._chartModel.chartSaveTime(),o=this._withoutInvalidating((()=>this._restoreGroups(s,e,t,i))),r=`ChartStorage.Synchronizer.ApplyingDTO.${`${this._origin.layoutId}.${this._origin.chartId}`}`,n=new Set;if((e.sources||new Map).forEach((e=>{e&&n.add(e.state.type)})),await Promise.all(Array.from(n).map((e=>(0,c.initLineTool)(e)))),!this._destroyed)return(0,l.perfMeasureOperation)(r,(()=>this._withoutInvalidating((()=>{this._chartModel.bulkActionMacro((()=>{(e.sources||new Map).forEach(((e,r)=>{try{if(e&&(0,y.isMtpPredictorToolName)(e.state.type))return void T.logWarn(`No longer supported tool ${e.state.type} is skipped while restoring state`);this._restoreLineDTO(e,r,o,s,t,i)}catch(t){T.logError(`Error restoring line tool ${r} (${e?.state.type}): ${t}`),e?.state.type&&!n.has(e.state.type)&&T.logError(`Line tool ${e.state.type} may need to be initialised first`)}})),(e.groups||new Map).forEach(((e,t)=>{this._invalidatedLineToolGroups.delete(t)})),this._recalculateHasChanges()}))}))))}_withoutInvalidating(e){try{return this._ignoreInvalidatingEventsDepth++,e()}finally{this._ignoreInvalidatingEventsDepth--}}_invalidateLineToolOrStudyStub(e,t,i){if(this._ignoreInvalidatingEventsDepth>0&&!i)return;const{invalidatedViaSyncOnly:s,savedToChartContent:o}=this._invalidatedLineToolsAndStudyStubs.get(e)||{},r=(void 0===s||s)&&this.invalidateViaSync();this._invalidatedLineToolsAndStudyStubs.set(e,{timestamp:t,invalidatedViaSyncOnly:r,savedToChartContent:o}),this._hasChanges.setValue(!0),this._debouncedSave()}_invalidateLineToolGroup(e,t,i){if(this._ignoreInvalidatingEventsDepth>0&&!i)return;const{savedToChartContent:s}=this._invalidatedLineToolGroups.get(e)||{};this._invalidatedLineToolGroups.set(e,{timestamp:t,invalidatedViaSyncOnly:this.invalidateViaSync(),savedToChartContent:s}),this._hasChanges.setValue(!0),this._debouncedSave()}_prepareDTOItem(e,t,i=!1){const s=new Map,o=new Map,r=[],n=[];if(this._invalidatedLineToolsAndStudyStubs.forEach(((n,a)=>{if(0!==t&&n.invalidatedViaSyncOnly)return void r.push(a);const l=this._chartModel.dataSourceForId(a);if(!(0,v.isStudyLineToolStub)(l))if(null===l){(this._originalLineToolSharingMode.get(a)===t||i)&&s.set(a,null)}else{
if(l===this._chartModel.lineBeingCreated()||l===this._chartModel.lineBeingEdited()||!l.isSavedInChart())return;const r=l.ownerSource()===this._chartModel.mainSeries(),n=!e||r,c=l.sharingMode().value()===t||i;if(n){const e=this._chartModel.lineToolsGroupModel().groupForLineTool(l);if(c)s.set(a,x(l,this._chartModel)),null!==e&&o.set(e.id,I(e,this._chartModel));else{const i=this._originalLineToolSharingMode.get(a);i===t&&s.set(a,null),null!==e&&i===t&&o.set(e.id,null)}}}})),0===t)for(const e of this._migratedSharedLineToolsDuplicates)s.has(e)||s.set(e,null);return this._invalidatedLineToolGroups.forEach(((e,i)=>{if(0!==t&&e.invalidatedViaSyncOnly)n.push(i);else if(!o.has(i)){const e=this._chartModel.lineToolsGroupModel().groupForId(i);if(null===e){this._originalLineToolGroupsSharingMode.get(i)===t&&o.set(i,null)}else e.sharingMode().value()===t&&o.set(i,I(e,this._chartModel))}})),{sources:s,groups:o,clientId:this._generateOrigin(),lineToolsToValidate:Array.from(s.keys()).concat(r),groupsToValidate:Array.from(o.keys()).concat(n)}}_setOriginalLineToolSharingMode(e,t){null!==t?this._originalLineToolSharingMode.set(e,t):this._originalLineToolSharingMode.delete(e)}_setOriginalLineToolGroupsSharingMode(e,t){null!==t?this._originalLineToolGroupsSharingMode.set(e,t):this._originalLineToolGroupsSharingMode.delete(e)}_loadAndMergeLineToolsOnStudies(e,t){const i={requestType:"studiesLineTools",seriesSourceId:this._chartModel.mainSeries().id(),sharingMode:e},s=this._chartModel.mainSeries();this._makeLoadRequestAndMerge(i,(i=>{const r=t?(0,o.default)(Array.from(this._allLineToolsAndStudyStubs.values()).map((e=>Array.from(e.keys())))).filter((e=>!i(e))):[];this._unloadLineTools(r,(e=>e.ownerSource()!==s),e)}))}_loadAndMergeLineToolsWithoutSymbol(e,t,i){const s={requestType:"lineToolsWithoutSymbol",seriesSourceId:this._chartModel.mainSeries().id(),sharingMode:e},o=this._chartModel.mainSeries(),n=(0,r.ensureNotNull)(this._chartModel.paneForSource(o)),a=this._allLineToolsAndStudyStubs.get(n.id());return this._makeLoadRequestAndMerge(s,(i=>{const s=t&&a?Array.from(a.keys()).filter((e=>!i(e))):[];this._unloadLineTools(s,(e=>!e.boundToSymbol()&&e.ownerSource()===o),e)}),void 0,i)}_recalculateHasChanges(){this._hasChanges.setValue(this._tryToSaveChartStateMigrationsOnce?this._invalidatedLineToolsAndStudyStubs.size>0||this._invalidatedLineToolGroups.size>0||this._migratedSharedLineToolsDuplicates.size>0:B(this._invalidatedLineToolsAndStudyStubs)||B(this._invalidatedLineToolGroups)||this._migratedSharedLineToolsDuplicates.size>0)}_generateOrigin(){return`${this._origin.layoutId}/${this._origin.chartId}/${this._origin.clientId}`}}function D(e){for(const[,t]of e)t.savedToChartContent=!0}function B(e){for(const[,t]of e)if(!t.savedToChartContent)return!0;return!1}function R(e){for(const[,t]of e)if(t.savedToChartContent)return!0;return!1}},863922:(e,t,i)=>{"use strict";var s;i.d(t,{SubsessionId:()=>s}),function(e){e.Regular="regular",e.Extended="extended",e.PreMarket="premarket",e.PostMarket="postmarket"}(s||(s={}))},451449:(e,t,i)=>{"use strict"
;i.d(t,{availableTimezones:()=>r,timezoneIsAvailable:()=>l,timezoneTitle:()=>c});var s=i(837575),o=i(180263);const r=(0,o.getAvailableTimezones)(),n=new Map;r.forEach((e=>{n.set(e.id,!0)}));const a=new Map;o.specialTimezones.concat(o.customTimezones).forEach((e=>{a.set(e.id,!0)}));function l(e){return n.has(e)}function c(e){for(const{id:t,title:i}of o.customTimezones)if(t===e){return`${i} (${(0,s.parseTzOffset)(e).string})`}for(const{id:t,title:i}of r)if(t===e)return`${i}`;return e}},837575:(e,t,i)=>{"use strict";i.d(t,{parseTzOffset:()=>o});var s=i(605678);function o(e,t=Date.now()){const i=(0,s.get_timezone)(e).offset_utc(t);let o="";const r=i/1e3/60/60;r%1&&(o=":"+Math.round(Math.abs(r%1*60)).toString().padStart(2,"0"));let n="";return n=r>0?"+"+(r-r%1)+o:0===r?"":String(r-r%1+o),{offset:i,string:"UTC"+n}}},180263:(e,t,i)=>{"use strict";i.d(t,{customTimezones:()=>n,getAvailableTimezones:()=>l,specialTimezones:()=>r});var s=i(729193),o=i(837575);const r=[{id:"Etc/UTC",get title(){return s.t(null,void 0,i(912255))}},{id:"exchange",get title(){return s.t(null,void 0,i(826607))}}],n=[{id:"Africa/Cairo",get title(){return s.t(null,void 0,i(351842))},offset:0},{id:"Africa/Casablanca",get title(){return s.t(null,void 0,i(252422))},offset:0},{id:"Africa/Johannesburg",get title(){return s.t(null,void 0,i(270330))},offset:0},{id:"Africa/Lagos",get title(){return s.t(null,void 0,i(950516))},offset:0},{id:"Africa/Nairobi",get title(){return s.t(null,void 0,i(124934))},offset:0},{id:"Africa/Tunis",get title(){return s.t(null,void 0,i(307248))},offset:0},{id:"America/Anchorage",get title(){return s.t(null,void 0,i(827902))},offset:0},{id:"America/Argentina/Buenos_Aires",get title(){return s.t(null,void 0,i(214144))},offset:0},{id:"America/Bogota",get title(){return s.t(null,void 0,i(503353))},offset:0},{id:"America/Caracas",get title(){return s.t(null,void 0,i(572427))},offset:0},{id:"America/Chicago",get title(){return s.t(null,void 0,i(821448))},offset:0},{id:"America/El_Salvador",get title(){return s.t(null,void 0,i(451447))},offset:0},{id:"America/Halifax",get title(){return s.t(null,void 0,i(582386))},offset:0},{id:"America/Juneau",get title(){return s.t(null,void 0,i(202631))},offset:0},{id:"America/Lima",get title(){return s.t(null,void 0,i(157500))},offset:0},{id:"America/Los_Angeles",get title(){return s.t(null,void 0,i(408426))},offset:0},{id:"America/Mexico_City",get title(){return s.t(null,void 0,i(874607))},offset:0},{id:"America/New_York",get title(){return s.t(null,void 0,i(258117))},offset:0},{id:"America/Phoenix",get title(){return s.t(null,void 0,i(331959))},offset:0},{id:"America/Santiago",get title(){return s.t(null,void 0,i(514156))},offset:0},{id:"America/Sao_Paulo",get title(){return s.t(null,void 0,i(955430))},offset:0},{id:"America/Toronto",get title(){return s.t(null,void 0,i(163672))},offset:0},{id:"America/Vancouver",get title(){return s.t(null,void 0,i(59132))},offset:0},{id:"US/Mountain",get title(){return s.t(null,void 0,i(889529))},offset:0},{id:"Asia/Almaty",get title(){
return s.t(null,void 0,i(495703))},offset:0},{id:"Asia/Ashkhabad",get title(){return s.t(null,void 0,i(319044))},offset:0},{id:"Asia/Bahrain",get title(){return s.t(null,void 0,i(578665))},offset:0},{id:"Asia/Bangkok",get title(){return s.t(null,void 0,i(973574))},offset:0},{id:"Asia/Chongqing",get title(){return s.t(null,void 0,i(209632))},offset:0},{id:"Asia/Colombo",get title(){return s.t(null,void 0,i(205091))},offset:0},{id:"Asia/Dhaka",get title(){return s.t(null,void 0,i(360690))},offset:0},{id:"Asia/Dubai",get title(){return s.t(null,void 0,i(473275))},offset:0},{id:"Asia/Ho_Chi_Minh",get title(){return s.t(null,void 0,i(462702))},offset:0},{id:"Asia/Hong_Kong",get title(){return s.t(null,void 0,i(982197))},offset:0},{id:"Asia/Jakarta",get title(){return s.t(null,void 0,i(33130))},offset:0},{id:"Asia/Jerusalem",get title(){return s.t(null,void 0,i(704831))},offset:0},{id:"Asia/Karachi",get title(){return s.t(null,void 0,i(585442))},offset:0},{id:"Asia/Kabul",get title(){return s.t(null,void 0,i(480553))},offset:0},{id:"Asia/Kathmandu",get title(){return s.t(null,void 0,i(28247))},offset:0},{id:"Asia/Kolkata",get title(){return s.t(null,void 0,i(288651))},offset:0},{id:"Asia/Kuala_Lumpur",get title(){return s.t(null,void 0,i(347064))},offset:0},{id:"Asia/Kuwait",get title(){return s.t(null,void 0,i(395130))},offset:0},{id:"Asia/Manila",get title(){return s.t(null,void 0,i(361445))},offset:0},{id:"Asia/Muscat",get title(){return s.t(null,void 0,i(825414))},offset:0},{id:"Asia/Nicosia",get title(){return s.t(null,void 0,i(276547))},offset:0},{id:"Asia/Qatar",get title(){return s.t(null,void 0,i(933753))},offset:0},{id:"Asia/Riyadh",get title(){return s.t(null,void 0,i(78095))},offset:0},{id:"Asia/Seoul",get title(){return s.t(null,void 0,i(444418))},offset:0},{id:"Asia/Shanghai",get title(){return s.t(null,void 0,i(578831))},offset:0},{id:"Asia/Singapore",get title(){return s.t(null,void 0,i(643795))},offset:0},{id:"Asia/Taipei",get title(){return s.t(null,void 0,i(476026))},offset:0},{id:"Asia/Tehran",get title(){return s.t(null,void 0,i(74298))},offset:0},{id:"Asia/Tokyo",get title(){return s.t(null,void 0,i(798199))},offset:0},{id:"Asia/Yangon",get title(){return s.t(null,void 0,i(177354))},offset:0},{id:"Atlantic/Azores",get title(){return s.t(null,void 0,i(384964))},offset:0},{id:"Atlantic/Reykjavik",get title(){return s.t(null,void 0,i(753858))},offset:0},{id:"Australia/Adelaide",get title(){return s.t(null,void 0,i(501502))},offset:0},{id:"Australia/Brisbane",get title(){return s.t(null,void 0,i(890689))},offset:0},{id:"Australia/Perth",get title(){return s.t(null,void 0,i(350108))},offset:0},{id:"Australia/Sydney",get title(){return s.t(null,void 0,i(179934))},offset:0},{id:"Europe/Amsterdam",get title(){return s.t(null,void 0,i(21347))},offset:0},{id:"Europe/Athens",get title(){return s.t(null,void 0,i(984171))},offset:0},{id:"Europe/Belgrade",get title(){return s.t(null,void 0,i(808377))},offset:0},{id:"Europe/Berlin",get title(){return s.t(null,void 0,i(523124))},offset:0},{id:"Europe/Bratislava",
get title(){return s.t(null,void 0,i(948824))},offset:0},{id:"Europe/Brussels",get title(){return s.t(null,void 0,i(385926))},offset:0},{id:"Europe/Bucharest",get title(){return s.t(null,void 0,i(664531))},offset:0},{id:"Europe/Budapest",get title(){return s.t(null,void 0,i(590243))},offset:0},{id:"Europe/Copenhagen",get title(){return s.t(null,void 0,i(366952))},offset:0},{id:"Europe/Dublin",get title(){return s.t(null,void 0,i(430868))},offset:0},{id:"Europe/Helsinki",get title(){return s.t(null,void 0,i(615140))},offset:0},{id:"Europe/Istanbul",get title(){return s.t(null,void 0,i(207798))},offset:0},{id:"Europe/Lisbon",get title(){return s.t(null,void 0,i(5072))},offset:0},{id:"Europe/London",get title(){return s.t(null,void 0,i(246507))},offset:0},{id:"Europe/Luxembourg",get title(){return s.t(null,void 0,i(975447))},offset:0},{id:"Europe/Madrid",get title(){return s.t(null,void 0,i(431892))},offset:0},{id:"Europe/Malta",get title(){return s.t(null,void 0,i(563237))},offset:0},{id:"Europe/Moscow",get title(){return s.t(null,void 0,i(446074))},offset:0},{id:"Europe/Oslo",get title(){return s.t(null,void 0,i(849738))},offset:0},{id:"Europe/Paris",get title(){return s.t(null,void 0,i(617874))},offset:0},{id:"Europe/Prague",get title(){return s.t(null,void 0,i(544403))},offset:0},{id:"Europe/Riga",get title(){return s.t(null,void 0,i(229643))},offset:0},{id:"Europe/Rome",get title(){return s.t(null,void 0,i(225991))},offset:0},{id:"Europe/Stockholm",get title(){return s.t(null,void 0,i(255511))},offset:0},{id:"Europe/Tallinn",get title(){return s.t(null,void 0,i(652176))},offset:0},{id:"Europe/Vienna",get title(){return s.t(null,void 0,i(61442))},offset:0},{id:"Europe/Vilnius",get title(){return s.t(null,void 0,i(100301))},offset:0},{id:"Europe/Warsaw",get title(){return s.t(null,void 0,i(164736))},offset:0},{id:"Europe/Zurich",get title(){return s.t(null,void 0,i(473496))},offset:0},{id:"Pacific/Auckland",get title(){return s.t(null,void 0,i(4216))},offset:0},{id:"Pacific/Chatham",get title(){return s.t(null,void 0,i(818846))},offset:0},{id:"Pacific/Fakaofo",get title(){return s.t(null,void 0,i(104177))},offset:0},{id:"Pacific/Honolulu",get title(){return s.t(null,void 0,i(899791))},offset:0},{id:"Pacific/Norfolk",get title(){return s.t(null,void 0,i(967412))},offset:0}];function a(e,t,i){const s=function(e){return e.map((e=>{const{id:t}=e,{string:i,offset:s}=(0,o.parseTzOffset)(t);return{id:t,offset:s,get title(){return`(${i}) ${e.title}`}}}))}(e),r=i.filter((({alias:e})=>Boolean(e))).map((e=>{const{alias:t,id:i}=e,{string:s,offset:r}=(0,o.parseTzOffset)(t);return{id:i,offset:r,get title(){return`(${s}) ${e.title}`},alias:t}})),n=function(e){return e.sort(((e,t)=>{const i=e.offset-t.offset;return 0!==i?i:e.title.localeCompare(t.title)}))}(s.concat(r));return t.concat(n)}function l(){return a(n,r,[])}},913947:(e,t,i)=>{"use strict";i.d(t,{TranslatedString:()=>s});class s{constructor(e,t){this._originalText=e,this._translatedText=t}originalText(){return this._originalText}translatedText(){return this._translatedText
}format(e){const t={},i={};for(const o of Object.keys(e)){const r=e[o];r instanceof s?(t[o]=r.originalText(),i[o]=r.translatedText()):(t[o]=r.toString(),i[o]=r.toString())}const o=this._originalText.format(t),r=this._translatedText.format(i);return new s(o,r)}}},42540:(e,t,i)=>{"use strict";i.d(t,{trackButtonClick:()=>o});var s=i(637581);function o(e,t,i,o){(0,s.getTracker)().then((s=>{null!==s&&s.trackToolbarButtonClick(e,i?`${t} ${i}`:t,o)}))}},563335:(e,t,i)=>{"use strict";i.d(t,{ActionWithStandardIcon:()=>r});var s=i(657130),o=i(812087);class r extends s.Action{constructor(e){const{options:t,customActionOptions:i}=e;t.iconId&&(t.icon=t.icon??o.icons.get(t.iconId)),i&&i.iconId&&(i.icon=i.icon??o.icons.get(i.iconId)),super(e)}}},812087:(e,t,i)=>{"use strict";i.d(t,{icons:()=>W});var s=i(190355),o=i(609096),r=i(812084),n=i(514216),a=i(258567),l=i(436875),c=i(560203),h=i(534756),d=i(570362),u=i(124321),_=i(36321),p=i(685023),m=i(418986),g=i(52108),S=i(16242),v=i(740008),f=i(651124),b=i(428864),y=i(779851),w=i(807563),C=i(962494),T=i(230252),P=i(592753),M=i(232717),x=i(51867),I=i(214186),L=i(631963),A=i(290044),k=i(867174),E=i(765353),D=i(697085),B=i(713140),R=i(387638),V=i(93721),O=i(816953);let N=[["Chart.Reset",w],["Chart.RemoveSelectedObject",C],["Settings",y],["Chart.Hide",T],["Chart.SymbolInfo",P],["Chart.VisualOrder",M],["Chart.ShowObject",x],["Chart.PriceScale",I],["Chart.Move",L],["Chart.ApplyIndicator",A],["Chart.UnlockObject",k],["Chart.LockObject",E],["Chart.AnchorLineTool",D],["Chart.InsertRowTable",B],["Chart.InsertColumnTable",R],["Chart.RemoveRowTable",C],["Chart.RemoveColumnTable",C],["Chart.Clone",V],["Chart.AddHorzLine",O],["Indicator.AddToFavorites",b]];N=N.concat([["TextNote.Add",h],["Watchlist.AddSymbol",c],["Watchlist.CreateNew",c],["Chart.Financials",d],["Chart.Technicals",u],["Alert.Add",_],["Alert.Edit",p],["Alert.Restart",g],["Alert.Stop",S],["Alert.FiresDownload",m],["Alert.Clear",v],["Chart.DetailsMetrics",f]]),N=N.concat([["Chart.ShowDataWindow",s],["Trading.Sell",o],["Trading.Buy",r],["Trading.AddOrder",n],["ObjectsTree.CreateGroup",a],["ObjectsTree.RenameItem",l],["Watchlist.AddSymbol",c]]);const W=new Map(N)},301406:(e,t,i)=>{"use strict";function s(){return Promise.all([i.e(25118),i.e(83617),i.e(26395),i.e(70438),i.e(26492),i.e(93868),i.e(67618),i.e(60802),i.e(43508),i.e(38953),i.e(47723)]).then(i.bind(i,872068))}i.d(t,{actionsProviderModule:()=>s})},854906:(e,t,i)=>{"use strict";i.d(t,{chartFloatingTooltipEnabledWV:()=>a});var s=i(950808),o=i(168509);const r="chart_floating_tooltip_enabled";function n(){return s.getJSON(r,true)}const a=new o.WatchedValue(n());a.subscribe((()=>s.setValue(r,a.value()))),s.onSync.subscribe(null,(()=>a.setValue(n())))},247553:(e,t,i)=>{"use strict";i.d(t,{ChartHotkeysListener:()=>g,globalEnvironmentState:()=>m,modifierPressed:()=>p,shiftPressed:()=>_});var s=i(284278),o=i(277637),r=i(913884),n=i(101458);var a=i(168509),l=i(45726)
;const c=new a.WatchedValue(Boolean((s.pressedKeys.value()??0)&o.Modifiers.Shift)),h=new a.WatchedValue(Boolean((s.pressedKeys.value()??0)&o.Modifiers.Mod)),d=new a.WatchedValue(Boolean((s.pressedKeys.value()??0)&o.Modifiers.Alt)),u=[o.Modifiers.None,o.Modifiers.Alt,o.Modifiers.Mod,o.Modifiers.Alt+o.Modifiers.Shift];function _(){return c}function p(){return h}function m(){return new l.EnvironmentState({altKey:d.value(),ctrlKey:p().value(),metaKey:p().value(),shiftKey:_().value()})}s.pressedKeys.subscribe(((e=0)=>{c.setValue(Boolean(e&o.Modifiers.Shift)),h.setValue(Boolean(e&o.Modifiers.Mod)),d.setValue(Boolean(e&o.Modifiers.Alt))}));class g{constructor(e,t){this._pressedKeyCode=null,this._boundKeydownHandler=null,this._boundKeyupHandler=null,this._chartWidget=e,this._parent=t,this._boundKeydownHandler=this._keydownHandler.bind(this),this._boundKeyupHandler=this._keyupHandler.bind(this),this._parent.ownerDocument.addEventListener("keydown",this._boundKeydownHandler),this._parent.ownerDocument.addEventListener("keyup",this._boundKeyupHandler)}destroy(){null!==this._boundKeydownHandler&&(this._parent.ownerDocument.removeEventListener("keydown",this._boundKeydownHandler),this._boundKeydownHandler=null),null!==this._boundKeyupHandler&&(this._parent.ownerDocument.removeEventListener("keyup",this._boundKeyupHandler),this._boundKeyupHandler=null)}_keydownHandler(e){this._chartWidget.hasModel()&&this._chartWidget.isActive().value()&&(e.defaultPrevented||("text-editor"===window.document.activeElement?.getAttribute("data-name")&&this._handleTabKeyDown(e)||window.document.activeElement===window.document.body&&(this._handleMoveDrawingsKeyDown(e)||this._handleScrollKeyDown(e)||this._handleZoomKeyDown(e)))&&e.preventDefault())}_keyupHandler(e){this._chartWidget.hasModel()&&this._handleScrollKeyUp(e)}_handleTabKeyDown(e){const t=255&(0,o.hashFromEvent)(e),i=this._chartWidget.model();if(9===t){const t=i.selection().dataSources()[0];if(void 0!==t&&(s=t,(0,n.isLineTool)(s)&&"LineToolTable"===s.state().type)){const i=(0,o.modifiersFromEvent)(e);return t.switchActiveCell(i===o.Modifiers.Shift)}return!1}var s;return!1}_handleMoveDrawingsKeyDown(e){const t=255&(0,o.hashFromEvent)(e),i=this._chartWidget.model();switch(t){case 37:return i.moveSelectedToolsLeft();case 39:return i.moveSelectedToolsRight();case 38:return i.moveSelectedToolsUp();case 40:return i.moveSelectedToolsDown()}return!1}_handleScrollKeyDown(e){if(null!==this._pressedKeyCode)return!1;const t=(0,o.hashFromEvent)(e),i=255&t,s=(0,o.modifiersFromEvent)(e);let n;if(37===i)n=1;else{if(39!==i)return!1;n=-1}if(o.isMacKeyboard&&s===o.Modifiers.Mod||!u.includes(s))return!1;if((0,r.isNativeUIInteraction)(t,e.target))return!1;this._pressedKeyCode=i;const a=this._chartWidget.scrollHelper();return s===o.Modifiers.None?a.moveByBar(n):s===o.Modifiers.Alt||s===o.Modifiers.Mod?a.move(n):-1===n?a.scrollToRealtime(!0):a.scrollToFirstBar(),!0}_handleScrollKeyUp(e){if(null===this._pressedKeyCode)return!1;const t=(0,o.hashFromEvent)(e);if((0,r.isNativeUIInteraction)(t,e.target))return!1
;return(255&t)===this._pressedKeyCode&&(this._pressedKeyCode=null,this._chartWidget.scrollHelper().stopMove(),!0)}_handleZoomKeyDown(e){const t=(0,o.hashFromEvent)(e),i=255&t;if((0,o.modifiersFromEvent)(e)!==o.Modifiers.Mod||(0,r.isNativeUIInteraction)(t,e.target))return!1;const s=this._chartWidget.model();if(38===i)s.zoomIn();else{if(40!==i)return!1;s.zoomOut()}return!0}}},880753:(e,t,i)=>{"use strict";i.d(t,{CHART_FONT_FAMILY:()=>n,CHART_MONOSPACE_FONT_FAMILY:()=>a});var s=i(702203);const o="'Trebuchet MS', Roboto, Ubuntu, sans-serif",r=`-apple-system, BlinkMacSystemFont, ${o}`;let n=((0,s.isOnMobileAppPage)("old"),o);const a="monospace";{const e=["U+2E80-2FD5","U+3040-309F","U+1B100-1B12F","U+1AFF0-1AFFF","U+1B000-1B0FF","U+1B130-1B16F","U+3190-319F","U+30A0-30FF","U+31F0-31FF","U+3400-4DBF","U+4E00-9FFF","U+0E00-0E7F"],t=n;(async()=>{if(!/iPhone OS 15_\d+?/.test(navigator.userAgent))return r;{if(["kr","zh_CN","zh_TW"].includes(window.locale))return n;const t=new FontFace("ChartIosFont","local(Helvetica), local(Arial)",{unicodeRange:e.join(", ")});try{return document.fonts.add(await t.load()),`ChartIosFont, ${r}`}catch(e){return n}}})().then((e=>{t===n&&(n=e)}))}},807434:(e,t,i)=>{"use strict";i.d(t,{ChartWidgetCollection:()=>sg});var s=i(209539),o=i(750586),r=i(883991),n=i(385955),a=i(185842),l=i(77357),c=i(605678),h=i(729193),d=i(266150),u=i(589589),_=i(376596),p=i(990221),m=i(582569),g=i(875500);const S=(0,l.getLogger)("Common.UndoStack");class v{constructor(){this._commands=[],this._onChange=new g.Delegate}onChange(){return this._onChange}isEmpty(){return 0===this._commands.length}size(){return this._commands.length}clear(){this.isEmpty()||(this._commands.length=0,this._onChange.fire())}push(e){if(!(e instanceof m.UndoCommand))throw new TypeError("argument must be an instance of UndoCommand");this._commands.push(e),this._onChange.fire(e)}pop(){if(this.isEmpty())return void S.logDebug("pop: undo stack is empty");const e=this._commands.pop();return this._onChange.fire(e),e}head(){if(!this.isEmpty())return this._commands[this._commands.length-1]}}class f extends m.UndoCommand{constructor(e){super(e,!1),this._subcommands=[]}addCommand(e){this._subcommands.push(e)}isEmpty(){return 0===this._subcommands.length}redo(e){for(let t=0;t<this._subcommands.length;t++)this._subcommands[t].redo(e)}undo(e){for(let t=this._subcommands.length-1;t>=0;t--)this._subcommands[t].undo(e)}commands(){return this._subcommands}affectsState(){return this._subcommands.some((e=>e.affectsState()))}}class b extends m.UndoCommand{constructor(e,t,i,s,o=!0){super(s,void 0,o),this._setter=e,this._oldValue=t,this._newValue=i}redo(){this._setter(this._newValue)}undo(){this._setter(this._oldValue)}}class y extends b{constructor(e,t,i,s,o=!0){super((e=>this._vwState.setValue(e)),t,i,s,o),this._vwState=e}}const w=(0,l.getLogger)("Common.UndoHistory");class C extends m.UndoCommand{constructor(e,t){super(null),this._chartModel=e,this._targetIndex=t}redo(){const e=this._chartModel.createPane(this._targetIndex,void 0,this._paneId);this._paneId=e.id()}
undo(){const e=(0,a.ensureDefined)(this._paneId),t=this._chartModel.panes().find((t=>t.id()===e));void 0!==t&&this._chartModel.removePane(t)}createdPaneId(){return this._paneId}}var T=i(466269),P=i(913947),M=i(948660);const x=new P.TranslatedString("change chart layout to {title}",h.t(null,void 0,i(9939)));class I extends m.UndoCommand{constructor(e,t){super(x.format({title:M.layouts[t].title})),this._chartWidgetCollection=e,this._newLayoutType=t,this._oldLayoutType=e.layout.value()}redo(){this._chartWidgetCollection.setLayout(this._newLayoutType)}undo(){this._chartWidgetCollection.setLayout(this._oldLayoutType)}}var L=i(64906),A=i(513852);const k=new P.TranslatedString("apply toolbars theme",h.t(null,void 0,i(663128)));class E extends m.UndoCommand{constructor(e,t,i=!0){super(k),this._prevThemeName=e,this._themeName=t,this._syncState=i}undo(){(0,L.isStdThemeName)(this._prevThemeName)&&((0,A.setTheme)(this._prevThemeName),this._syncState&&(0,L.syncTheme)())}redo(){(0,L.isStdThemeName)(this._themeName.toLowerCase())&&((0,A.setTheme)(this._themeName.toLowerCase()),this._syncState&&(0,L.syncTheme)())}}var D=i(49833),B=i(284278),R=i(950808),V=i(474422),O=i(277637),N=i(246445),W=i(702203),F=i(18107),z=i(690522),H=i(168509);function U(e){const t={};return{promise:new Promise(((i,s)=>{e.subscribe(t,i,!0)})),destroy:()=>{e.unsubscribeAll(t)}}}var G=i(65890),j=i(599730),q=i(149497),$=i(357966),K=i(781434),Z=i(998918);class Y extends Z.DialogRenderer{constructor(e){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)},this._chartWidgetCollection=e}show(e){const t=this._chartWidgetCollection,s=t.activeChartWidget.value()
;return s.generalPropertiesDefinitions().then((o=>Promise.all([i.e(99625),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(31788),i.e(15365),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(92597),i.e(18257),i.e(86834),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(33160),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(52253),i.e(44589),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(68805),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(5246),i.e(80387),i.e(75174),i.e(87795),i.e(57350),i.e(16803),i.e(26729),i.e(31403),i.e(37865),i.e(93807),i.e(4058),i.e(6437),i.e(25947),i.e(96840),i.e(23616),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(83754),i.e(87580),i.e(80928),i.e(90128),i.e(49515),i.e(21148),i.e(66985),i.e(7558),i.e(33269),i.e(11644),i.e(16531),i.e(57435),i.e(22783),i.e(39656),i.e(32078),i.e(87410),i.e(63726),i.e(51493),i.e(76037),i.e(69e3),i.e(66446),i.e(9325),i.e(34666),i.e(27024),i.e(88481),i.e(52694),i.e(35897),i.e(92642),i.e(81968),i.e(30468),i.e(37929),i.e(91987),i.e(75350),i.e(64388),i.e(8762),i.e(99826),i.e(32140),i.e(52316),i.e(50438),i.e(50889),i.e(30454),i.e(74686),i.e(32387),i.e(36295),i.e(80915),i.e(67534),i.e(17686),i.e(67890),i.e(53233),i.e(13349),i.e(98784),i.e(63056),i.e(28435),i.e(12796),i.e(74607),i.e(82106),i.e(6877),i.e(8046),i.e(87613),i.e(76325),i.e(68189),i.e(95571),i.e(50625)]).then(i.bind(i,917708)).then((i=>{const r=new i.GeneralChartPropertiesDialogRenderer({chartWidgetCollection:t,propertyPages:o,activePageId:this._activePageId,model:s.model()});return this._dialog?.hide(),this._dialog?.visible().unsubscribe(this._subscribe),this._dialog=r,r.visible().subscribe(this._subscribe),r.show(e),this._activePageId=void 0,r}))))}hide(){this._dialog?.hide()}isVisible(){return this.visible().value()}focusOnText(){}setActivePage(e){this._activePageId=e}}class X extends Z.DialogRenderer{constructor(e){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)},this._chartWidgetCollection=e}show(e){this._load().then((t=>{this._dialog?.hide(),this._dialog?.visible().unsubscribe(this._subscribe),this._dialog=t,t.visible().subscribe(this._subscribe),t.show(e),N.emit("compare_add")}))}hide(){this._dialog?.hide()}_load(){
return Promise.all([Promise.all([i.e(56035),i.e(17336)]).then(i.bind(i,242674)),Promise.all([i.e(92962),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(31788),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(92597),i.e(18257),i.e(86834),i.e(98729),i.e(27688),i.e(56752),i.e(20432),i.e(35424),i.e(33160),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(52253),i.e(44589),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(68805),i.e(59717),i.e(63935),i.e(29984),i.e(4050),i.e(30796),i.e(5246),i.e(80387),i.e(75174),i.e(87795),i.e(57350),i.e(16803),i.e(37865),i.e(93807),i.e(4058),i.e(96840),i.e(23616),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(87580),i.e(80928),i.e(90128),i.e(21148),i.e(32078),i.e(87410),i.e(63726),i.e(51493),i.e(76037),i.e(69e3),i.e(9325),i.e(88481),i.e(92642),i.e(83986),i.e(28602),i.e(64108),i.e(32387),i.e(36295),i.e(80915),i.e(17686),i.e(67890),i.e(53233),i.e(13349),i.e(98784),i.e(12796),i.e(74607),i.e(82106),i.e(6877),i.e(40401),i.e(22347)]).then(i.bind(i,28014))]).then((([e,t])=>{const i=new e.CompareModel(this._chartWidgetCollection);return t.getCompareDialogRenderer(i)}))}}var J=i(188485),Q=i(70346);const ee=()=>Promise.all([i.e(11151),i.e(93528)]).then(i.bind(i,148332));function te(e,t={}){return ee().then((i=>i.copyToClipboardImageOfChart(e,t)))}function ie(e,t={}){return ee().then((i=>i.getImageOfChartSilently(e,t)))}var se=i(187614);var oe=i(389960),re=i(322868);const ne=new P.TranslatedString("swap charts in the Layout",h.t(null,void 0,i(209599)));class ae extends m.UndoCommand{constructor(e,t,i){super(ne),this._swapper=e,this._from=t,this._to=i}redo(){this._swapper(this._from,this._to)}undo(){this._swapper(this._from,this._to)}}var le=i(707597);function ce(e){const{fullId:t,pine:i}=e;return`${t}${i?`[v.${i.version}]`:""}`}const he=/([\w,%,$,;,@,-]*)\[v.([\w,.,-]*)\]/;function de(e){const t=he.exec(e);return t?{fullId:t[1],pine:{version:t[2]}}:{fullId:e}}var ue=i(8914);const _e="replay_mode";function pe(){return _.CheckMobile.any()?"ActiveChart":R.getValue(_e,"ActiveChart")}const me=(0,ue.createPrimitiveProperty)(pe());R.onSync.subscribe(null,(()=>me.setValue(pe()))),me.subscribe(null,(()=>R.setValue(_e,me.value())));var ge=i(598944),Se=i(943462),ve=i(679399);const fe=(0,l.getLogger)("TimingsMeter.Service"),be=(0,l.getLogger)("TimingsMeter.Stats",{maxCount:160});function ye(){return{[ve.InvalidationLevel.None]:{count:0,lastTime:0,maxTime:0,totalTime:0},[ve.InvalidationLevel.Cursor]:{count:0,lastTime:0,maxTime:0,totalTime:0},[ve.InvalidationLevel.Light]:{count:0,lastTime:0,maxTime:0,totalTime:0},[ve.InvalidationLevel.Full]:{count:0,lastTime:0,maxTime:0,totalTime:0}}}function we(e,t){e.lastTime=t,e.totalTime+=t,++e.count,t>e.maxTime&&(e.maxTime=t)}function Ce(e){return e.toFixed(2)}function Te(e){const t=e.count;if(0===t)return"no events";const i=e.totalTime/t,s=Ce(e.maxTime);return`count=${t}, last=${Ce(e.lastTime)}, max=${s}, avg=${Ce(i)}`}class Pe{
constructor(e){this._waitDrawStartTime=-1,this._startDrawTime=-1,this._currentDrawLevel=ve.InvalidationLevel.Full,this._currentDrawItems=ye(),this._currentWaitingItem={count:0,lastTime:0,maxTime:0,totalTime:0},this._dumpTimingsStatsInterval=0,this._logPrefix=`[${e}]`}destroy(){this.stopCollect()}startCollect(){0!==this._dumpTimingsStatsInterval&&(fe.logWarn(`${this._logPrefix} Multiple start detected`),this.stopCollect()),this._clearCurrentState(),this._dumpTimingsStatsInterval=setInterval(this._dumpTimingsStats.bind(this),15e3),fe.logNormal(`${this._logPrefix} Collecting started`)}stopCollect(){0!==this._dumpTimingsStatsInterval&&(clearInterval(this._dumpTimingsStatsInterval),this._dumpTimingsStatsInterval=0,fe.logNormal(`${this._logPrefix} Collecting stopped. Dumping last state...`),this._dumpTimingsStats())}startWaitingDraw(){this._waitDrawStartTime=window.performance.now()}startDraw(e){this._startDrawTime=window.performance.now(),this._currentDrawLevel=e}stopDraw(){const e=window.performance.now();if(-1===this._startDrawTime||-1===this._waitDrawStartTime)return;const t=this._startDrawTime-this._waitDrawStartTime;we(this._currentWaitingItem,t),this._waitDrawStartTime=-1;const i=e-this._startDrawTime;we(this._currentDrawItems[this._currentDrawLevel],i),this._startDrawTime=-1}_dumpTimingsStats(){const e=[this._logPrefix," awaiting:",Te(this._currentWaitingItem),"; cursor:",Te(this._currentDrawItems[ve.InvalidationLevel.Cursor]),"; light:",Te(this._currentDrawItems[ve.InvalidationLevel.Light]),"; full:",Te(this._currentDrawItems[ve.InvalidationLevel.Full])].join("");be.logNormal(e),this._clearCurrentState()}_clearCurrentState(){this._currentDrawItems=ye(),this._currentWaitingItem={count:0,lastTime:0,maxTime:0,totalTime:0}}}i(780927);var Me=i(491628);var xe=i(313079);var Ie=i(783014),Le=i(797001),Ae=i(537244),ke=i(788312),Ee=i(822707),De=i(547290),Be=i(746587),Re=i(934101),Ve=i(254236),Oe=i(935490),Ne=i(320542),We=i(312116),Fe=i(353741),ze=i(123817),He=i(609344);const Ue=new class{constructor(){this._timerWorker=null,this._timerIdCounter=1,this._timersMap=new Map,this._rejectsToCall=new Set,this._processMessage=e=>{const t=this._timersMap.get(e.data.turnaround);switch(e.data.type){case"timerCreated":t&&(t.scheduledForRemoving?("interval"===t.type?this._getTimerWorker().postMessage({type:"clearInterval",id:e.data.id}):this._getTimerWorker().postMessage({type:"clearTimeout",id:e.data.id}),this._deleteTimerFromMap(e.data.turnaround)):t.workerTimerId=e.data.id);break;case"timerFired":t&&(t.callback(),"timeout"===t.type&&this._deleteTimerFromMap(e.data.turnaround))}}}destroy(){this._rejectsToCall.forEach((e=>e((0,ze.createAbortError)()))),this._timerWorker?.terminate(),this._timerWorker=null,this._timersMap.clear()}setTimeout(e,t){return this._setTimeoutImpl(e,t,"timeout")}clearTimeout(e){const t=this._timersMap.get(e);t&&(t.workerTimerId?(this._getTimerWorker().postMessage({type:"clearTimeout",id:t.workerTimerId}),this._deleteTimerFromMap(e)):t.scheduledForRemoving=!0)}setInterval(e,t){const i=this._nextTimerId()
;return this._timersMap.set(i,{callback:e,type:"interval"}),this._getTimerWorker().postMessage({type:"setInterval",delay:t,turnaround:i}),i}clearInterval(e){const t=this._timersMap.get(e);t&&(t.workerTimerId?(this._getTimerWorker().postMessage({type:"clearInterval",id:t.workerTimerId}),this._deleteTimerFromMap(e)):t.scheduledForRemoving=!0)}async createTimeout(e,t){let i;return new Promise(((s,o)=>{i=o,this._rejectsToCall.add(i);const r=this.setTimeout(s,e);t?.signal?.addEventListener("abort",(()=>{this.clearTimeout(r),o((0,ze.createAbortError)())}))})).finally((()=>{this._rejectsToCall.delete(i)}))}async*createInterval(e,t){let i=()=>{},s=e=>{};const o=this.setInterval((()=>{i()}),e);t.signal.addEventListener("abort",(()=>{this.clearInterval(o),s((0,ze.createAbortError)())}));try{for(;;)await new Promise(((e,t)=>{i=e,this._rejectsToCall.delete(s),s=t,this._rejectsToCall.add(s)})),yield}catch(e){if(!(0,ze.isAbortError)(e))throw e}}_getTimerWorker(){return null===this._timerWorker&&(this._timerWorker=new He.Worker(new URL(i.p+i.u(84206),i.b),{name:"Timer worker"}),this._timerWorker.onmessage=this._processMessage),this._timerWorker}_setTimeoutImpl(e,t,i){const s=this._nextTimerId();return this._timersMap.set(s,{callback:e,type:i}),this._getTimerWorker().postMessage({type:"setTimeout",delay:t,turnaround:s}),s}_deleteTimerFromMap(e){if(this._timersMap.delete(e),0===this._timersMap.size){const e=this._setTimeoutImpl((()=>{1===this._timersMap.size&&this._timersMap.has(e)&&(this._timersMap.delete(e),this._timerWorker?.terminate(),this._timerWorker=null)}),6e4,"terminal_timer")}}_nextTimerId(){return this._timerIdCounter++}},Ge=new Set(["chart_storage_hibernation_delay_60min","chart_storage_hibernation_delay_10min","chart_storage_hibernation_delay_5min"]);const je=new H.WatchedValue(qe());function qe(){return(0,ke.isFeatureEnabled)("chart_storage_hibernation_delay_60min")?36e5:(0,ke.isFeatureEnabled)("chart_storage_hibernation_delay_10min")?6e5:(0,ke.isFeatureEnabled)("chart_storage_hibernation_delay_5min")?3e5:6e4}(0,ke.onFeaturesStateChanged)().subscribe(null,(e=>{if(!function(e){return Ge.has(e)}(e))return;const t=qe();je.setValue(t,!1)}));const $e=je.readonly();function Ke(e){const t=document.querySelector('link[rel~="chart-storage-notifications"]');return t?.href?e?new URL(e,t.href):new URL(t.href):null}function Ze(e,t){return Boolean(e.metaInfo.uid.value())&&!t.containsData&&!t.onWidget&&function(){if(!(0,W.isOnMobileAppPage)("new"))return!0;const e=/TradingView\/(\d+)\.(\d+)\.(\d+)\.?/.exec(navigator.userAgent);if(null===e)return!0;const t=Number(e[1])-1,i=Number(e[2])-15,s=Number(e[3])-0;if(t>0||0===t&&i>0||0===t&&0===i&&s>0)return!0;return!1}()&&null!==Ke()}const Ye=(0,l.getLogger)("ChartStorageChangesSubscription");class Xe extends Oe.PersistentEventSourceTransport{constructor(e,t){super((e=>this._onMessage(e))),this._destroyed=!1,this._onChangeVisibilityBound=this._onChangeVisibility.bind(this),this._hibernateTimerId=null,this._hibernateDelay=$e.spawn(),this._beforeUnhibernating=new g.Delegate,
this._onChangesCallbacks=new Set,this._haveEverBeenHibernated=!1,this._fireBeforeUnhibernatingOnReconnect=!1,this._fireBeforeUnhibernatingOnReconnectTimerId=0,this._reconnect=()=>{this._tryReconnect()},this._chartWidgetsCollection=e,this._layoutVisibility=e.resizerBridge().visible.spawn(),this._layoutVisibility.subscribe(this._onChangeVisibilityBound,{callWithLast:!0}),Ve.telemetry.sendLineToolsStorageReport("line_tools_subscription_initial_connect"),this._connectionStatus.subscribe((e=>{e===Fe.ConnectionStatus.Closed&&Ve.telemetry.sendLineToolsStorageReport("line_tools_subscription_disconnected")})),this._subscribeForSharingLayout=t,this.connect(),this._hibernateDelay.subscribe((e=>{null!==this._hibernateTimerId&&this._scheduleHibernation(e)})),this._chartWidgetsCollection.metaInfo.uid.subscribe(this._reconnect)}destroy(){this._layoutVisibility.destroy(),this._hibernateDelay.destroy(),this._chartWidgetsCollection.metaInfo.uid.unsubscribe(this._reconnect),this.disconnect(),this._destroyed=!0}subscribeOnChanges(e){this._onChangesCallbacks.add(e)}unsubscribeOnChanges(e){this._onChangesCallbacks.delete(e)}beforeUnhibernating(){return this._beforeUnhibernating}async _prepareParamsForConnection(e){const t=this._chartWidgetsCollection.metaInfo.uid.value();if(this._destroyed)return Promise.reject("Subscription is being destroyed");const i=await(0,Ne.getStorageTarget)(t,"",0),s=Ke(`/charts-storage/layout/${t}/subscribe`);null!==s?(s.searchParams.delete("jwt"),s.searchParams.append("jwt",i.token),this._subscribeForSharingLayout&&window.user.id&&window.user.is_pro&&s.searchParams.append("id",""+window.user.id),this._url=s.toString()):this._url=""}_tryReconnectImpl(){super._tryReconnectImpl(),Ve.telemetry.sendLineToolsStorageReport("line_tools_subscription_reconnecting")}_onOpenCallback(){super._onOpenCallback(),this._fireBeforeUnhibernatingOnReconnect&&(Ye.logNormal("Unhibernating on reconnect"),this._beforeUnhibernating.fire(),this._fireBeforeUnhibernatingOnReconnect=!1,clearTimeout(this._fireBeforeUnhibernatingOnReconnectTimerId),this._fireBeforeUnhibernatingOnReconnectTimerId=0)}_onMessage(e){if("string"!=typeof e)throw new Error("Wrong message type, expected string");const t=JSON.parse(e);Object.entries(t).forEach((e=>{const t=(0,We.parseLineToolsAndGroupsDTO)(e[1],""),i=e[0];let s=0;i===Ne.sharedChartId?s=1:i===Ne.globallySharedChartId&&(s=2),this._chartWidgetsCollection.applyLineToolUpdateNotification(i,t,s)})),this._onChangesCallbacks.forEach((t=>t(e)))}_onChangeVisibility(){const e=this._layoutVisibility.value();Ye.logNormal(`Visibility changed to ${e}, connection status: ${this.connectionStatus().value()}`),e?this.connectionStatus().value()!==Fe.ConnectionStatus.Open?(this.connectionStatus().value()===Fe.ConnectionStatus.Closed&&this.connect(),this._beforeUnhibernating.fire(),this._haveEverBeenHibernated&&(Ye.logNormal("Connect due to becoming visible"),Ve.telemetry.sendLineToolsStorageReport("line_tools_unhibenate_subscription"))):((0,
W.isOnMobileAppPage)("any")||_.CheckMobile.iOS()||_.CheckMobile.Android())&&(Ye.logNormal("Schedule unhibernating on reconnect"),this._fireBeforeUnhibernatingOnReconnect=!0,clearTimeout(this._fireBeforeUnhibernatingOnReconnectTimerId),this._fireBeforeUnhibernatingOnReconnectTimerId=setTimeout((()=>{Ye.logNormal("Cancel Scheduled unhibernating on reconnect"),this._fireBeforeUnhibernatingOnReconnect=!1}),5e3)):e||this._scheduleHibernation($e.value())}_scheduleHibernation(e){null!==this._hibernateTimerId&&Ue.clearTimeout(this._hibernateTimerId),this._hibernateTimerId=Ue.setTimeout((()=>this._disconnectIfInvisible()),e)}_disconnectIfInvisible(){this._hibernateTimerId=null,this._layoutVisibility.value()||(Ye.logNormal("Disconnect due to becoming invisible"),this.disconnect(),Ve.telemetry.sendLineToolsStorageReport("line_tools_hibenate_subscription"),this._haveEverBeenHibernated=!0)}}var Je=i(391640),Qe=i(830213),et=i(127985);i(644329);function tt(e){return function(e){return ee().then((t=>t.downloadClientScreenshot(e)))}(e)}function it(e){return function(e){return ee().then((t=>t.copyToClipboardClientScreenshot(e)))}(e).then((()=>{(0,N.emit)("onClientScreenshotCopiedToClipboard")}))}const st={s:0,"2h":0,"2v":1,"3h":0,"3v":2,"3s":0,"3r":1,"2-1":1,"1-2":1,4:1,"4v":3,"4h":0,"4s":0,"4s-l":0,"1-3":1,"3-1":3,"2-2-l":0,"2-2-r":1,"2-2":3,"1-4":1,"5h":0,"5v":0,"5s":0,"5s-l":0,"2-3":2,"3-2":3,"4-1":4,"2-3-l":0,"2-3-r":2,6:1,"6h":0,"6v":0,"6c":4,"2-4":2,"4-2":4,"4-3":4,"7h":0,"7s":0,8:1,"8c":6,"8h":0,"8v":0,"9s":6,"5-4":5,"9h":0,"9v":0,"10c5":1,"10h":0,"10v":0,"12c6":1,"12c4":3,"12h":0,"14c7":1,"16c8":1,"16c4":3};var ot=i(584104),rt=i(465907),nt=i(425860),at=i(578519),lt=i(90570),ct=i(671535),ht=i(954231),dt=i(657415),ut=i(653048),_t=i(858328),pt=i(921619),mt=i(108425),gt=i(222993),St=i(19261),vt=i(322184),ft=i(992552);let bt;class yt extends Z.DialogRenderer{constructor(){super(),this._dialog=null,this._subscribe=e=>{this._setVisibility(e)}}show(){this._load().then((e=>e.show()))}hide(){this._dialog?.hide()}static getInstance(){return bt||(bt=new yt),bt}_load(){return Promise.all([i.e(86627),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(31788),i.e(15365),i.e(6406),i.e(19133),i.e(18257),i.e(86834),i.e(48011),i.e(20432),i.e(35424),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(75649),i.e(59717),i.e(29984),i.e(80387),i.e(87795),i.e(26729),i.e(497),i.e(66985),i.e(44591),i.e(24193),i.e(24025),i.e(57435),i.e(77141),i.e(87890),i.e(27450),i.e(53427),i.e(27247),i.e(32387),i.e(80915),i.e(53121),i.e(59982),i.e(25630),i.e(17686),i.e(67890),i.e(96976),i.e(45964),i.e(50176),i.e(84952)]).then(i.bind(i,587029)).then((e=>(this._dialog?.hide(),this._dialog?.visible().unsubscribe(this._subscribe),this._dialog=new e.ObjectTreeDialogRenderer,this._dialog.visible().subscribe(this._subscribe),this._dialog)))}}var wt=i(532180),Ct=i(603550);var Tt=i(495841);async function Pt(e,t,s,o,r,a="default"){let l,c=[];const d=e.model().model(),u=(0,
n.clone)(t),_=new Ct.Property({inputs:u}),p=function(e,t){return"symbol"===t?e.inputs.filter((t=>t.id===e.symbolInputId())):e.inputs.filter((e=>e.confirm))}(s,a),m=()=>{l&&d.removeCustomSource(l)},g=()=>{m(),r()},S=e=>{o({inputs:e,parentSources:c}),m()},v=p.filter(wt.isTimeOrPriceNotHiddenInput);if(v.length>0)try{const t=await Promise.all([i.e(14863),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(31788),i.e(15365),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(92597),i.e(18257),i.e(86834),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(33160),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(52253),i.e(44589),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(68805),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(5246),i.e(80387),i.e(75174),i.e(87795),i.e(57350),i.e(16803),i.e(37865),i.e(93807),i.e(4058),i.e(6437),i.e(96840),i.e(23616),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(87580),i.e(80928),i.e(90128),i.e(21148),i.e(7558),i.e(33269),i.e(22783),i.e(39656),i.e(32078),i.e(87410),i.e(63726),i.e(51493),i.e(76037),i.e(69e3),i.e(66446),i.e(9325),i.e(34666),i.e(27024),i.e(88481),i.e(52694),i.e(35897),i.e(92642),i.e(81968),i.e(30468),i.e(91987),i.e(64388),i.e(50438),i.e(37340),i.e(32387),i.e(36295),i.e(80915),i.e(17686),i.e(67890),i.e(53233),i.e(13349),i.e(98784),i.e(63056),i.e(28435),i.e(12796),i.e(74607),i.e(82106),i.e(6877),i.e(41494),i.e(8046),i.e(87613),i.e(68189),i.e(3039)]).then(i.bind(i,391604)),o=await t.selectInputValuesOnChart(e,v,_,s.shortDescription,s.inputs);if(l=o.customSourceId,o.destPane&&et.StudyMetaInfo.getSourceInputIds(s).length>0){const e=o.destPane.mainDataSource();c=e===d.mainSeries()?[]:[e]}else c=[]}catch(e){return void g()}
v.length!==p.length?Promise.all([i.e(14863),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(31788),i.e(15365),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(92597),i.e(18257),i.e(86834),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(33160),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(52253),i.e(44589),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(68805),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(5246),i.e(80387),i.e(75174),i.e(87795),i.e(57350),i.e(16803),i.e(37865),i.e(93807),i.e(4058),i.e(6437),i.e(96840),i.e(23616),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(87580),i.e(80928),i.e(90128),i.e(21148),i.e(7558),i.e(33269),i.e(22783),i.e(39656),i.e(32078),i.e(87410),i.e(63726),i.e(51493),i.e(76037),i.e(69e3),i.e(66446),i.e(9325),i.e(34666),i.e(27024),i.e(88481),i.e(52694),i.e(35897),i.e(92642),i.e(81968),i.e(30468),i.e(91987),i.e(64388),i.e(50438),i.e(37340),i.e(32387),i.e(36295),i.e(80915),i.e(17686),i.e(67890),i.e(53233),i.e(13349),i.e(98784),i.e(63056),i.e(28435),i.e(12796),i.e(74607),i.e(82106),i.e(6877),i.e(41494),i.e(8046),i.e(87613),i.e(68189),i.e(3039)]).then(i.bind(i,941145)).then((t=>{const o=new t.ConfirmInputsDialogRenderer(function(e){if("symbol"===e)return h.t(null,void 0,i(344320));return h.t(null,void 0,i(747259))}(a),p,_,a,s,S,g,(0,Tt.getTimezoneName)(e.model()));return o.show(),o})):S(_.state().inputs||{})}let Mt=null;var xt=i(96670),It=i(994497),Lt=i(451449);function At(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function kt(e){return e.reduce(((e,t)=>{for(const i in t)if(At(t,i)){const s=t[i],o=e[i];o?o.push(s):e[i]=[s]}return e}),{})}var Et=i(320093),Dt=i(247553);class Bt{constructor(e){this._chartModel=null,this._animation=null,this._chart=e,this._chart.withModel(this,(()=>{this._chartModel=this._chart.model()}))}destroy(){this._animation?.stop()}move(e){if(null!==this._chartModel){if(this._chartModel.timeScale().isEmpty())return;const t=.003,i=1.1,s=Math.round(i/t);this._moveImpl(((o,r,n)=>{const a=Math.min(r,s),l=e*t*Math.pow(a,2)/2;if(r<=s)return o+l;const c=Number.isFinite(n)?Math.max(0,s-n):0;return o+l+e*(r-a-c)*i+e*(i*c-t*Math.pow(c,2)/2)}),(e=>Math.max(0,s-e)+s))}}moveByBar(e){if(null!==this._chartModel){const t=this._chartModel.timeScale(),i=t.visibleBarsStrictRange();if(t.isEmpty()||null===i)return;const s=300,o=i.lastBar();this._moveImpl(((i,r)=>{const n=Math.floor(Math.max(0,r-s)/100)+1,a=o+e*n,l=t.indexToCoordinate(o);return i+(t.indexToCoordinate(a)-l)}),(()=>0),!0)}}stopMove(){this._animation?.stop(),this._animation=null}scrollToRealtime(e,t){if(null===this._chartModel)return;this._chartModel.timeScale().scrollToRealtime(e,t);const i=this._chart.chartWidgetCollection();!i.lock.dateRange.value()&&i.lock.trackTime.value()&&i.chartModels().value().forEach((t=>{t!==this._chartModel&&t.timeScale().scrollToRealtime(e)}))}scrollToFirstBar(){
this._chartModel?.timeScale().scrollToFirstBar()}_moveImpl(e,t,i){if(null===this._chartModel)return;const s=this._chartModel.timeScale();if(s.isEmpty())return;if(i&&null!==s.visibleBarsStrictRange()){const e=s.indexToCoordinate(s.visibleBarsStrictRange().lastBar())+s.barSpacing()/2;Math.abs(s.width()-e)>s.barSpacing()/6&&s.setRightOffset(Math.round(s.rightOffset()))}const o=performance.now();let r=1/0;this._animation={getStartPosition:()=>0,getPosition:t=>(t=Math.min(r,t),e(0,t-o,r-t)),finished:e=>e>=r,stop:()=>{const e=performance.now()-o;r=performance.now()+t(e)}},this._chartModel.model().stopTimeScaleAnimation(),this._chartModel.model().setTimeScaleAnimation(this._animation)}}var Rt=i(63138);let Vt=null;function Ot(e,t,s,o,r){return Promise.all([i.e(46458),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(31788),i.e(15365),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(92597),i.e(18257),i.e(86834),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(33160),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(52253),i.e(44589),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(68805),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(5246),i.e(80387),i.e(75174),i.e(87795),i.e(57350),i.e(16803),i.e(26729),i.e(31403),i.e(37865),i.e(93807),i.e(4058),i.e(6437),i.e(25947),i.e(96840),i.e(23616),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(83754),i.e(87580),i.e(80928),i.e(90128),i.e(49515),i.e(21148),i.e(66985),i.e(7558),i.e(33269),i.e(11644),i.e(16531),i.e(22783),i.e(39656),i.e(32078),i.e(87410),i.e(63726),i.e(81562),i.e(51493),i.e(76037),i.e(69e3),i.e(66446),i.e(9325),i.e(34666),i.e(27024),i.e(88481),i.e(52694),i.e(35897),i.e(92642),i.e(25361),i.e(81968),i.e(30468),i.e(37929),i.e(91987),i.e(64388),i.e(8762),i.e(32140),i.e(52316),i.e(50438),i.e(30454),i.e(3048),i.e(21341),i.e(73578),i.e(32387),i.e(36295),i.e(80915),i.e(53121),i.e(67534),i.e(6181),i.e(17686),i.e(67890),i.e(53233),i.e(13349),i.e(98784),i.e(63056),i.e(28435),i.e(12796),i.e(74607),i.e(82106),i.e(6877),i.e(8046),i.e(87613),i.e(76325),i.e(68189),i.e(95571),i.e(9258),i.e(25237)]).then(i.bind(i,280883)).then((i=>{Vt?.hide();const n=i.EditObjectDialogRenderer;return Vt=new n(e,t,o,r),Vt.show(s),Vt}))}var Nt=i(44408);let Wt=null;function Ft(e){return e&&e.lollipopsAtIndex}let zt=null,Ht=null;var Ut=i(101458),Gt=i(196806);const jt={[Rt.TabNames.symbol]:"symbol",[Rt.TabNames.legend]:"legend",[Rt.TabNames.scales]:"scales",[Rt.TabNames.trading]:"trading",[Rt.TabNames.events]:"events",[Rt.TabNames.alerts]:"alerts",[Rt.TabNames.timezoneSessions]:"canvas",[Rt.TabNames.text]:"text",[Rt.TabNames.style]:"style",[Rt.TabNames.visibility]:"visibility"},qt={[Rt.TabNames.style]:"style",[Rt.TabNames.visibility]:"visibilities"};async function $t(e,t,s={},o,r){const a=o.activeChartWidget.value(),{initialTab:l,tabName:c}=s;if(c&&!l&&(s.initialTab=qt[c]),(0,Gt.isStudyLineTool)(e)&&function(e){if(!(0,
Gt.isStudyLineTool)(e))return!1;return["LineToolFixedRangeVolumeProfile","LineToolVbPFixed","LineToolAnchoredVolumeProfile"].filter(n.notNull).some((t=>e.toolname===t))}(e))return a.propertiesDefinitionsForSource(e).then((i=>null!==i?Ot(e,t,s,r,i):null));if((0,Nt.isStudy)(e)&&function(e){const{shortId:t}=e.metaInfo();return"Overlay"===t}(e)||(0,Ut.isLineTool)(e))return a.propertiesDefinitionsForSource(e).then((o=>{if(null!==o){return function(e){return Promise.all([i.e(81055),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(31788),i.e(15365),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(92597),i.e(18257),i.e(86834),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(33160),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(52253),i.e(44589),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(68805),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(5246),i.e(80387),i.e(75174),i.e(87795),i.e(57350),i.e(16803),i.e(26729),i.e(31403),i.e(37865),i.e(93807),i.e(4058),i.e(6437),i.e(25947),i.e(96840),i.e(23616),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(83754),i.e(87580),i.e(80928),i.e(90128),i.e(49515),i.e(21148),i.e(66985),i.e(7558),i.e(33269),i.e(11644),i.e(16531),i.e(22783),i.e(39656),i.e(32078),i.e(87410),i.e(63726),i.e(81562),i.e(51493),i.e(76037),i.e(69e3),i.e(66446),i.e(9325),i.e(34666),i.e(27024),i.e(88481),i.e(52694),i.e(35897),i.e(92642),i.e(81968),i.e(30468),i.e(37929),i.e(91987),i.e(64388),i.e(8762),i.e(32140),i.e(52316),i.e(50438),i.e(30454),i.e(3048),i.e(21341),i.e(51658),i.e(32387),i.e(36295),i.e(80915),i.e(53121),i.e(67534),i.e(6181),i.e(17686),i.e(67890),i.e(53233),i.e(13349),i.e(98784),i.e(63056),i.e(28435),i.e(12796),i.e(74607),i.e(82106),i.e(6877),i.e(8046),i.e(87613),i.e(76325),i.e(68189),i.e(95571),i.e(9258),i.e(12060)]).then(i.bind(i,9691)).then((t=>{Wt?.hide();const i=t.SourcePropertiesEditorRenderer;return Wt=new i(e),Wt.show({shouldReturnFocus:e.shouldReturnFocus}),Wt}))}({propertyPages:o,model:t,source:e,activePageId:c&&jt[c],shouldReturnFocus:s.shouldReturnFocus})}return null}));if((0,Nt.isStudyStub)(e))return null;if((0,Nt.isStudy)(e)&&!Ft(e))return(0,ke.isFeatureEnabled)("prevent_settings_close_on_click_outside")?function(e,t,i={},s,o){const r=s.activeChartWidget.value(),n=Ot(e,t,{...i,onDestroy:()=>{Ht&&r.model().activeStrategySource().unsubscribe(Ht),zt&&s.activeChartWidget.unsubscribe(zt)},closeOnOutsideClick:!1},o);return n.then((t=>{t&&((0,Nt.isStudyStrategy)(e)&&(Ht=()=>{t.hide()},r.model().activeStrategySource().subscribe(Ht,{once:!0})),zt=()=>{t.hide()},s.activeChartWidget.subscribe(zt,{once:!0}))})),n}(e,t,s,o,r):Ot(e,t,s,r);{const t=Ft(e)?"events":c&&jt[c],i=o.getChartPropertiesDialogRenderer();return i.setActivePage(t),i.show(s)}}var Kt=i(727342),Zt=i(980002),Yt=i(841397),Xt=i(276479),Jt=i(521481);class Qt{constructor(e,t){this._showed=!1,this._additionalReadyPromise=null,this._cw=e,
this._element=document.createElement("div"),this._element.classList.add(Jt.screen),t.appendChild(this._element),this._cw.withModel(this,this._connectToModel)}destroy(){this.hide(),this._element.remove()}show(e,t){if(e){const e=this._cw.model().mainSeries().status();if(1!==e&&2!==e)return}this._additionalReadyPromise=t,this._cw.setInLoadingState(!0),this._showed||(this._showed=!0,this._show())}hide(){this._cw.setInLoadingState(!1),this._showed&&this._hide()}isShown(){return this._showed}_connectToModel(){const e=this._cw.model().mainSeries(),t=e.dataEvents();t.symbolError().subscribe(this,(e=>{e!==Xt.permissionDenied&&this.hide()})),t.seriesError().subscribe(this,(()=>{(0,d.isFeaturesetEnabled)("hide_loading_screen_on_series_error")&&this.hide()})),e.statusWV().subscribe((e=>{if(4!==e&&12!==e&&13!==e&&14!==e||this.hide(),j.seriesReadyStatuses.has(e)){const e=this._additionalReadyPromise;e?e.then((()=>{this.hide()})):this.hide()}}))}_show(){const e=this._cw.properties().childs().paneProperties.childs();let t;if(e.backgroundType.value()===Yt.ColorType.Solid)t=e.background.value();else{t=`linear-gradient(${e.backgroundGradientStartColor.value()},${e.backgroundGradientEndColor.value()})`}this._element.style.background=t,this._element.classList.add(Jt.fade)}_hide(){this._showed=!1,this._element.classList.remove(Jt.fade)}}function ei(e,t){let{deltaX:i,deltaY:s}=e;switch(i/=100,s/=100,t.deltaMode){case t.DOM_DELTA_PAGE:i*=120,s*=120;break;case t.DOM_DELTA_LINE:i*=32,s*=32}return{deltaX:i,deltaY:s}}class ti{constructor(){this._totalDeltaX=0,this._totalDeltaY=0,this._prevWheelTime=0}processWheel(e){e.timeStamp-this._prevWheelTime>100&&this._reset();const t=!(0,_.isMac)()&&e.shiftKey,i=t?-e.deltaY:e.deltaX,s=t?e.deltaX:e.deltaY;this._totalDeltaX+=i,this._totalDeltaY+=s,this._prevWheelTime=e.timeStamp;const o={deltaX:i,deltaY:s};return 0===this._totalDeltaX||0===this._totalDeltaY||(Math.abs(this._totalDeltaX)>=Math.abs(3*this._totalDeltaY)&&(o.deltaY=0),Math.abs(this._totalDeltaY)>=Math.abs(3*this._totalDeltaX)&&(o.deltaX=0)),ei(o,e)}_reset(){this._totalDeltaX=0,this._totalDeltaY=0}}var ii=i(955482),si=i(517806),oi=i(725318),ri=i(948654);class ni{constructor(e,t,i){this._handleEl=null,this._resizeInfo=null,this._colorCache={lineColor:"",backgroundColor:"",color:""},this._selected=new H.WatchedValue,this._chart=e,this._topPaneIndex=t,this._bottomPaneIndex=i,this._element=document.createElement("div"),this._element.classList.add(ri.paneSeparator),this._element.style.background=this._color(),this.adjustSize(),this._element.addEventListener("click",(()=>{}));const s=document.createElement("div");s.classList.add(ri.handle),this._element.appendChild(s),this._mouseEventHandler=new oi.MouseEventHandler(s,this,{treatVertTouchDragAsPageScroll:!1,treatHorzTouchDragAsPageScroll:!0}),this._handleEl=s,this._handleEl.classList.toggle(ri.mobile,_.CheckMobile.any()),this._element.setAttribute("aria-hidden","true"),this._selected.subscribe((e=>this._handleEl?.classList.toggle(ri.selected,e)))}destroy(){this._mouseEventHandler.destroy(),
this._element.parentElement&&this._element.parentElement.removeChild(this._element)}topPaneIndex(){return this._topPaneIndex}bottomPaneIndex(){return this._bottomPaneIndex}getElement(){return this._element}hide(){this._element.classList.add("js-hidden")}show(){this._element.classList.remove("js-hidden")}selected(){return this._selected.readonly()}adjustSize(){this._element.style.height=ni.height()+"px"}mouseEnterEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0);null!==t&&null!==i&&(0,a.ensureNotNull)(this._handleEl).classList.add(ri.hovered)}mouseLeaveEvent(e){(0,a.ensureNotNull)(this._handleEl).classList.remove(ri.hovered)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}tapEvent(){this._selected.setValue(!this._selected.value())}touchStartEvent(e){this._selected.value()&&this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._selected.value()&&this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._selected.value()&&this._mouseUpOrTouchEndEvent(e)}touchStartOutsideEvent(){this._selected.setValue(!1)}update(){this._element.style.background=this._color().toString()}paint(){}image(){const{topPane:e}=this._topBottomPane(!1),t=e.leftPriceAxisesContainer().getWidth(),i=e.width(),s=e.rightPriceAxisesContainer().getWidth(),o=this._color(),r=(0,Et.createDisconnectedCanvas)(document,(0,nt.size)({width:t,height:1})),n=(0,Et.getPrescaledContext2D)(r);n.fillStyle=o,n.fillRect(0,0,t,1);const a=(0,Et.createDisconnectedCanvas)(document,(0,nt.size)({width:i,height:1})),l=(0,Et.getPrescaledContext2D)(a);l.fillStyle=o,l.fillRect(0,0,i,1);const c=(0,Et.createDisconnectedCanvas)(document,(0,nt.size)({width:s,height:1})),h=(0,Et.getPrescaledContext2D)(c);return h.fillStyle=o,h.fillRect(0,0,s,1),{type:"separator",leftAxis:{content:r.toDataURL(),canvas:r,contentWidth:t,contentHeight:1},rightAxis:{content:c.toDataURL(),canvas:c,contentWidth:s,contentHeight:1},content:a.toDataURL(),canvas:a,contentWidth:i,contentHeight:1}}static height(){const e=window.devicePixelRatio||1;return e>=1?1:1/e}_mouseDownOrTouchStartEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0);if(null===t||null===i)return;const s=t.state().stretchFactor()+i.state().stretchFactor(),o=s/(t.height()+i.height()),r=30*o;s<=2*r||(this._resizeInfo={startY:e.pageY,prevStretchTopPane:t.state().stretchFactor(),maxPaneStretch:s-r,totalStretch:s,pixelStretchFactor:o,minPaneStretch:r},(0,a.ensureNotNull)(this._handleEl).classList.add(ri.active))}_pressedMouseOrTouchMoveEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0),s=this._resizeInfo;if(null===s||null===t||null===i)return;const o=(e.pageY-s.startY)*s.pixelStretchFactor,r=(0,si.clamp)(s.prevStretchTopPane+o,s.minPaneStretch,s.maxPaneStretch);t.state().setStretchFactor(r),i.state().setStretchFactor(s.totalStretch-r),this._chart.model().model().fullUpdate()}_mouseUpOrTouchEndEvent(e){const{topPane:t,bottomPane:i}=this._topBottomPane(!0),s=this._resizeInfo
;null!==s&&null!==t&&null!==i&&(this._chart.model().addPaneStretchFactorUndoCommand(t.state(),i.state(),s.prevStretchTopPane,t.state().stretchFactor()),this._resizeInfo=null,(0,a.ensureNotNull)(this._handleEl).classList.remove(ri.active))}_color(){const e=this._chart.properties().childs().paneProperties.childs().separatorColor.value(),t=this._chart.model().model().backgroundColor().value();if(this._colorCache.lineColor!==e||this._colorCache.backgroundColor!==t){const i=(0,ii.parseRgba)(t),s=(0,ii.parseRgba)(e),o=0===i[3]&&0===s[3]?"rgba(0,0,0,0)":(0,ii.rgbaToString)((0,ii.blendRgba)(i,s));this._colorCache={lineColor:e,backgroundColor:t,color:o}}return this._colorCache.color}_topBottomPane(e){const t=this._chart.paneWidgets();let i=null,s=null;for(let s=this._topPaneIndex;s>=0;--s){const o=t[s];if(!e||!o.state().collapsed().value()){i=o;break}}for(let i=this._bottomPaneIndex;i<t.length;++i){const o=t[i];if(!e||!o.state().collapsed().value()){s=o;break}}return{topPane:i,bottomPane:s}}}var ai=i(823291),li=i(812579),ci=i(359308),hi=i(141463),di=i(881362),ui=i(45726),_i=i(167972),pi=i(241181),mi=i(138264),gi=i(26878),Si=i(85818),vi=i(593026),fi=i(830780),bi=i(595398),yi=i(880753),wi=i(466341);const Ci={enableTooltip:!0,showLabels:!0,enableMenu:!0,enableHighlight:!0};function Ti(e,t){return Math.max(1,Math.floor(e.borderSize*t))}class Pi{constructor(e,t,i,s,o,r=null){this._size=(0,nt.size)({width:0,height:0}),this._offset=0,this._axisInfo=null,this._onLabelHovered=new g.Delegate,this._font=(0,gi.makeFont)(11,yi.CHART_FONT_FAMILY),this._highlighted=!1,this._isContextMenuOpened=!1,this._isMouseOverStub=!1,this._labelMode=2,this._fixedLabelMode=null,this._textWidthCache=new vi.TextWidthCache(5),this._gearRenderer=(0,Si.svgRenderer)(wi),this._canvasConfiguredHandler=()=>{this.update(),this._textWidthCache.reset()},this._timeAxisWidget=r,this._isLeft="left"===e;const{rendererOptionsProvider:n,sourcesTitlesProvider:a,contextMenuItemsProvider:l,backgroundBasedTheme:c,onActiveOrHoveredChart:h=new H.WatchedValue(!1).ownership(),requestRepaint:d,getBackgroundTopColor:u,getBackgroundBottomColor:_,showHorizontalBorder:p}=s;this._rendererOptionsProvider=n,this._sourcesTitlesProvider=a,this._contextMenuItemsProvider=l,this._backgroundBasedTheme=c,this._onActiveOrHoveredChart=h,this._requestRepaint=d,this._getBackgroundTopColor=u,this._getBackgroundBottomColor=_,this._showHorizontalBorder=Boolean(p),this._properties=t,this._axisInfo=i,this._labelOptions={...Ci,...o},this._cell=document.createElement("div"),this._labelOptions.enableTooltip&&this._cell.classList.add("apply-common-tooltip"),this._cell.style.width="25px",this._cell.style.height="100%",this._cell.style.position="absolute",this._cell.style.left="0",this._cell.style.overflow="hidden",this._labelOptions.showLabels&&(this._labelOptions.enableTooltip&&(0,bi.setTooltipData)(this._cell,"text",(e=>this._tooltipContent())),this._onActiveOrHoveredChart.subscribe(d)),this._properties.lineColor.subscribe(this,(()=>this._requestRepaint())),
this._mouseEventHandler=new oi.MouseEventHandler(this._cell,this,{treatHorzTouchDragAsPageScroll:!0,treatVertTouchDragAsPageScroll:!0}),this._canvasBinding=(0,Et.createBoundCanvas)(this._cell,(0,nt.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const m=this._canvasBinding.canvasElement;m.style.position="absolute",m.style.left="0",m.style.top="0",this._cell.setAttribute("aria-hidden","true")}destroy(){this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._properties.lineColor.unsubscribeAll(this),this._mouseEventHandler.destroy(),this._backgroundBasedTheme.release(),this._onActiveOrHoveredChart.unsubscribe(this._requestRepaint),this._onActiveOrHoveredChart.release()}mouseEnterEvent(e){this._mouseOrTouchEnterEvent(e)}touchStartEvent(e){this._mouseOrTouchEnterEvent(e)}mouseLeaveEvent(e){this._mouseOrTouchLeaveEvent(e)}touchEndEvent(e){this._mouseOrTouchLeaveEvent(e)}mouseClickEvent(e){this._mouseClickOrTapEvent(e)}tapEvent(e){this._mouseClickOrTapEvent(e)}update(){}getElement(){return this._cell}onLabelHovered(){return this._onLabelHovered}setSizeAndOffset(e,t){(0,nt.equalSizes)(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._cell.style.width=`${e.width}px`,this._cell.style.minWidth=`${e.width}px`,this._cell.style.height=`${e.height}px`),this._offset!==t&&(this._offset=t,this._cell.style.left=`${t}px`)}paint(e){0!==this._size.width&&0!==this._size.height&&(e.level===ve.InvalidationLevel.Full||e.invalidateStubs)&&((0,Et.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),this._paintImpl((0,Et.getContext2D)(this._canvasBinding.canvasElement),(0,Et.getBindingRenderingInfo)(this._canvasBinding)))}getWidth(){return this._size.width}getImage(){const e=(0,Et.getBindingRenderingInfo)(this._canvasBinding),t=(0,Et.createDisconnectedCanvasByRenderingInfo)(document,e);return this._paintImpl((0,Et.getContext2D)(t),e,!0),t}setLabelMode(e){e!==this._labelMode&&(this._labelMode=e,this._cell.classList.toggle("apply-common-tooltip",1!==e&&this._labelOptions.enableTooltip))}_paintImpl(e,t,i){this._drawBackground(e,t),this._drawVerticalBorder(e,t),this._showHorizontalBorder&&this._drawHorizontalBorder(e,t),this._labelOptions.showLabels&&this._drawLabel(e,t,i)}_setHighlighted(e){this._labelOptions.enableHighlight&&(this._onLabelHovered.fire("stubButton",e),this._highlighted!==e&&(this._highlighted=e),this._requestRepaint())}_drawVerticalBorder(e,t){e.save(),e.fillStyle=this._vertBorderColor();const i=Ti(this._rendererOptionsProvider.options(),t.horizontalPixelRatio),s=this._isLeft?t.bitmapSize.width-i:0;e.fillRect(s,0,i,t.bitmapSize.height),e.restore()}_drawHorizontalBorder(e,t){e.save(),e.fillStyle=this._horzBorderColor();const i=Ti(this._rendererOptionsProvider.options(),t.verticalPixelRatio),s=this._isLeft?0:i;e.fillRect(s,0,t.bitmapSize.width-i,i),e.restore()}_drawBackground(e,t){
const i=this._getBackgroundTopColor(),s=this._getBackgroundBottomColor(),{bitmapSize:o}=t;if(i===s?(0,Et.clearRect)(e,0,0,o.width,o.height,i):(0,mi.clearRectWithGradient)(e,0,0,o.width,o.height,i,s),this._highlighted){const t=L.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight");(0,Et.fillRect)(e,0,0,o.width,o.height,t),e.globalAlpha=1}}_drawLabel(e,t,i){const s=this._backgroundBasedTheme.value(),o=this._axisInfo;if(null===o||!i&&!this._onActiveOrHoveredChart.value())return;const{bitmapSize:r,horizontalPixelRatio:n,verticalPixelRatio:a}=t,l=Ti(this._rendererOptionsProvider.options(),n),c=Math.round(r.width)-l,h=Ti(this._rendererOptionsProvider.options(),a),d=Math.round(r.height)-h,u=(0,dt.point)(l+c/2,h+d/2);if(1===this._labelMode||2===this._labelMode&&(!this._highlighted||i)){e.fillStyle=L.themes[s].getThemedColor("color-price-axis-label-back"),e.globalAlpha=.5,e.beginPath(),e.arc(u.x,u.y,9.5*n,0,2*Math.PI,!0),e.fill(),e.globalAlpha=1,e.fillStyle=L.themes[s].getThemedColor("color-price-axis-label-text"),e.font=this._font,e.textAlign="center",e.textBaseline="middle";const t=this._textWidthCache.yMidCorrection(e,o.label);(0,Et.drawScaled)(e,n,a,(()=>{e.fillText(o.label,u.x/n,u.y/a+t)}))}else if(!i&&this._onActiveOrHoveredChart.value()){const t=this._gearRenderer.viewBox(),i=Math.round(u.x-t.width*n/2),o=Math.round(u.y-t.height*a/2);e.fillStyle=L.themes[s].getThemedColor("color-text-primary"),e.imageSmoothingQuality="high",this._gearRenderer.render(e,{targetViewBox:{x:i,y:o,width:t.width*n,height:t.height*a},doNotApplyColors:!0})}}_vertBorderColor(){return this._properties.lineColor.value()}_horzBorderColor(){return this._timeAxisWidget?.lineColor()??this._vertBorderColor()}_tooltipContent(){return this._sourcesTitlesProvider().join("\n")}_mouseOrTouchEnterEvent(e){this._isMouseOverStub=!0,this._labelOptions.showLabels&&this._labelOptions.enableHighlight&&!this._timeAxisWidget?.chart.chartFloatingTooltipVisible()&&this._setHighlighted(!0)}_mouseOrTouchLeaveEvent(e){this._isMouseOverStub=!1,this._labelOptions.showLabels&&this._labelOptions.enableHighlight&&!this._isContextMenuOpened&&this._setHighlighted(!1)}async _mouseClickOrTapEvent(e){if(e.preventDefault(),null!==this._fixedLabelMode||1===this._labelMode||!this._labelOptions.enableMenu||!this._labelOptions.showLabels)return void fi.ContextMenuManager.hideAll();this._fixedLabelMode=this._labelMode,this.setLabelMode(0);const t=this._cell.getBoundingClientRect(),i=await this._contextMenuItemsProvider();this._isContextMenuOpened=!0,this._labelOptions.showLabels&&this._labelOptions.enableHighlight&&this._setHighlighted(!0),fi.ContextMenuManager.showMenu(i,{clientX:this._isLeft?t.left:t.right,clientY:t.top,attachToXBy:this._isLeft?"left":"right",attachToYBy:"bottom"},{statName:"PriceScaleLabelContextMenu",doNotCloseOn:this.getElement()},{menuName:"PriceScaleLabelContextMenu"},(()=>{this._isMouseOverStub||this._setHighlighted(!1),this._isContextMenuOpened=!1,this.setLabelMode((0,a.ensureNotNull)(this._fixedLabelMode)),
this._fixedLabelMode=null}))}}var Mi=i(601988);class xi{constructor(e,t,i,s,o,r=null){this._axises=[],this._stubs=[],this._size=(0,nt.size)({width:0,height:0}),this._onLabelHovered=new g.Delegate,this._scalesProperties=e,this._priceAxisWidgetFactory=i,this._timeAxisWidget=r,this._rendererOptionsProvider=s.rendererOptionsProvider,this._titlesProvider=s.titlesProvider,this._stubContextMenuProvider=s.stubContextMenuProvider,this._backgroundBasedTheme=s.backgroundBasedTheme,this._onActiveOrHoveredChart=s.onActiveOrHoveredChart,this._getBackgroundTopColor=s.getBackgroundTopColor,this._getBackgroundBottomColor=s.getBackgroundBottomColor,this._requestRepaint=s.requestRepaint,this._showHorisontalBorder=Boolean(s.showHorizontalBorder),this._labelsOptions={...Ci,...o};const n=this._scalesProperties.childs();this._stubProperties={lineColor:n.lineColor,fontSize:n.fontSize},this._side=t,this._cell=document.createElement("div"),this._cell.classList.add("chart-markup-table","price-axis-container"),this._cell.style.width="25px",this._cell.style.position="relative"}destroy(){this.setScales([],0,0,0),this._backgroundBasedTheme.release(),this._onActiveOrHoveredChart?.release()}onLabelHovered(){return this._onLabelHovered}setScales(e,t,i,s){for(;e.length>this._axises.length&&this._axises.length<t;){const e=(0,Mi.getPriceAxisNameInfo)(this._side,this._axises.length),t=this._priceAxisWidgetFactory(this._side,this._rendererOptionsProvider,this._scalesProperties,e,this._backgroundBasedTheme);this._axises.push(t),this._cell.appendChild(t.getElement())}for(;e.length<this._axises.length;){const e=(0,a.ensureDefined)(this._axises.pop());this._cell.removeChild(e.getElement()),e.destroy()}for(let t=0;t<this._axises.length;++t)this._axises[t].setPriceScale(e[t]);const o=t-e.length,r=Math.max(0,o);for(;this._stubs.length>r;){const e=(0,a.ensureDefined)(this._stubs.pop());e.onLabelHovered().unsubscribeAll(this),this._cell.removeChild(e.getElement()),e.destroy()}for(;this._stubs.length<o;){const e=this._labelsOptions.showLabels?(0,Mi.getPriceAxisNameInfo)(this._side,this._stubs.length):null,t=new Pi(this._side,this._stubProperties,e,this._stubParams(this._stubs.length),this._labelsOptions,this._timeAxisWidget);t.onLabelHovered().subscribe(this,((t,i)=>{this._labelsOptions.showLabels&&this._labelsOptions.enableHighlight&&this._onLabelHovered.fire({owner:t,axis:(0,a.ensureNotNull)(e)},i)})),this._stubs.push(t),this._cell.appendChild(t.getElement())}const n=this._labelsOptions.enableMenu;1===s?this._stubs.forEach(((e,t)=>e.setLabelMode(n?0:1))):this._stubs.forEach(((e,t)=>e.setLabelMode(t<i&&n?2:1)))}getElement(){return this._cell}updateCurrencyLabels(){return this._axises.forEach((e=>e.updateCurrencyLabel()))}optimalWidths(){return this._axises.map((e=>e.optimalWidth()))}setSizes(e,t){this._size=(0,nt.size)({width:t.reduce(((e,t)=>e+t),0),height:e}),this._cell.style.width=this._size.width+"px",this._cell.style.minWidth=this._size.width+"px",this._cell.style.height=this._size.height+"px",t.length!==this._axises.length+this._stubs.length&&(0,
a.assert)(t.length===this._axises.length+this._stubs.length,"Widgets count should be the same as widths one");let i=0;this._forEachWidgetFromLeft(((s,o)=>{const r=t[o];s.setSizeAndOffset((0,nt.size)({width:r,height:e}),i),i+=r}))}update(){this._axises.forEach((e=>e.update())),this._stubs.forEach((e=>e.update()))}paint(e,t){this._axises.forEach(((t,i)=>t.paint(e(i)))),this._stubs.forEach(((e,i)=>e.paint(t)))}paintStubs(e){this._stubs.forEach((t=>t.paint(e)))}restoreDefaultCursor(){this._axises.forEach((e=>e.restoreDefaultCursor()))}getWidth(){return this._size.width}findAxisWidgetForScale(e){const t=this._axises.find((t=>t.priceScale()===e));return void 0===t?null:t}getScreenshotData(){const e=this._getImage();return{canvas:e,content:e.toDataURL(),contentHeight:this._size.height,contentWidth:this._size.width}}getImage(){return this._getImage()}slotsCount(){return this._axises.length+this._stubs.length}setHighlightedPriceAxises(e){this._axises.forEach((t=>{const i=t.axisInfo(),s=e.find((e=>e.label===i?.label));t.setHighlighted(void 0!==s)}))}axes(){return this._axises}_stubParams(e){return{rendererOptionsProvider:this._rendererOptionsProvider,backgroundBasedTheme:this._backgroundBasedTheme.spawnOwnership(),onActiveOrHoveredChart:this._onActiveOrHoveredChart?.spawnOwnership(),sourcesTitlesProvider:()=>this._titlesProvider(this._side,e),contextMenuItemsProvider:()=>this._stubContextMenuProvider(this._side,e),getBackgroundTopColor:this._getBackgroundTopColor,getBackgroundBottomColor:this._getBackgroundBottomColor,requestRepaint:this._requestRepaint,showHorizontalBorder:this._showHorisontalBorder}}_getImage(){const e=(0,Et.createDisconnectedCanvas)(document,this._size),t=(0,Et.getPrescaledContext2D)(e);let i=0;return this._forEachWidgetFromLeft(((e,s)=>{const o=e.getWidth();0!==o&&0!==this._size.height&&(t.drawImage(e.getImage(),i,0,o,this._size.height),i+=o)})),e}_forEachWidgetFromLeft(e){const t=[...this._axises,...this._stubs],i="left"===this._side,s=i?-1:t.length,o=i?-1:1;for(let r=i?t.length-1:0;r!==s;r+=o)e(t[r],r,t)}}var Ii=i(873282),Li=i(275925),Ai=i(192751),ki=i(308225);function Ei(e,t,i,s=!1){return e.classList.contains("readonly")!==i&&(e.classList.toggle("readonly",i),e.classList.toggle("js-hidden",s&&i),t?.classList.toggle("js-hidden",i),!0)}class Di{constructor(e=0){this._width=null,this._labelBottom=null,this._currencyInfo=null,this._unitInfo=null,this._measureUnitIdInfo=null,this._metricInfo=null,this._currencyAndUnitLabelsWrapper=document.createElement("div"),this._currencyAndUnitLabelsWrapper.className=ki["price-axis-currency-label-wrapper"],this._currencyAndUnitLabelsWrapper.setAttribute("data-name","currency-unit-label-wrapper"),this._controlsContainer=document.createElement("div"),this._controlsContainer.className=ki["price-axis-currency-label"],this._currencyAndUnitLabelsWrapper.appendChild(this._controlsContainer),this._currencyLabelDiv=document.createElement("div"),this._currencyLabelDiv.classList.add(ki.row,"apply-common-tooltip"),this._currencyLabelDiv.dataset.name="currency-label-selector",(0,
bi.setTooltipData)(this._currencyLabelDiv,"text",(e=>this._currencyTooltipContent())),this._currencyText=document.createElement("div"),this._currencyText.className=ki["price-axis-currency-label-text"],this._currencyLabelDiv.appendChild(this._currencyText),this._currencyArrowDown=document.createElement("div"),this._currencyArrowDown.className=ki["price-axis-currency-label-arrow-down"],this._currencyArrowDown.innerHTML=Ai,this._currencyLabelDiv.appendChild(this._currencyArrowDown),this._measureUnitIdLabelDiv=document.createElement("div"),this._measureUnitIdLabelDiv.className=ki.row,this._measureUnitIdLabelDiv.classList.add("apply-common-tooltip"),this._measureUnitIdLabelDiv.classList.add("readonly"),(0,bi.setTooltipData)(this._measureUnitIdLabelDiv,"text",(e=>this._measureUnitIdTooltipContent())),this._measureUnitIdText=document.createElement("div"),this._measureUnitIdText.className=ki["price-axis-currency-label-text"],this._measureUnitIdLabelDiv.appendChild(this._measureUnitIdText),this._unitLabelDiv=document.createElement("div"),this._unitLabelDiv.classList.add(ki.row,"apply-common-tooltip"),this._unitLabelDiv.dataset.name="unit-label-selector",(0,bi.setTooltipData)(this._unitLabelDiv,"text",(e=>this._unitTooltipContent())),this._unitText=document.createElement("div"),this._unitText.className=ki["price-axis-currency-label-text"],this._unitLabelDiv.appendChild(this._unitText),this._unitArrowDown=document.createElement("div"),this._unitArrowDown.className=ki["price-axis-currency-label-arrow-down"],this._unitArrowDown.innerHTML=Ai,this._unitLabelDiv.appendChild(this._unitArrowDown),this._metricLabelDiv=document.createElement("div"),this._metricLabelDiv.classList.add(ki.row,"apply-common-tooltip"),this._metricLabelDiv.dataset.name="metric-label-selector",(0,bi.setTooltipData)(this._metricLabelDiv,"text",(e=>this._metricTooltipContent())),this._metricText=document.createElement("div"),this._metricText.className=ki["price-axis-currency-label-text"],this._metricLabelDiv.appendChild(this._metricText),this._metricArrowDown=document.createElement("div"),this._metricArrowDown.className=ki["price-axis-currency-label-arrow-down"],this._metricArrowDown.innerHTML=Ai,this._metricLabelDiv.appendChild(this._metricArrowDown),this._controlsContainer.appendChild(this._currencyLabelDiv),this._controlsContainer.appendChild(this._measureUnitIdLabelDiv),this._controlsContainer.appendChild(this._unitLabelDiv),this._controlsContainer.appendChild(this._metricLabelDiv),this.disableCurrency(),this.disableUnit(),this.disableMetric(),this.setFontSize(e)}element(){return this._currencyAndUnitLabelsWrapper}currencyLabelElement(){return this._currencyLabelDiv}unitLabelElement(){return this._unitLabelDiv}metricLabelElement(){return this._metricLabelDiv}isEnabled(){return this.currencyLabelEnabled()||this.unitLabelEnabled()||this.measureUnitIdLableEnabled()||this.metricLabelEnabled()}isHidden(){return this._currencyAndUnitLabelsWrapper.classList.contains(ki.hidden)}setCurrencyExpanded(e){this._currencyLabelDiv.classList.toggle(ki.expanded,e)}
setUnitExpanded(e){this._unitLabelDiv.classList.toggle(ki.expanded,e)}setMetricExpanded(e){this._metricLabelDiv.classList.toggle(ki.expanded,e)}width(){if(null!==this._width)return this._width;let e=0;if(this.currencyLabelEnabled()){const t=this._currencyText.getBoundingClientRect(),i=this._currencyArrowDown.getBoundingClientRect();e=Math.max(e,t.width+i.width+2*this._textMarginAndPadding())}if(this.measureUnitIdLableEnabled()){const t=this._measureUnitIdText.getBoundingClientRect();e=Math.max(e,t.width+2*this._textMarginAndPadding())}if(this.unitLabelEnabled()){const t=this._unitText.getBoundingClientRect(),i=this._unitArrowDown.getBoundingClientRect();e=Math.max(e,t.width+i.width+2*this._textMarginAndPadding())}if(this.metricLabelEnabled()){const t=this._metricText.getBoundingClientRect(),i=this._metricArrowDown.getBoundingClientRect();e=Math.max(e,t.width+i.width+2*this._textMarginAndPadding())}return this._width=e}drawLabel(e,t,i){if(!this.isEnabled())return;const s=Math.round(Number(ki.css_wrapper_margin)*i),o=(0,si.ceiledEven)(t*i)-2*s,r=Math.round(this.labelBottom()*i),n=r-2*s,a=Math.round(Number(ki.css_value_currency_label_radius)*i);e.fillStyle=getComputedStyle(this._currencyAndUnitLabelsWrapper).backgroundColor,e.fillRect(0,0,Math.ceil(t*i),r);const l=[];l.push(this.currencyLabelEnabled()?this._currencyText.textContent??"":""),l.push(this.measureUnitIdLableEnabled()?this._measureUnitIdText.textContent??"":""),l.push(this.unitLabelEnabled()?this._unitText.textContent??"":""),e.font=(0,gi.makeFont)(this._fontSize,yi.CHART_FONT_FAMILY);const c=new vi.TextWidthCache;let h=0;const d=[];l.forEach((t=>{let i=0;""!==t&&(i=c.yMidCorrection(e,t),h++),d.push(i)}));const u=n/h;e.beginPath();const _=getComputedStyle(this._controlsContainer);e.fillStyle=_.backgroundColor,e.strokeStyle=_.borderColor,(0,mi.drawRoundRect)(e,s,s,o,n,a),e.fill(),e.stroke(),e.fillStyle=getComputedStyle(this._currencyLabelDiv).color,e.textBaseline="middle",e.textAlign="left";const p=Math.round(this._textMarginAndPadding()*i)+s,m=u/2;let g=s+m;l.forEach(((t,s)=>{""!==t&&((0,Et.drawScaled)(e,i,i,(()=>{e.fillText(t,p/i,(g+d[s])/i)})),g=Math.ceil(g+2*m))}))}setHidden(e){this._currencyAndUnitLabelsWrapper.classList.toggle(ki.hidden,e)}enableCurrency(){this._currencyLabelDiv.classList.remove("js-hidden"),this._resetSizesAndVisibility()}disableCurrency(){this._currencyLabelDiv.classList.add("js-hidden"),this._resetSizesAndVisibility()}enableUnit(){this._unitLabelDiv.classList.remove("js-hidden"),this._resetSizesAndVisibility()}disableUnit(){this._unitLabelDiv.classList.add("js-hidden"),this._resetSizesAndVisibility()}enableMeasureUnitId(){this._measureUnitIdLabelDiv.classList.remove("js-hidden"),this._resetSizesAndVisibility()}disableMeasureUnitId(){this._measureUnitIdLabelDiv.classList.add("js-hidden"),this._resetSizesAndVisibility()}enableMetric(){this._metricLabelDiv.classList.remove("js-hidden"),this._resetSizesAndVisibility()}disableMetric(){this._metricLabelDiv.classList.add("js-hidden"),this._resetSizesAndVisibility()}currencyLabelEnabled(){
return!this._currencyLabelDiv.classList.contains("js-hidden")}unitLabelEnabled(){return!this._unitLabelDiv.classList.contains("js-hidden")}measureUnitIdLableEnabled(){return!this._measureUnitIdLabelDiv.classList.contains("js-hidden")}metricLabelEnabled(){return!this._metricLabelDiv.classList.contains("js-hidden")}currencyConversionAvailable(){return!this._currencyLabelDiv.classList.contains("readonly")}unitConversionAvailable(){return!this._unitLabelDiv.classList.contains("readonly")}metricConversionAvailable(){return!this._metricLabelDiv.classList.contains("readonly")}setCurrencyInfo(e){if(this._currencyInfo===e)return!1;this._currencyInfo=e;const t=null===e.selectedCurrency?h.t(null,{context:"price conversion label"},i(217161)):(0,a.ensureDefined)(e.displayedValues.get(e.selectedCurrency));return this._currencyText.textContent!==t&&(this._currencyText.textContent=t,this._width=null),Ei(this._currencyLabelDiv,this._currencyArrowDown,e.readOnly)&&(this._width=null),!0}setUnitInfo(e){if(null!==this._unitInfo&&this._unitInfo.selectedUnit===e.selectedUnit&&0===this._unitInfo.availableGroups.size==(0===e.availableGroups.size)&&this._unitInfo.originalUnits.size===e.originalUnits.size)return this._unitInfo=e,!1;this._unitInfo=e;const t=null===e.selectedUnit?h.t(null,{context:"price conversion label"},i(217161)):(0,a.ensureDefined)(e.names.get(e.selectedUnit));return this._unitText.textContent!==t&&(this._unitText.textContent=t,this._width=null),Ei(this._unitLabelDiv,this._unitArrowDown,0===e.availableGroups.size)&&(this._width=null),!0}setMeasureUnitIdInfo(e){if(this._measureUnitIdInfo===e)return!1;this._measureUnitIdInfo=e;const t=null===e.selectedMeasureUnitId?h.t(null,{context:"price conversion label"},i(217161)):(0,a.ensureDefined)(e.names.get(e.selectedMeasureUnitId));return this._measureUnitIdText.textContent!==t&&(this._measureUnitIdText.textContent=t,this._width=null),Ei(this._measureUnitIdLabelDiv,null,0===e.names.size,!0)&&(this._width=null),!0}setMetricInfo(e){if(this._metricInfo===e)return!1;this._metricInfo=e;const t=null===e.selectedMetricId?h.t(null,{context:"price conversion label"},i(217161)):(0,a.ensureDefined)(e.names.get(e.selectedMetricId));return this._metricText.textContent!==t&&(this._metricText.textContent=t,this._width=null),Ei(this._metricLabelDiv,this._metricArrowDown,e.readOnly)&&(this._width=null),!0}currencyInfo(){return this._currencyInfo}unitInfo(){return this._unitInfo}measureUnitIdInfo(){return this._measureUnitIdInfo}metricInfo(){return this._metricInfo}setFontSize(e){this._fontSize!==e&&(this._fontSize=e,this._currencyLabelDiv.style.fontSize=e+"px",this._measureUnitIdLabelDiv.style.fontSize=e+"px",this._unitLabelDiv.style.fontSize=e+"px",this._metricLabelDiv.style.fontSize=e+"px",this._width=null,this._labelBottom=null)}labelBottom(){if(null!==this._labelBottom)return this._labelBottom;const e=this._controlsContainer.getBoundingClientRect(),t=this._currencyAndUnitLabelsWrapper.getBoundingClientRect(),i=e.y-t.y;return this._labelBottom=e.height+2*i}_resetSizesAndVisibility(){
this._width=null,this._labelBottom=null,this._updateVisibility()}_textMarginAndPadding(){return Number(ki.css_wrapper_margin)+Number(ki.css_row_left_right_padding)+2}_currencyTooltipContent(){const e=this._currencyInfo;return null===e?"":null===e.selectedCurrency?Array.from(e.currencies).map((t=>(0,a.ensureDefined)(e.displayedValues.get(t)))).join(", "):e.readOnly?h.t(null,{context:"price conversion label"},i(191455)):h.t(null,{context:"price conversion label"},i(789049))}_unitTooltipContent(){const e=this._unitInfo;return null===e?"":null===e.selectedUnit?Array.from(e.units).map((t=>(0,a.ensureDefined)(e.names.get(t)))).join(", "):0===e.availableGroups.size?h.t(null,{context:"price conversion label"},i(556765)):h.t(null,{context:"price conversion label"},i(405013))}_measureUnitIdTooltipContent(){const e=this._measureUnitIdInfo;return null===e?"":null===e.selectedMeasureUnitId?Array.from(e.measureUnitIds).map((t=>(0,a.ensureDefined)(e.names.get(t)))).join(", "):e.descriptions.get(e.selectedMeasureUnitId)||""}_metricTooltipContent(){const e=this._metricInfo;return null===e?"":null===e.selectedMetricId?Array.from(e.metrics).map((t=>(0,a.ensureDefined)(e.names.get(t)))).join(", "):e.readOnly?h.t(null,{context:"price conversion label"},i(994845)):h.t(null,{context:"price conversion label"},i(833746))}_updateVisibility(){const e=this.isEnabled();this._currencyAndUnitLabelsWrapper.classList.toggle("js-hidden",!e)}}async function Bi(e,t,s,o,r){const{UnitConversionRenderer:n}=await Promise.all([i.e(36989),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(75649),i.e(68805),i.e(75174),i.e(31403),i.e(24193),i.e(97493),i.e(98101),i.e(32387),i.e(99331),i.e(8297)]).then(i.bind(i,506764));return new n(e,s,t,o,r)}async function Ri(e,t,s){const{CurrencyMenuResultEvents:o}=await i.e(63885).then(i.bind(i,429851));return new o(e,t,s)}var Vi=i(657130);class Oi{constructor(e){const{action:t,property:i,undoModel:s,undoText:o,callback:r=null}=e;this._property=i,this._undoModel=s,this._undoText=o,this._action=t,this.setValue(i.value()),i.subscribe(this,this._propertyChanged),null!==r?t.update({onExecute:r.bind(this)}):t.update({onExecute:this._onActionCallback.bind(this)})}destroy(){this._property.unsubscribe(this,this._propertyChanged)}value(){return this._action.isChecked()}setValue(e){this._action.update({checked:Boolean(e)})}_onActionCallback(){this._undoModel.setProperty(this._property,this.value(),this._undoText)}_propertyChanged(e){this.setValue(e.value())}}class Ni extends Vi.Action{constructor(e,t){super(e),this._binding=new Oi({action:this,...t})}destroy(){this._binding.destroy(),super.destroy()}}var Wi=i(301406),Fi=i(858054),zi=i(570442),Hi=i(901649),Ui=i(563335);function Gi(e,t,i){return null===i?[]:i.filter((i=>{if(!i.isVisible()||i.ignoreAlignment())return!1;const{total:s}=i.topBottomTotalHeight(e),o=i.coordinate();return o>-s&&o<t+s}))}i(846013)
;const ji=new P.TranslatedString("change no overlapping labels",h.t(null,void 0,i(917590))),qi=new P.TranslatedString("toggle auto scale",h.t(null,void 0,i(599141))),$i=new P.TranslatedString("toggle log scale",h.t(null,void 0,i(777485))),Ki=h.t(null,{context:"scale_menu"},i(278751)),Zi=h.t(null,{context:"scale_menu"},i(911711)),Yi=h.t(null,{context:"scale_menu"},i(84679)),Xi=h.t(null,{context:"scale_menu"},i(213075)),Ji=h.t(null,{context:"scale_menu"},i(916277)),Qi=h.t(null,{context:"scale_menu"},i(342915)),es=h.t(null,{context:"scale_menu"},i(642843)),ts=h.t(null,{context:"scale_menu"},i(640096)),is=h.t(null,{context:"scale_menu"},i(197105)),ss=h.t(null,{context:"scale_menu"},i(886013)),os=h.t(null,{context:"scale_menu"},i(749179)),rs=h.t(null,{context:"scale_menu"},i(847834)),ns=h.t(null,{context:"scale_menu"},i(471980));const as=function(e){const t=new Fi.LimitedPrecisionNumericFormatter(e);return(e,i)=>(0,n.isNumber)(i)&&!e.isLog()?t.format(i):""}(4),ls=(0,d.isFeaturesetEnabled)("currency_menu_disabled"),cs=(0,d.isFeaturesetEnabled)("unit_menu_disabled"),hs=(0,d.isFeaturesetEnabled)("metric_menu_disabled"),ds={contextMenuEnabled:!0,currencyConversionEnabled:!1,unitConversionEnabled:!1,metricConversionEnabled:!1,countdownEnabled:!0,contextMenu:{general:!0,source:!0},pressedMouseMoveScale:!0,mouseWheelScale:!0,pinchScale:!0,croppedTickMarks:!0};class us{constructor(e,t,i,s,o,r,a,l,c){this._actions=null,this._priceScale=null,this._scaleModeButtons=null,this._scaleModeButtonsPromise=null,this._widthCache=new vi.TextWidthCache(1e3),this._color=null,this._fontSize=null,this._isVisible=!0,this._currencyMenu=null,this._unitMenu=null,this._metricMenu=null,this._size=(0,nt.size)({width:0,height:0}),this._currentCursorClassName="",this._destroyed=!1,this._highlighted=!1,this._highlightColorCache=null,this._mouseWheelHelper=null,this._dragScaleActive=!1,this._offset=NaN,this._pinching=!1,this._lastHittestResult=null,this._isHovered=new H.WatchedValue(!1),this._selectedViaTap=new H.WatchedValue(!1),this._recalcCurrencyUnitAndMetricVisibility=()=>{if(null===this._currencyLabel)return;const e=(0,zi.actualCurrencyUnitMetricVisibility)().value();let t=!this._pane.visuallyCollapsed().value();if(t)switch(e){case"alwaysOff":t=!1;break;case"visibleOnMouseOver":const e=this._chart.anyPriceAxisHovered().value(),i=!!this._currencyMenu,s=!!this._unitMenu;t=e||i||s;break;case"visibleOnTapSelection":t=this._selectedViaTap.value()}this._currencyLabel.setHidden(!t)},this._handleActualAutoLogButtonsVisibility=async e=>{const t=e.value();if("alwaysOff"===t)this._scaleModeButtons&&this._destroyScaleModeButtons();else{if(!this._scaleModeButtons){this._scaleModeButtonsPromise=this._scaleModeButtonsPromise??this._createScaleModeButtons();try{this._scaleModeButtons=await this._scaleModeButtonsPromise}catch(e){if((0,ze.isAbortError)(e))return}this._pane.visuallyCollapsed().subscribe(this._updatePriceScaleModeButtonsVisibility)}"alwaysOn"===t?(this._isHovered.unsubscribe(this._updatePriceScaleModeButtonsVisibility),
this._selectedViaTap.unsubscribe(this._updatePriceScaleModeButtonsVisibility)):"visibleOnMouseOver"===t?(this._selectedViaTap.unsubscribe(this._updatePriceScaleModeButtonsVisibility),this._isHovered.subscribe(this._updatePriceScaleModeButtonsVisibility)):(this._isHovered.unsubscribe(this._updatePriceScaleModeButtonsVisibility),this._selectedViaTap.subscribe(this._updatePriceScaleModeButtonsVisibility)),this._updatePriceScaleModeButtonsVisibility()}this.onOptimalWidthNeedToBeRecalculated()},this._updatePriceScaleModeButtonsVisibility=()=>{const e=this._isHovered.value(),t=this._selectedViaTap.value();let i=!1;if(!this._pane.visuallyCollapsed().value()&&!this._chart.chartFloatingTooltipVisible())switch((0,Hi.actualAutoLogButtonsVisibility)().value()){case"visibleOnMouseOver":i=e;break;case"visibleOnTapSelection":i=t;break;case"alwaysOn":i=!0}this._scaleModeButtons?.element().classList.toggle("price-axis__modeButtons_hidden",!i)},this._updateScaleModeButtons=()=>{this._scaleModeButtons?.update()},this._chart=e,this._pane=t,this._undoModel=i,this._properties=s,this._isLeft="left"===r,this._options=(0,n.merge)((0,n.clone)(ds),a),this._rendererOptionsProvider=o,this._backgroundBasedTheme=c,this._cell=document.createElement("div"),this._cell.className="price-axis",this._cell.dataset.name=`price-axis-${l.label}`,this._cell.style.width="25px",this._cell.style.left="0",this._canvasConfiguredHandler=()=>{this._undoModel.model().lightUpdate()},this._canvasBinding=(0,Et.createBoundCanvas)(this._cell,(0,nt.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const h=this._canvasBinding.canvasElement;h.style.position="absolute",h.style.zIndex="1",h.style.left="0",h.style.top="0",this._topCanvasBinding=(0,Et.createBoundCanvas)(this._cell,(0,nt.size)({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const d=this._topCanvasBinding.canvasElement;d.style.position="absolute",d.style.zIndex="2",d.style.left="0",d.style.top="0",this._cell.setAttribute("aria-hidden","true"),this._mouseEventHandler=new oi.MouseEventHandler(this._cell,this,{treatVertTouchDragAsPageScroll:!1,treatHorzTouchDragAsPageScroll:!0}),this._options.currencyConversionEnabled||this._options.unitConversionEnabled?(this._currencyLabel=new Di(12),this._cell.appendChild(this._currencyLabel.element())):this._currencyLabel=null,this._properties.childs().fontSize.subscribe(this,this._onFontSizeChanged),this._options.mouseWheelScale&&(this._mouseWheelHelper=new ti,this._cell.addEventListener("wheel",this._onMousewheel.bind(this),{passive:!1})),this._axisInfo=l,this._offset=0,this.restoreDefaultCursor(),(0,zi.actualCurrencyUnitMetricVisibility)().subscribe(this,this._recalcCurrencyUnitAndMetricVisibility),this._selectedViaTap.subscribe(this._recalcCurrencyUnitAndMetricVisibility.bind(this)),(0,Hi.actualAutoLogButtonsVisibility)().subscribe(this,this._handleActualAutoLogButtonsVisibility),this._handleActualAutoLogButtonsVisibility((0,
Hi.actualAutoLogButtonsVisibility)()).catch((()=>{})),this._chart.anyPriceAxisHovered().subscribe(this._recalcCurrencyUnitAndMetricVisibility,{callWithLast:!0}),this._pane.visuallyCollapsed().subscribe(this._recalcCurrencyUnitAndMetricVisibility,{callWithLast:!0}),this.update()}async getContextMenuActions(e){this._initActions();const t=(0,a.ensureNotNull)(this._actions),i=this._chart.actions(),s=[];if(this._priceScale?.resetScaleAvailable().value()&&s.push(t.reset,new Vi.Separator),s.push(this._autoScaleAction()),this._isMainSeriesAxis()&&s.push(this._lockScaleAction()),s.push(i.scaleSeriesOnly,this._invertAction(),new Vi.Separator,this._regularScaleAction(),this._percentageAction(),this._indexedTo100Action(),this._logAction(),new Vi.Separator,this._createMergeScalesAction(),new Vi.Separator),!(0,d.isFeaturesetEnabled)("fundamental_widget")){const e=[i.showSymbolLabelsAction,i.showSeriesLastValue,i.showSeriesPrevCloseValue,i.showPrePostMarketPriceLabel,i.showHighLowPriceLabels,(0,d.isFeaturesetEnabled)("show_average_close_price_line_and_label")?i.showAverageClosePriceLabel:null,this._undoModel.model().hasCustomSource("bidask")?i.showBidAskLabels:null,i.showStudyPlotNamesAction,i.showStudyLastValue,this._options.countdownEnabled?i.showCountdown:null,new Vi.Separator,t.alignLabels].filter(n.notNull);s.push(new Vi.Action({actionId:"Chart.PriceScale.Labels",options:{label:Zi,subItems:e}}))}const{createLinesAction:o}=await(0,Wi.actionsProviderModule)();return s.push(o(this._chart)),this._undoModel.crosshairSource().isMenuEnabled()&&s.push(i.addPlusButton),e&&!this._chart.onWidget()&&(0,d.isFeaturesetEnabled)("show_chart_property_page")&&(0,d.isFeaturesetEnabled)("chart_property_page_scales")&&i.scalesProperties&&s.push(new Vi.Separator,i.scalesProperties),s}getElement(){return this._cell}onOptimalWidthNeedToBeRecalculated(e){(this._size.width<this.optimalWidth()||e)&&this._undoModel.model().fullUpdate()}optimalWidth(){if(!this.isVisible())return 0;let e=0;const t=this.rendererOptions();if(this._pane.hasState()){const t=(0,Et.getContext2D)(this._canvasBinding.canvasElement);t.font=this.baseFont();const i=this._views(2,this._groupedSources());for(const s of i){if(!s.isAxisLabelVisible()||s.isOutsideOfVisiblePriceRange?.())continue;const i=this._widthCache.measureText(t,s.text());e=Math.max(e,i);const o=s.secondLineText();o&&(e=Math.max(e,this._widthCache.measureText(t,o)));const r=s.thirdLineText();r&&(e=Math.max(e,this._widthCache.measureText(t,r)))}const s=this.priceScale();for(const i of s.marks())e=Math.max(e,this._widthCache.measureText(t,i.label));const o=s.mainSource()?.firstValue()||null;if(null!==o&&!s.isPercentage()&&!s.isIndexedTo100()){const i=s.coordinateToPrice(1,o),r=s.coordinateToPrice(this._size.height-2,o);if(Math.abs(i-r)>1e-14){const n=Math.max(0,-Math.log10(Math.max(Math.abs(i),Math.abs(r)))),a=.11111111111111/Math.pow(10,Math.floor(n)),l=s.formatPrice(Math.min(i,r)-a,o),c=s.formatPrice(Math.max(i,r)+a,o);e=Math.max(e,this._widthCache.measureText(t,l),this._widthCache.measureText(t,c))}}}
const i=this._isCurrencyLabelEnabled()?Math.round((0,a.ensureNotNull)(this._currencyLabel).width()):0,s=e||34;let o=Math.max(i,this._scaleModeButtons?.width()??0,Math.ceil(t.borderSize+t.additionalPaddingInner+t.paddingInner+t.paddingOuter+s+4));return o+=o%2,o}setSizeAndOffset(e,t){(0,nt.equalSizes)(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._cell.style.width=e.width+"px",this._cell.style.height=e.height+"px",this._cell.style.minWidth=e.width+"px"),this._offset!==t&&(this._offset=t,this._cell.style.left=t+"px")}getWidth(){return this._size.width}getImage(){const e=this._size,t=(0,Et.createDisconnectedCanvas)(document,e);return(0,Et.getPrescaledContext2D)(t).drawImage(this._canvasBinding.canvasElement,0,0,e.width,e.height),null===this._currencyLabel||this._currencyLabel.isHidden()||this._currencyLabel.drawLabel((0,Et.getContext2D)(t),e.width,(0,Kt.getCanvasDevicePixelRatio)(t)),t}update(){null!==this._priceScale&&(this._priceScale.marks(),this.rendererOptions())}paint(e){if(!this._isVisible||0===this._size.width||0===this._size.height)return;if(e===ve.InvalidationLevel.None)return;const t=this._pane.state(),i=!t.maximized().value()&&t.collapsed().value();if(i&&e<ve.InvalidationLevel.Full)return;const s=this._pane.hasState();(0,Et.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,Et.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding);const o=null!==this._currencyLabel&&!this._currencyLabel.isHidden(),r=(e,t,i)=>{if(o){e.save(),e.beginPath();const i=(0,a.ensureNotNull)(this._currencyLabel).labelBottom();e.rect(0,i*t.verticalPixelRatio,t.bitmapSize.width,t.bitmapSize.height),e.clip()}i(),o&&e.restore()},n=(0,at.default)((()=>this._groupedSources())),l=(0,at.default)((()=>this._views(1,n()))),c=(0,at.default)((()=>this._views(0,n())));if(e>ve.InvalidationLevel.Cursor){const e=(0,Et.getContext2D)(this._canvasBinding.canvasElement),t=(0,Et.getBindingRenderingInfo)(this._canvasBinding);i||(this._alignLabels([...l(),...c()]),s&&this.updateCurrencyLabel()),this._drawBackground(e,t),i||r(e,t,(()=>{this._drawDrawingsHighlight(e,t)})),this._drawBorder(e,t),s&&!i&&(this._scaleModeButtons&&(this._scaleModeButtons.element().style.background=this._highlighted?this._highlightColor():this.backgroundColor()),r(e,t,(()=>{this._drawTickMarks(e,t),this._drawLabels(c(),e,t)})))}if(s&&!i){const e=(0,Et.getContext2D)(this._topCanvasBinding.canvasElement),t=(0,Et.getBindingRenderingInfo)(this._topCanvasBinding);e.clearRect(0,0,t.bitmapSize.width,t.bitmapSize.height),r(e,t,(()=>{this._drawLabels(l(),e,t),this._drawCrossHairLabel(e,t)}))}}restoreDefaultCursor(){this._setCursor("")}priceScale(){return(0,a.ensureNotNull)(this._priceScale)}setPriceScale(e){this._priceScale!==e&&(null!==this._priceScale&&(this._priceScale.onMarksChanged().unsubscribe(this,this.onOptimalWidthNeedToBeRecalculated),this._priceScale.modeChanged().unsubscribeAll(this)),this._priceScale=e,null!==e&&(e.onMarksChanged().subscribe(this,this.onOptimalWidthNeedToBeRecalculated),
e.modeChanged().subscribe(this,(()=>this.onOptimalWidthNeedToBeRecalculated(!0))),this.onOptimalWidthNeedToBeRecalculated(),this._scaleModeButtons&&(e.modeChanged().subscribe(this,this._updateScaleModeButtons),this._updateScaleModeButtons())))}isVisible(){return this._isVisible}setVisible(e){(e=!!e)!==this._isVisible&&(this._cell.style.display=e?"table-cell":"none",this._isVisible=e)}destroy(){null!==this._currencyMenu&&(this._currencyMenu.destroy(),this._currencyMenu=null),null!==this._unitMenu&&(this._unitMenu.destroy(),this._unitMenu=null),null!==this._metricMenu&&(this._metricMenu.destroy(),this._metricMenu=null),this._pane.visuallyCollapsed().unsubscribe(this._recalcCurrencyUnitAndMetricVisibility),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),null!==this._priceScale&&(this._priceScale.onMarksChanged().unsubscribe(this,this.onOptimalWidthNeedToBeRecalculated),this._priceScale.modeChanged().unsubscribeAll(this)),this._priceScale=null,this._mouseEventHandler.destroy(),this._properties.childs().fontSize.unsubscribe(this,this._onFontSizeChanged),null!==this._actions&&(Object.values(this._actions).forEach((e=>{e.destroy()})),this._actions=null),(0,zi.actualCurrencyUnitMetricVisibility)().unsubscribeAll(this),this._chart.anyPriceAxisHovered().unsubscribe(this._recalcCurrencyUnitAndMetricVisibility),(0,Hi.actualAutoLogButtonsVisibility)().unsubscribeAll(this),this._chart.setPriceAxisHovered(this,!1),this._destroyScaleModeButtons(),this._destroyed=!0}axisInfo(){return this._axisInfo}setHighlighted(e){this._highlighted=e}backgroundColor(){return this._pane.state().model().backgroundColor().value()}backgroundTopColor(){return this._pane.state().model().backgroundTopColor().value()}lineColor(){return this._properties.childs().lineColor.value()}textColor(){return this._properties.childs().textColor.value()}fontSize(){return this._properties.childs().fontSize.value()}baseFont(){return(0,gi.makeFont)(this.fontSize(),yi.CHART_FONT_FAMILY,"")}rendererOptions(){let e=this._rendererOptionsProvider.options();return this._color===e.color&&this._fontSize===e.fontSize||(this._color=e.color),this._fontSize!==e.fontSize&&(this._widthCache.reset(),this._fontSize=e.fontSize,this.onOptimalWidthNeedToBeRecalculated()),this._chart.onWidget()||(e=Object.assign({},e,{paddingInner:Math.max(e.paddingInner,Ii.ALERT_LABEL_WIDTH)})),e}mouseEnterEvent(e){this._chart.chartFloatingTooltipVisible()||(this._chart.setPriceAxisHovered(this,!0),this._isHovered.setValue(!0),this._applyLightUpdateIfRequired(),this._mouseEnterOrTouchStartEvent(e))}mouseMoveEvent(e){this._mouseOrTouchMoveEvent(e)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._mouseOrTouchMoveEvent(e),this._mouseEnterOrTouchStartEvent(e),this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){
this._pressedMouseOrTouchMoveEvent(e)}pinchStartEvent(e,t,i,s){return s.bothPointsOnTargetElement}pinchEvent(e,t,i){if(this._zoomAvailable()&&this._options.pinchScale){if(this._dragScaleActive&&this._finishScale(),!this._pinching)return this._pinching=!0,void this._undoModel.startTwoPointsScalePrice(this._pane.state(),this.priceScale(),t.y,i.y);this._undoModel.twoPointsScalePriceTo(this._pane.state(),this.priceScale(),t.y,i.y)}}pinchEndEvent(){this._pinching=!1,this._undoModel.endTwoPointsScalePrice(this._pane.state(),this.priceScale())}mouseDownOutsideEvent(){this._finishScale()}touchStartOutsideEvent(){this._finishScale(),this._selectedViaTap.setValue(!1)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseLeaveOrTouchEndEvent(e),this._mouseUpOrTouchEndEvent(e)}mouseClickEvent(e){this._mouseClickOrTapEvent(e)}tapEvent(e){this._mouseClickOrTapEvent(e)}mouseLeaveEvent(e){this._chart.setPriceAxisHovered(this,!1),this._isHovered.setValue(!1),this._applyLightUpdateIfRequired(),this._mouseLeaveOrTouchEndEvent(e)}mouseDoubleClickEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}doubleTapEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}contextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}touchContextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}dataSourceAtPoint(e,t){const i=this._pane.state();if(!i.maximized().value()&&i.collapsed().value())return null;const s=this._groupedSources(),o=[...s.sources,...s.topLevelSources,...i.customSources(),...i.sourcesByGroup().multipaneSources()];let r=null,n=null;if(!this._priceScale)return null;const a=(e,t)=>{const i=n?.target()??0;e.target()>i&&(n=e,r=t)},l=new dt.Point(e,t),c=(0,Et.getBindingRenderingInfo)(this._canvasBinding);for(let e=o.length-1;e>=0;--e){const t=o[e],s=t.priceAxisViews(i,this._priceScale);if(s&&0!==s.length)for(let e=s.length-1;e>=0;--e){const i=s[e].renderer();if(void 0!==i.hitTest){const e=i.hitTest(l,c,this._isLeft?"left":"right");null!==e&&a(e,t)}}}return this._lastHittestResult=n,r}reset(){const e=this._pane.state(),t=this.priceScale();this._undoModel.resetPriceScale(e,t),this.onOptimalWidthNeedToBeRecalculated(!0)}updateCurrencyLabel(){this._updateCurrencyLabelCurrency(),this._updateCurrencyLabelUnit(),this._updateCurrencyLabelMetric()}_updateCurrencyLabelCurrency(){if(null!==this._currencyLabel)if(this._options.currencyConversionEnabled){const e=this.priceScale().currency(this._undoModel.model().availableCurrencies());null===e||"alwaysOff"===(0,zi.actualCurrencyUnitMetricVisibility)().value()?this._currencyLabel.disableCurrency():(this._currencyLabel.enableCurrency(),this._currencyLabel.setCurrencyInfo(e))}else this._currencyLabel.disableCurrency()}_updateCurrencyLabelUnit(){if(null!==this._currencyLabel&&this._options.unitConversionEnabled){const e="alwaysOff"===(0,zi.actualCurrencyUnitMetricVisibility)().value(),t=this._undoModel.model().availableUnits(),i=this.priceScale().unit(t);null===i||e?this._currencyLabel.disableUnit():(this._currencyLabel.enableUnit(),this._currencyLabel.setUnitInfo(i))
;const s=this.priceScale().measureUnitId(t);null===s||e?this._currencyLabel.disableMeasureUnitId():(this._currencyLabel.enableMeasureUnitId(),this._currencyLabel.setMeasureUnitIdInfo(s))}}_updateCurrencyLabelMetric(){if(null!==this._currencyLabel&&this._options.metricConversionEnabled){const e="alwaysOff"===(0,zi.actualCurrencyUnitMetricVisibility)().value(),t=this._undoModel.model().availableMetrics(),i=this.priceScale().metric(t);null===i||e?this._currencyLabel.disableMetric():(this._currencyLabel.enableMetric(),this._currencyLabel.setMetricInfo(i))}}_groupedSources(){const e=this._pane.state(),t=e.model(),i=this._pane.state().sourcesByGroup(),s=this._isLeft?i.leftPriceScalesSources():i.rightPriceScalesSources(),o=this._priceScale===e.defaultPriceScale(),r=new Set(e.customSources()),n=t=>!!r.has(t)||(t.priceScale()===this._priceScale||o&&e.isOverlay(t)),a={sources:[...s.filter(n),...e.customSources()],topLevelSources:new Set};if(o){const t=this._pane.state().dataSources();for(const i of t)e.isOverlay(i)&&a.sources.push(i)}const l=t.lineBeingEdited()??t.lineBeingCreated();l&&n(l)&&(a.topLevelSources.add(l),a.lineBeingEditedOrCreated=l);const c=t.customSourceBeingMoved();c&&n(c)&&(a.topLevelSources.add(c),a.customSourceBeingMoved=c);const h=t.sourcesBeingMoved().filter(n);h.length>0&&(t.sourcesBeingMoved().forEach((e=>a.topLevelSources.add(e))),a.sourcesBeingMoved=h);const d=t.selection().allSources().filter(n);d.length>0&&(d.forEach((e=>a.topLevelSources.add(e))),a.selectedSources=d);const u=t.hoveredSource();return u&&n(u)&&(a.topLevelSources.add(u),a.hoveredSource=u),a}_isCurrencyLabelEnabled(){return null!==this._currencyLabel&&this._currencyLabel.isEnabled()}_alignLabels(e){const t=this.priceScale(),i=t.mainSource(),s=this._pane.state(),o=i?{labels:()=>i.priceAxisViews(s,t)}:null;!function(e){const{visibleViews:t,height:i,scale:s,rendererOptions:o}=e;let r=i/2;const n=Gi(o,i,t),a=s.mainSource();let l=[];null!==a&&(l=Gi(o,i,a.labels()),l.length&&(r=l[0].coordinate()));const c=n.filter((e=>e.coordinate()<=r)),h=n.filter((e=>e.coordinate()>r));c.sort(((e,t)=>{const i=t.coordinate()-e.coordinate();if(i)return i;const s=l.includes(e)?1:0;return(l.includes(t)?1:0)-s})),c.length>0&&h.length>0&&h.push(c[0]),h.sort(((e,t)=>e.coordinate()-t.coordinate()));for(const e of n)e.setFixedCoordinate(e.coordinate());if(s.labelsAligningEnabled()){if(h.length>0||c.length>0){{const e=c[0]??h[0],t=e.fixedOrRegularCoordinate(),{top:s,bottom:r,total:n}=e.topBottomTotalHeight(o);n<i&&t-s<0&&t+r>0&&e.setFixedCoordinate(s)}{const e=h[0]??c[0],t=e.fixedOrRegularCoordinate(),{top:s,bottom:r,total:n}=e.topBottomTotalHeight(o);n<i&&t-s<i&&t+r>i&&e.setFixedCoordinate(i-r)}}for(let e=1;e<c.length;e++){const t=c[e],i=c[e-1],{top:s,bottom:r,total:n}=t.topBottomTotalHeight(o),a=t.fixedOrRegularCoordinate(),l=i.fixedOrRegularCoordinate();if(a>l-n)t.setFixedCoordinate(l-n);else if(l>0&&a-s<0&&a+r>0){const{top:e}=i.topBottomTotalHeight(o);t.setFixedCoordinate(Math.min(l-e-r,s))}}for(let e=1;e<h.length;e++){
const t=h[e],s=h[e-1],{bottom:r,total:n}=s.topBottomTotalHeight(o),a=t.fixedOrRegularCoordinate(),l=s.fixedOrRegularCoordinate();if(a<l+n)t.setFixedCoordinate(l+n);else if(l<i){const{top:e,bottom:s}=t.topBottomTotalHeight(o);a-e<i&&a+s>i&&t.setFixedCoordinate(Math.max(l+r+e,i-s))}}}}({visibleViews:e,height:this._size.height,scale:{labelsAligningEnabled:()=>this.priceScale().properties().childs().alignLabels.value(),mainSource:()=>o},rendererOptions:this.rendererOptions()})}_drawTickMarks(e,t){const i=this.priceScale().marks();e.save(),e.font=this.baseFont();const s=this.rendererOptions(),{horizontalPixelRatio:o,verticalPixelRatio:r}=t,n=this._isLeft?Math.floor((this._size.width-s.additionalPaddingInner)*o):0,l=this._isLeft?Math.round(n-s.paddingInner*o):Math.round(n+(s.additionalPaddingInner+s.paddingInner)*o),c=this.fontSize(),h=this._isCurrencyLabelEnabled()?(0,a.ensureNotNull)(this._currencyLabel).labelBottom():0,d=i.map((t=>{if(this._options.croppedTickMarks)return{visible:!0,yCorrection:this._widthCache.yMidCorrection(e,t.label)};const i=t.coord-c/2,s=t.coord+c/2,o=!(s>this._size.height||i<h);return{visible:!(s>this._size.height||i<h),yCorrection:o?this._widthCache.yMidCorrection(e,t.label):0}}));e.fillStyle=this.textColor(),e.textAlign=this._isLeft?"right":"left",e.textBaseline="middle",(0,Et.drawScaled)(e,o,r,(()=>{for(let t=i.length;t--;){if(!d[t].visible)continue;const s=i[t];e.fillText(s.label,l/o,s.coord+d[t].yCorrection)}})),e.restore()}async _showCurrenciesContextMenu(){if(this._currencyMenu)return this._currencyMenu.destroy(),void(this._currencyMenu=null);let e;(0,_t.trackEvent)("GUI","Currency conversion");const t=()=>{this._currencyMenu=null,this._recalcCurrencyUnitAndMetricVisibility(),this._currencyLabel?.setCurrencyExpanded(!1)};if(ls)e=await Ri((0,a.ensureNotNull)(this._currencyLabel).currencyLabelElement(),["toggle_currency_menu_inner",this._undoModel.model().id(),this._pane.state().id(),this.priceScale().id()],t);else{const{currencyActions:s}=await Promise.all([i.e(36989),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(75649),i.e(68805),i.e(75174),i.e(31403),i.e(24193),i.e(97493),i.e(98101),i.e(32387),i.e(99331),i.e(8297)]).then(i.bind(i,380069));e=await Bi(Yi,(()=>s(this._undoModel,(0,a.ensureNotNull)(this._currencyLabel).currencyInfo(),this.priceScale())),(0,a.ensureNotNull)(this._currencyLabel).currencyLabelElement(),t)}this._destroyed?e.destroy():(this._currencyLabel?.setCurrencyExpanded(!0),this._currencyMenu=e)}async _showUnitsContextMenu(){if(this._unitMenu)return this._unitMenu.destroy(),void(this._unitMenu=null);let e;(0,_t.trackEvent)("GUI","Unit conversion");const t=()=>{this._unitMenu=null,this._recalcCurrencyUnitAndMetricVisibility(),this._currencyLabel?.setUnitExpanded(!1)};if(cs)e=await Ri((0,a.ensureNotNull)(this._currencyLabel).unitLabelElement(),["toggle_unit_menu_inner",this._undoModel.model().id(),this._pane.state().id(),this.priceScale().id()],t);else{
const{unitActions:s}=await Promise.all([i.e(36989),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(75649),i.e(68805),i.e(75174),i.e(31403),i.e(24193),i.e(97493),i.e(98101),i.e(32387),i.e(99331),i.e(8297)]).then(i.bind(i,891076));e=await Bi(Xi,(()=>s(this._undoModel,(0,a.ensureNotNull)(this._currencyLabel).unitInfo(),this.priceScale())),(0,a.ensureNotNull)(this._currencyLabel).unitLabelElement(),t)}this._destroyed?e.destroy():(this._currencyLabel?.setUnitExpanded(!0),this._unitMenu=e)}async _showMetricsContextMenu(){if(this._metricMenu)return this._metricMenu.destroy(),void(this._metricMenu=null);let e;(0,_t.trackEvent)("GUI","Metric switcher");const t=()=>{this._metricMenu=null,this._recalcCurrencyUnitAndMetricVisibility(),this._currencyLabel?.setMetricExpanded(!1)};if(hs)e=await Ri((0,a.ensureNotNull)(this._currencyLabel).metricLabelElement(),["toggle_metric_menu_inner",this._undoModel.model().id(),this._pane.state().id(),this.priceScale().id()],t);else{const{metricActions:s}=await Promise.all([i.e(36989),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(75649),i.e(68805),i.e(75174),i.e(31403),i.e(24193),i.e(97493),i.e(98101),i.e(32387),i.e(99331),i.e(8297)]).then(i.bind(i,48806));e=await Bi(Ji,(()=>s(this._undoModel,(0,a.ensureNotNull)(this._currencyLabel).metricInfo(),this.priceScale())),(0,a.ensureNotNull)(this._currencyLabel).metricLabelElement(),t,!0)}this._destroyed?e.destroy():(this._currencyLabel?.setMetricExpanded(!0),this._metricMenu=e)}_onFontSizeChanged(){this.onOptimalWidthNeedToBeRecalculated()}_mouseOrTouchMoveEvent(e){if(!this._priceScale)return;if(this._chart.chartFloatingTooltipVisible())return void this._setCursorClassName("default");if(e.localX<0||e.localY<0||e.localX>=this._size.width||e.localY>=this._size.height)return;let t=!0;const i=this.dataSourceAtPoint(e.localX,e.localY);i?((0,Ii.isAlertLabel)(i)?this._setCursorClassName("default"):this._setCursorClassName("pointer"),this._lastHittestResult?.data()?.hoverModelFromAxis&&(this._undoModel.model().setHoveredSource(i,this._lastHittestResult?.data()??null,0),t=!1)):this._setResizeCursor(),t&&this._undoModel.model().setHoveredSource(null,null)}_mouseDownOrTouchStartEvent(e){this._zoomAvailable()&&this._options.pressedMouseMoveScale&&!this._pinching&&(this._dragScaleActive=!0,this._undoModel.startScalePrice(this._pane.state(),this.priceScale(),e.localY))}_mouseEnterOrTouchStartEvent(e){this._setResizeCursor()}_pressedMouseOrTouchMoveEvent(e){if(this._dragScaleActive){const t=this.priceScale();this._undoModel.scalePriceTo(this._pane.state(),t,e.localY)}}_mouseUpOrTouchEndEvent(e){this._finishScale()}_finishScale(){this._dragScaleActive&&(this._undoModel.endScalePrice(this._pane.state(),this.priceScale()),this.restoreDefaultCursor(),this._dragScaleActive=!1)}_mouseClickOrTapEvent(e){if(this._currencyLabel){
if(this._currencyLabel.currencyConversionAvailable()&&this._currencyLabel.currencyLabelElement().contains(e.target))return this._showCurrenciesContextMenu(),void e.preventDefault();if(this._currencyLabel.unitConversionAvailable()&&this._currencyLabel.unitLabelElement().contains(e.target))return this._showUnitsContextMenu(),void e.preventDefault();if(this._currencyLabel.metricConversionAvailable()&&this._currencyLabel.metricLabelElement().contains(e.target))return this._showMetricsContextMenu(),void e.preventDefault()}e.isTouch&&this._selectedViaTap.setValue(!this._selectedViaTap.value());const t=this.dataSourceAtPoint(e.localX,e.localY);t&&this._undoModel.selectionMacro((e=>{e.selection().isSelected(t)&&this._undoModel.model().lastSelectedHittestData()===this._lastHittestResult?.data()||(e.clearSelection(),e.addSourceToSelection(t,this._lastHittestResult?.data()??null))}))}_mouseLeaveOrTouchEndEvent(e){this._setCursorClassName("")}_mouseDoubleClickOrDoubleTapEvent(e){if(this._currencyLabel?.currencyLabelElement().contains(e.target)||this._currencyLabel?.unitLabelElement().contains(e.target))return;const t=this.dataSourceAtPoint(e.localX,e.localY);t?this._pane.processDoubleClickOnSource(t,this._lastHittestResult??void 0,{origin:"price_scale"}):(this.reset(),(0,_t.trackEvent)("GUI","Double click price scale"))}async _contextMenuOrTouchContextMenuEvent(e){if(this._options.contextMenuEnabled){const t=this.dataSourceAtPoint(e.localX,e.localY);if(null!==t&&this._options.contextMenu.source){return void this._undoModel.model().selectionMacro((i=>{i.selection().isSelected(t)||(i.clearSelection(),i.addSourceToSelection(t)),this._pane.showContextMenuForSelection(e,{origin:"price_scale"})}))}if(this._options.contextMenu.general){const t=await this.getContextMenuActions(!0),i=this._undoModel.model().panes().findIndex((e=>e.id()===this._pane.state().id())),s=this._chart.chartWidgetCollection().chartModels().value().findIndex((e=>e.id()===this._undoModel.id())),o=this._priceScale?.id()&&-1!==i&&-1!==s;fi.ContextMenuManager.showMenu(t,e,{statName:"PriceScaleContextMenu"},{menuName:"PriceScaleContextMenu",...o&&{detail:{type:"priceScale",id:this._priceScale?.id()??"",paneIndex:i,chartIndex:s}}})}}}_setResizeCursor(){const e=this.priceScale();e.isPercentage()||e.isIndexedTo100()?this._setCursorClassName(""):this._zoomAvailable()&&(this._options.pressedMouseMoveScale||this._options.mouseWheelScale)&&this._setCursorClassName("ns-resize")}_setCursorClassName(e){let t="";e&&!this._pane.visuallyCollapsed().value()&&(t="price-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t)}_zoomAvailable(){return!this.priceScale().isEmpty()&&this.priceScale().hasCalculatedPriceRange()&&this._undoModel.model().zoomEnabled()}_onMousewheel(e){if(!this._zoomAvailable()||!this._options.mouseWheelScale)return;const t=(0,a.ensureNotNull)(this._mouseWheelHelper).processWheel(e).deltaY;if(0===t)return
;e.cancelable&&e.preventDefault();const i=this._undoModel,s=this._pane.state(),o=this.priceScale(),r=this._cell.getBoundingClientRect(),n=e.clientY-r.top,l=n+15*t;i.startScalePrice(s,this.priceScale(),n,!0),i.scalePriceTo(s,o,l),i.endScalePrice(s,o),e.stopPropagation()}_drawCrossHairLabel(e,t){const i=this._pane.state(),s=i.model(),o=this.priceScale(),r=s.crosshairSource().priceAxisViews(i,o);r&&r.length>0&&this._drawLabels(r,e,t)}_drawBackground(e,t){const i=this.backgroundTopColor(),s=this.backgroundColor(),{bitmapSize:o}=t;if(i===s?(0,Et.clearRect)(e,0,0,o.width,o.height,this.backgroundColor()):(0,mi.clearRectWithGradient)(e,0,0,o.width,o.height,i,s),this._highlighted){e.globalAlpha=.5;const t=L.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight");(0,Et.fillRect)(e,0,0,o.width,o.height,t),e.globalAlpha=1}}_drawDrawingsHighlight(e,t){const i=this._pane.state().model(),s=this.priceScale(),o=i.selection().lineDataSources().filter((e=>!e.isFixed()&&e.priceScale()===s)).reduce(((e,t)=>{const i=t.priceAxisPoints();return 0===i.length?e:e.concat(i)}),[]);o.length>0&&this._hightlightBackground(e,o,this.priceScale().mainSource(),t);const r=i.crosshairSource();r.startMeasurePoint()&&this._hightlightBackground(e,r.measurePoints(),this.priceScale().mainSource(),t)}_drawBorder(e,t){e.save(),e.fillStyle=this.lineColor();const{horizontalPixelRatio:i}=t,s=Math.max(1,Math.floor(this.rendererOptions().borderSize*i)),o=this._isLeft?t.bitmapSize.width-s:0;e.fillRect(o,0,s,t.bitmapSize.height),e.restore()}_drawLabels(e,t,i){const s=this.rendererOptions(),o=this._isLeft?"right":"left";for(const r of e)r.isAxisLabelVisible()&&(t.save(),r.renderer().draw(t,i,s,this._widthCache,o),t.restore())}_hightlightBackground(e,t,i,s){if(!i)return;const o=i.firstValue();if(null===o)return;let r=t[0].price,n=t[0].price;for(let e=1;e<t.length;e++)r=Math.min(r,t[e].price),n=Math.max(n,t[e].price);const{horizontalPixelRatio:a,verticalPixelRatio:l}=s,c=this.priceScale(),h=Math.floor(c.priceToCoordinate(r,o)*l),d=Math.ceil(c.priceToCoordinate(n,o)*l);(0,Et.fillRect)(e,Math.floor(a),h,s.bitmapSize.width,d-h,this._properties.childs().axisHighlightColor.value())}_viewsOrMaxMinViews(e){const t=this._pane.state(),i=this.priceScale();if(0===e.length)return[];if(1===e.length)return e[0].priceAxisViews(t,i)??[];{let s=1/0,o=-1/0,r=null,n=null;for(const a of e){const e=a.priceAxisViews(t,i)??[];for(const t of e){if(!t.isVisible())continue;const e=t.fixedOrRegularCoordinate();e>=o&&(o=e,n=t),e<=s&&(s=e,r=t)}}return n&&r?[n,r]:[]}}_views(e,t){const i=this._pane.state(),s=this.priceScale(),o=[];if(1!==e)for(const e of t.sources)t.topLevelSources.has(e)||o.push(...e.priceAxisViews(i,s)??[]);if(0!==e){const e=new Set,r=t=>!e.has(t),n=t=>{const i=t.filter(r);o.push(...this._viewsOrMaxMinViews(i));for(const t of i)e.add(t)};t.customSourceBeingMoved&&n([t.customSourceBeingMoved]),t.sourcesBeingMoved&&n(t.sourcesBeingMoved),t.selectedSources&&n(t.selectedSources),t.hoveredSource&&n([t.hoveredSource]),
t.lineBeingEditedOrCreated&&n([t.lineBeingEditedOrCreated]);for(const e of[...t.sources,...i.customSources()])e.topPriceAxisViews&&o.push(...e.topPriceAxisViews(i,s)??[])}return o}_initActions(){if(!this._pane.hasState()||null!==this._actions)return;const e=this._undoModel,t=new Ui.ActionWithStandardIcon({actionId:"Chart.PriceScale.Reset",options:{label:Qi,iconId:"Chart.Reset",shortcutHint:(0,O.humanReadableHash)(O.Modifiers.Alt+82),statName:"ResetScale",onExecute:()=>this.reset()}}),i=new Vi.Action({actionId:"Chart.PriceScale.ToggleAutoScale",options:{label:es,checkable:!0,checked:!0,statName:"ToggleAutoScale",onExecute:()=>{e.togglePriceScaleAutoScaleMode(this.priceScale()),this._updateScalesActions()}}}),s=new Vi.Action({actionId:"Chart.PriceScale.TogglePercentage",options:{label:ts,checkable:!0,checked:this.priceScale().isPercentage(),statName:"TogglePercantage",onExecute:()=>{e.togglePriceScalePercentageScaleMode(this.priceScale()),this._updateScalesActions()}}}),o=new Vi.Action({actionId:"Chart.PriceScale.ToggleIndexedTo100",options:{label:is,checkable:!0,checked:this.priceScale().isIndexedTo100(),statName:"ToggleIndexedTo100",onExecute:()=>{e.togglePriceScaleIndexedTo100ScaleMode(this.priceScale()),this._updateScalesActions()}}}),r=new Vi.Action({actionId:"Chart.PriceScale.ToggleLogarithmic",options:{label:ss,checkable:!0,checked:this.priceScale().isLog(),statName:"ToggleLogScale",onExecute:()=>{e.togglePriceScaleLogScaleMode(this.priceScale()),this._updateScalesActions()}}}),n=new Vi.Action({actionId:"Chart.PriceScale.ToggleRegular",options:{label:os,checkable:!0,checked:this.priceScale().isRegular(),statName:"ToggleRegularScale",onExecute:()=>{e.setPriceScaleRegularScaleMode(this.priceScale()),this._updateScalesActions()}}}),a=new Ni({actionId:"Chart.PriceScale.Labels.ToggleNoOverlappingLabelsVisibility",options:{label:rs,checkable:!0,checked:this.priceScale().properties().childs().alignLabels.value(),statName:"TogglePreciseLabels"}},{property:this.priceScale().properties().childs().alignLabels,undoModel:e,undoText:ji}),l=new Vi.Action({actionId:"Chart.PriceScale.ToggleInvertScale",options:{label:ns,checkable:!0,checked:this.priceScale().isInverted(),statName:"Invert Scale",onExecute:()=>{e.invertPriceScale(this.priceScale()),this._updateScalesActions()}}});this._actions={reset:t,setAutoScale:i,setPercentage:s,setIndexedTo100:o,setLog:r,setRegular:n,alignLabels:a,invertScale:l},this._updateScalesActions()}_logAction(){return this._isMainSeriesAxis()?this._chart.actions().logSeriesScale:(0,a.ensureNotNull)(this._actions).setLog}_percentageAction(){return this._isMainSeriesAxis()?this._chart.actions().percentSeriesScale:(0,a.ensureNotNull)(this._actions).setPercentage}_indexedTo100Action(){return this._isMainSeriesAxis()?this._chart.actions().indexedTo100SeriesScale:(0,a.ensureNotNull)(this._actions).setIndexedTo100}_autoScaleAction(){return this._isMainSeriesAxis()?this._chart.actions().autoSeriesScale:(0,a.ensureNotNull)(this._actions).setAutoScale}_regularScaleAction(){
return this._isMainSeriesAxis()?this._chart.actions().regularSeriesScale:(0,a.ensureNotNull)(this._actions).setRegular}_lockScaleAction(){const e=this._chart.actions().lockSeriesScale,t=as(this.priceScale(),this._undoModel.model().mainSeriesScaleRatio());return e.update({hint:t}),e}_invertAction(){return this._isMainSeriesAxis()?this._chart.actions().invertSeriesScale:(0,a.ensureNotNull)(this._actions).invertScale}_isMainSeriesAxis(){return this.priceScale().hasMainSeries()}_updateScalesActions(){const e=this.priceScale(),t=this._isMainSeriesAxis(),i=(0,a.ensureNotNull)(e.mainSource()).properties(),s=t&&e.isLockScale(),o=t&&6===i.style.value(),r=(0,a.ensureNotNull)(this._actions);r.setRegular.update({checked:e.isRegular(),disabled:s||o}),r.setPercentage.update({checked:e.isPercentage(),disabled:s||o}),r.setIndexedTo100.update({checked:e.isIndexedTo100(),disabled:s||o}),r.setLog.update({checked:e.isLog(),disabled:s||o}),r.setAutoScale.update({checked:e.isAutoScale(),disabled:e.properties().childs().autoScaleDisabled.value()})}_createMergeScalesAction(){const e=this._chart.actions(),t=this._undoModel.model().priceScaleSlotsCount();if(t.left+t.right===1)return 0===t.left?e.moveScaleToLeft:e.moveScaleToRight;const i=[];return i.push(e.mergeLeftScalesAction),i.push(e.mergeRightScalesAction),new Vi.Action({actionId:"Chart.PriceScale.MergeAllScales",options:{label:Ki,subItems:i}})}_setCursor(e){let t="";"grabbing"!==e&&"ns-resize"!==e||(t="price-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t,this._cell.style.cursor)}async _createScaleModeButtons(){const{PriceScaleModeButtonsRenderer:e}=await Promise.all([i.e(22510),i.e(66235),i.e(32387),i.e(71375)]).then(i.bind(i,791907));if(this._destroyed)throw(0,ze.createAbortError)();const t=new e({className:"price-axis__modeButtons",setMode:e=>{this._priceScale&&("log"===e?this._chart.model().setPriceScaleMode({log:!this._priceScale.isLog()},this._priceScale,$i):this._chart.model().setPriceScaleMode({autoScale:!this._priceScale.isAutoScale()},this._priceScale,qi))},getMode:()=>this._priceScale?.mode()});return t.element().style.background=this.backgroundColor(),this._cell.appendChild(t.element()),this._priceScale?.modeChanged().subscribe(this,this._updateScaleModeButtons),t}_destroyScaleModeButtons(){this._scaleModeButtons&&(this._isHovered.unsubscribe(this._updatePriceScaleModeButtonsVisibility),this._selectedViaTap.unsubscribe(this._updatePriceScaleModeButtonsVisibility),this._pane.visuallyCollapsed().unsubscribe(this._updatePriceScaleModeButtonsVisibility),this._priceScale?.modeChanged().unsubscribe(this,this._updateScaleModeButtons),this._scaleModeButtons.destroy(),this._scaleModeButtons=null)}_highlightColor(){const e=this.backgroundColor(),t=this._backgroundBasedTheme.value();if(null===this._highlightColorCache||this._highlightColorCache.backgroundColor!==e||this._highlightColorCache.theme!==t){const i=(0,
Li.applyTransparency)(L.themes[this._backgroundBasedTheme.value()].getThemedColor("color-price-axis-highlight"),50),s=(0,ii.rgbaToString)((0,ii.blendRgba)((0,ii.parseRgba)(this.backgroundColor()),(0,ii.parseRgba)(i)));this._highlightColorCache={theme:t,backgroundColor:e,resultColor:s}}return this._highlightColorCache.resultColor}_applyLightUpdateIfRequired(){"visibleOnMouseOver"===(0,zi.actualCurrencyUnitMetricVisibility)().value()&&this._undoModel.model().lightUpdate()}}var _s=i(320269),ps=i(140677);const ms=(0,l.getLogger)("Chart.ChartUndoModel"),gs=new P.TranslatedString("scale price",h.t(null,void 0,i(256968)));class Ss extends m.UndoCommand{constructor(e,t,i,s,o,r=!0){super(gs,!1,r),this._newPriceScaleState=null,this._model=e,this._paneIndex=e.panes().indexOf(t),this._priceScaleId=i.id(),this._state=s,this._timestamp=o?performance.now():null}undo(){if(null!==this._newPriceScaleState)return void ms.logDebug("PriceScaleChangeUndoCommand.undo: Command is already undone");const[e,t]=this._paneAndScale();this._newPriceScaleState=t.state(),this._model.restorePriceScaleState(e,t,this._state)}redo(){if(null===this._newPriceScaleState)return void ms.logDebug("PriceScaleChangeUndoCommand.redo: Command is not undone");const[e,t]=this._paneAndScale();this._model.restorePriceScaleState(e,t,this._newPriceScaleState),this._newPriceScaleState=null}canMerge(e){return e instanceof Ss&&null!==this._timestamp&&null!==e._timestamp&&null===this._newPriceScaleState&&e._model===this._model&&e._paneIndex===this._paneIndex&&e._priceScaleId===this._priceScaleId&&Math.abs(e._timestamp-this._timestamp)<1e3}merge(e){this._timestamp=e._timestamp}_paneAndScale(){const e=this._model.panes()[this._paneIndex],t=(0,a.ensureNotNull)(e.getPriceScaleById(this._priceScaleId));return[e,t]}}var vs=i(648589),fs=i(925752),bs=i(453113),ys=i(526067),ws=i(193343),Cs=i(545672),Ts=i(635262);class Ps{constructor(e,t){this._size=(0,nt.size)({width:0,height:0}),this._pane=null,this._canvasConfiguredHandler=()=>this._pane?.model().lightUpdate(),this._rendererOptionsProvider=e,this._side=t,this._cell=document.createElement("div"),this._cell.classList.add("chart-markup-table","price-axis-container"),this._cell.style.width="25px",this._cell.style.position="relative",this._canvasBinding=(0,Et.createBoundCanvas)(this._cell,(0,nt.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const i=this._canvasBinding.canvasElement;i.style.position="absolute",i.style.top="0px",i.style.left="0px",this._mouseEventHandler=new oi.MouseEventHandler(this._cell,this)}destroy(){this._mouseEventHandler.destroy(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose()}getElement(){return this._cell}getScreenshotData(e){const t=(0,Et.createDisconnectedCanvas)(document,this._size),i=(0,Et.getPrescaledContext2D)(t);return 0!==this._size.width&&0!==this._size.height&&i.drawImage(this._canvasBinding.canvasElement,0,0,this._size.width,this._size.height),{
content:t.toDataURL(),canvas:t,contentWidth:this._size.width,contentHeight:this._size.height}}setPane(e){this._pane=e}update(){}paint(){if(0===this._size.width||0===this._size.height)return;(0,Et.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding);const e=(0,Et.getBindingRenderingInfo)(this._canvasBinding),t=(0,a.ensureNotNull)(this._canvasBinding.canvasElement.getContext("2d"));if(t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this._size.width,this._size.height),this._drawBackground(t,e),this._drawBorder(t,e),!this._pane?.collapsed().value()){(this._pane?.dataSources()??[]).forEach((i=>{(i.widgetSideAreaViews?.(this._side)??[]).forEach((i=>i.renderer(e)?.draw(t,e)))}))}}restoreDefaultCursor(){}setSizes(e,t){this._size=(0,nt.size)({width:t.reduce(((e,t)=>e+t),0),height:e}),this._cell.style.width=this._size.width+"px",this._cell.style.minWidth=this._size.width+"px",this._cell.style.height=this._size.height+"px",this._canvasBinding.resizeCanvasElement(this._size)}getWidth(){return this._size.width}updateCurrencyLabels(){}optimalWidths(){return(this._pane?.dataSources()??[]).reduce(((e,t)=>{const i=(t.widgetSideAreaViews?.(this._side)??[]).reduce(((e,t)=>Math.max(e,t.optimalWidth())),0);return Math.max(e,i)}),0)}backgroundColor(){return(0,a.ensureNotNull)(this._pane).model().backgroundColor().value()}backgroundTopColor(){return(0,a.ensureNotNull)(this._pane).model().backgroundTopColor().value()}mouseMoveEvent(e){this._processTouchMouseEvent(e)}mouseLeaveEvent(){this._updateHoveredSource(null)}mouseEnterEvent(e){this._processTouchMouseEvent(e)}touchStartEvent(e){this._processTouchMouseEvent(e)}longTapEvent(e){this._processTouchMouseEvent(e)}touchEndEvent(){this._updateHoveredSource(null)}_processTouchMouseEvent(e){if(!this._pane)return;const t=(0,dt.point)(e.localX,e.localY);this._updateHoveredSource(this._hitTestSources(t))}_hitTestSources(e){const t=this._pane;if(!t||t.collapsed().value())return null;const i=t.dataSources();if(!i.length)return null;const s=(0,Et.getBindingRenderingInfo)(this._canvasBinding);for(const t of i){const i=t.widgetSideAreaViews?.(this._side);if(i&&i.length)for(const o of i){const i=o.renderer(s);if(!i)continue;const r=i.hitTest(e,s);if(r)return{source:t,hittest:r,renderer:i,isCustom:!1}}}return null}_updateHoveredSource(e){const t=this._pane;if(!t)return;const i=t.model(),{source:s=null,hittest:o=null}=e||{};i.setHoveredSource(s,o?.data()||null)}_drawBackground(e,t){const i=this.backgroundTopColor(),s=this.backgroundColor(),{bitmapSize:o}=t,r=this._pane?.model().panes().indexOf(this._pane)??0,n=this._pane?.model().mainPane(),a=r>(n?this._pane?.model().panes().indexOf(n)??0:0)?s:i;(0,Et.clearRect)(e,0,0,o.width,o.height,a)}_drawBorder(e,t){e.save();const i=(0,a.ensureNotNull)(this._pane).model().properties().childs().scalesProperties.childs().lineColor.value();e.fillStyle=i;const{horizontalPixelRatio:s}=t,o=Math.max(1,Math.floor(this._rendererOptionsProvider.options().borderSize*s)),r="left"===this._side?t.bitmapSize.width-o:0;e.fillRect(r,0,o,t.bitmapSize.height),e.restore()}}
var Ms=i(305025),xs=i(880847),Is=i(524143),Ls=i(382485),As=i(516590);function ks(e){return"startMoving"in e&&"move"in e&&"endMoving"in e&&"convertYCoordinateToPriceForMoving"in e}var Es=i(948954),Ds=i(316746);i(765732),i(415555);const Bs=(0,ai.getHexColorByName)("color-cold-gray-700"),Rs=(0,ai.getHexColorByName)("color-cold-gray-400"),Vs=new P.TranslatedString("scroll",h.t(null,void 0,i(614906))),Os=h.t(null,void 0,i(88276)),Ns=h.t(null,void 0,i(9874));function Ws(e,t,i){e.drawBackground&&e.drawBackground(t,i)}function Fs(e,t,i){e.draw(t,i)}function zs(e,t){return e.paneViews(t)}function Hs(e,t){return e.topPaneViews?.(t)??[]}function Us(e,t){return e.labelPaneViews(t)}function Gs(e,t){const i=e.strategyOrdersPaneView();return null===i?null:[i]}function js(e,t){return null===e||e.source!==t?null:e.hittest.data()}function qs(e,t,i,s,o){const r=e.result?.hittest.target()??0;t.target()>r&&(e.result={hittest:t,source:i,renderer:s,isCustom:o})}const $s={contextMenuEnabled:!0,contextMenu:vs.defaultChartWidgetActionsOptions,priceScaleContextMenuEnabled:!0,legendWidgetEnabled:!0,controlsEnabled:!0,propertyPagesEnabled:!0,sourceSelectionEnabled:!0,countdownEnabled:!0},Ks=new Map([[hi.AreaName.Text,"Text"],[hi.AreaName.Style,"Style"]]),Zs=!(0,d.isFeaturesetEnabled)("display_legend_on_all_charts");let Ys=null;function Xs(e,t){return!(0,hi.shouldDefaultActionBeExecuted)(e,t,"pressedMouseMoveHandler","touchMoveHandler")}class Js{constructor(e,t,i,s){this._legendWidget=null,this._paneControls=null,this._isDestroyed=!1,this._trackCrosshairOnlyAfterLongTap=(0,Zt.lastMouseOrTouchEventInfo)().isTouch,this._startTrackPoint=null,this._exitTrackingModeOnNextTry=!1,this._startMoveSourceParams=null,this._startChangeLineToolParams=null,this._preventSourceChange=!1,this._preventScrollUntilNextMouseDownOrTouchStart=!1,this._clonningAtMoveLineTools=null,this._startCloningPoint=null,this._size=(0,nt.size)({width:0,height:0}),this._themedTopColor=null,this._initCrossHairPosition=null,this._firstZoomPoint=null,this._editDialog=null,this._processing=!1,this._pressedMoveStage=0,this._touchMove=!1,this._startTouchPoint=null,this._isSelecting=!1,this._prevHoveredHittest=null,this._contextMenuX=0,this._contextMenuY=0,this._startScrollingPos=null,this._isScrolling=!1,this._scrollPriceScale=null,this._scrollXAnimation=null,this._prevPinchScale=1,this._pinching=!1,this._wasPinched=!1,this._longTap=!1,this._contextMenuOpenedOnLastTap=!1,this._paneControlsResizeObserver=null,this._lastClickedSource=null,this._customLegendWidgetsFactoryMap=new Map,this._prevMoveEventPosition=null,this._onMagnetStateChangedListener=this._onMagnetStateChanged.bind(this),this._onShiftKeyStateChangedListener=this._onShiftKeyStateChanged.bind(this),this._currentCursorClassName="",this._lastFinishedToolId=null,this._needResetMeasureLater=!1,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null,this._prevTooltipData=null,this._errorRenderer=null,this._highlightedPriceAxises=new li.WatchedObject([]),this._visuallyCollapsed=new H.WatchedValue(!1),
this._maximized=new H.WatchedValue(!1),this._endOfSeriesDataBanner=null,this._selectionBeforeMouseDown=new WeakSet,this._mouseTouchDownUpInfo=null,this._ignoringMouseMovement=!1,this._canvasConfiguredHandler=()=>this._state&&this._chartModel().lightUpdate(),this._updateVisuallyCollapsed=()=>{this._visuallyCollapsed.setValue(!this.state().maximized().value()&&this.state().collapsed().value())},this._updateMaximized=()=>{this._maximized.setValue(this.state().maximized().value())},this._chart=e,this._state=t,this._options=(0,n.merge)((0,n.clone)($s),i),this._paneWidgetsSharedState=s,this._state&&this._subscribeToState();const o={contextMenuEnabled:this._options.priceScaleContextMenuEnabled,pressedMouseMoveScale:this._options.handleScale.axisPressedMouseMove.price,mouseWheelScale:this._options.handleScale.mouseWheel,currencyConversionEnabled:this._options.currencyConversionEnabled,unitConversionEnabled:this._options.unitConversionEnabled,metricConversionEnabled:this._options.metricConversionEnabled,countdownEnabled:this._options.countdownEnabled,croppedTickMarks:this._options.croppedTickMarks};void 0!==this._options.priceScaleContextMenu&&(o.contextMenu=this._options.priceScaleContextMenu);const r=(e,t,i,s,r)=>new us(this._chart,this,this._chartUndoModel(),i,t,e,o,s,r),l=e.properties().childs().scalesProperties,c=this._chartModel().rendererOptionsProvider(),h={backgroundBasedTheme:e.backgroundBasedTheme().spawnOwnership(),stubContextMenuProvider:()=>Promise.resolve([]),titlesProvider:()=>[],rendererOptionsProvider:c,getBackgroundTopColor:()=>this._chartModel().backgroundTopColor().value(),getBackgroundBottomColor:()=>this._chartModel().backgroundColor().value(),requestRepaint:()=>this._chartModel().lightUpdate()};this._rowElement=document.createElement("div"),this._rowElement.style.display="flex";const d={showLabels:!1};this._lhsPriceAxisesContainer=t.mode()===K.PaneMode.Regular?new xi(l,"left",r,h,d):new Ps(c,"left"),this._rhsPriceAxisesContainer=t.mode()===K.PaneMode.Regular?new xi(l,"right",r,h,d):new Ps(c,"right"),this._paneCell=document.createElement("div"),this._paneCell.classList.add("chart-markup-table","pane"),this._div=document.createElement("div"),this._div.classList.add("chart-gui-wrapper"),this._div.setAttribute("data-name","pane-widget-chart-gui-wrapper"),this._paneCell.appendChild(this._div),this._canvasBinding=(0,Et.createBoundCanvas)(this._div,(0,nt.size)({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const u=this._canvasBinding.canvasElement;u.style.position="absolute",u.style.left="0",u.style.top="0",u.dataset.name="pane-canvas",this._topCanvasBinding=(0,Et.createBoundCanvas)(this._div,(0,nt.size)({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const _=this._topCanvasBinding.canvasElement;_.style.position="absolute",_.style.left="0",_.style.top="0",_.dataset.name="pane-top-canvas",this._rowElement.appendChild(this._lhsPriceAxisesContainer.getElement()),
this._rowElement.appendChild(this._paneCell),this._rowElement.appendChild(this._rhsPriceAxisesContainer.getElement()),u.setAttribute("aria-hidden","true");const p=this._chartModel().mainSeries();p.dataEvents().symbolResolved().subscribe(this,this._updateAccessibilityAttr),this._mainSeriesInterval=p.intervalObj().spawn(),this._mainSeriesInterval.subscribe(this._updateAccessibilityAttr.bind(this)),this._updateAccessibilityAttr(),this._options.legendWidgetEnabled&&(this._options.customLegendWidgetFactories&&(this._customLegendWidgetsFactoryMap=this._options.customLegendWidgetFactories),this._loadAndCreateLegendWidget()),this._state&&!this._chart.readOnly()&&this._options.controlsEnabled&&this._loadAndCreatePaneControlsWidget(this._state),(0,Ls.magnetEnabled)().subscribe(this._onMagnetStateChangedListener),(0,Dt.shiftPressed)().subscribe(this._onShiftKeyStateChangedListener),this._paneCell.addEventListener("dragover",(e=>{e.dataTransfer&&Array.from(e.dataTransfer.files).some(Cs.blobImageFilter)&&e.preventDefault()})),this._paneCell.addEventListener("drop",(e=>{if(window.user.id&&e.dataTransfer&&this._state){const t=Array.from(e.dataTransfer.files).find(Cs.blobImageFilter);if(t){e.preventDefault();const i=(0,Cs.uploadImage)(t),s=URL.createObjectURL(t),o=async()=>{await(0,pi.ensureLineToolLoaded)("LineToolImage"),this._chartUndoModel().pasteImageAsLineTool(i,s,(0,a.ensureNotNull)(this._state))};i.catch((e=>{(0,le.showChartWarningNotification)("copy",{title:Ns,text:e.message})})),o()}}})),this.setCursorForTool(),this._mouseEventHandler=new oi.MouseEventHandler(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:!this._options.handleScroll.vertTouchDrag,treatHorzTouchDragAsPageScroll:!this._options.handleScroll.horzTouchDrag,shouldAllowTouchDrag:()=>!1}),this._paneCellMouseEventHandler=new oi.MouseEventHandler(this._paneCell,{doubleTapEvent:this._paneDblClickOrTapEvent.bind(this),mouseDoubleClickEvent:this._paneDblClickOrTapEvent.bind(this)},{shouldAllowTouchDrag:()=>!1,treatVertTouchDragAsPageScroll:!this._options.handleScroll.vertTouchDrag,treatHorzTouchDragAsPageScroll:!this._options.handleScroll.horzTouchDrag}),this._prevHoveredHittest=null,this._highlightedPriceAxises.subscribe((e=>{this._highlightPriceAxisesByLabel(e.map((e=>e.axis)))})),this._prevPinchScale=0,this._isDestroyed=!1;const m=(0,F.combine)((e=>{const t=this._chart.paneWidgetSeparators(this);return[t.separatorAbove?.selected()?.weakReference()??new H.WatchedValue(!1).ownership(),t.separatorBelow?.selected()?.weakReference()??new H.WatchedValue(!1).ownership()]}),this._chart.paneWidgetsWV().weakReference());this._anySeparatorSelected=(0,F.accumulate)((e=>e.some(Boolean)),m.ownership())}destroy(){this._chart.onPaneWidgetDestroyed(this);this._chartModel().mainSeries().dataEvents().symbolResolved().unsubscribeAll(this),this._customLegendWidgetsFactoryMap.clear(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),
this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._legendWidget&&(this._legendWidget.destroy(),this._legendWidget=null),null!==this._paneControlsResizeObserver&&this._paneControlsResizeObserver.disconnect(),null!==this._paneControls&&(this._paneControls.destroy(),this._paneControls=null),this._lhsPriceAxisesContainer.destroy(),this._rhsPriceAxisesContainer.destroy(),this.hasState()&&this._unsubscribeFromState(),(0,Ls.magnetEnabled)().unsubscribe(this._onMagnetStateChangedListener),(0,Dt.shiftPressed)().unsubscribe(this._onShiftKeyStateChangedListener),this._paneWidgetsSharedState.onPaneDestroyed(this),this._errorRenderer&&this._errorRenderer.then((e=>{e.destroy(),this._errorRenderer=null})),this._prevHoveredHittest=null,this._mouseEventHandler.destroy(),this._paneCellMouseEventHandler.destroy(),this._rowElement.parentElement?.removeChild(this._rowElement),this._anySeparatorSelected.destroy(),this._mainSeriesInterval.destroy(),this._isDestroyed=!0}updateOptions(e){if((0,n.merge)(this._options,e),!1===e.legendWidgetEnabled&&this._legendWidget&&(this._legendWidget.destroy(),this._legendWidget=null),e.legendWidgetEnabled&&!this._legendWidget&&(this._options.customLegendWidgetFactories&&(this._customLegendWidgetsFactoryMap=this._options.customLegendWidgetFactories),this._loadAndCreateLegendWidget()),!this._state)return;const t=this._state.mode(),i=this._chartModel().rendererOptionsProvider();if(t===K.PaneMode.Regular&&!(this._lhsPriceAxisesContainer instanceof xi)){this._lhsPriceAxisesContainer.destroy(),this._rhsPriceAxisesContainer.destroy();const e={showLabels:!1},t={contextMenuEnabled:this._options.priceScaleContextMenuEnabled,pressedMouseMoveScale:this._options.handleScale.axisPressedMouseMove.price,mouseWheelScale:this._options.handleScale.mouseWheel,currencyConversionEnabled:this._options.currencyConversionEnabled,unitConversionEnabled:this._options.unitConversionEnabled,countdownEnabled:this._options.countdownEnabled,croppedTickMarks:this._options.croppedTickMarks},s=(e,i,s,o,r)=>new us(this._chart,this,this._chartUndoModel(),s,i,e,t,o,r),o=this._chart.properties().childs().scalesProperties,r=()=>this._chartModel().backgroundColor().value(),n=()=>this._chartModel().backgroundTopColor().value(),a={backgroundBasedTheme:this._chart.backgroundBasedTheme().spawnOwnership(),stubContextMenuProvider:()=>Promise.resolve([]),titlesProvider:()=>[],rendererOptionsProvider:i,getBackgroundTopColor:n,getBackgroundBottomColor:r,requestRepaint:()=>this._chartModel().lightUpdate()};this._lhsPriceAxisesContainer=new xi(o,"left",s,a,e),this._rhsPriceAxisesContainer=new xi(o,"right",s,a,e),this._rowElement.innerHTML="",this._rowElement.appendChild(this._lhsPriceAxisesContainer.getElement()),this._rowElement.appendChild(this._paneCell),this._rowElement.appendChild(this._rhsPriceAxisesContainer.getElement())}t!==K.PaneMode.Widget||this._lhsPriceAxisesContainer instanceof Ps||(this._lhsPriceAxisesContainer.destroy(),this._rhsPriceAxisesContainer.destroy(),
this._lhsPriceAxisesContainer=new Ps(i,"left"),this._rhsPriceAxisesContainer=new Ps(i,"right"),this._rowElement.innerHTML="",this._rowElement.appendChild(this._lhsPriceAxisesContainer.getElement()),this._rowElement.appendChild(this._paneCell),this._rowElement.appendChild(this._rhsPriceAxisesContainer.getElement()))}size(){return this._size}setSize(e){(0,nt.equalSizes)(this._size,e)||(this._size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._paneCell.style.width=e.width+"px",this._paneCell.style.height=e.height+"px",this._div.style.width=e.width+"px",this._div.style.height=e.height+"px",this._rowElement.classList.toggle("js-hidden",0===e.height),null!==this._legendWidget&&this._legendWidget.updateWidgetModeBySize(e),null!==this._paneControls&&this._paneControls.updateWidgetModeByWidth(e.width))}width(){return this._size.width}height(){return this._size.height}backgroundColor(){return this._chartModel().backgroundColor().value()}highlightedPriceAxises(){return this._highlightedPriceAxises}processDoubleClickOnSource(e,t,i){if((0,Ut.isEditableTextLineTool)(e)){const t=e.textEditingActivationTime();null!==t&&performance.now()-t<500&&e.deactivateTextEditing()}if((0,Ii.isAlertLabel)(e)){const t=e.alert(),s=t.id().value();if(t.isNew().value())return;(0,ys.getChartAlertsFacade)().then((e=>{(0,_t.trackEvent)("chart_alert","edit",`double_click_on_${i?.origin??"line"}`),e.openEditDialog(s,{actionSource:"alert_label_double_click",dataSourceHub:this._chartModel()})}))}else(0,_i.isDataSource)(e)&&e.id()!==this._lastFinishedToolId&&this._showEditDialogForSource(e,t)}stretchFactor(){return this._state?this._state.stretchFactor():0}setStretchFactor(e){this.hasState()&&this.state().setStretchFactor(e)}setCursorForTool(e,t,i){if(t&&t.mod()&&e&&e!==this._chartModel().crosshairSource())return void this._setCursorClassName("pointer");if(void 0!==i){switch(i){case Ms.PaneCursorType.VerticalResize:this._setCursorClassName("ns-resize");break;case Ms.PaneCursorType.HorizontalResize:this._setCursorClassName("ew-resize");break;case Ms.PaneCursorType.DiagonalNeSwResize:this._setCursorClassName("nesw-resize");break;case Ms.PaneCursorType.DiagonalNwSeResize:this._setCursorClassName("nwse-resize");break;case Ms.PaneCursorType.Default:this._setCursorClassName("default");break;case Ms.PaneCursorType.Pointer:this._setCursorClassName("pointer");break;case Ms.PaneCursorType.Grabbing:this._setCursorClassName("grabbing");break;case Ms.PaneCursorType.Text:this._setCursorClassName("text");break;case Ms.PaneCursorType.None:this._setCursorClassName("none")}return}const s=D.tool.value();if((0,D.toolIsCursor)(s)){if(null!==this._paneWidgetsSharedState.draggingSource()||this._isScrolling||this._chartUndoModel()&&this._chartUndoModel().model().sourcesBeingMoved().length)return void this._setCursorClassName("grabbing");if(e&&this._options.sourceSelectionEnabled)return void this._setCursorClassName("pointer")}let o="";switch(s){case"eraser":o="eraser";break;case"zoom":o="zoom-in"}if(!o)switch(D.cursorTool.value()){
case"arrow":o="default";break;case"dot":o="dot";break;case"demonstration":o="demonstration";break;case"performance":o="performance"}this._setCursorClassName(o)}showContextMenuForSelection(e,t,i){const s=this._chartUndoModel().selection();if(s.isEmpty())return;const o=s.dataSources().filter((e=>e.hasContextMenu()));this.showContextMenuForSources(o,e,void 0,t,i)}async showContextMenuForSources(e,t,i,s,o){if(!e.length||!this._state)return Promise.resolve(null);const{ActionsProvider:r}=await(0,Wi.actionsProviderModule)();if(this._isDestroyed)return null;const a=e[0],l=(0,n.merge)((0,n.clone)(this._options.contextMenu),i||{}),c=new r(this._chart,l);if(a===this._chartUndoModel().crosshairSource())return a.handleContextMenuEvent(t),Promise.resolve(null);{const i=await c.contextMenuActionsForSources(e,this._state,t,s?.origin,o?.data()?.customActions);if(0===i.length)return Promise.resolve(null);{let e={menuName:""};return a instanceof Es.Series?e={menuName:s?.origin??"ObjectTreeContextMenu",detail:{type:"series",id:a.instanceId()}}:(0,Ut.isLineTool)(a)?e={menuName:s?.origin??"ObjectTreeContextMenu",detail:{type:"shape",id:a?.id()??null}}:(0,Nt.isStudy)(a)&&(e={menuName:s?.origin??"ObjectTreeContextMenu",detail:{type:"study",id:a?.id()||null}}),fi.ContextMenuManager.createMenu(i,{takeFocus:!0,returnFocus:!0,isKeyboardEvent:l.isKeyboardEvent,statName:a.contextMenuStatName()},e,s?.onClose).then((e=>(e.show(t),e)))}}}leftPriceAxisesContainer(){return this._lhsPriceAxisesContainer}rightPriceAxisesContainer(){return this._rhsPriceAxisesContainer}setPriceAxisSizes(e,t,i){this._priceAxisesContainer(e).setSizes(t,i)}state(){return(0,a.ensureNotNull)(this._state)}hasState(){return null!==this._state}setState(e){this._state!==e&&(this.hasState()&&(this._unsubscribeFromState(),this._paneControls?.destroy(),this._paneControls=null),this._state=e,this.hasState()&&(this.updateOptions(this._options),this._subscribeToState(),this._loadAndCreatePaneControlsWidget(this.state()),this.updatePriceAxisWidgetsStates(),this._updateAccessibilityAttr()))}getScreenshotData(e){const t=[],i=[];let s,o=[];const r=this.state(),n=r.mode()===K.PaneMode.Widget?[]:r.sourcesByGroup().priceSources().slice().reverse(),a=this._chart.properties().childs().paneProperties.childs().legendProperties.childs();for(const l of n){const n=l.statusView();if((0,Nt.isStudy)(l)&&(a.showLegend.value()||e?.showCollapsedStudies)){const s=a.showStudyTitles.value(),o=!0;if(l.properties().childs().visible.value()&&this._chartModel().paneForSource(l)===r&&n&&o){t.push(s?l.statusProvider(e?.status).text():"");const o=(0,d.isFeaturesetEnabled)("use_last_visible_bar_value_in_legend")?this._chartModel().timeScale().visibleBarsStrictRange()?.lastBar()??null:null,r=l.legendValuesProvider().getValues(o);i.push(r)}}else if(l===this._chartModel().mainSeries()&&n&&a.showSeriesTitle.value()){const t=l.statusProvider(e?.status||{}).getSplitTitle();s=Object.values(t).filter((e=>""!==e)).join("  ");const i=(0,
d.isFeaturesetEnabled)("use_last_visible_bar_value_in_legend")?this._chartModel().timeScale().visibleBarsStrictRange()?.lastBar()??null:null;o=l.legendValuesProvider().getValues(i)}}return{type:"pane",leftAxis:this._lhsPriceAxisesContainer.getScreenshotData(),rightAxis:this._rhsPriceAxisesContainer.getScreenshotData(),content:this._canvasBinding.canvasElement.toDataURL(),canvas:this._canvasBinding.canvasElement,contentWidth:this._size.width,contentHeight:this._size.height,studies:t,studiesValues:i,containsMainSeries:this.containsMainSeries(),mainSeriesText:s,mainSeriesValues:o}}updatePriceAxisWidgetsStates(){if(!this.hasState())return;const e=this._chartModel(),t=e.paneForSource(e.mainSeries());if(t)if(this._state?.mode()===K.PaneMode.Regular){const i=e.priceScaleSlotsCount(),s=this.state(),o=s.visibleLeftPriceScales(),r=s.visibleRightPriceScales();this._lhsPriceAxisesContainer.setScales(o,i.left,t.leftPriceScales().length,i.left+i.right),this._rhsPriceAxisesContainer.setScales(r,i.right,t.rightPriceScales().length,i.left+i.right)}else this._state?.mode()===K.PaneMode.Widget&&(this._lhsPriceAxisesContainer.setPane(this._state),this._rhsPriceAxisesContainer.setPane(this._state))}updatePriceAxisWidgets(){this._lhsPriceAxisesContainer.update(),this._rhsPriceAxisesContainer.update()}update(){this.hasState()&&(this.updatePriceAxisWidgets(),null!==this._legendWidget&&this._legendWidget.update(),this.updateControls())}updateStatusWidget(e){this.hasState()&&null!==this._legendWidget&&(e.legendWidgetLayoutInvalidated()?this._legendWidget.updateLayout():this._legendWidget.update())}updateControls(){this.hasState()&&null!==this._paneControls&&this._paneControls.update()}updateThemedColors(e){this._themedTopColor=e.topColor,this._updateByThemedColors()}statusWidget(){return this._legendWidget}getElement(){return this._rowElement}canvasElement(){return this._canvasBinding.canvasElement}getRenderingInfo(){return(0,Et.getBindingRenderingInfo)(this._canvasBinding)}hasCanvas(e){return this._canvasBinding.canvasElement===e||this._topCanvasBinding.canvasElement===e}pinchStartEvent(){return null===this._paneWidgetsSharedState.scrollingPane()&&null===this._paneWidgetsSharedState.pinchingPane()&&(this._onTouchEvent(),!!this._options.handleScale.pinch&&(this._chartModel().stopTimeScaleAnimation(),this._prevPinchScale=1,this._pinching=!0,this._wasPinched=!0,this._paneWidgetsSharedState.setPinchingPane(this),!0))}pinchEvent(e,t,i,s){if(null!==this._paneWidgetsSharedState.scrollingPane()||this._paneWidgetsSharedState.pinchingPane()!==this)return;if(this._onTouchEvent(),!this._options.handleScale.pinch)return;const o=10*(s-this._prevPinchScale);this._prevPinchScale=s,this._chartModel().zoomTime(e.x,o,!0),this._prevPinchScale=s}pinchEndEvent(){null===this._paneWidgetsSharedState.scrollingPane()&&this._paneWidgetsSharedState.pinchingPane()===this&&(this._onTouchEvent(),this._pinching=!1,this._paneWidgetsSharedState.setPinchingPane(null))}mouseClickEvent(e){this._onMouseEvent(),this._mouseClickOrTapEvent(e)}tapEvent(e){
this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseClickOrTapEvent(e))}mouseDownEvent(e){this._onMouseEvent(),this.hasState()&&this._mouseDownOrTouchStartEvent(e,this._dataSourceAtPoint(e.localX,e.localY))}touchStartEvent(e){if(this._paneWidgetsSharedState.startTouch(this),this._preventTouchEventsExceptPinch())return;const t=!this._trackCrosshairOnlyAfterLongTap&&null!==Ys&&Ys.stateId===this.state().id()&&Math.abs(Ys.x-e.localX)+Math.abs(Ys.y-e.localY)<5;this._onTouchEvent(),this._chart.setActivePaneWidget(this);const i=this._dataSourceAtPoint(e.localX,e.localY);if(t){const t=this._chartModel().crosshairSource();null!==i&&i.source===t||t.selectPointMode().value()!==D.SelectPointMode.None?this.startTrackingMode(new dt.Point(e.localX,e.localY),new dt.Point(e.localX,e.localY)):!this._chart.readOnly()&&null!==i&&((0,Ut.isLineTool)(i.source)&&i.source.userEditEnabled()||(0,Ii.isAlertLabel)(i.source))&&this._chartUndoModel().selectionMacro((t=>{const s={type:"change",newSelectedSource:i.source,interactionType:e.isTouch?"touch":"pointer"};t.selectionOperationAvailable(s)&&(t.clearSelection(),t.addSourceToSelection(i.source,i.hittest.data()))}))}this._mouseDownOrTouchStartEvent(e,i),this._mouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._onMouseEvent(),this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._paneWidgetsSharedState.endTouch(this),this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseOrTouchLeaveEvent(e),this._mouseUpOrTouchEndEvent(e))}mouseMoveEvent(e){this._onMouseEvent(),this._mouseOrTouchMoveEvent(e)}pressedMouseMoveEvent(e){this._onMouseEvent(),this._chart.chartFloatingTooltipVisible()?null!==this._chart.activePaneWidget().value()&&this._mouseOrTouchMoveEvent(e):this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._pressedMouseOrTouchMoveEvent(e))}mouseLeaveEvent(e){this._onMouseEvent(),this._updateHoveredSource(null,new ui.EnvironmentState(e)),this._mouseOrTouchLeaveEvent(e)}mouseDoubleClickEvent(e){this._onMouseEvent(),this._mouseDoubleClickOrDoubleTapEvent(e)}wheelClickEvent(e){if(this._chart.readOnly())return;const t=this._dataSourceAtPoint(e.localX,e.localY);if(null===t||t.isCustom)return;if((t.hittest.target()||0)<=hi.HitTarget.MovePointBackground)return;const i=new ui.EnvironmentState(e),s=t.hittest.eraseMarker();if(i.mod()&&void 0!==s&&t.source.processErase)return void t.source.processErase(this._chartUndoModel(),s);const o=this._chartUndoModel();o.selection().isSelected(t.source)||o.selectionMacro((e=>{e.clearSelection();const i=(0,a.ensureNotNull)(t.source);e.addSourceToSelection(i,js(t,i))})),this._chart.removeSelectedSources()}doubleTapEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._mouseDoubleClickOrDoubleTapEvent(e))}longTapEvent(e){if(null===this._state||this._preventTouchEventsExceptPinch())return;if(this._onTouchEvent(),this._longTap=!0,null!==this._startTrackPoint||!this._trackingModeShouldBeActive())return;const t=this._chartModel().selection()
;if(!t.isEmpty()){const i=this._dataSourceAtPoint(e.localX,e.localY);if(null!==i&&t.isSelected(i.source))return}this.startTrackingMode(new dt.Point(e.localX,e.localY),new dt.Point(e.localX,e.localY),new ui.EnvironmentState(e))}mouseEnterEvent(e){if(this._onMouseEvent(),!this.hasState())return;this._chart.setActivePaneWidget(this);const t=this._dataSourceAtPoint(e.localX,e.localY);this._updateHoveredSource(t,new ui.EnvironmentState(e)),this.setCursorPosition(e.localX,e.localY,new ui.EnvironmentState(e))}contextMenuEvent(e){this._onMouseEvent(),this._contextMenuEvent(e)}touchContextMenuEvent(e){this._preventTouchEventsExceptPinch()||(this._onTouchEvent(),this._contextMenuEvent(e))}mouseDownOutsideEvent(e){this._processOutsideClick(null,e)}touchStartOutsideEvent(e){this._processOutsideClick(null,e)}cancelZoom(){this._chartModel().crosshairSource().clearSelection(),this._firstZoomPoint=null,this._preventCrossHairMove()&&this._clearCursorPosition()}startTrackingMode(e,t,i){this.state().mode()!==K.PaneMode.Widget&&(this._startChangeLineToolParams=null,this._startMoveSourceParams=null,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null,this._chartUndoModel().selectionMacro((e=>e.clearSelection())),this._startTrackPoint=e,this._exitTrackingModeOnNextTry=!1,this.setCursorPosition(t.x,t.y,i),this._initCrossHairPosition=this._chartModel().crosshairSource().currentPoint())}setDragToAnotherPaneCursor(){this._setCursorClassName("grabbing")}cloneLineTools(e,t){return this._chartUndoModel().cloneLineTools(e,t)}exitTrackingMode(){null!==this._state&&null!==this._startTrackPoint&&(this._exitTrackingModeOnNextTry=!0,this._tryExitTrackingMode())}trackingModeEnabled(){return null!==this._state&&null!==this._startTrackPoint}addCustomWidgetToLegend(e,t){this._options.legendWidgetEnabled&&(this._customLegendWidgetsFactoryMap.set(e,t),null!==this._legendWidget&&this._legendWidget.addCustomWidgetToLegend(e,t))}containsMainSeries(){return!!this.hasState()&&this.state().containsMainSeries()}paint(e,t){if(!this._chartUndoModel()||!this.hasState()||0===this._size.width||0===this._size.height)return;(0,Et.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,Et.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding),this._state&&(e.priceScaleSideMaxLevel("left")>ve.InvalidationLevel.Cursor||e.priceScaleSideMaxLevel("right")>ve.InvalidationLevel.Cursor)&&(this._recalculatePriceScales((0,Ds.viewportChangeEvent)(this.state())),null!==Ys&&Ys.stateId===this.state().id()&&this.setCursorPosition(Ys.x,Ys.y,Ys.envState));const i=e.fullInvalidation();if(i>ve.InvalidationLevel.Cursor&&null!==Ys&&Ys.stateId===this.state().id()){const e=this._dataSourceAtPoint(Ys.x,Ys.y);this._updateHoveredSource(e,(0,Dt.globalEnvironmentState)())}if(this._lhsPriceAxisesContainer.paint(e.getterForPriceScaleInvalidationLevelBySide("left"),t),this._rhsPriceAxisesContainer.paint(e.getterForPriceScaleInvalidationLevelBySide("right"),t),i===ve.InvalidationLevel.None)return
;const s=this._state&&(this._state.maximized().value()||!this._state.collapsed().value()||this._state.mode()===K.PaneMode.Widget);if(i>ve.InvalidationLevel.Cursor){const e=(0,a.ensureNotNull)(this._canvasBinding.canvasElement.getContext("2d"));e.setTransform(1,0,0,1,0,0);const t=(0,Et.getBindingRenderingInfo)(this._canvasBinding);this._makeSureIsUpdated(t),this._drawBackground(e,t),s&&this._drawSources(e,t)}if(null!==this._state){const e=(0,a.ensureNotNull)(this._topCanvasBinding.canvasElement.getContext("2d"));e.setTransform(1,0,0,1,0,0);const t=(0,Et.getBindingRenderingInfo)(this._topCanvasBinding);e.clearRect(0,0,t.bitmapSize.width,t.bitmapSize.height),s&&this._drawTopViews(e,t),this._drawCrossHair(e,t),s&&this._drawActiveLineTools(e,t)}this._updateEndOfSeriesBanner()}cancelCreatingLineTool(){const e=this._chartUndoModel(),t=this._chartUndoModel().lineBeingCreated();if(t)if(t.pointsCount()<=0&&!(0,se.isLineDrawnWithPressedButton)(t.toolname)){const i=t.points();if(i.length>2){const s=i[i.length-2];e.continueCreatingLine(s),this._finishTool(t)}else e.cancelCreatingLine()}else e.cancelCreatingLine();null!==this._firstZoomPoint&&this.cancelZoom(),this._clearCursorPosition(),this.setCursorForTool()}async drawRightThere(e,t){this.hasState()&&(await(0,pi.ensureLineToolLoaded)(e),this._chartUndoModel().drawRightThere(e,this.state(),void 0,t))}cancelMeasuring(){this._chartUndoModel().crosshairSource().clearMeasure(),(0,D.resetToCursor)(),this.setCursorForTool()}async setErrorMessage(e){if(e||this._errorRenderer){if(!this._errorRenderer){this._errorRenderer=this._createErrorBlock();const e=await this._errorRenderer;if(this._isDestroyed)return;this._div.insertBefore(e.container,this._topCanvasBinding.canvasElement.nextSibling)}(await this._errorRenderer).update({message:e?.message,icon:this._state?.containsMainSeries()||this._state?.maximized().value()?e?.icon:void 0,backgroundColor:`linear-gradient(${this._chartModel().backgroundTopColor().value()}, ${this._chartModel().backgroundColor().value()})`,textColor:this._chartModel().dark().value()?Rs:Bs,solutionId:e?.solutionId,rawHtml:e?.rawHtml,buttons:this.containsMainSeries()?e?.buttons:void 0,maxWidth:e?.maxWidth,maxHeight:e?.maxHeight,zeroHeight:e?.zeroHeight})}}collapsedHeight(){return Math.max(Math.ceil(this._paneControls?.bottomWithMargin()??0),33)}visuallyCollapsed(){return this._visuallyCollapsed.readonly()}maximized(){return this._maximized.readonly()}setCursorPosition(e,t,i){this._updateLastCrosshairPosition(e,t,i),this._chartModel().setAndSaveCurrentPosition(this._correctXCoord(e),this._correctYCoord(t),this.state(),i)}dataSourceAtPoint(e,t){return this._dataSourceAtPoint(e,t)?.source??null}_tryExitTrackingMode(e){this._exitTrackingModeOnNextTry&&(this._startTrackPoint=null,e||this._clearCursorPosition())}_tryStartMeasure(e,t,i,s,o){return!(!(0,D.toolIsMeasure)(D.tool.value())||t.startMeasurePoint())&&(e.isTouch||this._preventCrossHairMove()||this.setCursorPosition(e.localX,e.localY,i),s=this._chartModel().magnet().align(s,o,this.state()),t.startMeasuring({price:s,
index:o},this.state()),!0)}_tryFinishMeasure(e,t){if(t.startMeasurePoint()&&!t.endMeasurePoint()){let i=t.price;const s=t.index;return i=this._chartModel().magnet().align(i,s,this.state()),t.finishMeasure({price:i,index:s}),e.isTouch?(0,D.resetToCursor)():this._needResetMeasureLater=!0,this._preventCrossHairMove()&&this._clearCursorPosition(),!0}return!1}_tryStartZoom(e,t,i,s){const o=this._chart.model().model().zoomEnabled();if("zoom"===D.tool.value()&&o){const o=this._chartUndoModel(),r=o.timeScale().indexToCoordinate(i)-.5*o.timeScale().barSpacing();return this._firstZoomPoint={price:t,index:i,x:r,y:e.localY},this._preventCrossHairMove()||this.setCursorPosition(e.localX,e.localY,s),this._chartModel().crosshairSource().startSelection(this.state()),!0}return!1}_finishZoom(e){const t=this.state(),i=t.defaultPriceScale(),s=(0,a.ensureNotNull)(t.mainDataSource()).firstValue(),o=i.coordinateToPrice(e.localY,(0,a.ensureNotNull)(s)),r=this._chartUndoModel(),n=Math.round(r.timeScale().coordinateToIndex(e.localX)),l=(0,a.ensureNotNull)(this._firstZoomPoint);n!==l.index&&r.zoomToViewport(l.index,n,l.price,o,t),this._chartModel().crosshairSource().clearSelection(),this._firstZoomPoint=null,(0,D.resetToCursor)(),this._preventCrossHairMove()&&this._clearCursorPosition()}_tryFinishZoom(e){return null!==this._firstZoomPoint&&(this._finishZoom(e),!0)}_tryHandleEraserMouseDown(e,t){if((0,D.toolIsEraser)(D.tool.value())&&!e.isCustom&&(!(i=e.source)||!i.customization||!i.customization.disableErasing)){const i=this._chartUndoModel();if((0,Ut.isLineTool)(e.source)||(0,Nt.isStudy)(e.source)){const s=e.hittest.eraseMarker();return t.mod()&&void 0!==s&&e.source.processErase?e.source.processErase(i,s):i.removeSource(e.source,!1),!0}}var i;return!1}_tryStartChangingLineTool(e,t,i,s){if(e.isTouch&&null!==this._startTrackPoint)return!1;const o=t.hittest;if((!e.isTouch||!this._preventSourceChange)&&o&&(0,Ut.isLineTool)(t.source)&&o.target()===hi.HitTarget.ChangePoint){const r=this._chartUndoModel(),n=(0,a.ensure)(this.state().mainDataSource()?.firstValue()),l=o.data()?.ownerSourceId,c=(0,a.ensureNotNull)(l?this._chartModel().dataSourceForId(l):t.source.ownerSource()),h=(0,a.ensureNotNull)(c.priceScale()).coordinateToPrice(e.localY,n);r.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(t.source,o.data())}));let d=h;t.source.priceScale()===r.mainSeries().priceScale()&&(d=r.model().magnet().align(h,s,this.state()));const u=o.data()?.nonDiscreteIndex;u&&(s=r.timeScale().coordinateToFloatIndex(e.localX));const _=o.data()?.pointIndex;return this._startChangeLineToolParams={source:t.source,ownerSource:c,startPoint:{index:s,price:d,nonDiscreteIndex:u},screenPoint:{x:e.localX,y:e.localY},pointIndex:_,envState:i},!0}return this._startChangeLineToolParams=null,!1}_tryStartCloning(e,t,i,s){if(i.mod()){const t=this._chartUndoModel().selection().dataSources().filter((e=>e.cloneable()));if(s&&s.cloneable()&&t.push(s),t.length>0)return this._clonningAtMoveLineTools=t.map((e=>e.id())),this._startCloningPoint=new dt.Point(e.localX,e.localY),!0}
return!1}_tryFinishClonning(e,t,i){const s=this._chartUndoModel(),o=this._chartModel();if(t.mod()&&this._clonningAtMoveLineTools){const r=new dt.Point(e.localX,e.localY),n=(0,a.ensureNotNull)(this._startCloningPoint).subtract(r).length(),l=[];for(const e of this._clonningAtMoveLineTools){const t=o.dataSourceForId(e);null!==t&&l.push(t)}if(0===l.length)return!1;if(n>8){const o=this.cloneLineTools(l,!0).map((e=>(0,a.ensureNotNull)(s.model().dataSourceForId(e))));s.selectionMacro((e=>{e.clearSelection();let t=null;o.forEach((s=>{null===t&&(t=js(i,s)),e.addSourceToSelection(s,t)}))}));const r=new dt.Point(e.localX,e.localY),n=(0,a.ensureNotNull)(o[0].priceScale()),c=(0,a.ensureNotNull)(this.state().mainDataSource()).firstValue(),h={index:s.timeScale().coordinateToIndex(e.localX),price:n.coordinateToPrice(e.localY,(0,a.ensureNotNull)(c))};s.startMovingSources(o,{logical:h,screen:r},null,t),this._clonningAtMoveLineTools=null,this._startCloningPoint=null}return!0}return!1}_mouseDownEventForLineTool(e,t,i,s){const o=D.tool.value();if(!this.hasState()||(0,se.isLineToolDrawWithoutPoints)(o)||this.state().mode()===K.PaneMode.Widget)return;const r=this._chartUndoModel();let n=!1,l=null;(0,D.hideAllDrawings)().value()&&(0,ft.toggleHideOptions)(!1),(0,D.lockDrawings)().setValue(!1),e.isTouch&&!e.stylus&&((0,se.isLineToolName)(o)&&!(0,se.isLineDrawnWithPressedButton)(o)||r.lineBeingCreated())&&this._initToolCreationModeParams(e);const c=r.lineBeingCreated();if(c&&!(0,se.isLineDrawnWithPressedButton)(c.toolname)){const o=(0,a.ensure)(c.ownerSource()?.firstValue());if(e.isTouch&&!e.stylus){if(!this._startTouchPoint){this._startTouchPoint=new dt.Point(e.pageX,e.pageY);const t=c.points(),i=t[t.length-1],s=r.timeScale().indexToCoordinate(i.index),n=(0,a.ensureNotNull)(c.priceScale()).priceToCoordinate(i.price,o);return void(this._initCrossHairPosition=new dt.Point(s,n))}}else if(!e.isTouch){l=c;const h=r.model().paneBeingCreatedLineOn();if(h!==this._state&&null!==h){const i=this._externalPaneXCoord(h,e.localX),s=this._externalPaneYCoord(h,e.localY);n=r.continueCreatingLine({index:Math.round(r.timeScale().coordinateToIndex(i)),price:(0,a.ensure)(c.priceScale()?.coordinateToPrice(s,o))},t)}else{const e=r.model().magnet().align(s,i,this.state());n=r.continueCreatingLine({index:i,price:e},t)}}}else{const t=(0,se.isLineDrawnWithPressedButton)(o);if(!e.isTouch||e.stylus||t){const e=null===c||(0,Ut.isBrushBasedLineTool)(c)&&c.hasOnlyOnePoint(),a={index:i,price:t&&!e?s:r.model().magnet().align(s,i,this.state())};l=r.createLineTool({pane:this.state(),point:a,linetool:o,actionSource:"Draw"}),this._mouseTouchDownUpInfo&&(this._mouseTouchDownUpInfo.toolCreation=!0),r.lineBeingCreated()||(n=!0)}}const h=this._dataSourceAtPoint(e.localX,e.localY);l&&r.selectionMacro((e=>{e.addSourceToSelection((0,a.ensureNotNull)(l),h?.hittest.data())})),n&&l&&(this._finishTool(l,h),e.preventDefault())}_handleSelectionMouseDownAndGetJustDeselectedSource(e,t,i){const s=this._chartUndoModel();let o=null
;return(null===t||t.source.isSelectionEnabled())&&s.selectionMacro((s=>{if(!this._preventSourceChange&&null!==t&&(e.isTouch?t.hittest.target()>=hi.HitTarget.MovePointBackground:t.hittest.target()>hi.HitTarget.MovePointBackground))i.mod()||s.selection().isSelected(t.source)||s.clearSelection(),i.mod()&&s.selection().isSelected(t.source)?(o=t.source,s.removeSourceFromSelection(t.source)):s.addSourceToSelection(t.source,t.hittest.data()),s.selection().allSources().length>1&&(0,_t.trackEvent)("GUI","Multiselect","Click Select");else if(!i.mod()){const t={type:"clear",interactionType:e.isTouch?"touch":"pointer"};s.selectionOperationAvailable(t)&&s.clearSelection(),this._clonningAtMoveLineTools=null,this._startCloningPoint=null}})),o}_processMouseMoveWhileZoom(e,t){this._preventCrossHairMove()||this.setCursorPosition(e.localX,e.localY,t)}_updateCommonTooltip(e,t){let i=null;if(null!==e&&null!==e.hittest){const t=e.hittest.data();t&&(i=t.tooltip||null)}if(null===this._prevTooltipData&&null===i)return;if(null===i||""===i.text)return this._prevTooltipData=null,void(0,xs.hide)(t);if(this._prevTooltipData&&(0,r.default)(i,this._prevTooltipData))return;this._prevTooltipData=i;const s=(0,n.clone)(i);if(void 0!==s.rect){const e=this._paneCell.getBoundingClientRect();s.rect.x+=e.left,s.rect.y+=e.top}(0,xs.show)(s)}_setCursorPositionOnExternalPane(e,t,i,s){t=this._externalPaneXCoord(e,t),i=this._externalPaneYCoord(e,i);this._chart.paneByState(e).setCursorPosition(t,i,s)}_updateLastCrosshairPosition(e,t,i){const s=this.state().id();Ys={x:e,y:t,envState:i,stateId:s}}_setCursorClassName(e){let t="";e&&(t="pane--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._paneCell.classList.remove(this._currentCursorClassName),t&&this._paneCell.classList.add(t),this._currentCursorClassName=t,this._paneCell.style.cursor)}_processMouseUpOrTouchEndHandler(e){const t=this._dataSourceAtPoint(e.localX,e.localY);if(null!==t){const i=this._sourceWasSelected(t);t.hittest.tryCallMouseUpOrTouchEndHandler(e,{sourceWasSelected:i})}}_crossHairShouldBeVisible(){const e=this._chartModel().crosshairSource();return(0,se.isLineToolName)(D.tool.value())||(0,D.toolIsMeasure)(D.tool.value())||e.startMeasurePoint()&&!e.endMeasurePoint()||null!==this._firstZoomPoint||null!==this._chartModel().lineBeingEdited()||null!==this._chartModel().lineBeingCreated()}_clearCursorPosition(){Ys=null,this._chartModel().clearCurrentPosition()}_dataSourceAtPoint(e,t){if(!this.hasState())return null;const i={result:null},s=this._chartUndoModel();if((0,se.isLineToolName)(D.tool.value())||null!==s.lineBeingCreated())return i.result;if(this._currentChangingLineToolHitTest)return this._currentChangingLineToolHitTest;const o=new Set;if(this._currentMovingHitTest&&this._currentMovingHitTest.sourceAtPoint.hittest.data()){if(!this._currentMovingHitTest.cancelledContainer?.cancelled)return this._currentMovingHitTest.sourceAtPoint;o.add(this._currentMovingHitTest.sourceAtPoint.source.id())}
if(this._currentMovingHitTest&&this._currentMovingHitTest.sourceAtPoint.hittest.data()&&!this._currentMovingHitTest.cancelledContainer?.cancelled)return this._currentMovingHitTest.sourceAtPoint;const r=this.state(),n=(0,Et.getBindingRenderingInfo)(this._canvasBinding);this._makeSureIsUpdated(n);const a=qs.bind(null,i),l=new dt.Point(e,t);if(!r.maximized().value()&&r.collapsed().value()||(0,Zt.lastMouseOrTouchEventInfo)().isTouch&&(D.activePointSelectionMode.value()!==D.SelectPointMode.None||null!==this._startTrackPoint))return this._hitTestSources(n,[s.crosshairSource()],l,a,!1,o),i.result;const c=r.sourcesByGroup(),h=s.selection(),d=h.dataSources().filter((e=>e.isMultiPaneEnabled()||s.paneForSource(e)===r));this._hitTestSources(n,d,l,a,!1,o),this._hitTestSources(n,h.customSources(),l,a,!0,o),h.allSources().forEach((e=>o.add(e.id()))),this._hitTestSources(n,[s.crosshairSource()],l,a,!1,o),this._hitTestSources(n,r.customSources(di.CustomSourceLayer.Topmost),l,a,!0,o),this._hitTestSources(n,c.tradingSources(),l,a,!1,o),this._hitTestSources(n,r.customSources(di.CustomSourceLayer.Foreground),l,a,!0,o);const u=c.hitTestSources();if(this._hitTestSources(n,u,l,a,!1,o),this.containsMainSeries()){const e=s.activeStrategySource().value();if(null!==e&&!o.has(e.id())){const t=e.strategyOrdersPaneView();if(null!==t){const s=t.renderer(n);if(null!==s){const t=s.hitTest(l,n);t&&qs(i,t,e,s,!1)}}}}return null===i.result&&this._hitTestSources(n,r.customSources(di.CustomSourceLayer.Background),l,a,!0,o),i.result}_sourceWasSelected(e){return!!e&&this._selectionBeforeMouseDown.has(e.source)}_hitTestSources(e,t,i,s,o,r){const n=(0,a.ensureNotNull)(this._state);for(let a=t.length-1;a>=0;--a){const l=t[a];if(r.has(l.id()))continue;const c=l.paneViews(n);if(null!==c&&0!==c.length)for(let t=c.length-1;t>=0;--t){const r=c[t].renderer(e);if(r&&r.hitTest){const t=r.hitTest(i,e);null!==t&&s(t,l,r,o)}}}}_tryStartMovingLineTool(e,t,i,s){if(null===t.source||!t.source.movable()||null!==this._startTrackPoint)return!1;if(!this._preventSourceChange){const o=this._chartUndoModel(),r=(0,a.ensureNotNull)((0,a.ensureNotNull)(this._state).mainDataSource()).firstValue(),n=(0,a.ensureNotNull)(t.source.priceScale()),l=null===r?NaN:n.coordinateToPrice(e.localY,r);let c=(t.source.isSelectionEnabled()?o.selection().allSources():[t.source]).filter(ks);const h=c.filter((e=>(0,Ut.isLineTool)(e)&&!e.isSourceHidden()));c=h.length>0?h:c.includes(t.source)?[t.source]:[c[0]];const d=new dt.Point(e.localX,e.localY),u={index:s,price:l},_=t.hittest.data()?.activeItem;return this._startMoveSourceParams={source:c,startPoint:{logical:u,screen:d},activeItem:void 0===_?null:_,envState:i},!0}return this._startMoveSourceParams=null,!1}_chartModel(){return this._chart.model().model()}_chartUndoModel(){return this._chart.model()}_externalPaneXCoord(e,t){t+=this._div.getBoundingClientRect().left+document.body.scrollLeft;const i=(0,a.ensureNotNull)(this._chart.paneByState(e)),s=i._div.getBoundingClientRect().left+document.body.scrollLeft;return i._correctXCoord(t-s)}
_externalPaneYCoord(e,t){t+=this._div.getBoundingClientRect().top+document.body.scrollTop;const i=(0,a.ensureNotNull)(this._chart.paneByState(e)),s=i._div.getBoundingClientRect().top+document.body.scrollTop;return i._correctYCoord(t-s)}_correctXCoord(e){return Math.max(0,Math.min(e,this._size.width-1))}_correctYCoord(e){return Math.max(0,Math.min(e,this._size.height-1))}_processScroll(e){if(!this._chart.model().model().scrollEnabled())return;const t=performance.now();this._startScrollingPos||this._preventScroll()||(this._startScrollingPos={x:e.clientX,y:e.clientY,timestamp:t,localX:e.localX,localY:e.localY});const i=this._chartUndoModel();let s=this.state().defaultPriceScale();if(this._startScrollingPos&&!this._isScrolling&&(this._startScrollingPos.x!==e.clientX||this._startScrollingPos.y!==e.clientY))return i.beginUndoMacro(Vs),null===this._scrollXAnimation&&this._options.useKineticScroll&&(this._scrollXAnimation=new _s.KineticAnimation(.2,7,.997,15),this._scrollXAnimation.addPosition(e.clientX,this._startScrollingPos.timestamp)),i.selection().isEmpty()||(s=i.selection().allSources()[0].priceScale()),null===s||s.isEmpty()||(this._scrollPriceScale=s,i.startScrollPrice(this.state(),s,e.localY)),i.startScrollTime(e.localX),this._isScrolling=!0,this.setCursorForTool(),void this._paneWidgetsSharedState.setScrollingPane(this);this._isScrolling&&(null!==this._scrollPriceScale&&i.scrollPriceTo(this.state(),this._scrollPriceScale,e.localY),i.scrollTimeTo(e.localX),null!==this._scrollXAnimation&&this._scrollXAnimation.addPosition(e.clientX,t))}_finishScroll(){const e=this._chartUndoModel();e.endScrollTime(),null!==this._scrollPriceScale&&e.endScrollPrice(this.state(),this._scrollPriceScale),e.endUndoMacro(),this._isScrolling=!1,this._startScrollingPos=null,this._scrollPriceScale=null,this.setCursorForTool(),this._paneWidgetsSharedState.setScrollingPane(null)}_endScroll(e){if(!this._isScrolling)return!1;this._finishScroll();const t=this._scrollUndoCommandInStack(),i=performance.now();return null!==this._scrollXAnimation&&(this._scrollXAnimation.start(e.clientX,i),this._scrollXAnimation.finished(i)||(this._chartModel().stopTimeScaleAnimation(),this._chartModel().setTimeScaleAnimation(this._scrollXAnimation),this._scrollXAnimation=null)),t}_preventScroll(){return this._trackCrosshairOnlyAfterLongTap&&this._longTap||this._contextMenuOpenedOnLastTap||(0,se.isLineToolName)(D.tool.value())||Boolean(this._chartUndoModel().lineBeingCreated())||null!==this._startTrackPoint||this._preventScrollUntilNextMouseDownOrTouchStart}_isSelectPointModeEnabled(){return this._chartUndoModel().crosshairSource().selectPointMode().value()!==D.SelectPointMode.None}_preventCrossHairMove(){return!!this._trackCrosshairOnlyAfterLongTap&&(null===this._chart.trackingModePaneWidget()&&(!!this._contextMenuOpenedOnLastTap||!this._crossHairShouldBeVisible()&&null===this._startTrackPoint))}_finishTool(e,t=null){const i=this._chartUndoModel(),s=e.toolname;if(s===D.tool.value()&&(0,D.resetToCursor)(),this._preventCrossHairMove()&&this._clearCursorPosition(),
i.selectionMacro((i=>{i.addSourceToSelection(e,js(t,e))})),(0,Ut.isEditableTextLineTool)(e)&&e.activateEditingOnCreation())e.activateTextEditingOn(this._div,!0);else if((0,se.isTextToolName)(s)){const t=i.createUndoCheckpoint();this._chart.showChartPropertiesForSource(e,Rt.TabNames.text,void 0,t)}this._lastFinishedToolId=e.id(),(0,N.emit)("drawing_event",e.id(),"create")}_alignSourcesThatBeingMoved(e,t,i,s,o){const r=this._chartUndoModel(),n=2===o?NaN:r.timeScale().coordinateToIndex(t);r.model().sourcesBeingMoved().forEach((e=>{let a=n,l=e.convertYCoordinateToPriceForMoving(i,this.state().mainDataSource());if(null===l){if(1!==o)return;l=NaN}if((0,Nt.isStudy)(e)){const e=r.mainSeries().bars().firstIndex();null!==e&&2!==o&&(a=Math.max(n,e)),1!==o&&(l=this._chartModel().magnet().align(l,n,this.state()))}null!==this._currentMovingHitTest&&void 0!==this._currentMovingHitTest.sourceAtPoint.hittest.data()?.cursorType||this.setCursorForTool(),r.moveSources({screen:new dt.Point(t,i),logical:{index:a,price:l}},s)}))}_resetMeasureIfRequired(){this._needResetMeasureLater&&((0,D.resetToCursor)(),this._needResetMeasureLater=!1)}_makeSureIsUpdated(e){const t=this.state(),i=[...t.dataSources(),...t.customSources()];for(const s of i){const i=s.paneViews(t);if(null!==i)for(const t of i)t.makeSureIsUpdated?.(e)}}_drawBackground(e,t){const i=this._chartModel(),s=i.backgroundTopColor().value(),o=i.backgroundColor().value();if(this._state?.mode()===K.PaneMode.Widget){const i=this._state?.model().panes().indexOf(this._state)??0,r=this._state?.model().mainPane(),n=i>(r?this._state?.model().panes().indexOf(r)??0:0)?o:s;(0,Et.clearRect)(e,0,0,t.bitmapSize.width,t.bitmapSize.height,n)}else s===o?(0,Et.clearRect)(e,0,0,t.bitmapSize.width,t.bitmapSize.height,o):(0,mi.clearRectWithGradient)(e,0,0,t.bitmapSize.width,t.bitmapSize.height,s,o)}_drawWatermark(e,t){const i=this._chartModel().watermarkSource();if(null===i)return;if(!this.state().containsMainSeries())return;const s=i.paneViews();for(const i of s){e.save();const s=i.renderer(t);s&&s.draw(e,t),e.restore()}}_drawCrossHair(e,t){const i=this._chartUndoModel().crosshairSource();i.invalidateLockPosition(),i.visible||null===D.crosshairLock.value()||i.updateAllViews((0,Ds.sourceChangeEvent)(i.id())),this._drawSourceImpl(e,t,zs,Fs,i)}_drawActiveLineTools(e,t){const i=this._chartModel(),s=[i.lineBeingCreated(),i.lineBeingEdited(),...i.sourcesBeingMoved(),i.customSourceBeingMoved()].filter((e=>!!e));for(const o of s){(i.paneForSource(o)===this.state()||(0,_i.isDataSource)(o)&&o.isMultiPaneEnabled())&&this._drawSourceImpl(e,t,zs,Fs,o)}}_drawTopViews(e,t){for(const i of this.state().sourcesByGroup().all())i.topPaneViews&&this._drawSourceImpl(e,t,Hs,Fs,i)}_drawSources(e,t){
const i=this.state(),s=i.model(),o=i.sourcesByGroup(),r=o.tradingSources(),a=o.generalSources(),l=o.phantomSources(),c=i.customSources(di.CustomSourceLayer.Background).slice(),h=i.customSources(di.CustomSourceLayer.Foreground).slice(),d=i.customSources(di.CustomSourceLayer.Topmost).slice(),u=s.activeStrategySource().value(),_=s.replayStudyStrategy().value();this._drawSourceImpl(e,t,zs,Fs,s.gridSource()),this._drawWatermark(e,t);for(const i of c)this._drawSourceImpl(e,t,zs,Ws,i);for(const i of a)this._drawSourceImpl(e,t,zs,Ws,i);for(const i of h)this._drawSourceImpl(e,t,zs,Ws,i);for(const i of l)this._drawSourceImpl(e,t,zs,Ws,i);const p=new Set;[s.lineBeingCreated(),s.lineBeingEdited(),...s.sourcesBeingMoved(),s.customSourceBeingMoved()].filter(n.notNull).forEach((e=>p.add(e.id())));let m=s.hoveredSource();null!==m&&((0,_i.isDataSource)(m)&&!m.showOnTopOnHovering()||p.has(m.id())||(0,_i.isDataSource)(m)&&!a.includes(m)?m=null:p.add(m.id()));const g=s.selection().allSources().filter((e=>!((0,_i.isDataSource)(e)&&!a.includes(e))&&!p.has(e.id())));g.forEach((e=>p.add(e.id())));for(const i of c)this._drawSourceImpl(e,t,zs,Fs,i,p);for(const i of a)this._drawSourceImpl(e,t,zs,Fs,i,p);for(const i of h)this._drawSourceImpl(e,t,zs,Fs,i,p);u&&this.containsMainSeries()&&!(0,As.isStudyStrategyStub)(u)&&this._drawSourceImpl(e,t,Gs,Fs,u,p),_&&this._drawSourceImpl(e,t,Gs,Fs,_,p);for(const i of r)this._drawSourceImpl(e,t,zs,Ws,i);for(const i of d)this._drawSourceImpl(e,t,zs,Ws,i);for(const i of a)this._drawSourceImpl(e,t,Us,Fs,i,p);for(const i of h)this._drawSourceImpl(e,t,Us,Fs,i,p);for(const i of r)this._drawSourceImpl(e,t,zs,Fs,i,p);for(const i of d)this._drawSourceImpl(e,t,zs,Fs,i,p);for(const i of g)this._drawSourceImpl(e,t,zs,Fs,i),i===u&&this.containsMainSeries()&&!(0,As.isStudyStrategyStub)(u)&&this._drawSourceImpl(e,t,Gs,Fs,u);for(const i of g)this._drawSourceImpl(e,t,Us,Fs,i);m&&(this._drawSourceImpl(e,t,zs,Fs,m),m===u&&this.containsMainSeries()&&!(0,As.isStudyStrategyStub)(u)&&this._drawSourceImpl(e,t,Gs,Fs,u),this._drawSourceImpl(e,t,Us,Fs,m));for(const i of l)this._drawSourceImpl(e,t,zs,Fs,i,p)}_drawSourceImpl(e,t,i,s,o,r){if(r&&r.has(o.id()))return;const n=i(o,this.state());if(n)for(const i of n){const o=i.renderer(t);o&&(e.save(),s(o,e,t),e.restore())}}_updateByThemedColors(){null!==this._legendWidget&&this._legendWidget.updateThemedColors(this._themedTopColor),null!==this._paneControls&&this._paneControls.updateThemedColors(this._themedTopColor)}_scrollUndoCommandInStack(){const e=this._chartUndoModel().undoHistory().undoStack();if(e.isEmpty())return!1;const t=e.head();if(!(t instanceof f))return!1;if(t.isEmpty())return!1;return t.commands()[0]instanceof Ss}_onStateDestroyed(){this.setState(null)}_onDataSourcesCollectionChanged(){this._startMoveSourceParams=null}_processMouseEnterLeaveMoveHandlers(e,t){if(null!==this._prevHoveredHittest&&(this._prevHoveredHittest.renderer!==e?.renderer||this._prevHoveredHittest.hittest.data()?.activeItem!==e.hittest.data()?.activeItem)){
const e=this._sourceWasSelected(this._prevHoveredHittest);(0,hi.tryCallHandler)(t,{sourceWasSelected:e},this._prevHoveredHittest.hittest.data()?.mouseLeaveHandler),this._prevHoveredHittest=null}if(!t.isTouch&&null!==e){const i=this._sourceWasSelected(e);this._prevHoveredHittest?.renderer!==e.renderer&&(e.hittest.tryCallMouseEnterHandler(t,{sourceWasSelected:i}),this._prevHoveredHittest=e),e.hittest.tryCallMouseMoveHandler(t,{sourceWasSelected:i})}}_startChangeOrMoveLineToolIfNeeded(){if(null!==this._startChangeLineToolParams){const e=this._startChangeLineToolParams;(0,_t.trackEvent)("chart_alert","edit","start_change_line_tool_params"),this._chartUndoModel().startChangingLinetool(e.source,e.ownerSource,e.startPoint,e.pointIndex,e.envState)}if(null!==this._startMoveSourceParams){const e=this._startMoveSourceParams;(0,_t.trackEvent)("chart_alert","edit","start_moving_sources"),this._chartUndoModel().startMovingSources(e.source,e.startPoint,e.activeItem,e.envState)}this._startMoveSourceParams=null,this._startChangeLineToolParams=null}_trackingModeShouldBeActive(){return!(!this._trackCrosshairOnlyAfterLongTap||this._contextMenuOpenedOnLastTap||this._crossHairShouldBeVisible())&&this._longTap}_processOutsideClick(e,t){let i=null;const s=this._chartModel();if(null!==e&&(i=e.isCustom?s.customSourceName(e.source):e.source.id()),null!==this._lastClickedSource&&this._lastClickedSource.id!==i){const e=this._lastClickedSource.id;let i=this._lastClickedSource.isCustom?s.customSourceForName(e):s.dataSourceForId(e);null!==i||this._lastClickedSource.isCustom||(i=s.dataSourceForId(e)),null!==i&&i.onClickOutside&&(i.onClickOutside((0,Et.getBindingRenderingInfo)(this._canvasBinding),t),this._chartModel().updateSource(i))}this._lastClickedSource=null!==i?{id:i,isCustom:e?.isCustom??!1}:null}async showConfetti(e,t){{const s=await i.e(86740).then(i.bind(i,359901));"performance"===D.tool.value()&&s.confetti(e,t)}}_mouseClickOrTapEvent(e){if(!this.hasState())return;Ts.performanceTestMode&&"performance"===D.tool.value()&&this.showConfetti(e.pageX,e.pageY);let t=null,i=null;this._mouseTouchDownUpInfo&&this._mouseTouchDownUpInfo.toolCreation&&!this._mouseTouchDownUpInfo.mouseMove||(t=this._dataSourceAtPoint(e.localX,e.localY),i=t&&t.source);const s=this._chartUndoModel(),o=Boolean(t?.hittest.data()?.hideCrosshairLinesOnHover);this._processOutsideClick(t,e),!this._isSelectPointModeEnabled()||o||e.isTouch&&this.trackingModeEnabled()&&!this._exitTrackingModeOnNextTry||s.crosshairSource().trySelectCurrentPoint();const r=this._sourceWasSelected(t);!(0,se.isLineToolName)(D.tool.value())&&null!==t&&t.hittest.tryCallClickOrTapHandler(e,{sourceWasSelected:r})&&s.model().updateSource((0,a.ensureNotNull)(i)),!e.isTouch||this._isSelectPointModeEnabled()||t&&t.source===s.crosshairSource()||this._tryExitTrackingMode(),i&&(0,Ut.isLineTool)(i)&&this._lastFinishedToolId!==i.id()&&(0,N.emit)("drawing_event",i.id(),"click"),this._resetMeasureIfRequired(),this._mouseTouchDownUpInfo=null}_mouseDownOrTouchStartEvent(e,t){this._pressedMoveStage=1,
this._preventScrollUntilNextMouseDownOrTouchStart=!1,this._selectionBeforeMouseDown=new Set(this._chartModel().selection().allSources()),e.isTouch&&(this._longTap=!1,this._exitTrackingModeOnNextTry=null!==this._startTrackPoint,this._paneWidgetsSharedState.clearDraggingSource()),this._contextMenuOpenedOnLastTap=!1,this._lastFinishedToolId=null;const i=this._chartModel();if(i.stopTimeScaleAnimation(),this._mouseTouchDownUpInfo={mouseMove:!1,toolCreation:Boolean(i.lineBeingCreated())},e.isTouch&&this._switchTrackingModeFromAnotherPaneIfNeeded(e),document.activeElement!==document.body&&document.activeElement!==document.documentElement)document.activeElement&&document.activeElement.blur?document.activeElement.blur():document.body.focus();else{const e=document.getSelection();null!==e&&e.removeAllRanges()}(0,N.emit)("mouse_down",{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,screenX:e.screenX,screenY:e.screenY}),this._updateCommonTooltip(null);const s=this._chartUndoModel(),o=new ui.EnvironmentState(e);s.mainSeries().clearGotoDateResult();const r=this.state().defaultPriceScale();if(s.timeScale().isEmpty())return;const n=s.crosshairSource();if(!e.isTouch&&!(0,se.isLineDrawnWithPressedButton)(D.tool.value())){const t=null!==s.lineBeingCreated()?s.model().paneBeingCreatedLineOn():null;null!==t&&t!==this._state?this._setCursorPositionOnExternalPane(t,e.localX,e.localY,o):this.setCursorPosition(e.localX,e.localY,o)}e.isTouch&&(0,se.isLineToolName)(D.tool.value())&&((0,se.isLineDrawnWithPressedButton)(D.tool.value())||null!==n.pane?(0,se.isLineDrawnWithPressedButton)(D.tool.value())&&this._clearCursorPosition():this._chart.updateCrossHairPositionIfNeeded());const l=(0,a.ensureNotNull)(this.state().mainDataSource()).firstValue();let c=null==l?null:r.coordinateToPrice(e.localY,l),h=i.timeScale().coordinateToIndex(e.localX);if(n.startMeasurePoint()&&n.endMeasurePoint()&&n.clearMeasure(),o.shift()&&(0,D.toolIsCursor)(D.tool.value())){const e=s.selection().isEmpty();(null===t||e&&!t.hittest.data()?.hasOwnShortcutsBehaviourFor?.shiftKey)&&(D.tool.setValue("measure"),(0,ps.trackDrawingToolSelected)("measure","Keyboard shortcut"),e||s.selectionMacro((e=>e.clearSelection())))}if((e.isTouch&&!e.stylus||null===c||!this._tryStartMeasure(e,n,o,c,h))&&(e.isTouch&&!e.stylus||!this._tryFinishMeasure(e,n))&&!(this._tryFinishZoom(e)||null!==c&&this._tryStartZoom(e,c,h,o))){if(e.isTouch&&(null!==this._startTrackPoint?(this._initCrossHairPosition=n.currentPoint(),this._startTrackPoint=new dt.Point(e.localX,e.localY)):this._isSelectPointModeEnabled()&&null===this._chart.trackingModePaneWidget()&&this.startTrackingMode(new dt.Point(e.localX,e.localY),new dt.Point(e.localX,e.localY),new ui.EnvironmentState(e))),e.isTouch&&(this._preventSourceChange=null===t||!s.selection().isSelected(t.source)),!this._isSelectPointModeEnabled()&&!this._isScrolling){if(e.isTouch&&!e.stylus&&((0,D.toolIsMeasure)(D.tool.value())||null!==n.measurePane().value()))return void this._initToolCreationModeParams(e);if(null!==c&&((0,
se.isLineToolName)(D.tool.value())||s.lineBeingCreated()))return o.shift()||s.selectionMacro((e=>e.clearSelection())),void this._mouseDownEventForLineTool(e,o,h,c)}if((0,D.toolIsDemonstration)(D.tool.value())&&o.altOnly()){e.isTouch&&!this.trackingModeEnabled()&&this.startTrackingMode(new dt.Point(e.localX,e.localY),new dt.Point(e.localX,e.localY),new ui.EnvironmentState(e));const t=this._chartModel().crosshairSource().crosshairDemonstration();t.createHighlighter();const i=this._localCoordinatesToLineDataSourcePoint(n.originX(),n.originY(),(0,a.ensureNotNull)(this.state().mainDataSource()));i&&t.addHighlighterPosition(i)}else{if(null!==t){const i=this._sourceWasSelected(t);t.hittest.tryCallMouseDownOrTouchStartHandler(e,{sourceWasSelected:i})}if(!this._chart.readOnly()){const r=this._handleSelectionMouseDownAndGetJustDeselectedSource(e,t,o);if(null!==t&&!this._preventSourceChange){const i=t.hittest.data();if(t.isCustom){if(t.hittest.hasPressedMoveHandler(e))return s.model().setMovingCustomSource(t.source,i),this._preventScrollUntilNextMouseDownOrTouchStart=!0,this._currentMovingHitTest={sourceAtPoint:t,cancelledContainer:s.model().customSourceMovingHitTestData()??void 0},void s.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection((0,a.ensureNotNull)(t.source),(0,a.ensureNotNull)(i))}))}else if(i?.areaName===hi.AreaName.SourceItemMove){const o=i?.activeItem;if(void 0!==o)return s.startCustomMoving(t.source,o,e),this._currentMovingHitTest={sourceAtPoint:t},void s.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection((0,a.ensureNotNull)(t.source),(0,a.ensureNotNull)(i))}))}}if(null!==t&&this._tryHandleEraserMouseDown(t,o))return;const n=null!==t&&(0,Ut.isLineTool)(t.source)&&t.source.isLocked&&t.source.isLocked();if(!((0,D.lockDrawings)().value()||n)&&null!==t&&!t.isCustom){if(!t.source.userEditEnabled())return;const s=t.hittest.data()?.snappingPrice,n=t.hittest.data()?.snappingIndex;let u=e.localY,_=e.localX;const p=t.hittest.data()?.ownerSourceId,m=p?i.dataSourceForId(p):t.source.ownerSource();if(void 0!==s&&null!==l&&(u=(0,a.ensure)(m?.priceScale()).priceToCoordinate(s,l),c=s),void 0!==n&&(_=i.timeScale().indexToCoordinate(n),h=n),u===e.localY&&_===e.localX||(e={...e,localY:u,localX:_},this.setCursorPosition(e.localX,e.localY,o)),this._tryStartChangingLineTool(e,t,o,h))return void(this._currentChangingLineToolHitTest=t);if(this._currentChangingLineToolHitTest=null,(d=t.hittest.target())===hi.HitTarget.MovePoint||d===hi.HitTarget.MovePointBackground&&(0,Zt.lastMouseOrTouchEventInfo)().isTouch){if(this._tryStartCloning(e,t,o,r))return;if(this._tryStartMovingLineTool(e,t,o,h))return void(this._currentMovingHitTest={sourceAtPoint:t});this._currentMovingHitTest=null}}if(null!==t&&(0,bs.isPriceDataSource)(t.source)&&t.source.isDraggable()&&this._state?.hasDataSource(t.source)&&this._paneWidgetsSharedState.trySetDraggingSource(t.source,this))return}var d;null!==t&&t.hittest.target()===hi.HitTarget.Regular||(this._processing=!0)}}}_mouseUpOrTouchEndEvent(e){if(!this.hasState())return;this._pressedMoveStage=0
;const t=e.isTouch&&null!==this._startTrackPoint,i=e.isTouch&&this._wasPinched;e.isTouch&&(this._wasPinched=!1,this._longTap=!1),this._startMoveSourceParams=null,this._startChangeLineToolParams=null,this._currentChangingLineToolHitTest=null,this._currentMovingHitTest=null;const s=this._chartUndoModel(),o=s.model().customSourceMovingHitTestData();null!==o||s.customMoveBeingProcessed()||this._processMouseUpOrTouchEndHandler(e),this._isSelecting=!1;const r=s.model(),n=r.crosshairSource(),l=this._dataSourceAtPoint(e.localX,e.localY);if(n.selection()&&null===this._firstZoomPoint){const e=this.state().lineToolsForArea(n.selection(),(0,Et.getBindingRenderingInfo)(this._canvasBinding));s.selectionMacro((t=>{let i=null;e.forEach((e=>{null===i&&(i=js(l,e)),t.addSourceToSelection(e,i)}))})),n.clearSelection(),(0,_t.trackEvent)("GUI","Multiselect","Area Select")}(0,N.emit)("mouse_up",{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,screenX:e.screenX,screenY:e.screenY});const c=e.isTouch&&this._touchMove;e.isTouch&&(this._touchMove=!1);const h=new ui.EnvironmentState(e),d=D.tool.value();if(e.isTouch&&((0,D.toolIsMeasure)(d)||null!==n.measurePane().value())){if(!c&&!e.stylus&&null===n.measurePane().value()&&n.pane!==this._state)return void this.setCursorPosition(e.localX,e.localY);if(!c&&!e.stylus&&this._tryStartMeasure(e,n,h,n.price,n.index))return;if((!c||e.stylus)&&this._tryFinishMeasure(e,n))return}if(e.isTouch&&!c&&!(0,se.isLineDrawnWithPressedButton)(d)&&(0,se.isLineToolName)(d)&&!s.lineBeingCreated()){if(this._chart.justActivated())return;if(n.pane!==this._state)return void this.setCursorPosition(e.localX,e.localY,h);const t=n.currentPoint(),i=this.state().defaultPriceScale(),o=(0,a.ensure)(this.state().mainDataSource()?.firstValue()),r={index:Math.round(s.timeScale().coordinateToIndex(t.x)),price:i.coordinateToPrice(t.y,o)},c=(0,a.ensureNotNull)(s.createLineTool({pane:this.state(),point:r,linetool:d,actionSource:"Draw"}));return this._mouseTouchDownUpInfo&&(this._mouseTouchDownUpInfo.toolCreation=!0),s.selectionMacro((e=>{e.addSourceToSelection(c)})),s.lineBeingCreated()||(this._finishTool(c,l),e.preventDefault()),void(this._startTouchPoint=null)}const u=s.lineBeingCreated();if(u&&!(0,se.isLineDrawnWithPressedButton)(u.toolname)&&e.isTouch&&(this._startTouchPoint||e.stylus)){if(this._startTouchPoint=null,!c||e.stylus){const t=(0,a.ensureNotNull)(u.lastPoint()),i=s.continueCreatingLine({index:t.index,price:t.price},new ui.EnvironmentState(e));this._initCrossHairPosition=null,i&&(this._finishTool(u,l),e.preventDefault())}return}if(null!==this._firstZoomPoint&&this._firstZoomPoint.draggingMode)return void this._finishZoom(e);if(this._processing=!1,s.customMoveBeingProcessed())return void s.endCustomMoving();if(null!==o){if(o.beingMoved&&!o.cancelled){const t=this._sourceWasSelected(l);(0,hi.tryCallHandler)(e,{sourceWasSelected:t},o.mouseUpHandler,o.touchEndHandler),this.setCursorForTool()}if(r.setMovingCustomSource(null,null),Xs(e,o))return}if(r.lineBeingEdited())return s.endChangingLinetool(!1),
void(this._preventCrossHairMove()&&this._clearCursorPosition());if((0,se.isLineDrawnWithPressedButton)(d)&&!this._isSelectPointModeEnabled()){const t=s.lineBeingCreated();null!==t&&(t.finish(),"LineToolBrush"===t.toolname&&(0,N.emit)("drawing_event",t.id(),"create"));const i=this.state().defaultPriceScale();if(i.isEmpty())return;if(!t)return;const o=(0,a.ensure)(t.ownerSource()?.firstValue()),r=i.coordinateToPrice(e.localY,o),n={index:Math.round(s.timeScale().coordinateToIndex(e.localX)),price:r};return void s.continueCreatingLine(n)}const _=r.crosshairSource().crosshairDemonstration();if(_.isThereUnfinishedHighlighter())return void _.finishHighlighter();if(r.sourcesBeingMoved().length)return s.endMovingSource(!1,!1),r.sourcesBeingMoved().filter(Ut.isLineTool).forEach((e=>{this.setCursorForTool(e)})),void r.invalidate(ve.InvalidationMask.cursor());if(!this._chart.readOnly()){const t=e.localX>=0&&e.localX<this._size.width;if((!l||l.source!==n)&&t){const t=this._chartModel().mainSeries().syncModel();if(t){const i=this._chartModel().timeScale().points().roughTime(s.timeScale().coordinateToIndex(e.localX),((e,i)=>t.projectTime(e,i)));null!==i&&this._chart.chartWidgetCollection().syncScroll(1e3*i,this._chartModel())}}}const p=this._isScrolling,m=this._endScroll(e),g=this._paneWidgetsSharedState.draggingSource();if(null!==g){const t=e.target,i=this._chart.paneByCanvas(t);i&&i!==this&&i.state().mode()===K.PaneMode.Regular&&(m&&s.undoHistory().undo(),s.mergeToPane(g,i.state()));if(this._chart.timeAxisByCanvas(t))if(r.isUnmergeAvailableForSource(g))m&&s.undoHistory().undo(),s.unmergeToNewBottomPane(g);else{const e=r.panes(),t=(0,a.ensureNotNull)(r.paneForSource(g)),i=e.indexOf(t);i!==e.length-1&&(m&&s.undoHistory().undo(),t.maximized().value()&&s.toggleMaximizedPane(t),s.movePane(i,e.length-1))}this._paneWidgetsSharedState.clearDraggingSource();const o=this._chart.getTimeScale();o&&o.restoreDefaultCursor();const n=this._chart.paneWidgets();for(let e=0;e<n.length;e++){const t=n[e];t===this&&l&&!l.isCustom?t.setCursorForTool(l.source||void 0):t.setCursorForTool(),t.leftPriceAxisesContainer().restoreDefaultCursor(),t.rightPriceAxisesContainer().restoreDefaultCursor()}}this._chart.readOnly()||t||h.mod()||p||i||null!==this._lastFinishedToolId||null!==l&&(l.hittest.target()>hi.HitTarget.MovePointBackground||(0,Zt.lastMouseOrTouchEventInfo)().isTouch)&&s.selectionMacro((t=>{const i={type:"change",newSelectedSource:l.source,interactionType:e.isTouch?"touch":"pointer"};if(t.selectionOperationAvailable(i)){t.clearSelection();const e=(0,a.ensureNotNull)(l.source);t.addSourceToSelection(e,js(l,e))}})),e.isTouch&&(this._touchMove=!1)}_mouseOrTouchMoveEvent(e){if(!this.hasState())return;this._mouseTouchDownUpInfo&&(this._mouseTouchDownUpInfo.mouseMove=!0),this._resetMeasureIfRequired();const t=this._dataSourceAtPoint(e.localX,e.localY);this._processMouseEnterLeaveMoveHandlers(t,e);const i=this._chartUndoModel();if(!i)return;const s=e.localX,o=e.localY;this._prevMoveEventPosition=new dt.Point(s,o);const r=new ui.EnvironmentState(e)
;if(null===this._firstZoomPoint){if(this._updateHoveredSource(t,r,e),!e.isTouch&&i.lineBeingCreated()){const e=i.model().paneBeingCreatedLineOn();if(null!==e&&e!==this._state)return void this._setCursorPositionOnExternalPane(e,s,o,r)}e.isTouch||this.setCursorPosition(s,o,r)}else this._processMouseMoveWhileZoom(e,r)}_pressedMouseOrTouchMoveEvent(e){if(this._chartModel().dragExportEnabled().value()&&void 0!==e.buttons&&!Boolean(1&e.buttons))return;if(!this.hasState()||this._pinching||e.isTouch&&this._contextMenuOpenedOnLastTap)return;this._pressedMoveStage=2,this._mouseTouchDownUpInfo&&(this._mouseTouchDownUpInfo.mouseMove=!0),this._resetMeasureIfRequired(),this._startChangeOrMoveLineToolIfNeeded(),e.isTouch&&(this._touchMove=!0,this._preventSourceChange=!1);const t=new ui.EnvironmentState(e),i=this._chartUndoModel(),s=i.crosshairSource(),o=e.localX,r=e.localY;if(this._prevMoveEventPosition=new dt.Point(o,r),null!==this._firstZoomPoint)return this._processMouseMoveWhileZoom(e),void(this._firstZoomPoint.draggingMode=!0);const n=D.tool.value();if(e.isTouch&&this._startTouchPoint&&(0,se.isLineToolName)(n)&&!(0,se.isLineDrawnWithPressedButton)(n)&&!i.lineBeingCreated()&&!this._isSelectPointModeEnabled())return void this._updateCrosshairPositionInToolCreationMode(e,this.state());const l=s.measurePane().value();if(e.isTouch&&(this._startTouchPoint||e.stylus)&&((0,D.toolIsMeasure)(n)||null!==l))return void(e.stylus?this.setCursorPosition(e.localX,e.localY,new ui.EnvironmentState(e)):this._updateCrosshairPositionInToolCreationMode(e,l||this.state()));const c=i.lineBeingCreated();if(e.isTouch&&!e.stylus&&c&&!(0,se.isLineDrawnWithPressedButton)(c.toolname)){if(this._startTouchPoint){const t=(0,a.ensureNotNull)(i.lineBeingCreated()),s=(0,a.ensureNotNull)(i.model().paneForSource(t));this._updateCrosshairPositionInToolCreationMode(e,s)}return}if(e.isTouch&&null!==this._startTrackPoint){this._exitTrackingModeOnNextTry=!1;const e=(0,a.ensureNotNull)(this._initCrossHairPosition),i=new dt.Point(o,r).subtract(this._startTrackPoint),s=e.add(i);this.setCursorPosition(s.x,s.y,t)}else e.isTouch&&this._preventCrossHairMove()||this.setCursorPosition(o,r,t);const h=this._isSelectPointModeEnabled();if((0,se.isLineToolName)(n)&&!(0,se.isLineDrawnWithPressedButton)(n)&&!h&&!t.mod())return;if((0,se.isLineDrawnWithPressedButton)(n)&&!h){const t=i.lineBeingCreated();if(!t)return;const s=this._localCoordinatesToLineDataSourcePoint(e.localX,e.localY,(0,a.ensureNotNull)(t.ownerSource()));return void(s&&i.continueCreatingLine(s))}const d=i.crosshairSource().crosshairDemonstration();if(d.isThereUnfinishedHighlighter()){const e=this._localCoordinatesToLineDataSourcePoint(s.originX(),s.originY(),(0,a.ensureNotNull)(this.state().mainDataSource()));return void(e&&d.addHighlighterPosition(e))}if(null!==this._paneWidgetsSharedState.draggingSource()){const t=e.target,i=this._chart.paneByCanvas(t);i&&(i!==this?i.setDragToAnotherPaneCursor():i.setCursorForTool());const s=this._chart.timeAxisByCanvas(t);s&&s.setCursor("grabbing")}if(i.timeScale().isEmpty())return
;const u=this._options.handleScroll;if((!u.pressedMouseMove||e.isTouch)&&(!u.horzTouchDrag&&!u.vertTouchDrag||!e.isTouch))return;if(this._chartModel().dragExportEnabled().value()&&this._ignoringMouseMovement)return;if(i.customMoveBeingProcessed())return void i.processCustomMove(e);const _=i.model().customSourceMovingHitTestData();if(null!==_&&(this._updateCommonTooltip(null,!0),_.cancelled||(i.model().processingCustomSourceMove(),(0,hi.tryCallHandler)(e,{sourceWasSelected:this._selectionBeforeMouseDown.has(i.model().customSourceBeingMoved())},_.pressedMouseMoveHandler,_.touchMoveHandler)),Xs(e,_)))return;if(i.model().lineBeingEdited())return void this.setCursorPosition(o,r,t);if(i.model().sourcesBeingMoved().length)return void this._alignSourcesThatBeingMoved(i.model().sourcesBeingMoved(),e.localX,e.localY,t,i.model().lastHittestData()?.possibleMovingDirections);const p=this._dataSourceAtPoint(e.localX,e.localY);if(this._tryFinishClonning(e,new ui.EnvironmentState(e),p))return;const m=(0,D.toolIsMeasure)(n)||s.startMeasurePoint()&&s.endMeasurePoint();this._chart.readOnly()||!t.mod()||(0,se.isLineToolName)(n)||m||h?(this._processScroll(e),this._preventScroll()&&!this._preventCrossHairMove()&&null===this._startTrackPoint&&this.setCursorPosition(e.localX,e.localY,new ui.EnvironmentState(e))):this._isSelecting||(s.startSelection(this.state()),this._isSelecting=!0)}_mouseOrTouchLeaveEvent(e){if(!this.hasState())return;const t=this._chartUndoModel();if(!t)return;const i=t.crosshairSource();e.isTouch||null!==i.measurePane().value()&&null===i.endMeasurePoint()||this._clearCursorPosition();if(this._chartModel().setHoveredSource(null,null),null!==this._prevHoveredHittest){const t=this._sourceWasSelected(this._prevHoveredHittest);(0,hi.tryCallHandler)(e,{sourceWasSelected:t},this._prevHoveredHittest.hittest.data()?.mouseLeaveHandler),this._prevHoveredHittest=null}this._updateCommonTooltip(null),this._chart.setActivePaneWidget(null)}_mouseDoubleClickOrDoubleTapEvent(e){if(!this.hasState())return;const t=!this._chart.readOnly()&&!(0,se.isLineToolName)(D.tool.value())&&this._dataSourceAtPoint(e.localX,e.localY)||null,i=this._sourceWasSelected(t);if(null!==t&&t.isCustom)t.hittest.tryCallDblClickOrDblTapHandler(e,{sourceWasSelected:i});else if(null!==t&&(e.isTouch||t.hittest.target()>hi.HitTarget.MovePointBackground))t.hittest.tryCallDblClickOrDblTapHandler(e,{sourceWasSelected:i})&&!(0,hi.shouldDefaultActionBeExecuted)(e,(0,a.ensureNotNull)(t.hittest.data()),"doubleClickHandler","doubleTapHandler")||this.processDoubleClickOnSource(t.source,t.hittest?t.hittest:void 0);else if(!this._chart.readOnly()&&!(0,se.isLineToolName)(D.tool.value())&&!this._chartUndoModel().lineBeingCreated()&&this._chartUndoModel().selection().isEmpty()){const t=this.state();new ui.EnvironmentState(e).mod()&&!t.maximized().value()?(t.collapsed().value()||t.collapsingAvailable().value())&&this._chartUndoModel().toggleCollapsedPane(this.state()):this._chartUndoModel().toggleMaximizedPane(this.state())}}_contextMenuEvent(e){const t=this._chartUndoModel()
;if(t.crosshairSource().startMeasurePoint()&&!this._trackCrosshairOnlyAfterLongTap)return t.crosshairSource().clearMeasure(),void(0,D.resetToCursor)(!0);if(this._pinching)return;if(null===this._firstZoomPoint||this._trackCrosshairOnlyAfterLongTap||this.cancelZoom(),!(0,D.toolIsCursor)(D.tool.value())||this._isSelectPointModeEnabled()){if(e.isTouch)return;return(0,D.resetToCursor)(!0),this.setCursorForTool(),void(t.lineBeingCreated()&&t.cancelCreatingLine())}if(!this._options.contextMenuEnabled)return;const i=this._dataSourceAtPoint(e.localX,e.localY),s=i?i.source:null;if(e.isTouch&&null!==this._startTrackPoint){if(this._preventSourceChange)return;this._clearCursorPosition()}e.isTouch&&(this._contextMenuOpenedOnLastTap=!0,this._startTrackPoint=null),this._contextMenuX=e.localX,this._contextMenuY=e.localY;const o=i&&i.hittest?i.hittest.target():0,r=o>=hi.HitTarget.Regular||o>=hi.HitTarget.MovePointBackground&&e.isTouch;if(t.selectionMacro((t=>{null!==s&&r?t.selection().isSelected(s)||(t.clearSelection(),t.addSourceToSelection(s,js(i,s))):(this._options.contextMenu.general&&this._showContextMenu(e),t.clearSelection())})),null!==i&&r&&null!==s)if((0,_i.isDataSource)(s)&&s.hasContextMenu())s.isSelectionEnabled()?this.showContextMenuForSelection(e,void 0,i.hittest):this.showContextMenuForSources([s],e,void 0,void 0,i.hittest);else{const t=this._sourceWasSelected(i);i.hittest.tryCallContextMenuHandler(e,{sourceWasSelected:t})}}_onMouseEvent(){this._preventSourceChange=!1,this._startTrackPoint=null,this._trackCrosshairOnlyAfterLongTap=!1}_onTouchEvent(){this._trackCrosshairOnlyAfterLongTap=!0}_localCoordinatesToLineDataSourcePoint(e,t,i){const s=this.state().defaultPriceScale();if(s.isEmpty())return null;const o=new dt.Point(e,t),r=(0,a.ensure)(i.firstValue());return o.price=s.coordinateToPrice(t,r),o.index=Math.round(this._chartUndoModel().timeScale().coordinateToIndex(e)),o}_switchTrackingModeFromAnotherPaneIfNeeded(e){const t=this._chart.trackingModePaneWidget();if(null!==t&&t!==this){const i=this._chartModel().crosshairSource().currentPoint();t._exitTrackingModeOnNextTry=!0,t._tryExitTrackingMode(!0),this.startTrackingMode(new dt.Point(e.localX,e.localY),new dt.Point(i.x,e.localY),new ui.EnvironmentState(e))}}async _showContextMenu(e){const t=e=>e instanceof Vi.Separator,i=this._customActions(),s=(await this._initActions(e)).filter((e=>null!==e));i.remove.forEach((e=>{for(let t=0;t<s.length;t++){const i=s[t];if(i instanceof Vi.Action&&i.getLabel()===e){s.splice(t,1);break}}}));const o=i.top.concat(s).concat(i.bottom);for(let e=o.length-1;e>0;e--)t(o[e])&&t(o[e-1])&&o.splice(e,1);o.length&&t(o[0])&&o.splice(0,1),o.length&&t(o[o.length-1])&&o.splice(o.length-1,1),fi.ContextMenuManager.showMenu(o,e,{statName:"ChartContextMenu"},{menuName:"ChartContextMenu"})}async _initActions(e){const t=this._chart.actions(),i=[];if(this._chart.model().model().resetScalesAvailable().value()&&(i.push(t.chartReset),i.push(new Vi.Separator)),!this.state().isEmpty()&&(0,
d.isFeaturesetEnabled)("datasource_copypaste")&&this.state().mode()===K.PaneMode.Regular){const{createPasteAction:t,createActionCopyPrice:s}=await(0,Wi.actionsProviderModule)(),o=s(this.state(),e.localY),r=t(this._chart,this.state());(o||r)&&(o&&i.push(o),r&&i.push(r),i.push(new Vi.Separator))}if(ws.alertsAvailable&&this.state().mode()===K.PaneMode.Regular&&(i.length&&i.push(new Vi.Separator),(0,a.ensureNotNull)(this.state().mainDataSource()).alertCreationAvailable().value())){const t=(await(0,fs.getAlertsChartActionCreators)()).createAlert(this._chart,{localY:e.localY,pane:this.state()});null!==t&&i.push(t)}if(this._options.contextMenu.mainSeriesTrade&&this.containsMainSeries()){const{createActionTrade:t}=await(0,Wi.actionsProviderModule)(),s=await t(this._chart,this.state(),e);s&&i.push(...s)}i[i.length-1]instanceof Vi.Separator||i.push(new Vi.Separator),t.moveChartAction&&!t.moveChartAction.isDisabled()&&i.push(t.moveChartAction,new Vi.Separator),i.push(this._createLockTimeAxisAction(e)),i.push(new Vi.Separator),t.openTableView&&i.push(t.openTableView),t.paneObjectTree&&i.push(t.paneObjectTree),t.applyColorTheme&&i.push(t.applyColorTheme),i[i.length-1]instanceof Vi.Separator||i.push(new Vi.Separator),this._chart.applyIndicatorsToAllChartsAvailable()&&(i.push(t.applyStudiesToAllCharts),i.push(new Vi.Separator));const s=t.paneRemoveAllDrawingTools.getState().disabled;s||i.push(t.paneRemoveAllDrawingTools);const o=t.paneRemoveAllStudies.getState().disabled;return o||i.push(t.paneRemoveAllStudies),s&&o||i.push(new Vi.Separator),(0,d.isFeaturesetEnabled)("show_chart_property_page")&&i.push(t.chartProperties),i[i.length-1]instanceof Vi.Separator&&i.pop(),i}_loadAndCreateLegendWidget(){Promise.all([i.e(50648),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(5709),i.e(46680),i.e(74528),i.e(27848),i.e(6406),i.e(22066),i.e(18257),i.e(98729),i.e(56752),i.e(20432),i.e(44589),i.e(93807),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(51129),i.e(21113),i.e(40826),i.e(1748),i.e(8649),i.e(32387),i.e(36295),i.e(13349),i.e(98706),i.e(72132),i.e(65588)]).then(i.bind(i,318437)).then((e=>{if(this._isDestroyed||!this._options.legendWidgetEnabled||this._legendWidget)return;const t=e.LegendWidget,i=(0,ci.deepExtend)({},this._options.legendWidget);i.canShowSourceCode=!this._chart.onWidget()&&!_.CheckMobile.any(),i.readOnlyMode=i.readOnlyMode||this._chart.readOnly(),i.statusesWidgets={sourceStatusesEnabled:this._options.sourceStatusesWidgetEnabled,sourceStatuses:this._options.sourceStatusesWidget||{},marketStatusEnabled:this._options.marketStatusWidgetEnabled,dataUpdateModeEnabled:this._options.chartWarningWidgetEnabled,dataUpdateMode:this._options.chartWarningWidget||{},dataProblemEnabled:this._options.dataProblemWidgetEnabled,pineSourceStatusEnabled:this._options.pineSourceStatusEnabled,alertStatusEnabled:this._options.alertStatusEnabled};const s=(0,
F.combine)(((e,t)=>Zs&&this._chart!==e&&!t),this._chart.chartWidgetCollection().activeChartWidget.weakReference(),this._chart.chartWidgetCollection().lock.crosshair.weakReference()),o=(0,F.combine)(((e,t)=>null!==e?e===this._state:(0,D.toolIsMeasure)(t)),this._chartModel().crosshairSource().measurePane().weakReference(),D.tool.weakReference());this._legendWidget=new t(this._chartUndoModel(),this,this._chart.backgroundTopTheme().spawnOwnership(),s.ownership(),this._visuallyCollapsed.spawnOwnership(),o.ownership(),i,{showContextMenuForSelection:this.showContextMenuForSelection.bind(this),showContextMenuForSources:this.showContextMenuForSources.bind(this),showChartPropertiesForSource:this._chart.showChartPropertiesForSource.bind(this._chart),showGeneralChartProperties:this._chart.showGeneralChartProperties.bind(this._chart),showObjectsTreeDialog:this._chart.showObjectsTreeDialog.bind(this._chart),onLegendRowFocused:()=>{this._chart.chartWidgetCollection().activeChartWidget.setValue(this._chart)}});const r=this._legendWidget.getElement();r.classList.add("chart-gui-wrapper__legend"),this._div.prepend(r),this._legendWidget.updateLayout(),this._legendWidget.updateWidgetModeBySize(this._size),this._legendWidget.updateThemedColors(this._themedTopColor);for(const e of Array.from(this._customLegendWidgetsFactoryMap.keys()))this._legendWidget.addCustomWidgetToLegend(e,(0,a.ensureDefined)(this._customLegendWidgetsFactoryMap.get(e)))}))}_loadAndCreatePaneControlsWidget(e){Promise.all([i.e(50648),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(5709),i.e(46680),i.e(74528),i.e(27848),i.e(6406),i.e(22066),i.e(18257),i.e(98729),i.e(56752),i.e(20432),i.e(44589),i.e(93807),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(51129),i.e(21113),i.e(40826),i.e(1748),i.e(8649),i.e(32387),i.e(36295),i.e(13349),i.e(98706),i.e(72132),i.e(65588)]).then(i.bind(i,509313)).then((t=>{if(this._isDestroyed||this._state!==e)return;const i=t.PaneControlsWidget;this._paneControls=new i(this._chartUndoModel(),e,{backgroundThemeName:this._chart.backgroundTopTheme(),anySeparatorSelected:this._anySeparatorSelected.weakReference()},this._div),this._paneControls.updateWidgetModeByWidth(this._size.width),this._paneControls.updateThemedColors(this._themedTopColor),this._paneControlsResizeObserver=new ResizeObserver(this._handleRestrictLegendWidth.bind(this)),this._paneControlsResizeObserver.observe(this._paneControls.getElement()),this._paneControls.getElement().classList.add("chart-gui-wrapper__paneControls"),this._state?.collapsed().value()&&this._chartModel().fullUpdate()}))}_handleRestrictLegendWidth(e){null!==this._legendWidget&&null!==this._paneControls&&this._legendWidget.addMargin(e[e.length-1].contentRect.width)}_onMagnetStateChanged(){this._chart.isActive().value()&&(this._isSelectPointModeEnabled()||this._isToolActionActiveOnPane(!0))&&this._chartModel().crosshairSource().visible&&this._updateLineToolUsingMagnetOrShift()}_onShiftKeyStateChanged(){
this._chart.isActive().value()&&this._isToolActionActiveOnPane(!1)&&this._chartModel().crosshairSource().visible&&this._updateLineToolUsingMagnetOrShift(ui.EnvironmentState.create((0,Dt.shiftPressed)().value()))}_isToolActionActiveOnPane(e){const t=this._chartModel(),i=t.lineBeingCreated()||t.lineBeingEdited()||t.sourcesBeingMoved().length>0&&t.sourcesBeingMoved()[0];return i?t.paneForSource(i)===this._state:e&&(0,se.isLineToolName)(D.tool.value())&&t.crosshairSource().pane===this._state}_updateLineToolUsingMagnetOrShift(e){if(null===this._prevMoveEventPosition)return;const{x:t,y:i}=this._prevMoveEventPosition,s=this._chartModel().sourcesBeingMoved();s.length>0?(D.isStudyEditingNow.value()&&this.setCursorPosition(t,i,e),this._alignSourcesThatBeingMoved(s,t,i,e)):this.setCursorPosition(t,i,e)}_showEditDialogForSource(e,t){if(this._options.propertyPagesEnabled&&e.userEditEnabled())if(e===this._chartUndoModel().mainSeries())this._chart.showGeneralChartProperties(Rt.TabNames.symbol);else if((0,Ut.isLineTool)(e)||(0,Nt.isStudy)(e)||Ft(e)){let i;const s=t?.data();if(null!=s){const e=s.areaName;void 0!==e&&(i=Ks.get(e))}this._chart.showChartPropertiesForSource(e,i).then((e=>{this._editDialog=e}))}}_initToolCreationModeParams(e){this._startTouchPoint=new dt.Point(e.pageX,e.pageY),this._initCrossHairPosition=this._chartModel().crosshairSource().currentPoint()}_updateCrosshairPositionInToolCreationMode(e,t){if(t!==this._state){const i=this._chart.paneByState(t);return i._startTouchPoint=this._startTouchPoint,i._initCrossHairPosition=this._initCrossHairPosition,void i._updateCrosshairPositionInToolCreationMode(e,t)}const i=this._chartModel().crosshairSource();this._chart.justActivated()&&(this._initCrossHairPosition=i.currentPoint());const s=e.pageX,o=e.pageY,r=(0,a.ensureNotNull)(this._initCrossHairPosition),n=new dt.Point(s,o).subtract((0,a.ensureNotNull)(this._startTouchPoint)),l=r.add(n);this.setCursorPosition(l.x,l.y,new ui.EnvironmentState(e))}_priceAxisesContainer(e){return"left"===e?this._lhsPriceAxisesContainer:this._rhsPriceAxisesContainer}_recalculatePriceScales(e){const t=this.state();for(const i of t.leftPriceScales())t.recalculatePriceScale(i,e);for(const i of t.rightPriceScales())t.recalculatePriceScale(i,e);for(const i of t.sourcesByGroup().overlayPriceScaleSources())(0,Ut.isLineTool)(i)||t.recalculatePriceScale(i.priceScale(),e)}_createLockTimeAxisAction(e){const t=0===D.crosshairLock.value()?.type;return new Vi.Action({actionId:"Chart.Crosshair.LockVerticalCursor",options:{label:Os,statName:"LockCursorInTime",checkable:!0,checked:t,onExecute:()=>this._toggleLockTimeAxis(e.localX,!t)}})}_toggleLockTimeAxis(e,t){if(t){const t=this._chartUndoModel().timeScale(),i=t.coordinateToIndex(e),s=t.points().roughTime(i);if(null!==s)return void D.crosshairLock.setValue({type:0,time:s})}D.crosshairLock.setValue(null)}_preventTouchEventsExceptPinch(){return this._paneWidgetsSharedState.hasTouchesOnOtherPanes(this)||null!==this._paneWidgetsSharedState.pinchingPane()}_updateHoveredSource(e,t,i){
const s=this._chartUndoModel(),o=s.model();let r=!1;const n=e&&e.source,a=this._chart.readOnly();if(o.crosshairSource().isReplaySelection())this._setCursorClassName("none");else if(!(!a||e&&(0,Ut.isLineTool)(e.source))||this._editDialog&&this._editDialog.visible().value())a&&(o.setHoveredSource(null,null),this.setCursorForTool());else{const l=D.tool.value();let c=null;if(!this._processing&&((0,D.toolIsCursor)(l)||(0,D.toolIsEraser)(l)&&!a||t.mod()||!s.lineBeingCreated())){const t=e?.hittest;r=Boolean(t?.data()?.hideCrosshairLinesOnHover),t&&t.target()>hi.HitTarget.MovePointBackground?(c=n,!n?.isHoveredEnabled()||(0,D.toolIsEraser)(l)&&n===s.mainSeries()?o.setHoveredSource(null,null):o.setHoveredSource(n,t.data(),0)):o.setHoveredSource(null,null)}a?this.setCursorForTool(c,t,Ms.PaneCursorType.Default):this._options.sourceSelectionEnabled&&(this._isSelectPointModeEnabled()?this._setCursorClassName("pointer"):this.setCursorForTool(c,t,e?.hittest.data()?.cursorType));const h=o.customSourceBeingMoved(),d=null!==h?[h]:o.sourcesBeingMoved();if((!d.length||null!==e&&-1===d.indexOf(e.source))&&this._updateCommonTooltip(e),!a&&null!==e&&i&&e.hittest.hasPressedMoveHandler(i)){switch((e.hittest.data()||{}).cursorType){case Ms.PaneCursorType.VerticalResize:this._setCursorClassName("ns-resize");break;case Ms.PaneCursorType.HorizontalResize:this._setCursorClassName("we-resize");break;case Ms.PaneCursorType.DiagonalNeSwResize:this._setCursorClassName("nesw-resize");break;case Ms.PaneCursorType.DiagonalNwSeResize:this._setCursorClassName("nwse-resize")}}}this._preventCrossHairMove()&&this._clearCursorPosition(),1!==this._pressedMoveStage&&o.crosshairSource().setLinesShouldBeHidden(r)}async _createErrorBlock(){return new(await(0,Is.getErrorCardRenderer)())}_customActions(){const e={top:[],bottom:[],remove:[]},t=this._chartUndoModel().timeScale(),i=this._state&&this._state.defaultPriceScale();if(!(0,d.isFeaturesetEnabled)("custom_items_in_context_menu"))return e;const s=t.isEmpty()?void 0:t.indexToUserTime(t.coordinateToIndex(this._contextMenuX));let o;if(i&&!i.isEmpty()){const e=(0,a.ensureNotNull)(this.state().mainDataSource()).firstValue();o=i.coordinateToPrice(this._contextMenuY,(0,a.ensureNotNull)(e))}return(0,N.emit)("onContextMenu",{unixtime:null!=s?s.getTime()/1e3:void 0,price:o,callback:t=>{[...t].forEach((t=>{if(t.text)if(t.text.length>1&&"-"===t.text[0])e.remove.push(t.text.slice(1));else{let i;i="-"===t.text?new Vi.Separator:new Vi.Action({actionId:"Chart.ExternalActionId",options:{label:t.text,onExecute:t.click}}),t.position&&"top"===t.position?e.top.push(i):e.bottom.push(i)}}))}}),e}_highlightPriceAxisesByLabel(e){this._state?.mode()===K.PaneMode.Regular&&(this._lhsPriceAxisesContainer.setHighlightedPriceAxises(e),this._rhsPriceAxisesContainer.setHighlightedPriceAxises(e))}_subscribeToState(){const e=this.state();e.onDestroyed().subscribe(this,this._onStateDestroyed,!0),e.dataSourcesCollectionChanged().subscribe(this,this._onDataSourcesCollectionChanged),e.maximized().subscribe(this._updateVisuallyCollapsed,{
callWithLast:!0}),e.collapsed().subscribe(this._updateVisuallyCollapsed,{callWithLast:!0}),e.maximized().subscribe(this._updateMaximized,{callWithLast:!0})}_unsubscribeFromState(){const e=this.state();e.onDestroyed().unsubscribeAll(this),e.dataSourcesCollectionChanged().unsubscribeAll(this),e.maximized().unsubscribe(this._updateVisuallyCollapsed),e.collapsed().unsubscribe(this._updateVisuallyCollapsed),e.maximized().unsubscribe(this._updateMaximized),this._maximized.setValue(!1)}_updateAccessibilityAttr(){if(this.hasState()&&this.state().isMainPane().value()){const e=this._chartModel().mainSeries(),t=e.symbol(),s=(0,T.getTranslatedResolutionModel)(e.interval()).hint,o=h.t(null,{replace:{symbol:t,interval:s}},i(628430));this._topCanvasBinding.canvasElement.setAttribute("aria-label",o)}else this._topCanvasBinding.canvasElement.setAttribute("aria-hidden","true")}async _updateEndOfSeriesBanner(){{const e=()=>{if(window.user.is_pro)return null;const e=this._state;if(!e)return this._endOfSeriesDataBanner?.setVisible(!1),null;if(!this._chart.isActive().value())return null;const t=e.model().mainSeries();if(!t)return null;if(!e.isMainPane().value())return null;if(2===t.status()||t.requestMoreDataAvailable())return this._endOfSeriesDataBanner?.setVisible(!1),null;const i=t.bars().firstIndex();return null===i?null:{state:e,series:t,firstIndex:i}},t=()=>{if(this._legendWidget){const e=this._legendWidget.getElement().getBoundingClientRect();return e.bottom-e.top}return 0};let s=e();if(!s||"end"===s.series.endOfDataType())return void this._endOfSeriesDataBanner?.setVisible(!1);s.series.doNotShowLastAvailableBar(!1);const o=s.series.endOfDataType(),r=(0,a.ensureNotNull)(this._state).model().timeScale().indexToCoordinate(s.firstIndex)-s.state.model().timeScale().barSpacing();if(!this._endOfSeriesDataBanner&&!(0,d.isFeaturesetEnabled)("widget")){const t=await Promise.all([i.e(47088),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(74528),i.e(44589),i.e(93122),i.e(32387),i.e(99331),i.e(91833)]).then(i.bind(i,723196));if(s=e(),!s)return;this._endOfSeriesDataBanner||(this._endOfSeriesDataBanner=new t.EndOfSeriesBanner,this._div.appendChild(this._endOfSeriesDataBanner.element()))}const n=t();this._endOfSeriesDataBanner?.setVisible(!0),this._endOfSeriesDataBanner?.update(s.state,n,r,o);const l=this._endOfSeriesDataBanner?.currentSize();s.series.doNotShowLastAvailableBar(null!==l&&0!==l)}}_paneDblClickOrTapEvent(e){if(this._chart.readOnly())return;const t=this._dataSourceAtPoint(e.localX,e.localY);if(null!==t&&(0,Ut.isEditableTextLineTool)(t.source)){const e=t.source.textEditingActivationTime();null!==e&&performance.now()-e<500&&this.processDoubleClickOnSource(t.source,t.hittest)}}}class Qs{constructor(){this._draggingSource=null,this._activeTouchPanes=new Set,this._scrollingPane=null,this._pinchingPane=null}onPaneDestroyed(e){this._activeTouchPanes.delete(e),this._scrollingPane===e&&(this._scrollingPane=null),this._pinchingPane===e&&(this._pinchingPane=null)}startTouch(e){this._activeTouchPanes.add(e)}endTouch(e){
this._activeTouchPanes.delete(e)}hasTouchesOnOtherPanes(e){return this._activeTouchPanes.size>1||1===this._activeTouchPanes.size&&!this._activeTouchPanes.has(e)}trySetDraggingSource(e,t){return!this.hasTouchesOnOtherPanes(t)&&((0,a.assert)(null===this._draggingSource||this._draggingSource===e),this._draggingSource=e,!0)}clearDraggingSource(){null!==this._draggingSource&&(this._draggingSource=null)}draggingSource(){return this._draggingSource}setScrollingPane(e){(0,a.assert)(null===e||null===this._scrollingPane||this._scrollingPane===e),this._scrollingPane=e}scrollingPane(){return this._scrollingPane}setPinchingPane(e){(0,a.assert)(null===e||null===this._pinchingPane||this._pinchingPane===e),this._pinchingPane=e}pinchingPane(){return this._pinchingPane}}var eo=i(806941),to=i(45587);i(717189);const io={contextMenuEnabled:!0,timezoneMenuEnabled:!0,pressedMouseMoveScale:!0},so=new P.TranslatedString("change session",h.t(null,void 0,i(723426))),oo=h.t(null,void 0,i(109956));class ro{constructor(e,t,i,s,o){this._rendererOptions=null,this._onLabelHovered=new g.Delegate,this._mousedown=!1,this._currentCursorClassName="invalid",this._options=(0,n.merge)((0,n.clone)(io),t||{}),this.chart=e,this._properties=e.properties().childs().scalesProperties,this._element=document.createElement("div"),this._element.style.display="flex",this._backgroundBasedTheme=o;const r=e.model().model().rendererOptionsProvider(),a=()=>this.backgroundColor(),l=()=>{throw new Error("Time axis does not support real price scales")},c={titlesProvider:i,stubContextMenuProvider:async(e,t)=>{const i=await s(e,t),o=this.getContextMenuActions(!0);return 0===o.length?i:i.concat(new Vi.Separator,o)},backgroundBasedTheme:o.spawnOwnership(),onActiveOrHoveredChart:(0,F.combine)(((e,t)=>e||t),this.chart.isActive().weakReference(),this.chart.isHovered().weakReference()).ownership(),rendererOptionsProvider:r,getBackgroundTopColor:a,getBackgroundBottomColor:a,requestRepaint:()=>{this.chart.model().model().invalidate(ve.InvalidationMask.timeScale(ve.InvalidationLevel.Light,!0))},showHorizontalBorder:!0};this._lhsStubContainer=new xi(this._properties,"left",l,c,this._options.priceAxisLabelsOptions,this),this._lhsStubContainer.onLabelHovered().subscribe(this,((e,t)=>{this._onLabelHovered.fire(e,t)})),this._rhsStubContainer=new xi(this._properties,"right",l,c,this._options.priceAxisLabelsOptions,this),this._rhsStubContainer.onLabelHovered().subscribe(this,((e,t)=>{this._onLabelHovered.fire(e,t)})),this._element.appendChild(this._lhsStubContainer.getElement()),this._cell=document.createElement("div"),this._element.appendChild(this._cell),this._cell.classList.add("chart-markup-table","time-axis"),this._cell.style.height="25px",this._dv=document.createElement("div"),this._dv.style.width="100%",this._dv.style.height="100%",this._dv.style.position="relative",this._dv.style.overflow="hidden",this._cell.appendChild(this._dv),this._canvasConfiguredHandler=()=>this.chart.model().model().lightUpdate(),this._canvasBinding=(0,Et.createBoundCanvas)(this._dv,(0,nt.size)({width:16,
height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const h=this._canvasBinding.canvasElement;h.style.position="absolute",h.style.zIndex="1",h.style.left="0",h.style.top="0",this._topCanvasBinding=(0,Et.createBoundCanvas)(this._dv,(0,nt.size)({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler);const d=this._topCanvasBinding.canvasElement;d.style.position="absolute",d.style.zIndex="2",d.style.left="0",d.style.top="0",this._dv.setAttribute("aria-hidden","true"),this._element.appendChild(this._rhsStubContainer.getElement()),this.restoreDefaultCursor(),this.update(),this._minVisibleSpan=eo.MINUTE_SPAN,this._mouseEventHandler=new oi.MouseEventHandler(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:!0,treatHorzTouchDragAsPageScroll:!1}),this.size=(0,nt.size)({width:0,height:0})}destroy(){this._mouseEventHandler.destroy(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasConfiguredHandler),this._canvasBinding.dispose(),this._rhsStubContainer.onLabelHovered().unsubscribeAll(this),this._lhsStubContainer.onLabelHovered().unsubscribeAll(this),this._lhsStubContainer.destroy(),this._rhsStubContainer.destroy(),this.chart.properties().childs().paneProperties.childs().background.unsubscribeAll(this),this._backgroundBasedTheme.release()}setCursor(e){let t="";"grabbing"!==e&&"ew-resize"!==e||(t="time-axis--cursor-"+e),this._currentCursorClassName!==t&&(this._currentCursorClassName&&this._cell.classList.remove(this._currentCursorClassName),t&&this._cell.classList.add(t),this._currentCursorClassName=t,this._cell.style.cursor)}restoreDefaultCursor(){this.setCursor("")}getElement(){return this._element}optimalHeight(){const e=this.rendererOptions();return Math.ceil(e.borderSize+e.offsetSize+e.fontSize+e.paddingTop+e.paddingBottom+e.labelBottomOffset)}setSizes(e,t,i){this.size&&(0,nt.equalSizes)(this.size,e)||(this.size=e,this._canvasBinding.resizeCanvasElement(e),this._topCanvasBinding.resizeCanvasElement(e),this._cell.style.width=e.width+"px",this._cell.style.height=e.height+"px"),this._lhsStubContainer.setSizes(e.height,t),this._rhsStubContainer.setSizes(e.height,i)}rendererOptions(){if(!this._rendererOptions||this._rendererOptions.fontSize!==this.fontSize()){const e=this.fontSize();this._rendererOptions={borderSize:1,offsetSize:5,fontSize:e,font:(0,gi.makeFont)(e,yi.CHART_FONT_FAMILY,""),widthCache:new vi.TextWidthCache,paddingTop:3*e/12,paddingBottom:3*e/12,paddingHorizontal:9*e/12,labelBottomOffset:4*e/12}}return this._rendererOptions}backgroundColor(){return this.chart.model().model().backgroundColor().value()}lineColor(){const e=this._properties.childs().lineColor.value();if(0===(0,ii.parseRgba)(e)[3]){const e=this.chart.model().model().lastPane()
;if(e&&e.collapsed().value())return this.chart.properties().childs().paneProperties.childs().separatorColor.value()}return e}textColor(){return this._properties.childs().textColor.value()}fontSize(){return this._properties.childs().fontSize.value()}baseFont(){return(0,gi.makeFont)(this.fontSize(),yi.CHART_FONT_FAMILY)}baseBoldFont(){return(0,gi.makeFont)(this.fontSize(),yi.CHART_FONT_FAMILY,"","bold")}hasCanvas(e){return this._canvasBinding.canvasElement===e||this._topCanvasBinding.canvasElement===e}onLabelHovered(){return this._onLabelHovered}getScreenshotData(){return{content:this._canvasBinding.canvasElement.toDataURL(),canvas:this._canvasBinding.canvasElement,contentWidth:this.size.width,contentHeight:this.size.height,lhsStub:this._lhsStubContainer.getScreenshotData(),rhsStub:this._rhsStubContainer.getScreenshotData()}}getContextMenuActions(e){const t=this.chart,i=t.actions(),s=[];if(e||(t.model().timeScale().resetAvailable().value()&&(s.push(i.timeScaleReset),s.push(new Vi.Separator)),this._options.timezoneMenuEnabled&&s.push(i.applyTimeZone),s.push(i.sessionBreaks)),!t.model().mainSeries().isDWM()){const e=t.model()?.mainSeries().symbolInfo();if(e){const i=t.model().mainSeries().properties().childs().sessionId,o=(e.subsessions||[]).filter((e=>!e.private));if(o.length>1){const e=o.map((e=>new Vi.Action({actionId:"Chart.SetSession",options:{label:(0,to.translateSessionDescription)(e.description),checkable:!0,checked:i.value()===e.id,statName:"SetSession",onExecute:()=>{t.model().setProperty(i,e.id,so)}}}))),r=new Vi.Action({actionId:"Chart.SetSession",options:{label:oo,statName:"SetSession",subItems:e}});s.push(r)}}}return!t.onWidget()&&(0,d.isFeaturesetEnabled)("show_chart_property_page")&&(0,d.isFeaturesetEnabled)("chart_property_page_scales")&&i.scalesProperties&&(s.length&&s.push(new Vi.Separator),s.push(i.scalesProperties)),s}update(){if(!this.chart.hasModel())return;const e=this.chart.model().timeScale().marks();if(e){this._minVisibleSpan=eo.YEAR_SPAN;for(const t of e)this._minVisibleSpan=Math.min(t.span,this._minVisibleSpan)}}updatePriceAxisStubs(){const e=this.chart.model().model(),t=this.chart.hasMaximizedPane()?(0,a.ensureNotNull)(this.chart.maximizedPaneWidget()).state():e.paneForSource(e.mainSeries());if(!t)return;const i=e.priceScaleSlotsCount();this._lhsStubContainer.setScales([],i.left,t.leftPriceScales().length,i.left+i.right),this._rhsStubContainer.setScales([],i.right,t.rightPriceScales().length,i.left+i.right)}paint(e){if(e.level===ve.InvalidationLevel.None||0===this.size.width||0===this.size.height)return;(0,Et.tryApplySuggestedCanvasBitmapSize)(this._canvasBinding),(0,Et.tryApplySuggestedCanvasBitmapSize)(this._topCanvasBinding);const t=(0,Et.getContext2D)(this._topCanvasBinding.canvasElement);if(e.level>ve.InvalidationLevel.Cursor){const i=(0,Et.getContext2D)(this._canvasBinding.canvasElement),s=(0,Et.getBindingRenderingInfo)(this._canvasBinding);this.drawBackground(i,s),this.chart.hasModel()&&(this.drawBorder(i,s),this.drawTickMarks(i,s),this.drawBackLabels(i,s),
this.drawCrossHairLabel(t,s)),this._lhsStubContainer.paintStubs(e),this._rhsStubContainer.paintStubs(e)}this.drawCrossHairLabel(t,(0,Et.getBindingRenderingInfo)(this._topCanvasBinding))}drawBackground(e,t){if((0,Et.clearRect)(e,0,0,t.bitmapSize.width,t.bitmapSize.height,this.backgroundColor()),!this.chart.hasModel())return;const i=this.chart.model();if(!i.timeScale().isEmpty()){const s=i.model().selection().lineDataSources().filter((e=>!e.isFixed())).reduce(((e,t)=>{const i=t.timeAxisPoints();return 0===i.length?e:e.concat(i)}),[]);s.length>0&&this._highlightBackground(e,s,t)}const s=i.model().crosshairSource();s.startMeasurePoint()&&this._highlightBackground(e,s.measurePoints(),t)}drawBorder(e,t){e.save(),e.fillStyle=this.lineColor();const i=Math.max(1,Math.floor(this.rendererOptions().borderSize*t.verticalPixelRatio)),s=t.bitmapSize.width;e.fillRect(0,0,s,i),e.restore()}drawTickMarks(e,t){const i=this.chart.model().timeScale().marks();if(!i||0===i.length)return;let s=i.reduce(((e,t)=>e.span>t.span?e:t),i[0]).span;s>30&&s<40&&(s=30),e.save(),e.strokeStyle=this.lineColor();const o=this.rendererOptions(),r=o.borderSize+o.offsetSize+o.paddingTop+o.fontSize/2;e.textAlign="center",e.textBaseline="middle",e.fillStyle=this.textColor(),(0,Et.drawScaled)(e,t.horizontalPixelRatio,t.verticalPixelRatio,(()=>{e.font=this.baseFont();for(let t=0;t<i.length;t++){const o=i[t];o.span<s&&e.fillText(o.label,o.coord,r)}e.font=this.baseBoldFont();for(let t=0;t<i.length;t++){const o=i[t];o.span>=s&&e.fillText(o.label,o.coord,r)}})),e.restore()}drawBackLabels(e,t){e.save();const i=new Set,s=this.chart.model().model();let o=s.dataSources();const r=s.selection().allSources();for(const e of r)i.add(e);s.hoveredSource()&&i.add(s.hoveredSource());for(const e of s.sourcesBeingMoved())i.add(e);const n=s.customSourceBeingMoved();null!==n&&i.add(n);const a=s.lineBeingEdited()??s.lineBeingCreated();a&&i.add(a),i.add(this.chart.model().crosshairSource()),o=o.concat(s.customSources());const l=this.rendererOptions();for(let s=0;s<o.length;s++){const r=o[s];if(!i.has(r)&&r.timeAxisViews){const i=r.timeAxisViews();if(i)for(let s=0;s<i.length;s++)i[s].renderer().draw(e,t,l)}}e.restore()}drawCrossHairLabel(e,t){e.save(),e.clearRect(0,0,t.bitmapSize.width,t.bitmapSize.height);const i=this.chart.model().model(),s=[],o=i.lineBeingEdited()??i.lineBeingCreated();if(o&&o.timeAxisViews){const e=o.timeAxisViews();e&&e.length&&s.push(e)}const r=i.customSourceBeingMoved();this._addViewsOrMaxMin(null===r?[]:[r],s),this._addViewsOrMaxMin(i.sourcesBeingMoved(),s),this._addViewsOrMaxMin(i.selection().allSources(),s);const n=i.hoveredSource();if(n&&(0,_i.isDataSource)(n)&&!i.selection().isSelected(n)&&n.timeAxisViews){const e=n.timeAxisViews();e&&e.length&&s.push(e)}const a=i.crosshairSource(),l=a.timeAxisViews&&a.timeAxisViews();l&&l.length&&s.push(l);const c=this.rendererOptions();for(const i of s)for(const s of i)e.save(),s.renderer().draw(e,t,c),e.restore();e.restore()}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){
this._mouseOrTouchEnterEvent(e),this._mouseDownOrTouchStartEvent(e)}mouseDownOutsideEvent(){this._outsideMouseDownOrTouchStartEvent()}touchStartOutsideEvent(){this._outsideMouseDownOrTouchStartEvent()}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseUpOrTouchEndEvent(e),this._mouseOrTouchLeaveEvent(e)}contextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}touchContextMenuEvent(e){this._contextMenuOrTouchContextMenuEvent(e)}mouseEnterEvent(e){this._mouseOrTouchEnterEvent(e)}mouseLeaveEvent(e){this._mouseOrTouchLeaveEvent(e)}mouseDoubleClickEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}doubleTapEvent(e){this._mouseDoubleClickOrDoubleTapEvent(e)}_outsideMouseDownOrTouchStartEvent(){this._zoomAvailable()&&this._mousedown&&(this._mousedown=!1,this.chart.model().endScaleTime(),this.restoreDefaultCursor())}_highlightBackground(e,t,i){const s=this.chart.model().timeScale();let o=t[0].index,r=t[0].index;for(let e=1;e<t.length;e++)o=Math.min(o,t[e].index),r=Math.max(r,t[e].index);const{horizontalPixelRatio:n}=i,a=Math.floor(s.indexToCoordinate(o)*n),l=Math.ceil(s.indexToCoordinate(r)*n);(0,Et.fillRect)(e,a,0,l-a,i.bitmapSize.height,this._properties.childs().axisHighlightColor.value())}_addViewsOrMaxMin(e,t){if(e.length<=1){for(const i of e)if(i.timeAxisViews){const e=i.timeAxisViews();e&&e.length&&t.push(e)}}else t.push(this._minMaxViews(e))}_minMaxViews(e){const t=[];let i=1/0,s=-1/0,o=null,r=null;for(const t of e)if(t.timeAxisViews){const e=t.timeAxisViews();if(e&&e.length)for(let t=0;t<e.length;++t){const n=e[t],a=n.coordinate();a>=s&&(s=a,r=n),a<=i&&(i=a,o=n)}}return r&&t.push(r),o&&t.push(o),t}_zoomAvailable(){const e=this.chart.model().model();return!e.timeScale().isEmpty()&&e.zoomEnabled()&&this._options.pressedMouseMoveScale&&!this.chart.chartFloatingTooltipVisible()}_mouseDownOrTouchStartEvent(e){if(this._mousedown||!this._zoomAvailable())return;this._mousedown=!0;const t=this.chart.model();t.timeScale().isEmpty()||t.startScaleTime(e.localX)}_pressedMouseOrTouchMoveEvent(e){this._zoomAvailable()&&this.chart.model().scaleTimeTo(e.localX)}_mouseUpOrTouchEndEvent(e){this._zoomAvailable()&&(this._mousedown=!1,this.chart.model().endScaleTime(),this.restoreDefaultCursor())}_contextMenuOrTouchContextMenuEvent(e){this._options.contextMenuEnabled&&fi.ContextMenuManager.showMenu(this.getContextMenuActions(),e,{statName:"TimeScaleContextMenu"},{menuName:"TimeScaleContextMenu"})}_mouseOrTouchEnterEvent(e){this._zoomAvailable()&&this.setCursor("ew-resize")}_mouseOrTouchLeaveEvent(e){this.restoreDefaultCursor()}_mouseDoubleClickOrDoubleTapEvent(e){(0,_t.trackEvent)("GUI","Double click time scale"),this.chart.model().resetTimeScale()}}var no=i(527323),ao=i.n(no),lo=i(947110),co=(i(813915),i(153599)),ho=i(656713);function uo(e,t){return!!$.Interval.isEqual(e.res,t.res)&&(0,ho.areEqualTimeFrames)(e.val,t.val)}var _o=i(478311);const po={duration:250,
easing:lo.easingFunc.easeOutCubic};class mo{constructor(e){this._onFinishCalled=!1,this._options={...po,...e},this._startTime=performance.now()}getStartPosition(){return this._options.from}getPosition(e){const t=this._calculateProgress(e);return 1===t?(this._options.onFinish&&!this._onFinishCalled&&(this._options.onFinish(!0),this._onFinishCalled=!0),this._options.to):(0,_o.lerp)(this._options.from,this._options.to,this._options.easing(t))}finished(e){return 1===this._calculateProgress(e)}onFinish(e){this._onFinishCalled||(this._options.onFinish?.(e),this._onFinishCalled=!0)}_calculateProgress(e){const t=e-this._startTime;return t>=this._options.duration?1:t/this._options.duration}}var go=i(378588),So=i(461592);function vo(e,t,i,s){let o=null;if(i.currencyConversionEnabled()&&(0,So.isActingAsSymbolSource)(e)){const r=i.availableCurrencies(),n=t.currency(r),a=e.currency();null!==n&&null!==n.selectedCurrency&&!n.allCurrenciesAreOriginal&&n.selectedCurrency!==a&&(s&&null===a||null!==a&&r.convertible(a))&&(o=n.selectedCurrency)}return o}const fo=new P.TranslatedString("toggle collapsed pane state",h.t(null,void 0,i(145366)));class bo extends m.UndoCommand{constructor(e,t){super(fo),this._chartModel=e,this._paneIndex=t}redo(){this._chartModel.toggleCollapsedPane(this._paneIndex)}undo(){this._chartModel.toggleCollapsedPane(this._paneIndex)}}const yo=new P.TranslatedString("toggle maximized pane state",h.t(null,void 0,i(784128)));class wo extends m.UndoCommand{constructor(e,t){super(yo),this._model=e;const i=e.maximizedPane().value(),s=null===i?null:e.panes().indexOf(i);this._maximizedPaneIndex=t===i?null:e.panes().indexOf(t),this._prevMaximizedPaneIndex=s}redo(){this._setMaximizedPane(this._maximizedPaneIndex)}undo(){this._setMaximizedPane(this._prevMaximizedPaneIndex)}_setMaximizedPane(e){this._model.setMaximizedPane(null===e?null:this._model.panes()[e])}}var Co=i(961531),To=i(416464);const Po=new P.TranslatedString("move all scales to left",h.t(null,void 0,i(963551))),Mo=new P.TranslatedString("move all scales to right",h.t(null,void 0,i(791371))),xo=(0,l.getLogger)("Chart.MergeAllScales");class Io extends m.UndoCommand{constructor(e,t,i,s,o,r){super(r),this._model=e,this._paneIndex=e.panes().indexOf(t),this._targetPosition=s,this._targetIndex=o,this._scaleId=i.id(),this._sourcePosition=t.priceScalePosition(i),"overlay"!==this._sourcePosition&&(this._sourceIndex=t.priceScaleIndex(i,this._sourcePosition))}redo(){const e=this._model.panes()[this._paneIndex],t=(0,a.ensureNotNull)(e.getPriceScaleById(this._scaleId));e.movePriceScale(t,this._targetPosition,this._targetIndex),this._model.fullUpdate()}undo(){const e=this._model.panes()[this._paneIndex],t=(0,a.ensureNotNull)(e.getPriceScaleById(this._scaleId));e.movePriceScale(t,this._sourcePosition,this._sourceIndex),this._model.fullUpdate()}}var Lo=i(965947);class Ao extends m.UndoCommand{constructor(e,t,i,s){super(s,void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._createdIds=[],this._actionSourceWasSent=!1,this._model=e,this._withoutShift=i,
this._origStates=t.map((e=>e.state(!0)));const o=e.lineToolsGroupModel();this._origGroups=t.map((e=>{const t=o.groupForLineTool(e);return t&&t.id}))}redo(){const e=this._model.lineToolsGroupModel();let t;this._actionSourceWasSent||(t="Clone",this._actionSourceWasSent=!0);const i=this._origStates.map(((i,s)=>{const o=(0,a.ensureNotNull)(this._model.dataSourceForId(i.id)),r=0===this._createdIds.length?void 0:(0,a.ensureDefined)(this._createdIds[s]),n=(0,Ut.cloneLineTool)(this._model,o,!this._withoutShift,r,t);void 0!==i.sharingMode&&n.share(i.sharingMode);const l=(0,a.ensureNotNull)(o.priceScale());(0,a.ensureNotNull)(this._model.paneForSource(o)).addDataSource(n,l,!1);const c=this._origGroups[s];if(null!==c){const t=e.groupForId(c);t&&t.addLineTools([n])}return this._model.updateSource(n),n}));0===this._createdIds.length&&(this._createdIds=i.map((e=>e.id()))),this._model.selectionMacro((e=>{e.clearSelection(),i.forEach((t=>{e.addSourceToSelection(t)}))})),this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){const e=this._model.lineToolsGroupModel();this._createdIds.forEach((t=>{const i=(0,a.ensureNotNull)(this._model.dataSourceForId(t)),s=e.groupForLineTool(i);null!==s&&s.excludeLineTool(i),this._model.removeSource(i)}))}newIds(){return this._createdIds}}var ko=i(782486),Eo=i(988079),Do=i(863091);class Bo extends m.UndoCommand{constructor(e,t,i,s=!0){super(i,s,(0,Do.sourcesAffectState)(t)),this._newStates=[],this._model=e,this._savedStates=t.map((e=>e.state(!1)))}redo(){this._applyState(this._newStates)}undo(){0===this._newStates.length&&this.saveNewState(),this._applyState(this._savedStates)}saveNewState(){const e=this._savedStates.filter(n.notNull).map((e=>(0,a.ensureNotNull)(this._model.dataSourceForId(e.id))));this._newStates=e.map((e=>e.state(!1)))}_applyState(e){for(const t of e)if(null!==t){const e=this._model.dataSourceForId(t.id);if(null!==e)if((0,Nt.isStudy)(e)){const i=t.state.inputs,s=e.properties().childs().inputs.childs();for(const e in i)s[e]&&s[e].setValue(i[e])}else{const i=e;this._model.restoreLineToolState(i,t,!0),i.synchronizeAlert(!0)}}}}var Ro=i(75266);class Vo extends Ro.MoveSourceUndoCommand{constructor(e,t,i){super(e,t,i)}redo(){const e=(0,a.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),t=(0,a.ensureNotNull)(this._chartModel.paneForSource(e)),i=this._chartModel.children(e,!0,!0);t.bulkActionMacro((()=>{i.forEach((e=>this._chartModel.detachSource(e))),this._chartModel.detachSource(e)}));const s=this._chartModel.createPane(this.targetPaneIndex(e)),o=s.findSuitableScale(e);s.bulkActionMacro((()=>{s.addDataSource(e,o,!1),i.forEach((e=>s.addDataSource(e,o,!1)))}));const r=(0,a.ensureNotNull)(e.priceScale());r.restoreState(this._newPriceScaleState(s.isOverlay(e))),r.setHeight(s.height()),this._chartModel.fullUpdate(),this._chartModel.setShouldBeSavedEvenIfHidden(!0)}undo(){const e=(0,a.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),t=(0,a.ensureNotNull)(this._chartModel.paneForSource(e)),i=this._chartModel.children(e,!0,!0);t.bulkActionMacro((()=>{
i.forEach((e=>this._chartModel.detachSource(e)));const t=this._chartModel.detachSource(e);(0,a.assert)(t,"Undo of detaching must remove pane")}));const s=this._chartModel.panes()[this._initialPaneIndex];let o=s.getPriceScaleById(this._initialPriceScaleId);null===o&&(o=s.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex)),s.bulkActionMacro((()=>{s.addDataSource(e,o,!0),i.forEach((e=>s.addDataSource(e,o,!1)))}));const r=(0,a.ensureNotNull)(e.priceScale());r.restoreState(this._originalPriceScaleState()),r.setHeight(s.height()),this._chartModel.fullUpdate()}}class Oo extends Vo{constructor(e,t,i){super(e,t,i)}targetPaneIndex(e){const t=this._chartModel.panes();if(!t[this._initialPaneIndex].containsMainSeries()||e===this._chartModel.mainSeries())return this._initialPaneIndex+1;for(let e=this._initialPaneIndex+1;e<t.length;e++)if(t[e].mode()===K.PaneMode.Regular)return e<t.length-1&&t[e].containsMainSeries()&&t[e+1].mode()===K.PaneMode.Widget?e+1:e;return t.length}}class No extends Vo{constructor(e,t,i){super(e,t,i)}targetPaneIndex(e){const t=this._chartModel.panes();if(!t[this._initialPaneIndex].containsMainSeries()||e===this._chartModel.mainSeries())return this._initialPaneIndex;for(let e=this._initialPaneIndex-1;e>=0;e--)if(t[e].mode()===K.PaneMode.Regular)return e>0&&t[e].containsMainSeries()&&t[e-1].mode()===K.PaneMode.Widget?e-1:e;return 0}}class Wo extends Vo{constructor(e,t,i){super(e,t,i)}targetPaneIndex(){return this._chartModel.panes().length}}var Fo=i(43977),zo=i(65345),Ho=i(650841),Uo=i(741529),Go=i(47275);const jo=new P.TranslatedString("create {tool}",h.t(null,void 0,i(549986)));class qo extends Uo.LineToolSynchronizeUndoCommand{constructor({model:e,pane:t,lineTool:i,ownerSource:s,drawOnAllChartsMode:o=0,id:r}){super(e,jo.format({tool:new P.TranslatedString(i,Go.lineToolsLocalizedNames[i])}),!1,!Lo.lineToolsDoNotAffectChartInvalidation),this._lineId=null,this._lineState=null,this._paneIndex=e.panes().indexOf(t),this._lineTool=i,this._ownerSourceId=s.id(),this._lineId=r??null,this._drawOnAllChartsMode=o}startCreatingLine(e,t,i,s,o,r){const n=this._chartModel.panes()[this._paneIndex],a=this._chartModel.dataSourceForId(this._ownerSourceId)||void 0,l=this._chartModel.createLineTool({pane:n,point:e,linetool:this._lineTool,properties:t,linkKey:i,sharingMode:s,ownerSource:a,id:this._lineId??void 0,fromExternalModel:o,actionSource:r});return this._lineId=l.id(),this._fromExternalModel=o,!this._chartModel.lineBeingCreated()}continueCreatingLine(e,t,i,s){(0,a.assert)(this._lineId===this._chartModel.lineBeingCreated()?.id(),"Cannot continue not least created line");const o=this._chartModel.continueCreatingLine(e,t,i,s,this._fromExternalModel);return o&&this._chartModel.setShouldBeSavedEvenIfHidden(!0),o}line(){return null===this._lineId?null:this._chartModel.dataSourceForId(this._lineId)}drawOnAllCharts(){return 0!==this._drawOnAllChartsMode}_redo(){if(null===this._lineState)return;const e=this._chartModel.restoreSource(!1,this._paneIndex,null,(0,
a.ensureNotNull)(this._lineState),null);null!==e&&(this._lineId=e.id(),this._lineState=null,e.share(this._drawOnAllChartsMode))}_undo(){const e=this.line();null!==e&&(this._lineState=e.state(!1),this._chartModel.removeSource(e),this._lineId=null)}}var $o=i(870720);const Ko=new P.TranslatedString("bring {title} to front",h.t(null,void 0,i(386522))),Zo=new P.TranslatedString("send {title} to back",h.t(null,void 0,i(501507))),Yo=new P.TranslatedString("insert {title} after {targetTitle}",h.t(null,void 0,i(108602))),Xo=new P.TranslatedString("insert {title} before {targetTitle}",h.t(null,void 0,i(781721))),Jo=new P.TranslatedString("send {title} backward",h.t(null,void 0,i(540038))),Qo=new P.TranslatedString("bring {title} forward",h.t(null,void 0,i(887282))),er=new P.TranslatedString("send group {title} backward",h.t(null,void 0,i(517622))),tr=new P.TranslatedString("bring group {title} forward",h.t(null,void 0,i(602431)));function ir(e){return new P.TranslatedString(e.name(),e.title($o.TitleDisplayTarget.StatusLine))}class sr extends m.UndoCommand{constructor(e,t,i){super(i,void 0,(0,Do.sourcesAffectState)(t)),this._sourcesByPanes=new Map,this._originalState=new Map,this._model=e,t.forEach((t=>{const i=(0,a.ensureNotNull)(e.paneForSource(t)),s=e.panes().indexOf(i),o=this._sourcesByPanes.get(s)||[];o.push(t.id()),this._sourcesByPanes.set(s,o)})),Array.from(this._sourcesByPanes.keys()).forEach((t=>{const i=e.panes()[t],s=new Map,o=new Set(i.sourcesByGroup().multipaneSources());i.sourcesByGroup().allIncludingHidden().filter((e=>!o.has(e))).forEach((e=>{s.set(e.id(),e.zorder())})),this._originalState.set(t,s)}))}undo(){this._originalState.forEach(((e,t)=>{const i=this._model.panes()[t],s=new Map;e.forEach(((e,t)=>{const o=(0,a.ensureNotNull)(i.dataSourceForId(t));s.set(o,e)})),i.setZOrders(s)}))}redo(){this._sourcesByPanes.forEach(((e,t)=>{const i=this._model.panes()[t],s=e.map((e=>(0,a.ensureNotNull)(i.dataSourceForId(e))));this._paneOperation(i,s)}))}}class or extends sr{constructor(e,t){super(e,t,Ko.format({title:ir(t[0])}))}_paneOperation(e,t){e.bringToFront(t)}}class rr extends sr{constructor(e,t){super(e,t,Zo.format({title:ir(t[0])}))}_paneOperation(e,t){e.sendToBack(t)}}class nr extends sr{constructor(e,t,i,s){super(e,t,s),this._targetSource=i}_paneOperation(e,t){e.insertAfter(t,this._targetSource)}}class ar extends nr{constructor(e,t,i){super(e,t,i,Yo.format({title:ir(t[0]),targetTitle:ir(i)}))}}class lr extends sr{constructor(e,t,i,s){super(e,t,s),this._targetSource=i}_paneOperation(e,t){e.insertBefore(t,this._targetSource)}}class cr extends lr{constructor(e,t,i){super(e,t,i,Xo.format({title:ir(t[0]),targetTitle:ir(i)}))}}function hr(e,t){const i=t[0],s=e.sourcesByGroup().all().filter((e=>e.zorder()<i.zorder()));if(0===s.length)throw new Error("Cannot move backward source that already on back");let o=s[s.length-1];if((0,Ut.isLineTool)(o)){const t=e.model().lineToolsGroupModel().groupForLineTool(o);null!==t&&(o=t.lineTools()[0])}return o}class dr extends lr{constructor(e,t,i){super(e,i,hr(t,i),Jo.format({
title:ir(i[0])}))}}function ur(e,t){const i=t[t.length-1],s=e.sourcesByGroup().allExceptSpecialSources().filter((e=>e.zorder()>i.zorder()));if(0===s.length)throw new Error("Cannot bring forward source that already on back");let o=s[0];if((0,Ut.isLineTool)(o)){const t=e.model().lineToolsGroupModel().groupForLineTool(o);if(null!==t){const e=t.lineTools();o=e[e.length-1]}}return o}class _r extends nr{constructor(e,t,i){super(e,i,ur(t,i),Qo.format({title:ir(i[0])}))}}function pr(e,t){return(0,a.ensureNotNull)(e.paneForSource(t.lineTools()[0]))}class mr extends lr{constructor(e,t){super(e,t.lineTools(),hr(pr(e,t),t.lineTools()),er.format({title:t.name().value()}))}}class gr extends nr{constructor(e,t){super(e,t.lineTools(),ur(pr(e,t),t.lineTools()),tr.format({title:t.name().value()}))}}const Sr=new P.TranslatedString("rearrange panes",h.t(null,void 0,i(797491)));class vr extends m.UndoCommand{constructor(e,t,i){if(super(Sr),this._chartModel=e,this._index=t,(0,n.isNumber)(i))this._dstIndex=i;else{const s="up"===i?-1:1;this._dstIndex=t+s,e.panes()[this._dstIndex].mode()===K.PaneMode.Widget&&(this._dstIndex=this._dstIndex+s)}}redo(){this._checkIndices()&&this._chartModel.movePane(this._index,this._dstIndex)}undo(){this._checkIndices()&&this._chartModel.movePane(this._dstIndex,this._index)}_checkIndices(){const e=this._chartModel.panes().length;return this._index>=0&&this._index<e&&this._dstIndex>=0&&this._dstIndex<e}}var fr=i(637581);var br=i(193867),yr=i(110443),wr=i(580837);class Cr extends m.UndoCommand{constructor(e,t,i,s,o,r){super(s),this._prevPriceAxisProps={},this._dependentValues=[],this._intervalChangeWasTracked=!1,this._property=e,this._mainSeries=i,this._value=t,this._model=o,this._chartWidget=r}redo(){const e=this._mainSeries,t=e.properties().childs();this._dependentValues=(0,wr.prepareDependentValues)(this._property),this._prevResolution=t.interval.value(),this._prevValue=this._property.value(),this._storePriceAxisProps(),(0,br.allowSavingDefaults)(!0);const i=t.interval.value(),s=this._model.defaultResolutions(),o=(0,T.getResolutionByChartStyle)(this._value,i,s);this._intervalChangeWasTracked?yr.linking.interval.setValue(o):(yr.linking.setIntervalAndLogInitiator(o,"Chart style"),this._intervalChangeWasTracked=!0),e.setChartStyleWithIntervalIfNeeded(this._value,o),(0,Q.setLastUsedStyle)(this._value,e.symbolInfo()),(0,Q.preparePriceAxisProperties)(t),(0,br.allowSavingDefaults)(!1),this._invalidateModel(),this._chartWidget.screen.show(!0)}undo(){const e=this._mainSeries;(0,br.allowSavingDefaults)(!0),e.setChartStyleWithIntervalIfNeeded(this._prevValue,this._prevResolution),this._restorePriceAxisProps(),yr.linking.interval.setValue(this._prevResolution),(0,wr.restoreDependentValues)(this._property,this._dependentValues),(0,br.allowSavingDefaults)(!1),this._invalidateModel(),this._chartWidget.screen.show(!0)}_storePriceAxisProps(){const e=this._mainSeries.priceScale();this._prevPriceAxisProps=e.mode()}_restorePriceAxisProps(){this._mainSeries.priceScale().setMode(this._prevPriceAxisProps)}_invalidateModel(){
this._model&&(this._model.recalculateAllPanes((0,Ds.sourceChangeEvent)(this._model.mainSeries().id())),this._model.lightUpdate())}}const Tr=new P.TranslatedString("change date range",h.t(null,void 0,i(247014)));class Pr extends m.UndoCommand{constructor(e,t){super(Tr),this._modelsData=[],this._rangeOptions=t,this._modelsData.push({model:e,prevResolution:e.mainSeries().properties().childs().interval.value(),barSpacing:e.timeScale().barSpacing(),rightOffset:e.timeScale().rightOffset(),rangeOptions:e.appliedTimeFrame().value()})}redo(){for(const e of this._modelsData){const t=e.model.mainSeries(),i=t.properties().childs().interval;$.Interval.isEqual(this._rangeOptions.res,i.value())?t.loadDataTo(this._rangeOptions.val):(t.setDefaultTimeframe(this._rangeOptions.val),t.setSymbolParams({interval:this._rangeOptions.res}))}}undo(){for(const e of this._modelsData){const t=e.model.mainSeries(),i=t.properties().childs().interval;e.prevResolution!==i.value()?(null!==e.rangeOptions&&t.setDefaultTimeframe(e.rangeOptions.val),t.setSymbolParams({interval:e.prevResolution})):null!==e.rangeOptions&&t.loadDataTo(e.rangeOptions.val);const s=e.model.timeScale();s.setBarSpacing(e.barSpacing),s.setRightOffset(e.rightOffset)}}canMerge(e){return e instanceof Pr&&uo(e._rangeOptions,this._rangeOptions)}merge(e){if(!(e instanceof Pr))throw new Error("Invalid command to merge");this._modelsData=this._modelsData.concat(e._modelsData)}}function Mr(e){return e.properties().visible.value()}function xr(e){return!Mr(e)}class Ir{constructor(e,t,i){this._instanceId=(0,ot.randomHashN)(6),this._onChanged=new g.Delegate,this._lineToolsSet=new Set,this._lineTools=[...e],this._lineToolsSet=new Set(this._lineTools),this._name=new H.WatchedValue(t),this.id=i||(0,ot.randomHashN)(6)}instanceId(){return this._instanceId}lineTools(){return this._lineTools}name(){return this._name}setName(e){this._doAndFireOnChange((()=>{this._name.setValue(e)}))}isActualSymbol(){return this._lineTools.length>0&&this._lineTools[0].isActualSymbol()&&this._lineTools[0].isActualCurrency()&&this._lineTools[0].isActualUnit()}symbol(){return this._lineTools[0].symbol()}currencyId(){return this._lineTools[0].properties().childs().currencyId.value()??null}unitId(){return this._lineTools[0].properties().childs().unitId.value()??null}isSynchronizable(){return this._lineTools.some((e=>e.isSynchronizable()))}sharingMode(){return this._lineTools[0].sharingMode()}share(e){this._lineTools.forEach((t=>t.share(e)))}containsLineTool(e){return this._lineToolsSet.has(e)}addLineTools(e){this._doAndFireOnChange((t=>{e.forEach((e=>this._lineToolsSet.add(e))),this._lineTools.push(...e),t.push(...e.map((e=>e.id())))}))}excludeLineTool(e){this._doAndFireOnChange((t=>{this._lineToolsSet.delete(e);const i=this._lineTools.indexOf(e);this._lineTools.splice(i,1),t.push(e.id())}))}excludeLineTools(e){this._doAndFireOnChange((t=>{const i=new Set(e);e.forEach((e=>this._lineToolsSet.delete(e))),this._lineTools=this._lineTools.filter((e=>!i.has(e))),t.push(...e.map((e=>e.id())))}))}state(){return{id:this.id,
name:this._name.value(),tools:this._lineTools.map((e=>e.id()))}}visibility(){const e=this._lineTools.some(Mr),t=this._lineTools.some(xr);return e&&!t?"Visible":t&&!e?"Invisible":"Partial"}locked(){const e=this._lineTools.some((e=>e.properties().frozen.value())),t=this._lineTools.some((e=>!e.properties().frozen.value()));return e&&!t?"Locked":t&&!e?"Unlocked":"Partial"}isActualInterval(){const e=this._lineTools.some((e=>e.isActualInterval())),t=this._lineTools.some((e=>!e.isActualInterval()));return e&&!t?"IsActualInterval":t&&!e?"IsNotActualInterval":"Partial"}onChanged(){return this._onChanged}static fromState(e,t){const i=[];for(const s of t.tools){const t=e.dataSourceForId(s);null!==t&&i.push(t)}return i.length>0?new Ir(i,t.name,t.id):null}_doAndFireOnChange(e){const t=[],i=this.visibility(),s=this.locked(),o=this.isActualInterval();e(t),this._onChanged.fire({affectedLineTools:t,visibilityChanged:i!==this.visibility(),lockedChanged:s!==this.locked(),isActualIntervalChanged:o!==this.isActualInterval()})}}i(686923);class Lr extends m.UndoCommand{constructor(e,t,i){super(i,void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._model=e,this._groupId=t.id,this._groupName=t.name().value(),this._lineToolsIds=t.lineTools().map((e=>e.id()))}redo(){const e=(0,a.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId));this._model.lineToolsGroupModel().removeGroup(e)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))),t=new Ir(e,this._groupName,this._groupId);this._model.lineToolsGroupModel().addGroup(t)}}const Ar=new P.TranslatedString("create line tools group",h.t(null,void 0,i(288797)));class kr extends m.UndoCommand{constructor(e,t){super(Ar,void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._groupId=null,this._model=e,this._sourcesIds=t.map((e=>e.id()))}redo(){const e=this._sourcesIds.map((e=>this._model.dataSourceForId(e))),t=null===this._groupId?void 0:this._groupId;this._groupId=this._model.lineToolsGroupModel().createGroup(e,this._title,t).id}undo(){const e=(0,a.ensureNotNull)(this._model.lineToolsGroupModel().groupForId((0,a.ensureNotNull)(this._groupId)));this._model.lineToolsGroupModel().removeGroup(e)}createdGroupId(){return this._groupId}}const Er=new P.TranslatedString("add line tool(s) to group {group}",h.t(null,void 0,i(439590)));class Dr extends m.UndoCommand{constructor(e,t,i){super(Er.format({group:t.name().value()}),void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._model=e,this._groupId=t.id,this._lineToolsIds=i.map((e=>e.id()))}redo(){const e=(0,a.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)),t=this._lineToolsIds.map((e=>this._model.dataSourceForId(e)));e.addLineTools(t)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e)));(0,a.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)).excludeLineTools(e)}}class Br extends m.UndoCommand{constructor(e,t,i,s){super(s,void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._chartModel=e,this._groupId=t.id,this._oldName=t.name().value(),
this._newName=i}redo(){(0,a.ensureNotNull)(this._chartModel.lineToolsGroupModel().groupForId(this._groupId)).setName(this._newName)}undo(){(0,a.ensureNotNull)(this._chartModel.lineToolsGroupModel().groupForId(this._groupId)).setName(this._oldName)}}class Rr extends m.UndoCommand{constructor(e,t,i,s){super(s,void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._model=i,this._id=e.id(),this._targetSharingMode=t,this._originSharingMode=e.sharingMode().value()}redo(){const e=this._model.dataSourceForId(this._id);e?.isSynchronizable()&&(e.share(this._targetSharingMode),0!==this._targetSharingMode&&0===this._originSharingMode&&(e.linkKey().setValue((0,ot.randomHash)()),this._model.copyToOtherCharts([e],!1)))}undo(){const e=this._model.dataSourceForId(this._id);e?.isSynchronizable()&&(e.share(this._originSharingMode),0===this._originSharingMode&&((0,D.removeLineTool)({withUndo:!1,model:this._model,symbol:e.symbol(),linkKey:(0,a.ensureNotNull)(e.linkKey().value()),sourceTitle:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e),lineToolState:e.state(!1),unlink:!0}),e.linkKey().setValue(null)))}}const Vr=new P.TranslatedString("create line tools group from selection",h.t(null,void 0,i(134558))),Or=new P.TranslatedString("removing line tools group {name}",h.t(null,void 0,i(666140))),Nr=new P.TranslatedString("add line tool {lineTool} to group {name}",h.t(null,void 0,i(689580))),Wr=new P.TranslatedString("make group {group} visible",h.t(null,void 0,i(356541))),Fr=new P.TranslatedString("make group {group} invisible",h.t(null,void 0,i(572334))),zr=new P.TranslatedString("lock group {group}",h.t(null,void 0,i(706308))),Hr=new P.TranslatedString("unlock group {group}",h.t(null,void 0,i(952523))),Ur=new P.TranslatedString("rename group {group} to {newName}",h.t(null,void 0,i(385310)));class Gr{constructor(e){this._environment=e}createGroupFromSelection(){const e=this._environment.model();(0,a.assert)(!e.selection().isEmpty(),"Cannot create group from empty selection");const t=(0,zo.sortSources)(e.selection().lineDataSources());(0,a.assert)(t.length===e.selection().allSources().length,"A group could contain line tools only");const i=t.length>1||null!==this._environment.model().lineToolsGroupModel().groupForLineTool(t[0]),s=t.reduce(((e,t)=>e.zorder()>t.zorder()?e:t),t[0]);let o=s;const r=e.lineToolsGroupModel().groupForLineTool(s);if(null!==r){const e=r.lineTools();o=e[e.length-1]}this._environment.beginUndoMacro(Vr);const n=new Map,l=new Set;t.forEach((t=>{const i=this._groupForLineTool(t);if(null===i)return;const s=n.get(i)||[];s.push(t),n.set(i,s);const o=(0,a.ensureNotNull)(e.paneForSource(t));l.add(o)})),(0,a.assert)(l.size<=1,"All selected sources should be on the same pane"),n.forEach(((t,i)=>{const s=new Eo.ExcludeLineToolsFromGroupUndoCommand(e,i,t);this._environment.pushUndoCommand(s)}));const c=new kr(e,(0,zo.sortSources)(t));if(this._environment.pushUndoCommand(c),i){const i=new ar(e,t,o);this._environment.pushUndoCommand(i)}this._environment.endUndoMacro();const h=(0,
a.ensureNotNull)(c.createdGroupId());return(0,a.ensureNotNull)(e.lineToolsGroupModel().groupForId(h))}removeGroup(e){const t=this._environment.model(),i=e.lineTools();this._environment.beginUndoMacro(Or.format({name:e.name().value()}));const s=new Lr(t,e,null);this._environment.pushUndoCommand(s);const o=new ko.RemoveSourcesUndoCommand(t,i,null);this._environment.pushUndoCommand(o);const r=t.mainSeries().symbol();i.forEach((e=>{null!==e.linkKey().value()&&(0,D.removeLineTool)({withUndo:!0,model:t,symbol:r,sourceTitle:new P.TranslatedString(e.name(),e.title($o.TitleDisplayTarget.DataWindow)),lineToolState:e.state(!1),linkKey:(0,a.ensureNotNull)(e.linkKey().value())})})),this._environment.endUndoMacro()}groups(){return this._environment.model().lineToolsGroupModel().groups()}excludeLineToolFromGroup(e,t){const i=this._environment.model(),s=new Eo.ExcludeLineToolsFromGroupUndoCommand(i,e,[t]);this._environment.pushUndoCommand(s)}addLineToolToGroup(e,t){const i=this._environment.model(),s=i.lineToolsGroupModel().groupForLineTool(t);if(s===e)return;const o=Nr.format({lineTool:new P.TranslatedString(t.name(),t.title($o.TitleDisplayTarget.StatusLine)),name:e.name().value()});this._environment.beginUndoMacro(o),null!==s&&this._environment.pushUndoCommand(new Eo.ExcludeLineToolsFromGroupUndoCommand(i,s,[t]));{const s=e.sharingMode().value();t.sharingMode().value()!==s&&this._environment.pushUndoCommand(new Rr(t,s,i,null))}this._environment.pushUndoCommand(new Dr(i,e,[t])),this._environment.endUndoMacro()}bringToFront(e){const t=this._environment.model(),i=new or(t,e.lineTools());this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}sendToBack(e){const t=this._environment.model(),i=new rr(t,e.lineTools());this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}bringForward(e){const t=this._environment.model(),i=new gr(t,e);this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}sendBackward(e){const t=this._environment.model(),i=new mr(t,e);this._environment.pushUndoCommand(i),this._environment.emitEvent("changeZOrder",[e.lineTools()])}insertAfter(e,t){const i=this._environment.model();let s;if(t instanceof Ir){const e=t.lineTools();s=e[e.length-1]}else s=t;const o=new ar(i,e.lineTools(),s);this._environment.pushUndoCommand(o),this._environment.emitEvent("changeZOrder",[e.lineTools()])}insertBefore(e,t){const i=this._environment.model();let s;if(t instanceof Ir){s=t.lineTools()[0]}else s=t;const o=new cr(i,e.lineTools(),s);this._environment.pushUndoCommand(o),this._environment.emitEvent("changeZOrder",[e.lineTools()])}availableZOrderOperations(e){const t=this._environment.model(),i=e.lineTools(),s=i[0],o=i[i.length-1],r=(0,a.ensureNotNull)(t.paneForSource(i[0])).sourcesByGroup().allExceptSpecialSources(),n=r[0],l=r[r.length-1];return{bringForwardEnabled:o!==l,bringToFrontEnabled:o!==l,sendBackwardEnabled:s!==n,sendToBackEnabled:s!==n}}setGroupVisibility(e,t){const i=(t?Wr:Fr).format({
group:e.name().value()}),s=this._environment.model();this._environment.beginUndoMacro(i),e.lineTools().forEach((e=>{const i=e.properties().visible,o=new wr.SetPropertyUndoCommand(i,t,null,s,!Lo.lineToolsDoNotAffectChartInvalidation);this._environment.pushUndoCommand(o)})),this._environment.endUndoMacro()}setGroupLock(e,t){const i=(t?zr:Hr).format({group:e.name().value()}),s=this._environment.model();this._environment.beginUndoMacro(i),e.lineTools().forEach((e=>{const i=e.properties().frozen,o=new wr.SetPropertyUndoCommand(i,t,null,s,!Lo.lineToolsDoNotAffectChartInvalidation);this._environment.pushUndoCommand(o)})),this._environment.endUndoMacro()}setGroupName(e,t){const i=this._environment.model(),s=Ur.format({group:e.name().value(),newName:t}),o=new Br(i,e,t,s);this._environment.pushUndoCommand(o)}canBeGroupped(e){const t=this._environment.model();return new Set(e.map((e=>t.paneForSource(e)))).size<=1}_groupForLineTool(e){return this._environment.model().lineToolsGroupModel().groups().find((t=>t.containsLineTool(e)))||null}}var jr=i(430916),qr=i(17147),$r=i(917273);const Kr=new P.TranslatedString("apply study template {template}",h.t(null,void 0,i(381513)));function Zr(e){for(const t of e.panes)for(const e of t.sources)if((0,q.isMainSeriesState)(e))return e.id;return null}class Yr extends m.UndoCommand{constructor(e,t,i,o){super(Kr.format({template:i})),this._newSymbolParams={},this._hasAlreadyBeenUndone=!1,this._model=e,this._templateContent=function(e,t){const i=(0,s.default)({},e),o=(0,a.ensureNotNull)(Zr(i));for(const e of i.panes){e.mainSourceId===o&&(e.mainSourceId=t);for(const i of e.sources)if(i.id===o){i.id=t;const s=e=>{const i=e.indexOf(o);-1!==i&&e.splice(i,1,t)};if(e.leftAxisesState&&e.rightAxisesState?(e.leftAxisesState.forEach((e=>s(e.sources))),e.rightAxisesState.forEach((e=>s(e.sources)))):(s(e.leftAxisSources),s(e.rightAxisSources)),e.overlayPriceScales){const i=e.overlayPriceScales[o];i&&(delete e.overlayPriceScales[o],e.overlayPriceScales[t]=i)}}else i.ownerSource===o&&(i.ownerSource=t)}return i}(t,e.mainSeries().id()),this._initialState=e.studyTemplate(!0,!0,!0),this._eventSource=o;const r=e.mainSeries();t.symbol&&(this._newSymbolParams={symbol:t.symbol,currency:t.currency??null,unit:t.unit??null}),t.interval&&(this._newSymbolParams.interval=t.interval,this._newSymbolParams.style=(0,Q.getChartStyleByResolution)(t.interval,r.style())),this._initialSymbolParams={symbol:r.symbol(),currency:r.currency(),unit:r.unit(),interval:r.interval(),style:r.style()},this._initialState=e.studyTemplate(),this._initialGroupsState=e.lineToolsGroupModel().state()}redo(){this._model.mainSeries().setSymbolParams(this._newSymbolParams);const e=this._merge(this._templateContent,this._hasAlreadyBeenUndone?2:0).filter(Ut.isLineTool);this._model.lineToolsGroupModel().removeLineTools(e);const t=this._model.mainSeries().properties();(0,Q.preparePriceAxisProperties)(t),this._model.recalcVisibleRangeStudies(di.RecalcVisibleRangeStudiesReason.StudyCreation),this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){
this._model.mainSeries().setSymbolParams(this._initialSymbolParams),this._merge(this._initialState,1),this._hasAlreadyBeenUndone=!0}_merge(e,t){const i=e.version||0,s=this._model,o=s.mainSeries();(0,a.assert)(o.id()===Zr(e)),o.priceScale().properties().childs().lockScale.setValue(!1);const r=s.panes(),l=[];for(let e=r.length;e--;){const t=r[e],i=t.containsMainSeries(),s=t.dataSources();for(let e=s.length;e--;){const t=s[e];(!i||((0,Nt.isStudy)(t)||(0,Nt.isStudyStub)(t))&&t.isRemovedByStudyTemplates())&&l.push(t)}}s.resetDeferredStudies();const c=0===t?this._eventSource:1===t?"undo":this._eventSource?`redo_${this._eventSource}`:"redo",h=(0,jr.closeSourcesSet)(s,l,!0);for(let e=0;e<h.length;++e){const t=h[e];(0,Nt.isStudy)(t)&&(0,qr.trackStudies)(t.metaInfo(),t.model(),"remove",c),s.removeSource(t)}const d=e.panes;let u=0;for(let e=0;e<d.length;e++){let t=-1;const o=(0,n.clone)(d[e]);o.sources.sort(((e,t)=>e.zorder-t.zorder));for(let e=0;e<o.sources.length;e++){const i=o.sources[e];if((0,q.isMainSeriesState)(i)&&(delete i.state,t=e),(0,q.isStudyState)(i)){const e=new et.StudyMetaInfo(i.metaInfo);(0,qr.trackStudies)(e,s,"add",c)}}const l=t>-1,h=l?r[e-u]:s.createPane(e-u);if(l&&i<3&&(0,$r.reorderDataSourcesStateZOrder)(o.sources),h.restoreState({state:o,withData:!1,version:i,isStudyTemplate:!0}),null!==h.mainDataSource()){const e=(0,a.ensureNotNull)(this._model.alertsWatcher());for(const t of h.dataSources())e.syncSourceAlertLabels(t)}else u++,s.removePane(h)}return s.syncLollipopSources(),o.priceScale().setMode({autoScale:!0}),s.startNotStartedStudies(),s.recalculateAllPanes((0,Ds.globalChangeEvent)()),s.fullUpdate(),h}}const Xr=(0,l.getLogger)("Chart.ChartUndoModel"),Jr=new P.TranslatedString("paste drawing",h.t(null,void 0,i(837066)));class Qr extends m.UndoCommand{constructor(e,t,i,s,o){super(Jr,void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._needCopyToOtherCharts=!1,this._sourceState=null,this._actionSourceWasSent=!1,this._model=e,this._clipboardData=t,this._paneIndex=this._model.panes().indexOf(i||(0,a.ensureNotNull)(this._model.paneForSource(this._model.mainSeries()))),this._pasteWithData=!!s,this._keepZIndex=!!o}redo(){const e=this._model.panes()[this._paneIndex],t=(0,a.ensureNotNull)(e.clipboardLineToolOwnerSource(this._clipboardData.source.id)),i=t===this._model.mainSeries();let s;null===this._sourceState&&(this._sourceState=this._getSourceState(t,i)),this._actionSourceWasSent||(s="Paste",this._actionSourceWasSent=!0);const o=(0,a.ensureNotNull)(e.restoreLineTool({state:this._sourceState,withData:this._pasteWithData,keepZOrder:this._keepZIndex,ownerSource:t,actionSource:s}));(0,a.ensureNotNull)(t.priceScale()).addDataSource(o),this._clipboardData.centeredOnChart&&o.centerPosition&&o.centerPosition(),o.restoreFixedPoint(),o.createServerPoints(),this._needCopyToOtherCharts=Boolean(i&&o.isSynchronizable()&&0!==o.sharingMode().value()),this._model.setShouldBeSavedEvenIfHidden(!0)}undo(){if(!this._sourceState)return void Xr.logError("This command was never executed - nothing to undo");const e=this.source()
;this._clipboardData.centeredOnChart&&(this._clipboardData.centeredOnChart=!1,this._sourceState.points=e.normalizedPoints()),this._model.removeSource(e)}source(){return(0,a.ensureNotNull)(this._model.dataSourceForId((0,a.ensureNotNull)(this._sourceState).id))}needCopyToOtherCharts(){return this._needCopyToOtherCharts}_getSourceState(e,t){const i=(0,n.clone)(this._clipboardData.source);delete i.state.symbol,t?(null!=i.linkKey||void 0!==i.sharingMode&&0!==i.sharingMode)&&(i.linkKey=(0,ot.randomHash)()):(i.linkKey=null,i.sharingMode=0);const s=(0,a.ensureNotNull)(e.priceScale()),o=this._model,{symbol:r,currencyId:l,unitId:c}=this._clipboardData.source.state,h=(0,a.ensureNotNull)(e.symbolSource());let d=!1;!h.symbolSameAsCurrent(r)||(null!==l?l!==(0,Q.symbolCurrency)(h.symbolInfo(),void 0,!0):h.isConvertedToOtherCurrency())||(null!==c?c!==(0,Q.symbolUnit)(h.symbolInfo(),this._model.unitConversionEnabled()):h.isConvertedToOtherUnit())||((0,So.isActingAsSymbolSource)(e)?d=!0:(0,Nt.isStudy)(e)&&(d=Boolean(e.metaInfo().is_price_study))),i.state.currencyId=o.currencyConversionEnabled()&&h.isConvertedToOtherCurrency()?h.currency():null,i.state.unitId=o.unitConversionEnabled()&&h.isConvertedToOtherUnit()?h.unit():null;const u=e=>{const t=e.x*o.timeScale().width(),i=e.y*s.height()-40;return new dt.Point(t,i)},_=(0,a.ensureNotNull)(e.firstValue());if(this._model.id()===this._clipboardData.modelId||!d){for(let e=0;e<this._clipboardData.geometry.length;++e){const t=u(this._clipboardData.geometry[e]),r=o.timeScale().coordinateToIndex(t.x),n=o.timeScale().normalizeBarIndex(r);if(d){const t=s.priceToCoordinate(i.points[e].price,_)+-40;n.price=s.coordinateToPrice(t,_)}else n.price=s.coordinateToPrice(t.y,_);i.points[e]=n}i.state.interval=o.mainSeries().interval()}return i.id=(0,ot.randomHashN)(6),i}}class en extends m.UndoCommand{constructor(e,t,i,s){super(s),this._newSourcesCurrencies=new Map,this._oldSourcesCurrencies=new Map,this._showFade=!1,this._chartModel=e;const o=e.mainSeries();for(const e of t.seriesLikeSources()){if(!e.isVisible()||!e.isActingAsSymbolSource().value())continue;const t=i||(0,Q.symbolOriginalCurrency)((0,a.ensureNotNull)(e.symbolInfo()));this._newSourcesCurrencies.set(e.id(),t),this._oldSourcesCurrencies.set(e.id(),e.currency()),this._showFade=this._showFade||e===o&&e.currency()!==t}}redo(){this._applyCurrencies(this._newSourcesCurrencies)}undo(){this._applyCurrencies(this._oldSourcesCurrencies)}_applyCurrencies(e){e.forEach(((e,t)=>{(0,a.ensureNotNull)(this._chartModel.dataSourceForId(t)).setCurrency(e)})),this._chartModel.selectionMacro((e=>{e.clearSelection()})),this._showFade&&this._chartModel.undoModel().loadingScreen().show(!0)}}class tn extends m.UndoCommand{constructor(e,t,i,s){super(s),this._newSourcesUnits=new Map,this._oldSourcesUnits=new Map,this._showFade=!1,this._chartModel=e;const o=e.mainSeries();for(const e of t.seriesLikeSources()){if(!e.isVisible()||!e.isActingAsSymbolSource().value())continue;const t=i||(0,Q.symbolOriginalUnit)((0,
a.ensureNotNull)(e.symbolInfo()),this._chartModel.unitConversionEnabled());this._newSourcesUnits.set(e.id(),t),this._oldSourcesUnits.set(e.id(),e.unit()),this._showFade=this._showFade||e===o&&e.unit()!==t}}redo(){this._applyUnits(this._newSourcesUnits)}undo(){this._applyUnits(this._oldSourcesUnits)}_applyUnits(e){e.forEach(((e,t)=>{(0,a.ensureNotNull)(this._chartModel.dataSourceForId(t)).setUnit(e)})),this._chartModel.selectionMacro((e=>{e.clearSelection()})),this._showFade&&this._chartModel.undoModel().loadingScreen().show(!0)}}var sn=i(112511);class on extends m.UndoCommand{constructor(e,t,i,s){super(e),this._charts=new Map,this._firstRedo=!0,this._creationTime=performance.now(),this._linkingGroupIndex=s.linkingGroupIndex().value(),this._charts.set(s,{sourceId:t.id(),newSymbolParams:i,prevSymbolParams:t.symbolParams(),showFade:this._showFade(t,s),chartWidget:s})}redo(){this._firstRedo||(0,u.muteLinkingGroup)(this._linkingGroupIndex,!0),this._charts.forEach((e=>{const t=this._symbolSource(e).setSymbolParams(e.newSymbolParams);e.showFade&&e.chartWidget.screen.show(!0,t)})),this._firstRedo||(0,u.muteLinkingGroup)(this._linkingGroupIndex,!1),this._firstRedo=!1}undo(){(0,u.muteLinkingGroup)(this._linkingGroupIndex,!0),this._charts.forEach((e=>{const t=this._symbolSource(e).setSymbolParams(e.prevSymbolParams);e.showFade&&e.chartWidget.screen.show(!0,t)})),(0,u.muteLinkingGroup)(this._linkingGroupIndex,!1)}canMerge(e){if(!(e instanceof on)||e._linkingGroupIndex!==this._linkingGroupIndex||!this._containsMainSeriesOnly()||!e._containsMainSeriesOnly()||e._creationTime-this._creationTime>500)return!1;for(const[t]of e._charts)if(this._charts.has(t))return!1;return!0}merge(e){if(e instanceof on)for(const[t,i]of e._charts)this._charts.set(t,i)}_showFade(e,t){return e===t.model().mainSeries()}_symbolSource(e){return(0,a.ensureNotNull)(e.chartWidget.model().model().dataSourceForId(e.sourceId))}_containsMainSeriesOnly(){for(const[e,t]of this._charts)if(t.sourceId!==e.model().mainSeries().id())return!1;return!0}}const rn=new P.TranslatedString("change symbol",h.t(null,void 0,i(18769)));class nn extends on{constructor(e,t,i){super(rn,e,{symbol:t,currency:null,unit:null},i),this._symbol=t}canMerge(e){return e instanceof nn&&e._symbol===this._symbol&&super.canMerge(e)}}var an=i(436492);const ln=(0,l.getLogger)("Chart.ChartUndoModel"),cn=new P.TranslatedString("paste indicator",h.t(null,void 0,i(763339)));class hn extends m.UndoCommand{constructor(e,t,i){super(cn),this._sourceState=null,this._hasAlreadyBeenUndone=!1,this._model=e,this._clipboardData=t,this._paneId=i}redo(){if(!this._sourceState){const e=(0,an.default)(this._clipboardData.source);e.id=(0,ot.randomHashN)(6),this._sourceState=e}let e,t;e=this._paneId?(0,a.ensureNotNull)(this._model.paneForId(this._paneId)):this._sourceState.metaInfo.is_price_study?(0,a.ensureNotNull)(this._model.paneForSource(this._model.mainSeries())):this._model.createPane();const i=!e.mainDataSource();this._sourceState.zorder=e.newStudyZOrder();const s=(0,a.ensureNotNull)(e.restoreStudy({
source:this._sourceState}));if(i||(t=this._sourceState.metaInfo.is_price_study?t=this._model.mainSeries().priceScale():this._paneId?e.findSuitableScale(s):e.defaultPriceScale(),t!==s.priceScale()&&e.move(s,t)),(0,Nt.isStudy)(s)||(0,Nt.isStudyStub)(s)){{const e=this._hasAlreadyBeenUndone?"redo_paste":"paste";(0,qr.trackStudies)(new et.StudyMetaInfo(this._sourceState.metaInfo),s.model(),"add",e)}s.start()}}undo(){if(null===this._sourceState)return void ln.logError("This command was never executed - nothing to undo");const e=(0,a.ensureNotNull)(this._model.dataSourceForId(this._sourceState.id));this._model.removeSource(e)}state(){return this._sourceState}}class dn extends m.UndoCommand{constructor(e,t,i,s,o){super(null,!1),this._model=e,this._paneA=t,this._paneB=i,this._prevStretchA=s,this._currStretchA=o}redo(){const e=this._paneA.stretchFactor()+this._paneB.stretchFactor();this._paneA.setStretchFactor(this._currStretchA),this._paneB.setStretchFactor(e-this._currStretchA),this._model.fullUpdate()}undo(){const e=this._paneA.stretchFactor()+this._paneB.stretchFactor();this._paneA.setStretchFactor(this._prevStretchA),this._paneB.setStretchFactor(e-this._prevStretchA),this._model.fullUpdate()}}const un=new P.TranslatedString("move",h.t(null,void 0,i(965790)));class _n extends m.UndoCommand{constructor(e,t,i,s){super(un,!1),this._endEvent=null,this._model=e,this._sourceId=t.id(),this._itemIndex=i,this._startEvent=s}move(e){this._endEvent=e,this._move(e)}hasChanges(){return null!==this._endEvent}undo(){this._move(this._startEvent)}redo(){this._move((0,a.ensureNotNull)(this._endEvent))}_move(e){const t=(0,a.ensureNotNull)(this._model.dataSourceForId(this._sourceId));(0,a.assert)(void 0!==t.moveItem,'The method "moveItem" is not defined'),t.moveItem&&t.moveItem(new dt.Point(e.localX,e.localY),this._itemIndex,new ui.EnvironmentState(e))}}var pn=i(302500);class mn extends m.UndoCommand{constructor(e,t,i,s){super(i),this._newMode=e,this._priceScaleId=t.id(),this._model=s,this._oldMode=t.mode()}redo(){this._applyMode(this._newMode)}undo(){this._applyMode(this._oldMode)}_applyMode(e){const t=this._findPriceScaleById();null!==t&&((0,br.allowSavingDefaults)(!0),t.setMode(e),(0,br.allowSavingDefaults)(!1),this._model&&(this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this._model.lightUpdate()))}_findPriceScaleById(){const e=this._model.panes();for(let t=0;t<e.length;t++){const i=e[t].getPriceScaleById(this._priceScaleId);if(null!==i)return i}return null}}var gn=i(88434),Sn=i(389315),vn=i(645303),fn=i(724226),bn=i(298147),yn=i(172137),wn=i(464303);const Cn=["color-tv-blue-400","color-iguana-green-a700","color-tan-orange-500","color-sky-blue-400","color-berry-pink-a700","color-banana-yellow-700","color-minty-green-a400","color-berry-pink-a200","color-tv-blue-a100","color-grapes-purple-a700","color-ripe-red-a400","color-minty-green-500","color-grapes-purple-a100","color-deep-blue-a200","color-tan-orange-800"];class Tn{constructor(e,t=Cn){this._userDefaultUsed=!1,this._calcColorOffset=e,this._colors=t}getColor(e,t=!1){
const i=this._calcColorOffset();if(0===i&&(this._userDefaultUsed=!1),0===i&&!t)return this._userDefaultUsed=!0,e;const s=this._colors[(i-(this._userDefaultUsed?1:0))%this._colors.length],o=ai.colorsPalette[s],r=(0,Li.isHexColor)(e)?1:(0,ii.parseRgba)(e)[3];return(0,Li.generateColor)(o,(0,Li.alphaToTransparency)(r))}}class Pn{constructor(e,t){this._calcColorOffset=e,this._modelStartOffset=t}getColor(e){const t=this._calcColorOffset();if((0,Li.isHexColor)(e)){const i=(0,ii.parseRgb)(e);return(0,ii.rgbToHexString)((0,ii.shiftRgb)(i,t,this._modelStartOffset))}{const i=(0,ii.parseRgba)(e);return(0,ii.rgbaToString)((0,ii.shiftRgba)(i,t,this._modelStartOffset))}}}class Mn{constructor(e){this._rotators=new WeakMap,this._calcDefaultColorsOffset=e=>{const t=(0,Nt.useSameColorRotationComparator)(e);return this._chartModel.dataSources().filter((i=>(0,Nt.isStudy)(i)&&t(e,i.metaInfo()))).length},this._chartModel=e}getColorRotator(e){if(this._rotators.has(e)){const t=this._rotators.get(e);if(void 0!==t)return t}const t=this._createColorRotator(e);return this._rotators.set(e,t),t}_createColorRotator(e){const t=()=>this._calcDefaultColorsOffset(e);switch((0,Nt.studyColorRotationMode)(e)){case"loop":return new Tn(t);case"shift":return new Pn(t,this._chartModel.getStudyShiftColorStartOffset());case null:case"noRotations":return null}}}function xn(e){return(0,Ut.isLineTool)(e)&&e.boundToSymbol()||(0,Ii.isAlertLabel)(e)}class In{constructor(){this._items=[],this._set=new Set,this._dataSourcesCache=null,this._customSourcesCache=null,this._lineSourcesCache=null}isEmpty(){return 0===this._items.length}add(e){if(this._items.length>0&&!xn(this._items[0])&&this.clear(),xn(e)){const t=(0,J.lowerbound)(this._items,e,((e,t)=>e.zorder()<t.zorder()));this._items.splice(t,0,e)}else this.clear(),this._items=[e];this._set.add(e),this._invalidateCache()}canBeAddedToSelection(e){return 0===this._items.length||xn(this._items[0])&&xn(e)}isSelected(e){return this._set.has(e)}allSources(){return this._items.slice(0)}dataSources(){return null===this._dataSourcesCache&&(this._dataSourcesCache=this._items.filter(_i.isDataSource)),this._dataSourcesCache}lineDataSources(){return null===this._lineSourcesCache&&(this._lineSourcesCache=this._items.filter(Ut.isLineTool)),this._lineSourcesCache}customSources(){return null===this._customSourcesCache&&(this._customSourcesCache=this._items.filter((e=>!(0,_i.isDataSource)(e)))),this._customSourcesCache}checkLineToolSelection(){this._items.forEach((e=>(0,Ut.isLineTool)(e)&&e.calcIsActualSymbol())),this._items=this._items.filter((e=>!(0,Ut.isLineTool)(e)||e.isActualSymbol())),this._invalidateCache()}remove(e){this._items=this._items.filter((t=>t!==e)),this._set.delete(e),this._invalidateCache()}clear(){this._items=[],this._set.clear(),this._invalidateCache()}_invalidateCache(){this._customSourcesCache=null,this._dataSourcesCache=null,this._lineSourcesCache=null}}var Ln=i(252792),An=i(7255);class kn{constructor(e){this._rendererOptions={borderSize:1,additionalPaddingInner:0,fontSize:NaN,font:"",color:"",
paneBackgroundColor:"",paddingBottom:0,paddingInner:0,paddingOuter:0,paddingTop:0,lineSpacing:0},this._chartModel=e}options(){const e=this._rendererOptions,t=this._chartModel.properties().childs(),i=t.scalesProperties.childs().fontSize.value();return e.fontSize!==i&&(e.fontSize=i,e.font=(0,gi.makeFont)(i,yi.CHART_FONT_FAMILY,""),e.paddingTop=i/12*2.5,e.paddingBottom=i/12*2.5,e.paddingInner=i/12*4,e.additionalPaddingInner=i/12*4,e.paddingOuter=i/12*4,e.lineSpacing=i/12*2),e.color=t.scalesProperties.childs().textColor.value(),e.paneBackgroundColor=t.paneProperties.childs().background.value(),this._rendererOptions}}var En=i(253193),Dn=i(759499);const Bn=(0,br.extractThemedColors)(ut.lightTheme.content.sessions,ut.darkTheme.content.sessions);const Rn=["graphics","sessionHighlight.backgrounds.preMarket.visible","sessionHighlight.backgrounds.preMarket.available","sessionHighlight.backgrounds.postMarket.visible","sessionHighlight.backgrounds.postMarket.available","sessionHighlight.backgrounds.electronic.visible","sessionHighlight.backgrounds.electronic.available","sessionHighlight.vertLines.sessBreaks.available"];class Vn extends br.DefaultProperty{constructor(e){super({defaultName:"sessions",themedColors:Bn,excludedDefaultsKeys:[...Rn],excludedStateKeys:[...Rn],excludedTemplateKeys:[...Rn]}),this._symbolInfo=e,this._symbolInfo.subscribe((()=>this._updateGraphicsProps())),this.hasChild("graphics")||this.addProperty("graphics",{}),this.merge({sessionHighlight:{vertlines:{sessBreaks:{available:!0}},backgrounds:{preMarket:{visible:!0,available:!0},postMarket:{visible:!0,available:!0},electronic:{visible:!0,available:!0},outOfSession:{visible:!0,available:!0}}}}),this._updateGraphicsProps(),this.childs().sessionHighlight.subscribe(this,(()=>{this._updateGraphicsProps()}))}destroy(){this._symbolInfo.release(),super.destroy()}restoreState(e){const t=e.properties;!function(e){const t=e,i="graphics"in e?e.graphics.backgrounds:void 0;if(void 0!==i){const e=(0,a.ensureDefined)(i.outOfSession);e.color===Dn.sessionsPreferencesDefault.sessionHighlight.backgrounds.outOfSession.color||"postMarket"in i?(t.sessionHighlight=t.sessionHighlight??{},t.sessionHighlight.backgrounds=i):(t.sessionHighlight=t.sessionHighlight??{},t.sessionHighlight.backgrounds={...t.sessionHighlight?.backgrounds??{},postMarket:{color:e.color,transparency:e.transparency,visible:!0,available:!0},preMarket:{color:e.color,transparency:e.transparency,visible:!0,available:!0}})}const s="graphics"in e?e.graphics.vertlines:void 0;s&&(t.sessionHighlight??={},t.sessionHighlight.vertlines=s),(0,br.cleanUpStateKeys)(t,Rn)}(t),"graphics"in e.properties&&((0,s.default)(e.properties.sessionHighlight,e.properties.graphics),delete e.properties.graphics),this.mergeAndFire(t),this.removeDuplicateProperties()}loadThemeState(e){"graphics"in e&&((0,s.default)(e.sessionHighlight,e.graphics),delete e.graphics),this.mergeAndFire(e)}removeDuplicateProperties(){this.hasChild("properties")&&(this.removeProperty("properties"),(0,br.allowSavingDefaults)(!0),this.fireChanged(),(0,
br.allowSavingDefaults)(!1))}_userSettings(){const e=super._userSettings();return e&&!e.sessionHighlight&&(e.sessionHighlight=e.graphics),delete e?.graphics,e}_updateGraphicsProps(){const e=this._symbolInfo.value();e&&(this.childs().graphics.mergeAndFire(this.childs().sessionHighlight.state()),function(e){const t=e.subsessions?.filter((e=>!e.private)).map((e=>e.id))??[];return"futures"===e.type&&t.includes("regular")&&t.includes("us_regular")}(e)&&((0,a.ensureDefined)(this.childs().graphics.childs().backgrounds).childs().preMarket.mergeAndFire(this.childs().sessionHighlight.childs().backgrounds.childs().electronic.state()),(0,a.ensureDefined)(this.childs().graphics.childs().backgrounds).childs().postMarket.mergeAndFire(this.childs().sessionHighlight.childs().backgrounds.childs().electronic.state())))}}class On extends yn.AsyncResourceWrapper{constructor(e,t,i){super(e,(e=>e.destroy())),this._sessionsStateData=null,this._model=t,this._properties=i,t.mainSeries().dataEvents().symbolResolved().subscribe(this,this._updateVisibleOfPreAndPostMarketBackground),this._updateVisibleOfPreAndPostMarketBackground(),e.then((e=>{!this._destroyed&&this._sessionsStateData&&(e.restoreStateData(this._sessionsStateData),this._sessionsStateData=null)}))}destroy(){this._model.mainSeries().dataEvents().symbolResolved().unsubscribeAll(this),super.destroy()}properties(){return this._properties}applyOverrides(e){(0,En.applyPropertiesOverrides)(this._properties.childs().sessionHighlight,void 0,!1,e,"sessions");const t=this.get();t&&this._model.updateSource(t)}state(e){const t={properties:this._properties.state()};return e&&(t.data=this.get()?.stateData()??this._sessionsStateData??void 0),t}restoreState(e,t){if(e.oldState&&(e=function(e,t){const i={properties:{graphics:e.state.graphics}};return void 0!==e.data&&void 0!==e.metaInfo&&t&&(i.data={metaInfo:e.metaInfo,graphics:e.data.graphics}),i}(e,t)),this._properties.restoreState(e),this._updateVisibleOfPreAndPostMarketBackground(),this._sessionsStateData=null,void 0!==e.data&&t){const t=this.get();t?t.restoreStateData(e.data):this._sessionsStateData=e.data}}_updateVisibleOfPreAndPostMarketBackground(){const e=this._model.mainSeries().symbolInfo();if(e){const t=this._properties.childs().sessionHighlight.childs(),{preMarket:i,postMarket:s,electronic:o,outOfSession:r}=t.backgrounds.childs(),{sessBreaks:n}=t.vertlines.childs(),a=e.subsession_id,l=a&&(0,Q.isRegularSessionId)(a,e),c=(0,Q.symbolHasPreOrPostMarket)(e),h="futures"===e.type&&(0,Q.symbolHasElectronicSession)(e);i.childs().available.setValue(c&&!l),s.childs().available.setValue(c&&!l),o.childs().available.setValue(h&&!l),r.childs().available.setValue((c||h)&&!l),n.childs().available.setValue(!0)}}}var Nn=i(725408);const Wn="symbolWatermark",Fn={ticker:!1,interval:!1,description:!1,custom:!1,replay:!0,color:""},zn="rgba(80, 83, 94, 0.25)",Hn=["rgba(80, 83, 94, 0.20)","rgba(80, 83, 94, 0.30)"];function Un(){const e=R.getJSON(Wn)||{};return{...Fn,...Gn(e)}}function Gn(e){const{color:t,visibility:i,...s}=e,r={...s}
;return void 0!==i&&(r.ticker=s.ticker??i,r.interval=s.interval??i,r.description=s.description??i,r.custom=s.custom??i),(0,o.default)(t)&&t!==zn&&(r.color=t),r}class jn extends Ct.Property{constructor(e,t){super(e),this._defaultColors=t}value(e){const t=super.value();return void 0===e||t&&t.length>0?t:this._getDefaultColor(e)}_getDefaultColor(e){const[t,i]=this._defaultColors;return e===vn.StdTheme.Light?t:i}}const qn=(0,at.default)((()=>{const{color:e,...t}=Un(),i=new Ct.Property({...Fn,...t},(0,Nn.createPropertySchema)(Fn));return i.addChild("color",new jn(e,Hn)),R.onSync.subscribe(null,(()=>i.mergeAndFire(Un()))),i.subscribe(null,(()=>R.setJSON(Wn,i.state()))),i}));var $n=i(904003),Kn=i(640156),Zn=i(332157),Yn=i(741863),Xn=i(449616),Jn=i(851682);class Qn extends Jn.MediaCoordinatesPaneRenderer{constructor(){super(...arguments),this._data=null,this._widthCache=new vi.TextWidthCache}setData(e){this._data=e}hitTest(e){return null}_drawImpl(e){if(!this._data)return;const{lines:t,color:i}=this._data,{context:s,mediaSize:{width:o,height:r}}=e;let n=0;const a=[],l=t.filter((e=>!!e.text)),c=l.length;for(let e=0;e<c;e++){const t=l[e],{font:i,lineHeight:r}=ea(t,0===e,o<Xn.mobileFirstBreakpoints["media-mf-tablet-vertical"]),{width:c,paddingRight:h}=ta(t.icon,0===e,o<Xn.mobileFirstBreakpoints["media-mf-tablet-vertical"]);s.font=i;const d=this._widthCache.measureText(s,t.text)+c+h+16,u=d>o?o/d:1;a.push(u),n+=r*u+4}let h=Math.max((r-n)/2,0);s.fillStyle=i;for(let e=0;e<c;e++){const t=l[e],i=a[e],{font:r,lineHeight:n,vertOffset:c}=ea(t,0===e,o<Xn.mobileFirstBreakpoints["media-mf-tablet-vertical"]);try{s.save(),s.font=r,s.textBaseline="top",s.textAlign="left";const{icon:a,text:l}=t,{width:d,paddingRight:u,path:_}=ta(a,0===e,o<Xn.mobileFirstBreakpoints["media-mf-tablet-vertical"]),p=this._widthCache.measureText(s,l)+d+u;if(s.translate((o-i*p)/2,h),s.scale(i,i),_){const e={x:0,y:(n-d)/2};try{s.translate(e.x,e.y),s.fill(_,"evenodd")}finally{s.translate(-e.x,-e.y)}}s.translate(d+u,0),s.fillText(l,0,c),h+=n*i+4}finally{s.restore()}}}}function ea(e,t,i){return"getFontMetrics"in e?e.getFontMetrics(t,i):e}function ta(e,t,i){return void 0===e?ia:(0,Yn.default)(e)?e(t,i):e}const ia={width:0,paddingRight:0},sa=new Path2D("M28 54C42.3594 54 54 42.3594 54 28C54 13.6406 42.3594 2 28 2C13.6406 2 2 13.6406 2 28C2 42.3594 13.6406 54 28 54ZM26 16V28V40L14 28L26 16ZM26 28L38 40V16L26 28Z"),oa=sa,ra=(0,mi.scalePath2D)(sa,.785714286),na=(0,mi.scalePath2D)(sa,.5),aa="Sans-serif";function la(e,t){return e.value(t)}class ca{constructor(e,t){this._renderer=new Qn,this._invalidated=!0,this._model=e,this._watermark=t}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}_updateImpl(){const{ticker:e,interval:t,description:s,custom:o,replay:r}=this._watermark.properties().state(),a=this._model.backgroundTheme().value(),l=this._model.mainSeries(),c=l.aliasSymbolInfo(),d=r&&l.isInReplay().value(),u=null;if(!c||!(u?o:e||t||s||d))return void this._renderer.setData(null);if(u){const e=u({
symbolInfo:c,interval:l.interval()}),t=e?.map((e=>({text:e.text,font:(0,gi.makeFont)(e.fontSize,aa),lineHeight:e.lineHeight,vertOffset:e.vertOffset})));return void this._renderer.setData({color:la(this._watermark.properties().childs().color,a),lines:t??[]})}let _=c.name;if(/QUANDL/.test(c.exchange)){const e=_.split(/\//);e.length&&(_=e[e.length-1])}const p={description:c.description,short_description:c.short_description,pro_name:c.pro_name,short_name:c.name,local_description:c.local_description,language:c.language},m=[e?_:null,t?(0,Zn.translatedIntervalString)(l.interval()):null].filter(n.notNull),g=[{text:_?m.join(", "):""},{text:s&&(0,Kn.getTranslatedSymbolDescription)(p)||""},{text:d&&h.t(null,void 0,i(893028))||"",icon:ha}].filter((e=>e.text.length>0)).map((({text:e,icon:t})=>({text:e,icon:t,getFontMetrics:da})));this._renderer.setData({color:la(this._watermark.properties().childs().color,a),lines:g})}}const ha=(0,$n.default)((function(e,t){return t?e?{path:ra,width:44,paddingRight:12}:{path:na,width:28,paddingRight:8}:e?{path:oa,width:56,paddingRight:16}:{path:na,width:28,paddingRight:12}}),((e,t)=>`${e}-${t}`));const da=(0,$n.default)((function(e,t){const[i,s,o]=ua[t?e?2:3:e?0:1];return{font:(0,gi.makeFont)(i,aa),lineHeight:s,vertOffset:o}}),((e,t)=>`${e}-${t}`)),ua={0:[80,80,6],1:[36,44,8],2:[48,48,4],3:[28,36,6]},_a="symbolWatermark";class pa extends Ho.DataSource{constructor(e){super(),this._updateSource=()=>{this._model.updateSource(this)},this._model=e,this._properties=qn(),(0,En.applyDefaultsOverrides)(this._properties,void 0,!1,_a),this._properties.subscribe(this,this._updateSource),this._model.backgroundTheme().subscribe(this._updateSource),this._paneView=new ca(e,this)}destroy(){this._model.backgroundTheme().unsubscribe(this._updateSource),this._properties.unsubscribe(this,this._updateSource),super.destroy()}model(){return this._model}name(){return"watermark"}properties(){return this._properties}restorePropertiesDefaults(){qn().mergeAndFire(Fn)}applyOverrides(e){(0,En.applyPropertiesOverrides)(this._properties,void 0,!1,function(e){const{visibility:t,...i}=e,s={...i};return void 0!==t&&(s.ticker=t,s.interval=t,s.description=t,s.custom=t),s}(e),_a)}paneViews(){return[this._paneView]}updateAllViews(e){super.updateAllViews(e),this._paneView.update()}contextMenuStatName(){return"WatermarkContextMenu"}}var ma=i(641422),ga=i(813006);class Sa extends ga.PropertyBase{constructor(e){super(),this._model=e}destroy(){this._listeners.destroy()}getStepChangeValue(){return.1}getMinValue(){return 1e-7}getMaxValue(){return 99999999}value(){return this._model.mainSeriesScaleRatio()}setValue(e,t){(e!==this.value()||t)&&(this._model.setMainSeriesScaleRatio(e),this.fireChanged())}setValueSilently(e){e!==this.value()&&this._model.setMainSeriesScaleRatio(e)}state(){return null}clone(){return new Sa(this._model)}storeStateIfUndefined(){return!0}weakReference(){return(0,ma.weakReference)(this)}ownership(){return(0,ma.ownership)(this)}}var va=i(920174),fa=i(958734);class ba{constructor(e,t){this._map1=new Map,
this._map2=new Map,this._getter1=e,this._getter2=t}add(e){const t=this._getter1(e),i=this._getter2(e);this._map1.set(t,e),this._map2.set(i,t)}getByKey1(e){return this._map1.get(e)??null}getByKey2(e){const t=this._map2.get(e);return void 0===t?null:this._map1.get(t)??null}removeByKey1(e){const t=this._map1.get(e);void 0!==t&&(this._map1.delete(e),this._map2.delete(this._getter2(t)))}removeByKey2(e){const t=this._map2.get(e);void 0!==t&&(this._map2.delete(e),this._map1.delete(t))}}var ya=i(97063),wa=i(387607),Ca=i(500686),Ta=i(520244),Pa=i(658273);function Ma(e,t,i){return i.hasDataSource(t)?La(t,i)===e:!!i.isMainPane().value()&&La(i.model().mainSeries(),i)===e}const xa=new Map([["price",e=>(0,bs.isPriceDataSource)(e)],["trading",e=>(0,Ut.isTrading)(e)],["drawing",e=>(0,Ut.isLineTool)(e)&&!(0,Ut.isTrading)(e)&&!e.isPhantom()],["drawingsForAllSymbols",e=>(0,Ut.isLineTool)(e)&&!(0,Ut.isTrading)(e)&&!e.isPhantom()],["phantom",e=>(0,Ut.isLineTool)(e)&&e.isPhantom()],["restRowSources",e=>!(0,Ut.isLineTool)(e)&&!(0,Ut.isTrading)(e)],["legendViewSources",(e,t)=>t.hasDataSource(e)&&((0,bs.isPriceDataSource)(e)||(0,Gt.isStudyLineTool)(e))],["leftPriceScale",Ma.bind(null,"left")],["rightPriceScale",Ma.bind(null,"right")],["overlayPriceScale",Ma.bind(null,"overlay")],["multipane",(e,t)=>!t.hasDataSource(e)],["allWithoutMultipane",(e,t)=>t.hasDataSource(e)],["allWithoutMultipaneWithHidden",(e,t)=>t.hasDataSource(e)],["plotSource",(e,t)=>(0,Pa.isSeries)(e)||(0,Nt.isStudy)(e)&&t.hasDataSource(e)&&!e.isSpeciallyZOrderedSource()],["objectTree",(e,t)=>{if((0,Ut.isLineTool)(e)){const i=e.targetSignature().value();if(null!==i)return t.hasDataSourceWithSignature(i)}return t.hasDataSource(e)}]]),Ia=new Map([["price","visibleSorted"],["trading","visibleSorted"],["drawing","visibleSorted"],["drawingsForAllSymbols","allSorted"],["phantom","visibleSorted"],["restRowSources","visibleSorted"],["legendViewSources","visibleSorted"],["leftPriceScale","visibleSorted"],["rightPriceScale","visibleSorted"],["overlayPriceScale","visibleSorted"],["multipane","visibleSorted"],["allWithoutMultipane","visibleSorted"],["allWithoutMultipaneWithHidden","allSorted"],["plotSource","visibleSorted"],["objectTree","visibleSorted"]]);function La(e,t){const i=e.priceScale();return null===i?"overlay":t.priceScalePosition(i)}function Aa(e){let t=null;return{sources:e,hasSource:i=>(null===t&&(t=new Map(e.map((e=>[e.id(),e])))),t.has(i.id()))}}class ka{constructor(e){this._groupedSources=new Map,this._sources=null,this._pane=e}clear(){this._groupedSources.clear(),this._sources=null}destroy(){this.clear()}all(){return this._groupedSources.has("visibleSorted")||this._sortSources(),(0,a.ensureDefined)(this._groupedSources.get("visibleSorted")).sources}allIncludingHidden(){return this._groupedSources.has("allSorted")||this._sortSources(),(0,a.ensureDefined)(this._groupedSources.get("allSorted")).sources}allWithoutMultipane(){return this._getSourcesByGroupType("allWithoutMultipane")}allWithoutMultipaneWithHidden(){
return this._getSourcesByGroupType("allWithoutMultipaneWithHidden")}objectTreeSources(){return this._getSourcesByGroupType("objectTree")}hasObjectTreeSource(e){return this._getGroupedSourcesByGroupType("objectTree").hasSource(e)}visibleExceptSpecialSources(){if(!this._groupedSources.has("visibleExceptSpecial")){const e=this.all().filter((e=>!e.isSpeciallyZOrderedSource()));this._groupedSources.set("visibleExceptSpecial",Aa(e))}return(0,a.ensureDefined)(this._groupedSources.get("visibleExceptSpecial")).sources}allExceptSpecialSources(){if(!this._groupedSources.has("exceptSpecial")){const e=this.allIncludingHidden().filter((e=>!e.isSpeciallyZOrderedSource()));this._groupedSources.set("exceptSpecial",Aa(e))}return(0,a.ensureDefined)(this._groupedSources.get("exceptSpecial")).sources}tradingSources(){return this._getSourcesByGroupType("trading")}priceSources(){return this._getSourcesByGroupType("price")}plotSources(){return this._getSourcesByGroupType("plotSource")}lineSources(){return this._getSourcesByGroupType("drawing")}hasLineSource(e){return this._getGroupedSourcesByGroupType("drawing").hasSource(e)}lineSourcesForAllSymbols(){return this._getSourcesByGroupType("drawingsForAllSymbols")}phantomSources(){return this._getSourcesByGroupType("phantom")}allExceptLineAndTradingSources(){return this._getSourcesByGroupType("restRowSources")}hitTestSources(){if(!this._groupedSources.has("hitTest")){const e=this.allExceptLineAndTradingSources().concat(this.lineSources());this._groupedSources.set("hitTest",Aa((0,zo.sortSources)(e,this._pane)))}return(0,a.ensureDefined)(this._groupedSources.get("hitTest")).sources}generalSources(){if(!this._groupedSources.has("general")){const e=this.allExceptLineAndTradingSources().concat(this.lineSources());this._groupedSources.set("general",Aa((0,zo.sortSources)(e,this._pane)))}return(0,a.ensureDefined)(this._groupedSources.get("general")).sources}leftPriceScalesSources(){return this._getSourcesByGroupType("leftPriceScale")}rightPriceScalesSources(){return this._getSourcesByGroupType("rightPriceScale")}overlayPriceScaleSources(){return this._getSourcesByGroupType("overlayPriceScale")}multipaneSources(){return this._getSourcesByGroupType("multipane")}legendViewSources(){return this._getSourcesByGroupType("legendViewSources")}_getSourcesByGroupType(e){return this._getGroupedSourcesByGroupType(e).sources}_getGroupedSourcesByGroupType(e){const t=(0,a.ensureDefined)(Ia.get(e));return this._groupedSources.has(t)?this._groupedSources.has(e)||this._groupSources(e):(this._sortSources(),this._groupSources(e)),(0,a.ensureDefined)(this._groupedSources.get(e))}_sortSources(){null===this._sources&&(this._sources=this._pane.dataSources());const e=this._pane.model().multiPaneSources(this._pane),t=(0,zo.sortSources)(this._sources.concat(e),this._pane),i=t.filter((e=>!(0,Ut.isLineTool)(e)||e.isActualSymbol()&&e.isActualCurrency()&&e.isActualUnit()&&e.isActualMetric()));this._groupedSources.set("allSorted",Aa(t)),this._groupedSources.set("visibleSorted",Aa(i))}_groupSources(e){const t=(0,
a.ensureDefined)(Ia.get(e)),i=xa.get(e);if(void 0!==i){const s=(0,a.ensureDefined)(this._groupedSources.get(t)).sources.filter((e=>i(e,this._pane)));this._groupedSources.set(e,Aa(s))}}}var Ea=i(834905),Da=i(323197);function Ba(e,t,i){const s=(0,Q.symbolUnitConvertibleGroupsIfExist)(e,!0);if(null!==s)return s;const o=i.unitGroupById(t);return null===o?[]:[o]}function Ra(e,t,i,s){let o=null;if(i.unitConversionEnabled()&&(0,So.isSymbolSource)(e)){const r=i.availableUnits(),n=t.unit(r),a=e.unit(),l=null===a?[]:Ba(e.symbolInfo(),a,r);null!==n&&null!==n.selectedUnit&&!n.allUnitsAreOriginal&&n.selectedUnit!==a&&(s&&null===a||null!==a&&r.convertible(a,l))&&(o=n.selectedUnit)}return o}var Va=i(712745);function Oa(e,t,i){const s=e.div(t).toNumber();return Math.abs(Math.round(s)-s)<i}const Na=[2,5],Wa=[5,2];class Fa{constructor(e,t,i){if(this._base=e,this._integralDividers=t,(0,si.isBaseDecimal)(e))this._fractionalDividers=[2,2.5,2];else{this._fractionalDividers=[];const e=i?Na:Wa;for(let t=this._base;1!==t;){if(t%e[0]==0)this._fractionalDividers.push(e[0]),t/=e[0];else{if(t%e[1]!=0)throw new Error("unexpected base");this._fractionalDividers.push(e[1]),t/=e[1]}if(this._fractionalDividers.length>100)throw new Error("something wrong with base")}}}tickSpan(e,t,i){const s=0===this._base?0:1/this._base,o=Math.min(1e-14,(e-t)/1e3);let r=Math.pow(10,Math.max(0,Math.ceil((0,si.log10)(e-t))));if(!isFinite(r))return 1e305;let n=0,a=this._integralDividers[0];for(;;){const e=(0,si.greaterOrEqual)(r,s,o)&&r>s+o,t=(0,si.greaterOrEqual)(r,i*a,o),l=(0,si.greaterOrEqual)(r,1,o),c=new Va.Big(r).div(a),h=0===s||Oa(c,s,o);if(!(e&&t&&l&&h))break;r=c.toNumber(),a=this._integralDividers[++n%this._integralDividers.length]}if(r<=s+o&&(r=s),r=Math.max(1,r),this._fractionalDividers.length>0&&(0,si.equal)(r,1,o))for(n=0,a=this._fractionalDividers[0];;){const e=(0,si.greaterOrEqual)(r,i*a,o)&&r>s+o,t=new Va.Big(r).div(a),l=0===s||Oa(t,s,o);if(!e||!l)break;r=t.toNumber(),a=this._fractionalDividers[++n%this._fractionalDividers.length]}return r}}class za{constructor(e,t,i,s){this._marks=null,this._priceScale=e,this._base=t,this._coordinateToLogicalFunc=i,this._logicalToCoordinateFunc=s}base(){return this._base}setBase(e){if(e<0)throw new Error("base < 0");this._base=e}tickSpan(e,t,i=0){if(e<t)throw new Error("high < low");const s=this._priceScale.height(),o=this._tickMarkHeight(),r=(e-t)*o/s,n=[new Fa(this._base,[2,2.5,2],!0),new Fa(this._base,[2,2,2.5],!0),new Fa(this._base,[2.5,2,2],!0),new Fa(this._base,[2,2.5,2],!1),new Fa(this._base,[2,2,2.5],!1),new Fa(this._base,[2.5,2,2],!1)].reduce(((s,o)=>{const n=o.tickSpan(e,t,r);return n>i?Math.min(n,s):s}),1/0);return n>0&&isFinite(n)?n:e-t}rebuildTickMarks(){this._marks=null}marks(){return null===this._marks&&(this._marks=this._rebuildTickMarksImpl()),this._marks}_fontHeight(){return this._priceScale.fontSize()}_tickMarkHeight(){return Math.ceil(2.5*this._fontHeight())}_rebuildTickMarksImpl(){const e=this._priceScale,t=[],i=e.mainSource();if(e.isEmpty()||!e.hasCalculatedPriceRange()||null===i)return t
;let s=i.firstValue();null===s&&(s=0);const o=e.height(),r=this._coordinateToLogicalFunc(o-1,s),n=this._coordinateToLogicalFunc(0,s),a=Math.max(r,n),l=Math.min(r,n);if(a===l)return t;let c=this.tickSpan(a,l),h=a%c;h+=h<0?c:0;const d=a>=l?1:-1;let u=null;const _=e.formatter();let p=NaN;for(let i=a-h;i>l;i-=c){i===p&&(c=this.tickSpan(a,l,c)),p=i;const o=this._logicalToCoordinateFunc(i,s);null!==u&&Math.abs(o-u)<this._tickMarkHeight()||(t.push({coord:o,label:_.format(i)}),u=o,e.isLog()&&(c=this.tickSpan(i*d,l)))}return t}}var Ha=i(605434),Ua=i(807211);(0,d.isFeaturesetEnabled)("hide_price_scale_if_all_sources_hidden");const Ga=(0,Ua.getPercentageFormatter)(),ja=new Ha.PriceFormatter({priceScale:100,minMove:1}),qa={autoScale:!0,autoScaleDisabled:!1,lockScale:!1,percentage:!1,percentageDisabled:!1,log:!1,logDisabled:!1,alignLabels:!0,isInverted:!1,indexedTo100:!1};class $a{constructor(e,t){this._marksCache=null,this._onMarksChanged=new g.Delegate,this.m_dataSources=[],this._sourcesForAutoscale=null,this._sourcesThatAffectVisibility=[],this._hasSeries=!1,this._studiesCount=0,this._drawingCount=0,this._seriesLikeSources=[],this._priceDataSources=[],this._mainSource=null,this._lastSourceRemoved=new g.Delegate,this._scaleSeriesOnly=!1,this._invalidatedForRange={isValid:!0,visibleBars:null,logicalRange:null},this._priceRange=null,this._hasCalculatedPriceRange=!1,this._logFormula=(0,Da.logFormulaForBase)(null),this.m_height=0,this._margins={top:0,bottom:0},this._correctedMarginsCache=null,this._topPixelMargin=0,this._bottomPixelMargin=0,this._internalHeightCache=null,this._internalHeightChanged=new g.Delegate,this._priceRangeSnapshot=null,this._scrollStartPoint=null,this._currencyCache=null,this._unitCache=null,this._measureUnitIdCache=null,this._metricCache=null,this._recalculatePriceRangeOnce=!1,this._cachedOrderedSoruces=null,this._scaleStartPoint=null,this._twoPointsScaleStartPosition=null,this._maxPriceRange=null,this._minPriceRange=null,this._priceRangeChanged=new g.Delegate,this._modeChanged=new g.Delegate,this._sourcesToUpdateViews=null,this._markBuilder=new za(this,100,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this)),this._formatter=null,this._resetScaleAvailable=new H.WatchedValue(!1),this._id="",this._isVisible=new H.WatchedValue(!0),t=Object.assign({},qa,t),this._properties=new Ct.Property(t),this._boundOnSourceIsActingAsSymbolSourceChanged=this._onSourceIsActingAsSymbolSourceChanged.bind(this),this._scalesProperties=e,this._properties.childs().isInverted.subscribe(this,this._onIsInvertedChanged),this._properties.subscribe(null,(()=>{const e=this.mainSource();if(e&&e.model()){const t=e.model().paneForSource(e);t&&e.model().updatePane(t)}})),this._scalesProperties.subscribe(this,(()=>{this._marksCache=null})),this._properties.childs().lockScale.subscribe(this,this._updateResetAvailableValue),this._properties.childs().autoScale.subscribe(this,this._updateResetAvailableValue),this._updateResetAvailableValue(),this.setId((0,ot.randomHash)())}id(){return this._id}setId(e){this._id=e}isLog(){
return this._properties.childs().log.value()}isPercentage(){return this._properties.childs().percentage.value()}isInverted(){return this._properties.childs().isInverted.value()}isIndexedTo100(){return this._properties.childs().indexedTo100.value()}isAutoScale(){return this._properties.childs().autoScale.value()&&!this.isLockScale()}isLockScale(){return this._properties.childs().lockScale.value()}isRegular(){return!this.isPercentage()&&!this.isLog()&&!this.isIndexedTo100()}isScaleSeriesOnly(){return this._scaleSeriesOnly}properties(){return this._properties}height(){return this.m_height}setHeight(e){this.m_height!==e&&(this.m_height=e,this._invalidateInternalHeightCache(),this._marksCache=null)}internalHeight(){if(this._internalHeightCache)return this._internalHeightCache;const e=this.height()-this.topPixelMargin()-this.bottomPixelMargin();return this._internalHeightCache=e,e}fontSize(){return this._scalesProperties.childs().fontSize.value()}priceRange(){return this._makeSureItIsValid(),this._priceRange}setPriceRange(e,t,i){if(!(e instanceof Ea.PriceRange))throw new TypeError("incorrect price range");const s=this._priceRange;if(!t&&Ea.PriceRange.compare(s,e))return;const o=null!==this._maxPriceRange&&this._maxPriceRange.containsStrictly(e),r=null!==this._minPriceRange&&e.containsStrictly(this._minPriceRange);this.isLockScale()&&!t&&(o||r)||(this._marksCache=null,this._priceRange=e,i||this._priceRangeChanged.fire(s,e),this.updateAllViews((0,Ds.viewportChangeEvent)()))}setMinPriceRange(e){this._minPriceRange=e}setMaxPriceRange(e){this._maxPriceRange=e}recalculatePriceRangeOnce(){this._recalculatePriceRangeOnce=!0}priceRangeShouldBeRecalculatedOnce(){if(!this._recalculatePriceRangeOnce||this.isLockScale())return!1;const e=this.mainSource();return null!==e&&e.priceRangeReady()}priceRangeChanged(){return this._priceRangeChanged}mode(){const e=this._properties.childs();return{autoScale:e.autoScale.value(),lockScale:e.lockScale.value(),percentage:e.percentage.value(),indexedTo100:e.indexedTo100.value(),log:e.log.value()}}setMode(e){const t={},i=this.mode(),s=this._properties.state();let o=null;void 0!==e.autoScale&&e.autoScale!==s.autoScale&&(t.autoScale=e.autoScale,this._setAutoScaleValueWithDependentProperties(e.autoScale)),void 0!==e.lockScale&&e.lockScale!==s.lockScale&&(t.lockScale=e.lockScale,this._setLockScaleValueWithDependentProperties(e.lockScale)),void 0!==e.percentage&&e.percentage!==s.percentage&&(t.percentage=e.percentage,this._setPercentageValueWithDependentProperties(e.percentage),this._invalidatedForRange.isValid=!1),void 0!==e.indexedTo100&&e.indexedTo100!==s.indexedTo100&&(t.indexedTo100=e.indexedTo100,this._setIndexedTo100ValueWithDependentProperties(e.indexedTo100),this._invalidatedForRange.isValid=!1),void 0!==e.log&&e.log!==s.log&&(t.log=e.log,this._setLogValueWithDependentProperties(e.log));const r=this._properties.childs();s.log&&!r.log.value()&&(this._canConvertPriceRangeFromLog(this._priceRange)?(o=this._convertPriceRangeFromLog(this._priceRange),
null!==o&&this.setPriceRange(o)):r.autoScale.setValue(!0)),!s.log&&r.log.value()&&(o=this._convertPriceRangeToLog(this._priceRange),null!==o&&this.setPriceRange(o)),s.autoScale!==r.autoScale.value()&&r.autoScale.fireChanged(),s.autoScaleDisabled!==r.autoScaleDisabled.value()&&r.autoScaleDisabled.fireChanged(),s.lockScale!==r.lockScale.value()&&r.lockScale.fireChanged(),s.percentage!==r.percentage.value()&&(r.percentage.fireChanged(),this.updateFormatter()),s.indexedTo100!==r.indexedTo100.value()&&(r.indexedTo100.fireChanged(),this.updateFormatter()),s.percentageDisabled!==r.percentageDisabled.value()&&r.percentageDisabled.fireChanged(),s.log!==r.log.value()&&r.log.fireChanged(),s.logDisabled!==r.logDisabled.value()&&r.logDisabled.fireChanged(),void 0===t.log&&void 0===t.percentage&&void 0===t.lockScale&&void 0===t.autoScale&&void 0===t.indexedTo100||this._modeChanged.fire(i,this.mode())}modeChanged(){return this._modeChanged}isEmpty(){return this._makeSureItIsValid(),0===this.m_height||!this._priceRange||this._priceRange.isEmpty()}hasCalculatedPriceRange(){return this._hasCalculatedPriceRange}canDetachSource(e){return this.m_dataSources.some((t=>t!==e&&!Ft(t)&&(0,bs.isPriceDataSource)(t)&&!((0,Nt.isStudy)(t)&&t.isLinkedToSeries())))}updateAllViews(e){const t=this._getSourcesToUpdateViews();for(const i of t)i.updateAllViews(e)}logFormula(){return this._logFormula}state(){const e=this._properties.childs();return{id:this._id,m_priceRange:this.isAutoScale()?null:this.priceRange()?.serialize()||null,m_isAutoScale:this.isAutoScale(),m_isPercentage:e.percentage.value(),m_isIndexedTo100:e.indexedTo100.value(),m_isLog:e.log.value(),m_isLockScale:this.isLockScale(),m_isInverted:this.isInverted(),m_topMargin:this._margins.top,m_bottomMargin:this._margins.bottom,alignLabels:e.alignLabels.value(),logFormula:(0,n.clone)(this._logFormula),hasCalculatedPriceRange:this._hasCalculatedPriceRange}}restoreState(e){let t=e.m_priceRange;if(void 0===t)throw new TypeError("invalid state");if(void 0===e.m_isAutoScale)throw new TypeError("invalid state");void 0!==e.id&&(this._id=e.id);const i={autoScale:e.m_isAutoScale};void 0!==e.m_isPercentage&&(i.percentage=e.m_isPercentage),void 0!==e.m_isIndexedTo100&&(i.indexedTo100=e.m_isIndexedTo100),void 0!==e.m_isLog&&(i.log=e.m_isLog),void 0!==e.m_isLockScale&&(i.lockScale=e.m_isLockScale),void 0!==e.m_isInverted&&this._properties.childs().isInverted.setValue(e.m_isInverted),this.setMode(i),this._hasCalculatedPriceRange=e.hasCalculatedPriceRange??null!==t,t?(t instanceof Ea.PriceRange||(t=new Ea.PriceRange(t)),this.setPriceRange(t,!0)):this.clearPriceRange(),e.logFormula&&(this._logFormula=e.logFormula),void 0!==e.m_topMargin&&(this._margins.top=e.m_topMargin),void 0!==e.m_bottomMargin&&(this._margins.bottom=e.m_bottomMargin),void 0!==e.alignLabels&&this._properties.childs().alignLabels.setValue(e.alignLabels),this._mainSource=null,this._scaleSeriesOnly=!1}priceToLogical(e){return this.isLog()&&e?(0,Da.toLog)(e,this._logFormula):e}logicalToPrice(e){return this.isLog()?(0,
Da.fromLog)(e,this._logFormula):e}positionPercentToCoordinate(e){return this.height()*e}priceToCoordinate(e,t){const i=this._priceToPercentOrIndexedTo100IfNeeded(e,t);return this._logicalToCoordinate(i)}coordinateToPrice(e,t){let i=this._coordinateToLogical(e);return this.isPercentage()?i=(0,Da.fromPercent)(i,t):this.isIndexedTo100()&&(i=(0,Da.fromIndexedTo100)(i,t)),i}mainSource(){if(null!==this._mainSource)return this._mainSource;let e;for(const t of this._priceDataSources){if((0,Pa.isSeries)(t)){e=t;break}e||(e=t)}return this._mainSource=e||null,this._correctedMarginsCache=null,this._mainSource}priceToCoordinateFn(e){this._makeSureItIsValid();const t=this.bottomPixelMargin(),i=(0,a.ensureNotNull)(this.priceRange()),s=i.minValue(),o=i.maxValue(),r=this.internalHeight()-1,n=this.isInverted(),l=r/(o-s),c=this.m_height,h=e=>{const i=t+l*(e-s);return n?i:c-1-i};return this.isPercentage()?t=>h((0,Da.toPercent)(t,e)):this.isIndexedTo100()?t=>h((0,Da.toIndexedTo100)(t,e)):this.isLog()?e=>h((0,Da.toLog)(e,this._logFormula)):e=>h(e)}pricesArrayToCoordinates(e,t,i){this._makeSureItIsValid();const s=this.bottomPixelMargin(),o=(0,a.ensureNotNull)(this.priceRange()),r=o.minValue(),n=o.maxValue(),l=this.internalHeight()-1,c=this.isInverted(),h=l/(n-r);void 0===i&&(i=e.length);const d=this.isPercentage(),u=this.isIndexedTo100(),_=this.isLog(),p=this.m_height;let m,g;for(let o=0;o<i;o++)m=e[o],Number.isFinite(m)&&(d?m=(0,Da.toPercent)(m,t):u?m=(0,Da.toIndexedTo100)(m,t):_&&(m=(0,Da.toLog)(m,this._logFormula)),g=s+h*(m-r),e[o]=c?g:p-1-g)}fillYCoordinates(e,t,i){this._makeSureItIsValid();const s=(0,a.ensureNotNull)(this.priceRange()),o=this.bottomPixelMargin(),r=s.minValue(),n=s.maxValue(),l=this.internalHeight()-1,c=this.isInverted(),h=l/(n-r),d=i?.startItemIndex??0,u=i?.endItemIndex??e.length;if(this.isPercentage())for(let i=d;i<u;i++)e[i].y=(0,Da.toPercent)(e[i].price,t);else if(this.isIndexedTo100())for(let i=d;i<u;i++)e[i].y=(0,Da.toIndexedTo100)(e[i].price,t);else if(this.isLog())for(let t=d;t<u;t++)e[t].y=this.priceToLogical(e[t].price);else for(let t=d;t<u;t++)e[t].y=e[t].price;for(let t=d;t<u;t++){const i=e[t].y;if(isNaN(i)||null==i)continue;const s=o+h*(i-r);e[t].y=c?s:this.m_height-1-s}}barPricesToCoordinates(e,t){this._makeSureItIsValid();const i=(0,a.ensureNotNull)(this.priceRange()),s=e,o=this.bottomPixelMargin(),r=i.minValue(),n=i.maxValue(),l=this.internalHeight()-1;let c=null;if(this.isPercentage()?c=Da.toPercent:this.isIndexedTo100()?c=Da.toIndexedTo100:this.isLog()&&(c=(e,t)=>e?(0,Da.toLog)(e,this._logFormula):e),0===s.length)return;const h="open"in s[0],d="close"in s[0];if(null!==c)for(let e=0;e<s.length;e++){if(!s[e])continue;const i=s[e];h&&(i.open=c(i.open,t)),i.high=c(i.high,t),i.low=c(i.low,t),d&&(i.close=c(i.close,t)),void 0!==i.additionalPrice&&(i.additionalPrice=c(i.additionalPrice,t))}const u=l/(n-r),_=this.isInverted();for(let e=0;e<s.length;e++){const t=s[e];if(!t)continue;if(h){const e=o+u*(t.open-r),i=_?e:this.m_height-1-e;t.open=i}const i=o+u*(t.high-r),n=_?i:this.m_height-1-i;t.high=n
;const a=o+u*(t.low-r),l=_?a:this.m_height-1-a;if(t.low=l,d){const e=o+u*(t.close-r),i=_?e:this.m_height-1-e;t.close=i}if(void 0!==t.additionalPrice){const e=o+u*(t.additionalPrice-r);t.additionalPrice=_?e:this.m_height-1-e}}}formatter(){return null===this._formatter&&this.updateFormatter(),(0,a.ensureNotNull)(this._formatter)}updateFormatter(){this._marksCache=null;const e=this.mainSource();let t=100;e&&(t=e.base()),this._formatter=null,this.isPercentage()?(this._formatter=Ga,t=100):this.isIndexedTo100()?(this._formatter=ja,t=100):this._formatter=e?e.formatter():ja,this._markBuilder=new za(this,t,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this)),this._markBuilder.rebuildTickMarks()}formatPrice(e,t,i){return this.isPercentage()?this.formatPricePercentage(e,t,i):this.isIndexedTo100()?this.formatPriceIndexedTo100(e,t,i):this.formatter().format(e,i)}formatPriceAbsolute(e,t){return this._mainSourceFormatter().format(e,t)}formatPricePercentage(e,t,i){return e=(0,Da.toPercent)(e,t),Ga.format(e,i)}formatPriceIndexedTo100(e,t,i){const s=(0,Da.toIndexedTo100)(e,t);return this.formatter().format(s,i)}getFormattedValues(e,t,i,s){s??=this.formatPriceAbsolute(e);const o=this.formatPricePercentage(e,t,{signPositive:i}),r=this.formatPriceIndexedTo100(e,t);return{formattedPriceAbsolute:s,formattedPricePercentage:o,formattedPriceIndexedTo100:r,text:(0,Da.getCurrentModePriceText)(this,{formattedPriceAbsolute:s,formattedPricePercentage:o,formattedPriceIndexedTo100:r})}}resetScale(){this.setMode({autoScale:!0})}resetScaleAvailable(){return this._resetScaleAvailable.readonly()}dataSources(){return this.m_dataSources}seriesLikeSources(){return this._seriesLikeSources}addDataSource(e,t){this._addDataSourceImpl(e,t)}removeDataSource(e){const t=this.m_dataSources.indexOf(e);if((0,a.assert)(-1!==t,"Source is not attached to scale"),this.m_dataSources.splice(t,1),(0,bs.isPriceDataSource)(e)){const t=this._priceDataSources.indexOf(e);if((0,a.assert)(-1!==t,"Source is not found"),this._priceDataSources.splice(t,1),(0,So.isSymbolSource)(e)){const t=this._seriesLikeSources.indexOf(e);(0,a.assert)(-1!==t,"Source is not found"),this._seriesLikeSources.splice(t,1),e.symbolResolved().unsubscribeAll(this),e.isActingAsSymbolSource().unsubscribe(this._boundOnSourceIsActingAsSymbolSourceChanged),(0,Pa.isSeries)(e)&&(this._hasSeries=!1)}e.currencyChanged().unsubscribeAll(this),e.unitChanged().unsubscribeAll(this)}this.mainSource()||this.setMode({autoScale:!0}),(0,Nt.isStudy)(e)&&(e.onIsActualIntervalChange().unsubscribe(this,this._dropScaleCache),e.onHibernationStateChange().unsubscribe(this,this._dropScaleCache),e.properties().childs().styles.unsubscribe(this,this._dropScaleCache),this._studiesCount--,0===this._studiesCount&&(0,D.hideAllIndicators)().unsubscribe(this,this._dropScaleCache)),(0,Ut.isLineTool)(e)&&(this._drawingCount--,0===this._drawingCount&&(0,D.hideAllDrawings)().unsubscribe(this,this._dropScaleCache));const i=this._sourcesThatAffectVisibility.indexOf(e);-1!==i&&(this._sourcesThatAffectVisibility.splice(i,1),
e.properties().childs().visible.unsubscribe(this,this._onSourceVisibilityChanged)),e===this._mainSource&&(this._correctedMarginsCache=null,this._internalHeightCache=null,this._marksCache=null),this._mainSource=null,this._dropScaleCache(),this.updateFormatter(),this.invalidateSourcesCache(),this._updateIsVisible(),this._updateLogFormula(),0===this.m_dataSources.length&&this._lastSourceRemoved.fire()}replaceSource(e,t){const i=(0,bs.isPriceDataSource)(e)?this._priceDataSources.indexOf(e):void 0;return this._addDataSourceImpl(t,void 0,-1===i?void 0:i),this.removeDataSource(e),-1!==i}currency(e){if(null!==this._currencyCache&&e.size()===this._currencyCache.availableCurrenciesCount)return this._currencyCache.value;let t;const i=new Set,s=new Set,o=new Set,r=new Map,n=new Set;let l,c=0===this._seriesLikeSources.length||this._seriesLikeSources[0].model().readOnly(),h=!0,d=0,u=0;const _=this._seriesLikeSources.filter(So.isActingAsSymbolSource);for(const u of _){if(!u.isVisible())continue;const _=u.symbolInfo();if(null===_){t=null;break}const p=(0,Q.symbolOriginalCurrency)(_);if(null===p){t=null;break}r.set(p,(0,a.ensureNotNull)((0,Q.symbolOriginalCurrency)(_,!0)));const m=u.currency();if(null===m){t=null;break}r.set(m,(0,a.ensureNotNull)((0,Q.symbolCurrency)(_,!0)));const g=(0,Q.symbolBaseCurrency)(_);null!==g&&s.add(g),h=h&&p===m,o.add(m),i.add(p),void 0===l?l=m:null!==l&&l!==m&&(l=null),c||e.convertible(m)&&(0,Q.symbolCurrencyConvertible)(_)||(c=!0),d+=1,n.add((0,Q.proSymbol)(_,u.symbol()))}if(null!==t)for(const i of this._priceDataSources){if(_.includes(i))continue;const s=i;if(!s.isCurrencySource()||!s.isVisible()||s.isFailed())continue;const n=s.currency();if(null===n){t=null;break}o.add(n),u+=1;const h=(0,a.ensureNotNull)(s.symbolSource()),d=s.currencySourceSymbolInfo();if(null===d){t=null;break}if(c||e.convertible(n)&&(0,Q.symbolCurrencyConvertible)(d)||(c=!0),r.set(n,(0,a.ensureNotNull)((0,Q.symbolCurrency)(d,!0))),_.includes(h)||(c=!0),void 0===l)l=n;else if(null!==l&&l!==n){l=null;break}}return void 0===t&&(t=0===d&&0===u?null:{readOnly:c,selectedCurrency:l||null,currencies:o,originalCurrencies:i,baseCurrencies:s,symbolSourceCount:d,allCurrenciesAreOriginal:h,displayedValues:r,symbols:n}),this._currencyCache={value:t,availableCurrenciesCount:e.size()},t}unit(e){if(null!==this._unitCache&&e.size()===this._unitCache.availableUnitsCount)return this._unitCache.value;let t;const i=new Set,s=new Set,o=new Map,r=new Map,n=new Set;let l,c=0===this._seriesLikeSources.length||this._seriesLikeSources[0].model().readOnly()?new Set:e.allGroups(),h=!0,d=0,u=0;const _=this._seriesLikeSources.filter(So.isActingAsSymbolSource);for(const a of _){if(!a.isVisible())continue;const u=a.symbolInfo();if(null===u){t=null;break}const _=(0,Q.symbolOriginalUnit)(u,a.model().unitConversionEnabled());if(null===_){t=null;break}o.set(_,e.name(_)),r.set(_,e.description(_));const p=a.unit();if(null===p){t=null;break}if(o.set(p,e.name(p)),r.set(p,e.description(p)),h=h&&_===p,s.add(p),i.add(_),void 0===l?l=p:null!==l&&l!==p&&(l=null),c.size>0){
const t=Ba(u,p,e);c=(0,J.intersect)(c,new Set(t))}d+=1,n.add((0,Q.proSymbol)(u,a.symbol()))}if(null!==t)for(const i of this._priceDataSources){if(_.includes(i))continue;const n=i;if(!n.isUnitSource()||!n.isVisible()||n.isFailed())continue;const h=n.unit();if(null===h){t=null;break}s.add(h),u+=1;const d=(0,a.ensureNotNull)(n.symbolSource()),p=d.symbolInfo();if(null===p){t=null;break}if(c.size>0){const t=Ba(p,h,e);c=(0,J.intersect)(c,new Set(t))}if(o.set(h,e.name(h)),r.set(h,e.description(h)),_.includes(d)||(c=new Set),void 0===l)l=h;else if(null!==l&&l!==h){l=null;break}}if(void 0===t)if(0===d&&0===u)t=null;else{t={availableGroups:c,selectedUnit:l||null,units:s,originalUnits:i,symbolSourceCount:d,allUnitsAreOriginal:h,names:o,descriptions:r,symbols:n}}return this._unitCache={value:t,availableUnitsCount:e.size()},t}metric(e){if(!e.isReady())return null;if(null!==this._metricCache&&e.size()===this._metricCache.availableMetricsCount)return this._metricCache.value;let t;const i=new Set,s=new Map,o=new Set;let r,n=0===this._seriesLikeSources.length||this._seriesLikeSources[0].model().readOnly(),l=0,c=0;const h=this._seriesLikeSources.filter(So.isActingAsSymbolSource);for(const a of h){if(!a.isVisible())continue;const c=a.symbolInfo();if(null===c){t=null;break}const h=a.metric();if(null===h){t=null;break}s.set(h,e.name(h)),i.add(h),void 0===r?r=h:null!==r&&r!==h&&(r=null),n||e.convertible(h)||(n=!0),l+=1,o.add((0,Q.proSymbol)(c,a.symbol()))}if(null!==t)for(const o of this._priceDataSources){if(h.includes(o))continue;const l=o;if(!l.isMetricSource()||!l.isVisible()||l.isFailed())continue;const d=l.metric();if(null===d){t=null;break}i.add(d),c+=1;const u=(0,a.ensureNotNull)(l.symbolSource());if(null===l.currencySourceSymbolInfo()){t=null;break}if(n||e.convertible(d)||(n=!0),s.set(d,e.name(d)),h.includes(u)||(n=!0),void 0===r)r=d;else if(null!==r&&r!==d){r=null;break}}return void 0===t&&(t=0===l&&0===c?null:{readOnly:n,selectedMetricId:r||null,metrics:i,names:s}),this._metricCache={value:t,availableMetricsCount:e.size()},t}measureUnitId(e){if(null!==this._measureUnitIdCache&&e.size()===this._measureUnitIdCache.availableUnitsCount)return this._measureUnitIdCache.value;let t,i;const s=new Map,o=new Map,r=new Set;let n=0;const a=this._seriesLikeSources.filter(So.isActingAsSymbolSource);for(const l of a){if(!l.isVisible())continue;const a=l.measureUnitId();if(null===a){t=null;break}r.add(a),s.set(a,e.name(a)),o.set(a,e.description(a)),void 0===i?i=a:null!==i&&i!==a&&(i=null),n+=1}return void 0===t&&(t=0===n?null:{selectedMeasureUnitId:i||null,measureUnitIds:r,names:s,descriptions:o,symbolSourceCount:n}),this._measureUnitIdCache={value:t,availableUnitsCount:e.size()},t}setMargins(e){if(!(0,n.isNumber)(e.top)||!(0,n.isNumber)(e.bottom))throw new TypeError("invalid margin");if(e.top<0||e.top>30||e.bottom<0||e.bottom>30)throw new RangeError("invalid margin");this._margins.top===e.top&&this._margins.bottom===e.bottom||(this._margins=e,this._correctedMarginsCache=null,this._invalidateInternalHeightCache(),this._marksCache=null)}
topMargin(){return this._correctedMargins().top}bottomMargin(){return this._correctedMargins().bottom}invalidateMargins(){this._correctedMarginsCache=null}topPixelMargin(){return this.isInverted()?this.bottomMargin()*this.height()+this._bottomPixelMargin:this.topMargin()*this.height()+this._topPixelMargin}bottomPixelMargin(){return this.isInverted()?this.topMargin()*this.height()+this._topPixelMargin:this.bottomMargin()*this.height()+this._bottomPixelMargin}marks(){return this.isEmpty()?(this._marksCache=null,[]):(null===this._marksCache&&(this._markBuilder.rebuildTickMarks(),this._marksCache=this._markBuilder.marks(),this._onMarksChanged.fire()),this._marksCache)}onMarksChanged(){return this._onMarksChanged}priceRangeInPrice(){if(this.isEmpty())return null;const e=this.mainSource()?.firstValue()??null;if(null===e)return null;const t=this.height();return{from:this.coordinateToPrice(t-1,e),to:this.coordinateToPrice(0,e)}}setPriceRangeInPrice(e){if(this.isPercentage()||this.isIndexedTo100())return;const t=this.isInverted(),i=t?this.bottomMargin():this.topMargin(),s=t?this.topMargin():this.bottomMargin(),o=this.isLog();let r=o?(0,Da.toLog)(e.from,this._logFormula):e.from,n=o?(0,Da.toLog)(e.to,this._logFormula):e.to;const a=n-r;r+=s*a,n-=i*a,this.setMode({autoScale:!1}),this.setPriceRange(new Ea.PriceRange(r,n)),this._marksCache=null,this._onMarksChanged.fire()}hasMainSeries(){return this._hasSeries}getStudies(){return this.dataSources().filter(Nt.isStudy)}lastSourceRemoved(){return this._lastSourceRemoved}sourcesForAutoscale(){return this._mainSource&&this._scaleSeriesOnly!==this._scalesProperties.childs().scaleSeriesOnly.value()&&(this._sourcesForAutoscale=null),this._sourcesForAutoscale||(this._sourcesForAutoscale=this._recalculateSourcesForAutoscale()),this._sourcesForAutoscale}recalculatePriceRange(e,t){this._invalidatedForRange={visibleBars:e,logicalRange:t,isValid:!1}}internalHeightChanged(){return this._internalHeightChanged}orderedSources(){if(this._cachedOrderedSoruces)return this._cachedOrderedSoruces;let e=this.m_dataSources.slice();return e=e.filter((e=>!Ft(e))),e=(0,zo.sortSources)(e),this._cachedOrderedSoruces=e,this._cachedOrderedSoruces}invalidateSourcesCache(){this._cachedOrderedSoruces=null,this._sourcesToUpdateViews=null}startScale(e){this.isEmpty()||this.isPercentage()||this.isIndexedTo100()||null!==this._scaleStartPoint||null!==this._priceRangeSnapshot||(this._scaleStartPoint=this.m_height-e,this._priceRangeSnapshot=this.priceRange()?.clone()??null)}scaleTo(e){if(this.isPercentage()||this.isIndexedTo100()||null===this._scaleStartPoint)return;this.setMode({autoScale:!1}),(e=this.m_height-e)<0&&(e=0);let t=(this._scaleStartPoint+.2*(this.m_height-1))/(e+.2*(this.m_height-1));const i=(0,a.ensureNotNull)(this._priceRangeSnapshot).clone();t=Math.max(t,.1),i.scaleAroundCenter(t),this.setPriceRange(i)}endScale(){this.isPercentage()||this.isIndexedTo100()||null!==this._scaleStartPoint&&(this._scaleStartPoint=null,this._priceRangeSnapshot=null)}startTwoPointsScale(e,t){
if(this.isEmpty()||this.isPercentage()||this.isIndexedTo100()||null!==this._twoPointsScaleStartPosition)return;const i=Math.min(e,t),s=Math.max(e,t);this._twoPointsScaleStartPosition={topLogical:this._coordinateToLogical(i),bottomLogical:this._coordinateToLogical(s)}}twoPointsScale(e,t){if(this.isPercentage()||this.isIndexedTo100()||null===this._twoPointsScaleStartPosition)return;this.setMode({autoScale:!1});const i=Math.min(e,t),s=Math.max(e,t),{topLogical:o,bottomLogical:r}=this._twoPointsScaleStartPosition,n=this.bottomPixelMargin(),a=this.internalHeight()-1,l=(this._invertedCoordinate(i)-n)/a,c=(r-o)/((this._invertedCoordinate(s)-n)/a-l);if(!Number.isFinite(c))return;const h=o-c*l,d=h+c;this.setPriceRange(new Ea.PriceRange(this.priceToLogical(h),this.priceToLogical(d)))}isBeingScaled(){return null!==this._scaleStartPoint||null!==this._twoPointsScaleStartPosition}endTwoPointsScale(){this._twoPointsScaleStartPosition=null}startScroll(e){this.isAutoScale()||null===this._scrollStartPoint&&null===this._priceRangeSnapshot&&(this.isEmpty()||(this._scrollStartPoint=e,this._priceRangeSnapshot=this.priceRange()?.clone()??null))}scrollTo(e){if(this.isAutoScale())return;if(null===this._scrollStartPoint||null===this._priceRangeSnapshot)return;const t=this.priceRange();if(null===t)return;let i=e-this._scrollStartPoint;this.isInverted()&&(i*=-1);const s=i*(t.length()/(this.internalHeight()-1)),o=this._priceRangeSnapshot.clone();o.shift(s),this.setPriceRange(o,!0),this._marksCache=null}endScroll(){this.isAutoScale()||null!==this._scrollStartPoint&&(this._scrollStartPoint=null,this._priceRangeSnapshot=null)}clearPriceRange(){this._priceRange=null,this.recalculatePriceRangeOnce()}isVisible(){return this._isVisible}_addDataSourceImpl(e,t,i){if(t||-1===this.m_dataSources.indexOf(e)){if((0,bs.isPriceDataSource)(e)){if(void 0===i?this._priceDataSources.push(e):this._priceDataSources.splice(i,0,e),e.currencyChanged().subscribe(this,(()=>this._currencyCache=null)),e.unitChanged().subscribe(this,(()=>this._unitCache=null)),e.metricChanged().subscribe(this,(()=>this._metricCache=null)),(0,So.isSymbolSource)(e)&&(this._seriesLikeSources.push(e),e.symbolResolved().subscribe(this,(()=>{this._currencyCache=null,this._unitCache=null,this._metricCache=null,this._measureUnitIdCache=null,this._updateLogFormula()})),e.isActingAsSymbolSource().subscribe(this._boundOnSourceIsActingAsSymbolSourceChanged),(0,Pa.isSeries)(e))){const t=e.properties();this._hasSeries||(t.childs().lockScale&&(this.setMode({lockScale:t.childs().lockScale.value()}),t.removeProperty("lockScale")),t.childs().pnfStyle.hasChild("lockScale")&&t.childs().pnfStyle.removeProperty("lockScale")),this._hasSeries=!0}e.isSpeciallyZOrderedSource()||(this._sourcesThatAffectVisibility.push(e),e.properties().childs().visible.subscribe(this,this._onSourceVisibilityChanged))}(0,Nt.isStudy)(e)&&(e.onIsActualIntervalChange().subscribe(this,this._dropScaleCache),e.onHibernationStateChange().subscribe(this,this._dropScaleCache),e.properties().childs().styles.subscribe(this,this._dropScaleCache),
0===this._studiesCount&&(0,D.hideAllIndicators)().subscribe(this,this._dropScaleCache),this._studiesCount++),(0,Ut.isLineTool)(e)&&(0===this._drawingCount&&(0,D.hideAllDrawings)().subscribe(this,this._dropScaleCache),this._drawingCount++),this.m_dataSources.push(e),this._mainSource=null,this.mainSource()===e&&(this._correctedMarginsCache=null,this._internalHeightCache=null,this._marksCache=null),this._dropScaleCache(),this.updateFormatter(),this._initScaleProperties(),this.invalidateSourcesCache(),this._updateIsVisible(),this._updateLogFormula()}}_recalculateSourcesForAutoscale(){this._mainSource&&(this._scaleSeriesOnly=this._scalesProperties.childs().scaleSeriesOnly.value());const e=this._scaleSeriesOnly&&this._hasSeries;return this.m_dataSources.filter((t=>!(!t.properties().visible.value()&&!(0,Pa.isSeries)(t))&&(e?(0,Pa.isSeries)(t):(0,Nt.isStudy)(t)?!t.isSourceHidden()&&t.isIncludedInAutoScale():t.isIncludedInAutoScale())))}_updateAutoScaleDisabledProperty(e){const t=this._properties.childs(),i=t.indexedTo100.value()||t.percentage.value()||t.lockScale.value();e?t.autoScaleDisabled.setValueSilently(i):t.autoScaleDisabled.setValue(i)}_setAutoScaleValueWithDependentProperties(e){const t=this._properties.childs();t.autoScale.setValueSilently(e),e&&(t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.logDisabled.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setLockScaleValueWithDependentProperties(e){const t=this._properties.childs();t.lockScale.setValueSilently(e),e&&(t.autoScale.setValueSilently(!1),t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1),t.log.setValueSilently(!1)),t.percentageDisabled.setValueSilently(e),t.logDisabled.setValueSilently(e),this._updateAutoScaleDisabledProperty(!0)}_setPercentageValueWithDependentProperties(e){const t=this._properties.childs();t.percentage.setValueSilently(e),e&&(t.autoScale.setValueSilently(!0),t.log.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.indexedTo100.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setIndexedTo100ValueWithDependentProperties(e){const t=this._properties.childs();t.indexedTo100.setValueSilently(e),e&&(t.autoScale.setValueSilently(!0),t.log.setValueSilently(!1),t.lockScale.setValueSilently(!1),t.percentage.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_setLogValueWithDependentProperties(e){const t=this._properties.childs();t.log.setValueSilently(e),e&&(t.lockScale.setValueSilently(!1),t.percentage.setValueSilently(!1),t.indexedTo100.setValueSilently(!1)),this._updateAutoScaleDisabledProperty(!0)}_recalculatePriceRangeImpl(){const e=this._invalidatedForRange.visibleBars,t=this._invalidatedForRange.logicalRange;if(null===e||null===t)return;let i=null;const s=this.sourcesForAutoscale(),o=this.isPercentage(),r=this.isIndexedTo100();let n=0,a=0;const l={startTimePoint:e.firstBar(),endTimePoint:e.lastBar(),logicStartPoint:t.left(),logicEndPoint:t.right(),targetPriceScale:this,scaleSeriesOnly:this._scaleSeriesOnly}
;for(const e of s){if(!e.properties().visible.value())continue;const t=e.firstValue();if(null===t||o&&0===t)continue;const s=e.autoScaleInfo(l);let c=s.range;c&&(o?c=(0,Da.toPercentRange)(c,t):r&&(c=(0,Da.toIndexedTo100Range)(c,t)),i=null===i?c:i.merge(c)),void 0!==s.topPixelMargin&&(n=Math.max(n,s.topPixelMargin)),void 0!==s.bottomPixelMargin&&(a=Math.max(a,s.bottomPixelMargin))}(Math.abs(n-this._topPixelMargin)>0||Math.abs(a-this._bottomPixelMargin)>0)&&(this._bottomPixelMargin=a,this._topPixelMargin=n,this._marksCache=null,this._invalidateInternalHeightCache()),i?(this._hasCalculatedPriceRange=!0,i.minValue()===i.maxValue()&&(i=new Ea.PriceRange(i.minValue()-.5,i.maxValue()+.5)),this.setPriceRange(i)):this._priceRange||this.setPriceRange(new Ea.PriceRange(-.5,.5)),this._invalidatedForRange.isValid=!0;const c=this.mainSource();null!==c&&this._recalculatePriceRangeOnce&&(this._recalculatePriceRangeOnce=!c.priceRangeReady())}_makeSureItIsValid(){this._invalidatedForRange.isValid||(this._invalidatedForRange.isValid=!0,this._recalculatePriceRangeImpl())}_invalidateInternalHeightCache(){this._internalHeightCache=null,this._internalHeightChanged.fire()}_coordinateToLogical(e){if(this._makeSureItIsValid(),this.isEmpty())return 0;const t=this._invertedCoordinate(e),i=(0,a.ensureNotNull)(this.priceRange()),s=i.minValue()+(i.maxValue()-i.minValue())*((t-this.bottomPixelMargin())/(this.internalHeight()-1));return this.logicalToPrice(s)}_logicalToCoordinate(e){if(this._makeSureItIsValid(),this.isEmpty())return 0;e=this.priceToLogical(e);const t=(0,a.ensureNotNull)(this.priceRange()),i=this.bottomPixelMargin()+(this.internalHeight()-1)*(e-t.minValue())/(t.maxValue()-t.minValue());return this._invertedCoordinate(i)}_convertPriceRangeFromLog(e){if(null===e)return null;const t=(0,Da.fromLog)(e.minValue(),this._logFormula),i=(0,Da.fromLog)(e.maxValue(),this._logFormula);return new Ea.PriceRange(t,i)}_convertPriceRangeToLog(e){if(null===e)return null;const t=(0,Da.toLog)(e.minValue(),this._logFormula),i=(0,Da.toLog)(e.maxValue(),this._logFormula);return new Ea.PriceRange(t,i)}_canConvertPriceRangeFromLog(e){if(null===e)return!1;const t=(0,Da.fromLog)(e.minValue(),this._logFormula),i=(0,Da.fromLog)(e.maxValue(),this._logFormula);return isFinite(t)&&isFinite(i)}_onSourceVisibilityChanged(){this._dropScaleCache(),this._updateIsVisible()}_dropScaleCache(){this._sourcesForAutoscale=null,this._currencyCache=null,this._unitCache=null,this._metricCache=null,this._measureUnitIdCache=null}_updateIsVisible(){this._isVisible.setValue(!0)}_updateLogFormula(){const e=this.isLog()?this._convertPriceRangeFromLog(this.priceRange()):null,t=this.mainSource();if(null===t)this._logFormula=(0,Da.logFormulaForBase)(null);else{const e=t.base()||null,i=(0,Da.logFormulaForBase)(e);(0,Da.logFormulasAreSame)(i,this._logFormula)||(this._logFormula=i)}e&&this.setPriceRange(this._convertPriceRangeToLog(e))}_invertedCoordinate(e){return this.isInverted()?e:this.height()-1-e}_initScaleProperties(){const e=this.isLockScale(),t=this.properties().childs()
;e&&(t.percentage.setValue(!1),t.indexedTo100.setValue(!1),t.log.setValue(!1),t.autoScale.setValue(!1)),t.percentageDisabled.setValue(e),t.logDisabled.setValue(e),this._updateAutoScaleDisabledProperty(!1),t.percentage.value()&&(t.log.setValue(!1),t.indexedTo100.setValue(!1)),t.indexedTo100.value()&&(t.log.setValue(!1),t.percentage.setValue(!1))}_correctedMargins(){if(null===this._correctedMarginsCache){const e=this.mainSource();this._correctedMarginsCache=null!==e?e.correctScaleMargins(this._margins):this._margins}return this._correctedMarginsCache}_getSourcesToUpdateViews(){return this._sourcesToUpdateViews||(this._sourcesToUpdateViews=this.m_dataSources.filter((e=>!(0,Ut.isLineTool)(e)||e.isActualSymbol()&&e.isActualCurrency()))),this._sourcesToUpdateViews}_mainSourceFormatter(){const e=this.mainSource();return e?.formatter()||ja}_priceToPercentOrIndexedTo100IfNeeded(e,t){return this.isPercentage()?(0,Da.toPercent)(e,t):this.isIndexedTo100()?(0,Da.toIndexedTo100)(e,t):e}_onSourceIsActingAsSymbolSourceChanged(){this._dropScaleCache()}_onIsInvertedChanged(){this._marksCache=null,this._markBuilder.rebuildTickMarks()}_updateResetAvailableValue(){this._resetScaleAvailable.setValue(!this.isLockScale()&&!this.isAutoScale())}}var Ka=i(359691),Za=i(407760),Ya=i(373391);var Xa=i(553722),Ja=i(507982),Qa=i(822783);function el(e){e.wickUpColor=e.wickUpColor??e.wickColor,e.wickDownColor=e.wickDownColor??e.wickColor,delete e.wickColor}function tl(e){e&&(e.colorType??=Yt.ColorType.Solid)}function il(e,t,i){const s=parseInt(e.slice(0,2)),o=parseInt(e.slice(2)),r=(0,c.get_cal)(t,2e3,c.JANUARY,1,0,0,0);(0,c.set_hms)(r,s,o,0,0,t);const n=(0,c.cal_to_utc)(t,r,!0),a=(0,c.utc_to_cal)(i,n);return`${a.getUTCHours().toString().padStart(2,"0")}${a.getUTCMinutes().toString().padStart(2,"0")}`}const sl=(0,l.getLogger)("Chart.Pane");function ol(e,t,i){e.setMargins({top:t,bottom:i})}const rl="chart.pane";class nl{constructor(e,t,i,s,o){this.m_dataSources=[],this._sourceWatchedValuesSubscriptions=new Map,this.m_mainDataSource=null,this._cachedOrderedSources=new ka(this),this._sourcesById=new Map,this._priceSourcesById=new Map,this._sourcePropertiesChanged=new g.Delegate,this._sourcesZOrderChanged=new g.Delegate,this._tagsChanged=new g.Delegate,this._stretchFactor=1e3,this._isInInsertManyDataSourcesState=!1,this._lastLineDataSourceZOrder=null,this._rightPriceScales=[],this._leftPriceScales=[],this._lockedPriceScale=null,this._currentPriceScaleRatio=null,this._onPriceScalesChanged=new g.Delegate,this._isRecalculatingScales=!1,this._priceDataSources=[],this._symbolSources=[],this._studySources=[],this._lollipopDataSources=[],this._symbolSourceResolved=new g.Delegate,this._symbolSourceResolvingActive=new H.WatchedValue(!1),this._bulkActions={activeCounter:0},this._height=0,this._width=0,this._sizeChanged=new g.Delegate,this._dataSourcesCollectionChanged=new g.Delegate,this._dataSourcesZOrdersChanged=new g.Delegate,this._symbolSourceCollectionChanged=new g.Delegate,this._priceSourcesCollectionChanged=new g.Delegate,
this._isMainPane=new H.WatchedValue(!1),this._collapsed=new H.WatchedValue(!1),this._resetPriceScalesAvailable=new H.WatchedValue(!1),this._destroyed=new g.Delegate,this._executionsPositionController=null,this._seriesDisplayError=null,this._onPriceScaleIsVisibleChanged=()=>{this._model.fullUpdate()},this._recalcSymbolSourceResolvingActive=()=>{for(const e of this._symbolSources)if(e.symbolResolvingActive().value())return void this._symbolSourceResolvingActive.setValue(!0);this._symbolSourceResolvingActive.setValue(!1)},this._onSymbolSourceCollectionChanged=()=>{0===this._bulkActions.activeCounter?this._symbolSourceCollectionChanged.fire():this._bulkActions.symbolSourceCollectionChanged=!0},this._onSeriesDisplayError=e=>{},this._updateResetPriceScalesAvailableValue=()=>{const e=e=>e.resetScaleAvailable().value(),t=this._leftPriceScales.some(e)||this._rightPriceScales.some(e);this._resetPriceScalesAvailable.setValue(t)},this._priceScaleSelectionStrategy=(0,fa.createPriceScaleSelectionStrategy)(i.properties().childs().priceScaleSelectionStrategyName.value()),this._id=s??(0,ot.randomHashN)(6),this._mode=o??K.PaneMode.Regular,this._timeScale=e,this.m_mainDataSource=null,this._properties=t,this._model=i,this._maximized=(0,F.combine)((e=>e===this),i.maximizedPane().spawnOwnership()),this._collapsingAvailable=(0,F.combine)(((e,t)=>!e&&t),this._isMainPane.weakReference(),i.paneCollapsingAvailable().weakReference()),i.properties().childs().priceScaleSelectionStrategyName.subscribe(null,(e=>{this._priceScaleSelectionStrategy=(0,fa.createPriceScaleSelectionStrategy)(e.value()),this._priceScaleSelectionStrategy.apply(this)})),this._timeScale.barSpacingChanged().subscribe(this,(()=>{this.m_mainDataSource===this._model.mainSeries()&&this._recalculatePriceScaleByScaleRatio(this.m_mainDataSource.priceScale())})),i.onMultipaneSourcesCollectionChanged().subscribe(this,this._invalidateSourcesCache),i.panesCollectionChanged().subscribe(this,this._invalidateSourcesCache),t.childs().topMargin.subscribe(this,this._updateMargins),t.childs().bottomMargin.subscribe(this,this._updateMargins),this._lineToolsByLinkKey=new ba((e=>e.linkKey().value()),(e=>e.id())),this._updateMargins()}destroy(){if(this._properties.childs().topMargin.unsubscribeAll(this),this._properties.childs().bottomMargin.unsubscribeAll(this),this._model.properties().childs().priceScaleSelectionStrategyName.unsubscribeAll(this),this._timeScale.barSpacingChanged().unsubscribeAll(this),this._leftPriceScales.concat(this._rightPriceScales).forEach((e=>{e.modeChanged().unsubscribeAll(this),e.priceRangeChanged().unsubscribeAll(this),e.internalHeightChanged().unsubscribeAll(this),e.isVisible().unsubscribe(this._onPriceScaleIsVisibleChanged),e.resetScaleAvailable().unsubscribe(this._updateResetPriceScalesAvailableValue)})),this._mode===K.PaneMode.Regular)for(const e of this.m_dataSources)this.removeSourceFromPriceScale(e),e.destroy&&e.destroy();this._seriesDisplayError?.destroy(),this._model.onMultipaneSourcesCollectionChanged().unsubscribeAll(this),
this._model.panesCollectionChanged().unsubscribeAll(this),this._maximized.destroy(),this._collapsingAvailable.destroy(),this._destroyed.fire()}id(){return this._id}mode(){return this._mode}bulkActionMacro(e){this.beginBulkAction(),e(),this.endBulkAction()}beginBulkAction(){this._bulkActions.activeCounter+=1}endBulkAction(){this._bulkActions.activeCounter-=1,this._processAfterBulkAction()}defaultPriceScale(){const e=this.m_mainDataSource?.priceScale()??null;if(null!==e)return e;const t=this.properties().childs().axisProperties.state();return t.autoScale=!0,new $a(this._model.properties().childs().scalesProperties,t)}leftPriceScales(){return this._leftPriceScales}rightPriceScales(){return this._rightPriceScales}visibleLeftPriceScales(){const e=this._model.priceScaleSlotsCount(),t=this._leftPriceScales.filter((e=>e.isVisible().value())),i=this.mainDataSource()?.priceScale();if(t.length>e.left&&i?.isVisible().value()){const s=(0,J.moveToHead)(t,i);return s.splice(e.left),s}return t}visibleRightPriceScales(){const e=this._model.priceScaleSlotsCount(),t=this._rightPriceScales.filter((e=>e.isVisible().value())),i=this.mainDataSource()?.priceScale();if(t.length>e.right&&i?.isVisible().value()){const s=(0,J.moveToHead)(t,i);return s.splice(e.right),s}return t}clearSeries(e){const t=this._model.mainSeries();for(let i=this.m_dataSources.length-1;i>=0;i--)this.m_dataSources[i]===t&&this._removeSourceFromCollections(i,e)}sourcesByGroup(){return this._cachedOrderedSources}dataSourceForId(e){return this._sourcesById.get(e)||null}lineToolByLinkKey(e){return this._lineToolsByLinkKey.getByKey1(e)}changeSourceId(e,t){e===this._model.mainSeries()&&(0,va.getPersistentLogger)()?.addPersistentLogEntry(`changeSourceId for series from ${e.id()} to ${t}`,l.LOGLEVEL.INFO,rl),(0,a.assert)(this.hasDataSource(e));const i=e.id();e.setId(t),this._sourcesById.delete(i),this._sourcesById.set(t,e),(0,bs.isPriceDataSource)(e)&&(this._priceSourcesById.delete(i),this._priceSourcesById.set(t,e))}movePriceScale(e,t,i){const s=this.priceScalePosition(e);if(s!==t)this.removePriceScale(e),this._placePriceScale(e,t,i),e.invalidateMargins(),this._invalidateSourcesCache();else if(void 0!==i&&"overlay"!==s){const t="left"===s?this._leftPriceScales:this._rightPriceScales,o=t.indexOf(e);t.splice(o,1),t.splice(i,0,e)}}mainDataSource(){return this.m_mainDataSource}isEmpty(){return null===this.m_mainDataSource}recalculatePriceScale(e,t){if(!e)return;let i=e.sourcesForAutoscale();if(e===this._model.mainSeries().priceScale()&&(i=[...i,...this._cachedOrderedSources.multipaneSources()]),(e.isAutoScale()||e.priceRangeShouldBeRecalculatedOnce()||null===e.priceRange())&&i.length>0&&!this.timeScale().isEmpty()){const i=e.priceRange(),s=this.timeScale().visibleBarsStrictRange(),o=this.timeScale().logicalRange();e.recalculatePriceRange(s,o),Ea.PriceRange.compare(i,e.priceRange())||e.updateAllViews(t)}}onSourceTagsChanged(){this._tagsChanged.fire()}insertDataSource(e,t,i,s){e.setZorder(i),t||(s=!1,t=this.findSuitableScale(e)),this._addSourceToCollections(e);let o=!1
;e===this.model().mainSeries()?(this.m_mainDataSource=this.model().mainSeries(),o=!0):null===this.m_mainDataSource&&(0,bs.isPriceDataSource)(e)&&(this.m_mainDataSource=e,o=!0),s||t.addDataSource(e,this._isInInsertManyDataSourcesState),e.setPriceScale(t),t.invalidateMargins(),e.onTagsChanged&&e.onTagsChanged().subscribe(this,this.onSourceTagsChanged),o&&this._mode===K.PaneMode.Regular&&this._processMainSourceChange(),this._tagsChanged.fire(),(0,bs.isPriceDataSource)(e)&&this.recalculatePriceScale(t,(0,Ds.sourceChangeEvent)(e.id())),this._invalidateSourcesCache(),this._isInInsertManyDataSourcesState||(0,a.ensureNotNull)(this.model().alertsWatcher()).syncSourceAlertLabels(e)}addDataSource(e,t,i){let s=e.zorder();i||((0,Ut.isLineTool)(e)&&!e.isSpeciallyZOrderedSource()?(s=null!==this._lastLineDataSourceZOrder?this._lastLineDataSourceZOrder+1:this.newLineToolZOrder(),this._isInInsertManyDataSourcesState&&(this._lastLineDataSourceZOrder=s)):(0,Nt.isStudy)(e)&&!e.isSpeciallyZOrderedSource()&&(s=this.newStudyZOrder())),this.insertDataSource(e,t,s)}removeDataSource(e,t=!1,i=!1,s=!1){let o=this.m_dataSources.indexOf(e);if(-1===o)return void sl.logDebug("removeDataSource: invalid data source");(0,a.ensureNotNull)(this.model().alertsWatcher()).detachSourceAlertLabels(e),o=this.m_dataSources.indexOf(e),this._removeSourceFromCollections(o,i),e===this.m_mainDataSource&&(this.m_mainDataSource=null);const r=e.priceScale();s||this.removeSourceFromPriceScale(e),e.onTagsChanged&&e.onTagsChanged().unsubscribe(this,this.onSourceTagsChanged),(0,bs.isPriceDataSource)(e)&&!t&&this._processMainSourceChange(),(0,Nt.isStudy)(e)&&e.metaInfo().hasForceOverlayPlots()&&this._model.removeMultiPaneSource(e),this._tagsChanged.fire(),r&&(0,bs.isPriceDataSource)(e)&&this.recalculatePriceScale(r,(0,Ds.sourceChangeEvent)(e.id())),this._invalidateSourcesCache()}hasDataSource(e){return this._sourcesById.has(e.id())}hasDataSourceWithSignature(e){return this._priceDataSources.some((t=>t.signature().value()===e))}hasPriceDataSource(e){return this._priceSourcesById.has(e.id())}dataSources(){return this.m_dataSources}priceDataSources(){return this._priceDataSources}studySources(){return this._studySources}lollipopDataSources(){return this._lollipopDataSources}symbolSources(){return this._symbolSources}replaceSource(e,t,i){const s=this.m_mainDataSource===e,o=i?.replaceSource(e,t);this.removeDataSource(e,!0,void 0,o),this.insertDataSource(t,i,e.zorder(),o),this._sourcesById.set(t.id(),t),(0,bs.isPriceDataSource)(t)&&this._priceSourcesById.set(t.id(),t),s&&(this.m_mainDataSource=t,this._processMainSourceChange())}findSuitableScale(e,t,i){return this._priceScaleSelectionStrategy.findSuitableScale(this,e,t,i)}createNewPriceScaleIfPossible(){return this._priceScaleSelectionStrategy.createNewPriceScaleIfPossible(this)}canCreateNewPriceScale(){return this._priceScaleSelectionStrategy.canCreateNewPriceScale(this)}isOverlay(e){const t=e.priceScale();return null===t||"overlay"===this.priceScalePosition(t)}recalculate(e){
this._leftPriceScales.forEach((t=>this.recalculatePriceScale(t,e))),this._rightPriceScales.forEach((t=>this.recalculatePriceScale(t,e)));for(const t of this.m_dataSources)this.isOverlay(t)&&!(0,Ut.isLineTool)(t)&&this.recalculatePriceScale(t.priceScale(),e);this.updateAllViews(e),this._model.updatePane(this)}updateAllViews(e){const t=this._cachedOrderedSources.all();for(const i of t)i.updateAllViews(e);for(const t of this.model().customSources())t.updateViewsForPane(this,e)}updateLollipopViews(e){for(const t of this._lollipopDataSources)t.updateAllViews(e)}priceScalePosition(e){return this._leftPriceScales.includes(e)?"left":this._rightPriceScales.includes(e)?"right":"overlay"}createPriceScaleAtPosition(e,t){const i=this.properties().childs().axisProperties.state();i.autoScale=!0;const s=new $a(this.model().properties().childs().scalesProperties,i);return s.setHeight(this.height()),ol(s,this._defaultTopMargin(),this._defaultBottomMargin()),this._placePriceScale(s,e,t),s}removePriceScale(e){e.modeChanged().unsubscribeAll(this),e.priceRangeChanged().unsubscribeAll(this),e.internalHeightChanged().unsubscribeAll(this),e.isVisible().unsubscribe(this._onPriceScaleIsVisibleChanged),e.resetScaleAvailable().unsubscribe(this._updateResetPriceScalesAvailableValue),e===this._lockedPriceScale&&(this._lockedPriceScale=null,this._currentPriceScaleRatio=null);const t=this._leftPriceScales.indexOf(e);-1!==t&&(this._leftPriceScales[t].invalidateMargins(),this._leftPriceScales.splice(t,1));const i=this._rightPriceScales.indexOf(e);if(-1!==i&&(this._rightPriceScales[i].invalidateMargins(),this._rightPriceScales.splice(i,1)),null===e.mainSource()){const t=e.dataSources().length;0!==t&&sl.logError("Invalid priceScale state: empty mainSource but non-empty data sources="+t)}this._onPriceScalesChanged.fire(),this._updateResetPriceScalesAvailableValue()}priceScaleIndex(e,t){switch(t){case"left":return this.leftPriceScales().indexOf(e);case"right":return this.rightPriceScales().indexOf(e)}}move(e,t,i){const s=e.priceScale();this.removeSourceFromPriceScale(e),t.addDataSource(e),e.setPriceScale(t),t.invalidateMargins(),this._processMainSourceChange(),this._invalidateSourcesCache(),e.isIncludedInAutoScale()&&(null!==s&&this.recalculatePriceScale(s,(0,Ds.sourceChangeEvent)(e.id())),this.recalculatePriceScale(t,(0,Ds.sourceChangeEvent)(e.id()))),this._onPriceScalesChanged.fire()}setZOrders(e){e.forEach(((e,t)=>{t.setZorder(e)})),this._invalidateSourcesCache(),this._onDataSourcesZOrdersChanged(),0===this._bulkActions.activeCounter&&this._dataSourcesCollectionChanged.fire(),this.model().fullUpdate()}isMainPane(){return this._isMainPane.readonly()}isLast(){const e=this.model().panes();return e[e.length-1]===this}newStudyZOrder(){return(0,$r.newStudyZOrder)(this._priceDataSources)}newLineToolZOrder(e){return(0,$r.newLineToolZOrder)(this.sourcesByGroup().visibleExceptSpecialSources(),e)}model(){return this._model}containsMainSeries(){return this._sourcesById.has(this.model().mainSeries().id())}applyPriceScaleRatio(e,t){
null!==this._lockedPriceScale&&this._lockedPriceScale!==e||this._currentPriceScaleRatio===t||!this.isMainPane().value()||null===this._lockedPriceScale&&e!==this.mainDataSource()?.priceScale()||(this._setNewPriceRangeByScaleRatio(e,t,this._mainSourceVisiblePriceRange(e),!0,!0),null!==this._lockedPriceScale?this._tryToApplyNewPriceScaleRatio():e.isLog()||this.model().mainSeriesScaleRatioPropertyOnChanged())}sendToBack(e){const t=this.sourcesByGroup().visibleExceptSpecialSources();this._batchReorder(e,t[0],$r.moveBeforeSource)}bringToFront(e){const t=this.sourcesByGroup().allExceptSpecialSources();this._batchReorder(e,t[t.length-1],$r.moveAfterSource)}sendBackward(e){const t=this.sourcesByGroup().allIncludingHidden(),i=t.indexOf(e[0]);if(0===i)this.bringToFront(e);else{const s=t[i-1];this.insertBefore(e,s)}}bringForward(e){const t=this.sourcesByGroup().allExceptSpecialSources(),i=t.indexOf(e[e.length-1]);if(i===t.length-1)this.sendToBack(e);else{const s=t[i+1];this.insertAfter(e,s)}}insertAfter(e,t){this._batchReorder(e,t,$r.moveAfterSource)}insertBefore(e,t){this._batchReorder(e,t,$r.moveBeforeSource)}maximized(){return this._maximized}collapsed(){return this._collapsed}collapsingAvailable(){return this._collapsingAvailable}getPriceScaleById(e){const t=this.m_dataSources.find((t=>t.priceScale()?.id()===e));return void 0===t?null:t.priceScale()}priceScaleSelectionStrategy(){return this._priceScaleSelectionStrategy}setPriceScaleSelectionStrategy(e){this._priceScaleSelectionStrategy=e,e.apply(this)}findTargetPriceAxisViews(e,t,i,s){if((0,_i.isDataSource)(e)&&this.model().paneForSource(e)!==this)return[];const o=e.priceScale();if(t===o)return i;if(null===o)return[];if("overlay"===this.priceScalePosition(o))return t===this.defaultPriceScale()?i:[];const r=this.priceScalePosition(t);if(r!==this.priceScalePosition(o))return[];const n="left"===r?this.leftPriceScales():this.rightPriceScales();return n.indexOf(t)<n.indexOf(o)?s:[]}actionNoScaleIsEnabled(e){return!(!this.isOverlay(e)&&(0,bs.isPriceDataSource)(e))||this._nonOverlayPricesSourcesCount()>1}properties(){return this._properties}setPriceAutoScale(e,t){e.setMode({autoScale:t}),this.timeScale().isEmpty()||this.recalculatePriceScale(e,(0,Ds.viewportChangeEvent)())}state(e){const{withData:t,skipLineToolsFromOtherSymbols:i,wipeSensitiveData:s,skipLineTools:o,skipNonSharedLineTools:r,skipHiddenSources:n,includeSources:a,isStudyTemplate:l}=e??{},c={sources:[],mainSourceId:this.m_mainDataSource?.id(),stretchFactor:this._stretchFactor,leftAxisesState:[],rightAxisesState:[],overlayPriceScales:{},priceScaleRatio:this._currentPriceScaleRatio,isCollapsed:this._collapsed.value(),isMaximized:this._maximized.value(),mode:this._mode},h=new Map,d=new Map,u=e=>{if(h.has(e))return h.get(e);let t=!1;if((0,Nt.isStudy)(e))t=!(e.isVisible()||e.hasChildren()&&e.getAllChildren().some((e=>e.isVisible())));else if((0,Ut.isLineTool)(e))if(e.isVisible()){const i=e.ownerSource();t=!!i&&u(i)}else t=!0;return h.set(e,t),t},_=e=>{if(d.has(e))return d.get(e);let a=null
;const c=l&&!e.isSavedInStudyTemplates()||(0,Ii.isAlertLabel)(e)||!e.state||(0,Ut.isLineTool)(e)&&o||n&&u(e)||!e.isSavedInChart(Boolean(t))||!(a=e.state(t,s))||i&&(0,Ut.isLineTool)(e)&&e.isActualSymbol&&!e.isActualSymbol()||r&&(0,Ut.isLineTool)(e)&&0===e.sharingMode().value()||e.isPhantom()?null:a;return d.set(e,c),c};if(a){c.sources=[];for(let e=0;e<this.m_dataSources.length;e++){const t=_(this.m_dataSources[e]);null!==t&&c.sources.push(t)}}const p=e=>null!==d.get(e),m=e=>!o||!(0,Ut.isLineTool)(e);c.leftAxisesState=this._leftPriceScales.map((e=>({state:e.state(),sources:e.dataSources().filter(p).filter(m).map((e=>e.id()))}))),c.rightAxisesState=this._rightPriceScales.map((e=>({state:e.state(),sources:e.dataSources().filter(p).filter(m).map((e=>e.id()))}))),c.overlayPriceScales={};for(const e of this.m_dataSources)if(this.isOverlay(e)&&e.isSavedInChart(Boolean(t))){const t=e.priceScale();c.overlayPriceScales[e.id()]=t?.state()??null}return c}restoreState(e){const{state:t,withData:i,version:s,seriesId:o=this._model.mainSeries().id(),settingsMigration:r={},contentOverrides:n,restoreSilently:c,reason:h=0,isStudyTemplate:d=!1}=e;(0,va.getPersistentLogger)()?.addPersistentLogEntry(`Restoring pane with seriesId ${o}`,l.LOGLEVEL.INFO,rl),this._mode=t.mode??K.PaneMode.Regular,t.stretchFactor&&(this._stretchFactor=t.stretchFactor);const u={};if(t.sources){const e=t.sources.filter((e=>!!e&&("MainSeries"===e.type||(!e.points?.some((e=>null===e.time_t||!isFinite(e.time_t)))||(sl.logNormal("Dropped invalid "+e.type+". Reason: non-numeric point time"),!1))))),a=e.findIndex(q.isMainSeriesState);-1!==a&&this.model().mainSeries().setObsoleteZOrder(e[a].zorder),s<3&&(0,$r.reorderDataSourcesStateZOrder)(e);const l=-1!==this.m_dataSources.indexOf(this._model.mainSeries());this.clearSeries(Boolean(c)),this.m_mainDataSource=null,l&&this._addSourceToCollections(this._model.mainSeries(),c),(()=>{const i=e.find((e=>e.id===t.mainSourceId));if(void 0===i)return void sl.logWarn("There is no main source with id "+t.mainSourceId+", total sources="+e.length);if(!window.TradingView[i.type]||!(0,se.isLineToolName)(i.type))return void sl.logNormal("The type of main source is not line tool - fix is unnecessary");let s=null;for(const t of e)if(!window.TradingView[i.type]||!(0,se.isLineToolName)(t.type)){if(null!==s)return void sl.logWarn("Pane contains more than 1 possibly main sources - auto fix cannot be applied");s=t}if(null===s)return void sl.logWarn("Pane contains only line tools - possible we need to remove this pane?");const o=t.mainSourceId;let r=0;t.mainSourceId=s.id,e.forEach((e=>{e.ownerSource===o&&(e.ownerSource=s?.id,r+=1)})),sl.logNormal("Auto fix broken pane is applied, changed line tools="+r+", changed from="+o+" to="+s.id)})();for(const t of e)if("study_Sessions"===t.type){const e=t;e.oldState=!0,this.model().sessions().restoreState(e,i);break}for(const t of e)"study_Sessions"!==t.type&&(null===this._model.dataSourceForId(t.id)||"MainSeries"===t.type?(u[t.id]=t.ownerSource,(0,
q.isMainSeriesState)(t)?this._restoreMainSeries(t,i,l,r,n,c,d):(0,q.isStudyState)(t)?this.restoreStudy({source:t,withData:i,seriesId:o,settingsMigration:r,restoreSilently:c,reason:h,skipMainSourceRecalculation:!0}):(0,q.isLineToolState)(t)?(t.state&&(t.state.zOrderVersion=2),this.restoreLineTool({state:t,withData:i,restoreSilently:c})):t.type===wa.ChartEventsSourceId.Value&&this._restoreSpecialSource(t,i,c)):sl.logError("Duplicate id while restoring pane: "+t.type+","+t.id))}const _=new Set,p=(e,t)=>{e.priceScale()!==t&&(this.removeSourceFromPriceScale(e),e.setPriceScale(t),t.addDataSource(e))},m=(e,i,s)=>{if(_.has(e))return;_.add(e);const o=s.m_showSymbolLabels;void 0!==o&&e===this.model().mainSeries()&&this.model().properties().childs().scalesProperties.childs().showSymbolLabels.setValue(o),this._model.children(e,!0,!0).forEach((e=>{t.overlayPriceScales?.[e.id()]||m(e,i,s)})),p(e,i)},g=e=>{const t=(0,En.defaults)("chartproperties").paneProperties.axisProperties,i=new $a(this.model().properties().childs().scalesProperties,t);return i.restoreState(e.state),i.setHeight(this._height),e.sources.forEach((e=>{const s=this.dataSourceForId(e);s&&m(s,i,t)})),0===i.dataSources().length?null:i},S=e=>e.map(g).filter((e=>null!==e));let v;if(t.leftAxisesState)v=S(t.leftAxisesState);else{const e=g({state:t.leftAxisState,sources:t.leftAxisSources});v=null!==e?[e]:[]}let f;if(this._leftPriceScales.slice().forEach((e=>this.removePriceScale(e))),this._leftPriceScales=[],v.forEach((e=>this._placePriceScale(e,"left"))),t.rightAxisesState)f=S(t.rightAxisesState);else{const e=g({state:t.rightAxisState,sources:t.rightAxisSources});f=null!==e?[e]:[]}this._rightPriceScales.slice().forEach((e=>this.removePriceScale(e))),this._rightPriceScales=[],f.forEach((e=>this._placePriceScale(e,"right"))),this._currentPriceScaleRatio=t.priceScaleRatio||t.leftPriceScaleRatio||t.rightPriceScaleRatio||null;const b=new Map;for(const e of this.m_dataSources){if(_.has(e))continue;let i;if(t.overlayPriceScales&&t.overlayPriceScales[e.id()]){let s=t.overlayPriceScales[e.id()];b.has(s?.id)?i=b.get(s?.id):(s=(0,a.ensure)(s),i=new $a(this._model.properties().childs().scalesProperties),i.setHeight(this._height),s.m_isAutoScale=!0,s.m_isLog=!1,s.m_isPercentage=!1,s.m_isLockScale=!1,i.restoreState(s),b.set(s.id,i))}else i=new $a(this._model.properties().childs().scalesProperties),i.setHeight(this._height);p(e,i)}for(const e of Object.keys(u)){const t=u[e],i=this.dataSourceForId(e);t&&i&&null===i.ownerSource()&&i.setOwnerSource(this.dataSourceForId(t))}if(t.mainSourceId&&!this.containsMainSeries()&&(this.m_mainDataSource=this.dataSourceForId(t.mainSourceId)),!this.m_mainDataSource)for(const e of this.m_dataSources)if((0,bs.isPriceDataSource)(e)){this.m_mainDataSource=e;break}for(const e of this.m_dataSources)(0,Ut.isLineTool)(e)?(e.ownerSource()||e.setOwnerSource(this.mainDataSource()),e.isFixed()&&e.restoreFixedPoint()):(0,Nt.isStudy)(e)&&!e.ownerSource()&&e.isLinkedToSeries()&&e.setOwnerSource(this.model().mainSeries());this._collapsed.setValue(t.isCollapsed??!1),
t.isMaximized&&this._model.setMaximizedPane(this),this._updateMargins(),this._cachedOrderedSources.clear()}onPriceScalesChanged(){return this._onPriceScalesChanged}setPaneSize(e){let t;switch(e){case"large":t=1;break;case"medium":t=.6;break;case"small":t=.3;break;case"tiny":t=.15;break;default:throw new Error("Unknown size enum value: "+e)}this._stretchFactor=1e3*t}stretchFactor(){return this._stretchFactor}setStretchFactor(e){this._stretchFactor=e}customSources(e){return this.model().customSources(e)}createDrawingsCaches(){0}clearDrawingCaches(){0}executionsPositionController(){return null}width(){return this._width}height(){return this._height}setHeight(e){if(this._height!==e&&(this._height=e,this._mode===K.PaneMode.Regular)){this._leftPriceScales.forEach((t=>t.setHeight(e))),this._rightPriceScales.forEach((t=>t.setHeight(e)));for(let t=0;t<this.m_dataSources.length;t++){const i=this.m_dataSources[t];this.isOverlay(i)&&i.priceScale()&&(0,a.ensureNotNull)(i.priceScale()).setHeight(e)}this.updateAllViews((0,Ds.viewportChangeEvent)()),this._sizeChanged.fire()}}setWidth(e){return this._width!==e&&(this._width=e,this.updateAllViews((0,Ds.viewportChangeEvent)()),this._sizeChanged.fire(),!0)}onSizeChanged(){return this._sizeChanged}onTagsChanged(){return this._tagsChanged}onDestroyed(){return this._destroyed}dataSourcesCollectionChanged(){return this._dataSourcesCollectionChanged}dataSourcesZOrdersChanged(){return this._dataSourcesZOrdersChanged}symbolSourceCollectionChanged(){return this._symbolSourceCollectionChanged}priceSourcesCollectionChanged(){return this._priceSourcesCollectionChanged}symbolSourceResolved(){return this._symbolSourceResolved}symbolSourceResolvingActive(){return this._symbolSourceResolvingActive}sourcePropertiesChanged(){return this._sourcePropertiesChanged}sourceZOrderChanged(){return this._sourcesZOrderChanged}lineToolsForArea(e,t){const i=this.logicalRectToPixels(e);return[...this.m_dataSources,...this.model().multiPaneSources(this)].filter(Ut.isLineTool).filter((e=>(e.paneViews(this)||[]).some((e=>{const s=e.renderer(t);return s&&s.doesIntersectWithBox&&s.doesIntersectWithBox(i,t)}))))}logicalRectToPixels(e){const t=this.defaultPriceScale(),i=this.timeScale(),s=(0,a.ensureNotNull)((0,a.ensureNotNull)(t.mainSource()).firstValue()),o=t.priceToCoordinate(e.p1.price,s),r=i.indexToCoordinate(e.p1.index),n=t.priceToCoordinate(e.p2.price,s),l=i.indexToCoordinate(e.p2.index),c=new dt.Point(Math.min(r,l),Math.min(o,n)),h=new dt.Point(Math.max(r,l),Math.max(o,n));return(0,dt.box)(c,h)}timeScale(){return this._timeScale}restoreLineTool(e){const{withData:t,restoreSilently:s,actionSource:o,ownerSource:r}=e;let{keepZOrder:n,state:l}=e;if((0,se.isMtpPredictorToolName)(l.type))return sl.logWarn(`No longer supported tool ${l.type} is skipped while restoring state`),null;if(l.targetSignature&&!Ta.shareDrawingsOnIndicators)return sl.logWarn(`Drawing with id ${l.id} was created while share_drawings_on_indicators was on, but now it is off, so it is skipped while restoring state`),null
;const c=r??(l.ownerSource?this._model.dataSourceForId(l.ownerSource):null);if(Ta.shareDrawingsOnIndicators&&(l.ownerSource&&!l.targetSignature&&c&&((0,Nt.isStudy)(c)||(0,Nt.isStudyStub)(c))&&(l.targetSignature=c.signature().value()??void 0),l.targetSignature&&!this.isMainPane().value()))return(0,a.ensureNotNull)(this._model.mainPane()).restoreLineTool(e);delete l.state.lastUpdateTime,l.state.intervalsVisibilities=(0,Xa.mergeIntervalVisibilitiesDefaults)(l.state.intervalsVisibilities),n=void 0===n||n,Ya.LineToolElliott.migrateState(l),function(e){"LineToolGannComplex"!==e.type||void 0!==e.version&&1!==e.version||(e.type="LineToolGannFixed")}(l),Array.isArray(l.positionPercents)&&(l.positionPercents=l.positionPercents[0]);const d=l.type,u=l.id,_=l.state,p=n?l.zorder:this.newLineToolZOrder();(0,a.assert)((0,se.isLineToolName)(d),"invalid data source type:"+d+" (expected to be a Line Tool)");let m,g,S=null;if((0,q.isStudyLineToolState)(l)){S=this._model.isSnapshot()?new Qa.StudyVersioning([],[]):(0,Qe.studyMetaInfoRepository)().studyVersioning();const e=Qa.StudyVersioning.patchPointsBasedStudyState(l);l=e;const r=new et.StudyMetaInfo(e.metaInfo);if(!t&&r){const e=r.productId;if(!window.pro?.hasPackage(e)){const e=new ya.StudyLineToolStub(this._model,l,r.shortDescription);return e.setId(u),this._addSourceToCollections(e,s),void 0!==p&&e.setZorder(p),e.setFailed(h.t(null,void 0,i(386373))),null}}const n=S.updateMetaInfo(r)??r;g=(0,Ut.createStudyLineToolProperties)(this._model.backgroundTheme().spawnOwnership(),d,r,n,_,S),m=(0,Ut.createLineTool)(d,this._model,g,n,!0,void 0,o)}else g=(0,Ut.createLineToolProperties)(this._model.backgroundTheme().spawnOwnership(),d,!this._model.readOnly(),_),m=(0,Ut.createLineTool)(d,this._model,g,null,!0,void 0,o);m.setId(u),m.linkKey().setValue(l.linkKey||null);const v=l.alertId;v&&m.canHasAlert()&&ws.alertsAvailable&&!this._model.readOnly()&&!this._model.isJustClonedChart()&&m.restoreAlert(+v);let f=l.indexes??[];if(f=f.slice(0,l.points?.length??f.length),m.isFixed()?void 0!==l.positionPercents?m.restorePositionPercents(l.positionPercents):m.restorePositionPercents({x:.5,y:.5}):l.points&&m.restorePoints(l.points,f,t),m.restoreData){const e=l;(0,q.isStudyLineToolState)(e)?t&&(S&&(e.graphics=Qa.StudyVersioning.patchPointsBasedStudyData(new et.StudyMetaInfo(e.metaInfo),e.graphics)),m.restoreData(e)):m.restoreData(e)}const b=null==l.version?1:l.version,y=null==m.version?1:m.version;return b!==y&&m.migrateVersion?.(b,y,{pane:this,model:this._model,properties:g}),void 0!==p&&m.setZorder(p),r&&(0,Ut.prepareLineToolPropertiesByOwnerSource)(g,r),l.targetSignature&&m.supportsTargetSignature()&&!(0,Nt.isStudyStub)(c)?m.setTargetSignature(l.targetSignature):m.setOwnerSource(c),m.isFixed()&&m.restoreFixedPoint(),void 0!==l.sharingMode&&m.share(l.sharingMode),this._addSourceToCollections(m,s),this._cachedOrderedSources.clear(),m}restoreStudy(e){const{source:t,withData:r,seriesId:n=this._model.mainSeries().id(),settingsMigration:a,restoreSilently:l,reason:c,skipMainSourceRecalculation:d}=e
;if(r&&void 0===t.data&&void 0===t.nonSeriesData&&void 0===t.indexes)return sl.logError("Cannot restore (skipping) study without data "+t.id+", "+t.metaInfo.id),null;const u=t.metaInfo,_=(0,o.default)(u);_&&(sl.logWarn(`Cannot restore (skipping) study with string metaInfo, probably chart overwriting ${u}`),t.metaInfo={...de(u),inputs:[]});const p=t.id,m=t.state,g=t.zorder,S=(t.parentSources??(t.ownerSource?[t.ownerSource]:[])).filter((e=>e!==n));let v=new et.StudyMetaInfo(t.metaInfo),f=t.metaInfoPatch?(0,s.default)((0,an.default)(t.metaInfo),t.metaInfoPatch):t.metaInfo,b=new et.StudyMetaInfo(f);if(function(e){return"Script$TV_EARNINGS@tv-scripting"===e||"Script$TV_DIVIDENDS@tv-scripting"===e||"Script$TV_SPLITS@tv-scripting"===e||"ESD$TV_EARNINGS@tv-scripting"===e||"ESD$TV_DIVIDENDS@tv-scripting"===e||"ESD$TV_SPLITS@tv-scripting"===e||"Earnings@tv-basicstudies"===e||"Dividends@tv-basicstudies"===e||"Splits@tv-basicstudies"===e||"BarSetContinuousRollDates@tv-corestudies"===e}(b.id)&&!r)return sl.logNormal("Skipping study "+b.id),null;let y=m;const w=new Ln.StudyStub(this._model,t,b.shortDescription??b.name);w.setId(p),w.setZorder(g);const C=Za.DeferredStudies.instance(this._model);C.get(p);let T=!1;const P=(e,i,s)=>{if(T&&this._model.dataSourceForId(p)!==w)return;w.setStatus({type:Ka.StudyStatusType.Undefined});const o=async o=>{const n=(0,An.prepareStudyPropertiesForLoadChart)(b,e,y,s),a=e??b,l=i??v,h=!r&&a.isTVScript&&t.metaInfo.isTVScript&&a._serverMetaInfoVersion!==t.metaInfo._serverMetaInfoVersion,d=await(0,Nt.createStudy)(this._model,n,o,a,l,void 0,c,h);if(d.setId(p),d.setOwnFirstValue(t.ownFirstValue??null),t.customFields&&d.restoreStateCustomFields(t.customFields),r){const e=t,{data:i,nsData:s,indexes:o}=Qa.StudyVersioning.patchStudyData(b,e.data,e.nonSeriesData,e.indexes);d.restoreData(i,s,o)}this._model.replaceStudyStub(w,d),C.add(p,d)};if(S.length>0){const e=S.map((e=>C.get(e)));Promise.all(e).then(o)}else o([])},M=(0,an.default)(m),x=_?Promise.resolve().then((()=>{const e=et.StudyMetaInfo.parseIdString(t.metaInfo.fullId),i="tv-scripting"===e.packageId?{type:"pine",pineId:et.StudyMetaInfo.cutBeforeDollar(e.shortId),pineVersion:t.metaInfo.pine?.version}:{type:"java",studyId:e.id};return(0,Qe.studyMetaInfoRepository)().findById(i)})).then((e=>{if(!e)throw new Error("Cannot get study metaInfo: "+t.metaInfo.fullId);v=e,t.metaInfo=e.state(),f=t.metaInfoPatch?(0,s.default)((0,an.default)(t.metaInfo),t.metaInfoPatch):t.metaInfo,b=new et.StudyMetaInfo(f)})):Promise.resolve();let I;if(r){const e=Qa.StudyVersioning.patchPropsStateAndMetaInfo(m,b,{oldShowStudyLastValueProperty:!a?.showStudyLastValueProperty}),t=Qa.StudyVersioning.patchPropsStateAndMetaInfo(M,v,{oldShowStudyLastValueProperty:!a?.showStudyLastValueProperty});I=Promise.resolve([new et.StudyMetaInfo(e.metaInfo),new et.StudyMetaInfo(t.metaInfo)])}else{{const e=(0,
Qe.studyMetaInfoRepository)().requestMetaInfo().then((()=>Promise.all([i.e(25118),i.e(88736),i.e(30242),i.e(4998),i.e(3052),i.e(70438),i.e(26492),i.e(93868),i.e(67618),i.e(49894),i.e(60802),i.e(40760),i.e(93867),i.e(77435),i.e(2253),i.e(49615),i.e(50468),i.e(38953),i.e(7908),i.e(47538)]).then(i.bind(i,164269))));I=x.then((()=>Promise.all([b,v].map(((t,i)=>e.then((e=>{const{pineIdForJavaId:s,migrateJavaStateToPine:o}=e,n=s(t.id);if(n)return(0,Qe.studyMetaInfoRepository)().findById({pineId:n,pineVersion:"last",type:"pine"}).then((e=>(o(0===i?m:M,t,e),b=e,N.emit("chart_migrated"),e)));{const e=Qa.StudyVersioning.patchPropsStateAndMetaInfo(0===i?m:M,t,{oldShowStudyLastValueProperty:r&&!a?.showStudyLastValueProperty});return y=e.propsState,new et.StudyMetaInfo(e.metaInfo)}})))))))}}I.then((([e,t])=>{const s=this._model.isSnapshot()?new Qa.StudyVersioning([],[]):(0,Qe.studyMetaInfoRepository)().studyVersioning();if(this._model.isSnapshot())return void P(e,t,s);const o=[e,t].map(((e,t)=>s.updateMetaInfoAsync(e,1===t))).map((e=>e.sync?Promise.resolve(e.result):e.result));Promise.all(o).then((i=>P(i[0]??e,i[1]??t,s))).catch((e=>{"To use it, ask the author to publish the script."===e?w.setFailed(e,h.t(null,void 0,i(300558))):w.setFailed("error: "+e)}))})).catch((()=>w.setFailed(h.t(null,{context:"Study loading in chart"},i(770941))))),w.setZorder(g);const L=t.metaInfo.linkedToSeries?this._model.mainSeries():S.length?this.dataSourceForId(S[0]):null;return w.setOwnerSource(L),this._addSourceToCollections(w,l),T=!0,d||this._processMainSourceChange(),this._cachedOrderedSources.clear(),w}clipboardLineToolOwnerSource(e){const t=this.dataSourceForId(e);if(null!==t){const e=t.ownerSource();if(null!==e&&null!==e.firstValue())return e}const i=this.mainDataSource();if(null!==i&&null!==i.firstValue())return i;for(const e of this.dataSources())if((0,bs.isPriceDataSource)(e)&&null!==e.firstValue())return e;return null}realignLineTools(e){let t=!1;for(const i of this.m_dataSources)!(0,Ut.isLineTool)(i)||void 0!==e&&i?.ownerSource()?.symbolSource()!==e&&(0,So.isActingAsSymbolSource)(e)||(i.realign(),i.updateAllViews((0,Ds.sourceChangeEvent)(i.id())),t=!0);return t&&this._invalidateSourcesCache(),t}startScalePrice(e,t){e.startScale(t)}scalePriceTo(e,t){e.scaleTo(t),this.updateAllViews((0,Ds.viewportChangeEvent)())}endScalePrice(e){e.endScale()}startScrollPrice(e,t){e.startScroll(t)}scrollPriceTo(e,t){e.scrollTo(t),this.updateAllViews((0,Ds.viewportChangeEvent)())}endScrollPrice(e){e.endScroll()}resetPriceScale(e){const t=this.timeScale().visibleBarsStrictRange(),i=this.timeScale().logicalRange();e.resetScaleAvailable().value()&&e.resetScale(),e.recalculatePriceRange(t,i),this.updateAllViews((0,Ds.viewportChangeEvent)())}resetPriceScalesAvailable(){return this._resetPriceScalesAvailable.readonly()}restorePriceScaleState(e,t){e.restoreState(t),this.updateAllViews((0,Ds.viewportChangeEvent)())}beginInsertManyLineDataSources(){this._isInInsertManyDataSourcesState=!0,this._lastLineDataSourceZOrder=null}endInsertManyLineDataSources(){
this._isInInsertManyDataSourcesState=!1,this._lastLineDataSourceZOrder=null;{const e=(0,a.ensureNotNull)(this.model().alertsWatcher());for(const t of this.m_dataSources)e.syncSourceAlertLabels(t)}}removeSourceFromPriceScale(e){const t=e.priceScale();if(null!==t){const i=t.dataSources();i.indexOf(e)>=0&&t.removeDataSource(e),0===i.length&&this.removePriceScale(t)}}_invalidateSourcesCache(){this._cachedOrderedSources.clear(),this._leftPriceScales.forEach((e=>e.invalidateSourcesCache())),this._rightPriceScales.forEach((e=>e.invalidateSourcesCache()))}_processMainSourceChange(){let e=!1;if(null===this.m_mainDataSource)for(const t of this.m_dataSources)if((0,bs.isPriceDataSource)(t)&&!this.isOverlay(t)&&(!(0,Nt.isStudy)(t)||!t.isLinkedToSeries())){this.m_mainDataSource=t,e=!0;break}if(this.m_mainDataSource&&e){let e=this.m_dataSources.filter(Ut.isLineTool);e=(0,zo.sortSources)(e);for(const t of e)this.move(t,(0,a.ensureNotNull)(this.m_mainDataSource.priceScale()),!0)}else if(!this.m_mainDataSource||this.isOverlay(this.m_mainDataSource)&&0===this._nonOverlayPricesSourcesCount()){let e=null;if(this.m_dataSources.includes(this._model.mainSeries()))e=this._model.mainSeries();else for(const t of this.m_dataSources)if((0,bs.isPriceDataSource)(t)&&this.isOverlay(t)&&t.showInObjectTree()){e=t;break}if(null!==e){const t=this.m_mainDataSource===e;this.m_mainDataSource=e;const i=this.createNewPriceScaleIfPossible();if(t&&e===this._model.mainSeries()){const t=(0,a.ensureNotNull)(e.priceScale());this._model.children(e,!0,!0).forEach((e=>{this.removeSourceFromPriceScale(e),i.addDataSource(e),e.setPriceScale(i)})),this.removePriceScale(t)}this.move(e,i,!0),this.recalculatePriceScale(e.priceScale(),(0,Ds.globalChangeEvent)())}}}_addSourceToCollections(e,t){this.m_dataSources.push(e),this._sourcesById.set(e.id(),e),this._invalidateSourcesCache();const i=()=>{this._sourcePropertiesChanged.fire(e)};if(e.properties().subscribe(this,i),e.zOrderChanged().subscribe(this,(t=>this._sourcesZOrderChanged.fire(e,t))),(0,Ut.isLineTool)(e)){e.normalizedPointsChanged().subscribe(this,i),e.fixedPointChanged().subscribe(this,i),e.onIsActualSymbolChange().subscribe(this,(()=>this._invalidateSourcesCache())),e.hasAlert().subscribe(i),e.sharingMode().subscribe(i);const t=()=>{this._lineToolsByLinkKey.removeByKey2(e.id()),this._lineToolsByLinkKey.add(e)};e.linkKey().subscribe(t),this._sourceWatchedValuesSubscriptions.set(e.id(),{linkKeyCallback:t,commonCallback:i}),this._lineToolsByLinkKey.add(e)}const s=(0,So.isSymbolSource)(e)?e:null;if((0,bs.isPriceDataSource)(e)&&(this._priceSourcesById.set(e.id(),e),e.currencyChanged().subscribe(this,(()=>this._invalidateSourcesCache())),e.unitChanged().subscribe(this,(()=>this._invalidateSourcesCache())),this._priceDataSources.push(e),(0,Nt.isStudy)(e)&&this._studySources.push(e),this._onPriceSourcesCollectionChanged(),null!==s&&(this._symbolSources.push(s),s.symbolResolved().subscribe(this,(()=>this._symbolSourceResolved.fire(e))),s.symbolResolvingActive().subscribe(this._recalcSymbolSourceResolvingActive),
s.symbolHibernated().subscribe(this._onSymbolSourceCollectionChanged),this._recalcSymbolSourceResolvingActive(),this._onSymbolSourceCollectionChanged(),s===this._model.mainSeries()&&this._isMainPane.setValue(!0)),(0,Nt.isStudy)(e)||(0,Nt.isStudyStub)(e))){const t=e.metaInfo();t&&(0,Ca.isCountedUserScript)(t)&&(0,Ca.addUserScriptOnLayout)(t.scriptIdPart,(0,a.ensureDefined)(t.pine).version)}e.isMultiPaneAvailable()&&this.model().addMultiPaneSource(e),Ft(e)&&(this._lollipopDataSources.push(e),this.updateLollipopViews((0,Ds.sourceChangeEvent)(e.id()))),t||0!==this._bulkActions.activeCounter||this._dataSourcesCollectionChanged.fire()}_removeSourceFromCollections(e,t){const i=this.m_dataSources[e],s=i.id();if(i.properties().unsubscribeAll(this),i.zOrderChanged().unsubscribeAll(this),this.m_dataSources.splice(e,1),this._sourcesById.delete(i.id()),(0,Ut.isLineTool)(i)){if(i.normalizedPointsChanged().unsubscribeAll(this),i.fixedPointChanged().unsubscribeAll(this),i.onIsActualSymbolChange().unsubscribeAll(this),this._sourceWatchedValuesSubscriptions.has(s)){const e=this._sourceWatchedValuesSubscriptions.get(s);e&&(i.hasAlert().unsubscribe(e.commonCallback),i.linkKey().unsubscribe(e.linkKeyCallback)),this._sourceWatchedValuesSubscriptions.delete(s)}this._lineToolsByLinkKey.removeByKey2(i.id())}this._invalidateSourcesCache();const o=(0,So.isSymbolSource)(i)?i:null;if((0,bs.isPriceDataSource)(i)&&(this._priceSourcesById.delete(i.id()),i.currencyChanged().unsubscribeAll(this),i.unitChanged().unsubscribeAll(this),(0,J.removeItemFromArray)(this._priceDataSources,i),(0,Nt.isStudy)(i)&&(0,J.removeItemFromArray)(this._studySources,i),this._onPriceSourcesCollectionChanged(),null!==o&&((0,J.removeItemFromArray)(this._symbolSources,o),o.symbolResolved().unsubscribeAll(this),o.symbolResolvingActive().unsubscribe(this._recalcSymbolSourceResolvingActive),o.symbolHibernated().unsubscribe(this._onSymbolSourceCollectionChanged),this._recalcSymbolSourceResolvingActive(),this._onSymbolSourceCollectionChanged(),o===this._model.mainSeries()&&this._isMainPane.setValue(!1)),(0,Nt.isStudy)(i)||(0,Nt.isStudyStub)(i))){const e=i.metaInfo();e&&(0,Ca.isCountedUserScript)(e)&&(0,Ca.removeUserScriptFromLayout)(e.scriptIdPart,(0,a.ensureDefined)(e.pine).version)}i.isMultiPaneAvailable()&&this.model().removeMultiPaneSource(i),Ft(i)&&((0,J.removeItemFromArray)(this._lollipopDataSources,i),this.updateLollipopViews((0,Ds.sourceChangeEvent)(i.id()))),t||0!==this._bulkActions.activeCounter||this._dataSourcesCollectionChanged.fire()}_recalculatePriceScaleByScaleRatio(e){this.isMainPane().value()&&e===this._lockedPriceScale&&(null!==this._currentPriceScaleRatio?this._applyOldScaleRatioToPriceScale():this._tryToApplyNewPriceScaleRatio())}_defaultBottomMargin(){return.01*this.properties().childs().bottomMargin.value()}_defaultTopMargin(){return.01*this.properties().childs().topMargin.value()}_updateMargins(){const e=this._defaultTopMargin(),t=this._defaultBottomMargin();for(const i of this._leftPriceScales)ol(i,e,t);for(const i of this._rightPriceScales)ol(i,e,t)
;for(const i of this.m_dataSources)if(this.isOverlay(i)){const s=i.priceScale();null!==s&&(ol(s,e,t),this.recalculatePriceScale(s,(0,Ds.viewportChangeEvent)()))}for(const e of this._leftPriceScales)this.recalculatePriceScale(e,(0,Ds.viewportChangeEvent)());for(const e of this._rightPriceScales)this.recalculatePriceScale(e,(0,Ds.viewportChangeEvent)());this.updateAllViews((0,Ds.viewportChangeEvent)())}_batchReorder(e,t,i){i(this.sourcesByGroup().visibleExceptSpecialSources(),e,t),this._invalidateSourcesCache(),this._dataSourcesCollectionChanged.fire(),this._onDataSourcesZOrdersChanged(),this.model().fullUpdate()}_placePriceScale(e,t,i){if("overlay"===t)return void e.invalidateMargins();const s="left"===t?this._leftPriceScales:this._rightPriceScales,o=void 0===i?s.length:i;s.splice(o,0,e),e.modeChanged().subscribe(this,this._onPriceScaleModeChanged.bind(this,e)),e.internalHeightChanged().subscribe(this,this._recalculatePriceScaleByScaleRatio.bind(this,e)),e.priceRangeChanged().subscribe(this,this._recalculateTimeScaleByScaleRatio.bind(this,e)),e.priceRangeChanged().subscribe(this,this._onPriceScaleSetMinMaxPriceRange.bind(this,e)),e.isVisible().subscribe(this._onPriceScaleIsVisibleChanged),e.resetScaleAvailable().subscribe(this._updateResetPriceScalesAvailableValue),e.isLockScale()&&((0,a.assert)(null===this._lockedPriceScale),this._lockedPriceScale=e,this._currentPriceScaleRatio=null),e.invalidateMargins(),this._onPriceScalesChanged.fire(),this._updateResetPriceScalesAvailableValue()}_onPriceScaleModeChanged(e,t,i){if(i.lockScale&&(this._lockedPriceScale!==e&&null!==this._lockedPriceScale&&this._lockedPriceScale.setMode({lockScale:!1}),this._lockedPriceScale=e,this._currentPriceScaleRatio=(0,wn.scaleRatio)(this.timeScale(),e)),t.lockScale&&!i.lockScale&&(this._lockedPriceScale=null,this._currentPriceScaleRatio=null),t.percentage===i.percentage&&t.indexedTo100===i.indexedTo100)return;const s=this.timeScale().visibleBarsStrictRange(),o=this.timeScale().logicalRange();null!==s&&null!==o&&(e.recalculatePriceRange(s,o),e.updateAllViews((0,Ds.viewportChangeEvent)()))}_applyOldScaleRatioToPriceScale(){this._isRecalculatingScales||null===this._currentPriceScaleRatio||null===this._lockedPriceScale||(this._isRecalculatingScales=!0,this._setNewPriceRangeByScaleRatio(this._lockedPriceScale,this._currentPriceScaleRatio,this._mainSourceVisiblePriceRange(this._lockedPriceScale)),this._isRecalculatingScales=!1)}_setNewPriceRangeByScaleRatio(e,t,i,s,o){const r=(0,wn.priceRangeByScaleRatio)(e,this.timeScale().barSpacing(),t);e.setPriceRange(null!==r?r:i,s,o)}_applyOldScaleRatioToTimeScale(){this._isRecalculatingScales||null===this._currentPriceScaleRatio||(this._isRecalculatingScales=!0,this._setNewBarSpacingByScaleRatio(),this._isRecalculatingScales=!1)}_tryToApplyNewPriceScaleRatio(){const e=(0,a.ensureNotNull)(this._lockedPriceScale),t=(0,wn.scaleRatio)(this.timeScale(),e);this._currentPriceScaleRatio===t||e.isLog()||(this._currentPriceScaleRatio=t,this.model().mainSeriesScaleRatioPropertyOnChanged())}
_recalculateTimeScaleByScaleRatio(e){e===this._lockedPriceScale&&(null!==this._currentPriceScaleRatio?this._applyOldScaleRatioToTimeScale():this._tryToApplyNewPriceScaleRatio())}_setNewBarSpacingByScaleRatio(){const e=this.timeScale().getValidBarSpacing((0,wn.barSpacingByScaleRatio)((0,a.ensureNotNull)(this._lockedPriceScale),this._currentPriceScaleRatio));this.timeScale().isValidBarSpacing(e)&&this.timeScale().setBarSpacing(e)}_mainSourceVisiblePriceRange(e){const t=this.timeScale(),i=t.visibleBarsStrictRange();if(null===i)return new Ea.PriceRange(-.5,.5);const s=(0,a.ensureNotNull)(t.logicalRange()),o={startTimePoint:i.firstBar(),endTimePoint:i.lastBar(),logicStartPoint:s.left(),logicEndPoint:s.right(),targetPriceScale:e,scaleSeriesOnly:e.isScaleSeriesOnly()};return(0,a.ensureNotNull)((0,a.ensureNotNull)(e.mainSource()).priceRange(o))}_setMinMaxPriceRange(){const e=(0,a.ensureNotNull)(this._lockedPriceScale),t=(0,wn.priceRangeByScaleRatio)(e,this.timeScale().maxBarSpacing(),this._currentPriceScaleRatio),i=(0,wn.priceRangeByScaleRatio)(e,this.timeScale().minBarSpacing(),this._currentPriceScaleRatio);null!==t&&e.setMaxPriceRange(t),null!==i&&e.setMinPriceRange(i)}_onPriceScaleSetMinMaxPriceRange(e){e===this._lockedPriceScale&&this._setMinMaxPriceRange()}_onDataSourcesZOrdersChanged(){0===this._bulkActions.activeCounter?this._dataSourcesZOrdersChanged.fire():this._bulkActions.dataSourcesZOrdersChanged=!0}_onPriceSourcesCollectionChanged(){0===this._bulkActions.activeCounter?this._priceSourcesCollectionChanged.fire():this._bulkActions.priceSourcesCollectionChanged=!0}_nonOverlayPricesSourcesCount(){return this.m_dataSources.filter((e=>(!(0,Nt.isStudy)(e)||!e.isLinkedToSeries())&&((0,bs.isPriceDataSource)(e)&&e.showInObjectTree()&&!this.isOverlay(e)))).length}_restoreMainSeries(e,t,i,s,o,r,h){const d=e.id,u=e.state;if(u&&o&&(u.style=o.style??u.style,u.interval=o.interval||u.interval,o.symbol&&o.symbol!==u.symbol&&(u.symbol=o.symbol,delete u.currencyId,delete u.unitId)),u&&["candleStyle","hollowCandleStyle","haStyle"].forEach((e=>{u[e]&&(u[e].wickUpColor=u[e].wickUpColor||u[e].wickColor,u[e].wickDownColor=u[e].wickDownColor||u[e].wickColor)})),u&&(u.statusViewStyle=u.statusViewStyle||{},!u.statusViewStyle.symbolTextSource)){const e=!!u.statusViewStyle.showSymbolAsDescription;u.statusViewStyle.symbolTextSource=e?"ticker":"description"}if(u){u.extendedHours?u.sessionId="extended":u.sessionId||(u.sessionId="regular"),delete u.extendedHours,(0,Ja.allChartStyles)().includes(u.style)||(u.style=2);const e=u.lineStyle.styleType;let t;delete u.lineStyle.styleType,0===e&&(t=14,u.lineWithMarkersStyle=(0,n.clone)(u.lineStyle)),1===e&&(t=15,u.steplineStyle=(0,n.clone)(u.lineStyle)),void 0!==t&&2===u.style&&(u.style=t);const i=u.volFootprintStyle?.extendedSummary?.futuresBlockInfo;i&&(u.volFootprintStyle.extendedSummary.extendedOpenInterestBlockInfo={openInterestLow:{visible:i.openInterestLow.visible??!0},openInterestHigh:{visible:i.openInterestHigh.visible??!0}},delete u.volFootprintStyle.extendedSummary.futuresBlockInfo)
;const s=this._model.timezoneExceptExchange().value();let o=u.svpStyle?.inputs?.customSessionTZ??null;if(null!==s&&null!==o&&(o="exchange"===o.toLowerCase()?s:o,o!==s)){const e=u.svpStyle.inputs.customSession??"",[t,i]=e.split("-"),r=(0,c.get_timezone)(o),n=(0,c.get_timezone)(s),a=il(t,r,n),l=il(i,r,n);u.svpStyle.inputs.customSession=`${a}-${l}`,u.svpStyle.inputs.customSessionTZ=s}}if(u)for(const e of["lineStyle","lineWithMarkersStyle","steplineStyle"])tl(u[e]);if(!i){const e=this._model.mainSeries();(0,a.ensureNotNull)(this._model.mainPane()).removeDataSource(e,!1,r),this._addSourceToCollections(e,r)}const _=this.model().mainSeries(),p=_.properties().childs();this.m_mainDataSource=_;const m=u&&u.style?u.style:void 0;6===m&&"ATR"===p.pnfStyle.childs().inputs.childs().style.value()?p.pnfStyle.childs().inputs.childs().style.setValueSilently("Traditional"):4===m&&"ATR"===p.renkoStyle.childs().inputs.childs().style.value()&&p.renkoStyle.childs().inputs.childs().style.setValueSilently("Traditional"),u&&!u.hasOwnProperty("showSessions")&&(u.showSessions=!1),u&&void 0===u.settlementAsClose&&(u.settlementAsClose=!1),u&&t&&(u.showCountdown=!1),u&&(t&&!("showSeriesLastValueProperty"in s)&&"showLastValue"in u&&this._model.properties().childs().scalesProperties.childs().showSeriesLastValue.setValue(u.showLastValue),delete u.showLastValue),u&&this._restoreMainSeriesStudyInputs(e,_.styleStudyInfos());const g=_.sessionId();(0,va.getPersistentLogger)()?.addPersistentLogEntry(`Restore series. source.id: ${e.id} id: ${d}`,l.LOGLEVEL.INFO,rl),_.restoreState(e,t,h),this.changeSourceId(_,d),(0,va.getPersistentLogger)()?.addPersistentLogEntry(`Series has been successfully restored. id: ${_.id()}`,l.LOGLEVEL.INFO,rl),_.sessionId()!==g&&p.sessionId.fireChanged()}async _restoreMainSeriesStudyInputs(e,t){await(0,Qe.studyMetaInfoRepository)().requestMetaInfo();const i=(0,Qe.studyMetaInfoRepository)().studyVersioning(),s=(0,a.ensureDefined)(e.state),o={haStyle:(0,Q.chartStyleStudyId)(8,!0,s.haStyle?.inputs),renkoStyle:(0,Q.chartStyleStudyId)(4,!0,s.renkoStyle?.inputs),pbStyle:(0,Q.chartStyleStudyId)(7,!0,s.pbStyle?.inputs),kagiStyle:(0,Q.chartStyleStudyId)(5,!0,s.kagiStyle?.inputs),pnfStyle:(0,Q.chartStyleStudyId)(6,!0,s.pnfStyle?.inputs),rangeStyle:(0,Q.chartStyleStudyId)(11,!0,s.rangeStyle?.inputs),volFootprintStyle:(0,Q.chartStyleStudyId)(17,!0,s.volFootprintStyle?.inputs),tpoStyle:(0,Q.chartStyleStudyId)(18,!0,s.tpoStyle?.inputs),svpStyle:(0,Q.chartStyleStudyId)(20,!0,s.svpStyle?.inputs)},r={};for(const[n]of Object.entries(j.SYMBOL_STRING_DATA)){const a=`${j.STYLE_SHORT_NAMES[n]}Style`,l=s[a]?.inputs;if(null==l)continue;const c=a in e?e[a].studyId:o[a],h=et.StudyMetaInfo.parseIdString(c),d=t[a].studyId,u=et.StudyMetaInfo.parseIdString(d),_=i.updateStudyInputs(h.id,h.version,u.version,l.inputs,null);r[a]={inputs:_}}this.model().mainSeries().properties().mergeAndFire(r)}_restoreSpecialSource(e,t,i){e.type===wa.ChartEventsSourceId.Value&&t&&this._model.restoreChartEvents(e)}_processAfterBulkAction(){const e=this._bulkActions
;0===e.activeCounter&&(this._dataSourcesCollectionChanged.fire(),e.symbolSourceCollectionChanged&&(this._symbolSourceCollectionChanged.fire(),e.symbolSourceCollectionChanged=!1),e.priceSourcesCollectionChanged&&(this._priceSourcesCollectionChanged.fire(),e.priceSourcesCollectionChanged=!1),e.dataSourcesZOrdersChanged&&(this._dataSourcesZOrdersChanged.fire(),e.dataSourcesZOrdersChanged=!1))}}var al=i(991321),ll=i(781608);const cl=(0,l.getLogger)("Chart.TimePoints");function hl(e,t){return null===e||null===t?e===t:e.firstIndex===t.firstIndex&&e.lastIndex===t.lastIndex}class dl{constructor(){this._zoffset=0,this._items=[],this._range=new z.WatchedObject(null,hl)}clear(){this._zoffset=0,this._items=[],this._range.setValue(null)}size(){return this._items.length}range(){return this._range.readonly()}merge(e,t,i){const s=this._mergeImpl(e,t,i);return this._updateFirstAndLastIndex(),s}addTail(e,t){for(let i=t?1:0;i<e.length;i++)this._items.push(e[i]);this._updateFirstAndLastIndex()}remove(e){const t=this._indexToOffset(e);if(null===t)return[];const i=this._items.splice(t),s=[];for(let t=0;t<i.length;t++)s.push({change:"remove",index:e+t,value:i[t]});return this._updateFirstAndLastIndex(),s}valueAt(e){const t=this._indexToOffset(e);return null!==t?this._items[t]:null}indexOf(e,t){if(this._items.length<1)return null;if(e>this._items[this._items.length-1])return t?this._validOffsetToIndex(this._items.length-1):null;for(let i=0;i<this._items.length;++i){if(e===this._items[i])return this._validOffsetToIndex(i);if(e<this._items[i])return t?this._validOffsetToIndex(i):null}return null}state(e){let t=0,i=this._items.length;return null!==e&&(t=this._indexToOffset(e.firstBar())??0,i=(this._indexToOffset(e.lastBar())??i-1)+1),{items:this._items.slice(t,i),zoffset:this._zoffset-t}}restoreState(e){null!==e&&(this._items=e.items,this._zoffset=e.zoffset,this._updateFirstAndLastIndex())}roughTime(e,t=null){e=Math.round(e);const i=this.valueAt(e);if(null!==i)return i;const s=this._items;if(!s.length||s.length<2)return null;const o=s.length-1,r=this._validOffsetToIndex(0),n=this._validOffsetToIndex(o),a=s[0],l=s[o],c=(l-a)/(n-r);if(e<r){return a-(r-e)*c}if(e>n){const i=e-n;if(i<500&&null!=t)return t(l,i);return l+i*c}return null}roughIndex(e,t=null,i=0){const s=this._items;if(!s.length||s.length<2)return null;const o=s.length-1,r=this._validOffsetToIndex(0),n=this._validOffsetToIndex(o),a=s[0],l=s[o];if(e>=a&&e<=l)return this._closestIndex(e,i);const c=(l-a)/(n-r);if(e<a){const t=a-e;return r-Math.round(t/c)}if(e>l){const i=e-l;let s=Math.trunc(i/c);if(s<500&&null!==t){const i=t(l,e);i.success&&(s=i.result)}return n+s}return null}closestIndexLeft(e){return this._closestIndex(e,0)}firstPoint(){return 0===this._items.length?null:this._items[0]}lastPoint(){return 0===this._items.length?null:this._items[this._items.length-1]}_closestIndex(e,t){const i=this._items;if(!i.length)return null;if(Number.isNaN(e))return null;const s=i.length-1;if(e>=i[s])return this._validOffsetToIndex(s);const o=(0,J.lowerbound)(this._items,e,((e,t)=>e<t))
;if(o<=s&&this._items[o]===e)return this._validOffsetToIndex(o);if(0===t)return 0===o?null:this._validOffsetToIndex(o-1);if(1===t)return o>s?null:this._validOffsetToIndex(o);const r=e-(this._items[o-1]??-1/0),n=(this._items[o]??1/0)-e;return this._validOffsetToIndex(r<n?o-1:o)}_mergeImpl(e,t,i){if(0===i.length)return cl.logError("merge: 'values' does not contain any time points"),[];if(t>this._zoffset&&e+t>0)return cl.logError("merge: when the first time point index is updated, we should fill the time points starting from the first one"),[];if(0===this._items.length)return this._items=i.slice(),this._zoffset=t,[{change:"rebuild",index:this._validOffsetToIndex(0)}];const s=e+this._zoffset;if(s<0){const o=Math.abs(s);if(i.length<o)return cl.logError("merge: 'values' does not contain enough time points to fill in the new items. 'index': "+e.toString()+", previous 'zoffset': "+this._zoffset.toString()+", new 'zoffset': "+t.toString()+", 'values.length': "+i.length),[];this._items=new Array(o).concat(this._items),this._zoffset=t;for(let s=0;s<i.length;++s)this._items[e+s+t]=i[s];return[{change:"rebuild",index:this._validOffsetToIndex(0)}]}const o=[];let r=s;for(;r<this._items.length&&r-s<i.length;++r)this._items[r]=i[r-s],o.push({change:"update",index:this._validOffsetToIndex(r),value:i[r-s]});const n=s+i.length;if(n>this._items.length){const e=n-this._items.length;for(let t=r;t<r+e;++t){const e=this._items.length;this._items.push(i[t-s]),o.push({change:"append",index:this._validOffsetToIndex(e),value:i[t-s]})}}else{for(let e=n;e<this._items.length;++e)o.push({change:"remove",index:this._validOffsetToIndex(e),value:this._items[e]});this._items.length=n}return this._zoffset=t,o}_updateFirstAndLastIndex(){const e=this._offsetToIndex(0),t=this._offsetToIndex(this._items.length-1);this._range.setValue(null===e||null===t?null:{firstIndex:e,lastIndex:t})}_validOffsetToIndex(e){return e-this._zoffset}_offsetToIndex(e){return 0<=e&&e<this.size()?this._validOffsetToIndex(e):null}_indexToOffset(e){const t=e+this._zoffset;return 0<=t&&t<this.size()?t:null}}var ul=i(395079);const _l=new Map([[0,.1],[11,.1],[1,.35],[9,.35],[12,.35],[8,.35]]);class pl{constructor(e,t){this._styleSpecificRanges=new Map,this._logicalRange=e,this._defaultStyle=t}strictRange(e){if(null===this._logicalRange)return null;void 0===e&&(e=this._defaultStyle);let t=this._styleSpecificRanges.get(e);if(void 0===t){const i=(_l.get(e)||0)/2;t=new al.BarsRange(Math.floor(this._logicalRange.left()+i),Math.ceil(this._logicalRange.right()-i)),this._styleSpecificRanges.set(e,t)}return t}logicalRange(){return this._logicalRange}isValid(){return null!==this._logicalRange}static invalid(){return new pl(null,1)}}var ml=i(164680),gl=i(310834),Sl=i(273497),vl=i(663561),fl=i(530282);let bl;const yl=eo.YEAR_SPAN-1,wl=eo.YEAR_SPAN-2,Cl=eo.DAY_SPAN-1,Tl=eo.HOUR_SPAN-1,Pl=eo.HOUR_SPAN-2,Ml=eo.HOUR_SPAN-3,xl={[eo.MILLISECOND_SPAN]:1,[eo.HOUR_SPAN+2]:1,[eo.HOUR_SPAN+1]:1,[eo.SECOND_SPAN]:.9,[wl]:.1,[eo.DAY_SPAN]:.85},Il={[eo.DAY_SPAN]:230};function Ll(e,t){switch(t){
case"TimeWithMilliseconds":return new Sl.TimeFormatter(Sl.hourMinuteSecondMillisecFormat).format(e);case"TimeWithSeconds":case"Time":const s="TimeWithSeconds"===t?(0,vl.getHourMinuteSecondFormat)(fl.timeHoursFormatProperty.value()):(0,vl.getHourMinuteFormat)(fl.timeHoursFormatProperty.value());return new Sl.TimeFormatter(s).format(e);case"DayOfMonth":return e.getUTCDate().toString();case"Month":return(void 0===bl&&(bl=[h.t(null,void 0,i(657374)),h.t(null,void 0,i(617341)),h.t(null,void 0,i(103305)),h.t(null,void 0,i(526785)),h.t(null,{context:"short"},i(734750)),h.t(null,void 0,i(87745)),h.t(null,void 0,i(183959)),h.t(null,void 0,i(93762)),h.t(null,void 0,i(178469)),h.t(null,void 0,i(728337)),h.t(null,void 0,i(646545)),h.t(null,void 0,i(769036))]),bl)[e.getUTCMonth()];case"Year":return e.getUTCFullYear().toString()}}const Al=(0,$n.default)((e=>(0,gi.parseFont)(e)?.size??12));function kl(e,t,i,s){const o=El(e,t),r=Math.max(e.width,s);return{left:o-r/2-i,right:o+r/2+i}}function El(e,t){return e.index*t}function Dl(e,t){return t===e.length?null:e[t]}function Bl(e,t,i,s,o){const r=kl(e,i,s,o),n=kl(t,i,s,o);return r.right>n.left}function Rl(e){return new Date(1e3*e)}function Vl(e){if(e.span>=eo.MONTH_SPAN&&e.span<eo.YEAR_SPAN){const t=(0,c.get_month)(Rl(e.time));return t===c.JULY?yl:t===c.MARCH||t===c.MAY||t===c.SEPTEMBER||t===c.NOVEMBER?wl:eo.MONTH_SPAN}if(e.span>=eo.MINUTE_SPAN&&e.span<eo.HOUR_SPAN){const t=(0,c.get_minutes)(Rl(e.time));return t%30==0?Tl:t%15==0?Pl:t%5==0?Ml:eo.MINUTE_SPAN}if(e.span>=eo.HOUR_SPAN&&e.span<eo.DAY_SPAN){const t=(0,c.get_hours)(Rl(e.time));return 0===t||12===t?Cl:e.span}return e.span>=eo.WEEK_SPAN&&e.span<eo.MONTH_SPAN?eo.DAY_SPAN:e.span}function Ol(e,t){const i=function(e,t){return e===eo.MILLISECOND_SPAN&&t?"TimeWithMilliseconds":e<eo.MINUTE_SPAN&&t?"TimeWithSeconds":e<eo.DAY_SPAN&&t?"Time":e<eo.WEEK_SPAN||e<eo.MONTH_SPAN?"DayOfMonth":e<eo.YEAR_SPAN?"Month":"Year"}(e,t),s=new ml.CircularCacheBuffer(150);return e=>{let t=s.get(e.time);return void 0===t&&(t=function(e,t){return null!==gl.customFormatters.tickMarkFormatter?gl.customFormatters.tickMarkFormatter(e,t):Ll(e,t)}(Rl(e.time),i),s.set(e.time,t)),t}}class Nl{constructor(e,t,i){this._marksByIndex=new Map,this._marksByTime=new Map,this._marksBySpan=[],this._cache=null,this._labelsInvalidated=!0,this._widthsInvalidated=!0,this._skipIntraDayMarksSparseCache=null,this._changed=new g.Delegate,this._formatterBySpan=new Map,this._textWidthCache=new vi.TextWidthCache(1e4),this._timeVisible=e,this._sparseMarks=t,this._font=i;fl.timeHoursFormatProperty.subscribe(this,(()=>{this._labelsInvalidated=!0,this._formatterBySpan.clear(),this._cache=null})),this._font.subscribe((()=>{this._textWidthCache.reset(),this._widthsInvalidated=!0,this._cache=null})),this._sparseMarks.subscribe((()=>{this._cache=null}))}destroy(){fl.timeHoursFormatProperty.unsubscribeAll(this),this._timeVisible.release(),this._sparseMarks.release(),this._font.release()}reset(){this._resetImpl(),this._changed.fire()}indexToTime(e){const t=this._marksByIndex.get(e)
;return t?new Date(1e3*t.time):null}nearestIndex(e){let t=this.minIndex??0,i=this.maxIndex??0;for(;i-t>2;){if(1e3*(0,a.ensureDefined)(this._marksByIndex.get(t)).time===e)return t;if(1e3*(0,a.ensureDefined)(this._marksByIndex.get(i)).time===e)return i;const s=Math.round((t+i)/2);1e3*(0,a.ensureDefined)(this._marksByIndex.get(s)).time>e?i=s:t=s}return t}estimateLeft(e){const t=this._density();if(void 0===this.minIndex||!t)return 0;return(1e3*(0,a.ensureDefined)(this._marksByIndex.get(this.minIndex)).time-e)/t}merge(e,t){if(0===e.length)return;const i=e[0].index,s=e[e.length-1].index,o=i<=(this.minIndex??0)&&s>=(this.maxIndex??0);(t||o)&&this._resetImpl();const r=this._marksBySpan,n=new Set;if(this._marksByIndex.size>0)for(const t of e){const e=t.index,i=this._marksByIndex.get(e);i&&(i.index===e&&i.overriddenSpan===Vl(t)&&i.time===t.time||this._removeTickmark(i));const s=this._marksByTime.get(t.time);s&&s.index!==e&&this._removeTickmark(s)}for(const t of e){const e=t.index;if(this._marksByIndex.has(e))continue;const i=Vl(t),s=this._formatLabel(t),o={...t,label:s,overriddenSpan:i,width:(0,Et.measureText)(s,this._font.value(),this._textWidthCache).width};this._marksByIndex.set(e,o),this._marksByTime.set(t.time,o);let a=r[i];void 0===a&&(a=[],r[i]=a);const l=0===a.length||a[a.length-1].time<t.time;a.push(o),l||n.add(i)}this.minIndex=Math.min(this.minIndex??1/0,i),this.maxIndex=Math.max(this.maxIndex??-1/0,s);for(let e=r.length;e--;)r[e]&&(r[e].length||delete r[e],n.has(e)&&r[e].sort(((e,t)=>e.time-t.time)));this._cache=null,this._skipIntraDayMarksSparseCache=null,this._changed.fire()}build(e){if(this._labelsInvalidated&&(this._marksByIndex.forEach((e=>{e.label=this._formatLabel(e)})),this._labelsInvalidated=!1),this._widthsInvalidated&&(this._marksByIndex.forEach((e=>{e.width=(0,Et.measureText)(e.label,this._font.value(),this._textWidthCache).width})),this._widthsInvalidated=!1),this._cache?.barSpacing===e)return this._cache.marks;const t=Al(this._font.value()),i=5/14*t,s=50/14*t;let o=[];for(let t=this._marksBySpan.length;t--;){if(!this._marksBySpan[t])continue;const r=this._marksBySpan[t];if(0===r.length)continue;const n=t<eo.DAY_SPAN&&this._sparseMarks.value()&&this._skipIntraDayMarksSparse(),l=o;o=[];let c=0,h=0;const d=r.length>2?Il[t]:void 0;let u=null,_=-1/0,p=null,m=0;for(;c<l.length||h<r.length;){const t=Dl(l,c),n=Dl(r,h);if(void 0!==d&&null!==n&&n!==u){if(null!==p){const t=null!==u&&u.index>p.index?u:p,i=El(n,e)-El(t,e);_=Math.max(_,i)}u=n}null!==t?null!==n?t.index<n.index?((0,a.assert)(null===p||!Bl(p,t,e,i,s)),o.push(t),p=t,c++):(null!==p&&Bl(p,n,e,i,s)||Bl(n,t,e,i,s)?m++:(o.push(n),p=n),h++):((0,a.assert)(null===p||!Bl(p,t,e,i,s)),o.push(t),p=t,c++):(null!==n&&(null!==p&&Bl(p,n,e,i,s)?m++:(o.push(n),p=n)),h++)}if(this._sparseMarks.value()&&l.length>0&&m/r.length>(xl[t]??.5)&&!n){o=l;break}if(void 0!==d&&Number.isFinite(_)&&_<=d)break}return this._cache={marks:o,barSpacing:e},o}marksBySpan(){const e={};for(let t=this._marksBySpan.length;t--;)if(this._marksBySpan[t]){const i=[];e[t]=i
;for(const e of this._marksBySpan[t])i.push([e.index,e.time,e.overriddenSpan])}return e}state(e){let t=[];for(let e=this._marksBySpan.length;e--;)this._marksBySpan[e]&&(t=t.concat(this._marksBySpan[e]));if(null!==e){const i=e.firstBar(),s=e.lastBar();t=t.filter((e=>e.index>=i&&e.index<=s))}return{marks:t.map((e=>[e.span,e.time,e.index])),version:2}}restoreState(e){if(this._marksByIndex=new Map,this._marksByTime=new Map,this._marksBySpan=[],this.maxIndex=void 0,this.minIndex=void 0,e&&e.marks&&e.marks.length)if(2===e.version){const t=e.marks.map((e=>({span:e[0],time:e[1],index:e[2]})));this.merge(t)}else this.merge(e.marks)}removeTail(e){let t=-1/0;for(const i of this._marksByIndex.values())i.time>e?this._removeTickmark(i):t=Math.max(t,i.index);this.maxIndex=Number.isFinite(t)?t:void 0,void 0===this.maxIndex&&(this.minIndex=void 0),this._skipIntraDayMarksSparseCache=null}addTail(e){if(void 0!==this.maxIndex)for(let t=0;t<e.length;t++)e[t].index=this.maxIndex+t+1;this.merge(e)}_resetImpl(){this._marksByIndex=new Map,this._marksByTime=new Map,this._marksBySpan=[],this.minIndex=void 0,this.maxIndex=void 0,this._cache=null,this._formatterBySpan.clear()}_removeTickmark(e){const t=e.index,i=e.time;if(this._marksByIndex.get(t)!==e)return;this._marksByIndex.delete(t),this._marksByTime.delete(i);const s=this._marksBySpan[e.overriddenSpan],o=(0,J.lowerbound)(s,e,((e,t)=>e.time<t.time));(0,a.assert)(o>=0&&o<s.length&&s[o].time===i,"Searched tickmark is not found"),s.splice(o,1),0===s.length&&delete this._marksBySpan[e.overriddenSpan]}_density(){if(void 0===this.minIndex||void 0===this.maxIndex)return 0;const e=this.maxIndex-this.minIndex;if(0===e)return 0;return 1e3*((0,a.ensureDefined)(this._marksByIndex.get(this.maxIndex)).time-(0,a.ensureDefined)(this._marksByIndex.get(this.minIndex)).time)/e}_formatLabel(e){const t=Vl(e);let i=this._formatterBySpan.get(t);return void 0===i&&(i=Ol(t,this._timeVisible.value()),this._formatterBySpan.set(t,i)),i(e)}_skipIntraDayMarksSparse(){if(null===this._skipIntraDayMarksSparseCache){const e=this._marksBySpan[eo.DAY_SPAN]??[];this._skipIntraDayMarksSparseCache=function(e){if(e.length<3)return 0;const t=[];let i=null;for(const s of e){if(null!==i){const e=Math.abs(s.index-i);t.push(e)}i=s.index}const s=t.reduce(((e,t)=>e+t),0)/t.length;return t.reduce(((e,t)=>e+Math.abs(t-s)))/t.length/s*100}(e)>=25}return this._skipIntraDayMarksSparseCache}}var Wl=i(115676);class Fl{constructor(){this._baseIndex=0}setBaseIndex(e){this._baseIndex=e}indexToTotalWeight(e){return e-this._baseIndex}totalWeightToIndex(e){return this._baseIndex+e}indexRangeToWeights(e,t,i){const s=e-this._baseIndex;return[{left:s-.5,center:s,right:s+.5,timePointIndex:e}]}state(e){return{type:"constant",state:{baseIndex:this._baseIndex}}}restoreState(e){this._baseIndex=e.state.baseIndex}needAdjustingOnDataRestoring(){return!1}}var zl=i(151515);var Hl=i(960096),Ul=i(331210);const Gl={preserveBarSpacing:!1,lockVisibleTimeRangeOnResize:!1,rightBarStaysOnScroll:!0,minBarSpacing:.5},jl=(0,
d.isFeaturesetEnabled)("low_density_bars"),ql=jl?1:2,$l=(0,l.getLogger)("Chart.TimeScale");class Kl{constructor(e,t){this._width=0,this._widthChanged=new g.Delegate,this._rightOffset=10,this._rightOffsetChanged=new g.Delegate,this._maxRightOffsetChanged=new g.Delegate,this._defaultRightOffset=new H.WatchedValue(10),this._defaultRightOffsetPercentage=new H.WatchedValue(5),this._usePercentageRightOffset=new H.WatchedValue(!1),this._lastDefaultRightOffset=void 0,this._baseIndex=null,this._leftEdgeIndex=null,this._barSpacingChanged=new g.Delegate,this._barSpacing=6,this._snapshotBarSpacing=null,this._visibleBars=pl.invalid(),this._visibleBarsInvalidated=!0,this._visibleBarsChanged=new g.Delegate,this._logicalRangeChanged=new g.Delegate,this._points=new dl,this._onScroll=new g.Delegate,this._resetDelegate=new g.Delegate,this._scrollData=null,this._scaleStartPoint=null,this._commonTransitionStartState=null,this._requestingMoreData=!1,this._requestedTickmarksCount=0,this._endOfData=!1,this._lockBarsAndLogicalRangeEvents=!1,this._resetAvailable=new H.WatchedValue(!1),this._pointWeights=new Fl,this._weightedPointsCache=[],this._throttleRequestMoreDataOnScroll=(0,Sn.default)(this._requestMoreData,300),this._options=(0,ci.deepExtend)({},Gl,t),this._model=e,this._scalesProperties=e.properties().childs().scalesProperties,this._tickMarks=new Nl((0,F.combine)((e=>!e.isDWM()),e.mainSeries().intervalObj().weakReference()).ownership(),(0,F.combine)(((e,t)=>!e.isTicks()&&!e.isSeconds()&&!(0,Q.isRangeBasedStyle)(t)),e.mainSeries().intervalObj().weakReference(),(0,Ul.convertPropertyToWatchedValue)(e.mainSeries().properties().childs().style).ownership()).ownership(),(0,Hl.createWVFromGetterAndSubscription)((()=>(0,gi.makeFont)(this._scalesProperties.childs().fontSize.value(),yi.CHART_FONT_FAMILY)),this._scalesProperties.childs().fontSize).ownership()),this._defaultRightOffset.subscribe((()=>{this._usePercentageRightOffset.setValue(!1),this._defaultRightOffsetOptionsUpdated()})),this._defaultRightOffsetPercentage.subscribe((e=>{if(e>=100||e<0){const t=Math.max(0,Math.min(e,99));this._defaultRightOffsetPercentage.setValue(t)}else this._usePercentageRightOffset.setValue(!0),this._defaultRightOffsetOptionsUpdated()})),this._usePercentageRightOffset.subscribe((()=>{this._defaultRightOffsetOptionsUpdated()})),this._options.preserveBarSpacing&&(this._barSpacing=this._scalesProperties.childs().barSpacing.value()||6),this._barSpacingChanged.subscribe(this,this._maxRightOffsetOnChanged),this._barSpacingChanged.subscribe(this,this._updateResetAvailableValue),this._rightOffsetChanged.subscribe(this,this._updateResetAvailableValue),this._widthChanged.subscribe(this,this._maxRightOffsetOnChanged),this._updateResetAvailableValue()}destroy(){this._barSpacingChanged.unsubscribeAll(this),this._barSpacingChanged.destroy(),this._widthChanged.unsubscribeAll(this),this._widthChanged.destroy(),this._tickMarks.destroy()}isEmpty(){return 0===this._width||!this.canNormalize()}canNormalize(){return this._points.size()>0}update(e,t,i,s,o){
this._visibleBarsInvalidated=!0,i.length>0&&this._points.merge(e,t,i),this._tickMarks.merge(s,o),this.correctOffset()}addTail(e,t,i){this._tickMarks.removeTail(t);const s=e.params,o=(0,a.ensureDefined)(this._tickMarks.maxIndex)+(i?0:1);for(let e=0;e<s.marks.length;e++)s.marks[e].index=o+e;this._tickMarks.addTail(s.marks),this._points.addTail(s.changes,i);const r=this._rightOffset-s.changes.length;this._updateRightOffset(r)}state(e){const t={m_barSpacing:this.barSpacing(),m_rightOffset:this._defaultRightOffset.value(),rightOffsetPercentage:this._defaultRightOffsetPercentage.value(),usePercentageRightOffset:this._usePercentageRightOffset.value()};if(e){t.m_rightOffset=Math.max(0,this._rightOffset);const e=this.visibleBarsStrictRange(),i=this.visibleExtendedDataRange(this._model.mainSeries().data(),0),s=e?e.unite(i):i;t.points=this._points.state(s),t.tickmarks=this._tickMarks.state(s),t.width=this._width,t.weights=this._pointWeights.state(s),t.baseIndex=this._baseIndex}return t}restoreState(e,t){if(void 0===e.m_barSpacing)return void $l.logDebug("restoreState: invalid state");if(void 0===e.m_rightOffset)return void $l.logDebug("restoreState: invalid state");e.weights&&(this._pointWeights=function(e){let t;switch(e.type){case"constant":return t=new Fl,t.restoreState(e),t;case"computed":return t=new zl.ComputedTimePointWeights,t.restoreState(e),t}throw new Error(`Unexpected time point weigths type ${e.type}`)}(e.weights));let i=e.m_barSpacing;this._snapshotBarSpacing=t?i:null;const s=e.m_rightOffset<0&&!t?this.rightOffsetDefaultValue():e.m_rightOffset,o=s<0?this.rightOffsetDefaultValue():Math.round(s);if(this._defaultRightOffset.setValue(o),void 0!==e.rightOffsetPercentage&&Number.isFinite(e.rightOffsetPercentage)&&this._defaultRightOffsetPercentage.setValue(e.rightOffsetPercentage),this._usePercentageRightOffset.setValue(Boolean(e.usePercentageRightOffset)),this._rightOffset=s,this._baseIndex=e.baseIndex??this._baseIndex,t&&(this._requestedTickmarksCount=1/0,this._endOfData=!0,this._points.restoreState(e.points||null),this._tickMarks.restoreState(e.tickmarks||null),e.width&&this._width>0&&(i*=this._width/e.width)),t&&this._pointWeights.needAdjustingOnDataRestoring()){this._tryToUpdateBarSpacing(this._barSpacing,i);const e=this._points.range().value();if(e){const t=e.firstIndex;let s=i,o=i,r=0;(()=>{r=this.indexToCoordinate(t),r<0?(o=i,s=i/10):(s=i,o=10*i)})();for(let e=0;e<20&&Math.abs(r)>2;e++){const e=(o+s)/2;this._tryToUpdateBarSpacing(this._barSpacing,e),r=this.indexToCoordinate(t),r<0?o=e:s=e}}}else this._tryToUpdateBarSpacing(this._barSpacing,i);this.correctOffset(),this._usePercentageRightOffset.value()&&(this._rightOffset=this.percentsToBarIndexLength(this._defaultRightOffsetPercentage.value())),this._rightOffsetChanged.fire(this._rightOffset)}marks(){if(this.isEmpty())return null;const e=this._barSpacing,t=5*((this._scalesProperties.childs().fontSize.value()||0)+4),i=Math.round(t/e),s=(0,
a.ensureNotNull)(this.visibleBarsStrictRange()),o=Math.max(s.firstBar(),s.firstBar()-i),r=Math.max(s.lastBar(),s.lastBar()-i),n=this._tickMarks.build(e),l=[];for(const e of n)o<=e.index&&e.index<=r&&l.push({coord:this.indexToCoordinate(e.index),label:e.label,span:e.span,major:!1});return l}visibleBarsStrictRange(){return this._visibleBarsInvalidated&&(this._visibleBarsInvalidated=!1,this._updateVisibleBars()),this._visibleBars.strictRange()}visibleBarsStrictRangeChanged(){return this._visibleBarsChanged}visibleStrictDataRange(e){const t=this.visibleBarsStrictRange();if(null===t)return null;const i=e.search(t.firstBar(),Wl.PlotRowSearchMode.NearestRight),s=e.search(t.lastBar(),Wl.PlotRowSearchMode.NearestLeft);return null===i||null===s?null:new al.BarsRange(i.index,s.index)}visibleExtendedDataRange(e,t){const i=this.visibleBarsStrictRange();if(null===i)return null;let s=1===t?null:e.search(i.firstBar()-1,Wl.PlotRowSearchMode.NearestLeft),o=0===t?null:e.search(i.lastBar()+1,Wl.PlotRowSearchMode.NearestRight);return null===s&&(s=e.search(i.firstBar(),Wl.PlotRowSearchMode.NearestRight)),null===o&&(o=e.search(i.lastBar(),Wl.PlotRowSearchMode.NearestLeft)),null===s||null===o?null:new al.BarsRange(s.index,o.index)}logicalRangeChanged(){return this._logicalRangeChanged}tickMarks(){return this._tickMarks}points(){return this._points}width(){return this._width}setWidth(e,t){if(!Number.isFinite(e)||e<=0)return void $l.logWarn(`setWidth: invalid argument: ${e}`);if(this._width===e)return;const i=this._usePercentageRightOffset.value()&&this._rightOffset>0?this.barIndexLengthToPercents(this._rightOffset):-1;if(this._visibleBarsInvalidated=!0,(t||this._options.lockVisibleTimeRangeOnResize)&&this._width){const t=this._barSpacing*e/this._width;this._tryToUpdateBarSpacing(this._barSpacing,t)}else this._width&&this.setBarSpacing(this._barSpacing);if(null!==this._leftEdgeIndex){if((0,a.ensureNotNull)(this.visibleBarsStrictRange()).firstBar()<=this._leftEdgeIndex){const t=this._width-e;this._rightOffset-=Math.round(t/this._barSpacing)+1}}this._width=e,this._widthChanged.fire(e);const s=this._rightOffset;i>0?this._rightOffset=this.percentsToBarIndexLength(i):this.correctOffset(),this._rightOffset!==s&&this._rightOffsetChanged.fire(this._rightOffset),this._requestMoreData()}setLeftEdgeFix(e){this._leftEdgeIndex=e;const t=this.visibleBarsStrictRange();if(null===t)return;const i=t.firstBar()-e;if(i<0){const e=this._rightOffset-i-1;this.scrollToOffsetAnimated(e,500)}}positionPercentToCoordinate(e){return this.width()*e}indexToCoordinate(e){if(this.isEmpty())return 0;const t=this.baseIndex(),i=this._pointWeights.indexToTotalWeight(t+this._rightOffset+.5)-this._pointWeights.indexToTotalWeight(e);return this._width-i*this._barSpacing}indexToUserTime(e){return this._tickMarks.indexToTime(e)}timePointToIndex(e,t){switch(t){case 0:return this._points.indexOf(e,!1);case 1:return this._points.closestIndexLeft(e);default:return this._points.indexOf(e,!0)}}indexToTimePoint(e){return this._points.valueAt(e)}timeToCoordinate(e){
const t=this._points.closestIndexLeft(e);if(null===t)return null;const i=(0,a.ensureNotNull)(this._points.valueAt(t)),s=this.indexToCoordinate(t);if(s<=0||s>=this._width)return null;const o=this.barSpacing(),r=this.baseIndex();let n;n=0===r?this._model.mainSeries().intervalObj().value().inMilliseconds()/1e3:(0,a.ensureNotNull)(this._points.valueAt(r))-(0,a.ensureNotNull)(this._points.valueAt(r-1));const l=s+(e-i)/n*o+1;return l<=0||l>=this._width?null:l}barBorders(e){const t={timePointIndex:e,left:NaN,center:NaN,right:NaN};return this.fillBarBorders([t]),t}fillBarBorders(e,t,i){if(0===e.length)return;let s=t?.startItemIndex??0;const o=(t?.endItemIndex??e.length)-1;if(!0===i&&(s=(0,J.upperbound)(e,ul.UNPLOTTABLE_TIME_POINT_INDEX,((e,t)=>e<t.timePointIndex),s,o+1)),s>o)return;const r=this._pointWeights.indexToTotalWeight(this.baseIndex()+this._rightOffset+.5),n=this._pointWeights.indexRangeToWeights(e[s].timePointIndex,e[o].timePointIndex,this._weightedPointsCache);let l=0,c=n[l];const h=c,d=n[n.length-1];let u=NaN,_=NaN,p=NaN,m=!0;for(let t=s;t<=o;t+=1){const i=e[t];if(i.timePointIndex<h.timePointIndex)u=h.left-(h.timePointIndex-i.timePointIndex),_=u+.5,p=u+1;else if(i.timePointIndex>d.timePointIndex)p=d.right+(i.timePointIndex-d.timePointIndex),_=p-.5,u=p-1;else for(m&&(u=c.left,_=c.center,p=c.right,m=!1);c.timePointIndex<i.timePointIndex;)l+=1,(0,a.assert)(l<n.length,"Bar borders coordinates are not correct"),c=n[l],u=c.left,_=c.center,p=c.right;i.left=this._width-(r-u)*this._barSpacing,i.center=this._width-(r-_)*this._barSpacing,i.right=this._width-(r-p)*this._barSpacing}}timedValuesToCoordinates(e,t,i){const s=this._pointWeights.indexToTotalWeight(this.baseIndex()+this._rightOffset+.5),o=t?.startItemIndex??0;let r=o;const n=t?.endItemIndex??e.length;!0===i&&(r=(0,J.upperbound)(e,ul.UNPLOTTABLE_TIME_POINT_INDEX,((e,t)=>e<t.x),o,n));for(let t=r;t<n;++t){const i=e[t],o=s-this._pointWeights.indexToTotalWeight(i.x);i.x=this._width-o*this._barSpacing}for(let t=o;t<r;++t)e[t].x=-500}rightOffsetForTimePoint(e){const t=this.timeToCoordinate(e);if(null===t)return null;const i=(t-this._baseIndexBarCenterCoordinate())/this._barSpacing;return this._pointWeights.totalWeightToIndex(i)}scrollToRealtime(e,t){let i=this.targetDefaultRightOffset();i<0&&(i=this.rightOffsetDefaultValue());const s=()=>{void 0!==t&&t(),this._requestMoreData()};if(e){const e=this.logicalRange(),t=this._model.mainSeries().bars().lastIndex();if(null===e||null===t)return;const i=this.indexToCoordinate(e.right()+.5),o=this.indexToCoordinate(t+this._defaultRightOffset.value()+.5);return this._model.stopTimeScaleAnimation(),void this._model.setTimeScaleAnimation(new mo({from:0,to:i-o,duration:1e3,easing:lo.easingFunc.easeInOutQuint,onFinish:s}))}this._visibleBarsInvalidated=!0,this._updateRightOffset(i),this._onScroll.fire(),s()}scrollToFirstBar(e=()=>{}){this._model.gotoTime(new Date("1800-01-01").getTime()).then(e),this._onScroll.fire()}scrollToOffsetAnimated(e,t){if(!isFinite(e))throw new RangeError("offset is required and must be finite number")
;const i=void 0===t?400:t;if(!isFinite(i)||i<=0)throw new RangeError("animationDuration (optional) must be finite positive number");const s=this._rightOffset,o=Date.now(),r=()=>{this._visibleBarsInvalidated=!0;const t=(Date.now()-o)/i;if(t>=1)return this._updateRightOffset(e),this._visibleBarsInvalidated=!0,this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),void this._model.lightUpdate();const n=s+(e-s)*t;this._updateRightOffset(n),this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),setTimeout(r,20)};r()}defaultRightOffset(){return this._defaultRightOffset}rightOffsetDefaultValue(){return 10}defaultRightOffsetPercentage(){return this._defaultRightOffsetPercentage}usePercentageRightOffset(){return this._usePercentageRightOffset}barSpacing(){return this._barSpacing}barSpacingScaleRatio(){return null===this._snapshotBarSpacing?1:this._barSpacing/this._snapshotBarSpacing}setBarSpacing(e){if(!Number.isFinite(e))return void $l.logWarn(`setBarSpacing: invalid argument: ${e}`);e=this.getValidBarSpacing(e);const t=this._barSpacing>e;this._tryToUpdateBarSpacing(this._barSpacing,e)&&(this.correctOffset(),this._options.preserveBarSpacing&&((0,br.allowSavingDefaults)(!0),this._scalesProperties.childs().barSpacing.setValue(this._barSpacing),(0,br.allowSavingDefaults)(!1)),this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this._model.lightUpdate(),t&&this.requestHistoryPointsIfNeeded())}barSpacingChanged(){return this._barSpacingChanged}getValidBarSpacing(e){return null==e&&(e=this.barSpacing()),e<this.minBarSpacing()?this.minBarSpacing():e>this.maxBarSpacing()?this.maxBarSpacing():e}isValidBarSpacing(e){return e>=this.minBarSpacing()&&e<=this.maxBarSpacing()}preserveBarSpacing(){return this._options.preserveBarSpacing}normalizeBarIndex(e){let t=0,i=0;const s=this.baseIndex(),o=(0,a.ensureNotNull)(this._points.range().value()).firstIndex;return e<o?(t=(0,a.ensureNotNull)(this._points.valueAt(o)),i=e-o):e>s?(t=(0,a.ensureNotNull)(this._points.valueAt(s)),i=e-s):(t=(0,a.ensureNotNull)(this._points.valueAt(e)),i=0),{time_t:t,offset:i}}denormalizeTimePoint(e){const t=this._points.indexOf(e.time_t,!1);if(null!==t)return t+e.offset}rightOffset(){return this._rightOffset}rightOffsetChanged(){return this._rightOffsetChanged}minRightOffset(){const e=this.points().range().value()?.firstIndex,t=this._baseIndex;if(void 0===e||null===t)return null;if(null!==this._leftEdgeIndex){const e=this.width()/this._barSpacing;return this._leftEdgeIndex-t+e-1}return e-t-1+ql}maxRightOffset(){return this.width()/this._barSpacing-ql}maxRightOffsetChanged(){return this._maxRightOffsetChanged}onReset(){return this._resetDelegate}baseIndex(){return this._baseIndex||0}zoom(e,t,i){if(!Number.isFinite(e)||!Number.isFinite(t))return void $l.logWarn(`zoom: invalid arguments: ${e}, ${t}, ${i}`);const s=this.rightOffset(),o=void 0!==i?!i:this._options.rightBarStaysOnScroll,r=o&&this.usePercentageRightOffset().value()&&s>=0,n=r?this.barIndexLengthToPercents(s):void 0,a=this.coordinateToIndex(e),l=this.barSpacing(),c=l+t*(l/10)
;this.setBarSpacing(c),o||(this.startScroll(this.indexToCoordinate(a)),this.scrollTo(e),this.endScroll()),r&&void 0!==n&&this.setRightOffset(this.percentsToBarIndexLength(n)),this._requestMoreData()}zoomToBarsRange(e,t){if(null!==this._leftEdgeIndex&&(e=Math.max(e,this._leftEdgeIndex)),t<e)return;const i=this.baseIndex(),s=this._rightOffset;this._rightOffset=t-i;const o=e-.5,r=t+.5,n=Math.max(this._pointWeights.indexToTotalWeight(r)-this._pointWeights.indexToTotalWeight(o),ql);this.setBarSpacing(this.width()/n),this._visibleBarsInvalidated=!0,this.correctOffset(),this._rightOffset!==s&&this._rightOffsetChanged.fire(this._rightOffset),this._requestMoreData()}scrollToBar(e){null!==this._leftEdgeIndex&&(e=Math.max(e,this._leftEdgeIndex));const t=(0,a.ensureNotNull)(this.logicalRange()).length()+e-1;this._rightOffset=t-this.baseIndex(),this._visibleBarsInvalidated=!0,this.correctOffset(),this._rightOffsetChanged.fire(this._rightOffset),this._requestMoreData()}coordinateToIndex(e){return Math.round(this.coordinateToFloatIndex(e))}coordinateToFloatIndex(e){const t=(e-this._baseIndexBarCenterCoordinate())/this._barSpacing,i=this._pointWeights.totalWeightToIndex(t);return Math.round(1e6*i)/1e6}coordinateToVisibleIndex(e){let t=this.coordinateToIndex(e);const i=this.visibleBarsStrictRange();return null===i||i.contains(t)||(t=Math.min(Math.max(i.firstBar(),t),i.lastBar())),t}canZoomIn(){return this.barSpacing()<this.maxBarSpacing()}canZoomOut(){return this.barSpacing()>this._options.minBarSpacing}minBarSpacing(){return this._options.minBarSpacing}maxBarSpacing(){const e=this.width();return jl?e:e/ql}minVisibleBarCount(){return ql}resetRightOffset(){this.setRightOffset(this.targetDefaultRightOffset())}reset(){this._visibleBarsInvalidated=!0,this._points.clear(),this._scrollData=null,this._scaleStartPoint=null,this._clearCommonTransitionsStartState(),this._tickMarks.reset(),this._leftEdgeIndex=null,this._resetDelegate.fire(),this.disconnect()}resetAvailable(){return this._resetAvailable.readonly()}disconnect(){this._requestingMoreData=!1,this._requestedTickmarksCount=0,this._endOfData=!1}setBaseIndex(e){if(!Number.isFinite(e))return void $l.logDebug(`setBaseIndex: invalid argument: ${e}`);const t=this._baseIndex!==e;this._visibleBarsInvalidated=!0,this._baseIndex=e,this._pointWeights.setBaseIndex(this._baseIndex),this.correctOffset(),t&&(this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this._model.lightUpdate())}resetBaseIndex(){this._visibleBarsInvalidated=!0,this._baseIndex=null}setRightOffset(e){Number.isFinite(e)?(this._visibleBarsInvalidated=!0,this._updateRightOffset(e)):$l.logWarn(`setRightOffset: invalid argument: ${e}`)}correctBarSpacing(){this.isEmpty()||this.points().size()<this.width()/this.barSpacing()&&(this.setRightOffset(this.targetDefaultRightOffset()),this.setBarSpacing(this.width()/(this.points().size()+this.rightOffset())))}setTimePointWeights(e){this._weightedPointsCache=[],this._pointWeights=e??new Fl,this._pointWeights.setBaseIndex(this.baseIndex()),this._visibleBarsInvalidated=!0}
correctOffset(){const e=this.maxRightOffset();this._rightOffset>e&&(this._rightOffset=e,this._visibleBarsInvalidated=!0);const t=this.minRightOffset();null!==t&&this._rightOffset<t&&(this._rightOffset=t,this._visibleBarsInvalidated=!0)}logicalRange(){return this._visibleBarsInvalidated&&(this._visibleBarsInvalidated=!1,this._updateVisibleBars()),this._visibleBars.logicalRange()}restoreDefault(){this._visibleBarsInvalidated=!0,this._lockBarsAndLogicalRangeEvents=!0;const e=this._visibleBars;this.setBarSpacing(6),this.resetRightOffset(),this._lockBarsAndLogicalRangeEvents=!1,this._fireVisibleBarsChangedIfRequired(e,this._visibleBars),this._requestMoreData()}startScale(e){this._scrollData&&this.endScroll(),null===this._scaleStartPoint&&null===this._commonTransitionStartState&&(this.isEmpty()||(this._scaleStartPoint=e,this._saveCommonTransitionsStartState()))}scaleTo(e){if(null===this._commonTransitionStartState)return;const t=(0,si.clamp)(this._width-e,0,this._width),i=(0,si.clamp)(this._width-(0,a.ensureNotNull)(this._scaleStartPoint),0,this._width);if(0===t||0===i)return;const s=this.barIndexLengthToPercents(this.rightOffset());this.setBarSpacing(this._commonTransitionStartState.barSpacing*t/i),this.usePercentageRightOffset().value()&&this.rightOffset()>=0&&this.setRightOffset(this.percentsToBarIndexLength(s))}endScale(){null!==this._scaleStartPoint&&(this._scaleStartPoint=null,this._clearCommonTransitionsStartState(),this._requestMoreData())}startScroll(e){null===this._scrollData&&null===this._commonTransitionStartState&&(this.isEmpty()||(this._scrollData={startCoordinate:e,startRightEdgeLogical:this.baseIndex()+this._rightOffset+.5,startBaseIndex:this.baseIndex()},this._saveCommonTransitionsStartState()))}scrollTo(e){if(this._visibleBarsInvalidated=!0,null===this._scrollData)return;const{startCoordinate:t,startRightEdgeLogical:i,startBaseIndex:s}=this._scrollData,o=e-t,r=i+(this.baseIndex()-s),n=this.indexToCoordinate(r),a=this.coordinateToFloatIndex(n-o)-.5-this.baseIndex();this._updateRightOffset(a),this._onScroll.fire()}endScroll(){null!==this._scrollData&&(this._scrollData=null,this._clearCommonTransitionsStartState(),this._throttleRequestMoreDataOnScroll())}isBeingScrolled(){return null!==this._scrollData}isBeingScaled(){return null!==this._scaleStartPoint}onScroll(){return this._onScroll}invalidateVisibleBars(){this._visibleBarsInvalidated=!0}onTimeScaleCompleted(e){if(this._requestingMoreData=!1,this._endOfData=e,(0,d.isFeaturesetEnabled)("fix_left_edge")&&this._endOfData){const e=this._points.range().value()?.firstIndex;void 0!==e&&this.setLeftEdgeFix(e)}this._requestMoreData()}requestMoreHistoryPoints(e){this._model.mainSeries().requestMoreData(e)}targetDefaultRightOffset(){return this.usePercentageRightOffset().value()?this.percentsToBarIndexLength(this._defaultRightOffsetPercentage.value()):this._defaultRightOffset.value()}percentsToBarIndexLength(e){return.01*e*this._width/this._barSpacing}barIndexLengthToPercents(e){return 100*e*this._barSpacing/this._width}requestHistoryPointsIfNeeded(){
this._model.mainSeries().requestMoreData()}_requestMoreData(){this._model.mainSeries().requestMoreData()}_requestFutureTickmarksIfNeeded(){this._model.mainSeries().requestMoreData()}_requestHistoryPoints(e){this._model.chartApi().isConnected().value()&&(this._requestingMoreData?$l.logNormal("Skipping loading more data due active loading"):(this._requestingMoreData=!0,this._model.chartApi().requestMoreData(e)))}_updateVisibleBars(){const e=this._visibleBars;if(this.isEmpty())return void(this._visibleBars.isValid()&&(this._visibleBars=pl.invalid(),this._visibleBarsChanged.fire(null,e.strictRange()),this._logicalRangeChanged.fire(null,e.logicalRange())));const t=this.width()/this.barSpacing(),i=this.baseIndex(),s=i+this._rightOffset,o=s+.5,r=this._pointWeights.indexToTotalWeight(o)-t,n=Math.min(o-1,this._pointWeights.totalWeightToIndex(r))+.5;Number.isFinite(n)&&Number.isFinite(s)?(this._visibleBars=new pl(new ll.LogicalRange(n,s),this._model.mainSeries().style()),this._lockBarsAndLogicalRangeEvents||this._fireVisibleBarsChangedIfRequired(e,this._visibleBars)):$l.logWarn(`updateVisibleBars error: baseIndex: ${i}, barSpacing: ${this._barSpacing}, rightOffset: ${this._rightOffset}`)}_fireVisibleBarsChangedIfRequired(e,t){al.BarsRange.compare(e.strictRange(),t.strictRange())||this._visibleBarsChanged.fire(t.strictRange(),e.strictRange()),ll.LogicalRange.compare(e.logicalRange(),t.logicalRange())||this._logicalRangeChanged.fire(t.logicalRange(),e.logicalRange())}_baseIndexBarCenterCoordinate(){const e=this.baseIndex()+this._rightOffset+.5,t=this._pointWeights.indexToTotalWeight(e);return this._width-t*this._barSpacing}_tryToUpdateBarSpacing(e,t){return e!==t&&(this._visibleBarsInvalidated=!0,this._barSpacing=t,this._barSpacingChanged.fire(t),!0)}_saveCommonTransitionsStartState(){this._commonTransitionStartState={barSpacing:this.barSpacing(),rightOffset:this.rightOffset()}}_clearCommonTransitionsStartState(){this._commonTransitionStartState=null}_maxRightOffsetOnChanged(){this._maxRightOffsetChanged.fire(this.maxRightOffset())}_updateRightOffset(e){const t=this._rightOffset;this._rightOffset=e,this.correctOffset(),this._rightOffset!==t&&this._rightOffsetChanged.fire(this._rightOffset),this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this._model.lightUpdate()}_defaultRightOffsetOptionsUpdated(){this.rightOffset();this.setRightOffset(this.targetDefaultRightOffset()),this._updateResetAvailableValue(),this._lastDefaultRightOffset=this._defaultRightOffsetPercentage.value()}_updateResetAvailableValue(){this._resetAvailable.setValue(6!==this.barSpacing()||this.rightOffset()!==this.targetDefaultRightOffset())}}var Zl=i(149274),Yl=i(540768),Xl=i(873073);class Jl{constructor(e){this._onChanged=new g.Delegate,this._groups=[],this._groups=e||[],this._groups.forEach((e=>{e.onChanged().subscribe(null,(t=>this._onChanged.fire(e.id,t)))}))}groups(){return this._groups.filter((e=>e.isActualSymbol()))}groupsForAllSymbols(){return this._groups}createGroup(e,t,i){t=t||this._generateNextName();const s=new Ir(e,t,i)
;this._groups.push(s),s.onChanged().subscribe(null,(e=>this._onChanged.fire(s.id,e)));const o={visibilityChanged:!1,lockedChanged:!1,isActualIntervalChanged:!1,affectedLineTools:e.map((e=>e.id()))};return this._onChanged.fire(s.id,o),s}addGroup(e){this._groups.push(e),e.onChanged().subscribe(null,(t=>this._onChanged.fire(e.id,t))),this._onChanged.fire(e.id)}removeGroup(e){const t=this._groups.findIndex((t=>t.id===e.id));this._groups.splice(t,1),this._onChanged.fire(e.id)}groupForId(e){return this._groups.find((t=>t.id===e))||null}groupForLineTool(e){return this._groups.find((t=>t.containsLineTool(e)))||null}removeLineTools(e){const t=new Set;this._groups.forEach((i=>{const s=e.filter(i.containsLineTool.bind(i));s.length&&(i.excludeLineTools(s),t.add(i.id))}));return this._groups.filter((e=>0===e.lineTools().length)).forEach((e=>this.removeGroup(e))),Array.from(t)}state(e){return{groups:(e?this._groups.filter((e=>e.isActualSymbol())):this._groups).map((e=>e.state()))}}onChanged(){return this._onChanged}fireChangedAll(){this._groups.forEach((e=>{this._onChanged.fire(e.id)}))}static fromState(e,t){const i=[];for(const s of t.groups){const t=Ir.fromState(e,s);null!==t&&i.push(t)}return new Jl(i)}_generateNextName(){const e=new Set(this.groups().map((e=>e.name().value())));for(let t=1;;t++){const i=`Group ${t}`,s=`Group_${t}`;if(!e.has(i)&&!e.has(s))return i}}}var Ql=i(978802),ec=i(386228);function tc(e){return Boolean(e.session.timezone)&&Boolean(e.session.spec)}class ic{constructor(e,t){var i,s;this._sourceTargetBarBuilder=null,this._cache=new Map,this._source=e,this._target=t,this._sourceSession=Ql.SessionInfo.fromState(e.session),this._targetSession=Ql.SessionInfo.fromState(t.session),this._isResolutionTheSame=$.Interval.isEqual(e.resolution,t.resolution)||$.Interval.isTicks(e.resolution)&&$.Interval.isTicks(t.resolution),this._isSessionTheSame=(i=e.session,s=t.session,i.timezone===s.timezone&&i.spec===s.spec&&i.holidays===s.holidays&&i.corrections===s.corrections)}sourceTimeToTargetTime(e){if(this._isSessionTheSame&&this._isResolutionTheSame)return e;if(!tc(this._source)||!tc(this._target))return e;let t=this._cache.get(e);if(void 0===t){const i=1e3*e,s=this._sourceTargetBuilder();s.moveTo(i);const o=s.indexOfBar(i);t=s.startOfBar(Math.max(0,o))/1e3,this._cache.set(e,t)}return t}_sourceTargetBuilder(){return null===this._sourceTargetBarBuilder&&(this._sourceTargetBarBuilder=(0,ec.newBarBuilder)(this._target.resolution,this._targetSession,this._sourceSession)),this._sourceTargetBarBuilder}}var sc=i(466008);const oc="#000000";async function rc(e){(await(0,ys.getChartAlertsFacade)()).invokeAlertEditor(e)}class nc{constructor(e){this._alertLabelsBySource=new Map,this._alertsByAlertSeriesId=new Map,this._alertSeriesIdByAlert=new Map,this._alertLabelsOwnerSourcesByAlert=new Map,this._chartModel=e}destroy(){this.removeAllAlertLabels()}removeAllAlertLabels(){const e=this._alertLabelsBySource;this._alertLabelsBySource=new Map,this._alertsByAlertSeriesId.clear(),this._alertSeriesIdByAlert.clear(),
this._alertLabelsOwnerSourcesByAlert.clear(),e.forEach((e=>{e.forEach((e=>this._chartModel.removeSource(e)))}))}removeSourceAlertLabels(e){for(const t of this._getAlertLabelsBySource(e))this._removeAlertLabel(t);if((0,Pa.isSeries)(e)){const t=e.activeStudyBinding();t&&this.removeSourceAlertLabels(t)}}syncSourceAlertLabels(e){if(!(0,bs.isPriceDataSource)(e)||!e.hasStateForAlert())return;for(const t of this._getAlertLabelsBySource(e))t.alertOwnerSource().idForAlert()===t.alertSeriesId()||t.alert().isOHLC()||this._removeAlertLabel(t);const t=this._alertsByAlertSeriesId.get(e.idForAlert()),i=this._getAlertLabelsBySource(e);void 0!==t&&t.forEach((e=>{i.some((t=>t.alert()===e))||this._updateAlertLabelsByAlert(e,(0,a.ensureDefined)(this._alertSeriesIdByAlert.get(e)))}));const s=(0,a.ensureNotNull)(this._chartModel.paneForSource(e));for(const t of this._getAlertLabelsBySource(e)){const i=this._chartModel.paneForSource(t);i!==s?(null!==i&&i.removeDataSource(t),s.addDataSource(t,(0,a.ensureNotNull)(e.priceScale()),!1)):e.priceScale()!==t.priceScale()&&s.move(t,(0,a.ensureNotNull)(e.priceScale()))}if((0,Pa.isSeries)(e)){const t=e.activeStudyBinding();t&&this.syncSourceAlertLabels(t)}}detachSourceAlertLabels(e){for(const t of this._getAlertLabelsBySource(e))this._chartModel.detachSource(t);if((0,Pa.isSeries)(e)){const t=e.activeStudyBinding();t&&this.detachSourceAlertLabels(t)}}addAlert(e,t){(0,a.assert)(!this._alertSeriesIdByAlert.has(e),"Alert is already added on the chart"),this._alertSeriesIdByAlert.set(e,t);let i=this._alertsByAlertSeriesId.get(t);void 0===i&&(i=new Set,this._alertsByAlertSeriesId.set(t,i)),i.add(e),this._updateAlertLabelsByAlert(e,t)}removeAlert(e){const t=this._alertLabelsOwnerSourcesByAlert.get(e);void 0!==t&&t.forEach((t=>{const i=this._alertLabelsBySource.get(t);void 0!==i&&i.forEach((t=>{t.alert()===e&&this._removeAlertLabel(t)}))}));const i=this._alertSeriesIdByAlert.get(e);if(!i)return;this._alertSeriesIdByAlert.delete(e);const s=this._alertsByAlertSeriesId.get(i);void 0!==s&&s.delete(e)}_removeAlertLabel(e){const t=e.alertOwnerSource(),i=this._alertLabelsBySource.get(t);void 0!==i&&(i.delete(e),0===i.size&&this._alertLabelsBySource.delete(t));const s=e.alert(),o=this._alertLabelsOwnerSourcesByAlert.get(s);void 0!==o&&(o.delete(t),0===o.size&&this._alertLabelsOwnerSourcesByAlert.delete(s)),this._chartModel.removeSource(e)}_findPanes(e){const t=[];for(const i of this._chartModel.panes()){const s=i.priceDataSources(),o=new Set;for(const t of s)if(t.hasStateForAlert()&&t.idForAlert()===e&&o.add(t),(0,Pa.isSeries)(t)){const i=t.activeStudyBinding();i&&i.hasStateForAlert()&&i.idForAlert()===e&&o.add(i)}o.size>0&&t.push({pane:i,sources:o})}return t}_addLabelToPane(e,t,i,s){const o=new Ii.AlertLabel(this._chartModel,e,s,rc);i.addDataSource(o,s.priceScale(),!1);let r=this._alertLabelsBySource.get(s);void 0===r&&(r=new Set,this._alertLabelsBySource.set(s,r)),r.add(o);let n=this._alertLabelsOwnerSourcesByAlert.get(e);void 0===n&&(n=new Set,this._alertLabelsOwnerSourcesByAlert.set(e,n)),n.add(s)}
_updateAlertLabelsByAlert(e,t){const i=this._findPanes(t);if(i.length)for(const s of i)s.sources.forEach((i=>this._addLabelToPane(e,t,s.pane,i)));else if(e.isOHLC()){const i=this._chartModel.mainSeries();this._addLabelToPane(e,t,(0,a.ensureNotNull)(this._chartModel.paneForSource(i)),i)}this._chartModel.lightUpdate()}_getAlertLabelsBySource(e){const t=this._alertLabelsBySource.get(e);return void 0===t?[]:Array.from(t)}}var ac=i(475120),lc=i(143644),cc=i(601679),hc=i(969185),dc=i(343548),uc=i(15474);class _c extends uc.PriceLineAxisView{constructor(e,t){super(),this._model=e,this._source=t}_value(){const e=this._model.mainSeries(),t=e.priceScale(),i=e.firstValue();if(null===i)return{noData:!0};const s=this._source.price(),o=this._source.currentSession();if(null===s||"pre_market"!==o&&"post_market"!==o)return{noData:!0};return{noData:!1,coordinate:t.priceToCoordinate(s,i),color:"",formattedPricePercentage:"",formattedPriceAbsolute:"",formattedPriceIndexedTo100:"",text:"",index:0}}_priceLineColor(e){const t=this._source.properties().childs();return"pre_market"===this._source.currentSession()?t.preMarketColor.value():t.postMarketColor.value()}_lineWidth(){return this._source.properties().childs().lineWidth.value()}_lineStyle(){return this._source.properties().childs().lineStyle.value()}_isVisible(){if(!this._source.canBeVisibleOnSymbolAndInterval()||!this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value())return!1;const e=this._source.price(),t=this._source.currentSession();return null!==e&&("pre_market"===t||"post_market"===t)}}var pc=i(816570);class mc extends pc.PriceAxisView{constructor(e,t){super(),this._model=e,this._source=t}_updateRendererData(e,t,s){if(e.visible=!1,t.visible=!1,!this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value())return;const o=this._model.mainSeries(),r=o.priceScale(),n=o.firstValue();if(null===n)return;if(!this._source.canBeVisibleOnSymbolAndInterval())return;const a=this._source.price(),l=this._source.currentSession();if(null==a||"pre_market"!==l&&"post_market"!==l)return;const c=this._source.properties().childs(),d="pre_market"===l?(0,Li.resetTransparency)(c.preMarketColor.value()):(0,Li.resetTransparency)(c.postMarketColor.value());e.visible=!0,t.visible=!0,e.text=r.formatPriceAbsolute(a),t.text="pre_market"===l?h.t(null,{context:"market_status"},i(966412)):h.t(null,{context:"market_status"},i(619233)),s.coordinate=r.priceToCoordinate(a,n),s.background=d,s.textColor=this.generateTextColor(d),e.selectedMarkColor=this._model.selection().isSelected(this._source)?d:void 0}}var gc=i(786775);class Sc extends gc.HorizontalLinePaneView{constructor(e,t,i){super(),this._model=e,this._source=t;const s={doubleClickHandler:i,doubleTapHandler:i};this._lineRenderer.setHitTest(new hi.HitTestResult(hi.HitTarget.Regular,s))}_updateImpl(){const e=this._lineRendererData;e.visible=!1;const t=this._model.mainSeries(),i=this._source.properties().childs();if(!i.visible.value()||!t.isVisible())return
;const s=t.priceScale(),o=t.firstValue();if(null===o)return;if(!this._source.canBeVisibleOnSymbolAndInterval())return;const r=this._source.price(),n=this._source.currentSession();null===r||"pre_market"!==n&&"post_market"!==n||(e.visible=!0,e.y=s.priceToCoordinate(r,o),e.linestyle=i.lineStyle.value(),e.linewidth=i.lineWidth.value(),e.color="pre_market"===n?i.preMarketColor.value():i.postMarketColor.value())}}class vc extends dc.CustomSourceBase{constructor(e,t,i){super(e,t),this._extraHoursPrice=null,this._currentSession="holiday",this._quotesProvider=t.mainSeries().quotesProvider(),this._prePostMarketLinePaneView=new Sc(t,this,i),this._prePostPriceAxisView=new mc(t,this),this._prePostLabelPaneView=new hc.PanePriceAxisView(this._prePostPriceAxisView,t.mainSeries(),t),this._prePostPriceLineAxisView=new _c(t,this),this._quotesProvider.quotesUpdate().subscribe(this,this._updateQuotes),this._updateQuotes()}destroy(){this._quotesProvider.quotesUpdate().unsubscribeAll(this)}paneViews(e){return this._areViewsAvailableForPane(e)?[this._prePostMarketLinePaneView]:[]}labelPaneViews(e){return this._areViewsAvailableForPane(e)?[this._prePostLabelPaneView]:[]}priceAxisViews(e,t){return this._areViewsAvailableForPane(e)?e.findTargetPriceAxisViews(this,t,[this._prePostPriceAxisView],[this._prePostPriceLineAxisView]):[]}priceScale(){return this._model.mainSeries().priceScale()}updateAllViews(e){this._prePostMarketLinePaneView.update(e),this._prePostPriceAxisView.update(e),this._prePostPriceLineAxisView.update(e),this._prePostLabelPaneView.update(e)}price(){return this._extraHoursPrice}currentSession(){return this._currentSession}canBeVisibleOnSymbolAndInterval(){return this._model.mainSeries().isPrePostMarketPricesAvailableProperty().value()}properties(){return this._model.mainSeries().properties().childs().prePostMarket}_updateQuotes(){const e=this._quotesProvider.quotes().value();null===e?this._extraHoursPrice=null:(this._extraHoursPrice=e.rtc,void 0!==e.current_session&&(this._currentSession=e.current_session));const t=this._model.mainSeries().properties().childs().prePostMarket.childs().visible.value(),i=this._model.properties().childs().scalesProperties.childs().showPrePostMarketPriceLabel.value();this.canBeVisibleOnSymbolAndInterval()&&(t||i)&&(this.updateAllViews((0,Ds.sourceChangeEvent)(this.id())),this._model.updateSource(this))}_areViewsAvailableForPane(e){return!this._model.isInReplay().value()&&!this._model.isSnapshot()&&this._model.paneForSource(this._model.mainSeries())===e}}var fc=i(515834),bc=i(573477),yc=i(318776);function wc(e,t){return e.code<t.code?-1:e.code>t.code?1:0}class Cc{constructor(e){this._convertibleItems=e,this._idsToItems=new Map;for(const t of e)this._idsToItems.set(t.id,t)}convertible(e){return void 0!==this._idsToItems.get(e)}item(e){return this._idsToItems.get(e)??null}size(){return this._convertibleItems.length}filterConvertible(e,t){const i=this._convertibleItems.filter(function(e,t){return i=>!e.has(i.id)&&t(i.id)}(e,t));return i.sort(wc),i}getItems(){return this._convertibleItems.map((e=>e.id))
}}class Tc{constructor(e){this._allGroups=new Set,this._idToName=new Map,this._idToDescription=new Map,this._groupedUnitIds=new Map,this._groupedUnits=new Map,this._groupById=new Map,this._size=0,this._units=e;for(const t in e)if(e.hasOwnProperty(t)){this._allGroups.add(t),this._groupedUnitIds.set(t,new Set(e[t].map((e=>e.id)))),this._groupedUnits.set(t,e[t]);for(const i of e[t])this._size++,this._idToName.set(i.id,i.name),this._idToDescription.set(i.id,i.description),this._groupById.set(i.id,t)}}unitsChanged(e){return this._units!==e}size(){return this._size}name(e){return this._idToName.get(e)||e}description(e){return this._idToDescription.get(e)||e}unitGroupById(e){return this._groupById.get(e)||null}allGroups(){return new Set(this._allGroups)}unitsByGroups(e){const t=[];return e.forEach((e=>{const i=this._groupedUnits.get(e);void 0!==i&&t.push({name:e,units:i})})),t}convertible(e,t){for(const i of t){const t=this._groupedUnitIds.get(i);if(void 0!==t&&t.has(e))return!0}return!1}}var Pc=i(197486);class Mc{constructor(e){this._source=null,this._sourcePane=null,this._currentToolSupportsPhantomMode=!1,this._model=e}destroy(){this._source=null,this._sourcePane=null}source(){return this._source}onToolChanged(){this._removeSource(),this._currentToolSupportsPhantomMode=(0,se.isLineToolName)(D.tool.value())&&(0,Ut.supportsPhantomMode)(D.tool.value())}onCursorPositionUpdated(){if(!this._currentToolSupportsPhantomMode)return;const e=this._model.crosshairSource();if(this._sourcePane!==e.pane&&this._removeSource(),null===e.pane||!(0,Pc.isNumber)(e.index)||!(0,Pc.isNumber)(e.price))return void this._removeSource();const t={index:e.index,price:e.price};null!==this._source?this._source.setPoint(0,t):(this._source=this._model.createLineTool({pane:e.pane,point:t,linetool:D.tool.value()}),this._sourcePane=e.pane)}_removeSource(){null!==this._source&&(this._model.removeSource(this._source),this._source=null,this._sourcePane=null)}}class xc{constructor(e){this._convertibleItems=e,this._idsToItems=new Map;for(const t of e)this._idsToItems.set(t.id,t);this._idsToNames=new Map(Array.from(this._idsToItems.entries()).map((([e,t])=>[e,t.name])))}convertible(e){return void 0!==this._idsToItems.get(e)}item(e){return this._idsToItems.get(e)??null}size(){return this._convertibleItems.length}name(e){return this._idsToNames.get(e)??e}isReady(){return this._convertibleItems.length>0}getItems(){return this._convertibleItems.map((e=>e.id))}}function Ic(e,t,i){let s=null;if(i.metricConversionEnabled()&&(0,So.isSymbolSource)(e)){const e=i.availableMetrics(),o=t.metric(e);null!==o&&(s=o.selectedMetricId)}return s}var Lc=i(470841),Ac=i(321582);const kc=(e,t)=>!0,Ec=(e,t)=>!t.isPlotForceOverlay(e.id),Dc=(e,t)=>t.isPlotForceOverlay(e.id);function Bc(e,t){const i=e.priceScale(),s=e.firstValue();if(null===i||null===s)return;const o=e.bars().valueAt(t);if(null===o)return;let r;if(null!==e.priceSource())r=[e.barFunction()(o)];else switch(e.style()){case 12:r=[(0,a.ensure)(o[2]),(0,a.ensure)(o[3])];break;case 16:case 21:r=[(0,a.ensure)(o[2]),(0,
a.ensure)(o[4]),(0,a.ensure)(o[3])];break;default:r=[(0,a.ensure)(o[1]),(0,a.ensure)(o[2]),(0,a.ensure)(o[3]),(0,a.ensure)(o[4])]}return r.map((e=>({y:i.priceToCoordinate(e,s),price:e})))}class Rc{constructor(){this._lastValue=null}align(e,t,i){this._lastValue=null;let s=e;if(!(0,Ls.magnetEnabled)().value())return s;const o=i.mainDataSource();if(null===o)return s;const r=o.priceScale();if(!r||r.isEmpty())return s;const n=o.model().mainSeries(),l=(0,Ls.magnetSnapsToIndicators)().value();if(!l&&o!==n)return s;const c=(0,a.ensure)(o.firstValue()),h=r.priceToCoordinate(e,c),d=i.containsMainSeries()?function(e,t){return Bc(e,t)}(n,t)??[]:[];if(l){i.model().allStudies(!0).filter((e=>e.isVisible())).forEach((e=>{const s=function(e,t,i){const s=e.model(),o=s.paneForSource(e),r=s.mainPane(),n=s.mainSeries();if((0,Nt.isOverlayStudy)(e))return i===o?Bc(e,t):void 0;const a=e.metaInfo();if(!a)return;const l=e.data().valueAt(t);if(null===l)return;const c=a.hasForceOverlayPlots();if(!(i===o||c&&i===r))return;const h=e.priceScale(),d=n.priceScale(),u=e.firstValue(),_=n.firstValue();if(!h||!d||null===u||null===_)return;let p,m,g;o===r?(p=kc,m=d,g=_):i===o?(p=Ec,m=h,g=u):(p=Dc,m=d,g=_);const S=a.plots,v=S.filter((t=>!(0,Ac.isPlotWithTechnicalValues)(t)&&e.isPlotVisibleAt(t.id,1)&&p(t,a))),f=[];for(const e of v){const t=l[S.indexOf(e)+1];if(null!=t){const i=a.isPlotForceOverlay(e.id),s=(i?d:h).priceToCoordinate(t,i?_:u);f.push({y:s,price:m.coordinateToPrice(s,g)})}}return f}(e,t,i);s&&d.push(...s)}))}if(0===d.length)return s;d.sort(((e,t)=>Math.abs(e.y-h)-Math.abs(t.y-h)));const u=d[0];return((0,Ls.magnetMode)().value()===Lc.MagnetMode.StrongMagnet||Math.abs(u.y-h)<50)&&(s=u.price,this._lastValue=s),s}lastValue(){return this._lastValue}resetLastValue(){this._lastValue=null}}class Vc{constructor(e){this._appliedTimeFrame=new z.WatchedObject(null),this._appliedTimeFrameInfo=null,this._appliedTimeFrameChangedBound=this._appliedTimeFrameChanged.bind(this),this._model=e,e.mainSeries().dataEvents().seriesTimeFrame().subscribe(this,this._onSeriesTimeFrame),this._appliedTimeFrame.subscribe(this._appliedTimeFrameChangedBound)}destroy(){this._appliedTimeFrame.unsubscribe(this._appliedTimeFrameChangedBound),this._model.timeScale().logicalRangeChanged().unsubscribeAll(this),this._model.mainSeries().dataEvents().seriesTimeFrame().unsubscribeAll(this)}appliedTimeFrame(){return this._appliedTimeFrame}_appliedTimeFrameChanged(){this._model.timeScale().logicalRangeChanged().unsubscribe(this,this._invalidateAppliedTimeFrame)}_onSeriesTimeFrame(e,t,i,s){if(s){const e=this._model.timeScale();this._appliedTimeFrameInfo={logicalRange:e.logicalRange(),baseIndex:e.baseIndex()},e.logicalRangeChanged().subscribe(this,this._invalidateAppliedTimeFrame)}}_invalidateAppliedTimeFrame(){if(null===this._appliedTimeFrameInfo)return;const e=this._model.timeScale(),t=e.logicalRange(),i=e.baseIndex(),s=this._appliedTimeFrameInfo.logicalRange,o=this._appliedTimeFrameInfo.baseIndex
;(null===t||null===s||Math.abs(i-t.left()-(o-s.left()))>=.01||Math.abs(i-t.right()-(o-s.right()))>=.01)&&this._appliedTimeFrame.setValue(null)}}var Oc=i(892772),Nc=i(550837);class Wc extends Nc.BitmapCoordinatesPaneRenderer{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}hitTest(e){return null}_drawImpl(e){if(null===this._data)return;const{context:t,verticalPixelRatio:i,horizontalPixelRatio:s,bitmapSize:o}=e,r=Math.max(1,Math.floor(s));t.lineWidth=r;const n=Math.ceil(o.height*i),a=Math.ceil(o.width*s);if(t.lineCap="butt",this._data.vertLinesVisible){t.strokeStyle=this._data.vertLinesColor,(0,mi.setLineStyle)(t,this._data.vertLineStyle);for(const e of this._data.timeMarks){const i=Math.round(e.coord*s);(0,mi.drawVerticalLine)(t,i,0,n)}}if(this._data.horzLinesVisible){t.strokeStyle=this._data.horzLinesColor,(0,mi.setLineStyle)(t,this._data.horzLineStyle);for(const e of this._data.priceMarks){const s=Math.round(e.coord*i);(0,mi.drawHorizontalLine)(t,s,0,a)}}}}class Fc{constructor(e){this._renderer=new Wc,this._pane=e}update(){}renderer(){const e=this._pane.defaultPriceScale(),t=this._pane.model().timeScale();if(e.isEmpty()||t.isEmpty())return null;const i=this._pane.model().properties().childs().paneProperties.childs(),s=t.marks(),o=i.gridLinesMode.value(),r={horzLinesVisible:"both"===o||"horz"===o,vertLinesVisible:"both"===o||"vert"===o,horzLinesColor:i.horzGridProperties.childs().color.value(),vertLinesColor:i.vertGridProperties.childs().color.value(),horzLineStyle:i.horzGridProperties.childs().style.value(),vertLineStyle:i.vertGridProperties.childs().style.value(),priceMarks:e.marks(),timeMarks:null!==s?s:[]};return this._renderer.setData(r),this._renderer}}class zc extends Ho.DataSource{constructor(e){super(),this._model=e}id(){return"grid"}paneViews(e){return e.mode()===K.PaneMode.Regular?[new Fc(e)]:null}name(){return"Grid"}model(){return this._model}contextMenuStatName(){return"GridContextMenu"}}class Hc extends pc.PriceAxisView{constructor(e,t,i,s){super(),this._source=e,this._pane=t,this._priceScale=i,this._priceProvider=s,this._properties=e.model().properties().childs().scalesProperties}setHitTestData(e){this._hitTestData=e}setXCoord(e){this._xCoord=e}ignoreAlignment(){return!0}additionalPadding(e){return 0}_updateRendererData(e,t,i){if(e.visible=!1,t.visible=!1,this._pane.model().chartFloatingTooltipVisible())return;const s=this._priceScale,o=s.mainSource(),r=null!==o?o.firstValue():null;if(!this._isVisible()||s.isEmpty()||null===r)return;const n=this._currentPrice(s);if(null===n)return;i.background=(0,Li.resetTransparency)(this._bgColor()),i.textColor=this.generateTextColor(i.background);const a=this.additionalPadding(s.fontSize());i.additionalPaddingTop=a,i.additionalPaddingBottom=a,i.coordinate=s.priceToCoordinate(n,r),e.text=s.formatPrice(n,r),e.visible=!0,t.visible=!0,t.hitTestData=this._hitTestData,t.xCoord=this._xCoord}_currentPrice(e){return this._priceProvider(e)}}class Uc extends Hc{additionalPadding(e){return 2/12*e}_isVisible(){const e=this._source.lockedPane()
;return this._properties.childs().showPriceScaleCrosshairLabel.value()&&(this._source.visible||null!==e)&&(e??this._source.pane)===this._pane}_currentPrice(e){const t=D.crosshairLock.value();return null!==t&&1===t.type?this._pane===this._source.lockedPane()?t.price:null:super._currentPrice(e)}_bgColor(){const e=this._properties.childs();return this._source.model().dark().value()?e.crosshairLabelBgColorDark.value():e.crosshairLabelBgColorLight.value()}_updateRendererData(e,t,i){const s=t.visible;super._updateRendererData(e,t,i),this._source.isHovered()?t.backgroung=this._source.model().dark().value()?ai.colorsPalette["color-cold-gray-600"]:ai.colorsPalette["color-cold-gray-650"]:t.backgroung=void 0,s||(t.visible=s)}}class Gc extends Hc{_isVisible(){return null!==this._source.measurePane().value()}_bgColor(){return this._properties.childs().axisLineToolLabelBackgroundColorCommon.value()}}var jc=i(486075),qc=i(675336),$c=i(995659),Kc=i(976071),Zc=i(809603),Yc=i(431595),Xc=i(60523),Jc=i(302358);function Qc(e,t){const{dataSource:s,y:o,disabled:r,analyticsOpt:{method:n,source:a,actionSource:l,gaOrigin:c}}=t,d=s.priceScale(),u=s.firstValue();if(null===d||d.isPercentage()||d.isIndexedTo100()||null===u)return null;const _=d.coordinateToPrice(o,u);if(null===_)return null;const p=s.formatter().format(_),m=(0,So.isActingAsSymbolSource)(s)?s.symbolTitle($o.TitleDisplayTarget.StatusLine,!0,!0):s.title($o.TitleDisplayTarget.StatusLine,!0,{},!0),g={label:(0,Kc.hasUsualAlertPlots)(s)?h.t(null,{replace:{title:m,price:p}},i(715838)):h.t(null,{replace:{title:m}},i(97188)),statName:"AddAlertOnSource",iconId:"Alert.Add",shortcutHint:(0,O.humanReadableHash)(O.Modifiers.Alt+65),disabled:r};return r||(g.onExecute=async()=>{const t=e.mainSeries();(0,Yc.trackAlertCreationAttempt)(t.symbol(),n,a);(0,Jc.runOrSigninWithFeature)((()=>(async()=>{const t={dataSourceHub:e.model(),silent:!0,actionSource:l,method:n,source:a};(0,Ut.isLineTool)(s)?t.drawing=s:(t.series=s,t.value=(0,Zc.roundAlertValueUsingPrecision)(s,_)),(0,Xc.invokeAlertEditor)(t)})()),{feature:"alert",source:c})}),new Ui.ActionWithStandardIcon({actionId:"Alert.Add",options:g})}var eh=i(889727),th=i(938028),ih=i(994014);class sh extends hc.PanePriceAxisView{constructor(e,t,i,s,o){super(e,t,s),this._crossHairMenuCachedState=null,this._hasActions=!1,this._gaOrigin="CH menu",this._crosshairPriceAxisView=e,e.setPaneRendererLabelIcon(0),this._crosshair=t,this._scale=i,this._options=o,this._updateGaOrigin(),(0,jc.waitTradingService)().then((()=>{this._crossHairMenuCachedState=null}))}_updateImpl(e){const t=this._crosshair.y,i=this._chartModel.properties().childs().scalesProperties.childs().fontSize.value(),s=this._chartModel.timeScale().width(),o=this._crosshair.model().priceAxisRendererOptions(),n=i+2*this._crosshairPriceAxisView.additionalPadding(i)+o.paddingTop+o.paddingBottom,a=n,l=t-n/2,c=this._crosshair.pane,h=this._mainDataSourceOnPane(),u=h&&h.symbolSource(),_=!!u&&(u.isConvertedToOtherCurrency()||u.isConvertedToOtherUnit());if(this._updateGaOrigin(),null!==h){const e=function(e){
const t=e.priceScale();return t?.mode()??null}(h),t=h.idForAlert(),i=this._chartModel.isInReplay().value(),s=this._crossHairMenuCachedState,o=(0,d.isFeaturesetEnabled)("chart_crosshair_menu");null!==s&&s.id===t&&(0,r.default)(s.priceScale,e)&&s.isCurrencyOrUnitConverted===_&&s.isInReplay===i&&s.isMenuEnabled===o||(this._updateTooltipAndActionsAvailability(h,e,_),this._crossHairMenuCachedState={id:t,priceScale:e,isCurrencyOrUnitConverted:_,isInReplay:i,isMenuEnabled:o})}null!==h&&(0,So.isActingAsSymbolSource)(h)&&h.symbol();const p=null!==c&&(c.maximized().value()||!c.collapsed().value())&&this._hasActions;this._crosshairPriceAxisView.setPaneLabelVisible(p);const m=this._position();if(null!==m){const e=0,t=s-a,i=Boolean(ih.showPlusButtonOnCursor.value()),o=i?this._crosshair.x:void 0,r=void 0!==o?o-a/2:"left"===m?e:t,c=void 0!==o?o+a/2:"left"===m?e+a:t+a,h=(0,dt.box)(new dt.Point(r,l),new dt.Point(c,l+n));this._data={itemBox:h,clickHandler:this._handleClick.bind(this,m,i,h)},this._crosshairPriceAxisView.setHitTestData(this._data),this._crosshairPriceAxisView.setXCoord(o)}super._updateImpl(e)}_priceScale(){return this._scale}_updateGaOrigin(){this._gaOrigin=Boolean(ih.showPlusButtonOnCursor.value())?"CH menu cursor":"CH menu"}_updateTooltipAndActionsAvailability(e,t,i){this._hasActions=!1;const s=this._chartModel.isInReplay().value(),o=s&&!(0,th.isNewReplaySupportingPlatform)(),r=!i&&e.alertCreationAvailable().value()&&!s,n=!this._options.disableDrawHorizLineMenuAction,a=!i&&e===this._chartModel.mainSeries()&&Boolean((0,jc.tradingService)())&&!o;this._hasActions=a||r||n}_handleClick(e,t,i,s,o){if((0,d.isFeaturesetEnabled)("widget")&&(0,d.isFeaturesetEnabled)("referral_program_for_widget_owners"))return void(0,Co.showGoToTradingViewReferralDialog)({feature:"plusMenu"});(0,_t.trackEvent)(this._gaOrigin,"click");const r=this._mainDataSourceOnPane(),n=null!==r&&(0,So.isActingAsSymbolSource)(r)?r.symbol():null,a={pageX:o.pageX,pageY:o.pageY,clientX:o.clientX,clientY:o.clientY,screenX:o.screenX,screenY:o.screenY,price:this._crosshair.price,symbol:n};N.emit("onPlusClick",a),this._getMenuItems(e).then((s=>{s.length>0&&this._showContextMenu(s,t,i,o,e)}))}async _getMenuItems(e){const t=this._chartModel.mainSeries(),i=t.symbolInfo(),s=this._options.disableTradingMenuActions?null:(0,jc.tradingService)(),o=(0,a.ensureNotNull)(this._crosshair.pane).mainDataSource(),r=this._chartModel.isInReplay().value(),n=!r,l=r&&!(0,th.isNewReplaySupportingPlatform)(),c=o===t&&!(0,eh.isNonTradableSymbolType)(i?.type)&&Boolean(s)&&!l,h=n?this._createAlertMenuItems(e):Promise.resolve([]),d=c?this._createTradingMenuItems():Promise.resolve([]),u=this._createAddHorizontalLineMenuItem();return Promise.all([h,d,u]).then((([e,t,i])=>{t.length>0&&(0,a.ensureNotNull)(s).trackEvent(this._gaOrigin,"click");const o=e.length>0&&t.length>0;return[...e,o?new Vi.Separator:null,...t,(e.length>0||t.length>0)&&i.length>0?new Vi.Separator:null,...i].filter((e=>null!==e))}))}_createAlertMenuItems(e){if(null===this._crosshair.pane)return Promise.resolve([])
;const t=this._chartModel.mainSeries().interval();if($.Interval.isTicks(t))return Promise.resolve([]);const i=this._crosshair.pane.mainDataSource();if(null===i)return Promise.resolve([]);const s=i.symbolSource();if(!!s&&(s.isConvertedToOtherCurrency()||s.isConvertedToOtherUnit()))return Promise.resolve([]);const o=this._crosshair.y;if(this._options.menuForMainSourceOnly){if(i.alertCreationAvailable().value()&&i.isVisible()){const e=Qc(this._chartModel.undoModel(),this._getAddAlertActionOptions(i,o,!1));return Promise.resolve(null===e?[]:[e])}return Promise.resolve([])}const r=(0,a.ensureNotNull)(this._crosshair.pane).sourcesByGroup();let n=("left"===e?r.leftPriceScalesSources():r.rightPriceScalesSources()).filter((e=>(0,bs.isPriceDataSource)(e))).filter((e=>e.alertCreationAvailable().value()&&e.isVisible()));return n.reverse(),n=(0,J.moveToHead)(n,this._chartModel.mainSeries()),(0,$c.filterAccessibleDataSources)(n).then((e=>{const t=new Set(e),i=[];for(const e of n){const s=Qc(this._chartModel.undoModel(),this._getAddAlertActionOptions(e,o,!t.has(e)));null!==s&&i.push(s)}return i}))}_getAddAlertActionOptions(e,t,i){return{dataSource:e,y:t,disabled:i,analyticsOpt:{method:"crosshair_menu",source:"chart",actionSource:"crosshair_menu",gaOrigin:this._gaOrigin}}}_createTradingMenuItems(){const e=this._crosshair.y,t=(0,jc.tradingService)();if(null===t||null===this._crosshair.pane)return Promise.resolve([]);const i=this._crosshair.pane.mainDataSource();if(null===i)return Promise.resolve([]);const s=i.symbolSource();return!!s&&(s.isConvertedToOtherCurrency()||s.isConvertedToOtherUnit())?Promise.resolve([]):(0,qc.createTradeContext)({series:i,isMainChart:!1,y:e}).then((e=>t.chartContextMenuActions(e,{onlyMainActions:!0,hideNotExecutableAction:!0,gaOrigin:this._gaOrigin})))}async _createAddHorizontalLineMenuItem(){if(null===this._crosshair.pane)return[];const e=this._crosshair.pane.mainDataSource();if(null===e)return[];const t=this._crosshair.y,i=await this._getActionAddHorizontalLine({source:e,y:t,pane:this._crosshair.pane});return null===i?[]:[i]}async _getActionAddHorizontalLine(e){if(this._options.disableDrawHorizLineMenuAction)return null;const{source:t,y:i,pane:s}=e,o=this._getValue(t,i);if(null===o)return null;const{createDrawHorizontalLineAction:r}=await(0,Wi.actionsProviderModule)();return r(this._chartModel.undoModel(),s,{index:0,price:o})}_getValue(e,t){const i=e.priceScale(),s=e.firstValue();return null===i||null===s?null:i.coordinateToPrice(t,s)}_showContextMenu(e,t,i,s,o){const r="left"===o;setTimeout((()=>{const o=s.clientX-s.localX,n=s.clientY-s.localY,l=i.min.x+o,c=i.max.x+o,h=i.min.y+n,d=c-l,u=i.max.y+n-h,_=t?D.crosshairLock.value():void 0;if(void 0!==_){const e=(0,a.ensureNotNull)(this._chartModel.timeScale().points().roughTime(this._crosshair.index));D.crosshairLock.setValue({type:1,price:this._crosshair.price,time:e,modelId:this._chartModel.id(),paneId:(0,a.ensureNotNull)(this._crosshair.pane).id()})}fi.ContextMenuManager.showMenu(e,{clientX:s.clientX,clientY:s.clientY,box:{x:l,w:d,y:h,h:u},
attachToXBy:t?"auto":r?"left":"right",attachToYBy:"auto-strict",marginX:t?0:-d},{statName:t?"ContextPlusMenu":"ScalePlusMenu"},{menuName:"CrosshairMenuView"},(()=>{void 0!==_&&D.crosshairLock.setValue(_)}))}))}_mainDataSourceOnPane(){const e=this._crosshair.pane;return null!==e?e.mainDataSource():null}}class oh extends Nc.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){return void 0===this._data.clickHandler?null:new hi.HitTestResult(hi.HitTarget.Custom,{clickHandler:this._data.clickHandler,tapHandler:this._data.clickHandler})}_drawImpl(e){const t=this._data.vertLinesVisible,i=this._data.horzLinesVisible;if(!t&&!i)return;const{context:s,horizontalPixelRatio:o,verticalPixelRatio:r,bitmapSize:n}=e;s.lineWidth=Math.max(1,Math.floor(this._data.lineWidth*o)),s.strokeStyle=this._data.color,s.fillStyle=this._data.color,s.lineCap="butt",(0,mi.setLineStyle)(s,this._data.lineStyle);const a=Math.round(this._data.x*o),l=Math.round(this._data.y*r),c=Math.ceil(n.width*o),h=Math.ceil(n.height*r);t&&a>=0&&(0,mi.drawVerticalLine)(s,a,0,h),i&&l>=0&&(0,mi.drawHorizontalLine)(s,l,0,c),this._data.drawCenter&&(s.beginPath(),s.arc(a,l,Math.round(3*o),0,2*Math.PI,!0),s.fillStyle=this._data.color,s.fill()),this._data.scissors&&function(e,t,i){const{context:s,bitmapSize:o,horizontalPixelRatio:r,verticalPixelRatio:n}=e,a=24*r,l=Math.round(t-a/2);let c=Math.round(i-a/2);if(c<0)c=0;else{const e=o.height-a;c>e&&(c=e)}s.translate(l,c),s.scale(r,n),s.fillStyle="#0f0f0f",s.fill(rh),s.strokeStyle="#fff",s.lineWidth=1,s.stroke(rh)}(e,a,l)}}const rh=new Path2D("m15.68 3.72-3.82 5.52-3.83-5.52-.28-.42-.42.3a2.84 2.84 0 0 0-.68 3.92l3.27 4.73-1.16 1.68a3.34 3.34 0 0 0-4.26 3.22 3.34 3.34 0 0 0 3.32 3.35 3.34 3.34 0 0 0 3.08-4.6l1-1.44 1.13 1.62a3.34 3.34 0 0 0 3.15 4.42c1.84 0 3.32-1.5 3.32-3.35a3.34 3.34 0 0 0-4.42-3.17l-1.23-1.78 3.22-4.65a2.86 2.86 0 0 0-.69-3.96l-.41-.29-.29.42ZM7.82 16.27c.47 0 .86.39.86.88 0 .48-.39.87-.86.87a.87.87 0 0 1-.86-.87c0-.5.4-.88.86-.88Zm8.36 0c.47 0 .86.39.86.88 0 .48-.4.87-.86.87a.87.87 0 0 1-.86-.87c0-.5.39-.88.86-.88Z");const nh=ai.colorsPalette["color-tv-blue-500"];class ah{constructor(e,t){this._rendererData={},this._renderer=new oh(this._rendererData),this._source=e,this._pane=t}update(){}renderer(){const e=this._source.selectPointMode().value()!==D.SelectPointMode.None,t=this._source.lockedPane(),i=(this._source.visible||null!==t)&&(this._source.areLinesVisible||e)&&!this._source.linesShouldBeHidden(),s=this._rendererData;if(!i||null===this._pane)return null;const o=this._source.paneForPointSelect(),r=this._source.isReplaySelection(),n=t??this._source.pane,l=this._pane===n,c=r||(null!==o?n===o&&this._pane===o:l);if(s.scissors=!1,e&&(r||this._source.isOnHoveredChartWidget())&&c){const e=(0,a.ensureNotNull)(this._source.pointToSelect());s.color=this._source.lineColor()||nh,r?(s.lineWidth=2,s.scissors=l):s.lineWidth=1,s.lineStyle=fc.LINESTYLE_SOLID,s.horzLinesVisible=!0,s.vertLinesVisible=!0,s.drawCenter=!1,"time"===e?s.horzLinesVisible=!1:"price"===e&&(s.vertLinesVisible=!1)}else{
const e=this._source.properties(),t=D.tool.value(),i=(0,Zt.lastMouseOrTouchEventInfo)(),o=i.isTouch&&!i.stylus&&((0,se.isLineToolName)(t)||(0,D.toolIsMeasure)(t));let r;r=o?nh:e.childs().color.value();const a=e.childs().transparency.value();!o&&a>0&&(r=(0,Li.generateColor)(r,a));const l=!this._pane.model().chartFloatingTooltipActive()&&this._pane===n&&(this._pane.maximized().value()||!this._pane.collapsed().value());s.color=r,s.horzLinesVisible=l,s.vertLinesVisible=!0,s.lineWidth=e.childs().width.value(),s.lineStyle=e.childs().style.value(),s.drawCenter=o&&this._pane===n}return s.x=this._source.lockedX()??this._source.x,s.y=this._source.lockedY()??this._source.y,this._renderer}}var lh=i(478420);const ch={backgroundColor:(0,Li.generateColor)(ai.colorsPalette["color-tv-blue-500"],70),borderColor:(0,Li.generateColor)(ai.colorsPalette["color-tv-blue-500"],20)};class hh{constructor(e){this._renderer=new lh.RectangleRenderer,this._rectangle=null,this._crosshair=e}update(){const e=this._crosshair.selection();null!==e&&null!==this._crosshair.pane?this._rectangle=this._crosshair.pane.logicalRectToPixels(e):this._rectangle=null}renderer(){if(!this._rectangle)return null;const e={backcolor:ch.backgroundColor,color:ch.borderColor,fillBackground:!0,linewidth:1,points:[this._rectangle.min,this._rectangle.max],extendLeft:!1,extendRight:!1};return this._renderer.setData(e),this._renderer}}var dh=i(196768),uh=i(593859),_h=i(974266),ph=i(669899),mh=i(659134),gh=i(449938),Sh=i(603581);const vh=h.t(null,void 0,i(338093)),fh=h.t(null,{context:"study"},i(596168)),bh=(0,Ua.getPercentageFormatter)(),yh=new _h.TimeSpanFormatter,wh=(0,Ua.getVolumeFormatter)(),Ch=(0,ai.getHexColorByName)("color-tv-blue-500"),Th=(0,ai.getHexColorByName)("color-ripe-red-400"),Ph={bgColorPositive:(0,Li.generateColor)(Ch,80),bgColorNegative:(0,Li.generateColor)(Th,80),colorPositive:(0,ai.getHexColorByName)("color-tv-blue-600"),colorNegative:(0,ai.getHexColorByName)("color-ripe-red-400"),labelBgColorPositive:Ch,labelBgColorNegative:Th};class Mh{constructor(e,t){this._horzTrenRenderer=new ph.TrendLineRenderer,this._vertTrenRenderer=new ph.TrendLineRenderer,this._bgRenderer=new lh.RectangleRenderer,this._labelRenderer=new mh.TextRenderer,this._p1=null,this._p2=null,this._source=e,this._pane=t}update(e){const[t,i]=this._source.measurePoints();if(void 0===i)return this._p1=null,void(this._p2=null);const s=(0,a.ensureNotNull)(this._source.measurePane().value()),o=t.price,r=i.price,n=i.index-t.index,l=(0,dh.forceLTRStr)(""+n),c=(0,a.ensureNotNull)(s.mainDataSource()),h=c.firstValue();if(null===h)return this._p1=null,void(this._p2=null);const d=this._source.model().timeScale().indexToCoordinate(t.index),u=this._source.model().timeScale().indexToCoordinate(i.index),_=s.defaultPriceScale().priceToCoordinate(o,h),p=s.defaultPriceScale().priceToCoordinate(r,h);this._p1=new dt.Point(d,_),this._p2=new dt.Point(u,p);const m=this._source.model().timeScale().indexToUserTime(t.index),g=this._source.model().timeScale().indexToUserTime(i.index);let S=null
;null!==m&&null!==g&&(S=(g.valueOf()-m.valueOf())/1e3);const v=r-o,f=100*v/Math.abs(o),b=this._pane.model().mainSeries().symbolInfo(),y=b&&(0,Ua.getPipFormatter)(b),w=(0,a.ensureNotNull)(c.formatter()),C=(w.formatChange?.(r,o)??w.format(v))+" ("+bh.format(Math.round(100*f)/100)+") "+(y?y.format(v):""),T=null!==S?yh.format(S):null,P=null!==T?", "+(0,dh.startWithLTR)(T):"";let M=(0,dh.forceLTRStr)(C)+"\n"+vh.format({count:l})+P;const x=this._source.measureVolume();Number.isNaN(x)||(M+=`\n${fh} ${wh.format(x)}`);const I=r<o?Ph.bgColorNegative:Ph.bgColorPositive,L=r<o?Ph.colorNegative:Ph.colorPositive,A=r<o?Ph.labelBgColorNegative:Ph.labelBgColorPositive,k={points:[this._p1,this._p2],linewidth:0,fillBackground:!0,color:I,backcolor:I,extendLeft:!1,extendRight:!1};this._bgRenderer.setData(k);const E=this._p1.add(this._p2).scaled(.5);{const e=Math.round(E.y),t=new dt.Point(this._p1.x,e),i=new dt.Point(this._p2.x,e),s={points:[t,i],color:L,linewidth:1,linestyle:fc.LINESTYLE_SOLID,extendleft:!1,extendright:!1,leftend:Sh.LineEnd.Normal,rightend:Math.abs(t.x-i.x)>=50?Sh.LineEnd.Arrow:Sh.LineEnd.Normal};this._horzTrenRenderer.setData(s)}{const e=Math.round(E.x),t=new dt.Point(e,this._p1.y),i=new dt.Point(e,this._p2.y),s={points:[t,i],color:L,linewidth:1,linestyle:fc.LINESTYLE_SOLID,extendleft:!1,extendright:!1,leftend:Sh.LineEnd.Normal,rightend:Math.abs(t.y-i.y)>=50?Sh.LineEnd.Arrow:Sh.LineEnd.Normal};this._vertTrenRenderer.setData(s)}const D={x:0,y:10},B=.5*(this._p1.x+this._p2.x),R=this._p2.y,V=new dt.Point(B,R),O={points:[V],text:M,color:"#FFFFFF",horzAlign:uh.HorizontalAlign.Center,vertAlign:uh.VerticalAlign.Middle,font:yi.CHART_FONT_FAMILY,offsetX:D.x,offsetY:D.y,bold:!1,italic:!1,fontsize:12,lineSpacing:8,backgroundColor:A,backgroundTransparency:10,boxPaddingVert:9,boxPaddingHorz:9,backgroundRoundRect:4};this._labelRenderer.setData(O);const N=this._labelRenderer.measure(),W=(0,mh.calculateLabelPosition)(N,this._p1,this._p2,D,this._pane.height());this._labelRenderer.setPoints([W])}renderer(){if(null===this._p1||null===this._p2)return null;const e=new gh.CompositeRenderer;return e.append(this._bgRenderer),e.append(this._horzTrenRenderer),e.append(this._vertTrenRenderer),e.append(this._labelRenderer),e}}var xh=i(4570);class Ih extends Jn.MediaCoordinatesPaneRenderer{constructor(e){super(),this._svgMap=new Map,this._data=e,this._svgMap.set(e.theme,this._createSvgRenderer(e.theme))}hitTest(){return null}setData(e){this._svgMap.has(e.theme)||this._svgMap.set(e.theme,this._createSvgRenderer(e.theme)),this._data=e}_drawImpl(e){const{context:t,mediaSize:i}=e,{theme:s,x:o}=this._data,r=this._svgMap.get(s);if(!r)return;const n=r.viewBox(),{width:a,height:l}=n,c=a/2;o+c<0||o-c>i.width||(t.translate(o-c,i.height-l),r.render(t,{targetViewBox:n}))}_createSvgRenderer(e){const t=1===e?xh.replace("backgroundColor",(0,ai.getHexColorByName)("color-cold-gray-900")).replace("lineColor",(0,ai.getHexColorByName)("color-cold-gray-450")):xh.replace("backgroundColor",(0,ai.getHexColorByName)("color-white")).replace("lineColor",(0,
ai.getHexColorByName)("color-cold-gray-550"));return(0,Si.svgRenderer)(t)}}class Lh{constructor(e){this._source=e,this._renderer=new Ih(this._getRenderData(0))}update(){}renderer(){const e=this._source.visible&&this._source.areLinesVisible,t=this._source.lockedX(),i=0===D.crosshairLock.value()?.type;return e&&i&&null!==t?(this._renderer.setData(this._getRenderData(t+1)),this._renderer):null}_getRenderData(e){return{x:e,theme:this._source.model().dark().value()?1:0}}}const Ah=30;class kh{constructor(e,t,i){this._renderer=new lh.RectangleRenderer,this._invalidated=!0,this._source=e,this._pane=t,this._model=i}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}_updateImpl(){if(this._renderer.setData(null),!this._pane||!this._source.visible)return;if(!this._source.model().mainSeries().lastValueData(void 0,!0,!0).index)return;const e=new dt.Point(this._source.lockedX()??this._source.x,0),t=new dt.Point(this._pane.width(),this._pane.height()),i={backcolor:(0,Li.applyTransparency)(this._model.backgroundColorAtYPercentFromTop(.5),Ah),color:(0,Li.applyTransparency)(this._model.backgroundColorAtYPercentFromTop(.5),Ah),fillBackground:!0,linewidth:0,points:[e,t],disableInteractions:!0,extendLeft:!1,extendRight:!1};this._renderer.setData(i)}}var Eh=i(719456),Dh=i(75336);class Bh extends Eh.DataWindowView{constructor(e){super(),this._invalidated=!0,this._dateItem=new Eh.DataWindowItem("",h.t(null,void 0,i(507729)),""),this._timeItem=new Eh.DataWindowItem("",h.t(null,void 0,i(862119)),""),this._model=e,this._items.push(this._dateItem),this._items.push(this._timeItem)}update(){this._invalidated=!0}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}_updateImpl(){const e=this._model.mainSeries().isDWM();if(this._timeItem.setVisible(!e),this._timeItem.setValue(Dh.notAvailable),this._dateItem.setValue(Dh.notAvailable),this._model.timeScale().isEmpty())return;let t=this._model.crosshairSource().appliedIndex();if(!(0,Pc.isNumber)(t)){const e=this._model.mainSeries().data().last();if(null===e)return;t=e.index}const i=this._model.timeScale().indexToUserTime(t);null!==i&&(this._dateItem.setValue(this._model.dateFormatter().format(i)),e||this._timeItem.setValue(this._model.timeFormatter().format(i)))}}var Rh=i(131358);const Vh=ai.colorsPalette["color-tv-blue-500"],Oh=h.t(null,{context:"Replay"},i(157417));class Nh extends Rh.TimeAxisView{constructor(e,t,i,s=!1){super(e),this._indexProvider=i,this._highlighted=s,this._source=t,this._properties=e.properties().childs().scalesProperties}_getText(e){if(this._source.isReplaySelection()){const t=this._model.timeScale().indexToUserTime(e);return null!==t?`${Oh}: ${this._model.dateTimeFormatter().format(t)}`:""}return super._getText(e)}_getBgColor(){if(this._source.isReplaySelection())return Vh;const e=this._properties.childs()
;return this._highlighted?e.axisLineToolLabelBackgroundColorCommon.value():this._model.dark().value()?e.crosshairLabelBgColorDark.value():e.crosshairLabelBgColorLight.value()}_getIndex(){return this._model.crosshairSource().visible||null!==this._source.lockedPane()?this._indexProvider():null}_isVisible(){return this._properties.childs().showTimeScaleCrosshairLabel.value()}}var Wh=i(934),Fh=i(686330),zh=i(968105),Hh=i(171898);const Uh=(0,Li.applyAlpha)(Hh.colors.colorRipeRed500,.25),Gh=(0,Li.applyAlpha)(Hh.colors.colorRipeRed500,.03);class jh{constructor(e){this._invalidated=!0,this._circleRenderer=new zh.CircleRenderer,this._source=e}update(e){this._invalidated=!0}renderer(e){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._circleRenderer}_updateImpl(){const e=this._source.originX(),t=this._source.originY();Number.isFinite(e)&&Number.isFinite(t)?this._circleRenderer.setData({center:(0,dt.point)(e,t),radius:18,lineWidth:1,color:Gh,backColor:Uh,disableInteractions:!0}):this._circleRenderer.setData(null)}}class qh{constructor(e){this._activeHighlighter=null,this._highlighters=new Map,this._toolsFactory=null,this._throttleUpdateHighlighters=(0,Sn.default)((()=>{const e=(0,Ds.sourceChangeEvent)(this._crosshair.id());let t=!1;const i=Array.from(this._highlighters.keys());for(const s of i){const i=[];for(const t of(0,a.ensureDefined)(this._highlighters.get(s)))t.animationProgress()<1?(t.updateAllViews(e),i.push(t)):t.destroy?.();i.length>0?(this._highlighters.set(s,i),t=!0):this._highlighters.delete(s)}t&&this._crosshair.model().updateSource(this._crosshair)}),20,{leading:!0}),this._crosshair=e,this._view=new jh(e),this._currentTool=D.tool.spawn(),this._currentTool.subscribe((e=>{(0,D.toolIsDemonstration)(e)&&null===this._toolsFactory&&(this._toolsFactory=new yn.AsyncResourceWrapper((async()=>{const e=await Promise.all([i.e(88874),i.e(41414)]).then(i.bind(i,813414));return(t,i,s,o)=>new e.LineToolDemonstrationHighlighter(t,i,s,o)})()))}),{callWithLast:!0})}destroy(){for(const[,e]of this._highlighters)for(const t of e)t.destroy?.();this._currentTool.destroy()}update(e){this._view.update(e);for(const[,t]of this._highlighters)for(const i of t)i.updateAllViews(e)}paneViews(e){const t=[];e===this._crosshair.pane&&(0,D.toolIsDemonstration)(D.cursorTool.value())&&t.push(this._view);for(const i of this._highlighters.get(e)??[]){const s=i.paneViews(e);s&&t.push(...s)}return this._highlighters.size>0&&this._throttleUpdateHighlighters(),t}createHighlighter(){const e=this._toolsFactory?.get();if(!e)return;this._activeHighlighter=e(this._crosshair.model(),Uh,36,4e3);const t=(0,a.ensureNotNull)(this._crosshair.pane),i=(0,a.ensureNotNull)(t.mainDataSource());(0,Ut.prepareLineToolPropertiesByOwnerSource)(this._activeHighlighter.properties(),i),this._activeHighlighter.setOwnerSource(i);const s=this._highlighters.get(t)??[];s.push(this._activeHighlighter),this._highlighters.set(t,s)}addHighlighterPosition(e){this._activeHighlighter?.addPoint(e),this.update((0,Ds.sourceChangeEvent)(this._crosshair.id()))}
isThereUnfinishedHighlighter(){return null!==this._activeHighlighter}finishHighlighter(){this._activeHighlighter?.finish(),this._activeHighlighter=null,this._throttleUpdateHighlighters()}}const $h={menuEnabled:!1,menuForMainSourceOnly:!1,disableTradingMenuActions:!1,disableDrawHorizLineMenuAction:!1};let Kh=0;const Zh=(0,l.getLogger)("Chart.Crosshair");class Yh extends Ho.DataSource{constructor(e,t,i){super(),this.pane=null,this.price=NaN,this.index=NaN,this.visible=!0,this.areLinesVisible=!0,this.x=NaN,this.y=NaN,this._lockData=null,this._crosshairDemonstration=new qh(this),this._measurePane=new H.WatchedValue(null),this._measurePaneViewCache=new WeakMap,this._startMeasurePoint=null,this._endMeasurePoint=null,this._lastValidMeasurePoint=null,this._normalizedMeasurePoints=null,this._linesShouldBeHidden=!1,this._isOnHoveredChartWidget=!1,this._crossHairSelectPointMode=new H.WatchedValue(D.SelectPointMode.None),this._selectionPane=null,this._selectionView=new hh(this),this._selectionStartPoint=null,this._timeLockPaneView=null,this._crosshairPaneViewCache=new WeakMap,this._pointSelectionPaneViewCache=new WeakMap,this._priceAxisViews=new Map,this._panePriceAxisViews=new Map,this._startMeasurePriceAxisViews=new Map,this._endMeasurePriceAxisViews=new Map,this._originX=NaN,this._originY=NaN,this._subscribed=!1,this._movedDelegate=new g.Delegate,this._pointSelectedDelegate=new g.Delegate,this._requestPointParams=null,this._volumeCalculator=null,this._currentMeasurePointsetAndSymbolId=null,this._model=e,this._options=Object.assign({},$h,i||{}),this._dataWindowView=new Bh(e),this.setSelectionEnabled(!1);const s=e=>t=>t===(0,a.ensureNotNull)(this._measurePane.value()).defaultPriceScale()?e():null;this._currentPosPriceProvider=e=>{const t=(0,a.ensureNotNull)(this.pane);if(e===t.defaultPriceScale())return this.price;const i=(0,a.ensureNotNull)(t.defaultPriceScale().mainSource()).firstValue();if(null===i)return null;const s=t.defaultPriceScale().priceToCoordinate(this.price,i),o=(0,a.ensureNotNull)(e.mainSource()).firstValue();return null===o?null:e.coordinateToPrice(s,o)},this._startMeasurePriceProvider=s((()=>(0,a.ensureNotNull)(this._startMeasurePoint).price)),this._endMeasurePriceProvider=s((()=>(0,a.ensureNotNull)(this._lastMeasurePoint()).price)),this._properties=t;this._timeAxisView=new Nh(e,this,(()=>this.appliedIndex()),!1),this._startMeasureTimeAxisView=new Nh(e,this,(()=>(0,a.ensureNotNull)(this._startMeasurePoint).index),!0),this._endMeasureTimeAxisView=new Nh(e,this,(()=>(0,a.ensureNotNull)(this._lastMeasurePoint()).index),!0),this._cursorTool=D.cursorTool.spawn(),e.readOnly()||this._cursorTool.subscribe((e=>this.areLinesVisible="arrow"!==e),{callWithLast:!0}),this._crosshairLock=D.crosshairLock.spawn(),this._showPlusButtonOnCursor=ih.showPlusButtonOnCursor.spawn();const o=()=>{this.updateAllViews((0,Ds.sourceChangeEvent)(this.id())),this._model.lightUpdate()};this._crosshairLock.subscribe(o),this._showPlusButtonOnCursor.subscribe(o)}destroy(){null!==this._volumeCalculator&&this._volumeCalculator.destroy(),
this._measurePane.setValue(null),this._crosshairLock.destroy(),this._showPlusButtonOnCursor.destroy(),this._cursorTool.destroy(),this._removeMeasurePointset(),this._crosshairDemonstration.destroy(),super.destroy()}name(){return"Crosshair"}moved(){return this._movedDelegate}originX(){return this._originX}originY(){return this._originY}saveOriginCoords(e,t){this._originX=e,this._originY=t}clearOriginCoords(){this._originX=NaN,this._originY=NaN}currentPoint(){return new dt.Point(this.x,this.y)}model(){return this._model}appliedIndex(){return this._getLockData().index??this.index}lockedX(){return this._getLockData().xCoord??null}lockedY(){return this._getLockData().yCoord??null}lockedPane(){const e=D.crosshairLock.value();return null===e||1!==e.type?null:this._model.id()===e.modelId?this._model.paneForId(e.paneId):this._model.mainPane()}invalidateLockPosition(){this._lockData=null}startMeasurePoint(){return this._startMeasurePoint||null}endMeasurePoint(){return this._endMeasurePoint||null}measureVolume(){if(null===this._volumeCalculator)return NaN;const[e,t]=this.measurePoints();return void 0===t?NaN:this._volumeCalculator.volume(e.index,t.index)}measurePane(){return this._measurePane.readonly()}crosshairDemonstration(){return this._crosshairDemonstration}startMeasuring(e,t){this._startMeasurePoint=e,this._measurePane.setValue(t),t.containsMainSeries()&&((0,a.assert)(null===this._volumeCalculator),this._volumeCalculator=new Wh.SeriesTimeRangeVolumeCalculator(this.model().mainSeries())),this._model.updatePane(t)}finishMeasure(e){this._endMeasurePoint=e,this._createMeasurePointset((0,a.ensureNotNull)(this._startMeasurePoint),this._endMeasurePoint)}clearMeasure(){this._removeMeasurePointset(),this._measurePane.setValue(null),delete this._startMeasurePoint,delete this._endMeasurePoint,delete this._lastValidMeasurePoint,this._model.lightUpdate(),null!==this._volumeCalculator&&(this._volumeCalculator.destroy(),this._volumeCalculator=null)}measurePoints(){const e=[(0,a.ensureNotNull)(this._startMeasurePoint)],t=this._lastMeasurePoint();return null!==t&&e.push(t),e}startSelection(e){this._selectionStartPoint=this.currentLogicalPoint(),this._selectionPane=e}clearSelection(){this._selectionStartPoint=null,this._selectionPane=null}selection(){return this._selectionStartPoint?{p1:this._selectionStartPoint,p2:this.currentLogicalPoint()}:null}currentLogicalPoint(){return{index:this.appliedIndex(),price:this.price}}selectPointMode(){return this._crossHairSelectPointMode}lineColor(){return this._requestPointParams?.lineColor??null}cancelRequestSelectPoint(){this._crossHairSelectPointMode.value()!==D.SelectPointMode.None&&this._setSelectPointModeState(D.SelectPointMode.None),this._requestPointParams=null}requestPointParams(){return this._requestPointParams}requestSelectPoint(e){(0,a.assert)(this._crossHairSelectPointMode.value()===D.SelectPointMode.None,"Point already requested")
;const{pointType:t,pane:i,lineColor:s,ignoreIfOutOfData:o=3,selectFromAllChartsIfOutOfData:r,selectPointMode:n=D.SelectPointMode.Study,alignToTheLatestBarIfTimePointIsOutOfData:l=e.selectPointMode===D.SelectPointMode.Replay}=e;this._requestPointParams={pointType:t,pane:i,lineColor:s,ignoreIfOutOfData:o,selectFromAllChartsIfOutOfData:r,selectPointMode:n,alignToTheLatestBarIfTimePointIsOutOfData:l},i&&((0,a.assert)(-1!==this._model.panes().indexOf(i),"Chart model doesn't contain specified pane"),this._model.panesCollectionChanged().subscribe(this,this._paneCollectionChanged)),this._setSelectPointModeState(n)}onPointSelected(){return this._pointSelectedDelegate}trySelectCurrentPoint(){const e=this.pane;if(!e)return;const{pointType:t,selectFromAllChartsIfOutOfData:i,ignoreIfOutOfData:s,pane:o}=(0,a.ensureNotNull)(this._requestPointParams),r=this._model.mainSeries().bars(),n=r.firstIndex(),l=r.lastIndex();if(null===n||null===l)return;let c=null;if(!r.search(this.index,Wl.PlotRowSearchMode.Exact)&&"price"!==t&&i&&(c=Math.min(...Array.from(D.barTimesUnderCursor.values()))??null,null===c))return;if(o&&o!==e)return;let h,d=c;if("price"!==t&&null===c){const e=this.index;switch(s){case 3:if(e<n||e>l)return;break;case 1:if(e<n)return;break;case 2:if(e>l)return}if(d=this._model.timeScale().indexToTimePoint(e),null===d)return}if("time"!==t){const t=e.mainDataSource();if(null===t)return;const i=t.firstValue(),s=t.priceScale();if(null===i||null===s)return;h=s.coordinateToPrice(this.y,i)}this._setSelectPointModeState(D.SelectPointMode.None),this._pointSelectedDelegate.fire({time:d??void 0,price:h},e)}isOnHoveredChartWidget(){return this._isOnHoveredChartWidget}setOnHoveredChartWidget(e){this._isOnHoveredChartWidget=e}isReplaySelection(){return("AllCharts"===me.value()||this._isOnHoveredChartWidget)&&this._crossHairSelectPointMode.value()===D.SelectPointMode.Replay}clearPosition(){this.visible=!1,this.index=NaN,this.price=NaN,this.x=NaN,this.y=NaN,this.pane=null,this.clearOriginCoords(),this._updateVisibilityDependentPaneViews()}setPosition(e,t,i){this._subscribed||(this._model.mainSeries().onRestarted().subscribe(this,this.clearMeasure),this._subscribed=!0),this.visible=!0;const s=this._model.id(),o=this._model.mainSeries().bars().search(this.index,Wl.PlotRowSearchMode.NearestRight);return o&&D.barTimesUnderCursor.set(s,o.value[0]),this._tryToUpdateViews(e,t,i)}setLinesShouldBeHidden(e){this._linesShouldBeHidden=e}linesShouldBeHidden(){return this._linesShouldBeHidden}handleContextMenuEvent(e){this._crossHairSelectPointMode.value()!==D.SelectPointMode.None&&this._setSelectPointModeState(D.SelectPointMode.None)}properties(){return this._properties}priceAxisViews(e,t){const i=this._requestPointParams?.pointType,s=!i||"time"!==i||!this._isOnHoveredChartWidget,o=[];return(this.lockedPane()??this.pane)===e&&s&&o.push(this._createPriceAxisViewOnDemand(this._priceAxisViews,this._panePriceAxisViews,e,t,this._currentPosPriceProvider,Uc,!0)[0]),
this._startMeasurePoint&&o.push(this._createPriceAxisViewOnDemand(this._startMeasurePriceAxisViews,null,e,t,this._startMeasurePriceProvider,Gc)[0]),this._lastMeasurePoint()&&o.push(this._createPriceAxisViewOnDemand(this._endMeasurePriceAxisViews,null,e,t,this._endMeasurePriceProvider,Gc)[0]),o}timeAxisViews(){const e=[],t=this._requestPointParams?.pointType,i=!t||"price"!==t||!this._isOnHoveredChartWidget;return this._linesShouldBeHidden||!this.visible&&null===D.crosshairLock.value()||!i||e.push(this._timeAxisView),this._startMeasurePoint&&e.push(this._startMeasureTimeAxisView),this._lastMeasurePoint()&&e.push(this._endMeasureTimeAxisView),e}paneViews(e){if(void 0===e||e.mode()!==K.PaneMode.Regular)return null;const t=[];if(this.isReplaySelection()){let i=this._pointSelectionPaneViewCache.get(e);i||(i=new kh(this,e,this._model),this._pointSelectionPaneViewCache.set(e,i)),t.push(i)}let i=this._crosshairPaneViewCache.get(e);if(i||(i=new ah(this,e),this._crosshairPaneViewCache.set(e,i)),t.push(i),e===this._selectionPane&&t.push(this._selectionView),e===this._measurePane.value()){let i=this._measurePaneViewCache.get(e);i||(i=new Mh(this,e),this._measurePaneViewCache.set(e,i)),i.update((0,Ds.sourceChangeEvent)(this.id())),t.push(i)}if((ih.addPlusButtonProperty.value()||this._showPlusButtonOnCursor.value())&&1!==D.crosshairLock.value()?.type){const i=e===this.pane,s=!_.CheckMobile.any()||window.screen.width>=320,o=D.tool.value(),r=(0,se.isLineToolName)(o),n=null!==this._model.lineBeingEdited()||null!==this._model.lineBeingCreated()||this._model.sourcesBeingMoved().length>0||null!==this._model.customSourceBeingMoved()||(0,D.toolIsMeasure)(o);if(i&&this._isOnHoveredChartWidget&&this._crossHairSelectPointMode.value()===D.SelectPointMode.None&&s&&!r&&!n){const i=e.mainDataSource();if(null!==i){const s=i.priceScale();if(null!==s){const i=this._createPriceAxisViewOnDemand(this._priceAxisViews,this._panePriceAxisViews,e,s,this._currentPosPriceProvider,Uc,!0)[1];null!==i&&t.push(i)}}}}return 0===D.crosshairLock.value()?.type&&(null===this._timeLockPaneView&&(this._timeLockPaneView=new Lh(this)),t.push(this._timeLockPaneView)),t.push(...this._crosshairDemonstration.paneViews(e)),t}dataWindowView(){return this._dataWindowView}updateAllViews(e){this._priceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._panePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._startMeasurePoint&&(this._startMeasurePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._startMeasureTimeAxisView.update(e)),this._lastMeasurePoint()&&(this._endMeasurePriceAxisViews.forEach((t=>{t.forEach((t=>t.update(e)))})),this._endMeasureTimeAxisView.update(e)),this._timeAxisView.update(e),this._selectionView.update(),this._dataWindowView.update(),this._crosshairDemonstration.update(e),this._updateVisibilityDependentPaneViews()}isMenuEnabled(){return this._options.menuEnabled}isHoveredEnabled(){return ih.addPlusButtonProperty.value()||this._showPlusButtonOnCursor.value()}isHovered(){return this._model.hoveredSource()===this}
pointToSelect(){return this._requestPointParams?.pointType??null}paneForPointSelect(){return this._requestPointParams?.pane??null}contextMenuStatName(){return"CrossHairContextMenu"}restart(){this._currentMeasurePointsetAndSymbolId=null,this._normalizedMeasurePoints&&this._createMeasurePointsetWithNormalizedPoints(this._normalizedMeasurePoints)}_lastMeasurePoint(){return this._endMeasurePoint?this._endMeasurePoint:(null!==this.pane&&this._measurePane.value()===this.pane&&(this._lastValidMeasurePoint={price:this._model.magnet().align(this.price,this.index,this.pane),index:this.index}),this._lastValidMeasurePoint||null)}_createPriceAxisViewOnDemand(e,t,i,s,o,r,n=!1){let l=e.get(i),c=null!==t?t.get(i):void 0;void 0===l&&(l=new Map,e.set(i,l),this.isMenuEnabled()&&null!==t&&(c=new Map,t.set(i,c)),n&&i.onDestroyed().subscribe(this,(()=>this._onPaneDestroyed(i))));let h=l.get(s);if(void 0===h){if(h=new r(this,i,s,o),l.set(s,h),void 0!==c){const e=new sh(h,this,s,this._model,this._options);c.set(s,e)}n&&s.lastSourceRemoved().subscribe(this,(()=>this._onPriceScaleCleared(s)))}let d=null;return void 0!==c&&(d=(0,a.ensureDefined)(c.get(s))),[h,d]}_onPaneDestroyed(e){e.onDestroyed().unsubscribeAll(this),this._priceAxisViews.delete(e),this._panePriceAxisViews.delete(e),this._startMeasurePriceAxisViews.delete(e),this._endMeasurePriceAxisViews.delete(e)}_onPriceScaleCleared(e){e.lastSourceRemoved().unsubscribeAll(this),this._priceAxisViews.forEach((t=>t.delete(e))),this._panePriceAxisViews.forEach((t=>t.delete(e))),this._startMeasurePriceAxisViews.forEach((t=>t.delete(e))),this._endMeasurePriceAxisViews.forEach((t=>t.delete(e)))}_tryToUpdateViews(e,t,i){return!!this._tryToUpdateData(e,t,i)&&(this.updateAllViews((0,Ds.sourceChangeEvent)(this.id())),this._movedDelegate.fire({index:this.index,price:this.price}),!0)}_tryToUpdateData(e,t,i){const s=this.x,o=this.y,r=this.price,n=this.index,l=this.pane,c=this._priceScaleByPane(i);if(this.index=e,this.x=isNaN(e)?NaN:this._model.timeScale().indexToCoordinate(e),null!==c&&null!==i){this.pane=i,this.price=t;const e=(0,a.ensureNotNull)(i.mainDataSource()).firstValue();this.y=null===e?NaN:c.priceToCoordinate(t,e)}else this.pane=null,this.price=NaN,this.y=NaN;return s!==this.x||o!==this.y||n!==this.index||r!==this.price||l!==this.pane}_priceScaleByPane(e){return e&&!e.defaultPriceScale().isEmpty()?e.defaultPriceScale():null}_setSelectPointModeState(e){e===D.SelectPointMode.None&&(this._requestPointParams?.pane&&this._model.panesCollectionChanged().unsubscribe(this,this._paneCollectionChanged),this._requestPointParams=null),D.activePointSelectionMode.setValue(e),this._crossHairSelectPointMode.setValue(e),this._model.lightUpdate()}_paneCollectionChanged(e){const t=this.paneForPointSelect();null!==t&&-1===e.indexOf(t)&&this.cancelRequestSelectPoint()}_updateVisibilityDependentPaneViews(){for(const e of this.model().panes())this._pointSelectionPaneViewCache.get(e)?.update()}_getLockData(){if(null===this._lockData){const e=D.crosshairLock.value();if(null===e)this._lockData={};else{
const t=this._model.timeScale(),i=t.points().roughIndex(e.time)??void 0,s=void 0===i?void 0:t.indexToCoordinate(i);switch(e.type){case 0:this._lockData={index:i,xCoord:s};break;case 1:{let t;const o=this.lockedPane();if(null!==o){const i=o.mainDataSource();if(null!==i){const s=i.firstValue(),o=i.priceScale();null!==o&&null!==s&&(t=o.priceToCoordinate(e.price,s))}}this._lockData={index:i,xCoord:s,yCoord:t}}}}}return this._lockData}_createMeasurePointsetWithNormalizedPoints(e){const t=this._model.mainSeries().seriesSource().symbolInstanceId();if(null===t)return;this._removeMeasurePointset(),++Kh,this._currentMeasurePointsetAndSymbolId={measurePointsetId:Kh,symbolId:t},this._normalizedMeasurePoints=e;const i=(0,Fh.getServerInterval)(this._model.mainSeries().interval());this._model.chartApi().createPointset(this._currentMeasurePointsetIdWithPrefix(),"turnaround",this._currentMeasurePointsetAndSymbolId.symbolId,i,e,this._onPointsetResponse.bind(this))}_createMeasurePointset(e,t){const i=this._normalizePoint(e),s=this._normalizePoint(t),o=[[i.time_t,i.offset],[s.time_t,s.offset]];this._createMeasurePointsetWithNormalizedPoints(o)}_removeMeasurePointset(){null!==this._currentMeasurePointsetAndSymbolId&&this._model.chartApi().isConnected().value()&&this._model.chartApi().removePointset(this._currentMeasurePointsetIdWithPrefix()),this._currentMeasurePointsetAndSymbolId=null,this._normalizedMeasurePoints=null}_currentMeasurePointsetIdWithPrefix(){return"pointsetMeasure_"+(0,a.ensureNotNull)(this._currentMeasurePointsetAndSymbolId).measurePointsetId}_normalizePoint(e){return{...this._model.timeScale().normalizeBarIndex(e.index),price:e.price}}_onPointsetResponse(e){if("pointset_error"===e.method)return void Zh.logError(`Error getting pointset: ${e.params[0]} ${e.params[1]}`);if(e.params.customId!==this._currentMeasurePointsetIdWithPrefix())return;if(null===this._startMeasurePoint||null===this._endMeasurePoint)return;const t=e.params.plots;if(2!==t.length)return;const i=t[0].value[0],s=t[1].value[0];this._startMeasurePoint.index=i,this._endMeasurePoint.index=s,this.updateAllViews((0,Ds.sourceChangeEvent)(this.id())),this._model.updateSource(this)}}var Xh=i(781680),Jh=i(144776),Qh=i(15113),ed=i(575510),td=i(86304);const id=(0,l.getLogger)("Chart.Studies.StudyInserter"),sd=/^PUB;.*/;class od{constructor(e,t){this._parentSources=[],this._propsState=void 0,this._preferredPriceScale=void 0,this._allowChangeCurrency=!1,this._allowChangeUnit=!0,this._allowChangeMetric=!0,this._paneSize=void 0,this._forceOverlay=!1,this._inserterImpl=t,this._studyDescriptor=e}setParentSources(e){this._parentSources=e}setPaneSize(e){this._paneSize=e}setPreferredPriceScale(e){this._preferredPriceScale=e}setAllowChangeCurrency(e){this._allowChangeCurrency=e}setAllowChangeUnit(e){this._allowChangeUnit=e}setAllowChangeMetric(e){this._allowChangeMetric=e}setForceOverlay(e){this._forceOverlay=e}setPropertiesState(e){this._propsState=e}setTargetPriceScaleMode(e){this._targetPriceScaleMode=e}setEventSource(e){this._eventSource=e}async insert(e,t,i){let s=null
;var r;i||(s=void 0!==(r=this._inserterImpl).createStub&&void 0!==r.removeStub?this._inserterImpl.createStub():null);const a=(e,t)=>{if(i){const s=(0,o.default)(e)?{error:e}:{error:e.message,editorError:e};i.setStatus({type:Ka.StudyStatusType.Error,errorDescription:s}),t&&i.setMetaInfo(t),this._inserterImpl.storeFailedStub(i)}};let l,c,h,d=!0;try{l=await(0,Qe.studyMetaInfoRepository)().findById(this._studyDescriptor)}catch(e){id.logWarn(`Cannot get study ${JSON.stringify(this._studyDescriptor)}`);const t=this._studyDescriptor.pineId,s=sd.test(t),r="Error: cannot compile script";let n=!1;if(!(e instanceof ed.PineCompileFailErrorImpl))return a(r),Promise.reject(td.InsertionErrorCode.CannotGetMetainfo);i?.getDescriptor()?.isOverlay&&(this._forceOverlay=!0),l=new et.StudyMetaInfo(e.metaInfo),(0,o.default)(e.reason)||!e.reason.errors.length?c=[{message:r}]:(n=!0,c=e.reason.errors),s&&n&&(h=td.InsertionErrorCode.CannotCompilePub)}finally{null!==s&&(d=this._inserterImpl.removeStub(s))}if(!d)return Promise.reject(td.InsertionErrorCode.StubWasRemoved);if(void 0!==t&&t.cancelled)return Promise.reject(td.InsertionErrorCode.Cancelled);if(!this._canApplyStudyToParent(l))return a("Error: cannot be child"),Promise.reject(td.InsertionErrorCode.StudyCannotBeChild);const u={...l.defaults.inputs};let _={};if(void 0!==e){const t=et.StudyMetaInfo.getStudyPropertyRootName(l),i=(0,n.clone)((0,En.defaults)(t));(0,n.merge)(u,i.inputs);const s=await e(u,l.inputs,l);_=s.inputs,this._parentSources=s.parentSources??[]}if(void 0!==t&&t.cancelled)return Promise.reject(td.InsertionErrorCode.Cancelled);const p=this._insertStudy(l,_,i);if(null===p)return a("Error: unknown error"),Promise.reject(td.InsertionErrorCode.Unknown);await p.startPromise;const m=await p.study;return c&&m.setErrorCompilation(c),h?Promise.reject(h):m}_insertStudy(e,t,i){return this._inserterImpl.createStudy({studyMetaInfo:e,inputs:t,targetZOrder:null,stubToReplace:i,propsState:this._propsState,forceOverlay:this._forceOverlay,parentSources:this._parentSources,preferredPriceScale:this._preferredPriceScale,allowChangeCurrency:this._allowChangeCurrency,allowChangeUnit:this._allowChangeUnit,allowChangeMetric:this._allowChangeMetric,paneSize:this._paneSize,targetScaleMode:this._targetPriceScaleMode,eventSource:this._eventSource})}_canApplyStudyToParent(e){return 0===this._parentSources.length||et.StudyMetaInfo.canBeChild(e)}}class rd{constructor(e){this._priceSourceNamesById=new Map,e.forEach((e=>this._priceSourceNamesById.set(e.id,e.name)))}name(e){return this._priceSourceNamesById.get(e)??null}priceSourcesChanged(e){return e.length!==this._priceSourceNamesById.size}}const nd=new P.TranslatedString("remove deselected empty line tools",h.t(null,void 0,i(635496))),ad=(0,d.isFeaturesetEnabled)("auto_enable_symbol_labels"),ld=(0,d.isFeaturesetEnabled)("fix_left_edge"),cd=(0,l.getLogger)("Chart.ChartModel");function hd(e,t){const i=e.indexOf(t);return-1!==i&&(e.splice(i,1),!0)}function dd(e){const t=(0,Ds.crosshairMoveEvent)();for(let i=e.length;i--;){const s=e[i].dataSources()
;for(let e=s.length;e--;)s[e].dataWindowView()?.update(t),s[e].chartFloatingTooltipView?.()?.update(t);const o=e[i].priceDataSources();for(let e=o.length;e--;)o[e].legendView()?.update(t)}}const ud={isSnapshot:!1,readOnly:!1,watermarkEnabled:!0,shiftVisibleRangeOnNewBar:!0,currencyConversionEnabled:!1,unitConversionEnabled:!1,metricConversionEnabled:!1,countdownEnabled:!0,lastPriceAnimationEnabled:!0,onWidget:!1,hideIdeas:!1},_d={throttle:Sn.default,debounce:gn.default},pd=new Map([[di.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction,{timeout:2e3,adapter:"debounce"}],[di.RecalcVisibleRangeStudiesReason.DataUpdate,{timeout:5e3,adapter:"throttle"}],[di.RecalcVisibleRangeStudiesReason.SeriesRestart,{timeout:2e3,adapter:"debounce"}],[di.RecalcVisibleRangeStudiesReason.SeriesCompleted,{timeout:2e3,adapter:"debounce"}],[di.RecalcVisibleRangeStudiesReason.StudyCreation,{timeout:2e3,adapter:"debounce"}]]),md=Array.from(pd.values());function gd(e){return e.reduce(((e,t)=>{if(!(0,Ut.isLineTool)(t)||!t.isSynchronizable())return e;const i=t.linkKey().value();return i?(e[0].add(i),e[1].add(t.toolname),e):e}),[new Set,new Set])}function Sd(e){return e.sourcesByGroup().allWithoutMultipane()}function vd(e){return e.sourcesByGroup().allWithoutMultipaneWithHidden()}class fd{constructor(e){this._onRearrangePanes=new g.Delegate,this._lineToolsGroupModel=new Jl,this._sourcesBeingMoved=[],this._activeItemBeingMoved=null,this._lineBeingEdited=null,this._customSourceBeingMovedHitTestData=null,this._customSourceBeingMoved=null,this._dataSourceCollectionChanged=new g.Delegate,this._sourceProperitesChanged=new g.Delegate,this._sourceZOrderChanged=new g.Delegate,this._symbolSourceResolved=new g.Delegate,this._symbolSourceResolvingActive=new H.WatchedValue(!1),this._adjustForDividendsAvailability=new H.WatchedValue(0),this._adjustForDividendsEnabled=new H.WatchedValue(!1),this._inactivityGapsWatchedValue=null,this._allowedAdjustment=new H.WatchedValue("none"),this._currentTool=D.tool.spawn(),this._linesBeingCreated=[],this._lineCancelled=new g.Delegate,this._phantomSourceContainer=new Mc(this),this._destroyed=!1,this._restoringState=!1,this._isSettingsExternalPosition=!1,this._isTimeScrolling=!1,this._magnet=new Rc,this._scrollingState=null,this._modelIntervals=[],this._rendererOptionsProvider=new kn(this),this._studyInserted=new g.Delegate,this._cachedStudiesMaxOffset=0,this._replayStatus=new H.WatchedValue(0),this._panes=[],this._maximizedPane=new H.WatchedValue(null),this._tagsChanged=new g.Delegate,this._strategySources=[],this._strategySourcesChange=new g.Delegate,this._activeStrategySource=new H.WatchedValue(null),this._symbolIntervalChanged=new g.Delegate,this._paneCollapsingAvailable=new H.WatchedValue(!1),this._panesCollectionChanged=new g.Delegate,this._scrollEnabled=(0,d.isFeaturesetEnabled)("chart_scroll"),this._zoomEnabled=(0,d.isFeaturesetEnabled)("chart_zoom"),this._lollipopSourcesWatcher=null,this._alertsWatcher=null,this._hoveredSource=null,this._hoveredSourceChanged=new g.Delegate,this._lastHoveredHittestData=null,
this._hoveredSourceOrigin=null,this._lastSelectedHittestData=null,this._topmostCustomSources=[],this._fgCustomSources=[],this._bgCustomSources=[],this._allCustomSources=[],this._customSourcesMap=new Map,this._dragExportEnabled=new H.WatchedValue(!1),this._multiPaneSources=[],this._showLegendProperty=new Ct.Property,this._id=(0,ot.guid)(),this._chartSaveTime=null,this._availableCurrenciesList=null,this._availableCurrencies=new Cc([]),this._availablePriceSources=new rd([]),this._availableUnitsObject=null,this._availableUnits=new Tc({}),this._allAvailableMetricsList=null,this._availablePriceSourcesBySymbol=new Map,this._shouldBeSavedEvenIfHidden=!1,this._watchedThemeSpawn=A.watchedTheme.spawn(),this._backgroundColorAtYPercentFromTop=new bc.GradientColorCache,this._studiesWV=new z.WatchedObject([],J.compareTwoCollectionsByIds),this._studiesExcludeInternalWV=new z.WatchedObject([],J.compareTwoCollectionsByIds),this._resetScalesAvailable=new H.WatchedValue(!1),this._recalcVRStudiesParams={reasons:new Set},this._recalcColorStudiesParams={},this._replayStudyStrategy=new H.WatchedValue(null),this._studyColorRotatorFactory=new Mn(this),this._mainSeriesScaleRatioProperty=new Sa(this),this._abortController=new AbortController,this._recalcVisibleRangeStudiesImplDebouncedByAdapter=new Map(Object.keys(_d).map((e=>[e,new Map(md.filter((t=>t.adapter===e)).map((e=>[e.timeout,_d[e.adapter](this._recalcVisibleRangeStudiesImpl.bind(this,this._recalcVRStudiesParams),e.timeout)])))]))),this._recalcColorStudiesImplDebounced=(0,gn.default)(this._recalcColorStudiesImpl.bind(this,this._recalcColorStudiesParams),250),this._width=0,this._resetScales=new g.Delegate,this._chartThemeLoaded=new g.Delegate,this._selection=new In,this._selectedSourceChanged=new g.Delegate,this._symbolSourceCollectionChanged=new g.Delegate,this._gridSource=new zc(this),this._visibleRangeStudiesInputs=new z.WatchedObject(null),this._syncPointCache=new Map,this._lastAppliedGotoTimeRange=null,this._lastGotoTimeRange=null,this._alertsCollection=new H.WatchedValue(null),this._lollipopSourcesWatcherLoader=null,this._sessions=null,this._onMultipaneSourcesCollectionChanged=new g.Delegate,this._replayStudyStrategyInputs=null,this._studyShiftColorStartOffset=void 0,this._lineToolsSyncBlock=0,this._onDestroyed=new g.Delegate,this._clearSelection=()=>{this._lastSelectedHittestData=null,this._selection.clear()},this._removeSourceFromSelection=e=>{this._selection.remove(e)},this._addSourceToSelection=(e,t)=>{const i=this._selection.isSelected(e);i&&this._lastSelectedHittestData===t||e&&!e.isSelectionEnabled()||(this._lastSelectedHittestData=t||null,i||this._selection.add(e),(0,Nt.isStudyStrategy)(e)&&this.setActiveStrategySource(e))},this._recalcSymbolResolvingActive=()=>{for(const e of this._panes)if(e.symbolSourceResolvingActive().value())return void this._symbolSourceResolvingActive.setValue(!0);this._symbolSourceResolvingActive.setValue(!1)},this._recalcAdjustForDividendsAvailability=()=>{if(this._symbolSourceResolvingActive.value())return;const e=this.mainSeries()
;switch(e.symbolInfo()?.allowed_adjustment??"none"){case"dividends":return void this._adjustForDividendsAvailability.setValue(2);case"splits":return void this._adjustForDividendsAvailability.setValue(1);case"any":return void this._adjustForDividendsAvailability.setValue(3)}for(const t of this.symbolSources().filter(So.isActingAsSymbolSource)){if(t.symbolHibernated().value()||t===e)continue;if("any"===(t.symbolInfo()?.allowed_adjustment??"none"))return void this._adjustForDividendsAvailability.setValue(3)}this._adjustForDividendsAvailability.setValue(0)},this._recalcAllowedAdjustment=()=>{const e=this.mainSeries(),t=e.symbolInfo()?.allowed_adjustment??"none";if("dividends"===t||"splits"===t)return void this._allowedAdjustment.setValue(t);let i="none";for(const e of this.symbolSources().filter(So.isActingAsSymbolSource)){if(e.symbolHibernated().value())continue;const t=e.symbolInfo()?.allowed_adjustment??"none";if("any"===t)return void this._allowedAdjustment.setValue("any");"splits"===t&&"dividends"!==i&&(i="splits"),"dividends"===t&&(i="dividends")}this._allowedAdjustment.setValue(i)},this._recalcAdjustForDividendsEnabled=()=>{switch(this._adjustForDividendsAvailability.value()){case 2:return void this._adjustForDividendsEnabled.setValue(!0);case 0:case 1:return void this._adjustForDividendsEnabled.setValue(!1)}this._adjustForDividendsEnabled.setValue((0,a.ensureDefined)(this.mainSeries().properties().childs().dividendsAdjustment).value())},this._recalcPaneCollapsingAvailable=e=>{let t=this._panes.filter((e=>!e.collapsed().value())).length;0===t&&e&&this._panes.length>0&&(this._panes[0].collapsed().setValue(!1),t=1),this._paneCollapsingAvailable.setValue(t>1)},this._updateResetScalesAvailableValue=()=>{const e=this._timeScale.resetAvailable().value()||this._panes.some((e=>e.resetPriceScalesAvailable().value()));this._resetScalesAvailable.setValue(e)},this._onDrawingsVisibilityChanged=e=>{const t=!e.value();for(const e of this.dataSources()){const i=(0,Ut.isLineTool)(e)&&e.properties().visible.value();t&&i?(0,N.emit)("drawing_event",e.id(),"show"):!t&&i&&(0,N.emit)("drawing_event",e.id(),"hide")}this.selectionMacro((e=>e.clearSelection()))},this._onIndicatorsVisibilityChanged=()=>{this.allStudies().some((e=>e.canBeHiddenByGlobalFlag()&&e.properties().childs().visible.value()&&this.selection().isSelected(e)))?this.selectionMacro((e=>e.clearSelection())):this.lightUpdate()};const{chartSession:t,invalidateHandler:i,properties:s,seriesProperties:o,dataRequest:r,undoModel:l,barsMarksContainersFactory:c,options:h,hibernateVW:u,linkingGroupWV:_,isAutoSaveEnabled:p,symbolAliasService:m,drawTime:S}=e;this._availableMetrics=new xc([]),this._chartSession=t,this._invalidateHandler=i,this._undoModel=l,this._properties=s,this._options=(0,n.merge)((0,n.clone)(ud),h),this._hibernateWV=u,this._linkingGroupIndex=_,this._isAutoSaveEnabled=p,this._readOnly=this._options.readOnly,this._isSnapshot=this._options.isSnapshot,this._symbolAliasService=m,this._symbolAliasService?.onAliasChanged().subscribe(this,(()=>this.lightUpdate())),
this._drawTime=S,this._alertsWatcher=new nc(this),this.onWidget()||sc.withWeekdayProperty.subscribe(this,(()=>this._updateDateTimeFormatter())),this._chartSaveTime=(new Date).valueOf(),this._backgroundColor=new H.WatchedValue(this._getBackgroundColor()),this._backgroundTopColor=new H.WatchedValue(this._getBackgroundColor(!0)),this._properties.childs().paneProperties.childs().background.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundType.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundGradientStartColor.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().backgroundGradientEndColor.subscribe(this,this._updateBackgroundColor),this._properties.childs().paneProperties.childs().legendProperties.childs().showLegend.subscribe(this,this._updateShowLegendProperty),this._properties.childs().scalesProperties.subscribe(this,this.fullUpdate),this._backgroundColor.subscribe(this.recalcColorStudies.bind(this,!1)),this._backgroundTopColor.subscribe(this.recalcColorStudies.bind(this,!1)),this._backgroundCounterColor=new H.WatchedValue(this._getBackgroundCounterColor()),this._backgroundColor.subscribe((()=>this._backgroundCounterColor.setValue(this._getBackgroundCounterColor()))),this._backgroundTheme=(0,F.combine)((e=>"white"===e?vn.StdTheme.Dark:vn.StdTheme.Light),this._backgroundCounterColor.weakReference()),this._isDark=(0,F.combine)((e=>e===vn.StdTheme.Dark),this._backgroundTheme.weakReference()),this._watchedThemeSpawn.subscribe(this._updateBackgroundColor.bind(this)),this._symbolSourceResolvingActive.subscribe((()=>{this._recalcAdjustForDividendsAvailability(),this._recalcAllowedAdjustment()})),(0,D.init)();const v=this._readOnly?new Ct.Property((0,n.merge)((0,n.clone)(ut.lightTheme.content.chartProperties.paneProperties.crossHairProperties),(0,En.defaults)("chartproperties.paneProperties.crossHairProperties"))):this._properties.childs().paneProperties.childs().crossHairProperties;this._crossHairSource=new Yh(this,v,this._options.crossHair),this._crossHairSelectPointMode=this._crossHairSource.selectPointMode().spawn(),this._crossHairSelectPointMode.subscribe((e=>{if(e!==D.SelectPointMode.None&&this.lineBeingCreated()){const e=D.tool.value();this.cancelCreatingLine(),D.tool.setValue(e)}})),this._tagsChanged=new g.Delegate;const f={countdownEnabled:this._options.countdownEnabled,lastPriceAnimationEnabled:this._options.lastPriceAnimationEnabled};this._mainSeries=new Es.Series(this,o,f,r),this._timeScale=new Kl(this,this._options.timeScale),this._timeScale.resetAvailable().subscribe(this._updateResetScalesAvailableValue),this._appliedTimeFrame=new Vc(this),this._mainSeries.onStyleChanged().subscribe(this._timeScale,this._timeScale.invalidateVisibleBars);const b=()=>this.fullUpdate();this._mainSeries.properties().childs().showCountdown.subscribe(this,(()=>{this._mainSeries.updateAllViews((0,Ds.sourceChangeEvent)(this._mainSeries.id())),b()})),(0,
zi.currencyUnitMetricVisibilityProperty)().subscribe(this,b),(0,Hi.autoLogButtonsVisibilityProperty)().subscribe(this,b),this._timeScale.visibleBarsStrictRangeChanged().subscribe(this._mainSeries,this._mainSeries.clearHighLowPriceCache),this._timeScale.visibleBarsStrictRangeChanged().subscribe(this._mainSeries,this._mainSeries.clearAveragePriceCache),this.createPane(void 0,{axisProperties:o.childs().priceAxisProperties.state(["autoScale"])}),this._adjustForDividendsAvailability.subscribe(this._recalcAdjustForDividendsEnabled),(0,a.ensureDefined)(this.mainSeries().properties().childs().dividendsAdjustment).subscribe(this,this._recalcAdjustForDividendsEnabled),this._recalcAdjustForDividendsEnabled(),this._boundUpdateStudiesMaxOffset=this._updateStudiesMaxOffset.bind(this),this.mainSeries().dataEvents().seriesTimeFrame().subscribe(this,((e,t,i,s)=>{if(null!==this._lastAppliedGotoTimeRange&&null!==i&&s&&(0,ho.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,i)){const e=this.appliedTimeFrame().value();null!==e&&!this._lastAppliedGotoTimeRange.actual&&(0,ho.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,e.val)&&this.appliedTimeFrame().setValue(null),this._lastAppliedGotoTimeRange=null}})),this.mainSeries().dataEvents().completed().subscribe(this,(e=>{null===this._lastAppliedGotoTimeRange&&null!==this._lastGotoTimeRange&&this.gotoTimeRange(this._lastGotoTimeRange.from,this._lastGotoTimeRange.to,this._lastGotoTimeRange)}));const y=this._panes[0];y.setStretchFactor(2*y.stretchFactor()),this._properties.subscribe(this,this.lightUpdate),this._properties.childs().timezone.subscribe(null,(()=>{this._chartSession&&this._chartSession.isConnected().value()&&this._chartSession.switchTimezone(this.timezone())})),y.addDataSource(this._mainSeries,y.findSuitableScale(this._mainSeries),!1),this._barsMarksSources=c(this);for(const e of this._barsMarksSources)e.setOwnerSource(this._mainSeries),y.addDataSource(e,this._mainSeries.priceScale(),!0);if(this._mainSeries.symbolResolved().subscribe(this,this._clearAvailablePriceSources),this._mainSeries.onSymbolIntervalChanged().subscribe(this,this._onSymbolIntervalChanged),this._createLollipopSourcesWatcher(),this._watermarkSource=this._options.watermarkEnabled?new pa(this):null,this._timezoneExceptExchange=(0,F.combine)(((e,t)=>"exchange"!==e?e:t),(0,Hl.createWVFromProperty)(this._properties.childs().timezone).ownership(),(0,Hl.createWVFromGetterAndSubscription)((()=>this.mainSeries().symbolInfo()?.timezone??null),this.mainSeries().symbolResolved()).ownership()),this._updateDateTimeFormatter(),this.onWidget()||this._initAlertsList(),this._mainSeries.dataEvents().completed().subscribe(this,(()=>{if(this._scrollingState&&this.gotoTime(void 0,{targetPointAlignment:this._scrollingState.targetPointAlignment,autoscaleAfterScroll:this._scrollingState.autoscaleAfterScroll}),ld&&!this._mainSeries.requestMoreDataAvailable()){const e=this._mainSeries.bars().first();null!==e&&this._timeScale.setLeftEdgeFix(e.index)}})),this._mainSeries.onIntervalChanged().subscribe(this,(()=>{
this._recalcVRStudiesParams.oldStartVisibleIndex=NaN,this._recalcVRStudiesParams.oldEndVisibleIndex=NaN})),this._mainSeries.dataEvents().barReceived().subscribe(this,this.updateTimeScaleBaseIndex),!this._readOnly){this._mainSeries.properties().addChild("priceAxisProperties",this._mainSeries.priceScale().properties());const e=this._properties.childs().paneProperties.childs().legendProperties.childs();e.showStudyTitles.subscribe(this,(t=>{t.value()||e.showStudyArguments.setValue(!1)}))}this._mainSeries.properties().childs().interval.subscribe(this,this._updateDateTimeFormatter),this._mainSeries.onTimeFrameApplied().subscribe(this,(e=>{const t=e?{res:this._mainSeries.interval(),val:e}:null;this.appliedTimeFrame().setValue(t)})),this._maximizedPane.subscribe((()=>l.model().fullUpdate())),this._dataSourceCollectionChanged.subscribe(this,this._updateShowLegendProperty),(0,D.hideAllDrawings)().subscribe(this,this._onDrawingsVisibilityChanged),(0,D.hideAllIndicators)().subscribe(this,this._onIndicatorsVisibilityChanged),Xl.dateFormatProperty.subscribe(this,this._updateDateTimeFormatter),fl.timeHoursFormatProperty.subscribe(this,this._updateDateTimeFormatter),this._currentTool.subscribe((e=>{(0,se.isLineToolName)(e)&&this.selectionMacro((e=>{e.clearSelection()})),!(0,pi.isLineToolLoaded)(e)&&(0,pi.isAsyncGenericLineToolName)(e)?(0,pi.loadLineTool)(e).then((()=>this._phantomSourceContainer.onToolChanged())):this._phantomSourceContainer.onToolChanged()})),this._signatureSources=this._studiesExcludeInternalWV.spawn();const w=(0,F.combine)((e=>e.map((e=>e.signature().weakReference()))),this._signatureSources.weakReference());this._sourcesSignatures=(0,F.accumulate)((e=>e.filter(n.notNull)),w.ownership())}destroy(){this._abortController.abort(),this.clearIntervals(),this.resetDeferredStudies(),this._symbolAliasService?.onAliasChanged().unsubscribeAll(this),this.allStudies().forEach((e=>this.removeSource(e))),Xl.dateFormatProperty.unsubscribe(this,this._updateDateTimeFormatter),fl.timeHoursFormatProperty.unsubscribe(this,this._updateDateTimeFormatter),(0,D.hideAllIndicators)().unsubscribe(this,this._onIndicatorsVisibilityChanged),(0,D.hideAllDrawings)().unsubscribe(this,this._onDrawingsVisibilityChanged),this._dataSourceCollectionChanged.unsubscribeAll(this),this._phantomSourceContainer.destroy(),this._hoveredSourceChanged.destroy(),null!==this._watermarkSource&&(this._watermarkSource.destroy(),this._watermarkSource=null),Array.from(this._customSourcesMap.keys()).forEach(this._removeCustomSource,this),(0,a.assert)(0===this._topmostCustomSources.length),(0,a.assert)(0===this._fgCustomSources.length),(0,a.assert)(0===this._bgCustomSources.length),(0,a.assert)(0===this._allCustomSources.length),(0,a.assert)(0===this._customSourcesMap.size),this._panes.forEach((e=>e.destroy())),this._panes.length=0,this._sessions=null,null!==this._lollipopSourcesWatcher&&(this._lollipopSourcesWatcher.destroy(),this._lollipopSourcesWatcher=null),null!==this._alertsWatcher&&this._alertsWatcher.destroy(),
this.onWidget()||sc.withWeekdayProperty.unsubscribeAll(this),this._properties.childs().paneProperties.childs().legendProperties.childs().showLegend.unsubscribeAll(this),this._properties.childs().paneProperties.childs().background.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundType.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundGradientEndColor.unsubscribeAll(this),this._properties.childs().paneProperties.childs().backgroundGradientStartColor.unsubscribeAll(this),this._watchedThemeSpawn.destroy(),this._lastHoveredHittestData=null,this._lastSelectedHittestData=null,(0,zi.currencyUnitMetricVisibilityProperty)().unsubscribeAll(this),(0,Hi.autoLogButtonsVisibilityProperty)().unsubscribeAll(this),this._mainSeries.properties().childs().interval.unsubscribe(this,this._updateDateTimeFormatter),this._mainSeries.properties().childs().showCountdown.unsubscribeAll(this),this._alertsCollection.value()?.destroy(),this._alertsCollection.setValue(null),window.loginStateChange.unsubscribeAll(this),this._crossHairSelectPointMode.destroy(),this._mainSeries.onIntervalChanged().unsubscribeAll(this),this._mainSeries.onTimeFrameApplied().unsubscribeAll(this),this._mainSeries.symbolResolved().unsubscribe(this,this._clearAvailablePriceSources),this._mainSeries.onSymbolIntervalChanged().unsubscribe(this,this._onSymbolIntervalChanged),this._mainSeries.onStyleChanged().unsubscribe(this._timeScale,this._timeScale.invalidateVisibleBars),this._timeScale.visibleBarsStrictRangeChanged().unsubscribe(this._mainSeries,this._mainSeries.clearHighLowPriceCache),this._timeScale.visibleBarsStrictRangeChanged().unsubscribe(this._mainSeries,this._mainSeries.clearAveragePriceCache),this._timeScale.barSpacingChanged().unsubscribeAll(this),this._timeScale.onScroll().unsubscribeAll(this),this._timeScale.destroy(),this._timezoneExceptExchange.destroy(),this._lollipopSourcesWatcherLoader?.destroy(),this._appliedTimeFrame.destroy(),this._crossHairSource.destroy(),this._currentTool.destroy(),this._signatureSources.destroy(),this._sourcesSignatures.destroy(),this._onDestroyed.fire(),this._onDestroyed.destroy(),this._destroyed=!0}onDestroyed(){return this._onDestroyed}restart(){this._chartSession.switchTimezone(this.timezone()),this._timeScale.reset(),this._mainSeries.restart();for(const e of this.dataSources())e.restart&&e!==this._mainSeries&&e.restart();this._sessions?.get()?.restart()}version(){return 3}collapsed(){return this._hibernateWV}visibleRangeStudiesInputs(){return this._visibleRangeStudiesInputs.readonly()}chartSaveTime(){return this._chartSaveTime}setChartSaveTime(e){this._chartSaveTime=e}startNotStartedStudies(){if(!this._mainSeries.isStarted())throw new Error("Cannot start studies: main series is not started");for(const e of this.dataSources())(0,Nt.isStudy)(e)&&!e.isStarted()&&e.restart?.()}undoModel(){return this._undoModel}onData(e){switch(e.method){case"timescale_update":{const t=e.params;this._updateTimeScale({index:t.index,zoffset:t.zoffset,values:t.changes,indexDiffs:t.index_diff,
baseIndex:t.baseIndex,marks:t.marks,clearFlag:t.clear,clearTickMarks:t.clearTickMarks});break}case"timescale_completed":{const t=Boolean(e.params[0]);this._timeScale.onTimeScaleCompleted(t);break}}}addStrategySource(e,t){1!==t&&-1===this._strategySources.indexOf(e)&&(this._strategySources.push(e),this._strategySourcesChange.fire(t),this.setActiveStrategySource(e))}removeStrategySource(e,t){if(1===t)return;const i=this._strategySources.indexOf(e);if(-1!==i){if(this._strategySources.splice(i,1)[0]===this._activeStrategySource.value()&&this.unsetActiveStrategySource(),this._strategySources.length>0){const e=this._strategySources[this._strategySources.length-1];this.setActiveStrategySource(e)}this._strategySourcesChange.fire(t)}}setActiveStrategySource(e){-1!==this._strategySources.indexOf(e)&&this._activeStrategySource.setValue(e)}unsetActiveStrategySource(){this._activeStrategySource.setValue(null)}activeStrategySource(){return this._activeStrategySource.readonly()}strategySources(){return this._strategySources}strategySourcesChange(){return this._strategySourcesChange}replayStudyStrategy(){return this._replayStudyStrategy}setReplayStudyStrategy(e){this._replayStudyStrategy.setValue(e)}async replayStudyStrategyProperties(){if(null===this._replayStudyStrategyInputs){const e=await(0,lc.getReplayStrategyMetaInfo)();if(null!==this._replayStudyStrategyInputs)return this._replayStudyStrategyInputs;this._replayStudyStrategyInputs=new br.DefaultProperty({defaultName:"replayStudyStrategyInputs",factoryDefaultsSupplier:()=>(0,n.clone)(e.defaults.inputs)})}return this._replayStudyStrategyInputs}clearReplayStudyStrategyProperties(){this._replayStudyStrategyInputs=null}setScrollEnabled(e){this._scrollEnabled=e}scrollEnabled(){return this._scrollEnabled}setZoomEnabled(e){this._zoomEnabled=e}zoomEnabled(){return this._zoomEnabled}dragExportEnabled(){return this._dragExportEnabled}async setDragExportEnabled(e){console.error("feature is not enabled")}zoomToViewport(e,t,i,s,o){this.setTimeViewport(e,t);let r=Math.min(i,s),n=Math.max(i,s);const a=o.defaultPriceScale();a.isPercentage()||a.setMode({autoScale:!1}),a.isLog()&&(r=a.priceToLogical(r),n=a.priceToLogical(n)),a.setPriceRange(new Ea.PriceRange(r,n)),this.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this.invalidate(this._paneInvalidationMask(o,ve.InvalidationLevel.Light))}setTimeViewport(e,t){const i=this.appliedTimeFrame().value();null!==this._lastAppliedGotoTimeRange&&null!==i&&(0,ho.areEqualTimeFrames)(this._lastAppliedGotoTimeRange.range,i.val)&&!this._lastAppliedGotoTimeRange.actual||(this.timeScale().zoomToBarsRange(e,t),this.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this.recalcVisibleRangeStudies(di.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction),this.lightUpdate())}onTagsChanged(){return this._tagsChanged}canZoomIn(){return this._timeScale.canZoomIn()&&this._zoomEnabled}canZoomOut(){return this._timeScale.canZoomOut()&&this._zoomEnabled}onPaneTagsChanged(){this._tagsChanged.fire()}panesCollectionChanged(){return this._panesCollectionChanged}
dataSourceCollectionChanged(){return this._dataSourceCollectionChanged}symbolSourceCollectionChanged(){return this._symbolSourceCollectionChanged}symbolSourceResolved(){return this._symbolSourceResolved}symbolSourceResolvingActive(){return this._symbolSourceResolvingActive}adjustForDividendsAvailability(){return this._adjustForDividendsAvailability}adjustForDividendsEnabled(){return this._adjustForDividendsEnabled}allowedAdjustment(){return this._allowedAdjustment}paneCollapsingAvailable(){return this._paneCollapsingAvailable}sourcePropertiesChanged(){return this._sourceProperitesChanged}sourceZOrderChanged(){return this._sourceZOrderChanged}zoomTime(e,t,i){if(!this._zoomEnabled)return;const s=this.timeScale();if(s.isEmpty()||0===t)return;const o=s.width();e=Math.max(1,Math.min(e,o-2)),s.zoom(e,t,i),this.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this.lightUpdate(),this.recalcVisibleRangeStudies(di.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction)}lineBeingEdited(){return this._lineBeingEdited?.lineDataSource??null}linePointBeingEdited(){return this._lineBeingEdited?.pointIndex??null}linePointBeingChanged(){return this._lineBeingEdited?.startChangingPoint??null}activeItemBeingMoved(){return this._activeItemBeingMoved}mainSeries(){return this._mainSeries}updateAllPaneViews(e){for(const t of this._panes)t.updateAllViews(e);this._watermarkSource?.updateAllViews(e)}dataSources(){const e=[this.crosshairSource()];for(const t of this._panes)for(const i of t.dataSources())e.push(i);return e}priceDataSources(){const e=[];for(const t of this._panes)for(const i of t.priceDataSources())e.push(i);return e}symbolSources(){const e=[];for(const t of this._panes)for(const i of t.symbolSources())e.push(i);return e}orderedDataSources(e){let t=[this._crossHairSource];for(let i=0;i<this._panes.length;i++){let s=this._panes[i].sourcesByGroup().all();e&&(s=s.slice().reverse()),t=t.concat(s)}return t}lineToolByLinkKey(e){for(const t of this._panes){const i=t.lineToolByLinkKey(e);if(i)return i}return null}timeScale(){return this._timeScale}selection(){return this._selection}selectionMacro(e,t=!1){const i=this.selection().allSources();e({removeSourceFromSelection:this._removeSourceFromSelection,addSourceToSelection:this._addSourceToSelection,clearSelection:this._clearSelection,selectionOperationAvailable:this._selectionOperationAvailable.bind(this),selection:this.selection.bind(this)});const s=(0,J.subtract)(i,this.selection().allSources()),o=(0,J.subtract)(this.selection().allSources(),i);o.concat(i).forEach((e=>e.updateAllViews((0,Ds.selectionChangeEvent)())));let r=[];if(s.forEach((e=>{(0,Ut.isLineTool)(e)&&!t&&((0,Ut.isEditableTextLineTool)(e)&&e.deactivateTextEditing(),e.shouldBeRemovedOnDeselect()&&r.push(e))})),1===o.length){const[e]=o;(0,Ut.isLineTool)(e)&&e.hasAlert().value()&&0===e.alertStatus().value()&&e.synchronizeAlert().catch((()=>{}))}r=r.filter((e=>null!==this.dataSourceForId(e.id()))),r.length>0&&this._undoModel.removeSources(r,!1,nd),this.lightUpdate(),
(s.length>0||o.length>0)&&this._selectedSourceChanged.fire()}onSelectedSourceChanged(){return this._selectedSourceChanged}checkLineToolSelection(){const e=this.selection().allSources();this._selection.checkLineToolSelection(),e.length!==this.selection().allSources().length&&this._selectedSourceChanged.fire()}lineToolsGroupModel(){return this._lineToolsGroupModel}restoreLineToolsGroups(e){this._lineToolsGroupModel=Jl.fromState(this,e)}realignLineTools(e){for(const t of this._panes)(void 0===e||t.hasDataSource(e))&&t.realignLineTools(e)&&this._dataSourceCollectionChanged.fire(t)}copyToOtherCharts(e,t){const i=this.mainSeries(),s=i.syncModel(),o=this.timeScale();if(s)for(const r of e){if(!r.isSynchronizable())continue;const e=r.linkKey().value()||(0,ot.randomHash)();r.linkKey().setValue(e);const n=r.state(!1),l=r.normalizedPoints(),c=r.normalizedPointsForCreating(),h=r.properties().interval.value(),d=i.interval(),u=e=>{if($.Interval.isEqual(h,d))return e.map((e=>{const t=(0,a.ensureNotNull)(o.timePointToIndex(e.time_t))+e.offset;return{price:e.price,timeStamp:(0,a.ensureNotNull)(this.externalTimeStamp(t))}}));{const t=s.createNewModelWithResolution(h);return e.map((e=>({price:e.price,timeStamp:0===e.offset?e.time_t:t.projectTime(e.time_t,e.offset)})))}},_=u(l),p=u(c),m={...n,id:r.id(),linkKey:e,points:_,pointsForCreating:p,linetool:r.toolname,model:this,symbol:i.symbol(),withUndo:t,zOrder:r.zorder(),finalState:{points:l,interval:h},pointPositionPercents:r.isFixed()?r.calcPositionPercents():void 0,sharingMode:r.sharingMode().value()};(0,D.copyLineTool)(m)}}isSnapshot(){return this._isSnapshot}onWidget(){return this._options.onWidget}hideIdeas(){return this._options.hideIdeas}updateSource(e){const t=this._invalidationMaskForSource(e);null!==t&&this.invalidate(t)}updateSourcePriceScale(e){const t=this._invalidationMaskForSourcePriceScale(e);null!==t&&this.invalidate(t)}updatePane(e){this.invalidate(this._paneInvalidationMask(e))}updateTimeScaleBaseIndex(e){const t=this.mainSeries().bars(),i=(t.firstIndex()??1/0)<(e?.index??-1/0),s=this._timeScale.baseIndex();if(t.isEmpty()||this._updateBaseIndex((0,a.ensureNotNull)(t.lastIndex()),!!(e&&e.index>0)),i&&!this._timeScale.isBeingScrolled()&&!this._timeScale.isBeingScaled()){const e=this._timeScale.baseIndex()-s,t=this._timeScale.rightOffset();t-this.studyAwareDefaultRightOffset()>e&&this._timeScale.setRightOffset(t-e)}}setInterval(e,t){const i=setInterval(e,t);return this._modelIntervals.push(i),i}clearInterval(e){clearInterval(e);const t=this._modelIntervals.indexOf(e);t>-1&&this._modelIntervals.splice(t,1)}clearIntervals(){for(let e=0;e<this._modelIntervals.length;e++)clearInterval(this._modelIntervals[e]);this._modelIntervals=[]}createStudyInserter(e){return new od(e,{createStudy:e=>this.insertStudyWithParams(e),storeFailedStub:e=>{}})}insertStudyWithParams(e){const{studyMetaInfo:t,inputs:i,targetZOrder:s,propsState:o,forceOverlay:r,parentSources:l,preferredPriceScale:c,allowChangeCurrency:h,allowChangeUnit:d,allowChangeMetric:u,paneSize:_,targetScaleMode:p,id:m}=e
;let g=null;if(!r&&void 0!==t.groupingKey){const e=this.findNonOverlayStudyWithGroupingKey(t.groupingKey);null!==e&&(g=e.pane)}null===g&&(r||t.is_price_study?g=(0,a.ensureNotNull)(this.paneForSource(l?.[0]??this._mainSeries)):(g=this.createPane(),void 0!==_&&g.setPaneSize(_))),"Compare@tv-basicstudies"===t.id&&this._mainSeries.priceScale().setMode({log:!1,percentage:!0});const S=(0,n.merge)((0,an.default)(o??{}),{inputs:i,parentSources:[]});let v=!1,f=null,b=null;const y=l??[],w=(0,An.prepareStudyProperties)(t,S,g,(0,Qe.studyMetaInfoRepository)().studyVersioning(),y),C=(0,Nt.createStudy)(this,w,y,new et.StudyMetaInfo(t.state(),t.useVersionFromMetaInfo),new et.StudyMetaInfo(t.state(),t.useVersionFromMetaInfo),m,void 0),T=(0,gt.createDeferredPromise)();return C.then((e=>{if(v)return e.stop(),void e.destroy?.();f=e.id();const t=g.findSuitableScale(e,l?.[0]??this.mainSeries(),c);if(b=t.mode(),t===this.mainSeries().priceScale()&&(0,So.isSymbolSource)(e)){const i=h?vo(e,t,this,!0):null,s=d?Ra(e,t,this,!0):null,o=u?Ic(e,t,this):null;null===i&&null===s&&null===o||e.setSymbolParams({currency:i??void 0,unit:s??void 0,metric:o??void 0})}if((0,So.isSymbolSource)(e)&&(0,a.ensureNotNull)(g).hasDataSource(this.mainSeries())&&ad&&!R.getBool("enable_symbol_labels_on_inserting_compare_once",!1)&&((0,br.allowSavingDefaults)(!0),this.properties().childs().scalesProperties.childs().showSymbolLabels.setValue(!0),(0,br.allowSavingDefaults)(!1),R.setValue("enable_symbol_labels_on_inserting_compare_once",!0)),T.resolve(e.start()),s&&g.id()===s.paneId)g.insertDataSource(e,t,s.zorder);else{g.addDataSource(e,t,!1);null!==e.preferredZOrder()&&g.insertAfter([e],this.mainSeries())}void 0!==p&&t.setMode(p),e.isLinkedToSeries()&&e.setOwnerSource(this.mainSeries()),this.recalculatePane(g,(0,Ds.sourceChangeEvent)(e.id())),this.fullUpdate(),this._invalidateBarColorerCaches(),this._recalcVisibleRangeStudiesImpl({studies:[e],reasons:new Set([di.RecalcVisibleRangeStudiesReason.StudyCreation])}),this._recalcColorStudiesImpl({studies:[e],force:!0}),this._studyInserted.fire(e),this.alertsWatcher()?.syncSourceAlertLabels(e),e.maxOffset().subscribe(this._boundUpdateStudiesMaxOffset,{callWithLast:!0})})),{study:C,startPromise:T.promise,cancel:()=>v=!0,entityId:()=>f,originalScaleMode:()=>b}}replaceStudyStub(e,t){const i=this.paneForSource(e);if(null===i)return!1;const s=e.priceScale(),o=e.zorder(),r=e.ownerSource();return this.paneForSource(e)===i?i.replaceSource(e,t,s):(i.insertDataSource(t,s,o),this.removeSource(e)),t.setOwnerSource(r),this.dataSources().forEach((i=>{i.ownerSource()===e&&(i.setOwnerSource(t),(0,Ut.isLineTool)(i)&&i.supportsTargetSignature()&&!i.targetSignature().value()&&i.setTargetSignature(t.signature().value()))})),this._invalidateBarColorerCaches(),t.start(),this.recalculatePane(i,(0,Ds.sourceChangeEvent)(t.id())),this.fullUpdate(),!0}insertStudyStub(e,t,i,s){const o=void 0!==t,r=new Ln.StudyStub(this,i??null,e,t,s??null);let n;if(t||!o){n=(0,a.ensureNotNull)(this.mainPane())
;const e=!0===t?this.mainSeries().priceScale():n.createPriceScaleAtPosition("overlay");n.addDataSource(r,e,!1)}else n=this.createPane(),n.addDataSource(r,null,!1);return r.setZorder(n.newStudyZOrder()),this.recalculatePane(n,(0,Ds.sourceChangeEvent)(r.id())),this.fullUpdate(),r}removeStudyStub(e){const t=this.dataSourceForId(e);return null===t?(cd.logNormal("StudyStub id="+e+" is not found in chart model"),!1):(this.removeSource(t),!0)}restoreStudyStub(e){const t=this.insertStudyStub(e.title,e.isOverlay,e.descriptor);return this.paneForSource(t)?.changeSourceId(t,e.id),t.setStatus(e.status),t}bulkActionMacro(e){const t=this._panes;t.forEach((e=>e.beginBulkAction())),e(),t.forEach((e=>e.endBulkAction()))}allLineTools(){return this._getAllSources(Ut.isLineTool)}allLineToolsIncludingHidden(){return this._getAllSources(Ut.isLineTool,vd)}setHoveredSource(e,t=null,i){const s=this._hoveredSource!==e;this._hoveredSourceOrigin=i??null,!s&&(0,hi.hitTestResultDataAreEqual)(this._lastHoveredHittestData,t)||(this._lastHoveredHittestData=t,this._hoveredSource&&(this._hoveredSource.updateAllViews((0,Ds.hoverChangeEvent)()),this.updateSource(this._hoveredSource)),this._hoveredSource=e,this._hoveredSource&&(this._hoveredSource.updateAllViews((0,Ds.hoverChangeEvent)()),this.updateSource(this._hoveredSource)),s&&this._hoveredSourceChanged.fire(e))}properties(){return this._properties}chartApi(){return this._chartSession}disconnect(){this._sessions?.get()?.stop();for(const e of this.dataSources())e.disconnect&&e.disconnect();this._timeScale.disconnect()}crosshairSource(){return this._crossHairSource}gridSource(){return this._gridSource}publishedChartsTimelineSource(){for(const e of this._barsMarksSources)if(e instanceof xe.PublishedChartsTimeline)return e;return null}hoveredSource(){return this._hoveredSource}hoveredSourceOrigin(){return this._hoveredSourceOrigin}hoveredSourceChanged(){return this._hoveredSourceChanged}lastHittestData(){return this._lastHoveredHittestData}lastSelectedHittestData(){return this._lastSelectedHittestData}lightUpdate(){this.invalidate(ve.InvalidationMask.light())}fullUpdate(){this.invalidate(ve.InvalidationMask.full())}drawTime(){return this._drawTime}async syncTimeWithModel(e,t,i){const s=this.mainSeries().syncModel();if(null===s)return;const o=1e3*this.createSyncPoint(e,s.syncSourceTarget()).sourceTimeToTargetTime(t/1e3),r=(0,c.get_timezone)((0,a.ensureNotNull)(this.timezoneExceptExchange().value()));let n=(0,c.utc_to_cal)(r,o);return this.mainSeries().isDWM()&&(n=s.getSession().spec.correctTradingDay(n),(0,c.set_hms)(n,0,0,0,0,(0,c.get_timezone)("Etc/UTC"))),this._gotoTimeImpl(n.getTime(),{targetPointAlignment:"center",alignIfTargetPointIsVisible:!1,autoscaleAfterScroll:!1,...i}).catch((()=>{}))}gotoTime(e,t){return this._gotoTimeImpl(e,{targetPointAlignment:"center",alignIfTargetPointIsVisible:!0,autoscaleAfterScroll:!0,...t}).catch((()=>{}))}recalculatePane(e,t){e?.recalculate(t)}recalculateAllPanes(e){this._panes.forEach((t=>t.recalculate(e))),this.updateAllPaneViews(e),
this.crosshairSource().updateAllViews(e)}async gotoTimeRange(e,t,i){const s=this.timeScale(),o=s.tickMarks(),r=this.mainSeries();if(i||this._lastGotoTimeRange?.deferred.reject(),void 0===o.minIndex)return void(i||(this._lastGotoTimeRange={from:e,to:t,deferred:(0,gt.createDeferredPromise)()}));let n=e,l=t;if(null!==r.symbolInfo()){const i=(0,a.ensureNotNull)(this.timezoneExceptExchange().value()),s=(0,c.get_timezone)(i),o=(0,c.utc_to_cal)(s,e),h=(0,c.utc_to_cal)(s,t);if(r.isDWM()){const e=(0,c.get_timezone)("Etc/UTC");(0,c.set_hms)(o,0,0,0,0,e),(0,c.set_hms)(h,0,0,0,0,e)}n=o.getTime(),l=h.getTime()}const h=(0,a.ensureDefined)(o.maxIndex),d=(0,a.ensureDefined)(o.minIndex);if(!(n>=(0,a.ensureNotNull)(o.indexToTime(d)).valueOf()||r.endOfData()||i)){const s={type:"time-range",from:e/1e3,to:t/1e3};return null===this._lastAppliedGotoTimeRange&&(this._lastAppliedGotoTimeRange={range:s,actual:!0},r.loadDataTo(s)),i||(i=this._lastGotoTimeRange={from:e,to:t,deferred:(0,gt.createDeferredPromise)()}),i.deferred.promise}{const e=(e,t)=>e<t,t=e=>(0,a.ensureNotNull)(o.indexToTime(e)).valueOf(),c=(0,J.lowerboundExt)(t,n,e,o.nearestIndex(n),h);let u=n===l?c:(0,J.lowerboundExt)(t,l,e,o.nearestIndex(l),h);this._lastGotoTimeRange=null,null!==this._lastAppliedGotoTimeRange&&(this._lastAppliedGotoTimeRange.actual=!1);const _=s.baseIndex();if(c+Math.max(u-c+1,s.minVisibleBarCount())>_){const e=s.targetDefaultRightOffset();u-_<e&&(u=_+e)}const p=c===u&&c===d&&r.endOfData()?c-1:c;s.zoomToBarsRange(p,u),this.updateAllPaneViews((0,Ds.viewportChangeEvent)()),this.lightUpdate(),i?.deferred.resolve()}}paneForSource(e){if(e===this._mainSeries.activeStudyBinding())return this.mainPane();if(!(0,_i.isDataSource)(e))return Array.from(this._customSourcesMap.values()).includes(e)?this.paneForSource(this.mainSeries()):null;for(let t=this._panes.length-1;t>=0;t--)if(this._panes[t].hasDataSource(e))return this._panes[t];return e instanceof yc.BarsMarksContainer?this.paneForSource(this.mainSeries()):null}mainPane(){return this._panes.find((e=>e.isMainPane().value()))??null}lastPane(){return this._panes[this._panes.length-1]}removeSource(e,t){this.selectionMacro((t=>t.removeSourceFromSelection(e)),!0),this._hoveredSource===e&&(this._hoveredSource=null,this._lastHoveredHittestData=null),this._sourcesBeingMoved.includes(e)&&(this._sourcesBeingMoved=this._sourcesBeingMoved.filter((t=>t!==e)),this._sourcesBeingMoved.length||(this._activeItemBeingMoved=null)),e===this._lineBeingEdited?.lineDataSource&&(this._lineBeingEdited=null,D.isToolEditingNow.setValue(!1)),e===this.lineBeingCreated()&&(this._linesBeingCreated.shift(),0===this._linesBeingCreated.length&&D.isToolCreatingNow.setValue(!1)),!t&&e.stop&&e.stop();(0,a.ensureNotNull)(this.alertsWatcher()).removeSourceAlertLabels(e);const i=this.detachSource(e),s=this.mainSeries().priceScale();return(0,Nt.isStudy)(e)&&(0,So.isActingAsSymbolSource)(e)&&e.priceScale()===s&&s.isPercentage()&&1===s.seriesLikeSources().filter(So.isActingAsSymbolSource).length&&s.setMode({percentage:!1}),this.fullUpdate(),
this._invalidateBarColorerCaches(),(0,Nt.isStudy)(e)&&((0,N.emit)("study_event",e.id(),"remove"),e.isChildStudy()&&e.parentSources().forEach((t=>t.unsetChild(e))),e.maxOffset().unsubscribe(this._boundUpdateStudiesMaxOffset)),!t&&e.destroy&&e.destroy(),(0,Ut.isLineTool)(e)&&(e.removeAlert(),(0,N.emit)("drawing_event",e.id(),"remove")),i}mainSeriesScaleRatio(){return(0,wn.scaleRatio)(this._timeScale,this.mainSeries().priceScale())}setMainSeriesScaleRatio(e){(0,a.ensureNotNull)(this.paneForSource(this._mainSeries)).applyPriceScaleRatio(this._mainSeries.priceScale(),e)}timezone(){return this._properties.childs().timezone.value()}timezoneExceptExchange(){return this._timezoneExceptExchange}allStudies(e){const t=e?e=>(0,Nt.isStudy)(e)&&!Ft(e):Nt.isStudy;return this._getAllSources(t)}studiesWV(e){return e?this._studiesExcludeInternalWV.readonly():this._studiesWV.readonly()}signatureSources(){return this._signatureSources}sourcesSignatures(){return this._sourcesSignatures}listUserStudies(e){const t=[];for(const i of this._panes)for(const s of i.priceDataSources())if(!(0,Nt.isFundamentalStudy)(s)&&(0,Nt.isStudy)(s)&&s.showInObjectTree()){const{id:i,shortDescription:o}=s.metaInfo();if(e.dontCountVolume&&"Volume@tv-basicstudies"===i||e.dontCountCompare&&"Compare@tv-basicstudies"===i||e.dontCountOverlay&&"Overlay@tv-basicstudies"===i)continue;t.push(o)}return t}findNonOverlayStudyWithGroupingKey(e,t){const i=void 0!==t?[t]:this._panes;for(const t of i){const i=t.dataSources().find((i=>(0,Nt.isStudy)(i)&&i.metaInfo().groupingKey===e&&!t.isOverlay(i)));if(void 0!==i)return{pane:t,study:i}}return null}canMovePaneUp(e){if(0===e)return!1;const t=this._panes[e],i=this._panes[e-1];return t.mode()===K.PaneMode.Widget?i.containsMainSeries():i.mode()!==K.PaneMode.Widget||!t.containsMainSeries()||1!==e}movePaneUp(e){this.movePane(e,e-1)}canMovePaneDown(e){if(e===this._panes.length-1)return!1;const t=this._panes[e],i=this._panes[e+1];return t.mode()===K.PaneMode.Widget?i.containsMainSeries():i.mode()!==K.PaneMode.Widget||!t.containsMainSeries()||e!==this._panes.length-2}movePaneDown(e){this.movePane(e,e+1)}movePane(e,t){const i=this._panes[e];this._panes.splice(e,1),this._panes.splice(t,0,i),this._panesCollectionChanged.fire(this._panes),this._onRearrangePanes.fire(),this._invalidateBarColorerCaches(),this.invalidate(ve.InvalidationMask.panesOrder())}toggleCollapsedPane(e){const t=this._panes[e];t.collapsed().setValue(!t.collapsed().value()),this.fullUpdate()}sendToBack(e){this._sendTo(e,((e,t)=>e.sendToBack(t)))}bringToFront(e){this._sendTo(e,((e,t)=>e.bringToFront(t)))}backgroundColor(){return this._backgroundColor}backgroundTopColor(){return this._backgroundTopColor}backgroundColorAtYPercentFromTop(e){const t=this.backgroundColor().value(),i=this.backgroundTopColor().value();return this._backgroundColorAtYPercentFromTop.gradientColor(i,t,e)}backgroundCounterColor(){return this._backgroundCounterColor.readonly()}dark(){return this._isDark}backgroundTheme(){return this._backgroundTheme}readOnly(){return this._readOnly}defaultResolutions(){
return this.chartApi().defaultResolutions()}availableCurrencies(){const e=this._getAvailableCurrencies();return e.length!==this._availableCurrencies.size()&&(this._availableCurrencies=new Cc(e)),this._availableCurrencies}currencyConversionEnabled(){return this._options.currencyConversionEnabled}availableUnits(){const e=this._getAvailableUnits();return this._availableUnits.unitsChanged(e)&&(this._availableUnits=new Tc(e)),this._availableUnits}unitConversionEnabled(){return this._options.unitConversionEnabled}availableMetrics(){let e=this._getAllAvailableMetrics();const t=this.mainSeries().symbolInfo()?.metrics;return t&&(e=e.filter((e=>void 0!==t.items[e.id]))),e.length!==this._availableMetrics.size()&&(this._availableMetrics=new xc(e)),this._availableMetrics}metricConversionEnabled(){return this._options.metricConversionEnabled}availablePriceSources(e){const t=this._getAvailablePriceSources(e);return null!==t&&this._availablePriceSources.priceSourcesChanged(t)&&(this._availablePriceSources=new rd(t)),this._availablePriceSources}resetDeferredStudies(){Za.DeferredStudies.instance(this).reset()}waitForStudy(e){const t=this.dataSourceForId(e);return t&&(0,Nt.isStudy)(t)?Promise.resolve(t):Za.DeferredStudies.instance(this).get(e)}resetWaitForStudy(e){Za.DeferredStudies.instance(this).delete(e)}isJustClonedChart(){return this._undoModel.isJustClonedChart()}studyTemplate(e,t,i){const s={panes:[],version:this.version()};for(const e of this.panes())s.panes.push(e.state({includeSources:!0,isStudyTemplate:!0}));const o=this.mainSeries();return e&&(s.symbol=o.symbol(),this.currencyConversionEnabled()&&i&&(s.currency=o.currency()),this.unitConversionEnabled()&&i&&(s.unit=o.unit())),t&&(s.interval=o.interval()),s}dataSourceForId(e){for(const t of this._panes){const i=t.dataSourceForId(e);if(i)return i}return null}getStudyById(e){const t=this.dataSourceForId(e);return null!==t&&(0,Nt.isStudy)(t)?t:null}getLineToolById(e){const t=this.dataSourceForId(e);return null!==t&&(0,Ut.isLineTool)(t)?t:null}restoreLineToolState(e,t,i){t.positionPercents?e.restorePositionPercents(t.positionPercents):(e.clearFixedPoint(),e.restorePoints(t.points,t.indexes||[])),t.state.intervalsVisibilities=(0,Xa.mergeIntervalVisibilitiesDefaults)(t.state.intervalsVisibilities),e.linkKey().setValue(t.linkKey||null),e.properties().mergeAndFire(t.state),e.restoreData&&e.restoreData(t),e.createServerPoints(),e.setZorder(t.zorder??e.zorder()),this.fullUpdate();const s=e.linkKey().value();null!==s&&i&&!this._lineToolsSyncBlock&&(0,D.restoreLineToolState)({model:this,linkKey:s,state:t})}restoreFactoryDefaults(e){e.restoreFactoryDefaults(),this.recalcVisibleRangeStudies(di.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction)}preferences(){return(0,Jh.preferencesByWhiteList)(this,this.mainSeries())}applyPreferences(e){for(const[t,i]of Object.entries(e)){const e=this._properties.child(t);void 0!==i&&void 0!==e&&e.mergeAndFire(i)}if(void 0!==e.timeScale){const t=e.timeScale;this._timeScale.defaultRightOffset().setValue(t.defaultRightOffset),
this._timeScale.defaultRightOffsetPercentage().setValue(t.defaultRightOffsetPercentage),this._timeScale.usePercentageRightOffset().setValue(t.usePercentageRightOffset)}this._properties.saveDefaults(),this._mainSeries.applyPreferences(e.mainSeries),this.sessions().restoreState({properties:e.sessions},!1),this.recalculateAllPanes((0,Ds.globalChangeEvent)()),this.fullUpdate()}restoreTheme(e,t,i){e.mainSourceProperties.hollowCandleStyle||(e.mainSourceProperties.hollowCandleStyle=e.mainSourceProperties.candleStyle),this._undoModel.chartLoadTheme(e,t,i)}updateScales(){this.mainSeries().properties().childs().priceAxisProperties.fireChanged()}onResetScales(){return this._resetScales}startMovingSources(e,t,i,s,o,r){this._sourcesBeingMoved=e,this._activeItemBeingMoved=i;let n=!1;if(this._sourcesBeingMoved.forEach((e=>{!n&&(0,Nt.isStudy)(e)&&(n=!0);const l=(0,a.ensureNotNull)(this.paneForSource(e)),c=(0,Ut.isLineTool)(e),h=c&&e.linkKey().value();if(!1!==h&&null!==h&&s.has(h)&&c&&e.isFixed()){const t=(0,a.ensureDefined)(s.get(h)),n={screen:this._percentPositionToPoint(t,l)};e.startMoving(n,i,o,r)}else e.startMoving(t,i,o,r);const d=this._paneInvalidationMask(l,ve.InvalidationLevel.Light);this.invalidate(d)})),!r){const[s,r]=gd(e);if(s.size&&t.logical){const n=this.externalTimeStamp(t.logical.index),l={linkKeys:[...s],toolNames:[...r],model:this,symbol:this.mainSeries().symbol(),point:{price:t.logical.price,timeStamp:n},activeItem:null!==i?i:void 0,envState:o,pointPositionPercents:new Map};e.forEach((e=>{if((0,Ut.isLineTool)(e)){const i=e.linkKey().value();if(i&&e.isSynchronizable()&&e.isFixed()){const s=(0,a.ensureNotNull)(this.paneForSource(e));l.pointPositionPercents.set(i,this._pointToPercentPosition((0,a.ensureDefined)(t.screen),s))}}})),(0,D.startMovingLineTool)(l)}}D.isToolMovingNow.setValue(!0),n&&D.isStudyEditingNow.setValue(!0)}moveSources(e,t,i,s){if(this._sourcesBeingMoved.filter((e=>!e.isLocked||!e.isLocked())).forEach((o=>{const r=(0,Ut.isLineTool)(o)?o.linkKey().value():null;if(null!==r&&t.has(r)){const e=(0,a.ensureNotNull)(this.paneForSource(o)),n=(0,a.ensureDefined)(t.get(r)),l={screen:this._percentPositionToPoint(n,e)};o.move(l,this._activeItemBeingMoved,i,s)}else o.move(e,this._activeItemBeingMoved,i,s)})),this.lightUpdate(),!s&&e.logical&&!this._lineToolsSyncBlock){const[t,s]=gd(this._sourcesBeingMoved),o=this.externalTimeStamp(e.logical.index),r={linkKeys:[...t],toolNames:[...s],model:this,point:{price:e.logical.price,timeStamp:o},envState:i,pointPositionPercents:new Map};this._sourcesBeingMoved.filter(Ut.isLineTool).forEach((t=>{if(t.linkKey().value()&&t.isSynchronizable()&&t.isFixed()){const i=(0,a.ensureNotNull)(this.paneForSource(t));r.pointPositionPercents.set(t.linkKey().value(),this._pointToPercentPosition((0,a.ensureDefined)(e.screen),i))}})),(0,D.moveLineTool)(r)}}endMovingSources(e,t,i){const s=this._sourcesBeingMoved.map((s=>{const o=(0,a.ensureNotNull)(this.paneForSource(s)),r=s.endMoving(e,t,i),n=this._paneInvalidationMask(o,ve.InvalidationLevel.Light)
;return n.invalidateAll(ve.InvalidationLevel.Light),this.invalidate(n),r}));if(!t&&!this._lineToolsSyncBlock){const[e,t]=gd(this._sourcesBeingMoved),i=this._sourcesBeingMoved.filter(Ut.isLineTool).filter((e=>e.isSynchronizable()&&!!e.linkKey)).map((e=>{const t={points:e.normalizedPoints(),interval:this.mainSeries().interval()};return e.isFixed()&&(t.pointPositionPercents=e.calcPositionPercents()),t}));e.size&&(0,D.finishMovingLineTool)({linkKeys:[...e],toolNames:[...t],model:this,finalStates:i,changes:s})}this._sourcesBeingMoved=[],this._activeItemBeingMoved=null,D.isToolMovingNow.setValue(!1),D.isStudyEditingNow.setValue(!1)}sourcesBeingMoved(){return this._sourcesBeingMoved}setMovingCustomSource(e,t){this._customSourceBeingMoved=e,this._customSourceBeingMovedHitTestData=null!==t?{beingMoved:!1,cancelled:!1,...t}:null}processingCustomSourceMove(){null!==this._customSourceBeingMovedHitTestData&&(this._customSourceBeingMovedHitTestData.beingMoved=!0)}customSourceMovingHitTestData(){return this._customSourceBeingMovedHitTestData}customSourceBeingMoved(){return null!==this._customSourceBeingMovedHitTestData&&this._customSourceBeingMovedHitTestData.beingMoved?this._customSourceBeingMoved:null}lineToolsSynchronizer(){return this._lineToolsSynchronizer}setLineToolsSynchronizer(e){this._lineToolsSynchronizer=e}width(){return this._width}setWidth(e,t){(this._panes.reduce(((t,i)=>i.setWidth(e)||t),!1)||this._width!==e)&&(this._width=e,this._timeScale.setWidth(e,t),this.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this.recalcVisibleRangeStudies(di.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction))}setPaneHeight(e,t){e.setHeight(t),this.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this.lightUpdate()}resetScalesAvailable(){return this._resetScalesAvailable.readonly()}maximizedPane(){return this._maximizedPane.readonly()}setMaximizedPane(e){(0,a.assert)(null===e||this._panes.includes(e),"The pane is not part of this chart"),this._maximizedPane.setValue(e)}panes(){return this._panes}paneForId(e){return this._panes.find((t=>t.id()===e))||null}createPane(e,t,i,s){this._restoringState||this._maximizedPane.setValue(null);const o=this._properties.childs().paneProperties;t&&o.merge(t);const r=new nl(this._timeScale,o,this,i,s??K.PaneMode.Regular);return void 0!==e?this._panes.splice(e,0,r):this._panes.push(r),r.onTagsChanged().subscribe(this,(()=>this.onPaneTagsChanged())),r.dataSourcesCollectionChanged().subscribe(this,(()=>this._dataSourceCollectionChanged.fire(r))),r.dataSourcesZOrdersChanged().subscribe(this,(()=>this._invalidateBarColorerCaches())),r.symbolSourceCollectionChanged().subscribe(this,(()=>this._onSymbolSourceCollectionChanged(r))),r.priceSourcesCollectionChanged().subscribe(this,(()=>this._onPriceSourcesCollectionChanged(r))),r.sourcePropertiesChanged().subscribe(this,(e=>this._sourceProperitesChanged.fire(r,e))),r.sourceZOrderChanged().subscribe(this,(e=>this._sourceZOrderChanged.fire(r,e))),r.symbolSourceResolved().subscribe(this,(e=>this._symbolSourceResolved.fire(r,e))),
r.symbolSourceResolvingActive().subscribe(this._recalcSymbolResolvingActive),r.collapsed().subscribe(this._recalcPaneCollapsingAvailable),r.resetPriceScalesAvailable().subscribe(this._updateResetScalesAvailableValue,{callWithLast:!0}),this._recalcPaneCollapsingAvailable(),this._panesCollectionChanged.fire(this._panes),this._invalidateBarColorerCaches(),this.invalidate(ve.InvalidationMask.panesOrder()),r}removePane(e){e===this._maximizedPane.value()&&this._maximizedPane.setValue(null),e.destroy();const t=this._panes.indexOf(e);-1!==t&&(this._panes.splice(t,1),e.dataSourcesCollectionChanged().unsubscribeAll(this),e.dataSourcesZOrdersChanged().unsubscribeAll(this),e.symbolSourceCollectionChanged().unsubscribeAll(this),e.priceSourcesCollectionChanged().unsubscribeAll(this),e.sourcePropertiesChanged().unsubscribeAll(this),e.onTagsChanged().unsubscribeAll(this),e.symbolSourceResolved().unsubscribeAll(this),e.symbolSourceResolvingActive().unsubscribe(this._recalcSymbolResolvingActive),e.collapsed().unsubscribe(this._recalcPaneCollapsingAvailable),e.resetPriceScalesAvailable().unsubscribe(this._updateResetScalesAvailableValue),this._recalcPaneCollapsingAvailable(!0)),this._updateResetScalesAvailableValue();this.crosshairSource().pane===e&&this.clearCurrentPosition(),this._panesCollectionChanged.fire(this._panes),this._invalidateBarColorerCaches(),this.invalidate(ve.InvalidationMask.panesOrder())}changePanesHeight(e,t){if(this._panes.length<2)return;(0,a.assert)(e>=0&&e<this._panes.length,"Invalid pane index");const i=this._panes[e],s=this._panes.reduce(((e,t)=>e+t.stretchFactor()),0),o=this._panes.reduce(((e,t)=>e+t.height()),0),r=o-30*(this._panes.length-1);t=Math.min(r,Math.max(30,t));const n=s/o,l=i.height();i.setStretchFactor(t*n);let c=t-l,h=this._panes.length-1;for(const e of this._panes)if(e!==i){const t=Math.min(r,Math.max(30,e.height()-c/h));c-=e.height()-t,h-=1;const i=t*n;e.setStretchFactor(i)}this.fullUpdate()}clearCurrentPosition(){const e=this.crosshairSource();e.clearPosition(),(0,a.ensureNotNull)(e.dataWindowView()).update((0,Ds.sourceChangeEvent)(e.id())),dd(this._panes),this.invalidate(ve.InvalidationMask.cursor()),this._undoModel.syncCrosshair(null),this._phantomSourceContainer.onCursorPositionUpdated()}getTpoSummaryPane(){const e=this._mainSeries.properties().childs().tpoStyle.childs(),t=e.summary.childs().belowSeries.value(),i=e.summary.childs().infoBlocks,s=e.summary.childs().infoBlocks.childNames();let o=0;s.forEach((e=>{i.childs()[e].childs().visible.value()&&o++}));const r=Math.max(o*cc.constants.cellHeight,30);return this._getWidgetPane(t,r)}getVolumeFootprintSummaryPane(){const e=this._mainSeries.properties().childs().volFootprintStyle.childs(),t=e.extendedSummary.childs().belowSeries.value(),i=e.extendedSummary.childs().blockInfo,s=i.childNames();let o=0;s.forEach((e=>{i.childs()[e].childs().visible.value()&&o++}));const r=this._mainSeries.symbolInfo();if(r&&(0,bn.isFutures)(r.type)&&!(0,bn.hasCryptoTypespec)(r.typespecs)){const t=e.extendedSummary.childs().openInterestBlockInfo
;t.childNames().forEach((e=>{t.childs()[e]?.childs().visible.value()&&o++}))}if(r&&((0,bn.isFutures)(r.type)||"swap"===r.type)&&(0,bn.hasCryptoTypespec)(r.typespecs)){const t=e.extendedSummary.childs().extendedOpenInterestBlockInfo;t.childNames().forEach((e=>{t.childs()[e].childs().visible.value()&&o++}))}const n=Math.max(o*cc.constants.cellHeight,30);return this._getWidgetPane(t,n)}setAndSaveCurrentPosition(e,t,i,s){this.crosshairSource().saveOriginCoords(e,t),this.setCurrentPosition(e,t,i,s)}setCurrentPosition(e,t,i,s){let o=NaN;const r=this._timeScale.coordinateToVisibleIndex(e),n=(this._lineBeingEdited??this._linesBeingCreated[0])?.ownerSource.priceScale()??i.defaultPriceScale();let l=null;!n.isEmpty()&&Number.isFinite(t)&&(l=(0,a.ensureNotNull)(i.mainDataSource()).firstValue(),null!==l&&(o=n.coordinateToPrice(t,l)));const c=this.crosshairSource(),h=c.requestPointParams(),d=h?.selectPointMode??D.SelectPointMode.None,u=d!==D.SelectPointMode.None,_=D.tool.value(),p=this.mainSeries(),m=c.index,g=c.price,S=d===D.SelectPointMode.Study||D.isStudyEditingNow.value(),v=d===D.SelectPointMode.Replay;let f=!1;const b=(0,Ls.magnetSnapsToIndicators)().value();if(n===this._mainSeries.priceScale()||b)if((0,se.isLineDrawnWithPressedButton)(_)){const e=this.lineBeingCreated();f=null===e||(0,Ut.isBrushBasedLineTool)(e)&&e.hasOnlyOnePoint()}else{f=Boolean(this.lineBeingCreated()||this._lineBeingEdited||(0,se.isLineToolName)(_)||(0,D.toolIsMeasure)(_))||S}!this._isSettingsExternalPosition&&f?(o=this._magnet.align(o,r,i),null!==l&&this._setCorrectedPositionToCrosshair(r,o,i)):this._magnet.resetLastValue();let y=null;if(isNaN(o)||(y=i),this._isTimeScrolling){if(!this._isSettingsExternalPosition&&u){const e=p.bars().firstIndex(),t=p.bars().lastIndex();if(null!==e&&null!==t){const s=Math.min(Math.max(r,e),t);s!==r&&this._setCorrectedPositionToCrosshair(s,o,i)}}else c.setPosition(c.index,o,y);return}c.setOnHoveredChartWidget(!0),c.setPosition(r,o,y),(0,a.ensureNotNull)(c.dataWindowView()).update((0,Ds.sourceChangeEvent)(c.id())),dd(this._panes);const w=p.syncModel(),C=this.lineBeingCreated();if(this.crosshairSource().startMeasurePoint()||C?this.lightUpdate():this.invalidate(ve.InvalidationMask.cursor()),C){const e=C.linkKey().value();if(!this._isSettingsExternalPosition){const t=C.setLastPoint({index:r,price:o},s);if(C.updateAllViews((0,Ds.sourceChangeEvent)(C.id())),t.price===o&&t.index===r||this._setCorrectedPositionToCrosshair(t.index,t.price,i),w&&e&&!this._lineToolsSyncBlock){const i=this._timeScale.points().roughTime(t.index,w.projectTime.bind(w));(0,D.setLineToolLastPoint)({model:this,linkKey:e,point:{timeStamp:(0,a.ensureNotNull)(i),price:t.price}})}}}if(!this._isSettingsExternalPosition&&null!==this._lineBeingEdited&&null!==this._lineBeingEdited.pointIndex){const e={index:r,price:o},{lineDataSource:t,pointIndex:n,startChangingPoint:a}=this._lineBeingEdited;if(a?.nonDiscreteIndex){const t=this.crosshairSource().originX();Number.isFinite(t)&&(e.index=this._timeScale.coordinateToFloatIndex(t))}this.changeLinePoint(e,s)
;const l=t.alignCrossHairToAnchor(n)?t.getPoint(n):e;null!==l&&this._setCorrectedPositionToCrosshair(l.index,l.price,i)}if(!this._isSettingsExternalPosition&&1===this._sourcesBeingMoved.length){const e=this._sourcesBeingMoved[0];if(e.alignCrossHairToMovePoint?.()){const t=e.currentMovingPoint?.();t&&t.logical&&this._setCorrectedPositionToCrosshair(t.logical.index,t.logical.price,i)}}if(!this._isSettingsExternalPosition&&(S||v)){const e=p.bars().firstIndex(),t=p.bars().lastIndex();if(null!==e&&null!==t){let s=Math.max(r,e);h?.alignToTheLatestBarIfTimePointIsOutOfData&&(s=Math.min(s,t)),s!==r&&this._setCorrectedPositionToCrosshair(s,o,i)}}(m!==r||g!==o)&&this._syncCrosshair(s)}setExternalPosition(e,t){let i;const s=this.crosshairSource();if(s.setOnHoveredChartWidget(!1),null!==e&&(0,n.isNumber)(e.timeStamp)){const t=this.mainSeries().syncModel();if(t){const s=this.createSyncPoint(e.syncSourceTarget,t.syncSourceTarget()).sourceTimeToTargetTime(e.timeStamp);i=this._timeScale.points().roughIndex(s,t.distance.bind(t),1)}}if(null!==e&&null!=i&&Number.isFinite(i)){this._isSettingsExternalPosition=!0;const o=(0,a.ensureNotNull)(this.paneForSource(this.mainSeries())),r=this._timeScale.indexToCoordinate(i),n=(0,a.ensureNotNull)(o.mainDataSource()).firstValue();if(null!==n){let i=NaN;void 0!==e.price&&Number.isFinite(e.price)&&(i=this.mainSeries().priceScale().priceToCoordinate(e.price,n)),s.clearOriginCoords(),this.setCurrentPosition(r,i,o,t)}return s.setOnHoveredChartWidget(!1),void(this._isSettingsExternalPosition=!1)}s.clearPosition(),(0,a.ensureNotNull)(s.dataWindowView()).update((0,Ds.sourceChangeEvent)(s.id())),dd(this._panes),this.invalidate(ve.InvalidationMask.cursor())}startScaleTime(e){this._timeScale.startScale(e)}scaleTimeTo(e){this._timeScale.scaleTo(e),this.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this.lightUpdate()}endScaleTime(){this._timeScale.endScale(),this.lightUpdate(),this.recalcVisibleRangeStudies(di.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction)}resetTimeScale(){this._timeScale.restoreDefault(),this.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this.recalcVisibleRangeStudies(di.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction),this.lightUpdate(),this._resetScales.fire()}startScalePrice(e,t,i){e.startScalePrice(t,i)}scalePriceTo(e,t,i){e.scalePriceTo(t,i),this.mainSeries().priceScale().isLockScale()?this.lightUpdate():this.invalidate(this._paneInvalidationMask(e,ve.InvalidationLevel.Light))}endScalePrice(e,t){e.endScalePrice(t),this.invalidate(this._paneInvalidationMask(e,ve.InvalidationLevel.Light))}startTwoPointsScalePrice(e,t,i,s){t.startTwoPointsScale(i,s)}twoPointsScalePriceTo(e,t,i,s){t.twoPointsScale(i,s),t.updateAllViews((0,Ds.viewportChangeEvent)()),this.invalidate(this._paneInvalidationMask(e))}endTwoPointsScalePrice(e,t){t.endTwoPointsScale(),this.invalidate(this._paneInvalidationMask(e))}resetPriceScale(e,t){e.resetPriceScale(t),this.invalidate(this._paneInvalidationMask(e,ve.InvalidationLevel.Light))}restorePriceScaleState(e,t,i){e.restorePriceScaleState(t,i),
this.invalidate(this._paneInvalidationMask(e,ve.InvalidationLevel.Light))}detachSource(e){const t=this.paneForSource(e);return!!t&&(t.removeDataSource(e),t.isEmpty()?(this.lineBeingCreated()&&t===this.paneBeingCreatedLineOn()&&this.cancelCreatingLine(),this.removePane(t),!0):(this.fullUpdate(),!1))}restoreSource(e,t,i,s,o){const r=e?this.createPane(t):this.panes()[t],n=(0,q.isStudyState)(s),a=n?r.restoreStudy({source:s}):(0,q.isLineToolState)(s)?r.restoreLineTool({state:s}):null;if(!a)return null;let l=null;if(o?(l=r.getPriceScaleById(o.id),l||(l=r.createPriceScaleAtPosition(o.position,o.priceScaleIndex),l.setId(o.id))):l=a.ownerSource()?.priceScale()??l,l&&(a.setPriceScale(l),l.addDataSource(a)),!e&&i&&i.overlayPriceScales){const e=this.dataSources().filter((e=>void 0!==i.overlayPriceScales[e.id()]));e.forEach((e=>r.removeSourceFromPriceScale(e)));const t=new Map;e.forEach((e=>{const s=i.overlayPriceScales[e.id()];if(!s)return;let o;t.has(s.id)?o=t.get(s.id):(o=r.createPriceScaleAtPosition("overlay"),o.restoreState(s),t.set(s.id,o)),e.setPriceScale(o),o.addDataSource(e)}))}return e&&i&&r.restoreState({state:i,withData:!1,version:this.version()}),n&&(this.recalculateAllPanes((0,Ds.sourceChangeEvent)(a.id())),this._invalidateBarColorerCaches(),this.fullUpdate(),this.alertsWatcher()?.syncSourceAlertLabels(a)),a}children(e,t,i){return this.dataSources().filter((s=>!(0,Nt.isStudy)(s)||Ft(s)||e.isSeries&&s.isLinkedToSeries()?!((0,Ut.isLineTool)(s)&&i&&s.supportsTargetSignature()&&null!==s.targetSignature())&&s.ownerSource()===e:!t&&s.parentSources().includes(e)))}onRearrangePanes(){return this._onRearrangePanes}studyInserted(){return this._studyInserted}finishLineTool(e){const t=e.linkKey().value();(0,D.drawOnAllCharts)().value()&&null!==t&&e.isSynchronizable()&&!this._lineToolsSyncBlock&&(0,D.finishLineTool)({linkKey:t,model:this})}startChangingLinetool(e,t,i,s,o,r){this._lineBeingEdited={lineDataSource:e,ownerSource:t,startChangingPoint:i??null,pointIndex:s??null},e.startChanging(s,i,r),D.isToolEditingNow.setValue(!0);const n=(0,a.ensureNotNull)(this.paneForSource(e));e.startDragPoint&&void 0!==s&&void 0!==i&&e.startDragPoint(s,i),r||void 0===s||void 0===i||e.setPoint(s,i,o,r),e.updateAllViews((0,Ds.sourceChangeEvent)(e.id()));const l=this._paneInvalidationMask(n,ve.InvalidationLevel.Light);this.invalidate(l);const c=e.linkKey().value();if(c&&e.isSynchronizable()&&void 0!==s&&void 0!==i&&!this._lineToolsSyncBlock){const t=(0,a.ensureNotNull)(this.externalTimeStamp(i.index));(0,D.startChangingLineTool)({linkKey:c,model:this,symbol:this.mainSeries().symbol(),point:{price:i.price,timeStamp:t},positionPercents:e.positionPercents(),pointIndex:s,envState:o||null})}}createLineTool(e){const{point:t,linetool:i,linkKey:s=null,sharingMode:o=0,id:r,fromExternalModel:l,actionSource:c,pane:h}=e;let{properties:d,ownerSource:u}=e;u=(0,a.ensureDefined)(u||(0,a.ensureNotNull)(h.mainDataSource()));let _=h;if(Ta.shareDrawingsOnIndicators&&(0,Nt.isStudy)(u)&&(_=(0,a.ensureNotNull)(this.mainPane())),(0,a.assert)((0,
se.isLineToolName)(i),`Cannot create unknown line tool: ${i}`),d){const e={...Qh.intervalsVisibilitiesDefaults},t=d.childs().intervalsVisibilities.state();(0,n.merge)(e,t??{});const s=d.state();s.intervalsVisibilities=e,d=(0,Ut.createLineToolProperties)(this.backgroundTheme().spawnOwnership(),i,!this.readOnly(),s)}const p=(0,Ut.createLineTool)(i,this,d,null,void 0,r,c);if("LineToolExecution"!==i){let e;switch(i){case"LineToolIcon":e=p.properties().childs().icon.value().toString(16).toUpperCase();break;case"LineToolEmoji":e=p.properties().childs().emoji.value();break;case"LineToolSticker":e=p.properties().childs().sticker.value()}(0,_t.trackEvent)("drawings","Study_Drawing_"+i,e)}(0,Gt.isStudyLineTool)(p)&&(0,_t.trackEvent)("studies",`Study_${p.metaInfo().id}`,p.metaInfo().description);const m=!p.linkKey().value()&&!s;d||(0,Ut.prepareLineToolPropertiesByOwnerSource)(p.properties(),u),Ta.shareDrawingsOnIndicators&&(0,Nt.isStudy)(u)?p.setTargetSignature(u.signature().value()):p.setOwnerSource(u);const g=u.priceScale();if(p.setPriceScale(g),u===this.mainSeries()&&p.share(o),_.addDataSource(p,g,!1),null!==p.preferredZOrder()&&_.insertAfter([p],this.mainSeries()),(0,D.drawOnAllCharts)().value()){const e=p.isSynchronizable()?s||(0,ot.randomHash)():null;p.linkKey().setValue(e)}else p.linkKey().setValue(s);let S;if(m&&p.enableCurrentIntervalVisibility(),p.isFixed()){const e=(0,a.ensureNotNull)((0,a.ensureNotNull)(h.mainDataSource()).firstValue()),i=this._timeScale.indexToCoordinate(t.index),s=(0,a.ensureNotNull)(g).priceToCoordinate(t.price,e);S=p.addFixedPoint(new dt.Point(i,s))}else S=p.addPoint(t);return S||(this._linesBeingCreated.unshift({lineDataSource:p,fromExternal:!!l,ownerSource:u,pane:h}),D.isToolCreatingNow.setValue(!0)),this.fullUpdate(),p}endChangingLinetool(e,t){const i=(0,a.ensureNotNull)(this._lineBeingEdited).lineDataSource,s=i.endChanging(!1,e,t);this._lineBeingEdited=null,D.isToolEditingNow.setValue(!1),this.lightUpdate();const o={points:i.normalizedPoints(),interval:this.mainSeries().interval()},r=i.linkKey().value();null===r||!i.isSynchronizable()||t||this._lineToolsSyncBlock||(0,D.finishChangingLineTool)({model:this,linkKey:r,symbol:this.mainSeries().symbol(),finalState:o,changes:s})}continueCreatingLine(e,t,i,s,o){const r=(0,a.ensureNotNull)(this.lineBeingCreated()),n=r.addPoint(e,t,i,o);r.updateAllViews((0,Ds.sourceChangeEvent)(r.id()));const l=new ve.InvalidationMask(ve.InvalidationLevel.Light);return n&&(this._linesBeingCreated.shift(),0===this._linesBeingCreated.length&&D.isToolCreatingNow.setValue(!1)),this.invalidate(l),n}cancelCreatingLine(){const e=this.lineBeingCreated();e&&(this.removeSource(e),this._linesBeingCreated.shift(),this._lineCancelled.fire(),0===this._linesBeingCreated.length&&D.isToolCreatingNow.setValue(!1),(0,D.drawOnAllCharts)().value()&&e.isSynchronizable()&&!this._lineToolsSyncBlock&&(0,D.cancelLineTool)({model:this}))}lineBeingCreated(){return this._linesBeingCreated[0]?.lineDataSource??null}lineBeingCreateFromExternal(){return this._linesBeingCreated[0]?.fromExternal??!1}
paneBeingCreatedLineOn(){return this._linesBeingCreated[0]?.pane??null}lineCancelled(){return this._lineCancelled}isPhantomLine(e){return this._phantomSourceContainer.source()===e}alignTo45Degrees(e,t,i){const[s,o]=i,r={...o};e.snapPoint45Degree(s,r),this.startChangingLinetool(e,t,o,o.pointIndex),this.changeLinePoint(r,ui.EnvironmentState.create(!0)),this.endChangingLinetool(!1)}changeLinePoint(e,t,i){const s=(0,a.ensureNotNull)(this._lineBeingEdited),o=s.lineDataSource,r=(0,a.ensureNotNull)(s.pointIndex);let n=e.price,l=e.index;if(o.setPoint(r,e,t,i),!i){const t=o.alignCrossHairToAnchor(r)?o.getPoint(r):e;null!==t&&(l=t.index,n=t.price)}o.updateAllViews((0,Ds.sourceChangeEvent)(o.id())),this.lightUpdate();const c=o.linkKey().value();if(!i&&null!==c&&o.isSynchronizable()&&!this._lineToolsSyncBlock){const e=(0,a.ensureNotNull)(s.startChangingPoint),i={indexesChanged:l!==e.index,pricesChanged:n!==e.price},h=o.getChangePointForSync(r);if(null!==h){const e=this.externalTimeStamp(l);null!==e&&(n=h.price,(0,D.changeLineTool)({linkKey:c,model:this,symbol:this.mainSeries().symbol(),point:{price:n,timeStamp:e},positionPercents:o.positionPercents(),envState:t,changes:i}))}}}changeLinePoints(e,t,i){const s=e.points(),o=e.linkKey().value();!i&&o&&e.isSynchronizable()&&!this._lineToolsSyncBlock&&t.forEach(((t,i)=>{const r=s[i],n=r.price!==t.price,l=r.index!==t.index;if(e.getChangePointForSync(i)){const i=(0,a.ensureNotNull)(this.externalTimeStamp(t.index));(0,D.changeLineTool)({linkKey:o,model:this,symbol:this.mainSeries().symbol(),point:{price:t.price,timeStamp:i},positionPercents:e.positionPercents(),changes:{pricesChanged:n,indexesChanged:l}})}})),e.setPoints(t),e.updateAllViews((0,Ds.sourceChangeEvent)(e.id())),this.lightUpdate()}startScrollTime(e){this._timeScale.startScroll(e),this._isTimeScrolling=!0,this.mainSeries().clearGotoDateResult()}scrollTimeTo(e){this._timeScale.scrollTo(e),this.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this.lightUpdate()}endScrollTime(){this._timeScale.endScroll(),this.lightUpdate(),this.recalcVisibleRangeStudies(di.RecalcVisibleRangeStudiesReason.ViewportChangeUserAction),this._isTimeScrolling=!1}startScrollPrice(e,t,i){e.startScrollPrice(t,i)}scrollPriceTo(e,t,i){e.scrollPriceTo(t,i),this.invalidate(this._paneInvalidationMask(e,ve.InvalidationLevel.Light))}endScrollPrice(e,t){e.endScrollPrice(t),this.invalidate(this._paneInvalidationMask(e,ve.InvalidationLevel.Light))}addCustomSource(e,t,i=di.CustomSourceLayer.Foreground){this._customSourcesMap.has(e)&&cd.logWarn(`Attempt to add the same custom source multiple time "${e}"`),cd.logNormal(`Adding custom source "${e}"`);const s=t(e,this);switch(i){case di.CustomSourceLayer.Background:this._bgCustomSources.push(s);break;case di.CustomSourceLayer.Foreground:this._fgCustomSources.push(s);break;case di.CustomSourceLayer.Topmost:this._topmostCustomSources.push(s);break;default:throw new Error(`Unknown custom sources layer ${i}`)}this._allCustomSources.push(s),this._customSourcesMap.set(e,s),this.lightUpdate()}removeCustomSource(e){
this._removeCustomSource(e),this.lightUpdate()}hasCustomSource(e){return this._customSourcesMap.has(e)}customSourceForName(e){return this._customSourcesMap.get(e)||null}customSourceName(e){let t=null;return this._customSourcesMap.forEach(((i,s)=>{i===e&&(t=s)})),t}customSources(e){switch(e){case di.CustomSourceLayer.Background:return this._bgCustomSources;case di.CustomSourceLayer.Foreground:return this._fgCustomSources;case di.CustomSourceLayer.Topmost:return this._topmostCustomSources;default:return this._allCustomSources}}addMultiPaneSource(e){this._multiPaneSources.push(e),this._onMultipaneSourcesCollectionChanged.fire(),this.lightUpdate()}removeMultiPaneSource(e){const t=this._multiPaneSources.indexOf(e);-1===t?cd.logWarn("Attempt to remove multi-pane source which does not exist in the model"):(this._onMultipaneSourcesCollectionChanged.fire(),this._multiPaneSources.splice(t,1)),this.lightUpdate()}multiPaneSources(e){return this._multiPaneSources.filter((t=>!e.hasDataSource(t)))}onMultipaneSourcesCollectionChanged(){return this._onMultipaneSourcesCollectionChanged}rendererOptionsProvider(){return this._rendererOptionsProvider}magnet(){return this._magnet}priceAxisRendererOptions(){return this._rendererOptionsProvider.options()}priceScaleSlotsCount(){let e=0,t=0;this._panes.forEach((i=>{e=Math.max(i.leftPriceScales().length,e),t=Math.max(i.rightPriceScales().length,t)}));const i=e+t;if(_.CheckMobile.any()){const e=(0,a.ensureNotNull)(this.paneForSource(this.mainSeries())),t=e.priceScalePosition(this.mainSeries().priceScale());return("overlay"===t?e.rightPriceScales().length>0:"right"===t)?{left:0,right:1,totallySlots:i}:{left:1,right:0,totallySlots:i}}return{left:e,right:t,totallySlots:i}}dateTimeFormatter(){return this._dateTimeFormatter}dateFormatter(){return this._dateFormatter}timeFormatter(){return this._timeFormatter}isUnmergeAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;return(0,a.ensureNotNull)(this.paneForSource(e)).dataSources().filter(this._unmergeAvailable,this).length>1}isMergeDownAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;const t=this.paneForSource(e),i=this.panes().filter((e=>e.mode()===K.PaneMode.Regular));return t!==i[i.length-1]}isMergeUpAvailableForSource(e){if(!this._unmergeAvailable(e))return!1;return this.paneForSource(e)!==this.panes().filter((e=>e.mode()===K.PaneMode.Regular))[0]}isPriceScaleVisible(e){const t=e.mainSource();if(!t)return!1;const i=(0,a.ensureNotNull)(this.paneForSource(t)),s=i.priceScalePosition(e);if("overlay"===s)return!0;const o=i.priceScaleIndex(e,s),r=this.priceScaleSlotsCount()[s];return void 0!==o&&o<r}getStudyShiftColorStartOffset(){return this._studyShiftColorStartOffset}setStudyShiftColorStartOffset(e){this._studyShiftColorStartOffset=e}sessions(){return(0,a.ensureNotNull)(this._sessions)}createSessions(e){if(null===this._sessions){const t=function(e){const t=new Vn(e);return(0,En.applyDefaultsOverrides)(t.childs().sessionHighlight,void 0,!1,"sessions"),t.removeDuplicateProperties(),t
}(this.mainSeries().symbolInfoWV().weakReference());this._sessions=new On((async()=>{const s=await Promise.all([i.e(25118),i.e(88736),i.e(30242),i.e(4998),i.e(3052),i.e(70438),i.e(26492),i.e(93868),i.e(67618),i.e(49894),i.e(60802),i.e(40760),i.e(93867),i.e(77435),i.e(2253),i.e(49615),i.e(50468),i.e(38953),i.e(7908),i.e(47538)]).then(i.bind(i,918044));return this.addCustomSource("sessions",((i,o)=>{const r=new s.Sessions(i,o,t,e);return r.start(),r}),di.CustomSourceLayer.Background),this.customSourceForName("sessions")})(),this,t)}}createPrePostMarket(e){this.addCustomSource("prePostMarket",((t,i)=>new vc(t,i,e)))}createInactivityGaps(){0}inactivityGaps(){throw new Error("inactivity_gaps featureset is not enabled")}setInactivityGapsSession(e){(0,a.ensureNotNull)(this.customSourceForName("inactivityGaps")).setSession(e||"session")}watermarkSource(){return this._watermarkSource}watermarkContentProvider(){return new H.WatchedValue(null)}studiesColorRotatorFactory(){return this._studyColorRotatorFactory}replayStatus(){return this._replayStatus}setReplayStatus(e){this._replayStatus.setValue(e)}isInReplay(){return this._mainSeries.isInReplay()}getSymbolString(){return this._mainSeries.getSymbolString()}interval(){return this._mainSeries.interval()}onInReplayStateChanged(){return this._mainSeries.onInReplayStateChanged()}switchToReplay(e,t,i){this._mainSeries.switchToReplay(e,t,i)}switchToRealtime(){this._mainSeries.switchToRealtime(),this._timeScale.resetRightOffset(),this.setReplayStatus(0),this._scrollingState&&(this._scrollingState.deferred.reject(),this._scrollingState=null)}canChangeResolution(e){return this._mainSeries.canChangeResolution(e)}canChangeSymbol(e){return this._mainSeries.canChangeSymbol(e)}onReplayModified(){return this._mainSeries.onReplayModified()}mainSeriesScaleRatioProperty(){return this._mainSeriesScaleRatioProperty}mainSeriesScaleRatioPropertyOnChanged(){this._mainSeriesScaleRatioProperty.fireChanged()}getThemeNameIfStdTheme(){const e=this.sessions().properties(),t=this.properties(),i=this.mainSeries().properties();return e.allThemePropertiesAreDefault(vn.StdTheme.Light)&&t.allThemePropertiesAreDefault(vn.StdTheme.Light)&&i.allThemePropertiesAreDefault(vn.StdTheme.Light)?vn.StdTheme.Light:e.allThemePropertiesAreDefault(vn.StdTheme.Dark)&&t.allThemePropertiesAreDefault(vn.StdTheme.Dark)&&i.allThemePropertiesAreDefault(vn.StdTheme.Dark)?vn.StdTheme.Dark:null}theme(){return{chartProperties:this.properties().themeState(),sessions:this.sessions().properties().themeState(),mainSourceProperties:this.mainSeries().properties().themeState(),version:this.version()}}template(){return{chartProperties:this.properties().template(),sessions:this.sessions().properties().template(),mainSourceProperties:this.mainSeries().properties().template(),version:this.version()}}onChartThemeLoaded(){return this._chartThemeLoaded}chartThemeLoaded(){this._chartThemeLoaded.fire()}async colorStudiesPropertiesReady(){this._recalcColorStudiesImpl(this._recalcVRStudiesParams)
;const e=this.allStudies(!0).filter((e=>e.metaInfo().inputs.filter(wt.isStudyInputDependsOnChartColors).length>0));await Promise.all(e.map((e=>e.propertiesPatched())))}state(e){const{withData:t,skipLineToolsFromOtherSymbols:i,skipLineTools:s}=e,o=this.publishedChartsTimelineSource(),r=this.properties().childs(),n=r.tradingProperties.state(),a={panes:this._panes.map((t=>t.state({...e,includeSources:!0}))),timeScale:this._timeScale.state(t),chartProperties:{paneProperties:r.paneProperties.state(["horzGridProperties.style","vertGridProperties.style"]),scalesProperties:r.scalesProperties.state(),publishedChartsTimelineProperties:o?o.state(t):void 0,chartEventsSourceProperties:r.chartEventsSourceProperties?.state(),tradingProperties:n,priceScaleSelectionStrategyName:r.priceScaleSelectionStrategyName.value(),inactivityGaps:r.inactivityGaps.value()},sessions:this.sessions().state(t),version:this.version(),timezone:this.timezone(),shouldBeSavedEvenIfHidden:this._shouldBeSavedEvenIfHidden,linkingGroup:this._linkingGroupIndex.value()};return s||(a.lineToolsGroups=this.lineToolsGroupModel().state(i)),a}isInRestoreState(){return this._restoringState}restoreState(e,t,i){Za.DeferredStudies.instance(this).reset();const s={};if(!e.panes)return void cd.logDebug("ChartModel.restoreState: invalid state");if(!Array.isArray(e.panes))return void cd.logDebug("ChartModel.restoreState: invalid state");if(e.panes.length<1)return void cd.logDebug("ChartModel.restoreState: invalid state");this._restoringState=!0;for(const e of this._barsMarksSources)this.detachSource(e);if(this._shouldBeSavedEvenIfHidden=e.shouldBeSavedEvenIfHidden??!0,e.chartProperties&&!e.chartProperties.timezone&&(e.chartProperties.timezone=e.timezone),e.chartProperties){const i=(0,En.factoryDefaults)("chartproperties").scalesProperties;(0,n.merge)(i,e.chartProperties.scalesProperties),!("showLastValue"in i)||"showSeriesLastValue"in i||"showStudyLastValue"in i||(i.showSeriesLastValueProperty=i.showLastValue,i.showStudyLastValueProperty=i.showLastValue),"showSeriesLastValue"in i&&(s.showSeriesLastValueProperty=!0),"showStudyLastValue"in i&&(s.showStudyLastValueProperty=!0),(!this.isSnapshot()&&!this.readOnly()&&"showCurrency"in i||"showUnit"in i)&&((0,zi.migrateShowCurrencyAndShowUnitProperties)(i.showCurrency,i.showUnit),delete i.showCurrency,delete i.showUnit);{const{paneProperties:t}=e.chartProperties;t.vertGridProperties=t.vertGridProperties||(0,n.clone)(t.gridProperties),t.horzGridProperties=t.horzGridProperties||(0,n.clone)(t.gridProperties),t.horzGridProperties.style=t.vertGridProperties.style=fc.LINESTYLE_SOLID,"backgroundType"in t||(t.backgroundType=Yt.ColorType.Solid),"separatorColor"in t||(t.separatorColor=(0,L.getThemedColor)("color-chart-page-bg")),this._properties.childs().paneProperties.mergeAndFire(t)}this._properties.childs().scalesProperties.mergeAndFire(i),e.chartProperties.timezone&&this._properties.childs().timezone.setValue(e.chartProperties.timezone),
e.chartProperties.chartEventsSourceProperties&&this._properties.hasChild("chartEventsSourceProperties")&&this._properties.childs().chartEventsSourceProperties.mergeAndFire(e.chartProperties.chartEventsSourceProperties),e.chartProperties.tradingProperties&&this._properties.hasChild("tradingProperties")&&(void 0===e.chartProperties.tradingProperties.horizontalAlignment&&(e.chartProperties.tradingProperties.horizontalAlignment=(o=e.chartProperties.tradingProperties.lineLength)<=40?di.TradedGroupHorizontalAlignment.Right:o>=60?di.TradedGroupHorizontalAlignment.Left:di.TradedGroupHorizontalAlignment.Center),this._properties.childs().tradingProperties.mergeAndFire(e.chartProperties.tradingProperties)),this._timeScale.restoreState(e.timeScale,t),this._updateDateTimeFormatter()}var o;if(e.timeScale&&this._timeScale.restoreState(e.timeScale,t),!this.readOnly()){const t=this._getExceedingChildStudies(e.panes);if(t.length){for(let i=e.panes.length-1;i>=0;--i){const s=e.panes[i];for(let e=s.sources.length-1;e>=0;--e){const i=s.sources[e];~t.indexOf(i)&&s.sources.splice(e,1)}s.sources.length||s.mode!==K.PaneMode.Regular||e.panes.splice(i,1)}{const e=window.user.pro_plan,t="pro_premium_expert"===e||"pro_premium_expert_trial"===e;setTimeout((()=>(0,Ee.openPaywall)({feature:"studyOnStudy",isMaxPlan:t})),500)}}}const r=e.version||0,l=e.panes;let c="_seriesId",h=1;for(const e of l){const t=e.sources.find((e=>"MainSeries"===e.type));if(t){c=t.id,t.state&&(h=t.state.style);break}}const d=!0,u=l[0];this.panes()[0].restoreState({state:u,withData:t,version:r,seriesId:c,settingsMigration:s,contentOverrides:i,restoreSilently:d,reason:2,targetSeriesStyle:h}),this.panes()[0].mainDataSource()||this.removePane(this.panes()[0]);let _=1;for(let o=1;o<e.panes.length;o++){const n=e.panes[o];if(0===n.sources.length&&(n.mode??K.PaneMode.Regular)===K.PaneMode.Regular){cd.logWarn("Empty pane detected - restoring is skipped. idx="+o+", state="+JSON.stringify(n));continue}const a=this.panes()[_]||this.createPane();a.restoreState({state:n,withData:t,version:r,seriesId:c,settingsMigration:s,contentOverrides:i,restoreSilently:d,reason:2,targetSeriesStyle:h}),a.mainDataSource()||a.mode()!==K.PaneMode.Regular?_+=1:this.removePane(a)}if(u.isCollapsed&&this._panes[0].collapsed().setValue(!0),e.chartProperties&&e.chartProperties.publishedChartsTimelineProperties){const i=this.publishedChartsTimelineSource();i&&i.restoreData(e.chartProperties.publishedChartsTimelineProperties,t)}this._invalidateBarColorerCaches();const p=this.dataSources();let m=0;for(let e=0;e<p.length;e++){const t=p[e];(0,Ut.isLineTool)(t)&&(m++,t.calcIsActualSymbol())}this.updateTimeScaleBaseIndex(),this.recalculateAllPanes((0,Ds.globalChangeEvent)()),this.fullUpdate(),this.syncLollipopSources();const g=(0,a.ensureNotNull)(this.mainPane());for(const e of this._barsMarksSources)this.detachSource(e),g.addDataSource(e,this._mainSeries.priceScale(),!0);let S=fn.TVLocalStorage.getItem("linetools_limit")||1e3
;return window.is_authenticated&&window.user&&window.user.settings&&(S=window.user.settings.linetools_limit||S),e.sessions&&this.sessions().restoreState(e.sessions,t),e.lineToolsGroups&&(this._lineToolsGroupModel=Jl.fromState(this,e.lineToolsGroups)),m>S&&m%100==0?{lines_limit_exceeded:!0,line_tools_count:m}:(this.panes().forEach((e=>this._dataSourceCollectionChanged.fire(e))),this._lineToolsGroupModel.fireChangedAll(),this._linkingGroupIndex.setValue(e.linkingGroup??null),this._restoringState=!1,{})}shouldBeSavedEvenIfHidden(){return this._shouldBeSavedEvenIfHidden}setShouldBeSavedEvenIfHidden(e){this._shouldBeSavedEvenIfHidden=e}externalTimeStamp(e){const t=this.mainSeries().syncModel();return this.timeScale().points().roughTime(e,t&&t.projectTime.bind(t))}syncLollipopSources(){this._lollipopSourcesWatcherLoader?.callFunction((()=>{null!==this._lollipopSourcesWatcher&&this._lollipopSourcesWatcher.syncSources()}))}restoreChartEvents(e){this._lollipopSourcesWatcherLoader?.callFunction((()=>{null!==this._lollipopSourcesWatcher&&this._options.chartEventsEnabled&&this._lollipopSourcesWatcher.restoreChartEvents(e)}))}recalcVisibleRangeStudies(e){if(this._recalcVRStudiesParams.reasons.add(e),this._mainSeries.isStarted()&&this._mainSeries.isCompleted()){const t=(0,a.ensureDefined)(pd.get(e)).adapter,i=Math.min(...Array.from(this._recalcVRStudiesParams.reasons).map((e=>(0,a.ensureDefined)(pd.get(e)))).filter((e=>e.adapter===t)).map((e=>e.timeout)));(0,a.ensureDefined)(this._recalcVisibleRangeStudiesImplDebouncedByAdapter.get(t)?.get(i))()}else this._recalcVisibleRangeStudiesImpl(this._recalcVRStudiesParams)}recalcColorStudies(e){this._recalcColorStudiesParams.force=this._recalcColorStudiesParams.force||Boolean(e),this._recalcColorStudiesImplDebounced()}recalcStudyBasedLineTools(){this.dataSources().forEach((e=>{(0,Gt.isStudyLineTool)(e)&&e.recalcStudyIfNeeded()}))}alertsWatcher(){return this._alertsWatcher}alertsCollection(){return this._alertsCollection.readonly()}showLegend(){return this._showLegendProperty}id(){return this._id}selectPointMode(){return this._crossHairSelectPointMode}cancelRequestSelectPoint(){this._crossHairSource.cancelRequestSelectPoint()}requestSelectPoint(e){return this._crossHairSource.requestSelectPoint(e)}onPointSelected(){return this._crossHairSource.onPointSelected()}recalculatePriceRangeOnce(){const e=this.mainSeries();for(const t of this._panes)for(const i of t.priceDataSources())i.symbolSource()===e&&i.disablePriceRangeReady()}invalidate(e){this._invalidateHandler?.(e)}appliedTimeFrame(){return this._appliedTimeFrame.appliedTimeFrame()}barsMarksSources(){return this._barsMarksSources}createSyncPoint(e,t){return(0,Xh.getDefault2Lazy)(this._syncPointCache,e.uniqueId,t.uniqueId,(()=>new ic(e,t)))}isAutoSaveEnabled(){return this._isAutoSaveEnabled}linkingGroupIndex(){return this._linkingGroupIndex}studyAwareDefaultRightOffset(){
return this._timeScale.usePercentageRightOffset().value()?this._timeScale.percentsToBarIndexLength(this.studyAwareDefaultRightOffsetPercentage()):Math.max(this._timeScale.defaultRightOffset().value(),this._cachedStudiesMaxOffset)}studyAwareDefaultRightOffsetPercentage(){return this._timeScale.usePercentageRightOffset().value()?Math.max(this._timeScale.defaultRightOffsetPercentage().value(),this._timeScale.barIndexLengthToPercents(this._cachedStudiesMaxOffset)):this._timeScale.barIndexLengthToPercents(this.studyAwareDefaultRightOffset())}clearAllStudies(){this.dataSources().forEach((e=>e.clearData?.()))}setTimeScaleAnimation(e,t){const i=ve.InvalidationMask.light(),s=this._timeScale;i.setTimeScaleAnimation(e,t??s.width()-s.indexToCoordinate(s.baseIndex())),this.invalidate(i)}stopTimeScaleAnimation(){this._timeScale.endScroll();const e=ve.InvalidationMask.light();e.stopTimeScaleAnimation(),this.invalidate(e)}lollipopSourcesOptions(){const e=this._options;return{chartEventsEnabled:!this._options.isSnapshot&&this._options.chartEventsEnabled,esdEnabled:e.esdEnabled,newsNotificationsEnabled:e.newsNotificationsEnabled,continuousContractSwitchesEnabled:e.continuousContractSwitchesEnabled,futuresContractExpirationEnabled:e.futuresContractExpirationEnabled,latestUpdatesEnabled:e.latestUpdatesEnabled}}onSymbolIntervalChanged(){return this._symbolIntervalChanged}setPriceAutoScale(e,t,i){e.setPriceAutoScale(t,i),this.invalidate(this._paneInvalidationMask(e,ve.InvalidationLevel.Light))}calculateDefaultTags(){return this.dataSources().reduce(((e,t)=>(t.tags&&e.push(...t.tags()),e)),[])}async withoutLineToolsSyncAction(e){try{this._lineToolsSyncBlock++,await e()}finally{this._lineToolsSyncBlock--}}symbolAliasService(){return this._symbolAliasService}chartFloatingTooltipVisible(){return this._undoModel.chartFloatingTooltipVisible()}chartFloatingTooltipActive(){return this._undoModel.chartFloatingTooltipActive()}_initAlertsList(){return this._alertsListPromise||(this._alertsListPromise=(0,ys.getChartAlertsFacade)().then((e=>{const t=e.createCollection((()=>this.mainSeries().interval()),(()=>this.mainSeries().actualSymbol()),(()=>this.mainSeries().proSymbol()));this._alertsCollection.setValue(t),t.alertAdded().subscribe(this,this._addAlertLabelToChart.bind(this)),t.alertRemoved().subscribe(this,this._removeAlertLabelFromChart.bind(this)),t.firstConditionAlertSeriesChanged().subscribe(this,(e=>{this._removeAlertLabelFromChart(e),this._addAlertLabelToChart(e)})),t.sync();const i=e=>{this.mainSeries().dataEvents().symbolResolved()[e](this,s),this.mainSeries().dataEvents().symbolError()[e](this,this._removeAllAlertLabelsFromChart),this.mainSeries().properties().childs().interval[e](this,s)},s=()=>{t?.sync()};return window.loginStateChange.subscribe(this,(()=>{t?.reset(),i(window.is_authenticated?"subscribe":"unsubscribe")})),window.is_authenticated&&i("subscribe"),t}))),this._alertsListPromise}_updateStudiesMaxOffset(){const e=Math.max(...this.allStudies().map((e=>e.maxOffset().value())));this._cachedStudiesMaxOffset=e
;const t=this._timeScale.rightOffset();if(t<0)return;if(e<=t)return;const i=this._timeScale.logicalRange();i?this._timeScale.zoomToBarsRange(i.left(),this._timeScale.baseIndex()+Math.max(this._timeScale.rightOffset(),e)):this._timeScale.setRightOffset(Math.max(t,e))}_updateBaseIndex(e,t){const i=this._timeScale,s=i.baseIndex(),o=i.logicalRange();if(null!==o&&t){const t=o.contains(s),r=e-s,n=t?null:i.rightOffset()-r;if(!this._options.shiftVisibleRangeOnNewBar&&t){const e=i.width()/i.barSpacing(),t=e/(e+r),s=Math.max(i.minBarSpacing(),i.barSpacing()*t);i.setBarSpacing(s)}null!==n&&i.setRightOffset(n)}i.setBaseIndex(e)}async _createLollipopSourcesWatcher(){{const e=this.lollipopSourcesOptions(),t=[e.esdEnabled,e.continuousContractSwitchesEnabled,e.futuresContractExpirationEnabled,e.latestUpdatesEnabled,e.chartEventsEnabled],s=(0,_.onWidget)(),o=this.isSnapshot();(t.some(Boolean)||!s||o)&&(await(0,Qe.studyMetaInfoRepository)().requestMetaInfo(),this._lollipopSourcesWatcherLoader=new yn.AsyncResourceWrapper(i.e(81605).then(i.bind(i,324550))),this._lollipopSourcesWatcherLoader.callFunction((e=>{this._lollipopSourcesWatcher=new e.LollipopSourcesWatcher(this)})))}}_updateDateTimeFormatter(){const e=Xl.dateFormatProperty.value(),t=this.onWidget()?void 0:sc.withWeekdayProperty.value();if(this._dateFormatter=new Yl.DateFormatter(e,t),this.mainSeries().isDWM())this._dateTimeFormatter=new Yl.DateFormatter(e,t),this._timeFormatter=new Sl.TimeFormatter((0,vl.getHourMinuteFormat)(fl.timeHoursFormatProperty.value()));else{const i=$.Interval.parse(this.mainSeries().interval()),s=(0,vl.getTimeFormatForInterval)(i,fl.timeHoursFormatProperty.value());this._dateTimeFormatter=new Zl.DateTimeFormatter({dateFormat:e,withWeekday:t,timeFormat:s,dateTimeSeparator:"   "}),this._timeFormatter=new Sl.TimeFormatter(s)}}_invalidationMaskForSource(e,t=ve.InvalidationLevel.Light){if(e===this.crosshairSource())return ve.InvalidationMask.cursor();if(this._watermarkSource===e)return this._paneInvalidationMask((0,a.ensureNotNull)(this.paneForSource(this.mainSeries())),t);if(-1!==this._allCustomSources.indexOf(e)){const e=new ve.InvalidationMask;return e.invalidateAll(t),e}if(!(0,_i.isDataSource)(e))return null;if(e.isMultiPaneEnabled())return new ve.InvalidationMask(t);const i=this.paneForSource(e);return null!==i?this._paneInvalidationMask(i,t):null}_paneInvalidationMask(e,t=ve.InvalidationLevel.Light){const i=new ve.InvalidationMask,s=this._panes.indexOf(e);return i.invalidateAllPane(s,t),i}_invalidationMaskForSourcePriceScale(e,t=ve.InvalidationLevel.Light){if(!(0,_i.isDataSource)(e))return new ve.InvalidationMask(t);const i=this.paneForSource(e);if(null===i)return null;let s=e.priceScale();if(null===s)return null;const o=this._panes.indexOf(i);let r=i.priceScalePosition(s);if("overlay"===r){const e=this._panes[o].defaultPriceScale();s=e,r=i.priceScalePosition(e)}const n=i.priceScaleIndex(s,r);if(void 0===n)return null;const a=new ve.InvalidationMask;return a.invalidatePriceScale(o,r,n,t),a}_removeCustomSource(e){const t=this._customSourcesMap.get(e)
;if(void 0===t)return void cd.logWarn(`Attempt to remove custom source which does not exist in the model - "${e}"`);cd.logNormal(`Removing custom source "${e}"`),this.selectionMacro((e=>{e.removeSourceFromSelection(t)})),this._hoveredSource===t&&this.setHoveredSource(null),this._customSourceBeingMoved===t&&this.setMovingCustomSource(null,null);const i=hd(this._bgCustomSources,t),s=hd(this._fgCustomSources,t),o=hd(this._topmostCustomSources,t),r=hd(this._allCustomSources,t);(0,a.assert)(i||s||o,"Source should be presented in one of the layers"),(0,a.assert)(r,"Source should be presented in the array"),this._customSourcesMap.delete(e),t.destroy()}_updateShowLegendProperty(){const e=this._properties.childs().paneProperties.childs().legendProperties.childs().showLegend,t=this._showLegendProperty;if(e.value())t.setValue(!0);else{for(const e of this._panes){let i=0;for(const s of e.priceDataSources())if(null!==s.statusView()&&(i++,i>=2))return void t.setValue(!1)}t.setValue(!0)}}_pointToPercentPosition(e,t){return{x:e.x/this._timeScale.width(),y:e.y/(0,a.ensureNotNull)((0,a.ensureNotNull)(t.mainDataSource()).priceScale()).height()}}_percentPositionToPoint(e,t){const i=e.x*this._timeScale.width(),s=e.y*(0,a.ensureNotNull)((0,a.ensureNotNull)(t.mainDataSource()).priceScale()).height();return new dt.Point(i,s)}_recalcVisibleRangeStudiesImpl(e){if(!this._mainSeries.isStarted()||!this._mainSeries.isCompleted())return void this._visibleRangeStudiesInputs.setValue(null);if(this.timeScale().isEmpty())return;const t=this.timeScale().visibleBarsStrictRange();if(null===t)return;const i=this._mainSeries.bars(),s=i.search(t.firstBar(),Wl.PlotRowSearchMode.NearestRight),o=i.search(t.lastBar(),Wl.PlotRowSearchMode.NearestLeft),r=i.lastIndex(),n=s?s.index:void 0,a=o?o.index:void 0,l=n===e.oldStartVisibleIndex,c=a===e.oldEndVisibleIndex,h=[di.RecalcVisibleRangeStudiesReason.SeriesRestart,di.RecalcVisibleRangeStudiesReason.SeriesCompleted,di.RecalcVisibleRangeStudiesReason.StudyCreation].some((t=>e.reasons.has(t)));l&&c&&!h||(e.reasons.clear(),e.oldStartVisibleIndex=void 0!==n?n:NaN,e.oldEndVisibleIndex=void 0!==a?a:NaN,this._visibleRangeStudiesInputs.setValue({firstVisibleBarTime:1e3*(s?.value[0]??0),lastVisibleBarTime:1e3*(o?.value[0]??0),subscribeRealtime:o?.index===r}))}_recalcColorStudiesImpl(e){const t=this.backgroundColorAtYPercentFromTop(.5),i=this.dark().value()?ai.colorsPalette["color-cold-gray-200"]:ai.colorsPalette["color-cold-gray-900"],s=t===e.oldBgColor,o=i===e.oldFgColor;if(s&&o&&!e.force)return;e.force=!1,e.oldBgColor=t,e.oldFgColor=i;const r=e.studies??this.priceDataSources();e.studies=void 0;for(const e of r)if((0,Nt.isStudy)(e)){const s=e.metaInfo().inputs.filter(wt.isStudyInputDependsOnChartColors),o=e.properties().childs().inputs;s.forEach((e=>{const s=e.id===wt.ChartColorDependentStudyInputNames.FgColor?i:t;o.childs()[e.id].setValueSilently(s)})),s.length>0&&o.fireChanged()}}_getAllSources(e,t=Sd){const i=[];for(const s of this._panes){const o=t(s);for(const t of o)e(t)&&i.push(t)}return i}
_invalidateBarColorerCaches(){this.mainSeries().invalidateBarColorerCache()}_addAlertLabelToChart(e){{if(!e.isAlertPresentOnTarget(ac.AlertChartDisplayTarget.Label))return;const t=e.firstConditionSeriesId();if(null===t)return;(0,a.ensureNotNull)(this.alertsWatcher()).addAlert(e,t)}}_removeAlertLabelFromChart(e){(0,a.ensureNotNull)(this.alertsWatcher()).removeAlert(e)}_removeAllAlertLabelsFromChart(){(0,a.ensureNotNull)(this.alertsWatcher()).removeAllAlertLabels()}_updateTimeScale(e){const{index:t,zoffset:i,values:s,indexDiffs:o,baseIndex:r,marks:n,clearFlag:a,clearTickMarks:l}=e;if(a){this._timeScale.reset();for(const e of this.dataSources())e.clearData?.()}if(o.length>0)for(const e of this.dataSources())e.moveData?.(o);const c=this._timeScale.indexToTimePoint(this._timeScale.baseIndex()),h=this._timeScale.canNormalize();this._timeScale.update(t,i,s,n,l||!1);const d=this._timeScale.points().range().value();let u="ChartModel.prototype._updateTimeScale("+t+","+i+","+s.length+","+o.length+","+n.length+","+a+")";if(u+="TimeScale: {first:"+(d?.firstIndex??null)+",last:"+(d?.lastIndex??null)+"}",null===r){this._timeScale.resetBaseIndex();const e=this._timeScale.rightOffset();this._timeScale.setRightOffset(Math.max(e,this._cachedStudiesMaxOffset))}else if(void 0!==r){const e=this._timeScale.indexToTimePoint(r),t=null!==c&&null!==e&&e>c;this._updateBaseIndex(r,t)}if(cd.logDebug(u),!h&&h!==this._timeScale.canNormalize())for(const e of this.dataSources())!(0,Ut.isLineTool)(e)||e.isFixed()||e.isSourceHidden()||e.processHibernate();for(const e of this.dataSources())e.updateAllViews({type:"data-source-change",sourceId:e.id(),clearData:!0});this.recalculateAllPanes((0,Ds.globalChangeEvent)()),this.lightUpdate()}_getAvailableCurrencies(){return this.currencyConversionEnabled()?(0,n.isArray)(this._availableCurrenciesList)?this._availableCurrenciesList:(null!==this._availableCurrenciesList||(this._availableCurrenciesList=(0,ze.respectAbort)(this._abortController.signal,this.chartApi().availableCurrencies()),this._availableCurrenciesList.then((e=>{this._destroyed||(this._availableCurrenciesList=e,this.fullUpdate())})).catch((e=>{cd.logWarn(`An error occurred while getting currencies config: ${e}`)}))),[]):[]}_getAvailableUnits(){return this.unitConversionEnabled()?this._availableUnitsObject instanceof Promise||null===this._availableUnitsObject?(null!==this._availableUnitsObject||(this._availableUnitsObject=(0,ze.respectAbort)(this._abortController.signal,this.chartApi().availableUnits()),this._availableUnitsObject.then((e=>{this._destroyed||(this._availableUnitsObject=e,this.fullUpdate())})).catch((e=>{cd.logWarn(`An error occurred while getting units config: ${e}`)}))),{}):this._availableUnitsObject:{}}_getAllAvailableMetrics(){return this.metricConversionEnabled()?(0,n.isArray)(this._allAvailableMetricsList)?this._allAvailableMetricsList:(null!==this._allAvailableMetricsList||(this._allAvailableMetricsList=(0,ze.respectAbort)(this._abortController.signal,this.chartApi().availableMetrics()),this._allAvailableMetricsList.then((e=>{
this._destroyed||(this._allAvailableMetricsList=e,this.fullUpdate())})).catch((e=>{cd.logWarn(`An error occurred while getting currencies config: ${e}`)}))),[]):[]}_getAvailablePriceSources(e){const t=this._availablePriceSourcesBySymbol.get(e);if(Array.isArray(t))return t;if((0,n.isPromise)(t))return[];const i=this.chartApi().availablePriceSources(e);return this._availablePriceSourcesBySymbol.set(e,i),i.then((t=>{this._destroyed||(this._availablePriceSourcesBySymbol.set(e,t),this.fullUpdate())})).catch((e=>{cd.logWarn(`An error occurred while getting price sources config: ${e}`)})),[]}_clearAvailablePriceSources(){this._availablePriceSourcesBySymbol.clear()}_onSymbolIntervalChanged(){this._symbolIntervalChanged.fire()}_getBackgroundColor(e){const t=this._properties.childs().paneProperties.childs();if(t.backgroundType.value()===Yt.ColorType.Gradient){const i=t.backgroundGradientStartColor.value(),s=t.backgroundGradientEndColor.value();return function(e,t,i){if((0,L.getCurrentTheme)().name===vn.StdTheme.Dark&&(0,W.isOnMobileAppPage)("any")&&(0,L.isStdThemedDefaultValue)("chartProperties.paneProperties.backgroundGradientStartColor",e,vn.StdTheme.Dark)&&(0,L.isStdThemedDefaultValue)("chartProperties.paneProperties.backgroundGradientEndColor",t,vn.StdTheme.Dark))return oc;return i?e:t}(i,s,Boolean(e))}const i=t.background.value();return function(e){if((0,L.getCurrentTheme)().name===vn.StdTheme.Dark&&(0,W.isOnMobileAppPage)("any")&&(0,L.isStdThemedDefaultValue)("chartProperties.paneProperties.background",e,vn.StdTheme.Dark))return oc;return e}(i)}_getBackgroundCounterColor(){const e=this.backgroundColor().value();return"black"===(0,ii.rgbToBlackWhiteString)((0,ii.parseRgb)(e),150)?"white":"black"}_updateBackgroundColor(){this._backgroundColor.setValue(this._getBackgroundColor()),this._backgroundTopColor.setValue(this._getBackgroundColor(!0))}_syncCrosshair(e){if(!this._isSettingsExternalPosition){const t=this._undoModel.mainSeries(),i=t.syncModel(),s=this._undoModel.crosshairSource(),o=s.pane;if(null!==i&&null!==o){const r={timeStamp:this._timeScale.points().roughTime(s.index,i.projectTime.bind(i)),syncSourceTarget:i.syncSourceTarget()};o.mainDataSource()===t&&(r.price=s.price,r.symbol=t.symbol()),this._undoModel.syncCrosshair(r,e)}this._phantomSourceContainer.onCursorPositionUpdated()}}_gotoTimeImpl(e,t){const i=this.timeScale(),s=this.mainSeries();let o;if(void 0!==e){if(this._scrollingState&&this._scrollingState.deferred.reject(),o=(0,gt.createDeferredPromise)(),!s.isDWM()){const t=s.symbolInfo();if(null!==t){const i=(0,a.ensureNotNull)(this.timezoneExceptExchange().value()),o=(0,c.cal_to_utc)((0,c.get_timezone)(i),new Date(e)),r=(0,Oc.createTimeToBarTimeAligner)(s.interval(),t)(o);e=(0,c.utc_to_cal)((0,c.get_timezone)(i),r).getTime()}}this._scrollingState={targetDate:e,deferred:o,targetPointAlignment:t.targetPointAlignment,autoscaleAfterScroll:t.autoscaleAfterScroll}}else{if(!this._scrollingState)return cd.logError("scrollTo called without an argument"),Promise.reject();e=this._scrollingState.targetDate,
o=this._scrollingState.deferred}if(void 0===i.tickMarks().minIndex)return o.resolve(void 0),o.promise;this.stopTimeScaleAnimation();let r=((e,o)=>{if((e=>(0,a.ensureNotNull)(i.tickMarks().indexToTime((0,a.ensureDefined)(i.tickMarks().minIndex))).valueOf()-e)(o)<0){let r=i.tickMarks().nearestIndex(o);const n=s.bars().lastIndex();if(null===n)return"no_data";r=Math.min(r,n);let l=(0,a.ensureNotNull)(i.tickMarks().indexToTime(r)).valueOf();for(;l<o&&r<n;)r++,l=(0,a.ensureNotNull)(i.tickMarks().indexToTime(r)).valueOf();if((0,a.ensureNotNull)(i.visibleBarsStrictRange()).contains(r)&&!t.alignIfTargetPointIsVisible)return"in_visible_range";if("none"!==e){const t=i.width();if("left"===e)i.scrollToBar(r);else{const e=i.indexToCoordinate(r),s=i.coordinateToFloatIndex(e-t/2);i.scrollToBar(s)}}return{timestamp:(0,a.ensureNotNull)(i.indexToTimePoint(r))}}return"no_data"})(this._scrollingState.targetPointAlignment,this._scrollingState.targetDate);if("no_data"===r){const t=(0,a.ensureDefined)(i.tickMarks().minIndex),o=(0,a.ensureNotNull)(i.visibleBarsStrictRange()),n=o.lastBar()-o.firstBar();if(s.requestMoreDataAvailable()){const t=i.tickMarks().estimateLeft(e);i.requestMoreHistoryPoints(Math.ceil(t+n/2))}else i.zoomToBarsRange(t-n/2,t+n/2),r={timestamp:(0,a.ensureNotNull)(i.indexToTimePoint(t)),eod:!0}}if("no_data"!==r&&"in_visible_range"!==r){if(this._scrollingState.autoscaleAfterScroll){const e=(0,a.ensureNotNull)(i.visibleBarsStrictRange()),t=(0,a.ensureNotNull)(i.logicalRange());for(const i of this.panes()){for(const s of i.leftPriceScales())s.recalculatePriceRange(e,t);for(const s of i.rightPriceScales())s.recalculatePriceRange(e,t)}}this.fullUpdate(),this._scrollingState=null,o.resolve(r)}return"in_visible_range"===r&&(o.reject("already visible"),this._scrollingState=null),o.promise}_setCorrectedPositionToCrosshair(e,t,i){this.crosshairSource().setPosition(e,t,i)}_selectionOperationAvailable(e){const t=this._selection.allSources();if(1===t.length){const[i]=t;if(!(0,_i.isDataSource)(i)&&i.selectionOperationAvailable)return i.selectionOperationAvailable(e)}return!0}_onSymbolSourceCollectionChanged(e){this._clearAvailablePriceSources(),this._recalcAdjustForDividendsAvailability(),this._recalcAllowedAdjustment(),this._symbolSourceCollectionChanged.fire(e)}_onPriceSourcesCollectionChanged(e){this._panes.some((e=>e.hasDataSource(this._mainSeries)))&&(this._studiesWV.setValue(this.allStudies()),this._studiesExcludeInternalWV.setValue(this.allStudies(!0)))}_unmergeAvailable(e){return e===this._mainSeries||(0,Nt.isStudy)(e)&&!e.isLinkedToSeries()&&e.showInObjectTree()}_getExceedingChildStudies(e){let t=[];for(let i=0;i<e.length;++i)t=t.concat(e[i].sources||[]);let i=0,s=1;s=(0,Ae.getConfig)("STUDY_ON_STUDY")?.child_limit??1;const o=[],r={};let n=0,a=1e6;for(;t.length&&--a;){const e=t[n];(e.ownerSource&&r[e.ownerSource]||!e.ownerSource)&&(r[e.id]=e,t.splice(t.indexOf(e),1),e.ownerSource&&(0,q.isStudyState)(e)&&e.state&&e.state.isChildStudy&&++i>s&&o.push(e)),n=(n+1)%t.length}return o}_sendTo(e,t){const i=new Map;e.forEach((e=>{
const t=this.paneForSource(e);if(!t)return;const s=this._panes.indexOf(t);i.has(s)||i.set(s,[]),i.get(s)?.push(e)}));for(const[e,s]of i.entries())t(this._panes[e],s);this.fullUpdate()}_initialiseInactivityGaps(){if(!(0,d.isFeaturesetEnabled)("inactivity_gaps"))return;this.createInactivityGaps();const e=async e=>{const t=this.customSourceForName("inactivityGaps");e?t.start():t.stop()};if(null===this._inactivityGapsWatchedValue){const t=this.properties().childs().inactivityGaps;this._inactivityGapsWatchedValue=convertPropertyToWatchedValue(t),this._inactivityGapsWatchedValue.subscribe((t=>{e(t)})),e(t.value())}}_getWidgetPane(e,t){const i=this._panes.find((e=>e.mode()===K.PaneMode.Widget));if(i)return i;const s=(0,a.ensureNotNull)(this.paneForSource(this._mainSeries)),o=this._panes.indexOf(s);let r=0,n=0;this._panes.forEach((e=>{e.collapsed().value()||(r+=e.height(),n+=e.stretchFactor())}));const l=this.createPane(e?o+1:o,void 0,void 0,K.PaneMode.Widget);if(r>t){const e=t*n/(r-t);l.setStretchFactor(e)}return l}}var bd=i(791401),yd=i(183651);var wd=i(35289),Cd=i(292188),Td=i(52623),Pd=i(587241);class Md extends m.UndoCommand{constructor(e,t,i,s){super(s),this._newSourcesMetrics=new Map,this._oldSourcesMetrics=new Map,this._showFade=!1,this._chartModel=e;const o=e.mainSeries();for(const e of t.seriesLikeSources()){if(!e.isVisible()||!e.isActingAsSymbolSource().value())continue;const t=i||(0,Q.symbolOriginalMetric)((0,a.ensureNotNull)(e.symbolInfo()),this._chartModel.metricConversionEnabled());this._newSourcesMetrics.set(e.id(),t),this._oldSourcesMetrics.set(e.id(),e.metric()),this._showFade=this._showFade||e===o&&e.metric()!==t}}redo(){this._applyMetrics(this._newSourcesMetrics)}undo(){this._applyMetrics(this._oldSourcesMetrics)}_applyMetrics(e){e.forEach(((e,t)=>{(0,a.ensureNotNull)(this._chartModel.dataSourceForId(t)).setMetric(e)})),this._chartModel.selectionMacro((e=>{e.clearSelection()})),this._showFade&&this._chartModel.undoModel().loadingScreen().show(!0)}}const xd=new P.TranslatedString("zoom",h.t(null,void 0,i(278565)));class Id extends m.UndoCommand{constructor(e,t,i,s,o,r){super(xd),this._barSpacing=null,this._rightBarsOffset=null,this._leftBarsOffset=null,this._priceMode=null,this._model=e,this._startBar=t,this._endBar=i,this._startPrice=s,this._endPrice=o,this._pane=r}redo(){const e=(0,a.ensureNotNull)(this._model.timeScale().visibleBarsStrictRange());this._leftBarsOffset=e.firstBar()-this._startBar,this._rightBarsOffset=e.lastBar()-this._endBar,this._barSpacing=this._model.timeScale().barSpacing(),this._priceMode=this._pane.defaultPriceScale().mode(),this._model.zoomToViewport(this._startBar,this._endBar,this._startPrice,this._endPrice,this._pane)}undo(){const e=this._model.timeScale(),t=this._pane.defaultPriceScale(),i=(0,a.ensureNotNull)(e.visibleBarsStrictRange());e.setBarSpacing((0,a.ensureNotNull)(this._barSpacing)),e.zoomToBarsRange(i.firstBar()+(0,a.ensureNotNull)(this._leftBarsOffset),i.lastBar()+(0,a.ensureNotNull)(this._rightBarsOffset)),t.setMode((0,a.ensureNotNull)(this._priceMode)),
t.recalculatePriceRange((0,a.ensureNotNull)(e.visibleBarsStrictRange()),(0,a.ensureNotNull)(e.logicalRange())),this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this._model.lightUpdate()}}const Ld=(0,l.getLogger)("Chart.ChartUndoModel"),Ad=new P.TranslatedString("zoom",h.t(null,void 0,i(278565)));class kd extends m.UndoCommand{constructor(e,t,i){super(Ad),this._baseCmd=e,this._zoomStack=t,this._inOut=i}undo(e){if(this._inOut){if(this._baseCmd!==this._zoomStack.head())return void Ld.logDebug("zoom stack inconsistency");this._baseCmd.undo(e),this._zoomStack.pop()}else this._baseCmd.redo(e),this._zoomStack.push(this._baseCmd)}redo(e){if(this._inOut)this._baseCmd.redo(e),this._zoomStack.push(this._baseCmd);else{if(this._baseCmd!==this._zoomStack.head())return void Ld.logDebug("zoom stack inconsistency");this._baseCmd.undo(e),this._zoomStack.pop()}}}const Ed=new P.TranslatedString("stop syncing drawing",h.t(null,void 0,i(488881)));class Dd extends m.UndoCommand{constructor(e,t){super(Ed,void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._model=e,this._sourceId=t.id(),this._linkKey=t.linkKey().value()}redo(){(0,a.ensureNotNull)(this._model.dataSourceForId(this._sourceId)).linkKey().setValue(null)}undo(){(0,a.ensureNotNull)(this._model.dataSourceForId(this._sourceId)).linkKey().setValue(this._linkKey)}}var Bd=i(153987);const Rd=new P.TranslatedString("restore defaults",h.t(null,void 0,i(129510)));class Vd extends m.UndoCommand{constructor(e,t,i=Rd,s=!0){super(i,void 0,s),this._chartModel=e;const o=t.pathToRoot();this._targetObj=(0,Bd.isRootPath)(o)?o:t,this._state=t.state()}redo({chartWidgetCollection:e}){(0,br.allowSavingDefaults)(!0),this._chartModel.restoreFactoryDefaults(this._getProperty(e)),(0,br.allowSavingDefaults)(!1)}undo({chartWidgetCollection:e}){(0,br.allowSavingDefaults)(!0),this._getProperty(e).mergeAndFire(this._state),(0,br.allowSavingDefaults)(!1),this._chartModel.mainSeries().onChartStyleChanged()}_getProperty(e){const t=this._targetObj;return"string"==typeof t?(0,Bd.propertyByPath)(e,t):t}}class Od extends Vd{constructor(e,t,i,s){super(e,t,i,s??!Lo.lineToolsDoNotAffectChartInvalidation)}redo(e){(0,br.allowSavingDefaults)(!0),this._getProperty(e.chartWidgetCollection).child("intervalsVisibilities")?.mergeAndFire(Qh.intervalsVisibilitiesDefaults),super.redo(e),(0,br.allowSavingDefaults)(!1)}}const Nd=new P.TranslatedString("restore study defaults",h.t(null,void 0,i(662903)));class Wd extends Od{constructor(e,t,i=Nd){super(e,t.properties(),i,!0),this._studyId=t.id()}redo(e){super.redo(e),this._chartModel.recalcColorStudies(!0),this._patchProperties()}undo(e){super.undo(e),this._chartModel.recalcColorStudies(!0),this._patchProperties()}_patchProperties(){{const e=this._chartModel.getStudyById(this._studyId);if(!e)throw new Error("Study is not defined");e.patchPropertiesAfterResetDefaults()}}}function Fd(e,t){return(0,br.extractState)(e,t.map((e=>e.path)))}const zd=new P.TranslatedString("apply chart theme",h.t(null,void 0,i(647656)));class Hd extends m.UndoCommand{constructor(e,t,i){
super(zd),this._model=e,t.sessions&&(this._newSessionProps=i?t.sessions:Fd(t.sessions,(0,br.extractThemedColors)(ut.lightTheme.content.sessions,ut.darkTheme.content.sessions))),el(t.mainSourceProperties.candleStyle),el(t.mainSourceProperties.hollowCandleStyle),el(t.mainSourceProperties.haStyle);const s=t;s.chartProperties=s.chartProperties??{paneProperties:{},scalesProperties:void 0};const o=s.chartProperties.paneProperties.gridProperties;s.chartProperties.paneProperties.vertGridProperties=s.chartProperties.paneProperties.vertGridProperties??o,s.chartProperties.paneProperties.horzGridProperties=s.chartProperties.paneProperties.horzGridProperties??o;const r=this._model.properties().state().paneProperties.legendProperties;delete r.backgroundTransparency;const n=s.chartProperties.paneProperties;i&&(n.legendProperties={...n.legendProperties,...r});const a=(0,an.default)((0,En.factoryDefaults)("chartproperties"));if(delete a.timezone,i){const e=a.paneProperties;e&&(delete e.topMargin,delete e.bottomMargin)}const l=(0,ci.deepExtend)({},a,t.chartProperties);this._newChartProps=i?l:Fd(l,(0,br.extractThemedColors)(ut.lightTheme.content.chartProperties,ut.darkTheme.content.chartProperties)),e.timeScale().preserveBarSpacing()&&"barSpacing"in this._newChartProps.scalesProperties&&delete this._newChartProps.scalesProperties.barSpacing,tl(t.mainSourceProperties.lineStyle),tl(t.mainSourceProperties.lineWithMarkersStyle),tl(t.mainSourceProperties.steplineStyle);const c=(0,En.factoryDefaults)("chartproperties.mainSeriesProperties"),h=(0,ci.deepExtend)({},c,t.mainSourceProperties);i&&(delete h.visible,delete h.symbol,delete h.shortName,delete h.timeframe,delete h.interval,delete h.currencyId,delete h.unitId,delete h.sessionId,delete h.esdBreaksStyle),this._newSeriesProps=i?h:Fd(h,(0,br.extractThemedColors)(ut.lightTheme.content.mainSourceProperties,ut.darkTheme.content.mainSourceProperties)),this._oldChartProps=i?e.properties().state():e.properties().themeState(),this._oldSeriesProps=i?e.mainSeries().properties().state():e.mainSeries().properties().themeState(),this._oldSessionProps=i?this._model.sessions().properties().state():this._model.sessions().properties().themeState()}undo(){this._merge(this._oldChartProps,this._oldSeriesProps,this._oldSessionProps),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales(),this._model.chartThemeLoaded()}redo(){this._merge(this._newChartProps,this._newSeriesProps,this._newSessionProps),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales(),this._model.chartThemeLoaded()}_merge(e,t,i){const s=this._model;(0,br.allowSavingDefaults)(!0);const o=s.properties(),r=s.mainSeries().properties(),n=s.sessions().properties();o.applyDefaultThemedProperties(A.watchedTheme.value()),o.mergeAndFire(e),o.saveDefaults(),"priceAxisProperties"in t&&s.mainSeries().priceScale().setMode({autoScale:t.priceAxisProperties?.autoScale,percentage:t.priceAxisProperties?.percentage,log:t.priceAxisProperties?.log,lockScale:t.priceAxisProperties?.lockScale}),
r.applyDefaultThemedProperties(A.watchedTheme.value()),r.loadThemeState(t),r.saveDefaults(),s.mainSeries().createPaneView(),s.mainSeries().invalidateBarStylesCache(),s.recalculateAllPanes((0,Ds.globalChangeEvent)()),i&&(n.applyDefaultThemedProperties(A.watchedTheme.value()),n.loadThemeState(i),n.saveDefaults()),s.fullUpdate(),(0,br.allowSavingDefaults)(!1)}}const Ud=new P.TranslatedString("change resolution",h.t(null,void 0,i(743341)));class Gd extends on{constructor(e,t,i){super(Ud,e,function(e,t){let i;const s=(0,Q.isRangeStyle)(e.style()),o=$.Interval.isRange(t);return!s&&o?i=11:s&&!o&&(i=(0,Q.getLastUsedStyle)()),{interval:t,style:i}}(e,t),i),this._resolution=t}canMerge(e){return e instanceof Gd&&e._resolution===this._resolution&&super.canMerge(e)}_showFade(e,t){return!0}}class jd extends y{constructor(){super(...arguments),this._firstRedo=!0}redo(){this._firstRedo||(0,u.muteLinkingGroup)(this._newValue,!0),(0,u.muteLinkingGroup)(this._oldValue,!0),super.redo(),this._firstRedo||(0,u.muteLinkingGroup)(this._newValue,!1),(0,u.muteLinkingGroup)(this._oldValue,!1),this._firstRedo=!1}undo(){(0,u.muteLinkingGroup)(this._newValue,!0),(0,u.muteLinkingGroup)(this._oldValue,!0),super.undo(),(0,u.muteLinkingGroup)(this._newValue,!1),(0,u.muteLinkingGroup)(this._oldValue,!1)}}var qd=i(489793);class $d extends m.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._stubDescriptor=(0,a.ensureNotNull)(t.getDescriptor())}redo(){this._chartModel.dataSourceForId(this._stubDescriptor.id)||this._chartModel.restoreStudyStub(this._stubDescriptor)}undo(){this._chartModel.removeStudyStub(this._stubDescriptor.id)}}class Kd extends m.UndoCommand{constructor(e,t,i){super(i,void 0,!Lo.lineToolsDoNotAffectChartInvalidation),this._source=e,this._newState=t,this._oldState=e.properties().state()}redo(){this._source.applyTemplate(this._newState)}undo(){this._source.applyTemplate(this._oldState)}}var Zd=i(148983),Yd=i(211948),Xd=i(286592),Jd=i(872687),Qd=i(766332),eu=i(345698);const tu=new P.TranslatedString("apply all chart properties",h.t(null,void 0,i(347585)));class iu extends m.UndoCommand{constructor(e){super(tu),this._trading=null,this._oldNoConfirmEnabled=null,this._oldShowOnlyRejectionNotifications=null,this._oldShowPricesWithZeroVolume=null,this._oldShowPricesWithSpread=null,this._oldOrderExecutedSoundEnabled=null,this._prevWatermarkPreferences=null,this._prevAlertLabelsPreferences=null,this._prevAlertNotificationsPreferences=null,this._model=e,this._trading=(0,jc.tradingService)(),null!==this._trading&&(this._oldNoConfirmEnabled=this._trading.noConfirmEnabled.value(),this._oldShowOnlyRejectionNotifications=this._trading.showOnlyRejectionNotifications.value(),this._oldShowPricesWithZeroVolume=this._trading.showPricesWith().zeroVolume.value(),this._oldShowPricesWithSpread=this._trading.showPricesWith().spread.value(),this._oldOrderExecutedSoundEnabled=this._trading.orderExecutedSoundParams.enabled.value()),this._defaultsPreferences=(0,Jh.defaultsPreferencesByWhiteList)(this._model,this._model.mainSeries()),
this._oldPreferences=e.preferences(),this._prevDateFormat=Xl.dateFormatProperty.value(),this._prevAlertLabelsPreferences=(0,eu.getLabelsSettingsProperty)().state(),this._prevAlertNotificationsPreferences=(0,eu.getNotificationsSettingsProperty)().state(),this._model.onWidget()||(this._prevWithWeekday=sc.withWeekdayProperty.value()),this._prevTimeHoursFormat=fl.timeHoursFormatProperty.value(),this._prevAddPlusButton=ih.addPlusButtonProperty.value(),this._prevShowOpenMarkerStatus=Zd.showMarketOpenStatusProperty.value(),this._prevCurrencyUnitMetricVisibility=(0,zi.currencyUnitMetricVisibilityProperty)().value(),this._prevAutoLogButtonsVisibility=(0,Hi.autoLogButtonsVisibilityProperty)().value(),this._prevNavigationButtonsVisibility=(0,Yd.property)().value(),this._prevPaneButtonsVisibility=(0,Xd.property)().value();const t=this._model.watermarkSource();null!==t&&(this._prevWatermarkPreferences=t.properties().state())}redo(){null!==this._trading&&(this._trading.noConfirmEnabled.setValue(!1),this._trading.showOnlyRejectionNotifications.setValue(!1),this._trading.showPricesWith().zeroVolume.setValue(!0),this._trading.showPricesWith().spread.setValue(!0),this._trading.orderExecutedSoundParams.enabled.setValue(!1),this._trading.orderExecutedSoundParams.volume.setValue(.5)),"Auto"===this._defaultsPreferences.mainSeries?.tpoStyle?.inputs?.rowSize&&delete this._defaultsPreferences.mainSeries.tpoStyle.inputs.ticksPerRow,this._model.applyPreferences(this._defaultsPreferences),this._model.updateScales(),(0,Xl.restoreDateFormatSettingsValue)(),(0,fl.restoreTimeHoursFormatSettingsValue)(),(0,ih.restoreAddPlusButtonSettingsValue)(),(0,Zd.restoreShowMarketOpenStatusProperty)(),(0,zi.restoreCurrencyUnitMetricVisibilitySettingsValue)(),(0,Hi.restoreAutoLogButtonsVisibilitySettingsValue)(),(0,Yd.restoreNavigationButtonsVisibilitySettingsValue)(),(0,Xd.restorePaneButtonsVisibilitySettingsValue)(),(0,sc.restoreWithWeekdaySettingsValue)(),(0,Qd.restoreShowOnScreenshotSettingsValue)(),(0,Jd.restoreShowNewsNotificationSettingsValue)(),(0,eu.restoreSettingsProperty)();const e=this._model.watermarkSource();null!==e&&e.restorePropertiesDefaults()}undo(){null!==this._trading&&(this._trading.noConfirmEnabled.setValue((0,a.ensureNotNull)(this._oldNoConfirmEnabled)),this._trading.showOnlyRejectionNotifications.setValue((0,a.ensureNotNull)(this._oldShowOnlyRejectionNotifications)),this._trading.showPricesWith().zeroVolume.setValue((0,a.ensureNotNull)(this._oldShowPricesWithZeroVolume)),this._trading.showPricesWith().spread.setValue((0,a.ensureNotNull)(this._oldShowPricesWithSpread)),this._trading.orderExecutedSoundParams.enabled.setValue((0,a.ensureNotNull)(this._oldOrderExecutedSoundEnabled))),this._model.applyPreferences(this._oldPreferences),this._model.updateScales(),Xl.dateFormatProperty.setValue(this._prevDateFormat),fl.timeHoursFormatProperty.setValue(this._prevTimeHoursFormat),Zd.showMarketOpenStatusProperty.setValue(this._prevShowOpenMarkerStatus),ih.addPlusButtonProperty.setValue(this._prevAddPlusButton),(0,
zi.currencyUnitMetricVisibilityProperty)().setValue(this._prevCurrencyUnitMetricVisibility),(0,Hi.autoLogButtonsVisibilityProperty)().setValue(this._prevAutoLogButtonsVisibility),(0,Yd.property)().setValue(this._prevNavigationButtonsVisibility),(0,Xd.property)().setValue(this._prevPaneButtonsVisibility),null!==this._prevAlertLabelsPreferences&&(0,eu.getLabelsSettingsProperty)().mergeAndFire(this._prevAlertLabelsPreferences),null!==this._prevAlertNotificationsPreferences&&(0,eu.getNotificationsSettingsProperty)().mergeAndFire(this._prevAlertNotificationsPreferences),this._model.onWidget()||sc.withWeekdayProperty.setValue(this._prevWithWeekday);const e=this._model.watermarkSource();null!==e&&null!==this._prevWatermarkPreferences&&e.properties().mergeAndFire(this._prevWatermarkPreferences)}}class su extends m.UndoCommand{constructor(e,t,i,s){super(i),this._property=e,this._newValue=t,this._model=s,this._priceScale=this._model.mainSeries().priceScale(),this._oldValue=this._property.value(),this._oldMode=this._priceScale.mode()}redo(){this._oldValue=this._property.value(),this._oldMode=this._priceScale.mode(),(0,br.allowSavingDefaults)(!0),this._priceScale.setMode({autoScale:!1,percentage:!1,log:!1}),this._property.setValue(this._newValue),(0,br.allowSavingDefaults)(!1),this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this._model.lightUpdate()}undo(){(0,br.allowSavingDefaults)(!0),this._property.setValue(this._oldValue),this._priceScale.setMode(this._oldMode),(0,br.allowSavingDefaults)(!1),this._model.recalculateAllPanes((0,Ds.viewportChangeEvent)()),this._model.lightUpdate()}}var ou=i(864350);class ru extends m.UndoCommand{constructor(e,t){var s,o;super(new P.TranslatedString("apply all chart properties",h.t(null,void 0,i(347585)))),this._model=e,this._newProperties=t,s=(0,a.ensureDefined)(this._newProperties.mainSeries),o=(0,a.ensureDefined)(this._newProperties.paneProperties),["candleStyle","hollowCandleStyle","haStyle"].forEach((e=>{const t=s[e];void 0!==t&&(t.wickUpColor=t.wickUpColor||t.wickColor,t.wickDownColor=t.wickDownColor||t.wickColor)})),o.vertGridProperties=o.vertGridProperties||(0,ou.default)(o.gridProperties),o.horzGridProperties=o.horzGridProperties||(0,ou.default)(o.gridProperties),void 0===s.hollowCandleStyle&&(s.hollowCandleStyle=(0,ou.default)(s.candleStyle)),this._oldProperties=(0,Jh.preferencesByWhiteList)(e,e.mainSeries())}redo(){this._merge(this._newProperties),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales()}undo(){this._merge(this._oldProperties),this._model.mainSeries().onChartStyleChanged(),this._model.updateScales()}_merge(e){(0,br.allowSavingDefaults)(!0),this._model.applyPreferences(e),(0,br.allowSavingDefaults)(!1)}}class nu{constructor(e){this._leftScales=e.leftPriceScales().map((e=>e.id())),this._rightScales=e.rightPriceScales().map((e=>e.id()))}restorePane(e){this._leftScales.reverse().map((t=>(0,a.ensureNotNull)(e.getPriceScaleById(t)))).forEach((t=>e.movePriceScale(t,"left"))),this._rightScales.reverse().map((t=>(0,
a.ensureNotNull)(e.getPriceScaleById(t)))).forEach((t=>e.movePriceScale(t,"right")))}}class au extends m.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._targetStrategy=(0,fa.createPriceScaleSelectionStrategy)(t),this._initialState=e.panes().map((e=>new nu(e)))}redo(){this._chartModel.panes().forEach((e=>e.setPriceScaleSelectionStrategy(this._targetStrategy))),this._chartModel.fullUpdate()}undo(){const e=this._chartModel.panes();for(let t=0;t<e.length;t++)this._initialState[t].restorePane(e[t]);this._chartModel.fullUpdate()}}const lu=new P.TranslatedString("send {title} backward",h.t(null,{context:"undo command text"},i(828092))),cu=new P.TranslatedString("bring {title} forward",h.t(null,{context:"undo command text"},i(385504))),hu=new P.TranslatedString("insert {title} after {target}",h.t(null,{context:"undo command text"},i(617040))),du=new P.TranslatedString("insert {title} before {target}",h.t(null,{context:"undo command text"},i(740613))),uu=new P.TranslatedString("cut {title}",h.t(null,{context:"undo command text"},i(411818))),_u=new P.TranslatedString("cut sources",h.t(null,{context:"undo command text"},i(939717))),pu=new P.TranslatedString("remove {title}",h.t(null,{context:"undo command text"},i(445539))),mu=new P.TranslatedString("remove drawings group",h.t(null,{context:"undo command text"},i(122606))),gu=new P.TranslatedString("move scale",h.t(null,{context:"undo command text"},i(777577))),Su=new P.TranslatedString("stop syncing line tool(s)",h.t(null,{context:"undo command text"},i(693649))),vu=new P.TranslatedString("move drawing(s)",h.t(null,{context:"undo command text"},i(970105))),fu=new P.TranslatedString("load default drawing template",h.t(null,{context:"undo command text"},i(946929))),bu=new P.TranslatedString("apply factory defaults to selected sources",h.t(null,{context:"undo command text"},i(365874))),yu=new P.TranslatedString("change currency",h.t(null,{context:"undo command text"},i(189603))),wu=new P.TranslatedString("change unit",h.t(null,{context:"undo command text"},i(954891))),Cu=new P.TranslatedString("change metric",h.t(null,{context:"undo command text"},i(432124))),Tu=new P.TranslatedString("clone line tools",h.t(null,{context:"undo command text"},i(358))),Pu=new P.TranslatedString("merge up",h.t(null,{context:"undo command text"},i(555918))),Mu=new P.TranslatedString("merge down",h.t(null,{context:"undo command text"},i(721709))),xu=new P.TranslatedString("merge to pane",h.t(null,{context:"undo command text"},i(976815))),Iu=new P.TranslatedString("unmerge up",h.t(null,{context:"undo command text"},i(951847))),Lu=new P.TranslatedString("unmerge down",h.t(null,{context:"undo command text"},i(229417))),Au=new P.TranslatedString("unmerge to new bottom pane",h.t(null,{context:"undo command text"},i(69422))),ku=new P.TranslatedString("move {title} to new right scale",h.t(null,{context:"undo command text"},i(967935))),Eu=new P.TranslatedString("move {title} to new left scale",h.t(null,{context:"undo command text"
},i(793533))),Du=new P.TranslatedString("make {title} no scale (Full screen)",h.t(null,{context:"undo command text"},i(500843))),Bu=new P.TranslatedString("reset scales",h.t(null,{context:"undo command text"},i(407161))),Ru=new P.TranslatedString("create {tool}",h.t(null,{context:"undo command text"},i(749016))),Vu=new P.TranslatedString("paste {title}",h.t(null,{context:"undo command text"},i(708908))),Ou=new P.TranslatedString("insert {title}",h.t(null,{context:"undo command text"},i(965539))),Nu=new P.TranslatedString("remove pane",h.t(null,{context:"undo command text"},i(828253))),Wu=new P.TranslatedString("invert scale",h.t(null,{context:"undo command text"},i(779517))),Fu=new P.TranslatedString("toggle auto scale",h.t(null,{context:"undo command text"},i(388887))),zu=new P.TranslatedString("toggle lock scale",h.t(null,{context:"undo command text"},i(602497))),Hu=new P.TranslatedString("toggle regular scale",h.t(null,{context:"undo command text"},i(174640))),Uu=new P.TranslatedString("toggle indexed to 100 scale",h.t(null,{context:"undo command text"},i(871910))),Gu=new P.TranslatedString("toggle percentage scale",h.t(null,{context:"undo command text"},i(329841))),ju=new P.TranslatedString("toggle log scale",h.t(null,{context:"undo command text"},i(483995))),qu=new P.TranslatedString("move left",h.t(null,{context:"undo command text"},i(295204))),$u=new P.TranslatedString("move right",h.t(null,{context:"undo command text"},i(525643))),Ku=new P.TranslatedString("align to 45 degrees",h.t(null,{context:"undo command text"},i(231263))),Zu=new P.TranslatedString("set price scale selection strategy to {title}",h.t(null,{context:"undo command text"},i(547445))),Yu=new P.TranslatedString("remove all indicators",h.t(null,{context:"undo command text"},i(931719))),Xu=new P.TranslatedString("remove drawings",h.t(null,{context:"undo command text"},i(925963))),Ju=new P.TranslatedString("remove all indicators and drawing tools",h.t(null,{context:"undo command text"},i(2569))),Qu=new P.TranslatedString("turn line tools sharing off",h.t(null,{context:"undo command text"},i(692201))),e_=new P.TranslatedString("share line tools in layout",h.t(null,{context:"undo command text"},i(355407))),t_=new P.TranslatedString("share line tools globally",h.t(null,{context:"undo command text"},i(102197))),i_=new P.TranslatedString("change linking group",h.t(null,{context:"undo command text"},i(857223))),s_=new P.TranslatedString("apply drawing template",h.t(null,{context:"undo command text"},i(618386))),o_=(0,l.getLogger)("Chart.ChartUndoModel"),r_=(0,ke.isFeatureEnabled)("hide_tweet_drawingtool");function n_(e,t){return{bringForwardEnabled:e.bringForwardEnabled||t.bringForwardEnabled,bringToFrontEnabled:e.bringToFrontEnabled||t.bringToFrontEnabled,sendBackwardEnabled:e.sendBackwardEnabled||t.sendBackwardEnabled,sendToBackEnabled:e.sendToBackEnabled||t.sendToBackEnabled}}function a_(){return(0,D.drawOnAllCharts)().value()?1===(0,D.drawOnAllChartsMode)().value()?1:2:0}function l_(e,t){(0,_.onWidget)()?(0,Co.showGoToTradingViewReferralDialog)({
feature:"indicators"}):(0,To.showStudiesLimitGoProDialog)(e,t)}class c_ extends(ao()){constructor(e){super(),this._createLineCommands=[],this._scalePriceInfo=null,this._currentSourceMoveCommand=null,this._currentLineChangeCommand=null,this._currentCustomMoveCommand=null,this._zoomStack=new v,this._initialPriceScrollState=null,this._initialPriceScrollPos=null;const{chartWidget:t,chartSession:i,invalidateHandler:s,properties:o,seriesProperties:r,dataRequest:n,undoHistory:a,barsMarksContainersFactory:l,options:c,hibernateVW:h,linkingGroupWV:d,isAutoSaveEnabled:u,drawTime:_}=e;this._chartWidget=t,this.m_model=new fd({chartSession:i,invalidateHandler:s,properties:o,seriesProperties:r,dataRequest:n,undoModel:this,barsMarksContainersFactory:l,options:c,hibernateVW:h,linkingGroupWV:d,isAutoSaveEnabled:u,symbolAliasService:t.chartWidgetCollection().symbolAliasService(),drawTime:_}),this._undoHistory=a,this._lineToolsGroupController=new Gr({model:this._model.bind(this),pushUndoCommand:this._pushUndoCommand.bind(this),beginUndoMacro:e=>{this._undoHistory.beginUndoMacro(e)},endUndoMacro:this._undoHistory.endUndoMacro.bind(this._undoHistory),emitEvent:this.emitEvent.bind(this)})}id(){return this._model().id()}undoHistory(){return this._undoHistory}setWatchedValue(e,t,i){this._undoHistory.setWatchedValue(e,t,i)}lineToolsGroupController(){return this._lineToolsGroupController}mergeAllScales(e){!function(e,t){e.beginUndoMacro("left"===t?Po:Mo),e.model().panes().forEach((i=>{const s="left"===t?i.visibleRightPriceScales():i.visibleLeftPriceScales(),o=("left"===t?i.visibleLeftPriceScales():i.visibleRightPriceScales()).concat(s),r="overlay"===i.priceScalePosition(i.defaultPriceScale())?o[0]:i.defaultPriceScale();e.movePriceScale(i,r,t,0),o.forEach((t=>{if(t===r)return;let s=t.mainSource();for(;null!==s;){e.moveToScale(s,i,r,null,!0);const o=t.mainSource();if(o===s){xo.logError("Loop detected while trying to merge scales");break}s=o}}))})),e.endUndoMacro(),e.model().fullUpdate()}(this,e)}movePriceScale(e,t,i,s){const o=new Io(this._model(),e,t,i,s,gu);this._pushUndoCommand(o)}createLineTool({pane:e,point:t,linetool:i,properties:s,linkKey:o,ownerSource:r,synchronizationMode:n=co.CreateLineToolSyncMode.Default,sharingMode:l=a_(),id:c,actionSource:h}){const d=qd.lineToolsStudyIds[i];if((0,a.assert)(!(0,se.isStudyLineToolName)(d)||!!d),d){const e=this.canCreateStudy({id:d});if(!e.success)return l_(this.model(),e),(0,se.isStudyLineToolName)(D.tool.value())&&(0,D.resetToCursor)(),null}const u=Ru.format({tool:new P.TranslatedString(i,Go.lineToolsLocalizedNames[i])});this.beginUndoMacro(u);const _=n!==co.CreateLineToolSyncMode.ForceOff,p=new qo({model:this._model(),pane:e,lineTool:i,ownerSource:r||(0,a.ensureNotNull)(e.mainDataSource()),drawOnAllChartsMode:l,id:c}),m=p.startCreatingLine(t,s,o||null,l,n===co.CreateLineToolSyncMode.ForceOff,h),g=(0,a.ensureNotNull)(p.line());this._createLineCommands.unshift(p);let S=null;if(m&&(_&&this.finishLineTool(g),this._pushUndoCommand(p),this._createLineCommands.shift(),S={points:g.normalizedPoints(),
interval:this.mainSeries().interval()}),(void 0===o&&n===co.CreateLineToolSyncMode.Default&&(0,D.drawOnAllCharts)().value()||n===co.CreateLineToolSyncMode.ForceOn)&&g.isSynchronizable()){const e=(0,a.ensureNotNull)(this.model().externalTimeStamp(t.index)),s={point:{price:t.price,timeStamp:e},linetool:i,properties:g.properties(),symbol:this.mainSeries().symbol(),model:this.model(),linkKey:(0,a.ensureNotNull)(g.linkKey().value()),finalState:S,id:g.id(),sharingMode:g.sharingMode().value()};g.isFixed()&&(s.pointPositionPercents=g.calcPositionPercents()),(0,D.createLineTool)(s)}return this.endUndoMacro(),g}continueCreatingLine(e,t,i,s){const o=(0,a.ensureDefined)(this._createLineCommands[0]);this.beginUndoMacro(o.text());const r=(0,a.ensureNotNull)(this._model().lineBeingCreated()),n=o.continueCreatingLine(e,t,i,s);let l=null;if(n&&(this.finishLineTool(r),this._pushUndoCommand(o),this._createLineCommands.shift(),l={points:r.normalizedPoints(),interval:this.mainSeries().interval()}),o.drawOnAllCharts()&&r.isSynchronizable()){const i=(0,a.ensureNotNull)(this._model().externalTimeStamp(e.index));(0,D.continueLineTool)({point:{price:e.price,timeStamp:i},envState:t,finalState:l,model:this._model()})}return this.endUndoMacro(),n}continueExternalLine(e,t,i){const s=(0,a.ensureDefined)(this._createLineCommands[0]),o=s.continueCreatingLine(e,t,i);return o&&(this._pushUndoCommand(s),this._createLineCommands.shift()),o}finishLineTool(e){this._model().finishLineTool(e)}cancelCreatingLine(){this.m_model.cancelCreatingLine()}lineBeingCreated(){return this.m_model.lineBeingCreated()}pasteImageAsLineTool(e,t,i,s){const o=this._model().timeScale(),r=o.width(),n=i.height(),l=i.defaultPriceScale(),c=(0,a.ensureNotNull)((0,a.ensureNotNull)(l.mainSource()).firstValue()),h={price:l.coordinateToPrice(n/2,c),index:o.coordinateToIndex(r/2)},d=(0,Ut.createLineToolProperties)(i.model().backgroundTheme().spawnOwnership(),"LineToolImage",!i.model().readOnly());void 0!==s&&d.childs().transparency.setValue(s);const u=(0,a.ensureNotNull)(l.mainSource());(0,Ut.prepareLineToolPropertiesByOwnerSource)(d,u);const _=this.createLineTool({pane:i,point:h,linetool:"LineToolImage",properties:d,actionSource:"Paste"});return _&&(_.setBlobImageUrl(t),this.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(_,null)})),e.then((e=>{_.properties().childs().url.setValue(e)})).catch((e=>{const t=_.linkKey().value(),i=this.model();null!==t&&(0,D.removeLineTool)({withUndo:!1,model:i,linkKey:t,symbol:_.symbol(),sourceTitle:new P.TranslatedString(_.name(),_.translatedType()),lineToolState:_.state(!1)}),i.removeSource(_)}))),_}loadRange(e){const t=this._model(),i=t.appliedTimeFrame().value();return(null===i||!uo(i,e))&&(this._pushUndoCommand(new Pr(t,e)),(0,N.emit)("timeframe_interval",e),!0)}mainSeries(){return this.m_model.mainSeries()}model(){return this.m_model}allUndoModels(){return this._chartWidget.chartWidgetCollection().chartModels().value()}publishedChartsTimelineSource(){return this.m_model.publishedChartsTimelineSource()}unlinkLines(e){
const t=this.model();this.beginUndoMacro(Su);for(const i of e)null!==i.linkKey().value()&&(0,D.removeLineTool)({withUndo:!0,model:this.model(),symbol:i.symbol(),linkKey:(0,a.ensureNotNull)(i.linkKey().value()),sourceTitle:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,i),lineToolState:i.state(!1),unlink:!0}),this._pushUndoCommand(new Dd(t,i));this.endUndoMacro()}zoomFromViewport(){const e=new kd((0,a.ensureDefined)(this._zoomStack.head()),this._zoomStack,!1);this._pushUndoCommand(e)}zoomToViewport(e,t,i,s,o){const r=new Id(this.m_model,e,t,i,s,o),n=new kd(r,this._zoomStack,!0);this._pushUndoCommand(n)}zoomStack(){return this._zoomStack}timeScale(){return this.m_model.timeScale()}selection(){return this.m_model.selection()}selectionMacro(e,t){return this.m_model.selectionMacro(e,t)}onSelectedSourceChanged(){return this.m_model.onSelectedSourceChanged()}onTagsChanged(){return this.m_model.onTagsChanged()}lineCancelled(){return this.m_model.lineCancelled()}hoveredSource(){return this.m_model.hoveredSource()}crosshairSource(){return this.m_model.crosshairSource()}activeStrategySource(){return this.m_model.activeStrategySource()}setProperty(e,t,i,s){if(e&&e.value()!==t){this.beginUndoMacro(i);const o=new wr.SetPropertyUndoCommand(e,t,i,this.m_model,!s);this._pushUndoCommand(o),this.endUndoMacro(),this.emitEvent("setProperty")}}setProperties(e,t,i,s=!0){this.beginUndoMacro(i),this.m_model.selectionMacro((()=>{for(let o=0;o<e.length;o++)this.setProperty(e[o],t[o],i,!s)})),this.endUndoMacro()}beginUndoMacro(e){return this._undoHistory.beginUndoMacro(e)}endUndoMacro(){this._undoHistory.endUndoMacro()}invertPriceScale(e){const t=e.properties().childs().isInverted;this.setProperty(t,!t.value(),Wu)}togglePriceScaleAutoScaleMode(e){const t={autoScale:!e.isAutoScale()};this.setPriceScaleMode(t,e,Fu)}togglePriceScaleLockScaleMode(e){const t={lockScale:!e.isLockScale()};this.setPriceScaleMode(t,e,zu)}togglePriceScalePercentageScaleMode(e){const t={percentage:!e.isPercentage()};this.setPriceScaleMode(t,e,Gu)}togglePriceScaleIndexedTo100ScaleMode(e){const t={indexedTo100:!e.isIndexedTo100()};this.setPriceScaleMode(t,e,Uu)}togglePriceScaleLogScaleMode(e){const t={log:!e.isLog()};this.setPriceScaleMode(t,e,ju)}setPriceScaleRegularScaleMode(e){this.setPriceScaleMode({log:!1,percentage:!1,indexedTo100:!1},e,Hu)}withMacro(e,t){const i=this.beginUndoMacro(e);try{t()}finally{this.endUndoMacro()}return i}dataSources(){return this.m_model.dataSources()}orderedDataSources(e){return this.m_model.orderedDataSources(e)}barsMarksSources(){return this.m_model.barsMarksSources()}removeAllDrawingTools(e){this.beginUndoMacro(Xu),this._removeAllDrawingToolsImpl(e),this.endUndoMacro()}removeAllStudiesAndDrawingTools(e){this.beginUndoMacro(Ju),this._removeAllDrawingToolsImpl(e),this._removeAllStudiesImpl(),this.endUndoMacro()}removeAllStudies(){this.beginUndoMacro(Yu),this._removeAllStudiesImpl(),this.endUndoMacro()}scrollChartByBar(e){if(!this.m_model.scrollEnabled())return;const t=e*this.m_model.timeScale().barSpacing()
;this.startScrollTime(0),this.scrollTimeTo(t),this.endScrollTime()}canZoomIn(){return this.model().canZoomIn()}canZoomOut(){return this.model().canZoomOut()}zoomOut(){const e=this.timeScale().width();this.canZoomOut()&&(0,_o.doAnimate)({to:e/5,onStep:e=>{this.startScaleTime(0),this.scaleTimeTo(e),this.endScaleTime()}})}zoomIn(){const e=this.timeScale().width();this.canZoomIn()&&(0,_o.doAnimate)({to:e/5,onStep:e=>{this.startScaleTime(e),this.scaleTimeTo(0),this.endScaleTime()}})}scrollChart(e){this.m_model.scrollEnabled()&&(this.startScrollTime(0),this.scrollTimeTo(e),this.endScrollTime())}startMovingSources(e,t,i,s){e.filter((e=>e.doesMovingAffectsUndo())).length&&(this._currentSourceMoveCommand=new Bo(this.model(),e,vu,!1)),this.model().startMovingSources(e,t,i,new Map,s)}moveSources(e,t){this.model().moveSources(e,new Map,t)}endMovingSource(e,t){this.model().endMovingSources(e,void 0,t),null!==this._currentSourceMoveCommand&&(this._currentSourceMoveCommand.saveNewState(),this._pushUndoCommand(this._currentSourceMoveCommand)),this._currentSourceMoveCommand=null}startChangingLinetool(e,t,i,s,o,r){this._currentLineChangeCommand=new Bo(this.model(),[e],e.changePointUndoText(s),!1),this.model().startChangingLinetool(e,t,i,s,o,r)}changeLinePoint(e,t){this.model().changeLinePoint(e,t)}alignToolTo45Degrees(e,t){const i=e.alignTo45DegreesPoints();i&&(this._pushUndoCommand(new Bo(this.model(),[e],Ku,!1)),this.model().alignTo45Degrees(e,t,i))}endChangingLinetool(e){this.model().endChangingLinetool(e),null!==this._currentLineChangeCommand&&(this._currentLineChangeCommand.saveNewState(),this._pushUndoCommand(this._currentLineChangeCommand)),this._currentLineChangeCommand=null}setChartStyleProperty(e,t,i){if(e.value()!==t){const s=Td.chartStylePermissions.get(t),o=()=>{this.beginUndoMacro(i);const s=new Cr(e,t,this.mainSeries(),i,this.model(),this._chartWidget);var o;this._pushUndoCommand(s),this.emitEvent("setChartStyleProperty"),o=e.value(),(0,fr.getTracker)().then((e=>{if(null!==e){const t=j.STYLE_SHORT_NAMES[o];e.trackChartStyle(t)}})),this.endUndoMacro()};s?(0,Pd.runOrGoPro)(o,s.feature,{feature:s.featureName}):o()}}setPriceAutoScale(e,t,i){this._pushUndoCommand(new Ss(this.m_model,e,t,t.state())),this.m_model.setPriceAutoScale(e,t,i)}setPriceScaleMode(e,t,i){if(!(0,r.default)(t.mode(),e)){const s=new mn(e,t,i,this.m_model);this._pushUndoCommand(s)}}setPriceScaleSelectionStrategy(e){const t=this.m_model.properties().childs();if(t.priceScaleSelectionStrategyName.value()===e)return;(0,_t.trackEvent)("Chart","Change PriceScale Selection Strategy");const i=Zu.format({title:e});this.beginUndoMacro(i),this.setProperty(t.priceScaleSelectionStrategyName,e,i);const s=new au(this.m_model,e,i);this._pushUndoCommand(s),this.endUndoMacro()}setScaleRatioProperty(e,t,i){if(e.value()!==t){const s=new su(e,t,i,this.m_model);this._pushUndoCommand(s)}}createUndoCheckpoint(){return this._undoHistory.createUndoCheckpoint()}undoToCheckpoint(e){this._undoHistory.undoToCheckpoint(e)}restorePropertiesForSource(e){(0,
Ut.isLineTool)(e)?this._restoreLineToolFactoryDefaults(e):this._restoreStudyFactoryDefaults(e)}restoreLineToolsFactoryDefaults(e){1===e.length?this._restoreLineToolFactoryDefaults(e[0]):(this.beginUndoMacro(bu),e.forEach((e=>this._restoreLineToolFactoryDefaults(e))),this.endUndoMacro())}restorePreferences(){const e=new iu(this.model());this._pushUndoCommand(e)}restoreState(e,t,i){return this.m_model.restoreState(e,t,i)}async clipboardCopy(e,t=this.selection().dataSources()){if(!(0,d.isFeaturesetEnabled)("datasource_copypaste"))return;const i=t.filter((e=>e.copiable()));if(0===i.length)return;for(const e of i)if((0,Nt.isStudy)(e)&&e.isChildStudy())throw new Error("Can not copy child study");const s=(0,go.clipboardDataForSources)(this._model().id(),i);return null!==s?e.write({app:JSON.stringify(s),text:s.title}):void 0}async clipboardCut(e,t=this.selection().dataSources()){if(!(0,d.isFeaturesetEnabled)("datasource_copypaste"))return;const i=t.filter((e=>e.copiable()));if(0===i.length)return;await this.clipboardCopy(e,i);const s=i.filter((e=>e.isUserDeletable()));if(0===s.length)return;const o=(1===s.length?uu:_u).format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,s[0])});this.beginUndoMacro(o),this.m_model.selectionMacro((()=>this.removeSources(s,!1,o)),!0),this.endUndoMacro()}async clipboardPaste(e,t){let i=null;if((0,d.isFeaturesetEnabled)("datasource_copypaste")&&(i=i||await e.read(),i.app)){const e=JSON.parse(i.app);if(null!==await this.pasteSourceFromClip(t,e))return}await this._processSpecialLineToolsContents(e,i,t)}applyStudyTemplate(e,t,i){const s=new Yr(this._model(),e,t,i);this.beginUndoMacro(s.text());const o=this.m_model.panes().reduce(((e,t)=>e.concat(t.sourcesByGroup().allWithoutMultipaneWithHidden().filter(Ut.isLineTool).filter((e=>e.ownerSource()!==this.m_model.mainSeries()&&(!e.supportsTargetSignature()||null===e.targetSignature()))))),[]);this.removeSources(o,!1,null),this._pushUndoCommand(s),this.endUndoMacro(),(0,N.emit)("load_study_template")}createStudyInserter(e,t,i={}){const{stubTitle:s,isOverlay:o}=i,r={createStudy:e=>{const{studyMetaInfo:i,inputs:s,stubToReplace:o,propsState:r,forceOverlay:n,parentSources:a,preferredPriceScale:l,allowChangeCurrency:c,allowChangeUnit:h,allowChangeMetric:d,paneSize:u,targetScaleMode:_,eventSource:p}=e;if(!this.checkIfFeatureAvailable(i,t))return o_.logNormal("Cannot insert study "+i.id),null;(0,_t.trackEvent)("studies","Study_"+i.id,i.description),"Compare@tv-basicstudies"===i.id&&(0,_t.trackEvent)("compare","symbol:"+s.symbol),o&&this.m_model.removeSource(o);const m=this._insertStudy(i,s,r,n,a,l,c,h,d,u,null,_,p);return m.study.then((e=>(0,N.emit)("study_event",e.id(),"create"))),m},storeFailedStub:e=>{this._storeFailedStub(e)}};void 0!==s&&(r.createStub=()=>this.m_model.insertStudyStub(s,o).id(),r.removeStub=e=>this.m_model.removeStudyStub(e));const n=new od(e,r);return n.setParentSources(t),n}applyLineToolTemplate(e,t,i){this.beginUndoMacro(i),this.saveLineToolState(e,i);const s=new Kd(e,t,i);this._pushUndoCommand(s),
this.saveLineToolState(e,i),this.endUndoMacro(),this.model().updateSource(e)}applyLineToolsTemplate(e){if("sources"in e){const{sources:t,data:i}=e;this.beginUndoMacro(s_);for(const e of t)this.applyLineToolTemplate(e,i,null);this.endUndoMacro()}else{const{properties:t,data:i}=e;i.intervalsVisibilities=(0,Xa.mergeIntervalVisibilitiesDefaults)(i.intervalsVisibilities),t.applyTemplate(i,t.factoryDefaults()),t.saveDefaults()}}replayStatus(){return this.m_model.replayStatus()}setReplayStatus(e){return this.m_model.setReplayStatus(e)}isInReplay(){return this.m_model.isInReplay()}getSymbolString(){return this.m_model.getSymbolString()}interval(){return this.m_model.interval()}onInReplayStateChanged(){return this.m_model.onInReplayStateChanged()}switchToReplay(e,t,i){this._undoHistory.clearStack(),this.m_model.switchToReplay(e,t,i)}switchToRealtime(){this._undoHistory.clearStack(),this.m_model.switchToRealtime()}canChangeResolution(e){return this.model().canChangeResolution(e)}canChangeSymbol(e){return this.model().canChangeSymbol(e)}onReplayModified(){return this.model().onReplayModified()}startCustomMoving(e,t,i){this._currentCustomMoveCommand=new _n(this.model(),e,t,i)}customMoveBeingProcessed(){return null!==this._currentCustomMoveCommand}processCustomMove(e){(0,a.ensureNotNull)(this._currentCustomMoveCommand).move(e)}endCustomMoving(){null!==this._currentCustomMoveCommand&&this._currentCustomMoveCommand.hasChanges()&&(this._pushUndoCommand(this._currentCustomMoveCommand),this._currentCustomMoveCommand=null)}state(e){return this.m_model.state(e)}panes(){return this.m_model.panes()}cloneLineTools(e,t){this.beginUndoMacro(Tu);const i=new Ao(this._model(),e,t,Tu);this._pushUndoCommand(i);const s=i.newIds().map((e=>(0,a.ensureNotNull)(this.model().dataSourceForId(e)))).filter((e=>0!==e.sharingMode().value()));return s.length&&this._model().copyToOtherCharts(s,!0),this.endUndoMacro(),this.emitEvent("cloneLineTools"),i.newIds()}removeSource(e,t,i){this.lineBeingCreated()!==e?this.removeSources([e],t,pu.format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e)}),i):this.cancelCreatingLine()}removeSelectedSources(){const e=this._model().selection().dataSources();if(!e.length)return;const t=(e.length>1?mu:pu).format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e[0])});this.removeSources(e,!1,t)}removeSources(e,t,i,s){s||(e=e.filter((e=>e.isUserDeletable())));const o=this._model(),r=o.lineToolsGroupModel();this.beginUndoMacro(i),o.selectionMacro((s=>{const n=new Map;e.forEach((e=>{if((0,Ut.isLineTool)(e)){const t=r.groupForLineTool(e);if(null!==t){const i=n.get(t)||[];i.push(e),n.set(t,i)}null!==e.linkKey().value()&&(0,D.removeLineTool)({withUndo:!0,model:this.model(),linkKey:(0,a.ensureNotNull)(e.linkKey().value()),symbol:this.model().mainSeries().symbol(),lineToolState:e.state(!1),sourceTitle:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e)})}}));const l=new ko.RemoveSourcesUndoCommand(o,e,i),c=l.removedIds();this._pushUndoCommand(l),
!t&&c.length>0&&(1===c.length?this.emitEvent("removeSource",[c[0]]):this.emitEvent("removeSources",[c]))}),!0),this.endUndoMacro()}async scrollToLineTool(e){const t=this.timeScale().logicalRange();if(null===t)return;const i=e.points().map((e=>e.index)),s=this.timeScale().points().range().value();if(null===s)return;let o=s.firstIndex;const r=s.lastIndex,l=t.length()/2;if(0===i.length||i.some((e=>t.contains(e))))return;const c=()=>{const t=e.points().map((e=>e.index)),i=t.filter((e=>e<=r)).reduce(((e,t)=>null===e?t:Math.max(e,t)),null);return null!==i?i:t.reduce(((e,t)=>Math.min(e,t)))};let h=c();if(o-l>h){const t=e.points().map((e=>e.time)).filter(n.notUndefined).map((e=>1e3*e));if(0===t.length)return;const i=t.reduce(((e,t)=>Math.min(e,t)),t[0]);await this.model().gotoTime(i),h=c();if((0,a.ensureNotNull)(this.timeScale().logicalRange()).contains(h))return;o=(0,a.ensureNotNull)(this.timeScale().points().range().value()).firstIndex}o-l>h&&this.mainSeries().setGotoDateResult({timestamp:(0,a.ensureNotNull)(this.timeScale().points().valueAt(o)),eod:!0});const d=this.timeScale().width()/2,u=this.timeScale().indexToCoordinate(h);this.model().stopTimeScaleAnimation(),this.model().setTimeScaleAnimation(new mo({from:0,to:d-u,duration:lo.dur,easing:lo.easingFunc.easeInOutCubic}))}mergeSourceUp(e){const t=new Fo.MergeUpUndoCommand(this._model(),e,Pu);this._mergeUnmergeSource(e,t)}mergeSourceDown(e){const t=new Fo.MergeDownUndoCommand(this._model(),e,Mu);this._mergeUnmergeSource(e,t)}mergeToPane(e,t,i){const s=this._model().panes().indexOf(t),o=new Fo.MergeToTargetPane(this._model(),e,s,xu,i);this._mergeUnmergeSource(e,o)}unmergeSourceUp(e){const t=new No(this._model(),e,Iu);this._withKeepWidgetPanePositionGuard((()=>this._mergeUnmergeSource(e,t)),t.text())}unmergeSourceDown(e){const t=new Oo(this._model(),e,Lu);this._withKeepWidgetPanePositionGuard((()=>this._mergeUnmergeSource(e,t)),t.text())}unmergeToNewBottomPane(e){const t=new Wo(this._model(),e,Au);this._mergeUnmergeSource(e,t)}moveLeft(){this.beginUndoMacro(qu),(0,_o.doAnimate)({to:this.m_model.timeScale().width()/5,onStep:e=>{this.startScrollTime(e),this.scrollTimeTo(0),this.endScrollTime()},onComplete:()=>{this.endUndoMacro()}})}moveRight(){this.beginUndoMacro($u),(0,_o.doAnimate)({to:this.m_model.timeScale().width()/5,onStep:e=>{this.startScrollTime(0),this.scrollTimeTo(e),this.endScrollTime()},onComplete:()=>{this.endUndoMacro()}})}availableZOrderOperations(e){const t=this._model().lineToolsGroupModel(),i=e.filter(Ut.isLineTool),s=i.map((e=>t.groupForLineTool(e)));(0,a.assert)(new Set(s).size<=1,"Cannot move line tools from different group");const o=0===s.length?null:s[0];let r={bringForwardEnabled:!1,bringToFrontEnabled:!1,sendBackwardEnabled:!1,sendToBackEnabled:!1};const n=new Set(i);for(const t of(0,zo.sortSources)(e)){if((0,Ut.isLineTool)(t)&&null!==o){const e=(0,zo.sortSources)(o.lineTools().filter((e=>!n.has(e)||e===t)));r=n_(r,{bringForwardEnabled:t!==e[e.length-1],bringToFrontEnabled:t!==e[e.length-1],sendBackwardEnabled:t!==e[0],sendToBackEnabled:t!==e[0]})
;continue}const e=(0,a.ensureNotNull)(this._model().paneForSource(t)).sourcesByGroup().allExceptSpecialSources();if(0===e.length)continue;const i=t.zorder(),s=e[0].zorder(),l=e[e.length-1].zorder();r=n_(r,{bringForwardEnabled:i!==l,bringToFrontEnabled:i!==l,sendBackwardEnabled:i!==s,sendToBackEnabled:i!==s})}return r}sendToBack(e){if(!this.availableZOrderOperations(e).sendToBackEnabled)throw new Error("Send to back operation is unavailable");let t=null;const i=e[0];if((0,Ut.isLineTool)(i)){const s=this._model().lineToolsGroupModel().groupForLineTool(i);if(null!==s){const i=s.lineTools();t=new cr(this.model(),(0,zo.sortSources)(e),i[0])}}null===t&&(t=new rr(this.model(),(0,zo.sortSources)(e))),this._pushUndoCommand(t),this.emitEvent("changeZOrder",[e])}bringToFront(e){if(!this.availableZOrderOperations(e).bringToFrontEnabled)throw new Error("Bring to front operation is unavailable");let t=null;const i=e[0];if((0,Ut.isLineTool)(i)){const s=this._model().lineToolsGroupModel().groupForLineTool(i);if(null!==s){const i=s.lineTools();t=new ar(this.model(),(0,zo.sortSources)(e),i[i.length-1])}}null===t&&(t=new or(this.model(),(0,zo.sortSources)(e))),this._pushUndoCommand(t),this.emitEvent("changeZOrder",[e])}sendBackward(e){if(!this.availableZOrderOperations(e).sendBackwardEnabled)throw new Error("Send backward operation is unavailable");const t=lu.format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e[0])});this._sendBackOrBringForward(t,(0,zo.sortSources)(e),((e,t)=>new dr(this.model(),e,t)))}bringForward(e){if(!this.availableZOrderOperations(e).bringForwardEnabled)throw new Error("Bring forward operation is unavailable");const t=cu.format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e[0])});this._sendBackOrBringForward(t,(0,zo.sortSources)(e),((e,t)=>new _r(this.model(),e,t)))}insertAfter(e,t){e=(0,zo.sortSources)(e);const i=hu.format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e[0]),target:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,t)});this._insertAfterOrBefore(i,e,t,(()=>new ar(this.model(),e,t)))}insertBefore(e,t){e=(0,zo.sortSources)(e);const i=du.format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e[0]),target:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,t)});this._insertAfterOrBefore(i,e,t,(()=>new cr(this.model(),e,t)))}detachToRight(e,t){(0,_t.trackEvent)("Chart","Move to new right scale");const i=ku.format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e)}),s=new sn.MoveToNewPriceScaleUndoCommand(this.model(),e,t,"right",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}detachToLeft(e,t){(0,_t.trackEvent)("Chart","Move to new left scale");const i=Eu.format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e)}),s=new sn.MoveToNewPriceScaleUndoCommand(this.model(),e,t,"left",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}detachNoScale(e,t){(0,
_t.trackEvent)("Chart","Make source no scale");const i=Du.format({title:(0,Ho.getTranslatedStringForSource)($o.TitleDisplayTarget.StatusLine,e)}),s=new sn.MoveToNewPriceScaleUndoCommand(this.model(),e,t,"overlay",i);this._pushUndoCommand(s),this.emitEvent("moveSource",[e])}moveToScale(e,t,i,s,o){(0,_t.trackEvent)("Chart","Move source to target scale"),this.beginUndoMacro(s);const r=new sn.MoveToExistingPriceScaleUndoCommand(this.model(),e,t,i,s),n=o?null:vo(e,i,this._model()),a=o?null:Ra(e,i,this._model()),l=o?null:Ic(e,i,this._model());this._pushUndoCommand(r),null!==n&&this.setPriceScaleCurrency(i,n),null!==a&&this.setPriceScaleUnit(i,a),null!==l&&this.setPriceScaleMetric(i,l),this.endUndoMacro(),this.emitEvent("moveSource",[e])}setLinkingGroupIndex(e){const t=this.model().linkingGroupIndex();this._undoHistory.beginUndoMacro(i_),this._pushUndoCommand(new jd(t,t.value(),e,i_)),this._model().setShouldBeSavedEvenIfHidden(!0),this._undoHistory.endUndoMacro()}startScrollPrice(e,t,i){t.isAutoScale()||(this._initialPriceScrollState=t.state(),this._initialPriceScrollPos=i,this._model().startScrollPrice(e,t,i))}scrollPriceTo(e,t,i){t.isAutoScale()||(this._initialPriceScrollState&&this._initialPriceScrollPos&&Math.abs(this._initialPriceScrollPos-i)>20&&(this._pushUndoCommand(new Ss(this.m_model,e,t,this._initialPriceScrollState,void 0,!1)),this._initialPriceScrollState=null,this._initialPriceScrollPos=null),this._model().scrollPriceTo(e,t,i))}endScrollPrice(e,t){t.isAutoScale()||(this._initialPriceScrollState=null,this._initialPriceScrollPos=null,this._model().endScrollPrice(e,t))}startScrollTime(e){this.model().startScrollTime(e)}scrollTimeTo(e){this.model().scrollTimeTo(e)}endScrollTime(){this.model().endScrollTime()}startScaleTime(e){this.model().startScaleTime(e)}scaleTimeTo(e){this.model().scaleTimeTo(e)}endScaleTime(){this.model().endScaleTime()}resetTimeScale(){this.model().resetTimeScale()}startScalePrice(e,t,i,s){this._scalePriceInfo={priceScaleState:t.state(),tryMergeConsecutiveScales:s},this.model().startScalePrice(e,t,i)}scalePriceTo(e,t,i){this.model().scalePriceTo(e,t,i)}endScalePrice(e,t){this.model().endScalePrice(e,t);const i=(0,a.ensureNotNull)(this._scalePriceInfo);(0,r.default)(i.priceScaleState,t.state())||this._pushUndoCommand(new Ss(this.model(),e,t,i.priceScaleState,i.tryMergeConsecutiveScales)),this._scalePriceInfo=null}startTwoPointsScalePrice(e,t,i,s,o){this._scalePriceInfo={priceScaleState:t.state(),tryMergeConsecutiveScales:o},this.model().startTwoPointsScalePrice(e,t,i,s)}twoPointsScalePriceTo(e,t,i,s){this.model().twoPointsScalePriceTo(e,t,i,s)}endTwoPointsScalePrice(e,t){this.model().endTwoPointsScalePrice(e,t);const i=(0,a.ensureNotNull)(this._scalePriceInfo);(0,r.default)(i.priceScaleState,t.state())||this._pushUndoCommand(new Ss(this.model(),e,t,i.priceScaleState,i.tryMergeConsecutiveScales)),this._scalePriceInfo=null}resetPriceScale(e,t){const i=t.state();this.model().resetPriceScale(e,t),(0,r.default)(i,t.state())||this._pushUndoCommand(new Ss(this.m_model,e,t,i))}rearrangePanes(e,t){
const i=this.m_model.panes()[e],s=new vr(this._model(),e,t);i.mode()===K.PaneMode.Widget?this._pushUndoCommand(s):this._withKeepWidgetPanePositionGuard((()=>this._pushUndoCommand(s)),s.text())}movePane(e,t){const i=this.m_model.panes()[e],s=new vr(this._model(),e,t);i.mode()===K.PaneMode.Widget?this._pushUndoCommand(s):this._withKeepWidgetPanePositionGuard((()=>this._pushUndoCommand(s)),s.text())}toggleCollapsedPane(e){const t=this.panes().findIndex((t=>t===e));t<0||this._pushUndoCommand(new bo(this._model(),t))}toggleMaximizedPane(e){this._pushUndoCommand(new wo(this._model(),e))}readOnly(){return this.m_model.readOnly()}checkIfFeatureAvailable(e,t){const i=t.length>0,s=(0,Cd.isFundamentalStudyMetaInfo)(e),o=this.canCreateStudy({id:e.id,child:i,fundamental:s});return!!o.success||(l_(this.model(),o),!1)}async pasteSourceFromClip(e,t,i){const s=t;if(!s||0===s.sources.length)return null;const o=e||(0,a.ensureNotNull)(this.model().paneForSource(this.mainSeries()));if(!s.sources.some((e=>"drawing"!==e.type||null!==o.clipboardLineToolOwnerSource(e.source.id))))return null;const r=Array.from(new Set(s.sources.filter(go.isLineToolClipboardData).map((e=>e.source.type))));await Promise.all(r.map((e=>(0,Ut.initLineTool)(e)))),this.beginUndoMacro(Vu.format({title:s.title}));const n=[],l=[];for(const t of s.sources)if("drawing"===t.type&&null!==o.clipboardLineToolOwnerSource(t.source.id)){const e=await this.pasteLineTool(o,t);l.push(e),n.push(e)}else"study"===t.type&&t.source&&t.source.metaInfo&&this.checkIfFeatureAvailable(new et.StudyMetaInfo(t.source.metaInfo),[])&&n.push(this.pasteStudy(t,i?e:void 0));return l.length&&this.selectionMacro((e=>{e.clearSelection(),l.forEach((t=>{e.addSourceToSelection(t,null)}))})),this.endUndoMacro(),n}async pasteLineTool(e,t,i,s){await(0,pi.ensureLineToolLoaded)(t.source.type),t.source.state.intervalsVisibilities=(0,Xa.mergeIntervalVisibilitiesDefaults)(t.source.state.intervalsVisibilities),(0,Xa.makeIntervalsVisibilitiesVisibleAtInterval)(t.source.state.intervalsVisibilities,this.model().mainSeries().intervalObj().value());const o=new Qr(this.model(),t,e,i,s);this._pushUndoCommand(o);const r=o.source();return o.needCopyToOtherCharts()&&this._model().copyToOtherCharts([r],!0),this.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(r,null)})),r}pasteStudy(e,t){const i=new hn(this.model(),e,t?.id());this._pushUndoCommand(i);const s=(0,a.ensureNotNull)(i.state()).id;return(0,N.emit)("study_event",s,"paste_study"),(0,a.ensureNotNull)(this._model().dataSourceForId(s))}removePane(e){const t=this.m_model.panes()[e].dataSources().slice();this.removeSources(t,!1,Nu)}createPane(e){return this.m_model.createPane(e)}setPriceScaleCurrency(e,t){const i=new en(this.m_model,e,t,yu);this._pushUndoCommand(i)}setPriceScaleUnit(e,t){const i=new tn(this.m_model,e,t,wu);this._pushUndoCommand(i)}setPriceScaleMetric(e,t){{const i=new Md(this.m_model,e,t,Cu);this._pushUndoCommand(i)}}setSymbol(e,t){e.symbolSameAsResolved(t)||this._pushUndoCommand(new nn(e,t,this._chartWidget))}setResolution(e,t){
$.Interval.isEqual(e.interval(),t)||this._pushUndoCommand(new Gd(e,t,this._chartWidget))}syncCrosshair(e,t){this._chartWidget.chartWidgetCollection().syncCrosshair(e,this._chartWidget.id(),t)}loadingScreen(){return this._chartWidget.screen}chartLoadTheme(e,t,i){const s=new Hd(this.model(),e,t);i?s.redo():this._pushUndoCommand(s)}isJustClonedChart(){return this._chartWidget.isJustClonedChart()}isMultipleLayout(){return this._chartWidget.isMultipleLayout()}addPaneStretchFactorUndoCommand(e,t,i,s){const o=new dn(this.model(),e,t,i,s);this._pushUndoCommand(o)}applyPreferences(e){{const t=new ru(this.m_model,e);this._pushUndoCommand(t)}}paneForSource(e){return this.m_model.paneForSource(e)}destroy(){this.m_model.destroy()}moveSelectedToolsLeft(){return this._moveSelectedTools(2)}moveSelectedToolsUp(){return this._moveSelectedTools(0)}moveSelectedToolsRight(){return this._moveSelectedTools(3)}moveSelectedToolsDown(){return this._moveSelectedTools(1)}insertStudyWithoutCheck(e,t,i,s){return this._insertStudy(e,t,{},!1,[],void 0,void 0,void 0,void 0,void 0,i??null,void 0,void 0,s)}saveLineToolState(e,t){this._pushUndoCommand(new Bo(this.m_model,[e],t))}resetScales(){this._model().stopTimeScaleAnimation(),this.beginUndoMacro(Bu),this.resetTimeScale();for(const e of this.m_model.panes()){for(const t of e.leftPriceScales())this.resetPriceScale(e,t);for(const t of e.rightPriceScales())this.resetPriceScale(e,t)}this.endUndoMacro(),this.m_model.recalculateAllPanes((0,Ds.viewportChangeEvent)())}shareLineTools(e,t){const i=0===t?Qu:1===t?e_:t_;this.withMacro(i,(()=>{0===t&&this.unlinkLines(e),e.forEach((i=>{const s=this.model().lineToolsGroupModel().groupForLineTool(i);if(s){const o=s.lineTools().some((e=>e.isSynchronizable()));s.lineTools().every((t=>e.includes(t)))&&(0===t||i.isSynchronizable()||!o)||this.lineToolsGroupController().excludeLineToolFromGroup(s,i)}this._pushUndoCommand(new Rr(i,t,this.model(),null))}))}))}canCreateStudy(e,t){return this.model().chartApi().canCreateStudy(e,t)}chartWidgetCollectionLock(){return this._chartWidget.chartWidgetCollection().lock}onSymbolIntervalChanged(){return this.m_model.onSymbolIntervalChanged()}paneBeingCreatedLineOn(){return this.m_model.paneBeingCreatedLineOn()}invalidate(e){this.m_model.invalidate(e)}setWidth(e){this.m_model.setWidth(e)}setPaneHeight(e,t){this.m_model.setPaneHeight(e,t)}dataSourceForId(e){return this.m_model.dataSourceForId(e)}lineBeingEdited(){return this.m_model.lineBeingEdited()}sourcesBeingMoved(){return this.m_model.sourcesBeingMoved()}gridSource(){return this.m_model.gridSource()}watermarkSource(){return this.m_model.watermarkSource()}mainSeriesScaleRatioProperty(){return this.m_model.mainSeriesScaleRatioProperty()}setHoveredSource(e,t){this.m_model.setHoveredSource(e,t)}setCurrentPosition(e,t,i,s){this.m_model.setCurrentPosition(e,t,i,s)}setAndSaveCurrentPosition(e,t,i,s){this.m_model.setAndSaveCurrentPosition(e,t,i,s)}version(){return this.m_model.version()}restart(){this.m_model.restart()}disconnect(){this.m_model.disconnect()}calculateDefaultTags(){
return this.m_model.calculateDefaultTags()}drawRightThere(e,t,i,s){if((0,se.isLineToolName)(e)){if(void 0===i){const e=this.crosshairSource(),s=this.model().magnet().align(e.price,e.index,t);i={index:e.index,price:s}}const o=this.createLineTool({point:i,linetool:e,pane:t,actionSource:s});o&&this.selectionMacro((e=>{e.clearSelection(),e.addSourceToSelection(o)}))}}unloadDataSources(){const e=this.model(),t=e.dataSources().filter((e=>(0,Nt.isStudy)(e)&&!Ft(e)||(0,Ut.isLineTool)(e)||(0,Nt.isStudyStub)(e)));(0,jr.removeAllSourcesWithDependencies)(e,t)}chartFloatingTooltipVisible(){return this._chartWidget.chartFloatingTooltipVisible()}chartFloatingTooltipActive(){return this.chartFloatingTooltipVisible()&&null!==this._chartWidget.activePaneWidget().value()}_model(){return this.m_model}_pushUndoCommand(e){this._undoHistory.pushUndoCommand(e)}_mergeUnmergeSource(e,t){this.beginUndoMacro(t.text());const i=(0,a.ensureNotNull)(this._model().paneForSource(e)),s=new Set(i.sourcesByGroup().lineSources().filter((t=>t.ownerSource()===e)));this._model().lineToolsGroupModel().groups().filter((e=>{const t=e.lineTools().some((e=>s.has(e))),i=e.lineTools().some((e=>!s.has(e)));return t&&i})).forEach((e=>{this._pushUndoCommand(new Eo.ExcludeLineToolsFromGroupUndoCommand(this._model(),e,e.lineTools()))})),this._pushUndoCommand(t),this.endUndoMacro()}_insertStudy(e,t,i,s,o,r,n,a,l,c,h,d,u,_){const p=Ou.format({title:e.description}),m=new pn.InsertStudyCommand({chartModel:this.model(),studyMetaInfo:e,inputs:t,props:i,addAsOverlay:s,parentSources:o,preferredPriceScale:r,allowChangeCurrency:n,allowChangeUnit:a,allowChangeMetric:l,paneSize:c,targetZOrder:h??null,targetScaleMode:d,studyId:_,undoText:p,eventSource:u});return this._pushUndoCommand(m),m.insertedStudy()}_storeFailedStub(e){const t=Ou.format({title:e.title()});this.beginUndoMacro(t);const i=new $d(this.model(),e,t);this._pushUndoCommand(i),this.endUndoMacro()}async _processSpecialLineToolsContents(e,t,i){if(t=t||await e.read(),window.user.id&&t.files){const e=Array.from(t.files).find(Cs.blobImageFilter);if(e){const t=URL.createObjectURL(e),s=(0,Cs.uploadImage)(e);return void 0===i&&(i=(0,a.ensureNotNull)(this._model().paneForSource(this.mainSeries()))),await(0,pi.ensureLineToolLoaded)("LineToolImage"),this.pasteImageAsLineTool(s,t,i),void await s}}t.text&&(window.user.id&&!r_&&(0,bd.isTwitterUrl)(t.text)?(0,bd.createTweetLineToolByUrl)(t.text,this,!0):window.user.id&&(0,wd.isIdeaUrl)(t.text)?(0,wd.createIdeaLineToolByUrl)(t.text,this,!0):async function(e,t,i){if(null===t.timeScale().logicalRange())return null;const s=t.mainSeries(),o=i??(0,a.ensureNotNull)(t.model().paneForSource(s)),r=o.defaultPriceScale(),n=(0,a.ensureNotNull)(r.mainSource()),l=t.timeScale(),c=(0,a.ensureNotNull)(n.firstValue()),h=l.coordinateToIndex(t.timeScale().width()/2),d=o.height()/2,u={price:r.coordinateToPrice(d,c),time_t:(0,a.ensureNotNull)(l.indexToTimePoint(h)),offset:0},_=o.newLineToolZOrder(!0),p=yd.LineToolText.createProperties(t.model().backgroundTheme().spawnOwnership()),m=p.state();p.destroy(),
m.text=e,m.interval=s.interval();const g={type:"drawing",source:{id:(0,ot.randomHashN)(6),zorder:_,type:"LineToolText",state:m,symbol:n.symbolSource().symbol(),ownerSource:n.id(),points:[u]},geometry:[],modelId:t.model().id(),centeredOnChart:!0},S=await t.pasteLineTool(o,g,!1,!1);R.setValue("hint.pasteText",!0,{forceFlush:!0})}(t.text,this,i))}_insertAfterOrBefore(e,t,i,s){const o=(0,a.ensureNotNull)(this._model().paneForSource(i));if(t.some((e=>(0,Ut.isLineTool)(e)&&this._model().paneForSource(e)!==o)))throw new Error("Cannot insert line tool after target on another pane");this.beginUndoMacro(e),t.forEach((e=>{(0,a.ensureNotNull)(this.model().paneForSource(e))!==o&&this.mergeToPane(e,o)}));const r=s();this._withKeepWidgetPanePositionGuard((()=>this._pushUndoCommand(r)),r.text()),this.emitEvent("changeZOrder",[t]),this.endUndoMacro()}_sendBackOrBringForward(e,t,i){const s=new Map;t.forEach((e=>{const t=(0,a.ensureNotNull)(this._model().paneForSource(e)),i=s.get(t)||[];i.push(e),s.set(t,i)})),this.beginUndoMacro(e),s.forEach(((e,t)=>{this._pushUndoCommand(i(t,e))})),this.endUndoMacro(),this.emitEvent("changeZOrder",[t])}_moveSelectedTools(e){const t=this.model().selection().lineDataSources().filter((e=>!e.isSourceHidden()));if(0===t.length)return!1;if((0,D.lockDrawings)().value())return!0;const i=this.timeScale().visibleBarsStrictRange();if(null===i)return!1;const s=function(e){const t=new Map;for(const i of e){const e=i.ownerSource();if(null===e)continue;let s=t.get(e);if(void 0===s){const o=e.priceScale(),r=e.priceStep(),n=e.firstValue();if(null===o||null===r||null===n)continue;if(null===o.priceRange())continue;s={sources:[],priceScale:o,priceStep:r,startPrice:i.points()[0].price,firstValue:n},t.set(e,s)}s.sources.push(i)}return t}(t);if(0===s.size)return!1;this.beginUndoMacro(vu);const o=i.firstBar(),r=this.timeScale().indexToCoordinate(o),n=o+(3===e?1:2===e?-1:0),a=this.timeScale().indexToCoordinate(n);return D.isDirectionalMovementActive.setValue(!0),s.forEach((t=>{const{startPrice:i,priceStep:s,priceScale:l,firstValue:c}=t,h=i+(0===e?s:1===e?-s:0),d=l.priceToCoordinate(i,c),u=l.priceToCoordinate(h,c),_={logical:{index:o,price:i},screen:new dt.Point(r,d)},p={logical:{index:n,price:h},screen:new dt.Point(a,u)};this.startMovingSources(t.sources,_,null),this.moveSources(p),this.endMovingSource(!1,!0)})),D.isDirectionalMovementActive.setValue(!1),this.endUndoMacro(),!0}_restoreStudyFactoryDefaults(e){const t=new Wd(this.m_model,e);this._pushUndoCommand(t)}_restoreLineToolFactoryDefaults(e){this.beginUndoMacro(fu),this.saveLineToolState(e,fu);const t=new Od(this.m_model,e.properties(),fu);this._pushUndoCommand(t),this.saveLineToolState(e,fu),this.endUndoMacro(),this.model().updateSource(e)}_removeAllDrawingToolsImpl(e,t){this.selectionMacro((()=>{this.lineBeingCreated()&&this.cancelCreatingLine();this.dataSources().filter(Ut.isLineTool).filter((e=>e.isActualSymbol()&&e.isUserDeletable())).filter((e=>!t||t===e.toolname)).filter((t=>e||!t.isLocked?.())).forEach((e=>this.removeSource(e,!1)))}),!0)}
_removeAllStudiesImpl(){const e=this.dataSources(),t=e.filter(Nt.isStudy).filter((e=>!e.isChildStudy()&&e.removeByRemoveAllStudies())),i=e.filter(Nt.isStudyStub);t.concat(i).forEach((e=>this.removeSource(e,!1)))}_withKeepWidgetPanePositionGuard(e,t){const i=this.m_model.panes().findIndex((e=>e.mode()===K.PaneMode.Widget)),s=this.m_model.panes().findIndex((e=>e.containsMainSeries()));if(-1===i||-1===s)return void e();const o=i>s;this.beginUndoMacro(t),e();const r=this.m_model.panes().findIndex((e=>e.mode()===K.PaneMode.Widget)),n=this.m_model.panes().findIndex((e=>e.containsMainSeries()));if(n!==s){const e=o?n+1:n;this.movePane(r,e>r?e-1:e)}this.endUndoMacro()}}var h_=i(305458),d_=i(741494),u_=i(42540);class __{constructor(){this._session={startDate:(new Date).toISOString(),url:window.location.href,entries:[]}}addPersistentLogEntry(e,t,i){this._session.entries.push({date:(new Date).toISOString(),level:t,message:e,category:i})}async getLastSessions(e){return[this._session]}pendingEntries(){return this._session.entries}}var p_=i(224079),m_=i(435730);const g_=h.t(null,void 0,i(742642));function S_(e){if("replaced_to_exchange"===e.type)return{text:g_,warningIcon:m_,warningType:"notaccurate",solutionId:Be.solutionIds.WHAT_IS_CBOE_BZX_EXCHANGE}}class v_{constructor(e){this._activeHint=null,this._deferredPromise=null,this._chart=e;e.model().mainSeries().dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved)}destroy(){this._destroyActiveHint();this._chart.model().mainSeries().dataEvents().symbolResolved().unsubscribe(this,this._onSymbolResolved)}_destroyActiveHint(){null!==this._activeHint&&(this._activeHint.destroy(),this._activeHint=null),this._deferredPromise=null}async _createHint(){if(null===this._deferredPromise){const e=(0,gt.createDeferredPromise)();this._deferredPromise=e,Promise.all([i.e(20576),i.e(48072),i.e(63470),i.e(33042),i.e(32387),i.e(36804)]).then(i.bind(i,781750)).then((t=>{e.resolve(new t.ChartWarningHintRenderer(this._chart))}))}return this._deferredPromise.promise}_onSymbolResolved(e){const t=function(e){const t=(0,p_.firstReplacedByBatsExchange)(e);return null!==t?{type:"replaced_to_exchange",exchange:t}:null}(e),i=t&&function(e){return`warning.noSubsc_${e.exchange}`}(t);if(null===t||null===i||Boolean(R.getBool(i)))return void this._destroyActiveHint();const s={...S_(t),onClose:()=>{R.setValue(i,!0,{forceFlush:!0}),this._destroyActiveHint()}};null!==this._activeHint?this._activeHint.show(s):this._createHint().then((e=>{this._activeHint=e,this._activeHint.show(s)}))}}var f_=i(109294),b_=i(102727);h.t(null,void 0,i(533956));class y_{constructor(e){this._lastResolvedSymbol=null,this._initialSymbolError=!1,this._chart=e,this._chart.withModel(this,this._connectToModel)}_generateDialogContent(e){const t=this._getProSymbol(),i=new URL("https://www.tradingview.com/chart/");i.searchParams.append("symbol",t),i.searchParams.append("utm_source","www.tradingview.com"),i.searchParams.append("utm_medium","widget"),i.searchParams.append("utm_campaign","chart"),i.searchParams.append("utm_term",t)
;return e.format({linkStart:`<a target="_blank" href="${i.toString()}">`,linkEnd:"</a>"})}async _showDialog(e){(await(0,b_.createNoticeDialog)({content:e})).open()}_revertSymbolChange(){const e=this._chart.defaultSymbol(),t=this._getProSymbol();let i;i=this._lastResolvedSymbol?this._lastResolvedSymbol.pro_name:e!==t?e:"AAPL",this._chart.setSymbol(i)}_getProSymbol(){return this._chart.model().mainSeries().proSymbol()}_getSymbol(){return this._chart.model().mainSeries().symbolInfo()}_connectToModel(){const e=this._chart.model().mainSeries();e.dataEvents().symbolError().subscribe(this,(()=>{null===this._lastResolvedSymbol&&(this._initialSymbolError=!0)}),!0),e.dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved)}_onSymbolResolved(){const e=null===this._lastResolvedSymbol&&!this._initialSymbolError,t=this._getSymbol();if(!(this._lastResolvedSymbol&&t&&this._lastResolvedSymbol.pro_name===t.pro_name)&&(0,ke.isFeatureEnabled)("enable_asx_symbol_restriction")&&!e&&"ASX"===t?.exchange){const e=h.t(null,void 0,i(367800)),t=this._generateDialogContent(e);return this._showDialog(t),void this._revertSymbolChange()}this._lastResolvedSymbol=this._getSymbol()}}function w_(){const e=window.widgetbar;if(e){const t=(0,a.ensureNotNull)(e.setPage("object_tree")),i=(0,a.ensureNotNull)(t.widget("object_tree"));(0,a.ensureDefined)(i.properties).setValue({selectedPage:"data-window"})}else;}const C_="tradedGroup:",T_=`${C_}PlaceOrder`,P_=`${C_}EditOrder`;var M_=i(318068);const x_=h.t(null,void 0,i(533956));class I_{constructor(e){this._lastResolvedSymbol=null,this._chart=e,this._chart.withModel(this,this._connectToModel)}_getPopupContent(){const e=this._getProSymbol(),t=new URL("https://www.tradingview.com/chart/");t.searchParams.append("symbol",e),t.searchParams.append("utm_source","www.tradingview.com"),t.searchParams.append("utm_medium","widget"),t.searchParams.append("utm_campaign","chart"),t.searchParams.append("utm_term",e);return x_.format({linkStart:`<a target="_blank" href="${t.toString()}">`,linkEnd:"</a>"})}_onPopupClosed(){const e=this._chart.defaultSymbol(),t=this._getSymbol();let i;i=this._lastResolvedSymbol?this._lastResolvedSymbol:e!==t?e:"AAPL",this._chart.setSymbol(i)}_getProSymbol(){return this._chart.model().mainSeries().proSymbol()}_getSymbol(){return this._chart.model().mainSeries().actualSymbol()}_connectToModel(){const e=this._chart.model().mainSeries();e.dataEvents().symbolResolved().subscribe(this,this._onSymbolResolved),e.dataEvents().symbolGroupNotPermitted().subscribe(this,this._onSymbolGroupNotPermitted),e.dataEvents().symbolNotPermitted().subscribe(this,this.show)}_onSymbolResolved(){this._lastResolvedSymbol=this._getSymbol()}_onSymbolGroupNotPermitted(){this.show()}}class L_ extends I_{show(){(0,b_.createNoticeDialog)({content:this._getPopupContent()}).then((e=>{e.on("destroy",this._onPopupClosed.bind(this)),e.open()}))}}var A_=i(391060),k_=i(118756);var E_=i(602699);var D_=i(753880);var B_=i(106401),R_=i(445250),V_=i(522232),O_=i(153069),N_=i(812087);var W_=i(742778),F_=i(248754)
;function z_(e){return e.hasModel()?e.model().mainSeries().proSymbol():e.symbolWV().value()}var H_=i(566232),U_=i(992847),G_=i(506353),j_=i(120660);const q_={};function $_(e){if(!window.widgetbar)return;const t=(0,a.ensureNotNull)(window.widgetbar.setPage("base")).widget("watchlist");t&&(t.widgetObject?e(t.widgetObject):(t.widgetStarted().unsubscribeAll(q_),t.widgetStarted().subscribe(q_,(t=>e(t.widgetObject)),!0)))}class K_ extends Vi.Action{constructor(e,t){super({actionId:"Chart.AddSymbolToWatchList",options:t={iconId:"Watchlist.AddSymbol",icon:N_.icons.get("Watchlist.AddSymbol"),hotkeyHash:O.Modifiers.Alt+87,statName:"AddToWatchlist",label:K_.formatLabel(e),onExecute:()=>this._execute(),...t}}),this.updateSymbol=this.updateSymbol.bind(this),this._symbol=e}destroy(){this._symbol=void 0,super.destroy()}prepare(){}static formatLabel(e){return h.t(null,void 0,i(579934)).format({symbol:(0,O_.safeShortName)(e)})}updateSymbol(e){this._symbol=e,this.update({label:K_.formatLabel(e)})}_execute(){const e=this._symbol;e&&(0,Jc.runOrSigninWithFeature)((()=>{$_((t=>{t?.addSymbols([e])}))}),{feature:"watchList",source:"add symbol to watchlist"})}}class Z_ extends K_{constructor(e,t){super(e.value(),t),this._symbolRef=(0,F.combine)((e=>e),e),this._symbolRef.subscribe(this.updateSymbol,{callWithLast:!0})}destroy(){this._symbolRef&&this._symbolRef.destroy(),this._symbolRef=null,super.destroy()}}class Y_ extends Z_{constructor(e,t){super((0,De.createSymbolOrAliasWV)(e.symbolWV().weakReference(),e.symbolInfoWV().weakReference(),e.chartWidgetCollection().symbolAliasService()).ownership(),{subItems:[new Vi.Loader("Loading")],...t}),this._hadSymbolOnInit=!1,this._isMobile=(0,B_.isMobile)(),this._onRequest=null,this._unsubscribe=null,this._chart=e,this._load()}prepare(){super.prepare(),this._hadSymbolOnInit=!1,this._isMobile=(0,B_.isMobile)(),this.update({subItems:[new Vi.Loader("Loading")]}),this._onRequest?.()}destroy(){this._unsubscribe?.(),this._chart=null,this._onRequest=null,super.destroy()}_execute(){(0,Jc.runOrSigninWithFeature)((()=>{$_((e=>{this._chart&&e?.addSymbols([z_(this._chart)])}))}),{feature:"watchList",source:"add symbol to watchlist"})}async _load(){const[e,t,s,o,r,{watchlistSortComparator:n},a]=await Promise.all([i.e(64644).then(i.t.bind(i,779474,19)),(0,
U_.initSymbolListService)(),Promise.all([i.e(58667),i.e(66831),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(74528),i.e(44589),i.e(32387),i.e(36295),i.e(53121),i.e(80056),i.e(99331),i.e(13349),i.e(26395),i.e(2243),i.e(25975),i.e(66503),i.e(19938)]).then(i.bind(i,607456)),Promise.all([i.e(58667),i.e(66831),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(74528),i.e(44589),i.e(32387),i.e(36295),i.e(53121),i.e(80056),i.e(99331),i.e(13349),i.e(26395),i.e(2243),i.e(25975),i.e(66503),i.e(19938)]).then(i.bind(i,715913)),Promise.all([i.e(29323),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(15365),i.e(19133),i.e(22066),i.e(18257),i.e(86834),i.e(48011),i.e(56752),i.e(60627),i.e(44589),i.e(92118),i.e(75649),i.e(63935),i.e(5246),i.e(26729),i.e(47139),i.e(31403),i.e(93807),i.e(25947),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(497),i.e(49515),i.e(66985),i.e(7558),i.e(49135),i.e(44591),i.e(11644),i.e(78399),i.e(24193),i.e(15215),i.e(24025),i.e(57435),i.e(69631),i.e(87410),i.e(25361),i.e(77141),i.e(69441),i.e(37929),i.e(28209),i.e(83986),i.e(27097),i.e(69883),i.e(87890),i.e(83175),i.e(81254),i.e(97118),i.e(38388),i.e(91130),i.e(20111),i.e(32387),i.e(36295),i.e(80915),i.e(53121),i.e(59982),i.e(25630),i.e(13349),i.e(3535),i.e(20560),i.e(8106),i.e(2243),i.e(25975),i.e(49486),i.e(45964),i.e(5424),i.e(96703),i.e(60493)]).then(i.bind(i,872672)),Promise.all([i.e(29323),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(15365),i.e(19133),i.e(22066),i.e(18257),i.e(86834),i.e(48011),i.e(56752),i.e(60627),i.e(44589),i.e(92118),i.e(75649),i.e(63935),i.e(5246),i.e(26729),i.e(47139),i.e(31403),i.e(93807),i.e(25947),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(497),i.e(49515),i.e(66985),i.e(7558),i.e(49135),i.e(44591),i.e(11644),i.e(78399),i.e(24193),i.e(15215),i.e(24025),i.e(57435),i.e(69631),i.e(87410),i.e(25361),i.e(77141),i.e(69441),i.e(37929),i.e(28209),i.e(83986),i.e(27097),i.e(69883),i.e(87890),i.e(83175),i.e(81254),i.e(97118),i.e(38388),i.e(91130),i.e(20111),i.e(32387),i.e(36295),i.e(80915),i.e(53121),i.e(59982),i.e(25630),i.e(13349),i.e(3535),i.e(20560),i.e(8106),i.e(2243),i.e(25975),i.e(49486),i.e(45964),i.e(5424),i.e(96703),i.e(60493)]).then(i.bind(i,472046)),Promise.all([i.e(29323),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(15365),i.e(19133),i.e(22066),i.e(18257),i.e(86834),i.e(48011),i.e(56752),i.e(60627),i.e(44589),i.e(92118),i.e(75649),i.e(63935),i.e(5246),i.e(26729),i.e(47139),i.e(31403),i.e(93807),i.e(25947),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(497),i.e(49515),i.e(66985),i.e(7558),i.e(49135),i.e(44591),i.e(11644),i.e(78399),i.e(24193),i.e(15215),i.e(24025),i.e(57435),i.e(69631),i.e(87410),i.e(25361),i.e(77141),i.e(69441),i.e(37929),i.e(28209),i.e(83986),i.e(27097),i.e(69883),i.e(87890),i.e(83175),i.e(81254),i.e(97118),i.e(38388),i.e(91130),i.e(20111),i.e(32387),i.e(36295),i.e(80915),i.e(53121),i.e(59982),i.e(25630),i.e(13349),i.e(3535),i.e(20560),i.e(8106),i.e(2243),i.e(25975),i.e(49486),i.e(45964),i.e(5424),i.e(96703),i.e(60493)]).then(i.bind(i,290170))])
;if(this._destroyed)return;const{store:l}=t;this._onRequest=()=>l.dispatch(s.getCustomWatchlistsThunk(null)),this._unsubscribe=l.subscribe((()=>{if(!this._chart)return;const t=l.getState();if(null===r.getCustomListsState(t).timestamp)return;const s=z_(this._chart),c=r.getCustomLists(t),{activeSymbolList:u}=t,_=c.find((e=>e.id===u?.id));this._hadSymbolOnInit||(this._hadSymbolOnInit=!!_&&_.symbols.includes(s));const p=(0,d.isFeaturesetEnabled)("multiple_watchlists")?c.filter((e=>e.id!==u?.id)).sort(n):[];let m=_?[_,...p]:p;m=m.filter((e=>!(0,j_.isDeletedSymbolsList)(e.id)));const g=m.map((t=>{const i=t.symbols.includes(s),r={shortcutHint:t.id===u?.id?(0,O.humanReadableHash)(O.Modifiers.Alt+87):void 0,invisibleHotkey:t.id===u?.id?i:void 0,doNotCloseOnClick:!0,onExecute:()=>{const e=i?o.removeSymbolsThunk(G_.WATCHLIST_WIDGET_ID,[s],t.id,!0):o.addSymbolsToCustomListThunk(G_.WATCHLIST_WIDGET_ID,t.id,[s]);t.id!==u?.id||window.is_authenticated||this._hadSymbolOnInit?l.dispatch(e):window.runOrSignIn((()=>{l.dispatch(e)}),{source:"Chart context menu"})}};return new Vi.Action({actionId:"Watchlist.Actions",options:{...r,label:t.name,checkable:!0,checked:i,statName:"AddToWatchlist"},customActionOptions:{...r,jsxLabel:e.createElement(a.ContextMenuWatchlistItem,{title:t.name,isChecked:i,isSmallSize:this._isMobile})}})})),S=new Vi.Action({actionId:"Watchlist.Create",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(87616))),statName:"CreateNewWatchlist",iconId:this._isMobile?"Watchlist.CreateNew":void 0,onExecute:()=>{(0,Pd.runOrGoPro)((()=>{l.dispatch(o.userCreateWatchlistThunk(null,{symbols:[s]}))}),"MULTIPLE_WATCHLISTS",{feature:"multipleWatchLists",featureLocation:"moveSymbolsToNew"})}}});this.update({subItems:[...g,new Vi.Separator,S]})}))}}var X_=i(849084),J_=i(746274);function Q_(e){return(0,X_.default)(e)&&"dialogClose"in e&&"function"==typeof e.dialogClose}async function ep(e){if(!window.is_authenticated)return{subItems:[],disabled:!0};const[t,s,o]=await Promise.all([Promise.all([i.e(74114),i.e(6425)]).then(i.bind(i,64906)),Promise.all([i.e(74114),i.e(6425)]).then(i.bind(i,496807)),Promise.all([i.e(74114),i.e(6425)]).then(i.bind(i,798111))]),r=await t.getThemeNames(),n=[],a=new Vi.Action({actionId:"Chart.Theme.SaveAs",options:{name:"theme-save-as",statName:"SaveThemeAs",label:(0,H_.appendEllipsis)(h.t(null,void 0,i(784741))),onExecute:async()=>{try{void 0!==await new Promise(((t,i)=>{s.showThemeSaveDialogAsync(e.model().model().template(),t,t,i)}))&&await tp(e)}catch(e){if(Q_(e))return void e.dialogClose();throw e}}}});return n.push(a),r&&r.length&&(n.length&&n.push(new Vi.Separator),r.forEach((i=>{const r=new Vi.Action({actionId:"Chart.Theme.Apply.Custom",options:{label:t.translateStdThemeName(i),checkable:!1,statName:"LoadTheme",onExecute:()=>{o.loadTheme(e.chartWidgetCollection(),{themeName:i,standardTheme:!1}).then((()=>{window.saver.saveChartSilently(),(0,_t.trackEvent)("GUI","Switch to custom theme")}))},toolbox:{type:J_.ToolboxType.Delete,action:async()=>{try{void 0!==await new Promise(((e,t)=>{
s.showRemoveThemeDialogAsync(i,e,e,t)}))&&await tp(e)}catch(e){if(Q_(e))return void e.dialogClose();throw e}}},showToolboxOnHover:!0}});n.push(r)}))),{subItems:n,disabled:0===n.length}}async function tp(e,t){t??=e.actions().applyColorTheme,t?.update(await ep(e))}var ip=i(199862),sp=i(37841),op=i(930871);var rp=i(727724);function np(e){const t=e.model().dataSources(),s=t.filter(rp.isLineTool).filter((e=>e.isActualSymbol()&&e.isUserDeletable())).length,o=t.filter(Nt.isStudy).filter((e=>e.removeByRemoveAllStudies())).length,r=h.t(null,{plural:"{amount} drawings",count:s,replace:{amount:s.toString()}},i(406485)),n=h.t(null,{plural:"{amount} indicators",count:o,replace:{amount:o.toString()}},i(141662));return{drawings:{label:h.t(null,{replace:{drawings:r}},i(145396)),disabled:0===s},studies:{label:h.t(null,{replace:{indicators:n}},i(128133)),disabled:0===o},all:{label:h.t(null,{replace:{drawings:r,indicators:n}},i(683208)),disabled:0===s&&0===o}}}var ap=i(835537),lp=i(952892);function cp(e){const t=e.options(),s={label:(0,H_.appendEllipsis)(ap.t(null,void 0,i(597770))),statName:"ChangeInterval",onExecute:()=>(0,lp.showChangeIntervalDialogAsync)({initVal:yr.linking.interval.value(),selectOnInit:!0})};return!(0,d.isFeaturesetEnabled)("show_interval_dialog_on_key_press")||t.readOnly||t.hideSymbolSearch||(s.shortcutHint=",",s.hotkeyGroup=e.hotkeys(),s.hotkeyHash=188),new Vi.Action({actionId:"Chart.Dialogs.ShowChangeInterval",options:s})}class hp extends Vi.Action{constructor(e,t=new H.WatchedValue(!1)){super({...e,options:{...e.options,checkable:!0,checked:t.value(),onExecute:()=>{this._wv.setValue(!this._wv.value())}}}),this._updateChecked=e=>{this.update({checked:e})},t.subscribe(this._updateChecked),this._wv=t}destroy(){this._wv.unsubscribe(this._updateChecked),super.destroy()}}
const dp=new P.TranslatedString("scale price chart only",h.t(null,void 0,i(231831))),up=new P.TranslatedString("stay in drawing mode",h.t(null,void 0,i(482118))),_p=new P.TranslatedString("hide marks on bars",h.t(null,void 0,i(477665))),pp=new P.TranslatedString("change symbol last value visibility",h.t(null,void 0,i(225900))),mp=new P.TranslatedString("change symbol previous close value visibility",h.t(null,void 0,i(594209))),gp=new P.TranslatedString("change previous close price line visibility",h.t(null,void 0,i(886911))),Sp=new P.TranslatedString("change symbol labels visibility",h.t(null,void 0,i(156108))),vp=new P.TranslatedString("change indicators and financials value labels visibility",h.t(null,void 0,i(624360))),fp=new P.TranslatedString("change indicators and financials name labels visibility",h.t(null,void 0,i(386335))),bp=new P.TranslatedString("change bid and ask labels visibility",h.t(null,void 0,i(141553))),yp=new P.TranslatedString("change bid and ask lines visibility",h.t(null,void 0,i(396049))),wp=new P.TranslatedString("change pre/post market price label visibility",h.t(null,void 0,i(576701))),Cp=new P.TranslatedString("change pre/post market price line visibility",h.t(null,void 0,i(176745))),Tp=new P.TranslatedString("change high and low price labels visibility",h.t(null,void 0,i(56987))),Pp=new P.TranslatedString("change high and low price lines visibility",h.t(null,void 0,i(184666))),Mp=(new P.TranslatedString("change average close price label visibility",h.t(null,void 0,i(51646))),new P.TranslatedString("change average close price line visibility",h.t(null,void 0,i(405352))),new P.TranslatedString("change countdown to bar close visibility",h.t(null,void 0,i(399254)))),xp=new P.TranslatedString("change plus button visibility",h.t(null,void 0,i(739087))),Ip=new P.TranslatedString("change session breaks visibility",h.t(null,void 0,i(146202))),Lp=new P.TranslatedString("change price line visibility",h.t(null,void 0,i(322912))),Ap=new P.TranslatedString("change timezone",h.t(null,void 0,i(131408)));function kp(e){const t=e.hotkeys(),s=e.model(),o=e.options(),r=e.properties(),n=new Vi.Action({actionId:"Chart.Series.PriceScale.ToggleInvertPriceScale",options:{label:h.t(null,void 0,i(15925)),statName:"Invert Scale",checkable:!0,onExecute:()=>s.invertPriceScale(s.mainSeries().priceScale()),hotkeyGroup:t,hotkeyHash:ht.Modifiers.Alt+73}}),a=new Vi.Action({actionId:"Chart.Series.PriceScale.ToggleAutoScale",options:{label:h.t(null,void 0,i(633752)),checkable:!0,onExecute:e=>{const t=s.mainSeries().priceScale();s.togglePriceScaleAutoScaleMode(t),e.update({checked:t.isAutoScale()})}}}),l=new Vi.Action({actionId:"Chart.Scales.ToggleLockPriceToBarRatio",options:{label:h.t(null,void 0,i(411768)),checkable:!0,statName:"ToggleLockScale",onExecute:()=>s.togglePriceScaleLockScaleMode(s.mainSeries().priceScale())}}),c=new Vi.Action({actionId:"Chart.Series.PriceScale.ToggleRegular",options:{label:h.t(null,{context:"scale_menu"},i(749179)),checkable:!0,statName:"ToggleRegularScale",onExecute:e=>{
const t=s.mainSeries().priceScale();s.setPriceScaleRegularScaleMode(t),e.update({checked:t.isRegular()})}}}),u=new Vi.Action({actionId:"Chart.Series.PriceScale.TogglePercentage",options:{label:h.t(null,void 0,i(155833)),checkable:!0,statName:"TogglePercantage",onExecute:()=>s.togglePriceScalePercentageScaleMode(s.mainSeries().priceScale()),hotkeyGroup:t,hotkeyHash:ht.Modifiers.Alt+80}}),p=new Vi.Action({actionId:"Chart.Series.PriceScale.ToggleIndexedTo100",options:{label:h.t(null,void 0,i(152054)),checkable:!0,statName:"ToggleIndexedTo100",onExecute:()=>s.togglePriceScaleIndexedTo100ScaleMode(s.mainSeries().priceScale())}}),m=new Vi.Action({actionId:"Chart.Series.PriceScale.ToggleLogarithmic",options:{label:h.t(null,void 0,i(503558)),statName:"ToggleLogScale",checkable:!0,onExecute:()=>s.togglePriceScaleLogScaleMode(s.mainSeries().priceScale()),hotkeyGroup:t,hotkeyHash:ht.Modifiers.Alt+76}}),g=new Vi.Action({actionId:"Chart.ChangeTimeZone",options:{label:h.t(null,void 0,i(224198)),statName:"TimeZone",onDestroy:()=>e.properties().childs().timezone.unsubscribeAll(g)}}),S=e.properties().childs().timezone,v=()=>{const t=[],i=Lt.availableTimezones,s=e=>e.id===S.value();i.forEach((i=>{const o=new Vi.Action({actionId:"Chart.ChangeTimeZone",options:{label:i.title,checkable:!0,checked:s(i),statName:"SetTimeZone",onExecute:()=>{e.model().setProperty(S,i.id,Ap)}}});t.push(o)})),g.update({subItems:t})};v(),S.subscribe(g,v);const f=new Ui.ActionWithStandardIcon({actionId:"Chart.TimeScale.Reset",options:{label:h.t(null,void 0,i(906436)),iconId:"Chart.Reset",statName:"ResetScale",onExecute:()=>s.resetTimeScale(),hotkeyGroup:e.hotkeys(),hotkeyHash:ht.Modifiers.Mod+ht.Modifiers.Alt+81}}),b=new Vi.Action({actionId:"Chart.Dialogs.ShowInsertIndicators",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(724909))),statName:"InsertIndicator",onExecute:()=>e.showIndicators(),...o.indicatorsDialogShortcutEnabled?{hotkeyGroup:t,hotkeyHash:191}:void 0}}),y=new Vi.Action({actionId:"Chart.Dialogs.ShowCompareOrAddSymbol",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(92244))),statName:"CompareOrAddSymbol",onExecute:()=>e.toggleCompareOrAdd()}}),w=new Ui.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowGeneralSettings",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(730586))),iconId:"Settings",statName:"ChartProperties",onExecute:()=>e.showGeneralChartProperties()}}),C=new Ui.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowGeneralSettings.SymbolTab",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(730586))),iconId:"Settings",statName:"MainSeriesProperties",onExecute:()=>e.showGeneralChartProperties(Rt.TabNames.symbol)}}),T=new Ui.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowGeneralSettings.ScalesTab",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(316018))),iconId:"Settings",statName:"ScalesProperties",onExecute:()=>e.showGeneralChartProperties(Rt.TabNames.scales)}}),P=new Vi.Action({actionId:"Chart.SelectedObject.ToggleLocked",options:{label:h.t(null,void 0,i(754310)),
statName:"ToggleLockSelectedObject",onExecute:()=>e.toggleLockSelectedObject()}}),M=new Ui.ActionWithStandardIcon({actionId:"Chart.SelectedObject.Hide",options:{label:h.t(null,void 0,i(769391)),iconId:"Chart.Hide",statName:"HideSelectedObject",onExecute:()=>e.hideSelectedObject()}}),x=new Ni({actionId:"Chart.PriceScale.ToggleAutoScaleSeriesOnly",options:{label:h.t(null,void 0,i(762145)),checkable:!0,statName:"ScalePriceChartOnly"}},{property:r.childs().scalesProperties.childs().scaleSeriesOnly,undoModel:s,undoText:dp}),I=new hp({actionId:"Chart.DrawingToolbar.ToggleVisibility",options:{label:h.t(null,void 0,i(623716)),statName:"ToggleDrawingToolbar"}},o.isDrawingToolbarVisible),A=new Ni({actionId:"",options:{label:h.t(null,void 0,i(876659)),checkable:!0,statName:"ToggleStayInDrawingMode"}},{property:D.properties().childs().stayInDrawingMode,undoModel:s,undoText:up}),k=new Ni({actionId:"Chart.Marks.ToggleVisibility",options:{label:h.t(null,void 0,i(139355)),checkable:!0,statName:"ToggleHideMarksOnBars"}},{property:D.hideMarksOnBars(),undoModel:s,undoText:_p,callback:e=>D.hideMarksOnBars().setValue(e.isChecked())}),E=new Ni({actionId:"Chart.PriceScale.Labels.ToggleSeriesLastValueVisibility",options:{label:h.t(null,void 0,i(179580)),checkable:!0,checked:!1,statName:"ToggleSymbolLastValue"}},{property:r.childs().scalesProperties.childs().showSeriesLastValue,undoModel:s,undoText:pp}),B=new Ni({actionId:"Chart.PriceScale.Labels.ToggleSymbolNameLabelsVisibility",options:{label:h.t(null,void 0,i(770437)),checkable:!0,checked:!1,statName:"ToggleSymbolLabels"}},{property:r.childs().scalesProperties.childs().showSymbolLabels,undoModel:s,undoText:Sp}),R=(0,Hl.combineProperty)(((e,t)=>e||t),r.childs().scalesProperties.childs().showStudyLastValue.weakReference(),r.childs().scalesProperties.childs().showFundamentalLastValue.weakReference()),V=new Ni({actionId:"Chart.PriceScale.Labels.ToggleIndicatorsValueLabelsVisibility",options:{label:h.t(null,void 0,i(342463)),checkable:!0,checked:!1,statName:"ToggleStudiesAndFundamentalsPriceLabels",onDestroy:()=>{R.destroy()}}},{property:R,undoModel:s,undoText:null,callback:()=>{const e=!R.value();s.beginUndoMacro(vp),s.setProperty(r.childs().scalesProperties.childs().showStudyLastValue,e,null),s.setProperty(r.childs().scalesProperties.childs().showFundamentalLastValue,e,null),s.endUndoMacro()}}),N=(0,Hl.combineProperty)(((e,t)=>e||t),r.childs().scalesProperties.childs().showStudyPlotLabels.weakReference(),r.childs().scalesProperties.childs().showFundamentalNameLabel.weakReference()),W=new Ni({actionId:"Chart.PriceScale.Labels.ToggleIndicatorsNameLabelsVisibility",options:{label:h.t(null,void 0,i(394478)),checkable:!0,checked:!1,statName:"ToggleStudiesAndFundamentalsNameLabels",onDestroy:()=>{N.destroy()}}},{property:N,undoModel:s,undoText:null,callback:()=>{const e=!N.value();s.beginUndoMacro(fp),s.setProperty(r.childs().scalesProperties.childs().showStudyPlotLabels,e,null),s.setProperty(r.childs().scalesProperties.childs().showFundamentalNameLabel,e,null),s.endUndoMacro()}
}),F=s.mainSeries().properties().childs().highLowAvgPrice.childs(),z=new Ni({actionId:"Chart.PriceScale.Labels.ToggleHighLowPriceLabelsVisibility",options:{label:h.t(null,void 0,i(823430)),checkable:!0,checked:!1,statName:"ToggleHighLowPriceLabels"}},{property:F.highLowPriceLabelsVisible,undoModel:s,undoText:Tp}),H=new Ni({actionId:"Chart.Lines.ToggleHighLowLinesVisibility",options:{label:h.t(null,void 0,i(256220)),checkable:!0,checked:!1,statName:"ToggleHighLowPriceLine"}},{property:F.highLowPriceLinesVisible,undoModel:s,undoText:Pp}),U=new Ni({actionId:"Chart.PriceScale.ToggleCountdownToBarCloseVisibility",options:{label:h.t(null,void 0,i(271661)),checkable:!0,checked:!1,statName:"ToggleCountdown"}},{property:s.mainSeries().properties().childs().showCountdown,undoModel:s,undoText:Mp}),G=new Ni({actionId:"Chart.PriceScale.ToggleAddOrderPlusButtonVisibility",options:{label:h.t(null,void 0,i(288915)),checkable:!0,checked:ih.addPlusButtonProperty.value(),statName:"ToggleAddOrderPlusButton"}},{property:ih.addPlusButtonProperty,undoModel:s,undoText:xp}),j=new Ui.ActionWithStandardIcon({actionId:"Chart.Dialogs.ShowSymbolInfo",options:{label:(0,H_.appendEllipsis)((0,B_.isMobile)()?h.t(null,void 0,i(100734)):h.t(null,void 0,i(909299))),iconId:"Chart.SymbolInfo",checkable:!1,statName:"SymbolInfo",onExecute:()=>{if((0,B_.isMobile)())(0,d.isFeaturesetEnabled)("mobile_app_action_open_details_webview")&&o.onDetailsWebviewOpen?o.onDetailsWebviewOpen():(0,R_.showDetailsDialog)(),(0,_t.trackEvent)("ContextMenuClick","Mobile","SymbolInfo");else{const t=e.model().model(),i=t.mainSeries().symbolInfo();if(i){const e=t.availableUnits(),s=t.unitConversionEnabled();(0,sp.showSymbolInfoDialog)({symbolInfo:i,showUnit:s,unitDescription:t=>t?e.description(t):"",dateFormatter:t.dateFormatter()})}}}}}),q=new Vi.Action({actionId:"Chart.PriceScale.MergeAllScalesToLeft",options:{label:h.t(null,void 0,i(872980)),statName:"MergeAllScalesToLeft",onExecute:()=>s.mergeAllScales("left")}}),$=new Vi.Action({actionId:"Chart.PriceScale.MergeAllScalesToRight",options:{label:h.t(null,void 0,i(363370)),statName:"MergeAllScalesToRight",onExecute:()=>s.mergeAllScales("right")}}),K=new Vi.Action({actionId:"Chart.PriceScale.MoveToLeft",options:{label:h.t(null,void 0,i(705016)),statName:"MoveScaleToLeft",onExecute:()=>s.mergeAllScales("left")}}),Z=new Vi.Action({actionId:"Chart.PriceScale.MoveToRight",options:{label:h.t(null,void 0,i(91879)),statName:"MoveScaleToRight",onExecute:()=>s.mergeAllScales("right")}}),Y=new Ui.ActionWithStandardIcon({actionId:"Chart.Scales.Reset",options:{label:h.t(null,void 0,i(207845)),iconId:"Chart.Reset",statName:"ResetChart",onExecute:()=>e.GUIResetScales(),hotkeyGroup:t,hotkeyHash:ht.Modifiers.Alt+82}}),X=e.model().model().sessions().properties().childs().sessionHighlight.childs().vertlines.childs().sessBreaks.childs().visible,J=(0,Hl.createWVFromProperty)(e.model().mainSeries().isDWMProperty()),Q=new Vi.Action({actionId:"Chart.SessionBreaks.ToggleVisibility",options:{label:h.t(null,void 0,i(792496)),checkable:!0,checked:X.value(),
statName:"ToggleSessionBreaks",disabled:J.value(),onExecute:()=>{X&&s.setProperty(X,!X.value(),Ip)},onDestroy:()=>J.destroy()}});J.subscribe((()=>Q.update({disabled:J.value()})));const ee=new Ni({actionId:"Chart.Lines.ToggleSeriesPriceLineVisibility",options:{label:h.t(null,void 0,i(880222)),checkable:!0,statName:"TogglePriceLine"}},{property:s.mainSeries().properties().childs().showPriceLine,undoModel:s,undoText:Lp}),te=new Vi.Action({actionId:"Chart.Undo",options:{label:h.t(null,void 0,i(74133)),onExecute:()=>{(0,_t.trackEvent)("GUI","Undo"),s.undoHistory().undo()},onDestroy:()=>{e.model().undoHistory().undoStack().onChange().unsubscribeAll(te)},disabled:!0,hotkeyGroup:t,hotkeyHash:ht.Modifiers.Mod+90,isRepeatAccepted:!0}});e.model().undoHistory().undoStack().onChange().subscribe(te,(()=>te.update({disabled:e.model().undoHistory().undoStack().isEmpty()})));const ie=new Vi.Action({actionId:"Chart.Redo",options:{label:h.t(null,void 0,i(798307)),onExecute:()=>{(0,_t.trackEvent)("GUI","Redo"),e.model().undoHistory().redo()},onDestroy:()=>{e.model().undoHistory().redoStack().onChange().unsubscribeAll(ie)},disabled:!0,hotkeyGroup:t,hotkeyHash:ht.Modifiers.Mod+89,isRepeatAccepted:!0}});e.model().undoHistory().redoStack().onChange().subscribe(ie,(()=>ie.update({disabled:e.model().undoHistory().redoStack().isEmpty()})));const se={invertSeriesScale:n,autoSeriesScale:a,lockSeriesScale:l,regularSeriesScale:c,percentSeriesScale:u,indexedTo100SeriesScale:p,logSeriesScale:m,applyTimeZone:g,symbolSearch:new Vi.Action({actionId:"Chart.Dialogs.ShowChangeSymbol",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(692767))),statName:"ChangeSymbol",onExecute:()=>{(0,vt.showDialog)({defaultValue:"",trackResultsOptions:{trackResults:!(0,d.isFeaturesetEnabled)("widget"),emptySearchType:"empty_result__supercharts"},enableOptionsChain:(0,d.isFeaturesetEnabled)("symbol_search_option_chain_selector")})}}}),changeInterval:cp(e),timeScaleReset:f,insertIndicator:b,compareOrAdd:y,chartProperties:w,mainSeriesPropertiesAction:C,scalesProperties:T,lineToggleLock:P,seriesHide:M,studyHide:M,lineHide:M,scaleSeriesOnly:x,drawingToolbarAction:I,stayInDrawingModeAction:A,hideAllMarks:k,showSeriesLastValue:E,showSymbolLabelsAction:B,showStudyLastValue:V,showStudyPlotNamesAction:W,showHighLowPriceLabels:z,showHighLowPriceLines:H,showCountdown:U,addPlusButton:G,showSymbolInfoDialog:j,mergeLeftScalesAction:q,mergeRightScalesAction:$,moveScaleToLeft:K,moveScaleToRight:Z,chartReset:Y,sessionBreaks:Q,showPriceLine:ee,undo:te,redo:ie};if(o.goToDateEnabled&&(se.gotoDate=new Vi.Action({actionId:"Chart.Dialogs.ShowGoToDate",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(745998))),statName:"GoToDate",onExecute:()=>(0,op.showGoToDateDialog)(e.chartWidgetCollection().activeChartWidget.value()),hotkeyGroup:t,hotkeyHash:ht.Modifiers.Alt+71}})),(0,d.isFeaturesetEnabled)("show_object_tree")&&(se.paneObjectTree=new Vi.Action({actionId:"Chart.ObjectTree.Show",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(281025))),statName:"ObjectsTree",
onExecute:()=>e.showObjectsTreePanelOrDialog()}})),(0,d.isFeaturesetEnabled)("property_pages")&&(se.format=new Ui.ActionWithStandardIcon({actionId:"Chart.SelectedObject.ShowSettingsDialog",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(730586))),iconId:"Settings",statName:"EditSelectedObject",onExecute:()=>e.showSelectedSourcesProperties()}})),!e.readOnly()){const s=function(e){const t=np(e),i=new Vi.Action({actionId:"Chart.RemoveAllLineTools",options:{label:t.drawings.label,disabled:t.drawings.disabled,statName:"RemoveAllDrawingTools",onExecute:()=>e.removeAllDrawingTools(),onDestroy:()=>e.model().model().dataSourceCollectionChanged().unsubscribeAll(e)}}),s=new Vi.Action({actionId:"Chart.RemoveAllIndicators",options:{label:t.studies.label,disabled:t.studies.disabled,statName:"RemoveAllIndicators",onExecute:()=>e.removeAllStudies()}}),o=new Vi.Action({actionId:"Chart.RemoveAllIndicatorsAndLineTools",options:{label:t.all.label,disabled:t.all.disabled,statName:"RemoveAllIndicatorsAndDrawingTools",onExecute:()=>e.removeAllStudiesDrawingTools()}});return e.model().model().dataSourceCollectionChanged().subscribe(e,(()=>{const{studies:t,drawings:r,all:n}=np(e);s.update({disabled:t.disabled,label:t.label}),i.update({disabled:r.disabled,label:r.label}),o.update({disabled:n.disabled,label:n.label})})),{drawings:i,studies:s,all:o}}(e);se.paneRemoveAllStudies=s.studies,se.paneRemoveAllDrawingTools=s.drawings,se.paneRemoveAllStudiesDrawingTools=s.all,se.applyStudiesToAllCharts=new Vi.Action({actionId:"Chart.ApplyIndicatorsToAllCharts",options:{label:h.t(null,void 0,i(924176)),statName:"ApplyIndicatorsToAllCharts",onExecute:()=>e.chartWidgetCollection().applyIndicatorsToAllCharts(e)}}),se.studyRemove=se.lineRemove=new Ui.ActionWithStandardIcon({actionId:"Chart.SelectedObject.Remove",options:{label:h.t(null,void 0,i(91126)),iconId:"Chart.RemoveSelectedObject",statName:"RemoveSelectedObject",onExecute:()=>{(e.chartWidgetCollection().activeChartWidget.value()??e).removeSelectedSources()},hotkeyGroup:t,hotkeyHash:ht.isMacKeyboard?8:46}})}if(!(0,_.onWidget)()&&(0,d.isFeaturesetEnabled)("text_notes")&&(se.addToTextNotes=function(e){const t=e.symbolWV().spawn(),s=new Vi.Action({actionId:"Note.Create",options:{iconId:"TextNote.Add",icon:N_.icons.get("TextNote.Add"),label:h.t(null,void 0,i(230224)),statName:"AddToTextNotes",onExecute:()=>{window.runOrSignIn((()=>{window.widgetbar?.setPage("base"),(0,V_.createSymbolNote)(e.symbolWV().value(),(0,B_.isMobile)())}),{source:"Add text note in chart context menu"})},hotkeyHash:O.Modifiers.Alt+78,hotkeyGroup:e.hotkeys(),onDestroy:()=>t.destroy()}});return t.subscribe((t=>{const o=e.model().model().mainSeries().symbolInfo()?.pro_name,r=e.model().model().symbolAliasService()?.getAliasByProName(o??t),n=(0,O_.safeShortName)(t);s.update({label:h.t(null,void 0,i(343331)).format({symbol:r?.aliasName??n})})}),{callWithLast:!0}),s}(e)),window.is_authenticated&&(!(0,_.isDesktopApp)()||(0,D_.desktopVersionIsLess)("1.0.10")||(0,_.isDesktopApp)()&&!(0,D_.desktopVersionIsLess)("1.0.11"))){
const t=se.applyColorTheme=new Vi.Action({actionId:"Chart.Theme.Apply",options:{name:"apply-color-theme",label:h.t(null,void 0,i(354676)),subItems:[new Vi.Action({actionId:"Loading",options:{label:h.t(null,void 0,i(372732))}})],statName:"ColorTheme",onDestroy:()=>{window.loginStateChange.unsubscribeAll(t),L.themeListChanged.unsubscribeAll(t)}},optionsLoader:()=>ep(e)}),s=()=>tp(e,se.applyColorTheme);window.loginStateChange.subscribe(t,s),L.themeListChanged.subscribe(t,s)}(0,d.isFeaturesetEnabled)("show_source_code")&&(se.viewSourceCode=new Vi.Action({actionId:"Chart.Indicator.PineSource",options:{label:(0,H_.appendEllipsis)(h.t(null,void 0,i(793402))),statName:"OpenSelectedObjectSource",onExecute:()=>{const[e]=s.selection().dataSources();if(!(0,Nt.isStudy)(e))return;const t=e.metaInfo();t&&t.scriptIdPart&&t.pine&&(0,ip.activatePineEditor)({script:{scriptIdPart:t.scriptIdPart,version:t.pine.version}},"study_menu").catch(F_.showScriptInfoErrorNoticeDialog)}}})),se.hideAllLineTools=new Ni({actionId:"Chart.ToggleVisibility.AllLineTools",options:{label:h.t(null,void 0,i(988260)),checkable:!0,statName:"ToggleHideMarksOnBars",hotkeyGroup:e.hotkeys(),hotkeyHash:ht.Modifiers.Mod+ht.Modifiers.Alt+72}},{property:D.hideMarksOnBars(),undoModel:s,undoText:_p,callback:()=>(0,ft.toggleHideMode)()}),se.openTableView=new Vi.Action({actionId:"Chart.OpenTableView",options:{label:h.t(null,void 0,i(238336)),statName:"Table view",onExecute:async()=>{const{showChartTableViewDialog:t}=await Promise.all([i.e(32395),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(75828),i.e(97627),i.e(74354),i.e(5709),i.e(46680),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(98729),i.e(56752),i.e(20432),i.e(33160),i.e(52253),i.e(92118),i.e(65790),i.e(5792),i.e(57384),i.e(51129),i.e(21113),i.e(1748),i.e(8294),i.e(32387),i.e(78539),i.e(98706),i.e(72132),i.e(46650)]).then(i.bind(i,231259));t({widget:e.chartWidgetCollection().activeChartWidget})}}});{const e=se.showPrePostMarketPriceLabel=new Ni({actionId:"Chart.PriceScale.Labels.TogglePrePostMarketLabelsVisibility",options:{label:h.t(null,void 0,i(565161)),checkable:!0,checked:!1,disabled:!s.mainSeries().isPrePostMarketPricesAvailableProperty().value(),statName:"TogglePrePostMarketPriceLabel",onDestroy:()=>{s.mainSeries().isPrePostMarketPricesAvailableProperty().unsubscribeAll(e)}}},{property:r.childs().scalesProperties.childs().showPrePostMarketPriceLabel,undoModel:s,undoText:wp});s.mainSeries().isPrePostMarketPricesAvailableProperty().subscribe(e,(t=>{e.update({disabled:!t.value()})}))}{const e=se.showPrePostMarketPriceLine=new Ni({actionId:"Chart.Lines.TogglePrePostMarketPriceLineVisibility",options:{label:h.t(null,void 0,i(42110)),checkable:!0,checked:!1,disabled:!s.mainSeries().isPrePostMarketPricesAvailableProperty().value(),statName:"TogglePrePostMarketPriceLine",onDestroy:()=>{s.mainSeries().isPrePostMarketPricesAvailableProperty().unsubscribeAll(e)}}},{property:s.mainSeries().properties().childs().prePostMarket.childs().visible,undoModel:s,undoText:Cp})
;s.mainSeries().isPrePostMarketPricesAvailableProperty().subscribe(e,(t=>{e.update({disabled:!t.value()})}))}{const n=se.showSeriesPrevCloseValue=new Ni({actionId:"Chart.PriceScale.Labels.ToggleSymbolPrevCloseValueVisibility",options:{label:h.t(null,void 0,i(88215)),checkable:!0,checked:!1,statName:"ToggleSymbolPrevCloseValue",onDestroy:()=>s.mainSeries().onRestarted().unsubscribeAll(n)}},{property:r.childs().scalesProperties.childs().showSeriesPrevCloseValue,undoModel:s,undoText:mp});s.mainSeries().onRestarted().subscribe(n,(()=>{n.update({disabled:s.mainSeries().isDWM()})}));const a=se.showSeriesPrevCloseLine=new Ni({actionId:"Chart.Lines.ToggleSeriesPrevCloseLineVisibility",options:{label:h.t(null,void 0,i(794331)),checkable:!0,checked:!1,statName:"ToggleSymbolPrevCloseLine",onDestroy:()=>s.mainSeries().onRestarted().unsubscribeAll(a)}},{property:s.mainSeries().properties().childs().showPrevClosePriceLine,undoModel:s,undoText:gp});s.mainSeries().onRestarted().subscribe(a,(()=>{a.update({disabled:s.mainSeries().isDWM()})})),se.showBidAskLabels=new Ni({actionId:"Chart.PriceScale.Labels.ToggleBidAskLabelsVisibility",options:{label:h.t(null,void 0,i(231504)),checkable:!0,checked:!1,statName:"ToggleBidAskLabels"}},{property:r.childs().scalesProperties.childs().showBidAskLabels,undoModel:s,undoText:bp}),se.showBidAskLines=new Ni({actionId:"Chart.Lines.ToggleBidAskLinesVisibility",options:{label:h.t(null,void 0,i(919376)),checkable:!0,checked:!1,statName:"ToggleBidAskLines"}},{property:s.mainSeries().properties().childs().bidAsk.childs().visible,undoModel:s,undoText:yp});const l=e.chartWidgetCollection().activeChartCanBeMoved().spawn(),c=se.moveChartAction=new Vi.Action({actionId:"Chart.MoveChartInLayout",options:{label:h.t(null,void 0,i(288396)),subItems:[new Vi.Action({actionId:"Chart.MoveChartInLayout.Forward",options:{label:h.t(null,void 0,i(595838)),statName:"MoveChartRight",onExecute:()=>e.chartWidgetCollection().moveActiveChartWithUndo(!1)}}),new Vi.Action({actionId:"Chart.MoveChartInLayout.Back",options:{label:h.t(null,void 0,i(500147)),statName:"MoveChartLeft",onExecute:()=>e.chartWidgetCollection().moveActiveChartWithUndo(!0)}})],onDestroy:()=>l.destroy()}});if(l.subscribe((e=>c.update({disabled:!e})),{callWithLast:!0}),o.addToWatchlistEnabled){const i={hotkeyGroup:t,statName:"AddToWatchlist"};se.addToWatchlist=new Y_(e,i),t.add({desc:"Add symbol to watchlist",hotkey:ht.Modifiers.Mod+ht.Modifiers.Alt+87,handler:()=>(0,W_.showAddSymbolDialog)([z_(e)])})}}return se}var Ep=i(227719),Dp=i(446849);i(173251);const Bp=(0,l.getLogger)("ChartWidget",{color:"#606"}),Rp=(0,d.isFeaturesetEnabled)("chart_content_overrides_by_defaults"),Vp=new P.TranslatedString("hide {title}",h.t(null,void 0,i(589815))),Op=new P.TranslatedString("unlock {title}",h.t(null,void 0,i(770639))),Np=new P.TranslatedString("lock {title}",h.t(null,void 0,i(620927))),Wp=new P.TranslatedString("change session",h.t(null,void 0,i(723426)));let Fp=null;if(location.search.toLowerCase().includes("logcanvassaverestoreleaks")){
if(!_.isChrome)throw new Error("CanvasRenderingContext2D save/restore leak detection is available for now in Chrome only");i.e(16126).then(i.bind(i,670436)).then((e=>{e.enableCanvasRenderingContext2DSaveRestoreLeaksDetection(),Fp=e.reportCanvasRenderingContext2DSaveRestoreLeaks}))}const zp={addToWatchlistEnabled:!0,showFinancialsEnabled:!1,sourceSelectionEnabled:!0,propertyPagesEnabled:!0,paneContextMenuEnabled:!0,priceScaleContextMenuEnabled:!0,currencyConversionEnabled:!1,unitConversionEnabled:!1,goToDateEnabled:!1,marketStatusWidgetEnabled:!0,chartWarningWidgetEnabled:!0,dataProblemWidgetEnabled:!0,paneControlsEnabled:!0,isSymbolAvailable:e=>Promise.resolve(!0),legendWidgetEnabled:!0,chartEventsEnabled:!0,newsNotificationsEnabled:!0,esdEnabled:!1,latestUpdatesEnabled:!1,continuousContractSwitchesEnabled:!1,futuresContractExpirationEnabled:!1,croppedTickMarks:!0,countdownEnabled:!0,lastPriceAnimationEnabled:!0,useKineticScroll:_.CheckMobile.any(),indicatorsDialogShortcutEnabled:!0,handleScale:{mouseWheel:!0,pinch:!0,axisPressedMouseMove:{time:!0,price:!0}},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!0}},Hp=(0,br.extractThemedColors)(ut.lightTheme.content.chartProperties,ut.darkTheme.content.chartProperties);function Up(e,t,i,s=0){const o=t.mainSeries().syncModel(),r=e.mainSeries().syncModel();let n=i;if(null!==o&&null!==r){const t=e.createSyncPoint(o.syncSourceTarget(),r.syncSourceTarget());0!==s&&(i=o.projectTime(i,s)),n=t.sourceTimeToTargetTime(i)}return e.timeScale().points().roughIndex(n,r&&r.distance.bind(r))}const Gp=new Set(["Volume@tv-basicstudies","Compare@tv-basicstudies","Overlay@tv-basicstudies","Dividends@tv-basicstudies","Earnings@tv-basicstudies","Splits@tv-basicstudies","BarSetContinuousRollDates@tv-corestudies","Sessions@tv-basicstudies","InactivityGaps@tv-basicstudies","VbPSessionsRough@tv-volumebyprice","AnchoredVWAP@tv-basicstudies","RegressionTrend@tv-basicstudies","VbPAnchored@tv-basicstudies","VbPFixed@tv-basicstudies","VbPFixed@tv-volumebyprice","LongShortPosition@tv-basicstudies","ReplayStrategy@tv-scripting"]),jp=(0,at.default)((()=>{window.ChartApiInstance.setIsNonCountedStudyFn((e=>Gp.has(e)))}));var qp;!function(e){e.Canceled="canceled",e.Limits="limits"}(qp||(qp={}));class $p extends Error{constructor(e){super(`CreateStudyError: ${e}`),this.reason=e}}$p.Reasons=qp;class Kp{constructor(e,t){this._activePaneWidget=new H.WatchedValue(null),this._mainDiv=null,this._parent=null,this._elTooltipDiv=null,this._paneWidgets=new H.WatchedValue([]),this._timeAxisWidget=null,this._paneSeparators=[],this._controlBarNavigation=null,this._lineToolsSynchronizer=null,this._lineToolsSynchronizerHasChanges=null,this._modelCreated=new g.Delegate,this._isDestroyed=!1,this._customLegendWidgetsFactoryMap=new Map,this._backgroundTopTheme=new H.WatchedValue("light"),this._backgroundBasedTheme=new H.WatchedValue("light"),this._backgroundBottomTheme=new H.WatchedValue("light"),this._backgroundTopColorSpawn=null,this._backgroundBottomColorSpawn=null,this._lhsAxesWidth=0,
this._rhsAxesWidth=0,this._lhsPriceAxisWidthChanged=new g.Delegate,this._rhsPriceAxisWidthChanged=new g.Delegate,this._hotkeysListener=null,this._mouseWheelHelper=null,this._onWheelBound=null,this._justActivated=!1,this._inited=!1,this._containsData=!1,this._initialLoading=!1,this._onWidget=!1,this._widgetCustomer=void 0,this._defInterval=null,this._defStyle=null,this._defTimeframe=null,this._defMetric=null,this._removeMaximizeHotkey=null,this._invalidationMask=null,this._drawPlanned=!1,this._drawRafId=0,this._drawTime=new H.WatchedValue(performance.now()),this._inLoadingState=!1,this._timingsMeter=null,this._tagsChanged=new g.Delegate,this._redraw=new g.Delegate,this._isVisible=new H.WatchedValue(!0),this._collapsed=new H.WatchedValue(!1),this._dataWindowWidget=null,this._resizeHandler=null,this._spinner=null,this._symbolWV=new H.WatchedValue,this._resolutionWV=new H.WatchedValue,this._actions=null,this._updateThemedColorBound=this._updateThemedColor.bind(this),this._disconnected=new g.Delegate,this._reconnectBailout=new g.Delegate,this._connected=new g.Delegate,this._chartWidgetInitialized=new g.Delegate,this._aboutToBeDestroyed=new g.Delegate,this._saveChartService=null,this._objectTreeDialogController=null,this._chartPaintedPromise=null,this._noExchangeSubscrptionWarning=null,this._paneWidgetsSharedState=new Qs,this._onZoom=new g.Delegate,this._onScroll=new g.Delegate,this._availableScreen=null,this._widgetSymbolChangeRestrictions=null,this._hoveredPriceAxes=new Set,this._anyAxisHovered=new H.WatchedValue(!1),this._linkingGroupIndex=new H.WatchedValue(null),this._isHovered=new H.WatchedValue(!1),this._activeHint=null,this._eventHintDeferredPromise=null,this._warningHintDeferredPromise=null,this._setSymbolIntervalContentOverrides={},this._ariaPriceDescription=null,this._definitionsViewModel=null,this._barsButton=null,this._modelWV=new H.WatchedValue(null),this._updateScalesActions=()=>{const e=this.actions(),t=this.model().mainSeries(),i=t.priceScale(),s=t.properties(),o=i.isLockScale(),r=6===s.childs().style.value();e.percentSeriesScale.update({disabled:o||r,checked:i.isPercentage()}),e.logSeriesScale.update({disabled:o||r,checked:i.isLog()}),e.regularSeriesScale.update({disabled:o||r,checked:i.isRegular()}),e.indexedTo100SeriesScale.update({disabled:o||r,checked:i.isIndexedTo100()}),e.invertSeriesScale.update({checked:i.isInverted()}),e.lockSeriesScale.update({checked:i.isLockScale()}),e.autoSeriesScale.update({checked:i.isAutoScale(),disabled:i.properties().childs().autoScaleDisabled.value()})},this._invalidationHandler=e=>{if(!(e instanceof ve.InvalidationMask))throw new Error("Invalid mask");null!==this._invalidationMask?this._invalidationMask.merge(e):this._invalidationMask=e,this._drawPlanned||(this._drawPlanned=!0,this._options.visible.when((()=>{const e=!document.hidden,t=this.screen&&this.screen.isShown();null!==this._timingsMeter&&e&&!t&&this._timingsMeter.startWaitingDraw();const i=(0,a.ensureNotNull)((0,a.ensureNotNull)(this._parent).ownerDocument.defaultView)
;this._drawRafId=i.requestAnimationFrame(this._invalidationRAFCallback.bind(this))})))},this._onChartSessionIsConnectedChanged=e=>{e?this._onConnection():this._onDisconnect()},this._subscribeToBanInfo=e=>{e?this._spinner?.stop():this._spinner?.spin()},this._id=t,this._options=(0,n.merge)((0,n.clone)(zp),e),this._chartWidgetCollection=this._options.chartWidgetCollection,this._isActive=new H.WatchedValue(!!this._options.isActive),this._activeChartWidgetWV=this._chartWidgetCollection.activeChartWidget.spawn(),this._options.customLegendWidgetFactories&&(this._customLegendWidgetsFactoryMap=this._options.customLegendWidgetFactories),this._subscribeToDrawingState(),this.withModel(this,(()=>{const e=this.model().model();e.backgroundTopColor().subscribe(this._updateThemedColorBound),e.backgroundColor().subscribe(this._updateThemedColorBound)}));const s=(0,F.combine)((e=>[e?e.mainSeries().symbolInfoWV().weakReference():new H.WatchedValue(null).ownership()]),this._modelWV.weakReference());this._symbolInfoWV=(0,F.accumulate)((e=>e[0]),s.ownership()).ownership(),this._errorRendererResource=new yn.AsyncResourceWrapper(Promise.all([i.e(49446),i.e(60969)]).then(i.bind(i,481232)).then((e=>this._isDestroyed?null:new e.ErrorRenderer(new H.WatchedValue(this)))),(e=>{e?.destroy()})),this._scrollHelper=new Bt(this),this._objectTreeDialogController=yt.getInstance(),this._properties=new br.DefaultProperty({defaultName:"chartproperties",useUserPreferences:this._options.useUserChartPreferences,excludedDefaultsKeys:["scalesProperties.axisHighlightColor","scalesProperties.axisLineToolLabelBackgroundColorActive","scalesProperties.axisLineToolLabelBackgroundColorCommon","scalesProperties.showPriceScaleCrosshairLabel","scalesProperties.showTimeScaleCrosshairLabel","scalesProperties.crosshairLabelBgColorLight","scalesProperties.crosshairLabelBgColorDark","alertsProperties","mainSeriesProperties"],excludedTemplateKeys:["timezone","tradingProperties","mainSeriesProperties","chartEventsSourceProperties","priceScaleSelectionStrategyName","paneProperties.horzGridProperties.style","paneProperties.vertGridProperties.style","paneProperties.topMargin","paneProperties.bottomMargin","volumePaneSize","alertsProperties"],excludedStateKeys:["alertsProperties","mainSeriesProperties"],themedColors:Hp}),this._mainSeriesProperties=new k_.SeriesPropertiesImpl,this._startSpinner(this._options.container.value()),window.ChartApiInstance.connectionBanInfo().subscribe(this._subscribeToBanInfo,{callWithLast:!0}),this._chartSession=new A_.ChartSession(window.ChartApiInstance),jp(),this._isMultipleLayout=(0,F.combine)((e=>(0,M.isMultipleLayout)(e)),this._chartWidgetCollection.layout.weakReference()),this._properties.childs().scalesProperties.childs().scaleSeriesOnly.subscribe(null,(()=>{const e=this.model().model();e.recalculateAllPanes((0,Ds.viewportChangeEvent)()),e.invalidate(ve.InvalidationMask.full())})),this._hotkeys=B.createGroup({desc:"Chart actions",isDisabled:()=>!this.isActive().value()}),(0,
_.onWidget)()||(this._persistentLogSwitcher=new h_.FeatureToggleWatchedValue("support_persistent_logs",!1),this._persistentLogSwitcher.subscribe((async e=>{if(e){if((0,va.getPersistentLogger)())return;(0,va.setPersistentLogger)(new __);const{initPersistentLogger:e}=await i.e(65909).then(i.bind(i,215732));this._persistentLogSwitcher?.value()?e():(0,va.setPersistentLogger)(null)}else(0,va.setPersistentLogger)(null)}),{callWithLast:!0})),this._compareDialog=this._chartWidgetCollection.getCompareDialogRenderer(),this._options.timeScaleWidget&&(this._options.timeScaleWidget.pressedMouseMoveScale=this._options.handleScale.axisPressedMouseMove.time);const o=this._options.onCmeWidget;o&&Bp.logWarn("[ChartWidget] 'onCmeWidget' option is depricated");const r=this._options.widgetCustomer,l=this._options.timezone;let c=this._options.defSymbol??"",h=$.Interval.isValid(this._options.defInterval)?this._options.defInterval:null;const d=this._options.defStyle;let u=(0,Q.isValidStyle)(d)?d:null;const p=this._options.defSessionId,m=void 0!==this._options.defTimeframe?"string"==typeof this._options.defTimeframe?{value:this._options.defTimeframe.toUpperCase(),type:"period-back"}:{...this._options.defTimeframe,type:"time-range"}:null;let S=this._options.defMetric??null;this._content=this._options.content,this._initialLoading=this._options.initialLoading,this._containsData=!!this._options.containsData,this._onWidget=!!this._options.onWidget,this._compareSymbols=this._options.compareSymbols,this._defSymbol=c,this._defInterval=h,this._defTimeframe=m,this._defStyle=u,this._defMetric=S,this._onWidget&&(o?this._widgetCustomer="cme":r&&(this._widgetCustomer=r)),this._compareDialog=this._chartWidgetCollection.getCompareDialogRenderer();const v=this._contentSeriesProperties();v&&(c=v.symbol,h=v.interval,S=v.metricId),void 0===this._options.useUserChartPreferences&&(this._options.useUserChartPreferences=!0);const f="chartproperties.mainSeriesProperties",b=this._options.useUserChartPreferences?(0,En.defaults)(f):(0,En.factoryDefaults)(f),y=this._mainSeriesProperties,w=h||b.interval||"D";null!==u&&(0,Q.isValidStyle)(u)||(u=(0,Q.isValidStyle)(b.style)?b.style:(0,Q.getDefaultStyle)($.Interval.isRange(w)));const C=(0,ct.default)({visible:!0,symbol:c||window.DEFAULT_SYMBOL,shortName:"",timeframe:"",interval:w,currencyId:null,unitId:null,style:u,sessionId:p,metricId:S},n.notUndefined);y.merge(C),this._symbolWV.setValue(c),this._resolutionWV.setValue(w),this._containsData&&this._mainSeriesProperties.merge({showCountdown:!1}),l&&(0,Lt.timezoneIsAvailable)(l)&&this._properties.childs().timezone.setValue(l),this._options.container.subscribe((e=>{this._setElement(e)}),{callWithLast:!0});const T=()=>{this.resize()};this._options.width.subscribe(T),this._options.height.subscribe(T),this._options.visible.subscribe(this._updateTimingsMeterState.bind(this))}refreshMarks(){this.model().barsMarksSources().forEach((e=>e.refreshData()))}clearMarks(e){this.model().barsMarksSources().forEach((t=>t.clearMarks(e)))}setTimezone(e){const t=e;t&&(0,
Lt.timezoneIsAvailable)(t)?this.properties().childs().timezone.setValue(t):console.warn("Incorrect timezone: "+JSON.stringify(t))}getTimezone(){return this.properties().childs().timezone.value()}destroy(){this._chartSession.disconnect(),this._unsetActions(),this._hotkeys?.destroy(),this._lineToolsSynchronizer?.destroy(),this._noExchangeSubscrptionWarning?.destroy(),window.loginStateChange.unsubscribe(this,this._handleLoginStateChanged),this.hasModel()&&(this.model().model().backgroundTopColor().unsubscribe(this._updateThemedColorBound),this.model().model().backgroundColor().unsubscribe(this._updateThemedColorBound),this.model().model().crosshairSource().moved().unsubscribe(this,this._updateAriaPriceDescription),this.model().destroy()),this._modelWV.destroy(),window.ChartApiInstance.connectionBanInfo().unsubscribe(this._subscribeToBanInfo),this._ariaPriceDescription=null,this._customLegendWidgetsFactoryMap.clear(),this._scrollHelper.destroy(),this._errorRendererResource.destroy(),this._chartSession.criticalError().unsubscribe(this,this._onChartSessionCriticalError),this._chartSession.isConnected().unsubscribe(this._onChartSessionIsConnectedChanged),this._chartSession.destroy(),this._persistentLogSwitcher?.destroy(),this._isDestroyed=!0,this._aboutToBeDestroyed.fire(),this._removeMaximizeHotkey?.(),this._removeMaximizeHotkey=null,0!==this._drawRafId&&this._parent?.ownerDocument.defaultView?.cancelAnimationFrame(this._drawRafId),this._backgroundTopColorSpawn?.destroy(),this._backgroundBottomColorSpawn?.destroy(),this._timingsMeter?.stopCollect(),this._timingsMeter=null;const e=this._paneWidgets.value();for(let t=0;t<e.length;t++)e[t].destroy();this._paneWidgets.setValue([]);for(let e=0;e<this._paneSeparators.length;e++)this._paneSeparators[e].destroy();this._paneSeparators.length=0,this._hotkeysListener?.destroy(),this._barsButton?.destroy(),this._controlBarNavigation?.destroy(),this._controlBarNavigation=null,this._mainDiv&&(this._onWheelBound&&this._mainDiv.removeEventListener("wheel",this._onWheelBound),this._mainDiv.remove()),this._timeAxisWidget?.destroy(),this._timeAxisWidget=null,this._definitionsViewModel?.destroy(),this._isMultipleLayout.destroy(),D.createdLineTool.unsubscribeAll(this),D.continuedLineTool.unsubscribeAll(this),D.cancelledLineTool.unsubscribeAll(this),D.beenSetLineToolLastPoint.unsubscribeAll(this),D.startedMovingLineTool.unsubscribeAll(this),D.movedLineTool.unsubscribeAll(this),D.finishedMovingLineTool.unsubscribeAll(this),D.startedChangingLineTool.unsubscribeAll(this),D.changedLineTool.unsubscribeAll(this),D.finishedChangingLineTool.unsubscribeAll(this),D.removedLineTool.unsubscribeAll(this),D.finishedLineTool.unsubscribeAll(this),D.changedLineStyle.unsubscribeAll(this),D.restoredLineToolState.unsubscribeAll(this),D.restoredLineTool.unsubscribeAll(this),D.copiedLineTool.unsubscribeAll(this),this._activeChartWidgetWV.destroy()}title(){return h.t(null,void 0,i(625788))}emulateCriticalError(){this._chartSession.removeSeries("-1")}chartSession(){return this._chartSession}onDisconnected(){
return this._disconnected}onReconnectBailout(){return this._reconnectBailout}onConnected(){return this._connected}chartWidgetInitialized(){return this._chartWidgetInitialized}setBarsButton(e){this._barsButton=e}setVisibleTimeRange(e,t,i,s,o){throw new Error("Not implemented")}chartWidgetCollection(){return this._chartWidgetCollection}isInitialized(){return this._inited}lineToolsSynchronizer(){return this._lineToolsSynchronizer}actions(){return null===this._actions?this._setActions():this._actions}defaultSymbol(){return this._defSymbol}requestFullscreen(){this.getResizerDetacher().requestFullscreen()}exitFullscreen(){this.getResizerDetacher().exitFullscreen()}inFullscreen(){return this.getResizerDetacher().fullscreen.value()}modelCreated(){return this._modelCreated}containsStudyByPredicate(e){return!!this.hasModel()&&this.model().dataSources().some((t=>!!(0,Nt.isStudy)(t)&&e(t.metaInfo())))}model(){return(0,a.ensureNotNull)(this._modelWV.value())}id(){return this._id}layoutId(){return this._chartWidgetCollection.metaInfo.uid.value()}properties(){return this._properties}mainSeriesProperties(){return this._mainSeriesProperties}readOnly(){return Boolean(this._options.readOnly)}isActive(){return this._isActive.readonly()}isHovered(){return this._isHovered.readonly()}crossHairSyncEnabled(){return this._chartWidgetCollection.lock.crosshair.value()}isVisible(){return this._isVisible.value()}setVisible(e){this._isVisible.setValue(e)}visible(){return this._isVisible.readonly()}isCollapsed(){return this._collapsed.value()}setCollapsed(e){this._collapsed.setValue(e)}collapsed(){return this._collapsed.readonly()}isJustClonedChart(){return!!(this._options||{}).justCloned}removeAllDrawingTools(){!!this.model().model().allLineTools().find((e=>e.isLocked?.()))?(0,Dp.confirmRemovingLockedLineTools)(Dp.DeleteLockedLineToolReason.RemoveAll).then((e=>{this.model().removeAllDrawingTools(e)})):this.model().removeAllDrawingTools(!0)}removeAllStudies(){this.model().removeAllStudies()}removeAllStudiesDrawingTools(){!!this.model().model().allLineTools().find((e=>e.isLocked?.()))?(0,Dp.confirmRemovingLockedLineTools)(Dp.DeleteLockedLineToolReason.RemoveAll).then((e=>{this.model().removeAllStudiesAndDrawingTools(e)})):this.model().removeAllStudiesAndDrawingTools(!0)}removeSelectedSources(){this.removeDataSources(this.model().selection().dataSources())}removeDataSources(e){const t=this.model(),i=e.filter((e=>e!==t.mainSeries()&&e!==t.lineBeingCreated()&&e.isUserDeletable()));if(0===i.length)return;let s=null;(0,Nt.isStudy)(i[0])&&((0,a.assert)(1===i.length,"Cannot remove several studies (no multi select for studies)"),s=i[0]);const o=i.find((e=>e.hasAlert().value())),r=!!i.find((e=>(0,Ut.isLineTool)(e)&&e.isLocked?.()));if(o)(0,f_.confirmDatasourceRemoving)({hasLockedSources:r}).then((e=>{e&&t.removeSelectedSources()}));else if(s&&s.hasChildren()){const e=s.getAllChildren().map((e=>e.name(!0)));(0,mt.showDeleteStudyTreeConfirm)(e,(()=>{t.removeSelectedSources()}))}else r?(0,
Dp.showDeleteLockedLineToolsConfirm)(Dp.DeleteLockedLineToolReason.RemoveSelected,(e=>{e||t.selectionMacro((e=>{i.filter((e=>(0,Ut.isLineTool)(e)&&e.isLocked?.())).forEach((t=>{e.removeSourceFromSelection(t)}))})),t.removeSelectedSources()})):t.removeSelectedSources()}getSymbol(e){if(!this.hasModel())return this._setSymbolIntervalContentOverrides.symbol||window.DEFAULT_SYMBOL;if(!e)return this._symbolWV.value();const t=this.model().mainSeries().properties().childs();return t.shortName&&t.shortName.value()?t.shortName?.value()??"":t.symbol?.value()??""}setSymbol(e){if(this.hasModel()){this._symbolWV.setValue(e);const t=this.model();t.setSymbol(t.mainSeries(),e)}else this._mainSeriesProperties.merge({symbol:e}),this._symbolWV.setValue(e),this._setSymbolIntervalContentOverrides.symbol=e}setResolution(e){if(this.hasModel()){this._resolutionWV.setValue(e);const t=this.model();t.setResolution(t.mainSeries(),e)}else this._mainSeriesProperties.merge({interval:e}),this._resolutionWV.setValue(e),this._setSymbolIntervalContentOverrides.interval=e}getResolution(){return this._resolutionWV.value()}symbolWV(){return this._symbolWV.readonly()}symbolInfoWV(){return this._symbolInfoWV}resolutionWV(){return this._resolutionWV.readonly()}loadRange(e){if(this.hasModel()){this.screen.show();this.model().loadRange(e)||this.screen.hide()}}async showGeneralChartProperties(e,t){if(!(0,d.isFeaturesetEnabled)("show_chart_property_page"))return Promise.resolve(null);const s=await this._showChartProperties(this.model().mainSeries(),e,{doNotCloseOnBgClick:!0,onResetToDefault:async()=>{this.model().restorePreferences();const[e,t]=await Promise.all([Promise.all([i.e(74114),i.e(6425)]).then(i.bind(i,64906)),Promise.all([i.e(74114),i.e(6425)]).then(i.bind(i,798111))]),s=e.getCurrentTheme().name;t.loadTheme(this.chartWidgetCollection(),{themeName:s,standardTheme:!0})},shouldReturnFocus:t?.shouldReturnFocus});if(null===s)return null;const o=()=>{s.hide(),this._activeChartWidgetWV.unsubscribe(o)};return this._activeChartWidgetWV.subscribe(o),s}showChartPropertiesForSource(e,t,i,s){return(0,d.isFeaturesetEnabled)("property_pages")&&e.userEditEnabled()?e===this.model().model().mainSeries()?this.showGeneralChartProperties(t):((i=i||{}).onResetToDefault=()=>{((0,Ut.isLineTool)(e)||(0,Nt.isStudy)(e))&&this.model().restorePropertiesForSource.bind(this.model(),e)},this._showChartProperties(e,t,i,s)):Promise.resolve(null)}toggleCompareOrAdd(){this._compareDialog.visible().value()?this._compareDialog.hide():this._compareDialog.show()}tags(){return this.hasModel()?this.model().calculateDefaultTags():[]}options(){return this._options}ownerDocument(){return(0,a.ensureNotNull)(this._parent).ownerDocument}async showChartPropertiesForSources(e){if(!(0,d.isFeaturesetEnabled)("property_pages"))return Promise.resolve(null)
;const{sources:t,title:s,tabName:o,renamable:r}=e,n=this.model(),a=kt(t.map((e=>e.properties().childs()))),l=kt(t.map((e=>e.properties().childs().intervalsVisibilities))),[{createPropertyPage:c},{getSelectionStylePropertiesDefinitions:u},{getSelectionIntervalsVisibilitiesPropertiesDefinition:_},{getSelectionCoordinatesPropertyDefinition:p}]=await Promise.all([Promise.all([i.e(87193),i.e(85262),i.e(95025),i.e(9343),i.e(59328)]).then(i.bind(i,396742)),Promise.all([i.e(87193),i.e(85262),i.e(95025),i.e(9343),i.e(59328)]).then(i.bind(i,653174)),Promise.all([i.e(87193),i.e(85262),i.e(95025),i.e(9343),i.e(59328)]).then(i.bind(i,204408)),Promise.all([i.e(87193),i.e(85262),i.e(95025),i.e(9343),i.e(59328)]).then(i.bind(i,77100))]);return async function(e){const{SourcesPropertiesEditorRenderer:t}=await Promise.all([i.e(81055),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(31788),i.e(15365),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(92597),i.e(18257),i.e(86834),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(33160),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(52253),i.e(44589),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(68805),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(5246),i.e(80387),i.e(75174),i.e(87795),i.e(57350),i.e(16803),i.e(26729),i.e(31403),i.e(37865),i.e(93807),i.e(4058),i.e(6437),i.e(25947),i.e(96840),i.e(23616),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(83754),i.e(87580),i.e(80928),i.e(90128),i.e(49515),i.e(21148),i.e(66985),i.e(7558),i.e(33269),i.e(11644),i.e(16531),i.e(22783),i.e(39656),i.e(32078),i.e(87410),i.e(63726),i.e(81562),i.e(51493),i.e(76037),i.e(69e3),i.e(66446),i.e(9325),i.e(34666),i.e(27024),i.e(88481),i.e(52694),i.e(35897),i.e(92642),i.e(81968),i.e(30468),i.e(37929),i.e(91987),i.e(64388),i.e(8762),i.e(32140),i.e(52316),i.e(50438),i.e(30454),i.e(3048),i.e(21341),i.e(51658),i.e(32387),i.e(36295),i.e(80915),i.e(53121),i.e(67534),i.e(6181),i.e(17686),i.e(67890),i.e(53233),i.e(13349),i.e(98784),i.e(63056),i.e(28435),i.e(12796),i.e(74607),i.e(82106),i.e(6877),i.e(8046),i.e(87613),i.e(76325),i.e(68189),i.e(95571),i.e(9258),i.e(12060)]).then(i.bind(i,982230)),s=new t(e);return null!==Mt&&(Mt.hide(),Mt=s),s.show(),s}({sources:t,propertyPages:[c(u(a,n),"style",h.t(null,void 0,i(931992))),c({definitions:[p(t,n)]},"displacement",h.t(null,void 0,i(371549))),c(_(l,n),"visibility",h.t(null,void 0,i(987733)))],undoModel:n,title:s,activeTabId:o,renamable:r})}getPriceAxisWidthChangedByName(e){return"left"===e?this._lhsPriceAxisWidthChanged:this._rhsPriceAxisWidthChanged}getPriceAxisMaxWidthByName(e){return"left"===e?this._lhsAxesWidth:this._rhsAxesWidth}timeAxisHeight(){return null!==this._timeAxisWidget?this._timeAxisWidget.size.height:0}withModel(e,t){this.hasModel()?t.call(e):this.modelCreated().subscribe(e,t,!0)}modelWV(){return this._modelWV.readonly()}hasModel(){return null!==this._modelWV.value()}
onRedraw(){return this._redraw}copyLineToOtherCharts(){const e=this.model(),t=e.selection().lineDataSources().filter((e=>e.isSynchronizable()));e.model().copyToOtherCharts(t,!0)}toggleLockSelectedObject(){const e=this.model();e.selection().lineDataSources().forEach((t=>{const i=t.properties().frozen.value();e.setProperty(t.properties().frozen,!i,(i?Op:Np).format({title:new P.TranslatedString(t.name(),t.title($o.TitleDisplayTarget.StatusLine))}),Lo.lineToolsDoNotAffectChartInvalidation)}))}hideDataSources(e){if(e.length){const t=e.map((e=>e.properties().visible)),i=e.map((()=>!1));this.model().setProperties(t,i,Vp.format({title:new P.TranslatedString(e[0].name(),e[0].title($o.TitleDisplayTarget.StatusLine))}))}}hideSelectedObject(){this.hideDataSources(this.model().selection().dataSources().filter((e=>!(0,Ii.isAlertLabel)(e))))}unlinkSelectedLine(){const e=this.model(),t=e.selection().lineDataSources();e.unlinkLines(t)}paneWidgetsWV(){return this._paneWidgets}paneWidgets(){return this._paneWidgets.value()}paneWidgetSeparators(e){const t=this.paneWidgets().indexOf(e),i={};return this._paneSeparators.forEach((e=>{e.topPaneIndex()===t&&(i.separatorBelow=e),e.bottomPaneIndex()===t&&(i.separatorAbove=e)})),i}activePaneWidget(){return this._activePaneWidget.readonly()}paneByState(e){return this._paneWidgets.value().find((t=>t.hasState()&&t.state()===e))??null}paneByCanvas(e){return this._paneWidgets.value().find((t=>t.hasCanvas(e)))??null}timeAxisByCanvas(e){return this._timeAxisWidget?.hasCanvas(e)?this._timeAxisWidget:null}selectPointMode(){return this.model().model().selectPointMode()}cancelRequestSelectPoint(){const e=this.model().model();e.cancelRequestSelectPoint(),e.setReplayStatus(e.isInReplay().value()?3:0),e.clearCurrentPosition()}requestSelectPoint(e,t){const i=this.model();return e.selectPointMode===D.SelectPointMode.Replay&&i.model().setReplayStatus(1),new Promise(((s,o)=>{const r=()=>!!this.isVisible()||(o("Chartwidget must be visible"),this.cancelRequestSelectPoint(),!1);if(!r())return;(0,D.resetToCursor)(!0),i.lineBeingCreated()&&i.cancelCreatingLine();let n=!1;const a={};i.model().onPointSelected().subscribe(a,((e,t)=>{n=!0,this._isVisible.unsubscribe(r),this._hideHint(),s({point:e,pane:t})}),!0),i.model().requestSelectPoint(e),this.startTrackingMode(),void 0!==t&&this._showEventHint(t),this._isVisible.subscribe(r),this.selectPointMode().subscribe((()=>{setTimeout((()=>{n||(this.selectPointMode().value()===D.SelectPointMode.None&&this._hideHint(),i.model().onPointSelected().unsubscribeAll(a),this._isVisible.unsubscribe(r),o("cancelled"))}))}),{once:!0})}))}showReplayOrderConfirmationDialog(){return this.model().isInReplay().value()?new Promise(((e,t)=>{(0,V.showConfirm)({text:h.t(null,void 0,i(558444)),onConfirm:t=>{e(),t.dialogClose()},onClose:t})})):Promise.resolve()}showSourceProperties(e,t){e===this.model().mainSeries()&&(t=Rt.TabNames.symbol),this.showChartPropertiesForSource(e,t)}onScroll(){return this._onScroll}onZoom(){return this._onZoom}onTagsChanged(){return this._tagsChanged}onWidget(){
return this._onWidget}containsVolume(){return this.model().dataSources().some((e=>(0,Nt.isStudy)(e)&&"Volume"===e.metaInfo().shortId))}containsStudy(e){return this.containsStudyByPredicate((t=>t.id===e||t.fullId===e))}isSmall(){return this._width()<550||this._height()<300}onCmeWidget(){return"cme"===this._widgetCustomer}widgetCustomer(){return this._widgetCustomer}compareSymbols(){return this._compareSymbols}images(e){window.TradingView.printing=!0;const t=this.model().selection().allSources();this.model().selectionMacro((e=>e.clearSelection())),this.model().model().recalculateAllPanes((0,Ds.globalChangeEvent)());const i=(t,i)=>{t.paint(i,ve.InvalidationMask.timeScale(ve.InvalidationLevel.Light,!0).invalidationForTimeScale());const s={showCollapsedStudies:Boolean(e?.showCollapsedStudies),status:e?.status};return t.getScreenshotData(s)},s=[],o=this.maximizedPaneWidget();if(null!==o){const e=this._paneWidgets.value().indexOf(o);s.push(i(o,ve.InvalidationMask.light().invalidationForPane(e)))}else{const e=this._paneWidgets.value();e.forEach(((t,o)=>{s.push(i(t,ve.InvalidationMask.light().invalidationForPane(o))),o<e.length-1&&s.push(this._paneSeparators[o].image())}))}let r;this._timeAxisWidget&&(this._timeAxisWidget.paint(ve.InvalidationMask.timeScale(ve.InvalidationLevel.Light,!0).invalidationForTimeScale()),r=this._timeAxisWidget.getScreenshotData()),window.TradingView.printing=!1,this.model().selectionMacro((e=>{t.forEach((t=>{e.addSourceToSelection(t)}))})),this.model().model().recalculateAllPanes((0,Ds.globalChangeEvent)()),this.model().model().lightUpdate();const n=this.mainSeriesQuotesAndMetainfo();return{panes:s,timeAxis:r,colors:{text:this.properties().childs().scalesProperties.childs().textColor.value(),bg:this.properties().childs().paneProperties.childs().background.value(),scales:this.properties().childs().scalesProperties.childs().lineColor.value()},meta:n.meta,ohlc:n.ohlc,quotes:n.quotes}}insertStudy(e,t,i,s,o){return this._insertStudyOrReplaceStub(e,t,void 0,i,s,o)}replaceStubByStudy(e,t,i,s,o,r){return e.updateDescriptor(t),this._insertStudyOrReplaceStub(t,i,e,s,o,r)}addOverlayStudy(e,t,i){const s=this.model();return this._options&&this._options.isSymbolAvailable?this._options.isSymbolAvailable(e).then((async o=>{if(!o)return null;await(0,Qe.studyMetaInfoRepository)().requestMetaInfo();const r=s.createStudyInserter({type:"java",studyId:"Overlay@tv-basicstudies"},[]),n={allowExtendTimeScale:i};if((0,d.isFeaturesetEnabled)("use_overrides_for_overlay")){const e=(0,En.factoryDefaults)("study_Overlay@tv-basicstudies.style");n.style=e}return r.setPropertiesState(n),r.setForceOverlay(t),r.insert((()=>Promise.resolve({inputs:{symbol:e},parentSources:[]})))})):Promise.resolve(null)}showIndicators(e,t){if(window.studyMarket)return window.studyMarket.visible().value()?void window.studyMarket.hide():(window.studyMarket.show(e,t),(0,u_.trackButtonClick)("hotkey","indicators",void 0,!0),window.studyMarket)}setSaveChartService(e){this._saveChartService=e,
null!==this._lineToolsSynchronizer&&this._lineToolsSynchronizer.setSaveChartService(e)}getSaveChartService(){return this._saveChartService}mainSeriesQuotesAndMetainfo(){let e,t,i;const s=this.hasModel()&&this.model().mainSeries();if(s){const o=e=>null==e?"":s.formatter().format(e,{signNegative:!0,useRtlFormat:!1}),r=e=>null==e?"":e+"";e={resolution:s.interval(),symbol:s.symbol(),values:s.legendValuesProvider().getValues(null)};const n=s.symbolInfo();n&&(e.symbol=n.full_name,e.description=n.description,e.exchange=n.exchange);const a=s.bars().last();null!==a&&(t=a.value.slice(1,5).map(o));const l=s.quotes();l&&(i={change:o(l.change),changePercent:r(l.change_percent),last:o(l.last_price)})}return{meta:e,ohlc:t,quotes:i}}isMultipleLayout(){return this._isMultipleLayout}updateCrossHairPositionIfNeeded(){if(this.hasModel()){const e=(0,Zt.lastMouseOrTouchEventInfo)();if(e.isTouch){const t=this.maximizedPaneWidget()||this._paneWidgets.value()[0];if(t.hasState()&&(!e.stylus&&(this._isLineToolModeExceptBrush()||(0,D.toolIsMeasure)(D.tool.value()))||this.selectPointMode().value()!==D.SelectPointMode.None)){const e=.5*this.model().model().timeScale().width(),i=.5*t.state().defaultPriceScale().height();t.setCursorPosition(e,i)}const i=this.model().model().crosshairSource();i.updateAllViews((0,Ds.sourceChangeEvent)(i.id()))}}}trackingModePaneWidget(){if(!(0,Zt.lastMouseOrTouchEventInfo)().isTouch)return null;for(const e of this.paneWidgets())if(e.trackingModeEnabled())return e;return null}startTrackingMode(){if((0,Zt.lastMouseOrTouchEventInfo)().isTouch){this.exitTrackingMode(),this.updateCrossHairPositionIfNeeded();const e=this.maximizedPaneWidget()||this._paneWidgets.value()[0],t=this.model().model().crosshairSource().currentPoint();e.startTrackingMode(t,t)}}exitTrackingMode(){(0,Zt.lastMouseOrTouchEventInfo)().isTouch&&this.paneWidgets().some((e=>e.trackingModeEnabled()))&&(this.paneWidgets().forEach((e=>e.exitTrackingMode())),this.model().model().clearCurrentPosition())}onToolChanged(){const e=this.model().model();e.lineBeingCreated()&&!e.lineBeingCreateFromExternal()&&this._cancelCreatingLine(),this.selectPointMode().value()!==D.SelectPointMode.None&&this.cancelRequestSelectPoint(),this.exitTrackingMode()}setInLoadingState(e){this._inLoadingState=e}paint(e){this._drawTime.setValue(performance.now());const t=e??ve.InvalidationMask.full();t.validationActions().forEach((e=>e()));const i=this.maximizedPaneWidget();this._paneWidgets.value().forEach(((e,s)=>{null!==i&&i!==e||e.paint(t.invalidationForPane(s),t.invalidationForTimeScale())})),this._timeAxisWidget&&this._timeAxisWidget.paint(t.invalidationForTimeScale()),Fp?.(),this._redraw.fire()}GUIResetScales(){(0,_t.trackEvent)("GUI","Reset Scales"),this.hasModel()&&this.model().resetScales()}applyOverrides(e){const t={};for(const[i,s]of Object.entries(e))i.startsWith("mainSeriesProperties.priceAxisProperties")||(t[i]=s);if((0,En.applyPropertiesOverrides)(this.properties(),void 0,!1,t,void 0),this.hasModel()){(0,
En.applyPropertiesOverrides)(this.model().model().properties(),void 0,!1,t),(0,En.applyPropertiesOverrides)(this.model().mainSeries().properties(),void 0,!1,t,"mainSeriesProperties"),this.model().model().sessions().applyOverrides(t);const e=this.model().model().watermarkSource();null!==e&&e.applyOverrides(t)}}showFundamentals(e){this.showIndicators(e?[e]:void 0,"fundamentals")}maximizedPaneWidget(){return this._paneWidgets.value().find((e=>e.maximized().value()))??null}hasMaximizedPane(){return null!==this.maximizedPaneWidget()}setActive(e){(0,Zt.lastMouseOrTouchEventInfo)().isTouch&&(e&&this.selectPointMode().value()!==D.SelectPointMode.None?this.startTrackingMode():this.exitTrackingMode());for(const e of this._paneWidgets.value())e.update();e||this.model().selectionMacro((e=>{e.clearSelection()})),this._isActive.setValue(e)}justActivated(){return this._justActivated}setActivePaneWidget(e){this._activePaneWidget.setValue(e)}onPaneWidgetDestroyed(e){this._activePaneWidget.value()===e&&this._activePaneWidget.setValue(null)}getResizerDetacher(){return this._options}toggleFullscreen(){const e=this.getResizerDetacher();e.fullscreenable.value()&&(e.fullscreen.value()?e.exitFullscreen():e.requestFullscreen())}async generalPropertiesDefinitions(){return await(0,Qe.studyMetaInfoRepository)().findAllJavaStudies(),this._getChartPropertyDefinitionsViewModel().then((e=>e.propertyPages()))}propertiesDefinitionsForSource(e){return(0,Ut.isLineTool)(e)||(0,Nt.isStudy)(e)||(0,Gt.isStudyLineTool)(e)?e.getPropertyDefinitionsViewModel().then((e=>null===e?null:e.propertyPages())).catch((e=>(Bp.logWarn(e),null))):Promise.resolve(null)}backgroundTopTheme(){return this._backgroundTopTheme.readonly()}backgroundBasedTheme(){return this._backgroundBasedTheme.readonly()}backgroundBottomTheme(){return this._backgroundBottomTheme.readonly()}state(e){if(this.hasModel()){const t=this.model().state(e);return t.chartId=this.id(),t}return this._content}lineToolsAndGroupsDTO(){return(0,a.ensureNotNull)(this._lineToolsSynchronizer).prepareDTO()}applyLineToolUpdateNotification(e,t){return(0,a.ensureNotNull)(this._lineToolsSynchronizer).applyLineToolUpdateNotification(e,t)}reloadAllLineTools(){(0,a.ensureNotNull)(this._lineToolsSynchronizer).reloadAllLineTools()}startApplyingLineToolUpdateNotification(){this._lineToolsSynchronizer?.startApplyingLineToolUpdateNotification()}endApplyingLineToolUpdateNotification(){this._lineToolsSynchronizer?.endApplyingLineToolUpdateNotification()}applyAlertIdByExternalSource(e,t){this._lineToolsSynchronizer?.applyAlertIdByExternalSource(e,t)}deleteAlertByExternalSource(e,t){this._lineToolsSynchronizer?.deleteAlertByExternalSource(e)}shouldBeSavedEvenIfHidden(){return this.hasModel()?this.model().model().shouldBeSavedEvenIfHidden():!!this._options.content.shouldBeSavedEvenIfHidden}getTimeScale(){return this._timeAxisWidget}showObjectsTreePanelOrDialog(){let e=!1;const t=window.widgetbar;if(t&&t.isVisible()){const i=(0,a.ensureNotNull)(t.setPage("object_tree")),s=(0,a.ensureNotNull)(i.widget("object_tree"));(0,
a.ensureDefined)(s.properties).setValue({selectedPage:"object_tree"}),e="object_tree"===i.name}e||this.showObjectsTreeDialog()}showObjectsTreeDialog(){this._objectTreeDialogController?.show()}addCustomWidgetToLegend(e,t){this._customLegendWidgetsFactoryMap.set(e,t);for(const i of this.paneWidgets())i.addCustomWidgetToLegend(e,t)}applyIndicatorsToAllChartsAvailable(){if(!this.chartWidgetCollection().applyIndicatorsToAllChartsAvailable())return!1;for(const e of this.model().model().panes()){if(e.sourcesByGroup().all().some((e=>(0,Nt.isStudy)(e)&&!Ft(e))))return!0}return!1}widget(){return(0,a.ensureNotNull)(this._mainDiv)}addCompareAsOverlay(e,t,i){const s=this.model();return(0,a.ensureDefined)(this._options.isSymbolAvailable)(e).then((async o=>{if(!o)return null;await(0,Qe.studyMetaInfoRepository)().requestMetaInfo();const r=s.createStudyInserter({type:"java",studyId:"Overlay@tv-basicstudies"},[]);return r.setForceOverlay(!0),r.setPreferredPriceScale("as-series"),!0!==i&&r.setTargetPriceScaleMode({percentage:!0}),void 0!==t&&r.setPropertiesState({allowExtendTimeScale:t}),r.insert((async()=>({inputs:{symbol:e},parentSources:[]})))}))}scrollHelper(){return this._scrollHelper}resize(){const e=this._height()+"px",t=this._width()+"px",i=(0,a.ensureNotNull)(this._mainDiv);i.style.height=e,i.style.width=t,this._elMainTable.style.height=e,this._elMainTable.style.width=t,this._resizeHandler&&this._mainDiv&&this._resizeHandler()}chartPainted(){return this._drawPlanned?(null===this._chartPaintedPromise&&(this._chartPaintedPromise=(0,gt.createDeferredPromise)()),this._chartPaintedPromise.promise):Promise.resolve()}setDataWindowWidget(e){this._dataWindowWidget=e}removeDataWindowWidget(){this._dataWindowWidget=null}showSelectedSourcesProperties(e){const t=this.model().selection().dataSources();if(1===t.length)this.showSourceProperties(t[0],e);else{const i=t.filter(Ut.isLineTool);i.length>0&&this.showChartPropertiesForSources({sources:i,tabName:e})}}setTimingsMeter(e){this._timingsMeter=e,this._updateTimingsMeterState()}onAboutToBeDestroyed(){return this._aboutToBeDestroyed}executeActionById(e){if("takeScreenshot"===e)return console.warn('Action "takeScreenshot" is deprecated. Use method "takeScreenshot" instead'),void this._chartWidgetCollection.takeScreenshot();const t=this.actions()[e];t?t.execute():console.warn("Unknown action id: "+e)}getCheckableActionState(e){const t=this.actions()[e];if(t){if(t.isCheckable())return t.isChecked();console.warn("Action "+e+" has no state")}else console.warn("Unknown action id: "+e);return null}connect(){this._chartSession.isConnected().subscribe(this._onChartSessionIsConnectedChanged),this._chartSession.criticalError().subscribe(this,this._onChartSessionCriticalError),this._chartSession.connect(this._onData.bind(this))}finishInitWithoutConnect(){this._chartSession.disable(),this._init(),this._chartWidgetInitialized.fire()}reconnect(){this._chartSession.disconnect(),this._chartSession.connect()}update(){if(this.hasModel()){for(const e of this._paneWidgets.value())e.update()
;this._timeAxisWidget&&this._timeAxisWidget.update()}}setPriceAxisHovered(e,t){t?this._hoveredPriceAxes.add(e):this._hoveredPriceAxes.delete(e),this._anyAxisHovered.setValue(this._hoveredPriceAxes.size>0)}anyPriceAxisHovered(){return this._anyAxisHovered.readonly()}linkingGroupIndex(){return this._linkingGroupIndex}offsetInDocument(e){const t=this.paneByState(e);if(!t)return{left:NaN,top:NaN};const i=t.getElement().getBoundingClientRect();return{left:Math.round(i.left+document.body.scrollLeft),top:Math.round(i.top+document.body.scrollTop)}}showHint(e,...t){0===e?this._showEventHint(...t):1===e&&this._showWarningHint(...t)}hotkeys(){return this._hotkeys}onAboutToLoadContent(){if(this._lineToolsSynchronizer?.destroy(),this._lineToolsSynchronizer=null,this.hasModel()){const e=this.model();for(const t of e.dataSources())(0,Ut.isLineTool)(t)&&t.detachAlert();e.isInReplay().value()&&e.switchToRealtime()}this._chartSession.disconnect()}async loadContent(e,t){this.screen.show();const i=this.model();i.model().setMaximizedPane(null),i.model().selectionMacro((e=>e.clearSelection()));const s=i.mainSeries();i.model().isInReplay().value()&&i.model().switchToRealtime();let o,r;i.crosshairSource().clearMeasure(),i.unloadDataSources(),i.model().alertsWatcher()?.detachSourceAlertLabels(s),this._chartSession.connect(this._onData.bind(this)),this._activePaneWidget.setValue(null),s.purgeSymbolInfo(),e.loading=!0,this._id=(0,a.ensureDefined)(e.chartId),await(0,Ut.ensureAllLineToolsLoadedForLayout)([e]),this._content=e,this._setSymbolIntervalContentOverrides={},this._initialLoading=t;const n=this._contentSeriesProperties();if(n&&(o=n,r=e.chartProperties.priceScaleSelectionStrategyName),!o)throw Error("An error occurred while determining main series on the chart");const l=s.style();this._mainSeriesProperties.mergeAndFire({visible:!0,symbol:o.symbol,timeframe:"",interval:o.interval||"D",style:o.style}),void 0!==r&&this._properties.childs().priceScaleSelectionStrategyName.setValue(r),l!==s.style()&&s.onChartStyleChanged(),this._init(),i.undoHistory().clearStack(),this._chartWidgetInitialized.fire(),i.model().alertsWatcher()?.syncSourceAlertLabels(s)}resetDrawingState(){if((0,D.resetToCursor)(!0),this.hasModel()){const e=(0,a.ensureNotNull)(this.model().crosshairSource().pane);(0,a.ensureNotNull)(this.paneByState(e)).cancelCreatingLineTool(),this.model().selectionMacro((e=>{e.clearSelection()}))}}chartFloatingTooltipVisible(){return this._chartWidgetCollection.chartFloatingTooltipVisible().value()}_clearSelectionHotkey(){return{desc:"Cancel selection",hotkey:27,handler:()=>{if(this._checkIsTradedGroupSelected()&&(0,jc.tradingService)()?.clearTradedContextLinking(),this.selectPointMode().value()!==D.SelectPointMode.None)return this.selectPointMode().value()===D.SelectPointMode.Replay&&this._chartWidgetCollection.getAll().forEach((e=>{e!==this&&e.selectPointMode().value()===D.SelectPointMode.Replay&&e.cancelRequestSelectPoint()})),void this.cancelRequestSelectPoint();if(this.hasModel()){const e=this.model().selection().lineDataSources()
;1===e.length&&(0,Ut.isEditableTextLineTool)(e[0])&&e[0].textEditingJustFinished()||this.model().selectionMacro((e=>{this._cancelCreatingLine(),e.clearSelection()}));const t=this.model().model().customSourceMovingHitTestData();t&&t.cancelMoveHandler&&t.cancelMoveHandler()&&(t.cancelled=!0,this.model().model().setMovingCustomSource(null,null),this.model().model().lightUpdate())}},isDisabled:()=>{if(!this.hasModel())return!0;const e=this.model(),t=0===e.selection().allSources().length,i=null===e.crosshairSource().measurePane().value(),s=this.selectPointMode().value()===D.SelectPointMode.None;return t&&i&&s}}}async _insertStudyOrReplaceStub(e,t,i,s,o,r){try{{const i=this.model().model().chartApi().canCreateStudy({id:"java"===e.type?e.studyId:"",child:t.length>0,fundamental:s?.isFundamental});if(!i.success)throw(0,To.showStudiesLimitGoProDialog)(this.model().model(),i),new $p($p.Reasons.Limits)}return t.length&&await new Promise(((e,t)=>{(0,xt.runOrSignIn)(e,{source:"study on study",onUnmountEvent:()=>t(new $p(qp.Canceled))})})),r?.(),"java"===e.type&&await(0,Qe.studyMetaInfoRepository)().requestMetaInfo(),await this._insertOrReplaceStubByStudyImpl(e,t,i,s,o)}catch(e){return i&&e instanceof $p&&this.model().model().removeSource(i,!0),null}}_insertOrReplaceStubByStudyImpl(e,t,s,o,r){const n=this.model().createStudyInserter(e,t,o);n.setEventSource(o?.eventSource),n.setForceOverlay("java"===e.type&&"Volume@tv-basicstudies"===e.studyId&&(0,d.isFeaturesetEnabled)("volume_force_overlay"));const a=n.insert(((e,i,s)=>new Promise(((o,n)=>{this.selectPointMode().value()!==D.SelectPointMode.None&&this.cancelRequestSelectPoint(),r?o(r(e,i,s)):(0,Nt.isSymbolicStudy)(s)?((0,_t.trackEvent)("GUI","Confirmation dialogs","Symbol confirmation dialog"),Pt(this,e,s,o,(()=>n(new $p($p.Reasons.Canceled))),"symbol")):(0,Nt.hasConfirmInputs)(i)?((0,_t.trackEvent)("GUI","Confirmation dialogs","Inputs confirmation dialog"),Pt(this,e,s,o,(()=>n(new $p($p.Reasons.Canceled))))):o({inputs:{},parentSources:t})}))),void 0,s);return a.then((()=>{(0,D.hideAllIndicators)().value()&&(0,ft.toggleHideOptions)(!1)})).catch((e=>{s||(e===td.InsertionErrorCode.StudyCannotBeChild&&(0,V.showWarning)({title:h.t(null,void 0,i(633907)),text:h.t(null,void 0,i(900041)),buttonText:h.t(null,void 0,i(111898)),backdrop:!0}),e===td.InsertionErrorCode.CannotCompilePub&&(0,V.showWarning)({title:h.t(null,void 0,i(621984)),text:h.t(null,void 0,i(386377)),buttonText:h.t(null,void 0,i(111898)),backdrop:!0}),e===td.InsertionErrorCode.CannotGetMetainfo&&(0,V.showWarning)({title:h.t(null,void 0,i(212564)),text:h.t(null,void 0,i(285e3)),buttonText:h.t(null,void 0,i(111898)),backdrop:!0}))})),a}async _showChartProperties(e,t,i,s){if(!this.hasModel())return null;t&&((0,R.setValue)("properties_dialog.active_tab.chart",t),i.tabName=t);const o=await $t(e,this.model(),i,this._options.chartWidgetCollection,s);return o?.visible().value()?o:null}_createLineToolsSynchronizerIfNeeded(){{this._lineToolsSynchronizer?.destroy(),this._lineToolsSynchronizerHasChanges??=new H.WatchedValue(!1),
this._lineToolsSynchronizerHasChanges.setValue(!1);const e={readOnlyMode:this.readOnly(),migrateSyncedLineTools:this===this._options.chartWidgetCollection.getAll()[0]},t={layoutId:this.layoutId(),chartId:this._id,clientId:this._chartWidgetCollection.clientId},i=E_.LineToolsSynchronizer;this._lineToolsSynchronizer=new i(t,this.model().model(),e,this._lineToolsSynchronizerHasChanges),null!==this._saveChartService&&this._lineToolsSynchronizer.setSaveChartService(this._saveChartService),this._lineToolsSynchronizer.invalidateAll(!0),this.hasModel()&&this.model().model().setLineToolsSynchronizer(this._lineToolsSynchronizer)}}_updateThemedColor(){const e=this.model().model(),t=e.backgroundColorAtYPercentFromTop(.5);let i=e.backgroundTopColor().value(),s=e.backgroundColor().value();const o=(0,pt.isColorDark)(t),r=(0,pt.isColorDark)(i),n=(0,pt.isColorDark)(s);this.widget().classList.toggle("chart-widget--themed-dark",o),this.widget().classList.toggle("chart-widget--themed-light",!o),this.widget().classList.toggle("chart-widget__top--themed-dark",r),this.widget().classList.toggle("chart-widget__top--themed-light",!r),this.widget().classList.toggle("chart-widget__bottom--themed-dark",n),this.widget().classList.toggle("chart-widget__bottom--themed-light",!n),this._backgroundTopTheme.setValue(r?"dark":"light"),this._backgroundBasedTheme.setValue(o?"dark":"light"),this._backgroundBottomTheme.setValue(n?"dark":"light"),i===s&&(0,L.isStdThemedDefaultValue)("chartProperties.paneProperties.background",i,this._backgroundBasedTheme.value())&&(i=null,s=null);for(const e of this._paneWidgets.value())e.updateThemedColors({topColor:i,bottomColor:s})}_isLineToolModeExceptBrush(){const e=D.tool.value();return(0,se.isLineToolName)(e)&&!(0,se.isLineDrawnWithPressedButton)(e)&&this.selectPointMode().value()===D.SelectPointMode.None}_cancelCreatingLine(){const e=this.model().model(),t=e.lineBeingCreated();if(null!==t){const i=(0,a.ensureNotNull)(e.paneForSource(t));(0,a.ensureNotNull)(this.paneByState(i)).cancelCreatingLineTool(),t.toolname===D.tool.value()&&(0,D.resetToCursor)()}const i=e.crosshairSource().measurePane().value();if(null!==i){(0,a.ensureNotNull)(this.paneByState(i)).cancelMeasuring()}}_adjustSize(e){let t=0;const i=this.hasModel()?this.model().model().priceScaleSlotsCount():null,s=new Uint32Array(null===i?0:i.left),o=new Uint32Array(null===i?0:i.right),r={value:0},n={value:0},a=(0,Kt.getCanvasDevicePixelRatio)(document.body),l=(e,t)=>e+t,c=(e,t,i)=>{Array.isArray(i)?i.forEach(((t,i)=>{e[i]=Math.max(e[i],t)})):t.value=Math.max(t.value,i)},h=(e,t,i)=>{if(i.value>t){const s=i.value/t;let o=0;for(let t=0;t<e.length;t++)e[t]=Math.ceil(e[t]*s),o+=e[t];return o}return t},d=this._width(),u=this._height(),_=this._paneSeparators.length,p=this.hasMaximizedPane()?0:ni.height()*_,m=null!==this._timeAxisWidget?this._timeAxisWidget.optimalHeight():0;let g=u-m>=61?m:0;g%2&&(g+=1);const S=this._paneWidgets.value(),v=Math.max(1,Math.floor((u-p-g)/S.length));let f=0,b=null;const y=this.maximizedPaneWidget();for(const e of S)if(!y||y===e){
e.leftPriceAxisesContainer().updateCurrencyLabels();const i=e.leftPriceAxisesContainer().optimalWidths();e.rightPriceAxisesContainer().updateCurrencyLabels();const a=e.rightPriceAxisesContainer().optimalWidths();c(s,r,i),c(o,n,a),y!==e&&e.state().collapsed().value()?f+=Math.min(v,e.collapsedHeight()):(t+=e.stretchFactor(),b=e)}let w=s.reduce(l,0);0===w&&0!==s.length&&0!==r.value&&(s[0]=w=r.value);let C=o.reduce(l,0);0===C&&0!==o.length&&0!==n.value&&(o[0]=C=n.value),w=h(s,w,r),C=h(o,C,n);let T=Math.max(d-w-C,0);if(T<=102){w=0,C=0,T=d;for(let e=0;e<s.length;e++)s[e]=0;for(let e=0;e<o.length;e++)o[e]=0}for(const e of this._paneSeparators)e.adjustSize();const P=p+f+g,M=u<P?0:u-P,x=M/t;let I=0,L=!1;const A=this.hasModel()?this.model().model():void 0;this._paneWidgets.value().forEach(((e,t)=>{void 0!==A&&e.setState(A.panes()[t]);let i=0;if(this.hasMaximizedPane())i=this.maximizedPaneWidget()===e?M:0;else if(e.state().collapsed().value())i=Math.min(v,e.collapsedHeight());else{const t=e===b?Math.ceil((M-I)*a)/a:Math.round(e.stretchFactor()*x*a)/a;i=Math.max(t,2),I+=i}e.setPriceAxisSizes("left",i,s),e.setPriceAxisSizes("right",i,o),L=L||i!==e.height(),e.setSize((0,nt.size)({width:T,height:i})),A&&e.state()&&A.setPaneHeight(e.state(),i)})),null!==this._timeAxisWidget&&this._timeAxisWidget.setSizes((0,nt.size)({width:T,height:g}),s,o),A&&A.setWidth(T,e),this._controlBarNavigation&&this._controlBarNavigation.updatePosition(),this._lhsAxesWidth!==w&&(this._lhsAxesWidth=w,this._lhsPriceAxisWidthChanged.fire(w)),this._rhsAxesWidth!==C&&(this._rhsAxesWidth=C,this._rhsPriceAxisWidthChanged.fire(C)),L&&N.emit("panes_height_changed")}_makePaneWidgetsAndSeparators(){const e=this.model().model().panes(),t=e.length,i=this._paneWidgets.value().length,s=this._paneWidgets.value().slice();for(let e=t;e<i;e++){(0,a.ensureDefined)(s.pop()).destroy();const e=this._paneSeparators.pop();e&&e.destroy()}const o=this._options.containsData;for(let r=0;r<t;r++){const t=r>=i,n={contextMenuEnabled:this._options.paneContextMenuEnabled,currencyConversionEnabled:this._options.currencyConversionEnabled,unitConversionEnabled:this._options.unitConversionEnabled,metricConversionEnabled:this._options.metricConversionEnabled,handleScale:this._options.handleScale,handleScroll:this._options.handleScroll,priceScaleContextMenuEnabled:this._options.priceScaleContextMenuEnabled,legendWidgetEnabled:this._options.legendWidgetEnabled&&e[r].mode()===K.PaneMode.Regular,sourceStatusesWidgetEnabled:!o,sourceStatusesWidget:this._options.sourceStatusesWidget,marketStatusWidgetEnabled:this._options.marketStatusWidgetEnabled&&!o,chartWarningWidgetEnabled:this._options.chartWarningWidgetEnabled&&!o,chartWarningWidget:this._options.chartWarningWidget,dataProblemWidgetEnabled:this._options.dataProblemWidgetEnabled&&!o,legendWidget:this._options.legendWidget,propertyPagesEnabled:this._options.propertyPagesEnabled,sourceSelectionEnabled:this._options.sourceSelectionEnabled,controlsEnabled:this._options.paneControlsEnabled,croppedTickMarks:this._options.croppedTickMarks,
countdownEnabled:this._options.countdownEnabled,customLegendWidgetFactories:new Map(this._customLegendWidgetsFactoryMap),useKineticScroll:this._options.useKineticScroll,pineSourceStatusEnabled:!this.readOnly(),alertStatusEnabled:!this.readOnly()&&!this._onWidget};if(void 0!==this._options.paneContextMenu&&(n.contextMenu=this._options.paneContextMenu),void 0!==this._options.priceScaleContextMenu&&(n.priceScaleContextMenu=this._options.priceScaleContextMenu),t){const t=new Js(this,e[r],n,this._paneWidgetsSharedState);if(s.push(t),r>0){const e=new ni(this,r-1,r);this._paneSeparators.push(e),this._timeAxisWidget?this._elMainTable.insertBefore(e.getElement(),this._timeAxisWidget.getElement()):this._elMainTable.appendChild(e.getElement())}this._timeAxisWidget?this._elMainTable.insertBefore(t.getElement(),this._timeAxisWidget.getElement()):this._elMainTable.appendChild(t.getElement())}else{s[r].updateOptions(n)}}const r=this.maximizedPaneWidget();for(const e of this._paneSeparators)r?e.hide():e.show();for(let i=0;i<t;i++){const t=e[i],o=s[i];o.hasState()&&o.state()===t?o.updatePriceAxisWidgetsStates():o.setState(t)}for(let e=t;e--;)s[e].updateControls();this._paneWidgets.setValue([...s]),this._errorRendererResource.callFunction((e=>{e?.updatePaneWidgets()})),this._updateThemedColor()}_width(){return this._options.width.value()}_height(){return this._options.height.value()}_update(e,t){const i=e?e.fullInvalidation():ve.InvalidationLevel.Full,s=!!e&&e.isVisibleTimeRangeLockedOnResize();if(null!==this._timingsMeter&&this._timingsMeter.startDraw(i),i===ve.InvalidationLevel.Full&&(this.hasModel()?this._updateGui(s):this._adjustSize(s)),i>ve.InvalidationLevel.Cursor&&(this._timeAxisWidget?.update(),this._paneWidgets.value().forEach((e=>{e.updatePriceAxisWidgets()})),this._applyTimeScaleInvalidations(e,t),this._invalidationMask?.fullInvalidation()===ve.InvalidationLevel.Full&&(this._invalidationMask.merge(e),this._adjustSize(this._invalidationMask.isVisibleTimeRangeLockedOnResize()),this._applyTimeScaleInvalidations(this._invalidationMask,t),e=this._invalidationMask,this._invalidationMask=null)),this.paint(e),this._dataWindowWidget){const t=e.maxPaneInvalidation();t===ve.InvalidationLevel.Full?this._dataWindowWidget.fullUpdate():t>ve.InvalidationLevel.None&&this._dataWindowWidget.update()}this._paneWidgets.value().forEach(((t,i)=>{t.updateStatusWidget(e.invalidationForPane(i))})),null!==this._timingsMeter&&this._timingsMeter.stopDraw(),e&&e.panesOrderInvalidated()&&N.emit("panes_order_changed")}_initMaximizeHotkey(e){const t=e=>!e.defaultPrevented&&(0,ht.modifiersFromEvent)(e)===ht.Modifiers.Alt&&!(0,D.toolIsDemonstration)(D.tool.value()),i=e=>{t(e)&&e.stopPropagation()},s=e=>{t(e)&&(e.preventDefault(),e.stopPropagation(),this.toggleFullscreen())};return e.addEventListener("mousedown",i,!0),e.addEventListener("click",s,!0),()=>{e.removeEventListener("mousedown",i,!0),e.removeEventListener("click",s,!0)}}_onMousewheel(e){if(!this.hasModel())return;if(!this.model().model().zoomEnabled()||null===this._mouseWheelHelper)return
;if(this.model().timeScale().isEmpty())return;const t=this._mouseWheelHelper.processWheel(e),i=t.deltaX,s=-t.deltaY;if(0!==i&&this._options.handleScroll.mouseWheel||0!==s&&this._options.handleScale.mouseWheel){if(e.cancelable&&e.preventDefault(),0!==s&&this._options.handleScale.mouseWheel){const t=Math.sign(s)*Math.min(1,Math.abs(s)),i=(0,a.ensureNotNull)(this._mainDiv).getBoundingClientRect(),o=e.clientX-this._lhsAxesWidth-i.left;if(!Number.isFinite(o)||!Number.isFinite(t))return void Bp.logWarn("Incorrect mouse wheel processing: scrollPosition: "+o+", zoomScale: "+t);const r=new ui.EnvironmentState(e).mod();this.model().model().zoomTime(o,t,!!r||void 0),this._onZoom.fire(r)}0!==i&&this._options.handleScroll.mouseWheel&&this.model().scrollChart(-80*i)}}_beginRequestActive(){const e=this._activeChartWidgetWV.value()!==this;if(this._chartWidgetCollection.activeChartWidget.setValue(this),e){this._chartWidgetCollection.ariaDescribeChart(this._activeChartWidgetWV.value());const e=(0,Zt.lastMouseOrTouchEventInfo)();e.isTouch&&!e.stylus&&this._isLineToolModeExceptBrush()&&this.updateCrossHairPositionIfNeeded(),this._justActivated=!0}}_endRequestActive(){this._justActivated&&setTimeout((()=>this._justActivated=!1),0)}_requestActive(){this._beginRequestActive(),this._endRequestActive()}_createSessions(e){const t=this.showGeneralChartProperties.bind(this,Rt.TabNames.events);e.createSessions(t)}_createPrePostMarket(e){{const t=this.showGeneralChartProperties.bind(this,Rt.TabNames.scales);e.createPrePostMarket(t)}}_createVolumeIfNeeded(){const e=(0,d.isFeaturesetEnabled)("create_volume_indicator_by_default")&&this._options.addVolume,t=!this._content,i=(0,d.isFeaturesetEnabled)("create_volume_indicator_by_default_once");this._content&&this._content.loading;if(e&&t){const e=()=>{setTimeout((async()=>{const e=this.model().model(),t=e.mainSeries().symbolInfo();if(!t)return;const i=(0,Q.hasVolume)(t);if(!this.containsVolume()&&i){const t=(0,En.factoryDefaults)("chartproperties.volumePaneSize");await(0,Qe.studyMetaInfoRepository)().requestMetaInfo();const i=e.createStudyInserter({type:"java",studyId:"Volume@tv-basicstudies"});i.setForceOverlay((0,d.isFeaturesetEnabled)("volume_force_overlay")),i.setPaneSize(t),(0,d.isFeaturesetEnabled)("hide_volume_ma")&&i.setPropertiesState({styles:{vol_ma:{display:0}}}),i.insert()}else if(!i&&this.containsVolume()){const t=this.model().dataSources().filter((e=>(0,Nt.isStudy)(e)&&"Volume"===e.metaInfo().shortId))[0];e.removeSource(t)}}))};this.model().mainSeries().dataEvents().symbolResolved().subscribe(this,e,i)}}onModelTagsChanged(){this._tagsChanged.fire()}_initBackgroundColor(){null===this._backgroundTopColorSpawn&&(this._backgroundTopColorSpawn=this.model().model().backgroundTopColor().spawn(),this._backgroundTopColorSpawn.subscribe(this._onBackgroundColorChanged.bind(this))),null===this._backgroundBottomColorSpawn&&(this._backgroundBottomColorSpawn=this.model().model().backgroundColor().spawn(),this._backgroundBottomColorSpawn.subscribe(this._onBackgroundColorChanged.bind(this)))}
_updateGui(e){this.hasModel()&&(this._makeTimeAxisWidget(),this._makePaneWidgetsAndSeparators(),this._elMainTable.style.userSelect="none",this._adjustSize(e))}_onChartStyleChanged(){(0,_t.trackEvent)("Chart",`Chart Style ${this.model().mainSeries().getStyleShortName().toUpperCase()}`)}_addPerfMark(e){(0,Ep.addPerfMark)(`ChartWidget.${this._id}.${e}`)}_setElement(e){if(!e)return;if(this._mainDiv){this._mainDiv.remove();const e=document.createRange();e.selectNodeContents((0,a.ensureNotNull)(this._parent)),e.deleteContents()}this._controlBarNavigation&&(this._controlBarNavigation.destroy(),this._controlBarNavigation=null),null!==this._removeMaximizeHotkey&&this._removeMaximizeHotkey(),this._removeMaximizeHotkey=this._initMaximizeHotkey(e);const t=e.ownerDocument,s=t.createElement("div");s.classList.add("chart-container-border"),e.insertBefore(s,e.firstChild),this._parent=s;const o=t.createElement("div");if(o.classList.add("chart-widget"),this._mainDiv=o,this._elTooltipDiv=t.createElement("div"),this._elTooltipDiv.className="tooltip-wrapper",this._mainDiv.appendChild(this._elTooltipDiv),this._elMainTable=t.createElement("div"),this._elMainTable.className="chart-markup-table",this._mainDiv.appendChild(this._elMainTable),o.setAttribute("role","region"),o.setAttribute("aria-label",h.t(null,{replace:{index:this.id()}},i(843367))),this._hotkeysListener&&this._hotkeysListener.destroy(),this._errorRendererResource.callFunction((e=>{e?.setContainer(this._parent)})),this._hotkeysListener=new Dt.ChartHotkeysListener(this,this._mainDiv),(this._options.controlBarEnabled||(0,d.isFeaturesetEnabled)("control_bar"))&&this._createControlBar(),this._options.handleScale.mouseWheel||this._options.handleScroll.mouseWheel){this._mouseWheelHelper=new ti;const e=this._onMousewheel.bind(this);this._onWheelBound=e,this._mainDiv.addEventListener("wheel",e,{passive:!1})}this._mainDiv.addEventListener("mouseenter",(()=>this._isHovered.setValue(!0))),this._mainDiv.addEventListener("mouseleave",(()=>this._isHovered.setValue(!1))),this.resize(),this._justActivated=!1,this.withModel(this,(()=>{s.appendChild(o),o.addEventListener("mousedown",this._beginRequestActive.bind(this)),o.addEventListener("mouseup",this._endRequestActive.bind(this)),o.addEventListener("touchstart",this._beginRequestActive.bind(this)),o.addEventListener("touchmove",this._endRequestActive.bind(this)),o.addEventListener("touchend",this._endRequestActive.bind(this)),o.addEventListener("click",this._requestActive.bind(this))})),this._inited&&(null!==this._timeAxisWidget&&(this._timeAxisWidget.destroy(),this._timeAxisWidget=null),this._paneWidgets.value().forEach((e=>{e.destroy()})),this._paneWidgets.setValue([]),this._paneSeparators.forEach((e=>{e.destroy()})),this._paneSeparators.length=0,this._update(ve.InvalidationMask.full(),performance.now()))}_init(){this.hasModel()&&this.model().mainSeries().clearData(),this._initColors(),this._makeDefaultGui();this._makeDefaultModel(),(()=>{this._checkObsoleteTimezone(),
this._chartSession&&this._chartSession.connected()&&this.model().model().restart(),this._content&&(this._initColors(),this._updateGui(),this.update()),this._resizeHandler=()=>{this._invalidationHandler(ve.InvalidationMask.full())},this._resizeHandler(),(0,a.ensureNotNull)(this._parent).appendChild((0,a.ensureNotNull)(this._mainDiv)),this._spinner&&(this._spinner.stop(),this._spinner=null),this._activateSymbolSearchHotkeys(),this.model().timeScale().onScroll().subscribe(this,(()=>this._onScroll.fire())),this._inited=!0})()}_makeDefaultModel(){let e;if(this._content&&this._content.timeScale.points){const t=this._content.timeScale.points.items[0];e={startDate:t}}const t=()=>{const t={readOnly:this.readOnly(),isSnapshot:!!this._containsData,...(0,St.pickFields)(this._options,["timeScale","crossHair","chartEventsEnabled","newsNotificationsEnabled","esdEnabled","latestUpdatesEnabled","continuousContractSwitchesEnabled","futuresContractExpirationEnabled","countdownEnabled","lastPriceAnimationEnabled","currencyConversionEnabled","unitConversionEnabled","metricConversionEnabled","watermarkEnabled","shiftVisibleRangeOnNewBar","hideIdeas","onWidget"])},i=new c_({chartSession:this._chartSession,invalidateHandler:this._invalidationHandler,properties:this._properties,seriesProperties:this._mainSeriesProperties,dataRequest:e,chartWidget:this,undoHistory:this._options.undoHistory,barsMarksContainersFactory:this._options.barsMarksContainersFactory,options:t,hibernateVW:this._collapsed,linkingGroupWV:this._linkingGroupIndex,isAutoSaveEnabled:this._saveChartService?.autoSaveEnabled()??new H.WatchedValue(!0),drawTime:this._drawTime.readonly()});return i.model().fullUpdate(),this._createSessions(i.model()),this._createPrePostMarket(i.model()),i};this._modelWV.setValue(this._modelWV.value()||t(),!0),this.model().model().setChartSaveTime(1e3*this._chartWidgetCollection.metaInfo.lastModified.value()),this._createVolumeIfNeeded();if(this._content){let e=this._setSymbolIntervalContentOverrides;Rp&&this._initialLoading&&(e={...e,symbol:this._defSymbol,interval:this._defInterval??void 0,style:this._defStyle??void 0},this._defInterval&&$.Interval.isRange(this._defInterval)&&(e.style=11)),this._applySavedModelState(this._containsData,e),this._setSymbolIntervalContentOverrides={},Rp&&this._defSymbol&&this.model().model().recalculatePriceRangeOnce()}this._setActions(),this._createLineToolsSynchronizerIfNeeded(),(()=>{const e=this.model();e.onTagsChanged().subscribe(this,(()=>this.onModelTagsChanged())),this._initBackgroundColor(),this._updateGui(),this._modelCreated.fire(e),this._tagsChanged.fire();const t=e.mainSeries(),i=t.properties().childs();this._defTimeframe&&t.setDefaultTimeframe(this._defTimeframe),this._defMetric&&t.setMetric(this._defMetric),t.dataEvents().symbolNotPermitted().subscribe(null,(e=>t.setSymbolParams({symbol:e}))),this._symbolWV.setValue(i.symbol.value()),i.symbol.subscribe(this,(e=>this._symbolWV.setValue(e.value()))),this._resolutionWV.setValue(i.interval.value()),
i.interval.subscribe(this,(e=>this._resolutionWV.setValue(e.value()))),window.loginStateChange.subscribe(this,this._handleLoginStateChanged),this._handleLoginStateChanged(),t.dataEvents().symbolResolved().subscribe(this,(e=>{const i=e.pro_name,s=e.pro_perm;i&&this._options.isSymbolAvailable&&this._options.isSymbolAvailable(i,s).then((e=>{e||t.setSymbolParams({symbol:window.DEFAULT_SYMBOL})}))})),void 0!==this._options.requestFallbackSymbol&&t.dataEvents().symbolGroupNotPermitted().subscribe(this,(e=>{(0,a.ensureDefined)(this._options.requestFallbackSymbol)(i.symbol.value(),{type:"group_not_permitted",symbolGroup:e}).then((e=>{e&&t.setSymbolParams({symbol:e})}))})),(0,a.ensureDefined)(t.onInReplayStateChanged).bind(t)().subscribe(this.screen,this.screen.show),i.style.unsubscribe(this,this._onChartStyleChanged),i.style.subscribe(this,this._onChartStyleChanged),t.dataEvents().completed().subscribe(this,(()=>this._addPerfMark("SeriesCompleted")),!0),t.dataEvents().barReceived().subscribe(this,(()=>this._addPerfMark("SeriesFirstDataReceived")),!0);const s=this._options;t.dataEvents().chartTypeNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"D"}),s.muteSessionErrors||((0,Le.trackGoProFeature)("kagiRenko"),(0,Pd.reloginOrGoPro)({feature:"kagiRenko"}))})),t.dataEvents().intradaySpreadNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"D"}),s.muteSessionErrors||(0,Pd.reloginOrGoPro)({feature:"intradaySpread"})})),t.dataEvents().customIntervalNotPermitted().subscribe(null,(i=>{const o=e.model().defaultResolutions(),r=o.find((e=>(0,T.compareResolutions)(e,i)>=0))??o[o.length-1];t.setSymbolParams({interval:r}),s.muteSessionErrors||(0,Pd.reloginOrGoPro)({feature:"customIntervals"})})),t.dataEvents().secondsIntervalNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"1"}),s.muteSessionErrors||(0,Pd.reloginOrGoPro)({feature:"secondsIntervals"})})),t.dataEvents().ticksIntervalNotPermitted().subscribe(null,(()=>{t.setSymbolParams({interval:"1"}),s.muteSessionErrors||(0,Pd.reloginOrGoPro)({feature:"tickIntervals"})})),t.dataEvents().intradayExchangeNotPermitted().subscribe(null,(()=>{if(t.setSymbolParams({interval:"D"}),!s.muteSessionErrors){let e=(0,a.ensureNotNull)(t.symbolInfo()).listed_exchange;(0,d_.getExchanges)().forEach((t=>{t.value===e&&(e=t.name)})),(0,Pd.reloginOrGoPro)({feature:"intradayExchange"})}})),t.requestingStyleIsNotSupported.subscribe(null,(()=>{const i=t.interval(),s=e.model().defaultResolutions(),o=(0,Q.getLastUsedSingleValueBasedStyle)(),r=(0,T.getResolutionByChartStyle)(o,i,s);t.setChartStyleWithIntervalIfNeeded(o,r)})),t.requestingStyleSupportRecovered.subscribe(null,(i=>{const s=t.interval(),o=e.model().defaultResolutions(),r=(0,T.getResolutionByChartStyle)(i,s,o);t.setChartStyleWithIntervalIfNeeded(i,r)}))})()}_applySavedModelState(e,t){this._adjustSize();const s=this.model(),o=s.restoreState(this._content,e,t),r=s.mainSeries().properties().childs();this._symbolWV.setValue(r.symbol.value()),this._resolutionWV.setValue(r.interval.value()),
o&&o.lines_limit_exceeded&&!this.readOnly()&&Promise.all([i.e(83450),i.e(11087),i.e(52682),i.e(66920),i.e(68120),i.e(15215),i.e(72113),i.e(30567),i.e(77831),i.e(58291),i.e(38994),i.e(57343),i.e(17515)]).then(i.bind(i,563031)).then((({showLinetoolsLimitExceededDialog:e})=>{e(this)}))}_addHotkeys(){if(this._hotkeys.add({desc:"Maximize",hotkey:ht.Modifiers.Alt+13,handler:()=>this.toggleFullscreen(),isDisabled:()=>!this.getResizerDetacher().fullscreenable.value()}),this._hotkeys.add(this._clearSelectionHotkey()),this._options.indicatorsDialogShortcutEnabled&&this._hotkeys.add({desc:"Show insert indicator dialog",hotkey:111,handler:()=>this.showIndicators()}),!this.readOnly()){this._hotkeys.add({desc:"Remove selected source",hotkey:ht.isMacKeyboard?46:8,handler:()=>this.removeSelectedSources()}),this._hotkeys.add({desc:"Switch between sessions",hotkey:ht.Modifiers.Shift+ht.Modifiers.Alt+69,handler:()=>this._switchSubSession()});{const e=async(e,t)=>{const i=this._activePaneWidget.value();i&&("drawRightThere"===t.action?await i.drawRightThere(e,"Hotkey"):(D.tool.setValue(e),(0,ps.trackDrawingToolSelected)(e,"Keyboard shortcut")))},t=(t,i)=>()=>e(t,i);Object.entries(M_.lineToolsSelectHotkeys).map((([e,i])=>({desc:i.description,hotkey:i.hash,handler:t(e,i)}))).forEach((e=>this._hotkeys.add(e)))}}this._hotkeys.add({desc:"Show a data window widget",hotkey:ht.Modifiers.Alt+68,handler:w_}),this.withModel(null,(()=>{const e=()=>this._hotkeys.promote();this.model().onSelectedSourceChanged().subscribe(null,e),this.model().crosshairSource().measurePane().subscribe((t=>{null!==t&&e()}))}))}_switchSubSession(){if(!this.hasModel())return;const e=this.model().mainSeries();if(!$.Interval.parse(e.interval()).isIntraday())return;const t=e.symbolInfo();if(null===t)return;const i=t.subsessions?.filter((e=>!e.private))??[];if(0===i.length)return;const s=(i.findIndex((t=>t.id===e.properties().childs().sessionId.value()))+1)%i.length;this.model().setProperty(e.properties().childs().sessionId,i[s].id,Wp)}_startSpinner(e){this._spinner||e&&(this._spinner=(new It.Spinner).spin(e))}_handleLoginStateChanged(){(0,d.isFeaturesetEnabled)("popup_hints")&&window.user&&window.user.is_pro?this._noExchangeSubscrptionWarning=new v_(this):null!==this._noExchangeSubscrptionWarning&&(this._noExchangeSubscrptionWarning.destroy(),this._noExchangeSubscrptionWarning=null)}_checkObsoleteTimezone(){const e=this.properties().childs().timezone.value();(0,Lt.timezoneIsAvailable)(e)||this.properties().childs().timezone.setValue({UTC:"Etc/UTC",EST:"America/New_York",CST:"America/Chicago",PST:"America/Los_Angeles"}[e]||"exchange")}_initColors(){const e=this.properties().childs(),t=e.scalesProperties.childs();t.lineColor.subscribe(this,this._updateAndPaint),t.textColor.subscribe(this,this._updateAndPaint),e.paneProperties.childs().separatorColor.subscribe(this,this._setPaneSeparatorLineColor)}_setPaneSeparatorLineColor(){this._paneSeparators.forEach((e=>e.update())),this._updateAndPaint()}_updateAndPaint(){this.update(),this.paint()}_makeDefaultGui(){
this._makeLoadingScreen(),this.onWidget()&&this._makeAvailableOnTVPopup(),this.onWidget()&&(0,ke.isFeatureEnabled)("enable_symbol_change_restriction_on_widgets")&&this._initialiseWidgetSymbolChangeRestrictions(),this.hasModel()&&(this._makeTimeAxisWidget(),this._makePaneWidgetsAndSeparators(),this._updateScalesActions()),this._adjustSize(),(0,Et.disableSelection)(this._elMainTable),this._updateAndPaint()}_makeLoadingScreen(){if((0,d.isFeaturesetEnabled)("lean_chart_load")){if(this.screen)return;this.screen=new Qt(this,(0,a.ensureNotNull)(this._parent))}else this.screen?.destroy(),this.screen=new Qt(this,(0,a.ensureNotNull)(this._mainDiv))}_makeAvailableOnTVPopup(){this._availableScreen||(this._availableScreen=new L_(this))}_initialiseWidgetSymbolChangeRestrictions(){this._widgetSymbolChangeRestrictions||(this._widgetSymbolChangeRestrictions=new y_(this))}_activateSymbolSearchHotkeys(){this.readOnly()||this._options.hideSymbolSearch||(0,vt.activateKeyPressHandler)()}_makeTimeAxisWidget(){if(this._timeAxisWidget)return void this._timeAxisWidget.updatePriceAxisStubs();const e=this.model();this._timeAxisWidget=new ro(this,this._options.timeScaleWidget,this._titlesProvider.bind(this),this._menuItemsProvider.bind(this),this._backgroundBasedTheme.spawnOwnership()),this._elMainTable.appendChild(this._timeAxisWidget.getElement()),this._timeAxisWidget.updatePriceAxisStubs(),this._timeAxisWidget.onLabelHovered().subscribe(this,((t,i)=>{const s=this.maximizedPaneWidget(),o=s?s.state():e.paneForSource(e.mainSeries()),r=(0,a.ensureNotNull)(this.paneByState((0,a.ensureNotNull)(o))).highlightedPriceAxises(),n=r.value().slice(),l=n.findIndex((e=>e.owner===t.owner&&e.axis?.label===t.axis?.label));i||-1===l?i&&-1===l&&n.push({owner:t.owner,axis:t.axis}):n.splice(l,1),r.setValue(n),this.model().model().lightUpdate()}))}_updateAriaPriceDescription(e){0}_titlesProvider(e,t){const i=this.model(),s=this.maximizedPaneWidget(),o=(0,a.ensureNotNull)(s?s.state():i.paneForSource(i.mainSeries())),r="right"===e?o.rightPriceScales():o.leftPriceScales();if(r.length<t+1)return[];let n=r[t].orderedSources().filter((e=>e===i.mainSeries()||(0,Nt.isStudy)(e)));return n.reverse(),n=(0,J.moveToHead)(n,i.mainSeries()),n.map((e=>e.title($o.TitleDisplayTarget.StatusLine,!0,void 0,!1)))}async _menuItemsProvider(e,t){const i=this.model(),s=this.maximizedPaneWidget(),o=(0,a.ensureNotNull)(s?s.state():i.paneForSource(i.mainSeries())),r="right"===e?o.visibleRightPriceScales():o.visibleLeftPriceScales();if(r.length<t+1)return[];const n=r[t],l=i.model().panes().indexOf(o),c=this._paneWidgets.value()[l],h="right"===e?c.rightPriceAxisesContainer():c.leftPriceAxisesContainer(),d=(0,a.ensureNotNull)(h).findAxisWidgetForScale(n);return await(d?.getContextMenuActions())??[]}_invalidationRAFCallback(e){if(this._drawPlanned=!1,this._drawRafId=0,!this._inLoadingState){if(this._invalidationMask){const t=this._invalidationMask;this._invalidationMask=null,this._update(t,e);for(const i of t.invalidationForTimeScale().animations)if(0===i.type&&!i.value.finished(e)){
this.model().model().setTimeScaleAnimation(i.value,i.rightOffsetPx);break}}null!==this._chartPaintedPromise&&(this._chartPaintedPromise.resolve(),this._chartPaintedPromise=null)}}_applyTimeScaleInvalidations(e,t){for(const i of e.invalidationForTimeScale().animations)this._applyTimeScaleInvalidation(i,t)}_applyTimeScaleInvalidation(e,t){if(!this.hasModel())return;const i=this.model().model(),s=i.timeScale();if(0===e.type){const o=e.value.getStartPosition()-e.value.getPosition(t),r=e.rightOffsetPx+o,n=s.width()-r,a=s.indexToCoordinate(s.baseIndex());i.startScrollTime(a),i.scrollTimeTo(n),i.endScrollTime(),s.requestHistoryPointsIfNeeded(),e.value.finished(t)&&e.value.onFinish?.(!0)}}_onChartSessionCriticalError(e,t){this._disconnected.fire(!0)}_onData(e){if("reconnect_bailout"===e.method)this._reconnectBailout.fire();else this.model().model().onData(e)}_onConnection(){this._requestMetadataAndProcessModel(),this.hasModel()&&(this.model().model().restart(),this.model().model().fullUpdate(),this._connected.fire())}_onDisconnect(){this.hasModel()&&this.model().model().disconnect(),this.hasModel()&&this.model().model().fullUpdate(),this._disconnected.fire()}async _requestMetadataAndProcessModel(){this._inited||(await(0,Ut.initAllLineToolsFromContent)(this._content),this._init(),this._chartWidgetInitialized.fire(),Bp.logDebug("initialized"))}async _requestMetadata(){this._addPerfMark("RequestMetadataStart"),Bp.logInfo("RequestMetadataStart"),await(0,Qe.studyMetaInfoRepository)().requestMetaInfo(),this._addPerfMark("RequestMetadataEnd"),Bp.logInfo("RequestMetadataEnd, already initialized: "+Boolean(this._inited))}async _createControlBar(){const e=await Promise.all([i.e(50648),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(5709),i.e(46680),i.e(74528),i.e(27848),i.e(6406),i.e(22066),i.e(18257),i.e(98729),i.e(56752),i.e(20432),i.e(44589),i.e(93807),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(51129),i.e(21113),i.e(40826),i.e(1748),i.e(8649),i.e(32387),i.e(36295),i.e(13349),i.e(98706),i.e(72132),i.e(65588)]).then(i.bind(i,96520));this._controlBarNavigation=new e.ControlBarNavigation(this,(0,a.ensureNotNull)(this._mainDiv),this._options.controlBar),this.hasModel()&&this._adjustSize()}_subscribeToDrawingState(){if(this.readOnly())return;(0,D.init)();const e=(e,t)=>{if(!this.hasModel())return;const i=this.model(),s=i.model();e.model!==s&&(this._lineToolsSynchronizer?this._lineToolsSynchronizer.executeSynchronizationInLayoutAction((()=>t(s,i))):t(s,i))};D.createdLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=(0,a.ensureNotNull)(e.paneForSource(e.mainSeries()));let o,r=null;if(void 0===t.pointPositionPercents){if(r=Up(e,t.model,t.point.timeStamp),null===r)return;o=t.point.price}else{const i=t.pointPositionPercents.x*e.timeScale().width(),s=e.mainSeries().priceScale(),n=t.pointPositionPercents.y*s.height(),a=e.mainSeries().firstValue();if(null===a)return;r=e.timeScale().coordinateToIndex(i),o=s.coordinateToPrice(n,a)}const n={index:(0,a.ensureNotNull)(r),price:o},l=i.createLineTool({pane:s,
point:n,linetool:t.linetool,properties:t.properties,linkKey:t.linkKey,ownerSource:e.mainSeries(),synchronizationMode:co.CreateLineToolSyncMode.ForceOff,id:t.id,sharingMode:t.sharingMode});null!==l&&!Boolean(this.model().lineBeingCreated())&&t.finalState&&l.restoreExternalPoints(t.finalState,{indexesChanged:!0,pricesChanged:!0})}))})),D.continuedLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=Up(e,t.model,t.point.timeStamp);if(null===s)return;const o={index:s,price:t.point.price},r=e.lineBeingCreated();if(null===r)return;i.continueExternalLine(o,t.envState??void 0,!!t.finalState)&&t.finalState&&r.restoreExternalPoints(t.finalState,{indexesChanged:!0,pricesChanged:!0})}))})),D.cancelledLineTool.subscribe(this,(t=>{e(t,(async(e,t)=>{e.cancelCreatingLine()}))})),D.beenSetLineToolLastPoint.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.lineBeingCreated();if(null===s||s.linkKey().value()!==t.linkKey)return;const o=Up(e,t.model,t.point.timeStamp);if(null===o)return;const r={index:o,price:t.point.price};s.setLastPoint(r),s.updateAllViews((0,Ds.sourceChangeEvent)(s.id())),e.lightUpdate()}))})),D.startedMovingLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=t.linkKeys.map((t=>e.lineToolByLinkKey(t))).filter(n.notNull);if(s.length){const i=Up(e,t.model,t.point.timeStamp);if(null===i)return;const o={index:i,price:t.point.price},r=t.activeItem??null,n=s[0].pointToScreenPoint(o);n&&e.startMovingSources(s,{logical:o,screen:n},r,t.pointPositionPercents,null===t.envState?void 0:t.envState,!0)}}))})),D.movedLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.sourcesBeingMoved().filter(Ut.isLineTool).filter((e=>(e=>t.linkKeys.some((t=>e.linkKey().value()===t)))(e)));if(!s.length)return;const o=Up(e,t.model,t.point.timeStamp);if(null===o)return;const r={index:o,price:t.point.price},n=s[0].pointToScreenPoint(r);n&&e.moveSources({logical:r,screen:n},t.pointPositionPercents,t.envState??void 0,!0)}))})),D.finishedMovingLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.sourcesBeingMoved().filter(Ut.isLineTool);if(0===s.length)return;s.forEach((i=>{const s=(e=>{for(let i=0;i<t.linkKeys.length;i++)if(t.linkKeys[i]===e.linkKey().value())return{state:t.finalStates[i],changes:t.changes[i]};return null})(i);e.endMovingSources(null!==s,!0),null!==s&&(i.restoreExternalPoints(s.state,s.changes),s.state.pointPositionPercents&&i.restorePositionPercents(s.state.pointPositionPercents))}))}))})),D.startedChangingLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.lineToolByLinkKey(t.linkKey);if(null!==s){let i=null;if(t.positionPercents){const o=e.timeScale().positionPercentToCoordinate(t.positionPercents.x),r=(0,a.ensureNotNull)(s.priceScale()).positionPercentToCoordinate(t.positionPercents.y);if(i=s.screenPointToPoint((0,dt.point)(o,r),!0),!i)return}else{const o=s.getPoint(t.pointIndex),r=o?o.index:Up(e,t.model,t.point.timeStamp);if(null===r)return;i={index:r,price:t.point.price}}s.isActualSymbol()&&s.isActualCurrency()&&s.isActualUnit()&&e.startChangingLinetool(s,(0,
a.ensureNotNull)(s.ownerSource()),i,t.pointIndex,t.envState??void 0,!0)}}))})),D.changedLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.lineBeingEdited();if(null===s||s.linkKey().value()!==t.linkKey)return;let o=null;if(t.positionPercents){const i=e.timeScale().positionPercentToCoordinate(t.positionPercents.x),r=(0,a.ensureNotNull)(s.priceScale()).positionPercentToCoordinate(t.positionPercents.y);if(o=s.screenPointToPoint((0,dt.point)(i,r),!0),!o)return}else{let i=null;if(i=t.changes.indexesChanged?Up(e,t.model,t.point.timeStamp):(0,a.ensureNotNull)(e.linePointBeingChanged()).index,null===i)return;o={index:i,price:t.point.price}}s.isActualSymbol()&&s.isActualCurrency()&&s.isActualUnit()&&e.changeLinePoint(o,void 0,!0)}))})),D.finishedChangingLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.lineToolByLinkKey(t.linkKey);null!==s&&s.isActualSymbol()&&s.isActualCurrency()&&s.isActualUnit()&&null!==e.lineBeingEdited()&&e.endChangingLinetool(!!t.finalState,!0),null!==s&&t.finalState&&(t.finalState.pointPositionPercents?s.restorePositionPercents(t.finalState.pointPositionPercents):s.restoreExternalPoints(t.finalState,t.changes))}))})),D.removedLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const{withUndo:s,unlink:o,linkKey:r}=t,n=e.lineToolByLinkKey(r);null!==n&&(o&&n.detachAlert(),s?i.removeSource(n,!1):(e.lineToolsGroupModel().removeLineTools([n]),e.removeSource(n)))}))})),D.finishedLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.lineToolByLinkKey(t.linkKey);null!==s&&(0,se.isLineToolFinishRequiredWhenCreatedByApi)(s.toolname)&&s.finish()}))})),D.changedLineStyle.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.lineToolByLinkKey(t.linkKey);if(null!==s){const{zOrder:e,...i}=t.state;void 0!==e&&s.setZorder(e),(0,lt.default)(i)||(s.restoreExternalState(i),s.propertiesChanged(!0)),t.alertId&&s.syncAlert(t.alertId)}}))})),D.restoredLineToolState.subscribe(this,(t=>{e(t,(async(e,i)=>{const s=e.lineToolByLinkKey(t.linkKey);if(null!==s){const i={...t.state};i.indexes=t.state.points.map((i=>({index:Up(e,t.model,i.time_t),price:i.price}))),e.restoreLineToolState(s,i,!1)}}))})),D.restoredLineTool.subscribe(this,(t=>{e(t,(async(e,i)=>{e.restoreSource(t.state.restorePane,t.state.paneIndex,t.state.paneState,t.state.sourceState,null)}))})),D.copiedLineTool.subscribe(this,(async t=>{e(t,(async(e,i)=>{const s=(0,a.ensureNotNull)(e.paneForSource(e.mainSeries()));let o;const r={...t.state,intervalsVisibilities:(0,Xa.mergeIntervalVisibilitiesDefaults)(t.state.intervalsVisibilities)},n=(0,Ut.createLineToolProperties)(e.backgroundTheme().spawnOwnership(),t.linetool,!e.readOnly(),r),l=e.dataSourceForId(t.id);if(l){if(!(0,Ut.isLineTool)(l))return void Bp.logError(`Error sync creating line tool. Object with id ${t.id} is already in use and it is not a line tool`);if(l.toolname!==t.linetool)return void Bp.logError(`Error sync creating line tool. Object with id ${t.id} is already in use and its type differs: ${l.toolname} and ${t.linetool}`)}if(l&&(l.linkKey().setValue(t.linkKey),l.share(t.sharingMode)),
t.pointPositionPercents){const e={index:0,price:0};if(o=l??i.createLineTool({pane:s,point:e,linetool:t.linetool,properties:n,linkKey:t.linkKey,synchronizationMode:co.CreateLineToolSyncMode.ForceOff,id:t.id}),null===o)return;o.restorePositionPercents((0,a.ensureDefined)(t.pointPositionPercents))}else{const r=i=>({index:(0,a.ensureNotNull)(Up(e,t.model,i.timeStamp)),price:i.price}),c=t.points.map(r),h=t.pointsForCreating.map(r),d=c[0];if(l)o=l;else if(t.withUndo)o=i.createLineTool({pane:s,point:d,linetool:t.linetool,properties:n,linkKey:t.linkKey,sharingMode:t.sharingMode,synchronizationMode:co.CreateLineToolSyncMode.ForceOff,id:t.id});else{const e=new qo({model:i.model(),pane:s,lineTool:t.linetool,ownerSource:(0,a.ensureNotNull)(s.mainDataSource()),drawOnAllChartsMode:t.sharingMode,id:t.id});e.redo(),e.startCreatingLine(d,n,t.linkKey||null,t.sharingMode,!0),o=(0,a.ensureNotNull)(e.line())}if(null===o)return;const u=(e,s)=>{t.withUndo?i.continueCreatingLine(e,new ui.EnvironmentState(void 0,!0),s,!0):i.model().continueCreatingLine(e,new ui.EnvironmentState(void 0,!0),s,!0)},_=(0,se.isLineToolFinishRequiredWhenCreatedByApi)(t.linetool);if(e.lineBeingCreated())if(h.length>1)for(let e=1;e<h.length;e++)u(h[e],e<h.length-1&&!_),e===h.length-1&&_&&(o.finish(),u(h[e],!0));else _&&(o.finish(),u(h[0],!0))}if(o.properties().interval.setValue(t.state.interval),o.restoreExternalState(t.state),o.restoreData){const{points:e,...i}=t;o.restoreData(i)}o.setZorder(t.zOrder),o.propertiesChanged(!0),t.finalState&&(o.calcIsActualSymbol(),o.restoreExternalPoints(t.finalState,{pricesChanged:!0,indexesChanged:!0})),t.alertId&&o.syncAlert(t.alertId)}))}))}_setFirstRequestNumbarsUsingTimeframeAndInterval(e){const t=function(e){const t=e.numberExtraBars??0,i=e.barSpacing||6,s=Math.ceil(e.width/i)+t;if(e.timeFrame){if(!e.interval)return{barCount:s};const i=$.Interval.parse(e.interval);if("string"==typeof e.timeFrame){if("ALL"===e.timeFrame)return{barCount:s};let o=e.timeFrame;"YTD"===e.timeFrame&&(o=`${Math.floor(((new Date).valueOf()-new Date((new Date).getFullYear(),0,0).valueOf())/1e3/60/60/24)}D`);const r=$.Interval.parse(o),n=Date.now().valueOf(),a=n-r.inMilliseconds();return{barCount:(0,ec.getPeriodsBetweenDates)(e.symbolInfo?.session??"24x7",e.symbolInfo?.session_holidays??"",e.symbolInfo?.corrections??"",i.letter(),i.multiplier(),a,n)+t,message:`based on period of ${o}`,shouldAdjustBarSpacing:!0}}if("time-range"===e.timeFrame.type)return{barCount:(0,ec.getPeriodsBetweenDates)(e.symbolInfo?.session??"24x7",e.symbolInfo?.session_holidays??"",e.symbolInfo?.corrections??"",i.letter(),i.multiplier(),1e3*e.timeFrame.from,1e3*e.timeFrame.to)+t,message:`based on time range: ${e.timeFrame.from} ... ${e.timeFrame.to}`,shouldAdjustBarSpacing:!0}}return{barCount:s}}({width:e.timeScale().width(),barSpacing:e.timeScale().barSpacing(),timeFrame:this.options().defTimeframe,interval:this.options().defInterval});if((0,
d.isFeaturesetEnabled)("charting_library_debug_mode")&&console.log(`${(new Date).toISOString()} Setting initial data request count to ${t.barCount} bars${t.message?` (${t.message})`:""}`),e.mainSeries().seriesSource().setInitialRequestOptions({count:t.barCount}),t.shouldAdjustBarSpacing&&"number"==typeof t.barCount&&t.barCount>0){const i=Math.ceil(e.timeScale().width()/t.barCount);e.timeScale().setBarSpacing(i)}}_createEventHint(){if(null===this._eventHintDeferredPromise){const e=(0,gt.createDeferredPromise)();this._eventHintDeferredPromise=e,Promise.all([i.e(50865),i.e(72454),i.e(32387),i.e(77588)]).then(i.bind(i,614572)).then((t=>{e.resolve(new t.ChartEventHintRenderer(this._chartWidgetCollection.getContainer()))}))}return this._eventHintDeferredPromise.promise}async _createWarningHint(){if(null===this._warningHintDeferredPromise){const e=(0,gt.createDeferredPromise)();this._warningHintDeferredPromise=e,Promise.all([i.e(20576),i.e(48072),i.e(63470),i.e(33042),i.e(32387),i.e(36804)]).then(i.bind(i,781750)).then((t=>{e.resolve(new t.ChartWarningHintRenderer(this))}))}return this._warningHintDeferredPromise.promise}_showEventHint(e){(0,d.isFeaturesetEnabled)("popup_hints")&&(null!==this._activeHint&&0===this._activeHint.type?this._activeHint.show(e):(this._hideHint(),this._createEventHint().then((t=>{this._activeHint=t,void 0!==e&&this._activeHint.show(e)}))))}_showWarningHint(e){(0,d.isFeaturesetEnabled)("popup_hints")&&(null!==this._activeHint&&1===this._activeHint.type?this._activeHint.show(e):(this._hideHint(),this._createWarningHint().then((t=>{if(null!==t){if(this._activeHint=t,void 0===e)return;this._activeHint.show(e)}}))))}_hideHint(){null!==this._activeHint&&this._activeHint.hide()}_checkIsTradedGroupSelected(){const e=this.model(),t=e.model();return e.selection().customSources().some((e=>t.customSourceName(e)?.startsWith(T_)||t.customSourceName(e)?.startsWith(P_)))}_setActions(){return this._unsetActions(),this._addHotkeys(),this._actions=kp(this),this.withModel(null,(()=>{const e=this.model().mainSeries(),t=e.properties();t.childs().priceAxisProperties.subscribe(this,this._updateScalesActions),e.priceScaleAboutToBeChanged().subscribe(this,(()=>{t.childs().priceAxisProperties.unsubscribeAll(this)})),e.priceScaleChanged().subscribe(this,(()=>{t.childs().priceAxisProperties.subscribe(this,this._updateScalesActions),this._updateScalesActions()}))})),this._updateScalesActions(),this._actions}_unsetActions(){this._actions&&(Object.values(this._actions).forEach((e=>{e.destroy()})),this._actions=null)}_updateTimingsMeterState(){const e=this._options.visible.value();null!==this._timingsMeter&&(e?this._timingsMeter.startCollect():this._timingsMeter.stopCollect())}_onBackgroundColorChanged(){this._paneWidgets.value().forEach((e=>{e.setCursorForTool()})),this.update(),this.model().model().fullUpdate()}_contentSeriesProperties(){if(this._content)for(let e=this._content.panes.length;e-- >0;){const t=this._content.panes[e].sources;for(let e=t.length;e-- >0;){const i=t[e];if((0,q.isMainSeriesState)(i))return i.state??null
}}return null}async _getChartPropertyDefinitionsViewModel(){if(null===this._definitionsViewModel){const e=await Promise.all([i.e(98304),i.e(85262),i.e(17944),i.e(74217),i.e(75439)]).then(i.bind(i,513932));if(this._isDestroyed)throw new Error("Chart widget already destroyed");await new Promise((e=>this.withModel(null,e))),null===this._definitionsViewModel&&(this._definitionsViewModel=new e.ChartPropertyDefinitionsViewModel(this.model(),this.properties(),this._options))}return this._definitionsViewModel}}var Zp=i(609851),Yp=i(137975);const Xp=(0,l.getLogger)("Clipboard");class Jp{constructor(e){this._e=e}write(e){return(0,Yp.writeImpl)(this._toRaw(e),this._e)}_toRaw(e){const t={files:[]};t.text=e.text,void 0!==e.app?t.html=this._serializeAppData(e.app,e.text):e.html&&(t.html=e.html);for(const i of e.files||[])t.files.push(i);return t}_serializeAppData(e,t){return`<meta charset="utf-8"><span data-tradingview-clip="${(0,Zp.htmlEscape)(e)}">${t?(0,Zp.htmlEscape)(t.slice(0,256)):"&#128200;"}</span>`}}class Qp{constructor(e){this._e=e}async read(){this._e&&0===this._e.eventPhase&&(Xp.logWarn("Cannot use an already dispatched ClipboardEvent for reading"),this._e=null);const e=this._e?this._readUsingEvent(this._e):await this._readUsingApi();return this._fromRaw(e)}_readUsingEvent(e){const t=(0,a.ensure)(e.clipboardData);e.preventDefault();const i={files:[]};for(let e=0;e<t.files.length;e++)i.files.push(t.files[e]);for(let e=0;e<t.items.length;e++){const s=t.items[e];"string"===s.kind&&("text/plain"===s.type?i.text=t.getData(s.type):"text/html"===s.type?i.html=t.getData(s.type):i.files.push(new Blob([t.getData(s.type)],{type:s.type})))}return i}async _readUsingApi(){const e=(0,Yp.getClipboard)();if(!e||!e.read)throw new DOMException("ClipboardApi is not supported","NotSupportedError");let t,i;const s=[],o=await e.read();for(const e of o)for(const o of e.types)"text/html"===o?t=e.getType(o).then(this._readBlobAsText):"text/plain"===o?i=e.getType(o).then(this._readBlobAsText):s.push(e.getType(o));return{text:await i,html:await t,files:await Promise.all(s)}}_fromRaw(e){const t={};if(void 0!==e.text&&(t.text=e.text),void 0!==e.html){const i=this._parseAppData(e.html);i?t.app=i:t.html=e.html}return e.files.length>0&&(t.files=e.files),t}_parseAppData(e){if(-1===e.slice(0,1024).indexOf("data-tradingview-clip"))return;const t=(new DOMParser).parseFromString(e,"text/html").querySelector("[data-tradingview-clip]");return t?t.getAttribute("data-tradingview-clip")||"":void 0}_readBlobAsText(e){return new Promise(((t,i)=>{const s=new FileReader;s.onloadend=()=>{t(s.result)},s.onerror=()=>{i(s.error)},s.readAsText(e)}))}}class em{constructor(e){this._callbacks=Object.assign({},e),this._boundOnCopy=this._onCopyEv.bind(this),this._boundOnCut=this._onCutEv.bind(this),this._boundOnPaste=this._onPasteEv.bind(this)}listen(){document.addEventListener("copy",this._boundOnCopy),document.addEventListener("cut",this._boundOnCut),document.addEventListener("paste",this._boundOnPaste)}async peek(){if("granted"!==(await navigator.permissions.query({
name:"clipboard-read"})).state)throw new Error("clipboard-read is not granted");return new Qp(null).read()}uiRequestCopy(e){this._callbacks.copyRequested&&this._callbacks.copyRequested(new Jp(null),e)}uiRequestCut(e){this._callbacks.cutRequested&&this._callbacks.cutRequested(new Jp(null),e)}uiRequestPaste(e){this._callbacks.pasteRequested&&this._callbacks.pasteRequested(new Qp(null),e)}destroy(){document.removeEventListener("copy",this._boundOnCopy),document.removeEventListener("cut",this._boundOnCut),document.removeEventListener("paste",this._boundOnPaste)}_onCopyEv(e){e.defaultPrevented||this._callbacks.copyRequested&&this._callbacks.copyRequested(new Jp(e))}_onCutEv(e){e.defaultPrevented||this._callbacks.cutRequested&&this._callbacks.cutRequested(new Jp(e))}_onPasteEv(e){e.defaultPrevented||this._callbacks.pasteRequested&&this._callbacks.pasteRequested(new Qp(e))}}var tm=i(913884);function im(e){const t=e.target;return null!==t&&1===t.nodeType&&(0,tm.isTextEditingField)(t)}function sm(e){const t=e.target;if(null===t)return!1;const i=(t.ownerDocument||t).getSelection();return null!==i&&!i.isCollapsed}class om extends em{_onCopyEv(e){if(!im(e)&&!sm(e))return super._onCopyEv(e)}_onCutEv(e){if(!im(e)&&!sm(e))return super._onCutEv(e)}_onPasteEv(e){if(!im(e))return super._onPasteEv(e)}}var rm=i(176359),nm=i(396476),am=i(620257);function lm(e){return`chart-widget-collection-border-${e}`}const cm=new P.TranslatedString("resize layout",ap.t(null,void 0,i(831045))),hm=new P.TranslatedString("reset layout sizes",ap.t(null,void 0,i(133497)));function dm(e,t){return e.selected===t.selected&&e.withShift===t.withShift}class um{constructor(e){this._selected=new z.WatchedObject({selected:!1,withShift:!1},dm),this._onShiftPressed=e=>{const t=this._state.currentLayoutResizeAction.value();t&&this._applyMouseMove(t.delta,e)},this._state=e.state,this._splitterElement=e.splitterElement,this._splitter=e.splitter,this._computeContentBox=e.computeContentBox,(0,Dt.shiftPressed)().subscribe(this._onShiftPressed),this._selected.subscribe((e=>{if(e.selected){const t=lm(this._splitter.className);Array.from(this._state.parent.getElementsByClassName(t)).forEach((e=>e.classList.remove(am.hovered)));(e.withShift?Array.from(this._state.parent.getElementsByClassName(t)):[this._splitterElement]).forEach((e=>e.classList.add(am.hovered)))}else{const e=lm(this._splitter.className);Array.from(this._state.parent.getElementsByClassName(e)).forEach((e=>e.classList.remove(am.hovered)))}}))}destroy(){(0,Dt.shiftPressed)().unsubscribe(this._onShiftPressed)}mouseDownEvent(e){this._mouseDownOrTouchStartEvent(e)}touchStartEvent(e){this._selected.value().selected&&this._mouseDownOrTouchStartEvent(e)}pressedMouseMoveEvent(e){this._pressedMouseOrTouchMoveEvent(e)}touchMoveEvent(e){this._selected.value().selected&&this._pressedMouseOrTouchMoveEvent(e)}mouseUpEvent(e){this._mouseUpOrTouchEndEvent(e)}touchEndEvent(e){this._mouseUpOrTouchEndEvent(e)}mouseEnterEvent(e){this._selected.setValue({selected:!0,withShift:e.shiftKey})}mouseLeaveEvent(){this._selected.setValue({
selected:!1,withShift:!1})}mouseDoubleClickEvent(e){this._resetLayoutSizes()}doubleTapEvent(){this._resetLayoutSizes()}tapEvent(e){this._selected.setValue({selected:!this._selected.value().selected,withShift:e.shiftKey})}touchStartOutsideEvent(e){this._selected.setValue({selected:!1,withShift:!1})}_mouseDownOrTouchStartEvent(e){const t=new dt.Point(e.localX+this._splitterElement.offsetLeft,e.localY+this._splitterElement.offsetTop),i=(0,nm.deepCopy)(this._state.sizingState.value());this._state.currentLayoutResizeAction.setValue({point:t,splitter:this._splitter,initialState:i,alignedState:this._state.layoutTemplate.value().syncSublayoutsBySplitter(this._splitter,(0,nm.deepCopy)(i)),shiftState:e.shiftKey,delta:0}),this._selected.setValue({selected:!0,withShift:e.shiftKey})}_pressedMouseOrTouchMoveEvent(e){const t=this._state.currentLayoutResizeAction.value();if(!t)return;t.shiftState!==e.shiftKey&&(this._selected.setValue({selected:!0,withShift:e.shiftKey}),t.shiftState=e.shiftKey);const i=new dt.Point(e.localX+this._splitterElement.offsetLeft,e.localY+this._splitterElement.offsetTop);t.delta="v"===t.splitter.orientation?i.y-t.point.y:i.x-t.point.x,this._applyMouseMove(t.delta,e.shiftKey)}_mouseUpOrTouchEndEvent(e){const t=this._state.currentLayoutResizeAction.value();if(t&&(this._splitterElement.classList.remove(am["i-active"]),this._state.currentLayoutResizeAction.setValue(null),t.currentState)){this._state.undoHistory.beginUndoMacro(cm),this._state.undoHistory.pushUndoCommand(new y(this._state.sizingState,t.initialState,t.currentState,cm));const e=this._state.layoutTemplate.value().layoutType;this._state.undoHistory.pushUndoCommand(new b((t=>t?this._state.allLayoutSizesState.set(e,t):this._state.allLayoutSizesState.delete(e)),this._state.allLayoutSizesState.get(this._state.layoutTemplate.value().layoutType),this._state.sizingState.value(),hm)),this._state.undoHistory.endUndoMacro(),this._state.layoutSizesChanged.setValue(!0)}}_applyMouseMove(e,t){const i=(0,a.ensureNotNull)(this._state.currentLayoutResizeAction.value()),s=t?i.alignedState:i.initialState,o=this._state.options.padding??2,r=this._computeContentBox();i.currentState=this._state.layoutTemplate.value().resizeApplier(r,o,e,i.splitter,(0,nm.deepCopy)(s),t),this._state.sizingState.setValue(i.currentState)}_resetLayoutSizes(e){const t=(0,rt.layoutInitialSizingState)(this._state.layoutTemplate.value().expression),i=this._state.layoutTemplate.value().layoutType,s=e=>e?this._state.allLayoutSizesState.set(i,e):this._state.allLayoutSizesState.delete(i);if(e)return this._state.sizingState.setValue(t),void s(t);this._state.undoHistory.beginUndoMacro(hm),this._state.undoHistory.pushUndoCommand(new y(this._state.sizingState,this._state.sizingState.value(),t,hm)),this._state.undoHistory.pushUndoCommand(new b(s,this._state.allLayoutSizesState.get(this._state.layoutTemplate.value().layoutType),t,hm)),this._state.undoHistory.endUndoMacro()}}var _m=i(854906),pm=i(259611);class mm extends Error{constructor(){super("Cannot show floating tooltip")}}class gm{constructor(e){
this._visibleChartWidgets=new z.WatchedObject([],pm.compareTwoCollectionsByIds),this._initialWidgetForTooltip=null,this._floatingTooltip=void 0,this._cursorPosition=new z.WatchedObject(null),this._destroyController=new AbortController,this._hintDestoryController=null,this._layoutChangedBound=this._onLayoutChangedCallback.bind(this),this._onMaximizedChartChangedCallback=(0,gn.default)((()=>{this._layoutChangedBound()}),0),this._visibleChartsChangedBound=this._visibleChartWidgetsChanged.bind(this),this._mouseDownBound=this.mouseDownEvent.bind(this),this._mouseMoveBound=this.mouseMoveEvent.bind(this),this._chartWidgetCollection=e,e.layout.subscribe(this._layoutChangedBound),e.maximizedChartWidget().subscribe(this._onMaximizedChartChangedCallback,{callWithLast:!0}),this._visibleChartWidgets.subscribe(this._visibleChartsChangedBound,{callWithLast:!0}),this._hoveredWidget=(0,F.accumulate)((e=>{const t=e.find(n.notNull);return t?this._visibleChartWidgets.value().find((e=>e.paneWidgets().includes(t)))??null:null}),(0,F.combine)((e=>e.map((e=>e.activePaneWidget().weakReference()))),this._visibleChartWidgets.weakReference()).ownership())}destroy(){this._cursorPosition.destroy(),this._visibleChartWidgets.destroy(),this._hoveredWidget.destroy(),this._chartWidgetCollection.layout.unsubscribe(this._layoutChangedBound),this._chartWidgetCollection.maximizedChartWidget().unsubscribe(this._onMaximizedChartChangedCallback),this._destroyController.abort(),this._hintDestoryController?.abort()}async mouseDownEvent(e){const t=this._hoveredWidget.value();if(!t)return;const{target:s,button:o}=e;if(0===o&&window.innerWidth>767&&s instanceof HTMLCanvasElement){const o=t.paneByCanvas(s);if(null===o)return;const a=(0,dt.point)(e.pageX,e.pageY);if(this._canShowHint()&&!t.model().model().isSnapshot()&&null===this._hintDestoryController){const s=(0,oi.getClickPosition)(e);if(s){const e=o.dataSourceAtPoint(s.x,s.y);(null===e||e===t.model().mainSeries()||(0,Nt.isStudy)(e)&&!(0,Nt.isESDStudy)(e))&&(this._hintDestoryController=new AbortController,r=t.widget(),n=this._hintDestoryController,Promise.all([i.e(26960),i.e(50865),i.e(5709),i.e(51493),i.e(14241),i.e(32387),i.e(48255)]).then(i.bind(i,392653)).then((e=>{n.signal.aborted||e.showActivationHint(r,n)})))}}try{await this._awaitBeforeShow()}catch{return}const l=new AbortController,c=()=>l.abort();window.addEventListener("mouseup",c,{once:!0}),this._destroyController.signal.addEventListener("abort",c,{once:!0});try{this._initialWidgetForTooltip=t,await this._show(a,l.signal)}catch(t){if(t instanceof mm)return void c();throw e}}var r,n}mouseMoveEvent(e){return!!(this._floatingTooltip&&1&e.buttons)&&(this._cursorPosition.setValue((0,dt.point)(e.pageX,e.pageY)),!0)}_onLayoutChangedCallback(){const e=this._chartWidgetCollection.maximizedChartWidget().value(),t=(e?[e]:this._chartWidgetCollection.getAll()).filter((e=>e.isVisible()));this._visibleChartWidgets.setValue(t)}_visibleChartWidgetsChanged(){this._visibleChartWidgets.value().forEach((e=>{e.withModel(null,(()=>{const t=e.widget()
;t.removeEventListener("mousedown",this._mouseDownBound),t.removeEventListener("mousemove",this._mouseMoveBound),t.addEventListener("mousedown",this._mouseDownBound),t.addEventListener("mousemove",this._mouseMoveBound)}))}))}async _awaitBeforeShow(){const e=new AbortController,t=()=>e.abort();this._destroyController.signal.addEventListener("abort",t,{once:!0}),window.addEventListener("mouseup",t),window.addEventListener("mousemove",t);try{await(0,ze.delay)(e.signal,400)}finally{this._destroyController.signal.removeEventListener("abort",t),window.removeEventListener("mouseup",t),window.removeEventListener("mousemove",t)}}async _show(e,t){const[{createChartFloatingTooltip:s},{createViewState:o}]=await Promise.all([Promise.all([i.e(85879),i.e(6406),i.e(27688),i.e(58460),i.e(32387),i.e(4350),i.e(80762)]).then(i.bind(i,264211)),Promise.all([i.e(85879),i.e(6406),i.e(27688),i.e(58460),i.e(32387),i.e(4350),i.e(80762)]).then(i.bind(i,303779))]);if(t.aborted)return;const r=this._initialWidgetForTooltip;if(null!==r&&r===this._hoveredWidget.value()&&!this._canShowTooltip())throw new mm;t.addEventListener("abort",(()=>this._destroyFloatingTooltip()),{once:!0});try{this._chartWidgetCollection.setChartFloatingTooltipVisible(!0);const t=r?.model();t?.crosshairSource().updateAllViews((0,Ds.crosshairMoveEvent)()),t?.model().lightUpdate(),this._floatingTooltip=s(o(this._hoveredWidget,this._cursorPosition)),this._cursorPosition.setValue(e),this._hintDestoryController?.abort(),this._hintDestoryController=null,R.setValue("hint.chartFloatingTooltipActivationHint",!1,{forceFlush:!0})}catch{throw new mm}}_destroyFloatingTooltip(){this._cursorPosition.setValue(null),this._initialWidgetForTooltip=null,this._floatingTooltip&&(this._floatingTooltip.destroy(),this._floatingTooltip=void 0),this._chartWidgetCollection.setChartFloatingTooltipVisible(!1)}_canShowHint(){return(0,d.isFeaturesetEnabled)("popup_hints")&&R.getBool("hint.chartFloatingTooltipActivationHint",!0)}_canShowTooltip(){const e=this._hoveredWidget.value();if(!e)return!1;const t=e.model().model(),i=D.tool.value();if(null!==t.lineBeingEdited()||null!==t.lineBeingCreated()||t.sourcesBeingMoved().length>0||null!==t.customSourceBeingMoved()||(0,D.toolIsMeasure)(i)||(0,D.toolIsEraser)(i)||t.crosshairSource().crosshairDemonstration().isThereUnfinishedHighlighter())return!1;const s=t.hoveredSource();return!!(null===s||(0,Nt.isStudy)(s)||(0,_i.isDataSource)(s)&&(0,Pa.isSeries)(s))}}const Sm=(0,l.getLogger)("Chart.ChartWidgetCollection"),vm=h.t(null,void 0,i(386048)),fm=h.t(null,void 0,i(924006)),bm=h.t(null,void 0,i(537953)),ym=h.t(null,void 0,i(404824)),wm=h.t(null,void 0,i(859926)),Cm=h.t(null,{context:"clipboard operation"},i(210901)),Tm=h.t(null,{context:"clipboard operation"},i(247521)),Pm=h.t(null,{context:"clipboard operation"},i(623400)),Mm=h.t(null,{context:"clipboard operation"
},i(394128)),xm=h.t(null,void 0,i(429994)),Im=new P.TranslatedString("change series style",h.t(null,void 0,i(587242))),Lm=new P.TranslatedString("sync time",h.t(null,void 0,i(815993))),Am=new P.TranslatedString("symbol lock",h.t(null,void 0,i(719209))),km=new P.TranslatedString("interval lock",h.t(null,void 0,i(222286))),Em=new P.TranslatedString("date range lock",h.t(null,void 0,i(230957))),Dm=new P.TranslatedString("track time",h.t(null,void 0,i(400412))),Bm=new P.TranslatedString("set layout sizes",h.t(null,void 0,i(779184))),Rm=new P.TranslatedString("reset layout sizes",h.t(null,void 0,i(133497))),Vm=new P.TranslatedString("apply chart theme",h.t(null,void 0,i(647656))),Om=new P.TranslatedString("apply indicators to entire layout",h.t(null,void 0,i(897476))),Nm=async function(e,t,i,s){const o=e.map((e=>e.chartWidget)).filter((e=>e.hasModel())).filter((e=>e.id()===t||0!==s));try{o.forEach((e=>e.startApplyingLineToolUpdateNotification()));for(const e of o)await e.model().model().withoutLineToolsSyncAction((()=>e.applyLineToolUpdateNotification(i,s)))}finally{o.forEach((e=>e.endApplyingLineToolUpdateNotification()))}},Wm=function(e){const t={};return e.chartWidgetsDefs.map((e=>e.chartWidget)).forEach((e=>t[e.id()]=function(e){const t={};if(!e.hasModel()){const i=e.options().content;if(!i)return t;const s=(0,a.ensureNotNull)(i.panes.reduce(((e,t)=>e??t.sources.find((e=>"MainSeries"===e.type))??null),null));return t.resolution=s.state?.interval,t.symbol=s.state?.symbol,t.short_name=s.state?.shortName,t}const i=e.model().mainSeries(),s=i.properties().childs(),o=i.symbolInfo();t.resolution=s.interval.value(),t.symbol_type=null!==o&&o.type||"",t.exchange=null!==o&&o.exchange||"",t.listed_exchange=null!==o&&o.listed_exchange||"";const r=o?.legs??[];if(null!==o&&i.isSpread()){const e=r[0];let i=o.base_name[0];i=i.split(":")[1],t.symbol=e,t.short_name=i,t.expression=o.full_name}else t.symbol=null!==o&&o.ticker||s.symbol.value(),t.short_name=s.shortName.value();const n=o?.base_name??[];return t.legs=r.map(((e,t)=>({symbol:e,pro_symbol:n[t]}))),t}(e))),t},Fm=function(e,t,i){const s=e.chartWidgetsDefs.slice(0,e.layoutTemplate.value().count).map(((t,i,s)=>({def:t,metrics:e.layoutTemplate.value().sizer({top:0,left:0,width:256,height:256},i,s.length,0)}))).sort(((e,t)=>e.metrics.top-t.metrics.top||e.metrics.left-t.metrics.left)).map((e=>e.def));if(s.length<2)return null;let o=s.indexOf(t);return-1===o?null:(o=(o+(i?s.length-1:1))%s.length,s[o])},zm=function(e){let t=1;for(;e(""+t);)t++;return""+t},Hm=function(e){if(e){const e=function(){const e=(0,Ae.getConfig)("BACKEND_CONNECTIONS")?.limit??0,t=(0,a.ensureDefined)(window.pro),i=t.getProductsByType(t.PRODUCT_TYPES.pro_plan);for(const t of i)if(((0,Ae.getConfig)("BACKEND_CONNECTIONS",(0,a.ensureDefined)(t.id))?.limit??0)>e)return{connectionCount:e,moreConnectionsPlanAvailable:!0};return{connectionCount:e,moreConnectionsPlanAvailable:!1}}();(0,Ee.openPaywall)({feature:"connectionsLimit",...e})}},Um=function(e,t,i,s){let o=0;const r=(0,
Je.createWVFromGetterAndSubscriptions)((()=>++o),[i,s]);return(0,F.combine)(((t,i)=>e()[st[t]]??null),t.weakReference(),r.ownership())},Gm=function(e){et.StudyMetaInfo.mergeDefaultsOverrides(e),(0,Qe.studyMetaInfoRepository)().isReady()&&et.StudyMetaInfo.overrideDefaults((0,Qe.studyMetaInfoRepository)().getInternalMetaInfoArray())};const jm=new Map,qm=new Map,$m=function(e,t){var i;i=t,window.ChartApiInstance.setBroker(i)},Km=(0,ke.isFeatureEnabled)("fix_duplicated_chart_ids"),Zm=(0,ke.isFeatureEnabled)("ticks_replay"),Ym=["2-3","5h","6h","7h","8h"],Xm=["10c5","12c6","12c4","14c7","16c8","16c4"];function Jm(e){return e.value()?1:0}function Qm(e){return Promise.all(e.map((e=>{const t=e.model().mainSeries();return t.symbolResolvingActive().value()?U(t.dataEvents().symbolResolved()).promise:t.symbolInfo()})))}const eg={saveChartEnabled:!0,takeScreenshotEnabled:!0,publishedChartsEnabled:!0};function tg(e){return e instanceof Error?e.message:null}function ig(e,t){for(const i of e.sources){if("study"!==i.type)return!0;if(t.checkIfFeatureAvailable(new et.StudyMetaInfo(i.source.metaInfo),[]))return!0}return!1}class sg{constructor(e){this.activeChartStyle=new H.WatchedValue,this.activeChartWidget=new H.WatchedValue,this.onAboutToBeDestroyed=new g.Delegate,this.clientId=(0,ot.randomHash)(),this._destroyed=!1,this._chartWidgetsDefs=[],this._activeIndex=0,this._globalDetachable=new H.WatchedValue,this._layoutTemplate=new H.WatchedValue,this._layoutType="s",this._layoutWV=new H.WatchedValue(this._layoutType),this._currentLayoutResizeAction=new H.WatchedValue(null),this._inlineChartsCount=new H.WatchedValue,this._selectedSources=new H.WatchedValue([]),this._lineToolsSynchronizerHasChanges=new H.WatchedValue(!1),this._viewMode=new H.WatchedValue(re.CollectionViewMode.ForceFullscreen),this._allLayoutSizesState=new Map,this._splitters=new H.WatchedValue([]),this._savedChartWidgetOptions=[],this._flags={isConfirmationAboutReplayLocked:!1,loadingChart:!1,setTimeFrameActive:!1,setChartStyleActive:!1,setNewResolution:!1},this._loadingContent=!1,this._initialLoading=!1,this._isPhoneSize=new H.WatchedValue(!1),this._sizingState=new H.WatchedValue,this._layoutSizesChangedWV=new H.WatchedValue(!1),this._symbolLock=new H.WatchedValue(!1),this._internalSymbolLock=new H.WatchedValue(this._symbolLock.value()),this._intervalLock=new H.WatchedValue(!1),this._internalIntervalLock=new H.WatchedValue(this._intervalLock.value()),this._trackTimeLock=new H.WatchedValue(!1),this._combinedTrackTimeLock=this._createCombineTrackTimeLock(),this._internalTrackTimeLock=new H.WatchedValue(this._combinedTrackTimeLock.value()),this._dateRangeLock=new H.WatchedValue(!1),this._internalDateRangeLock=new H.WatchedValue(this._dateRangeLock.value()),this._crosshairLock=new H.WatchedValue(R.getBool("chart.syncCrosshair",!0)),this._activeChartCanBeMoved=new H.WatchedValue(!1),this._symbolLockSpawn=this._symbolLock.spawn(),this._intervalLockSpawn=this._intervalLock.spawn(),this._dateRangeLockSpawn=this._dateRangeLock.spawn(),
this._trackTimeLockSpawn=this._trackTimeLock.spawn(),this._crosshairLockSpawn=this._crosshairLock.spawn(),this._hotkeys=(0,B.createGroup)({desc:"Layout"}),this._saveChartService=null,this._chartStorageNotification=null,this._newsNotifier=null,this._crossHairSyncBroadcast=null,this._crossHairSyncEnabledSubscriptionId=null,this._maximizedChartDef=new H.WatchedValue(null),this._maximizedChart=new H.WatchedValue(null),this._chartWidgetCreatedDelegate=new g.Delegate,this._onZoom=new g.Delegate,this._onScroll=new g.Delegate,this._bottomToolbar=new H.WatchedValue(null),this._bottomToolbarWidget=null,this._bottomToolbarDestroyer=null,this._linkingGroupsCharts=new Map,this._chartModels=new z.WatchedObject([],J.compareTwoCollectionsByIds),this._customLegendWidgetsFactoriesMap=new Map,this._customSources=new Map,this._replayContainer=null,this._prevMaximizedChartDef=null,this._phoneStates=[],this._chartsSwappedDelegate=new g.Delegate,this._saveKeysPressedDelegate=new g.Delegate,this._subscribedChartWidget=null,this._lineToolsSplitAdjuster=null,this._tool=D.tool.spawn(),this._activeChartInterval=new z.WatchedObject($.Interval.parse("")),this._hasChanges=new H.WatchedValue(!1),this._hasChangesSpawn=null,this._pendingSetSymbolCancellationToken={cancelled:!0},this._symbolAliasService=null,this._replaySessionState=null,this._chartFloatingTooltipController=null,this._chartFloatingTooltipVisible=new H.WatchedValue(!1),this._activeChartWidgetModel=new H.WatchedValue(null),this._onChartFloatingTooltipEnabledChanged=()=>{_m.chartFloatingTooltipEnabledWV.value()?this._chartFloatingTooltipController=new gm(this):(this._chartFloatingTooltipController?.destroy(),this._chartFloatingTooltipController=null)},this._onResizeActionChanged=e=>{this._dateRangeLock.value()&&null===e&&this._syncChartsDateRangesWithActiveChartRange()},this._recalcHasChanges=()=>{this._lineToolsSynchronizerHasChanges.setValue(this._chartWidgetsDefs.some((e=>{const t=e.chartWidget.lineToolsSynchronizer();return null!==t&&t.hasChanges().value()})))},this._handlePhoneSize=(e,t)=>{this._options.mobileForceChartMaximizeEnabled&&(!this._phoneStates.includes(oe.mediaState.device??"")||t&&this._phoneStates.includes(t)?this._phoneStates.includes(oe.mediaState.device??"")||t&&!this._phoneStates.includes(t)||this._isPhoneSize.setValue(!1):this._isPhoneSize.setValue(!0))},this._handlePhoneForceFullscreen=()=>{if(!window.is_authenticated)return;const e=(0,d.isFeaturesetEnabled)("app_phone");!(0,d.isFeaturesetEnabled)("app_tablet")&&(e||this._isPhoneSize.value())?this._viewMode.value()===re.CollectionViewMode.ForceFullscreen&&(this._prevMaximizedChartDef=this._maximizedChartDef.value(),this.activeChartWidget.value().requestFullscreen()):this._prevMaximizedChartDef||(this._setMaximized(null),this._updateViewMode())},this._updateActiveChartCanBeMoved=()=>{this._activeChartCanBeMoved.setValue(!this._readOnly&&this.inlineChartsCount.value()>1&&!this._isDetached(this._chartWidgetsDefs[this._activeIndex]))},this._updateLinkingGroupCharts=()=>{const e=new Map
;for(const t of this._chartWidgetsDefs){const i=t.chartWidget.linkingGroupIndex().value();let s=e.get(i);void 0===s&&(s=[],e.set(i,s)),s.push(t.chartWidget)}for(const t of(0,J.join)(new Set(this._linkingGroupsCharts.keys()),new Set(e.keys())))this._getLinkingGroupCharts(t).setValue(e.get(t)??[])},this._updateLayout=()=>{let e;const t=this._layoutTemplate.value(),i=this._maximizedChartDef.value();if(e=i?[i]:this._chartWidgetsDefs.slice(0,t.count).filter((e=>!e.hiddenInLayout.value())),e.forEach(((t,i)=>this._updateLayoutPartial(t,i,e.length))),this._maximizedChartDef.value())this._clearSplitters();else{const{padding:e=2,border:i=0}=this._options,s=this._computeContentBox(),o=t.splitters(s,e+i,this._sizingState.value());this._clearSplitters(o.length);const r=this._splitters.value(),n=o.map(((e,t)=>{const i=t<r.length?r[t].splitterElement:document.createElement("div");let s,o;t<r.length?(s=r[t].mouseListener,o=r[t].mouseHandler):(s=new um({state:this._stateImpl(),splitterElement:i,splitter:e,computeContentBox:this._computeContentBox.bind(this)}),o=new oi.MouseEventHandler(i,s));const n=e.metrics,a=i.classList.contains(am.hovered),l=i.classList.contains(am["i-active"]);return i.className="",i.classList.add(am.chartsSplitter),i.classList.add(`chart-widget-collection-border-${e.className}`),a&&i.classList.add(am.hovered),l&&i.classList.add(am["i-active"]),i.style.left=n.left+"px",i.style.top=n.top+"px",i.style.width=n.width+"px",i.style.height=n.height+"px",i.setAttribute("aria-hidden","true"),"v"===e.orientation?i.style.cursor="ns-resize":i.style.cursor="ew-resize",this._parent.insertBefore(i,this._bottomToolbar.value()),{splitter:e,splitterElement:i,mouseHandler:o,mouseListener:s}}));this._splitters.setValue(n)}},this.undoHistory=function(e){const t=[],i=new v,s=new v,o={chartWidgetCollection:e},r=new g.Delegate;function n(e){if(t.length>0)t[t.length-1].addCommand(e);else{s.clear();const t=i.head(),o=t&&t.text().originalText();t&&t.canMerge(e)?t.merge(e):i.push(e);const r=e.text().originalText();""!==r&&r!==o&&w.logNormal("DO: "+r)}e.executeOnPush()&&e.redo(o),t.length||r.fire(l())}function l(){const e=i.head(),t=s.head(),o=void 0===e?void 0:e.text(),r=void 0===t?void 0:t.text();return{enableUndo:!i.isEmpty(),undoCommandCount:i.size(),undoText:void 0!==o?o.translatedText():o,enableRedo:!s.isEmpty(),redoCommandCount:s.size(),redoText:void 0!==r?r.translatedText():r,originalUndoText:void 0!==o?o.originalText():void 0,originalRedoText:void 0!==r?r.originalText():void 0}}return{beginUndoMacro:function(e){const i=new f(e);return t.push(i),i},clearStack:function(){i.clear(),s.clear(),r.fire(l())},createUndoCheckpoint:function(){return{lastActualCommand:i.isEmpty()?null:i.head()}},endUndoMacro:function(){const e=(0,a.ensureDefined)(t.pop());e.isEmpty()||n(e)},pushUndoCommand:n,redo:function(){if(s.isEmpty())return!1;const e=s.pop();return!!e&&(e.redo(o),i.push(e),w.logNormal("REDO: "+e.text().originalText()),r.fire(l()),!0)},redoStack:function(){return s},setWatchedValue:function(e,t,i,s){const o=e.value();if(o!==t){
const r=new y(e,o,t,i,!s);n(r),r.redo()}},undo:function(){if(i.isEmpty())return!1;const e=i.pop();return!!e&&(e.undo(o),s.push(e),w.logNormal("UNDO: "+e.text().originalText()),r.fire(l()),!0)},undoStack:function(){return i},undoToCheckpoint:function(e){for(;!i.isEmpty()&&e.lastActualCommand!==i.head();)i.pop().undo(o);s.clear(),r.fire(l())},state:l,onChange:function(){return r}}}(this),this._options=(0,s.default)({},eg,e),this._readOnly=this._options.readOnly||!1;const t=this._readOnly?{id:"read-only",state:e.content?.symbolAliasServiceState??[]}:void 0;if(this._symbolAliasService=(0,De.getSymbolAliasService)(t),this.layout=this._layoutWV.readonly(),this.selectedSources=this._selectedSources.readonly(),this.inlineChartsCount=this._inlineChartsCount.readonly(),this.lineToolsSynchronizerHasChanges=this._lineToolsSynchronizerHasChanges.readonly(),this.viewMode=this._viewMode.readonly(),this.lock={symbol:this._symbolLockSpawn,interval:this._intervalLockSpawn,dateRange:this._dateRangeLockSpawn,crosshair:this._crosshairLockSpawn,trackTime:this._trackTimeLockSpawn},this._symbolLock.subscribe((e=>this._handleSymbolLockChange(e))),this._internalSymbolLock.subscribe((e=>this._handleInternalSymbolLockChange(e))),this._intervalLock.subscribe((e=>this._handleIntervalLockChange(e))),this._internalIntervalLock.subscribe((e=>this._handleInternalIntervalLockChange(e))),this._trackTimeLock.subscribe((e=>this._handleTrackTimeLockChange(e))),this._internalTrackTimeLock.subscribe((e=>this._handleInternalTrackTimeLockChange(e))),this._dateRangeLock.subscribe((e=>this._handleDateRangeLockChange(e))),this._internalDateRangeLock.subscribe((e=>this._handleInternalDateRangeLockChange(e))),this._currentLayoutResizeAction.subscribe(this._onResizeActionChanged),window.TVD){const e=window.TVD.crosshairSyncEnabled;e?(e.value()&&(this._crossHairSyncBroadcast=this._createBroadcastChannel()),this._crossHairSyncEnabledSubscriptionId=e.subscribe((e=>{e?this._crossHairSyncBroadcast=this._createBroadcastChannel():(this._destroyBroadcastChannel(),this._crossHairSyncBroadcast=null)}))):this._crossHairSyncBroadcast=this._createBroadcastChannel()}this._crosshairLock.subscribe((e=>{R.setValue("chart.syncCrosshair",e);for(let e=0;e<this._chartWidgetsDefs.length;++e){const t=this._chartWidgetsDefs[e].chartWidget;t.hasModel()&&t.model().model().lightUpdate()}})),this._widthWV=this._options.resizerBridge.width,this._heightWV=this._options.resizerBridge.height,this._maximizedChartDef.subscribe((e=>{const t=this._maximizedChart.value();this._maximizedChart.setValue(null===e?null:e.chartWidget),e&&this.activeChartWidget.setValue((0,a.ensureNotNull)(e.chartWidget)),e&&t&&t.setActivePaneWidget(null)})),this._maximizedChartDef.subscribe((e=>{this._chartWidgetsDefs.forEach((t=>{t.fullscreen.setValue(t===e)}))}),{callWithLast:!0}),this._maximizedChartDef.subscribe((()=>{this._updateChartsVisibility(),this._updateLayout(),N.emit("layout_changed")})),this._widgetOptions=this._options.widgetOptions||{},this.onWidget=!!this._widgetOptions.onWidget
;const i=this._options.metaInfo||{};this.metaInfo={id:new H.WatchedValue(i.id||null),name:new H.WatchedValue(i.name),description:new H.WatchedValue(i.description),username:new H.WatchedValue(i.username),uid:new H.WatchedValue(i.uid),lastModified:new H.WatchedValue(i.lastModified),isPrivate:new H.WatchedValue(i.isPrivate)};this.undoHistory.onChange().subscribe(null,(e=>{N.emit("undo_redo_state_changed",e)})),this._parent=this._options.resizerBridge.container.value(),this._parent.classList.add("unselectable"),this._parent.addEventListener("contextmenu",G.preventDefaultForContextMenu),this._options.seriesControlBarEnabled&&this._createSeriesControlWidget(),this._chartPropertiesDialogRenderer=new Y(this),this._compareDialogRenderer=new X(this),window.ChartApiInstance.connectionsLimitReached().subscribe(Hm,{callWithLast:!0}),this._sizingState.subscribe((()=>this._updateLayout())),this._widthWV.subscribe(this._updateLayout),this._heightWV.subscribe(this._updateLayout),this._activeLinkingGroupWV=this._getActiveLinkingGroupWV(),this._allLinkingGroupsWV=this._getAllLinkingGroupsWV(),this._isPhoneSize.setValue(!1),this._phoneStates=["phone","phone-vertical"],this.activeChartWidget.subscribe((e=>{if(!e)return void this._activeChartWidgetModel.setValue(null);e.hasModel()?this._activeChartWidgetModel.setValue(e.model()):e.withModel(null,(()=>{e===this.activeChartWidget.value()&&this._activeChartWidgetModel.setValue(e.model())}));let t=NaN;for(let i=this._chartWidgetsDefs.length;i--;)if(this._chartWidgetsDefs[i].chartWidget===e){t=i;break}if(!isFinite(t))throw new Error("Cannot make detached ChartWidget active");if(this._activeIndex!==t){this._maximizedChartDef.value()&&(this._isDetached(this._chartWidgetsDefs[t])||this._maximizedChartDef.setValue(this._chartWidgetsDefs[t])),this._activeIndex=t,this._updateActivityView();for(let t=this._chartWidgetsDefs.length;t--;)this._chartWidgetsDefs[t].chartWidget!==e&&this._chartWidgetsDefs[t].chartWidget.setActive(!1);this._updateCrossHairPositionIfNeeded(),e.setActive(!0),D.activePointSelectionMode.setValue(e.selectPointMode().value())}this._updateActiveChartCanBeMoved(),this._updateActiveChartInterval(),this._subscribeToProperties(e)}),{callWithLast:!0}),this._readOnly||(this._hotkeys.add({desc:"Switch active chart",hotkey:(0,d.isFeaturesetEnabled)("accessible_keyboard_shortcuts")?B.Modifiers.Shift+39:9,handler:()=>this.switchChart(!1)}),this._hotkeys.add({desc:"Switch active chart",hotkey:(0,d.isFeaturesetEnabled)("accessible_keyboard_shortcuts")?B.Modifiers.Shift+37:O.Modifiers.Shift+9,handler:()=>this.switchChart(!0)})),this._hotkeys.add({desc:"Fullscreen mode",hotkey:B.Modifiers.Shift+70,isDisabled:(0,d.isFeaturesetEnabled)("widget")||!this.fullscreenable().value(),handler:()=>{this.fullscreen().value()?this.exitFullscreen():this.startFullscreen()}}),this._options.takeScreenshotEnabled&&(this._hotkeys.add({desc:"Screenshot server",hotkey:B.Modifiers.Alt+83,handler:this.takeServerScreenshot.bind(this)}),(0,W.isOnMobileAppPage)("any")||(this._hotkeys.add({
desc:"Download client screenshot",hotkey:B.Modifiers.Mod+B.Modifiers.Alt+83,handler:tt.bind(this,this)}),this._hotkeys.add({desc:"Copy client screenshot",hotkey:B.Modifiers.Mod+B.Modifiers.Shift+83,handler:it.bind(this,this)}))),this._options.saveChartEnabled&&this._hotkeys.add({desc:"Save Chart Layout",hotkey:B.Modifiers.Mod+83,handler:()=>this._saveKeysPressedDelegate.fire()}),this._clipboardHandler=this._createClipboardHandler(),this.clipboard=this._clipboardHandler,this._options.globalEvents&&this._clipboardHandler.listen(),this._leftBottomChartWidget=Um(this.getAll.bind(this),this._layoutWV.readonly(),this._chartsSwappedDelegate,this._chartWidgetCreatedDelegate),function(e,t){if(Ze(e,t.widgetOptions)){const i=new Xe(e,!e.readOnly());i.beforeUnhibernating().subscribe(e,(()=>{!function(e){e.chartWidgetsDefs.map((e=>e.chartWidget)).forEach((e=>e.reloadAllLineTools()))}(t)})),t.setChartStorageNotificationSubscription(i)}}(this,this._stateImpl()),this._createChartWidgetCollectionNewsNotifier().then((e=>{this._destroyed||(this._newsNotifier=e)})),this._layoutWV.subscribe((e=>this._layoutType=e)),this._layoutWV.subscribe((()=>this._updateActivityView())),this._inlineChartsCount.subscribe(this._updateActiveChartCanBeMoved),this._inlineChartsCount.subscribe((e=>{this._chartWidgetsDefs.forEach(((t,i)=>{t.collapsed.setValue(i>=e)}))})),this._inlineChartsCount.subscribe((e=>{this._bottomToolbar.value()?.classList.toggle("multiple-layout",e>1)})),this.loadContent(this._options.content,!0).then((e=>{this._readOnly&&(this._layoutWV.writeLock=!0),e.contentMigrated&&N.emit("chart_migrated")})),window.addEventListener("resize",this._updateLayout),this._options.mobileForceChartMaximizeEnabled&&(oe.mediaState.on("changeDevice",this._handlePhoneSize),this._options.handleMaximizedChartOnResizeDisabled||oe.mediaState.on("changeDevice",this._handlePhoneForceFullscreen),this._handlePhoneSize(),this._handlePhoneForceFullscreen());let o=0;const r=()=>{--o,0===o&&N.emitOnce("onChartReady")};this._chartWidgetsDefs.forEach((e=>{if(!e)return;o++;const t=e.chartWidget;t.withModel(null,(()=>{this._options.metaInfo&&t.model().model().setChartSaveTime(1e3*this._options.metaInfo.lastModified);const e=t.model().mainSeries();if(e.bars().size()>0||e.isFailed())r();else{const t=e.dataEvents(),i=()=>{r(),t.barReceived().unsubscribe(null,i),t.completed().unsubscribe(null,i),t.error().unsubscribe(null,i),t.unsupportedResolutionRequested().unsubscribe(null,i)};t.barReceived().subscribe(null,i),t.completed().subscribe(null,i),t.error().subscribe(null,i),t.unsupportedResolutionRequested().subscribe(null,i)}}))})),this._allInitialModelsCreated().then(Qm).then((()=>{window.saver&&window.is_authenticated&&this._options.widgetOptions.justCloned&&window.saver.saveChartSilently()})).catch(Sm.logError.bind(Sm)),_m.chartFloatingTooltipEnabledWV.subscribe(this._onChartFloatingTooltipEnabledChanged,{callWithLast:!0})}destroy(){if(_m.chartFloatingTooltipEnabledWV.unsubscribe(this._onChartFloatingTooltipEnabledChanged),this._chartFloatingTooltipController?.destroy(),
this.onAboutToBeDestroyed.fire(),this.setActive(!1),this._bottomToolbarDestroyer?.(),this._bottomToolbarDestroyer=null,this._symbolLockSpawn.destroy(),this._intervalLockSpawn.destroy(),this._trackTimeLockSpawn.destroy(),this._dateRangeLockSpawn.destroy(),this._combinedTrackTimeLock.destroy(),this._crosshairLockSpawn.destroy(),this._currentLayoutResizeAction.unsubscribe(this._onResizeActionChanged),this._chartWidgetsDefs.forEach((e=>e.destroy())),this._options.resizerBridge.remove(),this._clearSplitters(),window.removeEventListener("resize",this._updateLayout),oe.mediaState.off("changeDevice",this._handlePhoneSize),this._options.mobileForceChartMaximizeEnabled&&!this._options.handleMaximizedChartOnResizeDisabled&&oe.mediaState.off("changeDevice",this._handlePhoneForceFullscreen),this._tool.destroy(),this._parent.remove(),this._customSources.clear(),this._customLegendWidgetsFactoriesMap.clear(),this._hotkeys.destroy(),this._chartStorageNotification&&this._chartStorageNotification.destroy(),this._clipboardHandler&&this._clipboardHandler.destroy(),this._newsNotifier&&this._newsNotifier.destroy(),this._activeLinkingGroupWV.destroy(),this._allLinkingGroupsWV.destroy(),window.TVD&&null!==this._crossHairSyncEnabledSubscriptionId){const e=window.TVD.crosshairSyncEnabled;e&&e.unsubscribe(this._crossHairSyncEnabledSubscriptionId),this._destroyBroadcastChannel()}this._hasChangesSpawn?.destroy(),this._leftBottomChartWidget.destroy(),this._destroyed=!0}activeCharWidgetModel(){return this._activeChartWidgetModel.readonly()}innerState(){return this._stateImpl()}getAll(){return this._chartWidgetsDefs.map((e=>e.chartWidget))}maximizedChartWidget(){return this._maximizedChart.readonly()}leftBottomChartWidget(){return this._leftBottomChartWidget}activeLinkingGroup(){return this._activeLinkingGroupWV}allLinkingGroups(){return this._allLinkingGroupsWV}linkingGroupsCharts(e){return this._getLinkingGroupCharts(e).readonly()}async setLayout(e){(0,ge.getInitData)().android_app&&(Ym.includes(e)&&!(0,d.isFeaturesetEnabled)("mobile_app_supports_new_layout_types")||Xm.includes(e)&&!(0,d.isFeaturesetEnabled)("mobile_app_supports_new_layout_types_2"))&&(e="s");{let e=!1;if(null!==this._saveChartService&&(e=Boolean(this._saveChartService.autoSaveEnabled().value())),e)try{const e=this._chartWidgetsDefs.map((e=>e.chartWidget?.lineToolsSynchronizer()?.flushPendingSavings()??null)).filter(n.notNull);e.length&&await Promise.all(e)}catch(e){Sm.logError(`Error flushing line tools: ${e}`)}}(e=this._checkProFeature(e))in M.layouts||(e="s"),N.emit("layout_about_to_be_changed",e),this._clearSplitters();const t=M.layouts[e];this._layoutTemplate.setValue(t);const{count:i,layoutType:s,expression:o}=t,r=this._allLayoutSizesState.get(s)??(0,rt.layoutInitialSizingState)(o);this._allLayoutSizesState.set(s,r),this._sizingState.setValue(r);for(let e=0;e<i||e<this._chartWidgetsDefs.length;e++){let t=this._chartWidgetsDefs[e];if(e<i){if(t){if(this._loadingContent){const e=this._savedChartWidgetOptions.shift();e&&await(0,
a.ensureNotNull)(t.chartWidget).loadContent(e.content,this._initialLoading)}}else t=this._addNewChartWidget(e);t.container.value().classList.toggle("multiple",i>1)}}this._updateChartsVisibility(),this._sizingState.setValue(r),this._layoutWV.setValue(e),this._recalculateMaximizedChartDef(),this._updateInlineChartsCount(),this._updateLayout(),this._updateWatchedValue(),this._checkAllPendingModelsAlreadyCreated(),this._initialLoading||this._updateViewMode(),this._inlineChartsCount.value()<1&&i>0&&this._chartWidgetsDefs[i-1].rdState.bridge().attach()}async setChartStyleToWidget(e,t){if(t??=this.activeChartWidget.value(),!t)return!1;{if($.Interval.isTicks(t.resolutionWV().value())&&(4===e||7===e||5===e||6===e))return t.showHint(1,{text:bm.format({chartStyle:(0,Q.getTranslatedChartStyleName)(e)}),solutionId:Be.solutionIds.WHY_RENKO_NOT_WORK,solutionText:h.t(null,void 0,i(644780))}),!1;let s=!1;const o=(this._intervalLock.value()?this.getAll():[this.activeChartWidget.value()]).filter((e=>e.hasModel()));for(const t of o){const i=t.model().model();if(i.isInReplay().value()&&!i.mainSeries().isStyleSupported(e)){s=!0;break}}const r=this.innerState().flags;return!s||r.isConfirmationAboutReplayLocked?(this.setChartStyle(t,e),!0):new Promise((i=>{(0,V.showConfirm)({text:ym,onConfirm:s=>{r.isConfirmationAboutReplayLocked=!0,this.setChartStyle(t,e),r.isConfirmationAboutReplayLocked=!1,s.dialogClose(),i(!0)},onClose:()=>i(!1),onCancel:e=>{e.dialogClose(),i(!1)}})}))}}state(e){const{withData:t,skipLineToolsFromOtherSymbols:i,wipeSensitiveData:s,skipLineTools:o,skipHiddenSources:r,addOnlyActiveChart:n}=e;let a=n?this.getAll().indexOf(this.activeChartWidget.value()):0;const l=n?a+1:this._chartsCountToSave(),c=[],h={},d=new Set;for(;a<l;a++){const e=this._chartWidgetsDefs[a];if(e?.chartWidget.hasModel()){const t=e.chartWidget.model().model().mainSeries().symbolInfo();t&&d.add(t.pro_name)}const n=this._getStateForChartImpl(a,t,i,s,o,r);if(n){let e=n;{const t=e=>/^study_?.*$/gim.test(e.type);e={...e,panes:e.panes.map((e=>({...e,sources:e.sources.map((e=>{if(t(e)){const{metaInfo:t,...i}=e,s=ce(t);h[s]||(h[s]=t);const o=e.data?.symbols??{};for(const e of Object.keys(o)){const t=o[e];t&&d.add(t.pro_name)}return{...i,metaInfo:s}}return e}))})))}}c.push(e)}}const u=n?void 0:Array.from(this._allLayoutSizesState.entries()).reduce(((e,[t,i])=>(e[t]=i,e)),{});return{name:this.metaInfo.name.value(),layout:n?"s":this._layoutType,charts:c,symbolLock:Jm(this._symbolLock),intervalLock:Jm(this._intervalLock),trackTimeLock:Jm(this._trackTimeLock),dateRangeLock:Jm(this._dateRangeLock),crosshairLock:Jm(this._crosshairLock),layoutsSizes:u,studyMetaInfoMap:h,symbolAliasServiceState:this._symbolAliasService?.state(Array.from(d)),replaySessionState:t||s?void 0:this._replaySessionState??void 0}}applyLineToolUpdateNotification(e,t,i){Nm.call(this,this._chartWidgetsDefs,e,t,i)}readOnly(){return this._readOnly}onZoom(){return this._onZoom}onScroll(){return this._onScroll}resizerBridge(){return this._options.resizerBridge}setSymbol(e,t,i){
return this._setSymbolImpl(e,t,i)}setSymbolAll(e){const t=this._chartWidgetsDefs.map((e=>e.chartWidget));return this._setSymbolImpl(e,void 0,void 0,t)}async setResolution(e,t,s){const o=this._flags;if(o.loadingChart||o.setTimeFrameActive||o.setNewResolution||o.setChartStyleActive)return!1;{const r=$.Interval.isTicks(e),n=this._getChartWidgetsForIntervalLock();if(r)for(const e of n){const t=e.model().model().mainSeries().style();if(4===t||7===t||5===t||6===t)return e.showHint(1,{text:bm.format({chartStyle:(0,Q.getTranslatedChartStyleName)(t)}),solutionId:Be.solutionIds.WHY_RENKO_NOT_WORK,solutionText:h.t(null,void 0,i(644780))}),!1}let a="",l=!1;const c=$.Interval.isRange(e);if(c||r&&!Zm)for(const e of n){const t=e.model().model();if(t.isInReplay().value()){if(c&&11!==t.mainSeries().style()){l=!0,a=ym;break}r&&(l=!0,a=wm)}}const d=n.filter((e=>e.model().isInReplay().value()));if(d.length){if(!(await Promise.all(d.map((t=>t.model().canChangeResolution(e))))).every(Boolean))return!1}return!l||o.isConfirmationAboutReplayLocked?(this._applyResolution(e,t,s),!0):new Promise((i=>{(0,V.showConfirm)({text:a,onConfirm:r=>{o.isConfirmationAboutReplayLocked=!0,this._applyResolution(e,t,s),o.isConfirmationAboutReplayLocked=!1,r.dialogClose(),i(!0)},onClose:()=>i(!1),onCancel:e=>{e.dialogClose(),i(!1)}})}))}}setTimeFrame(e){this._flags.loadingChart||this._flags.setTimeFrameActive||((0,Re.trackIntervalChanging)(e.res,"Date range"),this._flags.setTimeFrameActive=!0,this._intervalLock.value()?this._chartWidgetsDefs.forEach((t=>{t.chartWidget.loadRange(e)})):this.activeChartWidget.value().loadRange(e),this._flags.setTimeFrameActive=!1)}setChartStyle(e,t){this._flags.setChartStyleActive=!0;const i=e.model(),s=i.mainSeries().properties().childs().style;i.setChartStyleProperty(s,t,Im),this._flags.setChartStyleActive=!1}async setChartLayoutWithUndo(e){if(e=this._checkProFeature(e),this.layout.value()===e)return!1;{let e=!1;if(this._saveChartService&&(e=Boolean(this._saveChartService.autoSaveEnabled().value())),e){const e=this._chartWidgetsDefs.map((e=>e.chartWidget?.lineToolsSynchronizer()?.flushPendingSavings()??null)).filter(n.notNull);if(e.length)try{await Promise.all(e)}catch(e){Sm.logError(`Error flushing line tools: ${e}`)}}}return this.undoHistory.pushUndoCommand(new I(this,e)),!0}images(e){const t=Math.max(1,window.devicePixelRatio||1),i=this.getAll();let s;{const e=this._options.widgetOptions.customerReadableName||"TradingView.com",t={timezone:this.activeChartWidget.value().model().model().timezoneExceptExchange().value()??"exchange",dateFormat:"MMM dd, yyyy"},i=new Se.DateTimeWithTzFormatter(t).format(window.ChartApiInstance.serverTime()/1e3),o=this.metaInfo.username.value(),r=!o||this.readOnly()||this._widgetOptions.onWidget?fm:vm,n=[r.split(/{date}/)[0].format({userName:o,customer:e}).trim(),i],a=[r.format({userName:o,customer:e,date:i}).trim()];s="phone-vertical"===oe.mediaState.device?n:a}const o=this.maximizedChartWidget().value();if(e&&e.onlyActiveChart||o)return{layout:"s",hidpiRatio:t,theme:(0,L.getCurrentTheme)().name,
charts:[this.activeChartWidget.value().images(e)],publishedBy:s};const r=[],n=M.layouts[this.layout.value()].count,a={showCollapsedStudies:(e=e||{}).showCollapsedStudies,status:e.status};for(let e=0;e<i.length&&e<n;e++)r.push(i[e].images(a));return{layout:this.layout.value(),hidpiRatio:t,theme:(0,L.getCurrentTheme)().name,charts:r,publishedBy:s}}clientSnapshot(e={}){const t={hideResolution:Boolean(e.hideResolution)};return(0,_.isSymphonyEmbed)()||(e.showHeaderPublishedBy=!0),(0,rm.clientSnapshot)(this.images({showCollapsedStudies:!1,status:t}),e)}tags(){let e=[];for(let t=0;t<this._chartWidgetsDefs.length&&t<this._layoutTemplate.value().count;t++)e=e.concat(this._chartWidgetsDefs[t].chartWidget.tags());return e=Array.from(new Set(e)),e=e.map((e=>e.toLowerCase().replace(/\W+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""))),e}syncCrosshair(e,t,i){if(this._setExternalPosition(e,t,i)){const t=this._crossHairSyncBroadcast;if(t){const s={type:"crosshair",payload:{point:e,envState:i,sourceUniqueId:t.uniqueId}};t.channel.postMessage(s)}}}syncScroll(e,t){if(!this._combinedTrackTimeLock.value()||this._dateRangeLock.value())return;const i=this._layoutTemplate.value().count;this.undoHistory.beginUndoMacro(Lm),this._chartWidgetsDefs.slice(0,i).filter((e=>e.chartWidget.hasModel()&&e.chartWidget.model().model()!==t)).forEach((t=>{const i=t.chartWidget.model().model(),s=i.mainSeries().syncModel();s&&i.syncTimeWithModel(s.syncSourceTarget(),e)})),this.undoHistory.endUndoMacro(),N.emit("sync_time",e)}clearChartMetaInfo(){this.metaInfo.id.setValue(null),this.metaInfo.uid.setValue(""),this.metaInfo.name.setValue("")}async takeScreenshot(){if(0===this._options.snapshotUrl?.length)return console.warn("To use this feature, please specify the snapshot_url option in the widget constructor."),"";const e={snapshotUrl:this._options.snapshotUrl};e.asyncSave=!window.TVD;const t=await ie(this,e);return N.emit("onScreenshotReady",t),t}async takeServerScreenshot(){if(0===this._options.snapshotUrl?.length)return console.warn("To use this feature, please specify the snapshot_url option in the widget constructor."),"";const e={snapshotUrl:this._options.snapshotUrl};e.asyncSave=!window.TVD;const t=(0,W.isOnMobileAppPage)("any"),i=t?ie:te,s=await i(this,e);return N.emit("onScreenshotReady",s),t||N.emit("onServerScreenshotCopiedToClipboard"),s}async loadLayoutState(e){this.metaInfo.id.setValue(e.id),this.metaInfo.uid.setValue(e.uid),this.metaInfo.name.setValue(e.name),this.metaInfo.description.setValue(e.description),this.metaInfo.username.setValue(e.username),this.metaInfo.lastModified.setValue(e.lastModified),this.metaInfo.isPrivate.setValue(e.isPrivate);const t=await this.loadContent(e.chartWidgetCollectionState);this.unloadUnusedCharts(),this.undoHistory.clearStack(),N.emit("layout_loaded"),t.contentMigrated&&N.emit("chart_migrated")}saveLayoutState(){return new Promise(((e,t)=>{this._saveChartService?.saveChartOrShowTitleDialog((()=>{}),e,t)}))}async loadContent(e,t){Sm.logNormal("Loading layout content"),
this.getAll().forEach((e=>e.onAboutToLoadContent())),this._loadingContent=!0,this._initialLoading=Boolean(t),this._savedChartWidgetOptions.splice(0),(0,D.init)();let i=!1,s=this._layoutType;if(e){const t=function(e){return"charts"in e}(e)?e:{layout:"s",charts:[e],name:""};if(Km){const e=t.charts.map((e=>(0,a.ensureDefined)(e.chartId))),s=function(e){if(1===e.length)return e;if(new Set(e).size===e.length)return e;const t=new Set;for(const i of e)/^\d+$/.test(i)&&t.add(+i);let i=1;const s=[];for(const o of e){for(;t.has(i);)i++;let e=o;s.includes(o)&&(e=`${i}`,t.add(i)),s.push(e)}return s}(e);t.charts.forEach(((t,o)=>{t.chartId=s[o],i=i||t.chartId!==e[o]}))}if(t.layoutsSizes)for(const e of Object.keys(t.layoutsSizes))this._allLayoutSizesState.set(e,t.layoutsSizes[e]);const r=new Set;if(t.charts.forEach((e=>{e.chartId&&r.add(e.chartId)})),t.charts.forEach((e=>{if(!e.chartId){const t=zm((e=>r.has(e)));r.add(t),e.chartId=t}})),s=t.layout,!(0,M.isSupportedLayout)(s)){const e=(0,M.tryGuessingTheMostSuitableLayout)(s);Sm.logError(`Loading unsupported layout ${s}. Force migration to ${e}`),s=e}for(const e of t.charts){if("studyMetaInfoMap"in t){const i=t;e.panes.forEach((e=>{e.sources.forEach((e=>{if("metaInfo"in e&&(0,o.default)(e.metaInfo)){const t=(0,a.ensureDefined)(i.studyMetaInfoMap)[e.metaInfo];t&&(e.metaInfo=(0,n.clone)(t))}}))}))}this._savedChartWidgetOptions.push({content:e})}void 0!==t.symbolLock&&this._symbolLock.setValue(Boolean(t.symbolLock)),void 0!==t.intervalLock&&this._intervalLock.setValue(Boolean(t.intervalLock)),void 0!==t.trackTimeLock&&this._trackTimeLock.setValue(Boolean(t.trackTimeLock)),void 0!==t.dateRangeLock&&this._dateRangeLock.setValue(Boolean(t.dateRangeLock)),void 0!==t.crosshairLock&&this._crosshairLock.setValue(Boolean(t.crosshairLock)),this._replaySessionState=t.replaySessionState??null}return(0,u.muteLinkingGroup)("all",!0),await this.setLayout(s||"s"),(0,u.muteLinkingGroup)("all",!1),"s"===this._layoutType||this._options.mobileForceChartMaximizeEnabled||this._viewMode.setValue(re.CollectionViewMode.Multichart),this._tool.subscribe(this._onToolChanged.bind(this)),this._tool.subscribe(this._updateCrossHairPositionIfNeeded.bind(this)),this._loadingContent=!1,this._initialLoading=!1,{contentMigrated:i}}applyOverrides(e){for(let t=0;t<this._chartWidgetsDefs.length;t++)this._chartWidgetsDefs[t].chartWidget.applyOverrides(e)}applyStudiesOverrides(e){Gm(e)}switchChart(e){const t=this._getVisuallyAdjacentDef(this._chartWidgetsDefs[this._activeIndex],e);this.ariaDescribeChart(t?t.chartWidget:this.activeChartWidget.value()),t&&this.activeChartWidget.setValue(t.chartWidget)}startFullscreen(){this._options.resizerBridge.requestFullscreen()}exitFullscreen(){this._options.resizerBridge.exitFullscreen()}fullscreenable(){return this._options.resizerBridge.fullscreenable}fullscreen(){return this.resizerBridge().fullscreen}chartWidgetCreated(){return this._chartWidgetCreatedDelegate}saveKeysPressed(){return this._saveKeysPressedDelegate}getContainer(){return this._parent}async applyTheme(e){
const{theme:t,onlyActiveChart:i,restoreNonThemeDefaults:s,themeName:o,standardTheme:r,syncState:n=!0,noUndo:a}=e,l=(0,L.getCurrentTheme)().name;let c;i?c=[this.activeChartWidget.value()]:(await Promise.all(this._savedChartWidgetOptions.map(((e,t)=>t)).map((e=>new Promise((t=>{const i=this._addNewChartWidget(e,t);this._hideChart(i)}))))),c=this._chartWidgetsDefs.map((e=>e.chartWidget))),a?(r&&new E(l,o,n).redo(),c.forEach((e=>{e.model().model().restoreTheme(t,s,a)}))):(this.undoHistory.beginUndoMacro(Vm),r&&this.undoHistory.pushUndoCommand(new E(l,o,n)),c.forEach((e=>{e.model().model().restoreTheme(t,s)})),this.undoHistory.endUndoMacro()),await Promise.all(c.map((e=>e.model().model().colorStudiesPropertiesReady())))}applyIndicatorsToAllCharts(e){const t=e.model().model().studyTemplate();this.undoHistory.beginUndoMacro(Om);for(let i=0;i<this._chartWidgetsDefs.length;i++){const s=this._chartWidgetsDefs[i].chartWidget;s!==e&&(s.hasModel()&&s.model().applyStudyTemplate(t,""))}this.undoHistory.endUndoMacro()}applyIndicatorsToAllChartsAvailable(){return!this._readOnly&&this._actualLayoutCount()>1}async applyIndicatorToAllCharts(e,t,i,s){this.undoHistory.beginUndoMacro(s);for(let o=0;o<this._chartWidgetsDefs.length;o++){const r=this._chartWidgetsDefs[o].chartWidget;if(r!==e&&r&&r.hasModel()){const e=r.model();if(!ig(t,e))continue;let o;if(i.isOnMainPane)o=(0,a.ensureNotNull)(e.model().paneForSource(r.model().model().mainSeries()));else{const t=new C(e.model(),i.paneIndex);this.undoHistory.pushUndoCommand(t);const s=(0,a.ensureDefined)(t.createdPaneId());o=(0,a.ensureDefined)(e.model().panes().find((e=>e.id()===s)))}const n=await e.pasteSourceFromClip(o,t,!0);if(n&&1===n.length){const t=n[0];if(i.asCompare){const i=(0,a.ensureNotNull)(e.mainSeries().priceScale());e.moveToScale(t,(0,a.ensureDefined)(o),i,s),e.setPriceScaleMode({percentage:!0},i,null)}}e.model().lightUpdate()}}this.undoHistory.endUndoMacro()}setActive(e){if(0!==this._chartWidgetsDefs.length){for(let e=this._chartWidgetsDefs.length;e--;)this._chartWidgetsDefs[e].chartWidget.setActive(!1);this._chartWidgetsDefs[this._activeIndex].chartWidget.setActive(e)}}revertToInline(){if(!this._isPhoneSize.value()||this._viewMode.value()!==re.CollectionViewMode.ForceFullscreen){this._setMaximized(null);for(let e=0;e<this._chartWidgetsDefs.length;e++)this._chartWidgetsDefs[e].rdState.bridge().attach()}}activeChartInterval(){return this._activeChartInterval.readonly()}hasChanges(){return this._hasChanges.readonly()}chartMarketStatuses(){return this._chartWidgetsDefs.map((e=>{{const t=e.chartWidget.hasModel()?e.chartWidget.model().mainSeries().marketStatusModel():null;return null!==t?function(e){const t=e.value();if(null!==t){const e=Me.titleMap.get(t);if(void 0!==e)return e}return""}(t.status()):"-"}}))}chartSeriesStatuses(){return this._chartWidgetsDefs.map((e=>{const t=e.chartWidget.hasModel()?e.chartWidget.model().mainSeries().status():null;return(null===t?"":j.SERIES_STATUS_TEXT[t])+" ("+t+")"}))}applyPreferencesToAllCharts(e){{const t=e.model().preferences()
;this._chartWidgetsDefs.forEach((i=>{i.chartWidget.model()!==e&&i.chartWidget.model().applyPreferences(t)}))}}addCustomSource(e,t,i){(0,a.assert)(!this._customSources.has(e),"Cannot create the same custom source multiple times"),this._customSources.set(e,{factory:t,layer:i});for(let s=0;s<this._chartWidgetsDefs.length;++s){const o=this._chartWidgetsDefs[s].chartWidget;o.hasModel()&&o.model().model().addCustomSource(e,t,i)}}removeCustomSource(e){(0,a.assert)(this._customSources.has(e),"Cannot remove not created custom source"),this._customSources.delete(e);for(let t=0;t<this._chartWidgetsDefs.length;++t){const i=this._chartWidgetsDefs[t].chartWidget;i.hasModel()&&i.model().model().removeCustomSource(e)}}addCustomWidgetToLegend(e,t){(0,a.assert)(!this._customLegendWidgetsFactoriesMap.has(e),"Cannot create the same custom widget in legend multiple times"),this._customLegendWidgetsFactoriesMap.set(e,t);for(let i=0;i<this._chartWidgetsDefs.length;++i)this._chartWidgetsDefs[i].chartWidget.addCustomWidgetToLegend(e,t)}addReplayWidget(e){(0,a.assert)(null===this._replayContainer,"Cannot create replay container multiple times"),this._replayContainer=document.createElement("div"),this._replayContainer.style.position="absolute",this._replayContainer.style.minHeight="49px",this._replayContainer.style.overflow="hidden",this._replayContainer.style.left="0px",this._replayContainer.style.right="0px";const t=this._bottomToolbar.value()?.offsetHeight??0;this._replayContainer.style.bottom=`${t}px`,this._replayContainer.setAttribute("data-is-chart-toolbar-component","true"),this._parent.prepend(this._replayContainer);e(this._replayContainer,(()=>this._updateLayout())),this._updateLayout()}destroyReplayWidget(){(0,a.assert)(null!==this._replayContainer,"Cannot remove replay container, container is not created"),this._replayContainer.remove(),this._replayContainer=null,this._updateLayout()}setViewMode(e){this._viewMode.setValue(e)}moveActiveChartWithUndo(e){const t=this._chartWidgetsDefs[this._activeIndex],i=this._getVisuallyAdjacentDef(t,e);i&&this.undoHistory.pushUndoCommand(new ae(this._swapCharts.bind(this),t.chartWidget,i.chartWidget))}activeChartCanBeMoved(){return this._activeChartCanBeMoved.readonly()}generalPropertiesDefinitions(){return this.activeChartWidget.value().generalPropertiesDefinitions()}reconnectChartApi(e){!function(e){const t=window.ChartApiInstance;window.is_authenticated&&(t.disconnect(),e&&t.authTokenManager().reset(),setTimeout((()=>t.connect()),500))}(e)}setBroker(e){$m?.(this._stateImpl(),e)}setSaveChartService(e){this._saveChartService=e,this._hasChangesSpawn?.destroy(),this._hasChangesSpawn=e.hasChangesWV().spawn(),this._hasChangesSpawn.subscribe((e=>this._hasChanges.setValue(e)),{callWithLast:!0});for(let t=0;t<this._chartWidgetsDefs.length;++t){this._chartWidgetsDefs[t].chartWidget.setSaveChartService(e)}}getCompareDialogRenderer(){return this._compareDialogRenderer}getChartPropertiesDialogRenderer(){return this._chartPropertiesDialogRenderer}chartsSymbols(){return Wm(this._stateImpl())}
resetLayoutSizes(e){const t=this._layoutTemplate.value().layoutType,i=this._layoutTemplate.value().expression,s=(0,rt.layoutInitialSizingState)(i),o=e=>e?this._allLayoutSizesState.set(t,e):this._allLayoutSizesState.delete(t);if(e)return this._sizingState.setValue(s),void o(s);this.undoHistory.beginUndoMacro(Rm),this.undoHistory.pushUndoCommand(new y(this._sizingState,this._sizingState.value(),s,Rm)),this.undoHistory.pushUndoCommand(new b(o,this._allLayoutSizesState.get(t),s,Rm)),this.undoHistory.endUndoMacro()}setLayoutSizes(e,t,i=Bm){}unloadUnusedCharts(){const e=this._chartWidgetsDefs.splice(M.layouts[this._layoutType].count);for(const t of e)t.destroy();this._updateLinkingGroupCharts()}layoutSizesChanged(){return this._layoutSizesChangedWV.readonly()}ariaDescribeChart(e){0}chartModels(){return this._chartModels.readonly()}symbolAliasService(){return this._symbolAliasService}replaySessionState(){return this._replaySessionState}updateReplaySessionState(e){(0,r.default)(this._replaySessionState,e)||(this._replaySessionState=e,this._saveChartService?.markContentAsChanged())}subscribeChartStorageNotification(e){this._chartStorageNotification?.subscribeOnChanges(e)}unsubscribeChartStorageNotification(e){this._chartStorageNotification?.unsubscribeOnChanges(e)}setChartFloatingTooltipVisible(e){this._chartFloatingTooltipVisible.setValue(e)}chartFloatingTooltipVisible(){return this._chartFloatingTooltipVisible.readonly()}_stateImpl(){return{undoHistory:this.undoHistory,chartWidgetsDefs:this._chartWidgetsDefs,actualLayoutCount:this._actualLayoutCount.bind(this),savedChartWidgetOptions:this._savedChartWidgetOptions,activeChartWidget:this.activeChartWidget,options:this._options,parent:this._parent,setChartStorageNotificationSubscription:e=>{this._chartStorageNotification=e},maximizedChartDef:this._maximizedChartDef,setMaximized:this._setMaximized.bind(this),layoutTemplate:this._layoutTemplate,widthWV:this._widthWV,heightWV:this._heightWV,checkProFeature:this._checkProFeature.bind(this),lineToolsSynchronizerHasChanges:this._lineToolsSynchronizerHasChanges,recalcHasChanges:this._recalcHasChanges.bind(this),onZoom:this._onZoom,onScroll:this._onScroll,layoutType:this._layoutType,layoutWV:this._layoutWV,isPhoneSize:this._isPhoneSize,viewMode:this._viewMode,updateViewMode:this._updateViewMode.bind(this),loadingContent:this._loadingContent,initialLoading:this._initialLoading,inlineChartsCount:this._inlineChartsCount,updateWatchedValue:this._updateWatchedValue.bind(this),checkAllPendingModelsAlreadyCreated:this._checkAllPendingModelsAlreadyCreated.bind(this),readOnly:this._readOnly,symbolLock:this._symbolLock,internalSymbolLock:this._internalSymbolLock,intervalLock:this._intervalLock,internalIntervalLock:this._internalIntervalLock,dateRangeLock:this._dateRangeLock,internalDateRangeLock:this._internalDateRangeLock,trackTimeLock:this._trackTimeLock,internalTrackTimeLock:this._internalTrackTimeLock,crosshairLock:this._crosshairLock,customLegendWidgetsFactoriesMap:this._customLegendWidgetsFactoriesMap,
globalDetachable:this._globalDetachable,saveChartService:this._saveChartService,customSources:this._customSources,updateActivityView:this._updateActivityView.bind(this),sizingState:this._sizingState,currentLayoutResizeAction:this._currentLayoutResizeAction,allLayoutSizesState:this._allLayoutSizesState,splitters:this._splitters,widgetOptions:this._widgetOptions,bottomToolbar:this._bottomToolbar,replayContainer:this._replayContainer,layoutSizesChanged:this._layoutSizesChangedWV,flags:this._flags,chartModels:this._chartModels,hideChart:this._hideChart.bind(this),addNewChartWidget:this._addNewChartWidget.bind(this)}}_createClipboardHandler(){return new om({copyRequested:(e,t)=>{this.activeChartWidget.value().model().clipboardCopy(e,t).catch((e=>{const t=tg(e)??Cm.format({keystroke:(0,O.humanReadableHash)(B.Modifiers.Mod+67)});(0,le.showChartWarningNotification)("copy",{title:Tm,text:t})}))},cutRequested:(e,t)=>{this.activeChartWidget.value().model().clipboardCut(e,t).catch((e=>{const t=tg(e)??Cm.format({keystroke:(0,O.humanReadableHash)(B.Modifiers.Mod+88)});(0,le.showChartWarningNotification)("cut",{title:Pm,text:t})}))},pasteRequested:(e,t)=>{if(t?.mode()===K.PaneMode.Widget)return;(t?t.model().undoModel():this.activeChartWidget.value().model()).clipboardPaste(e,t).catch((e=>{const t=tg(e)??Cm.format({keystroke:(0,O.humanReadableHash)(B.Modifiers.Mod+86)});(0,le.showChartWarningNotification)("paste",{title:Mm,text:t})}))}})}_handleInternalSymbolLockChange(e){this._symbolLock.setValue(e)}_handleSymbolLockChange(e){if(e!==this._internalSymbolLock.value())if(this._loadingContent)this._internalSymbolLock.setValue(e);else{if(this.undoHistory.beginUndoMacro(Am),e){const e=this.activeChartWidget.value(),t=this._chartWidgetsDefs.map((e=>e.chartWidget));this._linkingGroupsCharts.forEach(((i,s)=>{const o=e.linkingGroupIndex().value()===s?e:t.find((e=>e.linkingGroupIndex().value()===s));if(void 0!==o){(0,u.muteLinkingGroup)(s,!0);for(const e of i.value())e!==o&&e.symbolWV().value()!==o.symbolWV().value()&&(e.setSymbol(o.symbolWV().value()),this._dateRangeLock.value()&&this._subscribeToCompletedEventForDateRangeSync(e,!0));(0,u.muteLinkingGroup)(s,!1)}}))}this.undoHistory.setWatchedValue(this._internalSymbolLock,e,Am),this.undoHistory.endUndoMacro()}}_handleInternalIntervalLockChange(e){this._intervalLock.setValue(e)}_handleIntervalLockChange(e){if(e!==this._internalIntervalLock.value())if(this._loadingContent)this._internalIntervalLock.setValue(e);else{if(this.undoHistory.beginUndoMacro(km),e&&e){const e=this.activeChartWidget.value(),t=this._chartWidgetsDefs.map((e=>e.chartWidget));this._linkingGroupsCharts.forEach(((i,s)=>{const o=e.linkingGroupIndex().value()===s?e:t.find((e=>e.linkingGroupIndex().value()===s));if(void 0!==o){(0,u.muteLinkingGroup)(s,!0);for(const e of i.value())e!==o&&e.resolutionWV().value()!==o.resolutionWV().value()&&(e.setResolution(o.resolutionWV().value()),this._dateRangeLock.value()&&this._subscribeToCompletedEventForDateRangeSync(e,!0));(0,u.muteLinkingGroup)(s,!1)}}))}
this.undoHistory.setWatchedValue(this._internalIntervalLock,e,km),this.undoHistory.endUndoMacro()}}_handleInternalDateRangeLockChange(e){const t=this.activeChartWidget.value();if(t&&t.hasModel()){const i=t.model();e?(this._subscribeToEventsForDateRangeSync(i),this._syncChartsDateRangesWithActiveChartRange(t)):this._unsubscribeFromEventsForDateRangeSync(i)}this._dateRangeLock.setValue(e)}_handleDateRangeLockChange(e){this._loadingContent?this._internalDateRangeLock.setValue(e):this.undoHistory.setWatchedValue(this._internalDateRangeLock,e,Em)}_handleInternalTrackTimeLockChange(e){this._trackTimeLock.setValue(e)}_handleTrackTimeLockChange(e){this._loadingContent?this._internalTrackTimeLock.setValue(e):this.undoHistory.setWatchedValue(this._internalTrackTimeLock,e,Dm)}_subscribeToEventsForDateRangeSync(e){e.timeScale().visibleBarsStrictRangeChanged().subscribe(this._getSubscriptionObjectForChartModel(e),(()=>{this._activeChartLogicalRangeChanged()}))}_unsubscribeFromEventsForDateRangeSync(e){e.timeScale().visibleBarsStrictRangeChanged().unsubscribeAll(this._getSubscriptionObjectForChartModel(e)),jm.forEach((e=>{const t=e.cw,i=e.callback;t.model().mainSeries().dataEvents().completed().unsubscribe(null,i)})),jm.clear()}_activeChartLogicalRangeChanged(){this._syncChartsDateRangesWithActiveChartRange()}_getSubscriptionObjectForChartModel(e){const t=qm.get(e.id())??{};return qm.set(e.id(),t),t}_setExternalPosition(e,t,i){const s=this._actualLayoutCount();return this._chartWidgetsDefs.slice(0,s).filter((e=>e.rdState.bridge().visible.value())).map((e=>e.chartWidget)).filter((e=>e.id()!==t&&(!!e.hasModel()&&(e.selectPointMode().value()===D.SelectPointMode.Replay&&"AllCharts"===me.value()||this._crosshairLock.value())))).forEach((t=>t.model().model().setExternalPosition(e,i))),!0}_createBroadcastChannel(){const e=new BroadcastChannel("ChartWidgetsCollection");return e.onmessage=e=>{const t=e.data;if(this._crossHairSyncBroadcast&&"crosshair"===t.type)this._crossHairSyncBroadcast.uniqueId!==t.payload.sourceUniqueId&&this._setExternalPosition(t.payload.point,null,t.payload.envState)},{channel:e,uniqueId:(0,ot.randomHashN)(6)}}_destroyBroadcastChannel(){this._crossHairSyncBroadcast?.channel.close()}async _createChartWidgetCollectionNewsNotifier(){if(this._widgetOptions.newsNotificationsEnabled){return new((await i.e(4855).then(i.bind(i,391097))).ChartWidgetCollectionNewsNotifier)(this)}return null}async _createSeriesControlWidget(){const e="0px",t=document.createElement("div");this._bottomToolbar.setValue(t),t.style.left=e,t.style.right=e,t.style.bottom=e,t.classList.add("chart-toolbar","chart-controls-bar"),t.setAttribute("data-is-chart-toolbar-component","true"),this._parent.appendChild(t);const{BottomToolbarRenderer:s}=await Promise.all([i.e(91177),i.e(57032),i.e(1967),i.e(63665),i.e(75828),i.e(24977),i.e(74528),i.e(18257),i.e(60627),i.e(75649),i.e(31403),i.e(93807),i.e(497),i.e(44591),i.e(24025),i.e(57435),i.e(50019),i.e(49892),i.e(32387),i.e(55381)]).then(i.bind(i,412405));if(this._destroyed)return
;const o=this._options.resizerBridge,r=[o.container.spawn(),o.width.spawn(),o.height.spawn()],n=o.container.value(),l=new g.Delegate,c=()=>{l.fire()};r.forEach((e=>{e.subscribe(c)}));this._bottomToolbarWidget=new s((0,a.ensureNotNull)(this._bottomToolbar.value()),l,(()=>{const e=n.getBoundingClientRect(),t=this._computeContentBox();return t.top=e.top+t.top,t.left=e.left+t.left,t}),this,window.ChartApiInstance,this._widgetOptions,this._options.seriesControlBar),this._bottomToolbarDestroyer=()=>{null!==this._bottomToolbarWidget&&(this._bottomToolbarWidget.destroy(),this._bottomToolbarWidget=null,this._bottomToolbar.setValue(null)),r.forEach((e=>{e.destroy()})),l.destroy(),window.ChartApiInstance.connectionsLimitReached().unsubscribe(Hm)}}_checkProFeature(e){if("s"===e||this._widgetOptions.containsData||this._readOnly||(0,Ae.enabled)("MULTIPLE_CHARTS")&&(0,a.ensure)((0,Ae.getConfig)("MULTIPLE_CHARTS")?.limit)>=M.layouts[e].count)return e;let t="s";{let i=1;const s=(0,Ae.getConfig)("MULTIPLE_CHARTS")?.limit??0;for(const e of Object.keys(M.layouts)){const o=M.layouts[e].count;o<=s&&o>i&&(t=e,i=o)}this._allInitialModelsCreated().then(Qm).then((()=>{(0,Le.trackGoProFeature)("multipleCharts"),(0,Ee.openPaywall)({feature:"multipleCharts",limit:M.layouts[e].count})}))}return t}_allInitialModelsCreated(){return this._chartWidgetsDefs.every((e=>e.chartWidget.hasModel()))?Promise.resolve(this._chartWidgetsDefs.map((e=>e.chartWidget))):Promise.all(this._chartWidgetsDefs.map((e=>e.chartWidget.hasModel()||U(e.chartWidget.modelCreated()).promise))).then((()=>this._allInitialModelsCreated()))}_actualLayoutCount(){return M.layouts[this._layoutType].count}_setMaximized(e){this._maximizedChartDef.value()!==e&&this._maximizedChartDef.setValue(e)}_updateViewMode(){"s"===this._layoutType||this._maximizedChartDef.value()?this._viewMode.setValue(re.CollectionViewMode.ForceFullscreen):this._viewMode.setValue(re.CollectionViewMode.Multichart)}_updateWatchedValue(){const e=Math.min(this._layoutTemplate.value().count,this._chartWidgetsDefs.length)-1;if(e<0)return void this.activeChartWidget.deleteValue();const t=Math.min(Math.max(0,this._activeIndex),e);this.activeChartWidget.setValue(this._chartWidgetsDefs[t].chartWidget)}_checkAllPendingModelsAlreadyCreated(){this._chartWidgetsDefs.every((e=>e.chartWidget.hasModel()))&&(this._updateWatchedValue(),N.emit("layout_changed"))}_updateActivityView(){for(let e=this._chartWidgetsDefs.length;e--;){const t=e===this._activeIndex;this._chartWidgetsDefs[e].container.value().classList.toggle("active",t),this._chartWidgetsDefs[e].container.value().classList.toggle("inactive",!t)}}_isDetached(e){return e.rdState.owner.value()!==e}_getVisuallyAdjacentDef(e,t){return Fm(this._stateImpl(),e,t)}_swapCharts(e,t){const i=this._chartWidgetsDefs.findIndex((t=>t.chartWidget===e)),s=this._chartWidgetsDefs.findIndex((e=>e.chartWidget===t));if(-1===i||-1===s)throw new Error("chart is not in the layout");const o=this._chartWidgetsDefs[i],r=this._chartWidgetsDefs[s];this._chartWidgetsDefs[i]=r,this._chartWidgetsDefs[s]=o,
this._activeIndex===i?this._activeIndex=s:this._activeIndex===s&&(this._activeIndex=i),this._updateLayout(),this._chartsSwappedDelegate.fire()}_subscribeToProperties(e){if(this._subscribedChartWidget!==e){if(this._subscribedChartWidget&&(this._subscribedChartWidget.modelCreated().unsubscribe(null,this._onmodel),this._subscribedChartWidget.hasModel())){const e=this._subscribedChartWidget.model();this._dateRangeLock.value()&&this._unsubscribeFromEventsForDateRangeSync(e);e.mainSeries().properties().childs().style.unsubscribe(this,this._onstyle);e.model().onSelectedSourceChanged().unsubscribe(this,this._onselectedsource),this._subscribedChartWidget=null}e&&(this._subscribedChartWidget=e,e.hasModel()?this._onmodel(e.model()):e.modelCreated().subscribe(this,this._onmodel))}}_onmodel(e){const t=e.mainSeries().properties().childs();t.style.subscribe(this,this._onstyle),this._onstyle(t.style);e.model().onSelectedSourceChanged().subscribe(this,this._onselectedsource),this._dateRangeLock.value()&&(this._subscribeToEventsForDateRangeSync(e),this._syncChartsDateRangesWithActiveChartRange()),this._onselectedsource()}_onstyle(e){this.activeChartStyle.setValue(e.value())}_onselectedsource(){const e=(0,a.ensureNotNull)(this._subscribedChartWidget).model();this._selectedSources.setValue(e.selection().allSources().slice())}_onToolChanged(){this._chartWidgetsDefs.forEach((e=>{e.chartWidget.onToolChanged()}))}_updateCrossHairPositionIfNeeded(){const e=this.activeChartWidget.value();this._chartWidgetsDefs.forEach((t=>{t.chartWidget!==e&&this._crosshairLock.value()&&t.chartWidget.updateCrossHairPositionIfNeeded()})),e&&e.updateCrossHairPositionIfNeeded()}async _setSymbolImpl(e,t,i,s){const o=i??this.activeChartWidget.value();void 0===t&&(t=o.linkingGroupIndex().value()),s=s??(this._symbolLock.value()?this._chartWidgetsDefs.map((e=>e.chartWidget)):[o]),this._pendingSetSymbolCancellationToken.cancelled=!0;const r=this._pendingSetSymbolCancellationToken={cancelled:!1},n=()=>{for(const i of s)(i.hasModel()?i.model().mainSeries().symbolSameAsResolved(e):i.symbolWV().value()===e)||void 0!==t&&i.linkingGroupIndex().value()!==t||i.setSymbol(e)};{const t=s.filter((e=>e.hasModel()&&e.model().isInReplay().value()));if(t.length){const i=await Promise.all(t.map((t=>t.model().canChangeSymbol(e))));if(r.cancelled)return!1;const s=i.find((e=>!e.result));if(s){if(1!==s.reason)return!1;const e=this._flags;return!e.isConfirmationAboutReplayLocked&&new Promise((i=>{(0,V.showConfirm)({text:xm,onConfirm:s=>{r.cancelled?i(!1):(e.isConfirmationAboutReplayLocked=!0,t.forEach((e=>e.model().switchToRealtime())),n(),e.isConfirmationAboutReplayLocked=!1,i(!0),s.dialogClose())},onClose:()=>i(!1),onCancel:e=>{e.dialogClose()}})}))}}}return n(),!0}_alreadyHasId(e){return this._chartWidgetsDefs.some((t=>t.chartWidget?.id()===e))}_getCopiedChartStateAsWidgetContent(){const e=this.activeChartWidget.value();if(e){const t=e.state({skipNonSharedLineTools:!0});return t.chartId=zm((e=>this._alreadyHasId(e))),t.shouldBeSavedEvenIfHidden=!1,t.panes.forEach((e=>{
e.sources.forEach((e=>{(0,q.isLineToolState)(e)&&!e.linkKey&&(e.alertId=void 0)}))})),{content:t}}}_onIdeaClickedHandler(e){(0,Ie.openPublicationViewPopup)(e)}_barsMarksContainersFactory(e){const t=[];if(this._options.publishedChartsEnabled){const i=new xe.PublishedChartsTimeline(e,(e=>this._onIdeaClickedHandler(e)));t.push(i)}return t}_getLinkingGroupCharts(e){let t=this._linkingGroupsCharts.get(e);return void 0===t&&(t=new z.WatchedObject([],J.compareTwoCollectionsByIds),this._linkingGroupsCharts.set(e,t)),t}_getActiveLinkingGroupWV(){const e=this.activeChartWidget,t=new H.WatchedValue(null),i=()=>{t.setValue(e.value().linkingGroupIndex().value())};e.value()&&i();const s=e.spawn();let o;return s.subscribe((e=>{o?.destroy(),o=e.linkingGroupIndex().spawn(),o.subscribe(i),i()})),t.spawn((()=>{s.destroy(),o?.destroy()}))}_getAllLinkingGroupsWV(){const e=new z.WatchedObject(this._getAllLinkingGroups()),t=()=>{e.setValue(this._getAllLinkingGroups())};this._chartWidgetsDefs.forEach((e=>e.chartWidget.linkingGroupIndex().subscribe(t)));const i=e=>{e.linkingGroupIndex().subscribe(t),t()};return this._chartWidgetCreatedDelegate.subscribe(null,i),e.spawn((()=>{this._chartWidgetsDefs.forEach((e=>e.chartWidget.linkingGroupIndex().unsubscribe(t))),this._chartWidgetCreatedDelegate.unsubscribe(null,i)}))}_getAllLinkingGroups(){const e=new Set(this._chartWidgetsDefs.map((e=>e.chartWidget.linkingGroupIndex().value())));return Array.from(e).sort(((e,t)=>(e??-1)-(t??-1)))}_computeContentBox(){const{border:e=0,edge:t=0}=this._options,i=t+e,s=this._bottomToolbar.value()?.offsetHeight??0,o=this._replayContainer?.offsetHeight??0;return{width:this._widthWV.value()-2*i,height:this._heightWV.value()-s-o-i,top:0,left:i}}_updateLayoutPartial(e,t,i,s=this._layoutTemplate.value()){const o=this._computeContentBox(),{padding:r=2,border:n=0}=this._options,a=s.sizer(o,t,i,r+n,this._sizingState.value());a.width=Math.max(Math.round(a.width),0),a.height=Math.max(Math.round(a.height),0),a.top=Math.round(a.top),a.left=Math.round(a.left),e.metrics=a;const l=e.container.value();if(l){l.style.width=a.width+"px",l.style.height=a.height+"px",l.style.top=a.top+"px",l.style.left=a.left+"px";const e=1===i;l.classList.toggle("single-visible",e);const t=Math.round(o.width),s=0===a.top&&0===a.left,r=0===a.top&&a.left+a.width===t,n=0===a.top&&a.width===t;l.classList.toggle("top-left-chart",!e&&!n&&s),l.classList.toggle("top-right-chart",!e&&!n&&r),l.classList.toggle("top-full-width-chart",e||n)}e.width.setValue(a.width),e.height.setValue(a.height)}_setInitialSizes(e){let t=0,i=0;const s=this._layoutTemplate.value();for(let o=0;o<s.count;o++){this._chartWidgetsDefs[o]===e&&(i=t),t++}this._updateLayoutPartial(e,i,t,s)}_createChartWidget(e){let t={chartWidgetCollection:this,isActive:0===this._chartWidgetsDefs.length,barsMarksContainersFactory:e=>this._barsMarksContainersFactory(e),undoHistory:this.undoHistory,readOnly:this._readOnly,initialLoading:this._initialLoading,...e??{}}
;void 0!==this._customLegendWidgetsFactoriesMap&&(t.customLegendWidgetFactories=new Map(this._customLegendWidgetsFactoriesMap));const i=document.createElement("div");i.classList.add("chart-container"),i.style.position="absolute",i.style.overflow="hidden",this._parent.insertBefore(i,this._bottomToolbar.value()),_.isEdge&&(i.style.touchAction="none",i.style.msTouchAction="none"),t.className&&i.classList.add(t.className);const s={alive:new H.WatchedValue(!0),container:new H.WatchedValue(i),width:new H.WatchedValue,height:new H.WatchedValue,collapsed:new H.WatchedValue(!1),hiddenInLayout:new H.WatchedValue(!1),visible:new H.WatchedValue,rdState:new p.ResizerDetacherState,requestFullscreen:()=>{this._globalDetachable.value()&&(this._setMaximized(s),this.activeChartWidget.setValue((0,a.ensureNotNull)(s.chartWidget)))},exitFullscreen:()=>{this.activeChartWidget.value()===s.chartWidget&&this._setMaximized(null)},detachable:this._globalDetachable,fullscreenable:this._globalDetachable,fullscreen:new H.WatchedValue(!1),chartWidget:null};s.rdState.pushOwner(s);const o=()=>{s.chartWidget.isActive()&&this._updateActiveChartCanBeMoved()};s.rdState.owner.subscribe(o),this._chartWidgetsDefs.push(s);const r=()=>{(0,a.ensureNotNull)(s.chartWidget).setVisible(!s.hiddenInLayout.value()),l()},n=e=>{(0,a.ensureNotNull)(s.chartWidget).setCollapsed(e)},l=()=>{s.visible.setValue(!s.hiddenInLayout.value()&&this._options.resizerBridge.visible.value())};s.hiddenInLayout.subscribe(r),s.collapsed.subscribe(n),this._options.resizerBridge.visible.subscribe(l),l(),this._setInitialSizes(s),t={...t,...s.rdState.bridge()};const c=t.content?(0,a.ensureDefined)(t.content.chartId):zm((e=>this._alreadyHasId(e))),h=s.chartWidget=new Kp(t,c);this._saveChartService&&h.setSaveChartService(this._saveChartService),this._readOnly||(s.timingsMeter=new Pe(String(this._chartWidgetsDefs.length-1)),h.setTimingsMeter(s.timingsMeter)),t.containsData?h.finishInitWithoutConnect():h.connect();const d=()=>{s.chartWidget.isActive()&&this._updateActiveChartInterval()},u=()=>{this._checkForLineToolsSplitsAdjustment(s.chartWidget)};h.withModel(null,(()=>{const e=h.model().model();this._customSources.forEach(((t,i)=>{e.addCustomSource(i,t.factory,t.layer)})),e.mainSeries().intervalObj().subscribe(d,{callWithLast:!0}),e.mainSeries().lastSplits().subscribe(u)})),this._updateWatchedValue(),this._updateActivityView();const m=t?.content?.linkingGroup??null;h.linkingGroupIndex().setValue(m),h.linkingGroupIndex().subscribe(this._updateLinkingGroupCharts);const g=this._getLinkingGroupCharts(m).value();return g.length>0&&(this._symbolLock.value()&&h.setSymbol(g[0].symbolWV().value()),this._intervalLock.value()&&h.setResolution(g[0].resolutionWV().value())),this._updateLinkingGroupCharts(),h.onZoom().subscribe(this,(e=>this._onZoom.fire(e))),h.onScroll().subscribe(this,(()=>this._onScroll.fire())),h.withModel(null,(()=>{h.lineToolsSynchronizer()?.hasChanges().subscribe(this._recalcHasChanges,{callWithLast:!0})})),s.destroy=()=>{if(s.rdState.owner.unsubscribe(o),
s.hiddenInLayout.unsubscribe(r),s.collapsed.unsubscribe(n),this._options.resizerBridge.visible.unsubscribe(l),h.linkingGroupIndex().unsubscribe(this._updateLinkingGroupCharts),h.onZoom().unsubscribeAll(this),h.onScroll().unsubscribeAll(this),h.lineToolsSynchronizer()?.hasChanges().unsubscribe(this._recalcHasChanges),s.timingsMeter?.destroy(),s.rdState.destroy(),h.destroy(),h.hasModel()){const e=h.model().mainSeries();e.intervalObj().unsubscribe(d),e.lastSplits().unsubscribe(u)}},this._chartWidgetCreatedDelegate.fire(h),s}_addNewChartWidget(e,t){let i,s=this._savedChartWidgetOptions.shift();if(void 0!==s){const e=this.activeChartWidget.value();e&&e.lineToolsSynchronizer()&&(i=e.lineToolsAndGroupsDTO())}else s=this._getCopiedChartStateAsWidgetContent();const o={...this._widgetOptions,...s,...0===e||this._symbolLock.value()?void 0:{defSymbol:null}},r=this._createChartWidget(o),{chartWidget:n}=r;return n.modelCreated().subscribe(null,(()=>{t?t():this._checkAllPendingModelsAlreadyCreated(),this._dateRangeLock.value()&&n===this.activeChartWidget.value()&&this._subscribeToCompletedEventForDateRangeSync(n,!0);const e=n.lineToolsSynchronizer();void 0!==i&&e&&[...i.entries()].map((([t,i])=>{0!==t&&e.applyDTO(i,t).then((()=>{e.invalidateAll(!0)}))}));let s=!1;const o=()=>{const e=this._chartWidgetsDefs.filter((e=>(e.chartWidget!==n||!s)&&e.chartWidget.hasModel())).map((e=>e.chartWidget.model()));this._chartModels.setValue(e)};o(),n.onAboutToBeDestroyed().subscribe(null,(()=>{s=!0,o()}))}),!0),r}_subscribeToCompletedEventForDateRangeSync(e,t){const i=e.id();if(jm.has(i))return;const s=()=>{jm.has(i)&&(jm.delete(i),this._syncChartsDateRangesWithActiveChartRange(t?e:void 0))};e.model().mainSeries().dataEvents().completed().subscribe(null,s,!0),jm.set(i,{cw:e,callback:s})}_syncChartsDateRangesWithActiveChartRange(e){if(!this._dateRangeLock.value()||null!==this._currentLayoutResizeAction.value())return;const t=this.activeChartWidget.value(),i=t.model().mainSeries();if(!(0,Q.isTimeBasedStyle)(i.style()))return;const s=t.model().timeScale(),o=s.visibleBarsStrictRange();if(null===o)return;const r=(0,a.ensureNotNull)(s.points().range().value());let n=s.indexToTimePoint(o.firstBar());null===n&&i.endOfData()&&(n=s.indexToTimePoint(r.firstIndex));let l=s.indexToTimePoint(o.lastBar());if(null===l&&(l=s.indexToTimePoint(r.lastIndex)),null===n||null===l)return void this._subscribeToCompletedEventForDateRangeSync(t,!1);jm.delete(t.id());let h=1e3*n,d=1e3*l;if(i.isDWM()){const e=new Date(h),t=new Date(d);(0,c.set_hms)(e,0,0,0,0),(0,c.set_hms)(t,0,0,0,0),h=e.getTime(),d=t.getTime()}for(let i=0;i<this._chartWidgetsDefs.length;i++){const s=this._chartWidgetsDefs[i].chartWidget;s.hasModel()&&s!==t&&(void 0===e||s===e)&&(0,Q.isTimeBasedStyle)(s.model().mainSeries().style())&&setTimeout(this._chartWidgetGotoTimeRange.bind(null,s,h,d))}}_chartWidgetGotoTimeRange(e,t,i){e.model().model().gotoTimeRange(t,i).catch((()=>{})),N.emit("sync_date_range",t,i)}_hideChart(e){e.hiddenInLayout.setValue(!0);const t=e.container.value()
;t.parentNode&&t.parentNode.removeChild(t)}_updateChartsVisibility(){const{count:e}=this._layoutTemplate.value(),t=this._maximizedChartDef.value();this._chartWidgetsDefs.forEach(((i,s)=>{(t?t===i:s<e)?(this._parent.insertBefore(i.container.value(),this._bottomToolbar.value()),i.hiddenInLayout.setValue(!1)):this._hideChart(i)}))}_updateInlineChartsCount(){const{count:e}=this._layoutTemplate.value();this._inlineChartsCount.setValue(e),this._globalDetachable.setValue(e>1)}_getStateForChartImpl(e,t,i,s,o,r){if(e<this._chartWidgetsDefs.length){const n=this._chartWidgetsDefs[e].chartWidget;return e<this._actualLayoutCount()||n.shouldBeSavedEvenIfHidden()?n.state({withData:t,skipLineToolsFromOtherSymbols:i,wipeSensitiveData:s,skipLineTools:o,skipHiddenSources:r}):null}const n=this._savedChartWidgetOptions[e-this._chartWidgetsDefs.length].content;return o?(a=n,{...a,panes:(l=a.panes,l.map((e=>{return{...e,sources:(t=e.sources,t.filter((e=>!(0,se.isLineToolName)(e.type))))};var t})))}):n;var a,l}_chartsCountToSave(){return this._chartWidgetsDefs.length+this._savedChartWidgetOptions.length}_updateActiveChartInterval(){const e=this.activeChartWidget.value();e?.hasModel()&&this._activeChartInterval.setValue(e.model().mainSeries().intervalObj().value())}_createCombineTrackTimeLock(){return(0,F.combine)(((e,t)=>e||t),this._trackTimeLock.weakReference(),this._someOfWidgetsAreInSelectingReplayPointMode(this._layoutWV,this._chartWidgetsDefs).ownership())}_someOfWidgetsAreInSelectingReplayPointMode(e,t){let i=[];const s={},o=()=>{i.forEach((e=>e.unsubscribe(a))),i=t.filter((e=>e.chartWidget.hasModel())).map((e=>e.chartWidget.selectPointMode())),i.forEach((e=>e.subscribe(a))),t.forEach((e=>{e.chartWidget.hasModel()||e.chartWidget.withModel(s,(()=>{o(),a()}))}))};o();const r=()=>i.some((e=>e.value()===D.SelectPointMode.Replay))&&"AllCharts"===me.value(),n=new H.WatchedValue(r()),a=()=>n.setValue(r()),l=()=>{o(),a()};e.subscribe(l),me.subscribe(n,a);return n.spawn((()=>{me.unsubscribe(n,a),e.unsubscribe(l),i.forEach((e=>e.subscribe(a)))}))}_getChartWidgetsForIntervalLock(){return(this._intervalLock.value()?this._chartWidgetsDefs.map((e=>e.chartWidget)):[this.activeChartWidget.value()]).filter((e=>e.hasModel()))}_applyResolution(e,t,i=this.activeChartWidget.value()){const s=this._flags;if((0,T.setLastUsedResolution)(e),s.setNewResolution=!0,void 0===t&&(t=i.linkingGroupIndex().value()),this._intervalLock.value())for(const i of this._chartWidgetsDefs){const s=i.chartWidget;s.resolutionWV().value()===e||void 0!==t&&s.linkingGroupIndex().value()!==t||s.setResolution(e)}else i.setResolution(e);s.setNewResolution=!1}async _checkForLineToolsSplitsAdjustment(e){if(!this._widgetOptions.onWidget){if(!this._lineToolsSplitAdjuster){
const{LineToolsSplitAdjuster:e}=await Promise.all([i.e(30070),i.e(64116),i.e(98115),i.e(57032),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(5709),i.e(74528),i.e(15365),i.e(18257),i.e(48011),i.e(44589),i.e(75649),i.e(26729),i.e(25947),i.e(49515),i.e(11644),i.e(78399),i.e(69631),i.e(41819),i.e(85294),i.e(32387),i.e(80915),i.e(21776),i.e(99331),i.e(66277),i.e(5553),i.e(45661),i.e(17633)]).then(i.bind(i,696545));this._lineToolsSplitAdjuster=new e(this.undoHistory)}return this._lineToolsSplitAdjuster.checkForLineToolsSplitsAdjustment(e)}}_clearSplitters(e=0){const t=this._splitters.value();t.splice(e).forEach((e=>{e.splitterElement.remove(),e.mouseListener.destroy(),e.mouseHandler.destroy()})),this._splitters.setValue([...t])}_recalculateMaximizedChartDef(){let e=null;if(this._isPhoneSize.value()&&this._viewMode.value()===re.CollectionViewMode.ForceFullscreen){const t=this._maximizedChartDef.value();if(t){const i=this._chartWidgetsDefs.indexOf(t);e=i<0||i>=this._layoutTemplate.value().count?this._chartWidgetsDefs[0]:t}else e=this._chartWidgetsDefs[0]}this._maximizedChartDef.setValue(e)}_validateLayoutSizes(e){}_validateLayoutSizesState(e,t){}_validateLayoutSizesStateRecursive(e,t,i,s){}}},176359:(e,t,i)=>{"use strict";i.d(t,{clientSnapshot:()=>P,widgetClientSnapshot:()=>x});var s=i(425860),o=i(185842),r=i(657415),n=i(955482),a=(i(266150),i(645303)),l=i(188485),c=i(320093),h=i(880753),d=i(26878),u=i(64906),_=i(539403),p=i(124e3);const m=Boolean(window.initData?.logo?.no_powered_by);function g(e,t=null,i=null){let s={};if("number"==typeof e)return{relativePositions:{[e]:{l:t,t:i}},nextElementLeft:e,nextElementTop:e};const[o,...r]=e;if("v"===o){let e=null;for(const o of r){const r=g(o,t,i);s={...s,...r.relativePositions},i=r.nextElementTop,e=r.nextElementLeft}t=e}if("h"===o){let e=null;for(const o of r){const r=g(o,t,i);s={...s,...r.relativePositions},t=r.nextElementLeft,e=r.nextElementTop}i=e}return{relativePositions:s,nextElementTop:i,nextElementLeft:t}}const S=function(e){const t={};for(const i of Object.keys(e)){const s=g(e[i]).relativePositions;t[i]=s}return t}(_);function v(e,t,i,s){let o=Math.round(10*s),r=Math.round(10*s);const n=i[e];if(null!==n.l){const e=v(n.l,t,i,s);o=e.x+e.width+Math.round(5*s)}if(null!==n.t){const e=v(n.t,t,i,s);r=e.y+e.height+Math.round(5*s)}const a=t[e];return{x:o,y:r,width:a.width,height:a.height}}function f(e,t,i){const s=(new DOMParser).parseFromString(p,"image/svg+xml");s?.firstElementChild?.setAttribute("color",i);const o=URL.createObjectURL(new Blob([(new XMLSerializer).serializeToString(s)],{type:"image/svg+xml"}));return new Promise((i=>{const s=new Image;s.width=e,s.height=t,s.onload=()=>{i({image:s,width:e,height:t})},s.src=o}))}function b(e,t,i,s){return(0,c.drawScaled)(e,s,s,(()=>{e.fillText(i,t.x/s,t.y/s)})),e.measureText(i).width*s}function y(e,t,i,s,o,n){const a=o.map((e=>e.text)).join("");let c=i.x;const h=function(e,t,i,s){if(e.measureText(t).width*s<=i)return{text:t,elided:!1};const o=e.measureText("...").width*s,r=[];for(let e=0;e<t.length;++e)r.push(e);const n=(0,
l.upperbound)(r,i,((r,n)=>e.measureText(t.slice(0,n+1)).width*s+o>i));return{text:(t=t.slice(0,n)).trim(),elided:!0}}(e,a,s-c,t);if(h.elided&&!n)return null;const d=[];let u=0;for(const e of o){if(u+e.text.length>h.text.length)break;d.push(e.text),u+=e.text.length}const _=d.join("").trim().length;u=0;for(const s of o){if(u+s.text.length>_)break;s.color&&(e.save(),e.fillStyle=s.color),c+=b(e,new r.Point(c,i.y),s.text,t),s.color&&e.restore(),u+=s.text.length}return h.elided&&(c+=b(e,new r.Point(c,i.y),"...",t)),c}function w(e){return e.map((e=>({...e,title:""})))}function C(e,t){const i=[{text:e.trim()}];for(const e of t)e.visible&&(""!==i[i.length-1].text&&i.push({text:"  "}),e.title&&i.push({text:e.title}),i.push({text:e.value,color:e.color}));return i}class T{constructor(e,t){this._logoTextColor=null,this._snapshotData=e,t=t||{},this._options={backgroundColor:u.themes[e.theme].getThemedColor("color-bg-primary"),borderColor:u.themes[e.theme].getThemedColor("color-border"),font:h.CHART_FONT_FAMILY,fontSize:12,legendMode:"vertical",hideResolution:!1,hideStudiesFromLegend:!1,showHeaderPublishedBy:!1,showHeaderMainSymbol:!1,...t};const i=S[e.layout],o=e.charts.map((e=>function(e){const t=e.panes[0],i=t.canvas.width+t.leftAxis.canvas.width+t.rightAxis.canvas.width;let o=0;for(const t of e.panes)o+=t.canvas.height;return void 0!==e.timeAxis&&0!==e.timeAxis.contentHeight&&(o+=e.timeAxis.canvas.height),(0,s.size)({width:i,height:o})}(e)));if(this._pixelRatio=e.hidpiRatio,this._chartsGeometry=e.charts.map(((e,t)=>v(t,o,i,this._pixelRatio))),!m){let i=e.theme;void 0!==t.backgroundColor&&(i="black"===(0,n.rgbToBlackWhiteString)((0,n.parseRgb)(t.backgroundColor),150)?a.StdTheme.Dark:a.StdTheme.Light),this._logoTextColor=u.themes[i].getThemedColor("color-text-primary")}this._headerDefaultTextColor=u.themes[e.theme].getThemedColor("color-text-primary")}async getImage(){const e=this._pixelRatio;let t=0,i=0,o=0;const n=this._headerItems();if(n.length>0){o=Math.ceil(1.4*this._options.fontSize*e)*n.length}i+=o;let a=0,l=0;for(const e of this._chartsGeometry)a=Math.max(a,e.x+e.width),l=Math.max(l,e.y+e.height);const h=i;t+=a,i+=l,t+=Math.round(10*e);const u=m?Math.round(10*e):Math.round(60*e),_=i;i+=u;const p=(0,c.createDisconnectedCanvas)(document,(0,s.size)({width:t,height:i}),1),g=(0,c.getContext2D)(p);g.font=(0,d.makeFont)(this._options.fontSize,this._options.font),g.textBaseline="top",g.fillStyle=this._options.backgroundColor,g.fillRect(0,0,t,i),n.length>0&&this._drawHeader(g,n,t,new r.Point(Math.round(10*e),Math.round(10*e)));for(let e=0;e<this._snapshotData.charts.length;++e){const t=this._snapshotData.charts[e],i=this._chartsGeometry[e];this._drawChart(t,i,g,new r.Point(0,h))}if(null!==this._logoTextColor){const t=await f(Math.round(162*e),Math.round(28*e),this._logoTextColor);g.drawImage(t.image,Math.round(10*e),_+Math.round(u/2-t.height/2),t.width,t.height)}return p}_drawChart(e,t,i,s){i.save(),i.translate(t.x+s.x,t.y+s.y);let o=0;for(const t of e.panes){let s=0
;const n=t.leftAxis.canvas.width+Math.round(8*this._pixelRatio),a=o,l=o+Math.round(10*this._pixelRatio);t.leftAxis.contentWidth>0&&t.leftAxis.contentHeight>0&&(i.drawImage(t.leftAxis.canvas,s,o),s+=t.leftAxis.canvas.width),i.drawImage(t.canvas,s,o),s+=t.canvas.width,t.rightAxis.contentWidth>0&&t.rightAxis.contentHeight>0&&i.drawImage(t.rightAxis.canvas,s,o),"pane"===t.type&&(i.fillStyle=e.colors.text,this._drawLegend(t,i,new r.Point(n,l),a)),o+=t.canvas.height}if(void 0!==e.timeAxis&&0!==e.timeAxis.contentHeight){let t=0;e.timeAxis.lhsStub.contentWidth>0&&e.timeAxis.lhsStub.contentHeight>0&&(i.drawImage(e.timeAxis.lhsStub.canvas,t,o),t+=e.timeAxis.lhsStub.canvas.width),i.drawImage(e.timeAxis.canvas,t,o),t+=e.timeAxis.canvas.width,e.timeAxis.rhsStub.contentWidth>0&&e.timeAxis.rhsStub.contentHeight>0&&i.drawImage(e.timeAxis.rhsStub.canvas,t,o)}i.strokeStyle=this._options.borderColor,i.strokeRect(0,0,t.width,t.height),i.restore()}_headerItems(){const e=[];if(this._options.showHeaderPublishedBy&&this._snapshotData.publishedBy)for(const t of this._snapshotData.publishedBy)e.push([{text:t}]);if(this._options.showHeaderMainSymbol){const t=this._snapshotData.charts[0],i=`${t.meta?.symbol}, ${t.meta?.resolution}`;e.push(C(i,t.meta?.values??[]))}return e}_drawHeader(e,t,i,s){e.save(),e.fillStyle=this._headerDefaultTextColor;const o=Math.ceil(1.4*this._options.fontSize*this._pixelRatio);t.forEach(((t,n)=>{y(e,this._pixelRatio,new r.Point(s.x,s.y+o*n),i,t,!0)})),e.restore()}_drawLegend(e,t,i,s){let n=!0;const a=Math.ceil(1.4*this._options.fontSize*this._pixelRatio);let l=i.x,c=i.y;if(e.mainSeriesText&&c+a<s+e.canvas.height){const i=y(t,this._pixelRatio,new r.Point(l,c),e.contentWidth*this._pixelRatio,C(e.mainSeriesText,e.mainSeriesValues),!0);"horizontal"!==this._options.legendMode?c+=a:(l=(0,o.ensureNotNull)(i)+1.4*this._options.fontSize*this._pixelRatio,n=!1)}for(let o=0;o<e.studies.length;++o)if(c+a<s+e.canvas.height){const s=e.studies[o],h=e.studiesValues[o];let d=null;for(;null===d;)d=y(t,this._pixelRatio,new r.Point(l,c),e.contentWidth*this._pixelRatio,this._options.hideStudiesFromLegend?[]:C(s,w(h)),n),"horizontal"!==this._options.legendMode?c+=a:null===d?(n=!0,l=i.x,c+=a):(l=d+1.4*this._options.fontSize*this._pixelRatio,n=!1)}}}async function P(e,t){return new T(e,t).getImage()}class M{constructor(e,t){if(this._logoTextColor=null,this._widgetSnapshot=e,t=t||{},this._options={backgroundColor:u.themes[e.theme].getThemedColor("color-bg-primary"),borderColor:u.themes[e.theme].getThemedColor("color-border"),font:h.CHART_FONT_FAMILY,fontSize:12,showHeaderPublishedBy:!0,...t},this._pixelRatio=e.hidpiRatio,!m){let i=e.theme;void 0!==t.backgroundColor&&(i="black"===(0,n.rgbToBlackWhiteString)((0,n.parseRgb)(t.backgroundColor),150)?a.StdTheme.Dark:a.StdTheme.Light),this._logoTextColor=u.themes[i].getThemedColor("color-text-primary")}this._headerDefaultTextColor=u.themes[e.theme].getThemedColor("color-text-primary")}async getSnapshot(){const e=this._pixelRatio,t=Math.round(10*e);let i=0,o=0,n=0;const a=this._headerItems()
;if(a.length>0){n=Math.ceil(1.4*this._options.fontSize*e)*a.length}o+=n;const l=o,h=this._widgetSnapshot.canvas.width,u=this._widgetSnapshot.canvas.height;i+=h+2*t,o+=u+t;const _=Math.round(60*e),p=o;o+=_;const m=(0,c.createDisconnectedCanvas)(document,(0,s.size)({width:i,height:o}),1),g=(0,c.getContext2D)(m);if(g.font=(0,d.makeFont)(this._options.fontSize,this._options.font),g.textBaseline="top",g.fillStyle=this._options.backgroundColor,g.fillRect(0,0,i,o),a.length>0&&this._drawHeader(g,a,i,new r.Point(t,t)),g.drawImage(this._widgetSnapshot.canvas,t,t+l),g.strokeStyle=this._options.borderColor,g.strokeRect(t,t+l,h,u),null!==this._logoTextColor){const t=await f(Math.round(162*e),Math.round(28*e),this._logoTextColor);g.drawImage(t.image,Math.round(10*e),p+Math.round(_/2-t.height/2),t.width,t.height)}return{canvas:m,chartBox:(0,r.box)(new r.Point(t,t+n),new r.Point(t+h,t+n+u))}}_headerItems(){const e=[];if(this._options.showHeaderPublishedBy&&this._widgetSnapshot.publishedBy)for(const t of this._widgetSnapshot.publishedBy)e.push([{text:t}]);return e}_drawHeader(e,t,i,s){e.save(),e.fillStyle=this._headerDefaultTextColor;const o=Math.ceil(1.4*this._options.fontSize*this._pixelRatio);t.forEach(((t,n)=>{y(e,this._pixelRatio,new r.Point(s.x,s.y+o*n),i,t,!0)})),e.restore()}}async function x(e,t){return new M(e,t).getSnapshot()}},996002:(e,t,i)=>{"use strict";i.d(t,{deleteLockedLineToolsProperty:()=>c});var s=i(950808),o=i(8914),r=i(367011);const n="delete_locked_linetools",a="toggle_delete_locked_linetools";function l(){const e=s.getBool(n,!0)&&s.getBool(r.doNotShowDeleteLockedLineKey,!1),t=s.getBool(a,e);return s.remove(n),s.setValue(a,t),t}const c=(0,o.createPrimitiveProperty)(l());c.subscribe(null,(()=>s.setValue(a,c.value()))),s.onSync.subscribe(null,(()=>c.setValue(l())))},367011:(e,t,i)=>{"use strict";i.d(t,{doNotShowDeleteLockedLineConfirmProperty:()=>a,doNotShowDeleteLockedLineKey:()=>r});var s=i(950808),o=i(8914);const r="do_not_show_delete_locked_line_confirm";function n(){return s.getBool(r,!1)}const a=(0,o.createPrimitiveProperty)(n());a.subscribe(null,(()=>s.setValue(r,a.value()))),s.onSync.subscribe(null,(()=>a.setValue(n())))},727342:(e,t,i)=>{"use strict";function s(e){return Math.max(1,e.ownerDocument?.defaultView?.devicePixelRatio||1)}i.d(t,{getCanvasDevicePixelRatio:()=>s})},322868:(e,t,i)=>{"use strict";i.d(t,{CHART_WIDGET_COLLECTION_SERVICE:()=>r,CollectionViewMode:()=>o.CollectionViewMode,chartWidgetCollectionService:()=>n});var s=i(835228),o=i(925002);const r={id:"ChartWidgetCollectionService"};function n(){return(0,s.hasService)(r)?(0,s.service)(r):null}},320269:(e,t,i)=>{"use strict";i.d(t,{KineticAnimation:()=>n});var s=i(185842);function o(e,t){return e.position-t.position}function r(e,t,i){const s=(e.position-t.position)/(e.time-t.time);return Math.sign(s)*Math.min(Math.abs(s),i)}class n{constructor(e,t,i,s){this._position1=null,this._position2=null,this._position3=null,this._position4=null,this._animationStartPosition=null,this._durationMsecs=0,this._speedPxPerMsec=0,this._minSpeed=e,
this._maxSpeed=t,this._dumpingCoeff=i,this._minMove=s}addPosition(e,t){if(null!==this._position1){if(this._position1.time===t)return void(this._position1.position=e);if(Math.abs(this._position1.position-e)<this._minMove)return}this._position4=this._position3,this._position3=this._position2,this._position2=this._position1,this._position1={time:t,position:e}}start(e,t){if(null===this._position1||null===this._position2)return;if(t-this._position1.time>50)return;let i=0;const s=r(this._position1,this._position2,this._maxSpeed),n=o(this._position1,this._position2),a=[s],l=[n];if(i+=n,null!==this._position3){const e=r(this._position2,this._position3,this._maxSpeed);if(Math.sign(e)===Math.sign(s)){const t=o(this._position2,this._position3);if(a.push(e),l.push(t),i+=t,null!==this._position4){const e=r(this._position3,this._position4,this._maxSpeed);if(Math.sign(e)===Math.sign(s)){const t=o(this._position3,this._position4);a.push(e),l.push(t),i+=t}}}}let c=0;for(let e=0;e<a.length;++e)c+=l[e]/i*a[e];Math.abs(c)<this._minSpeed||(this._animationStartPosition={position:e,time:t},this._speedPxPerMsec=c,this._durationMsecs=function(e,t){const i=Math.log(t);return Math.log(1*i/-e)/i}(Math.abs(c),this._dumpingCoeff))}getStartPosition(){return(0,s.ensureNotNull)(this._animationStartPosition).position}getPosition(e){const t=(0,s.ensureNotNull)(this._animationStartPosition),i=e-t.time;return t.position+this._speedPxPerMsec*(Math.pow(this._dumpingCoeff,i)-1)/Math.log(this._dumpingCoeff)}finished(e){return null===this._animationStartPosition||this._progressDuration(e)===this._durationMsecs}_progressDuration(e){const t=e-(0,s.ensureNotNull)(this._animationStartPosition).time;return Math.min(t,this._durationMsecs)}}},465907:(e,t,i)=>{"use strict";i.d(t,{createLayout:()=>c,layoutInitialSizingState:()=>h});var s=i(393418),o=i(436492),r=i(185842);const n=12,a=.05;function l(e,t=n){const i=new Set;if((0,s.default)(e))return i.add(e),{indices:i,smallestIndex:e,sizer:e=>e,splitters:()=>[],resizeApplier:(e,t,i,s,o)=>o,syncSublayoutsBySplitter:(e,t)=>t};const[c,...h]=e,u=h.map((e=>l(e)));let _=1/0;for(const e of u)for(const t of Array.from(e.indices))t<_&&(_=t),i.add(t);const p=(e,t,i,s,o,r,n,a)=>{const{left:l,top:c,width:h,height:u}=e,_="h"===n?h:u,p=_-i*(r-1);a||(s=(o=1/r)*t);const m=s*p+t*i,g=Math.round(m),S=t===r-1?_-g:Math.round(m+o*p)-g;return"h"===n?d(l+g,c,S,u):d(l,c+g,h,S)},m=(e,i,o,r,n,a,l)=>{if((0,s.default)(o))return[];const[c,...h]=o;return h.reduce((({sumOfCoeffsBefore:s,splitters:o},u,_)=>{const g=l?.[_],S=g?.percent??1/h.length,v=p(e,_,i,s,S,h.length,c,l);if(_<h.length-1){const e=`${a}-${r}-${_}-${c}`,{left:i,top:s,width:l,height:h}=v,u="v"===c?d(i,s+h-t/2+1,l,t):d(i+l-t/2+1,s,t,h);o.push({level:r,orientation:c,indexes:[...n,_],metrics:u,className:e})}return{splitters:Array.isArray(u)?o.concat(m(v,i,u,r+1,[...n,_],a,g?.substate)):o,sumOfCoeffsBefore:s+S}}),{splitters:[],sumOfCoeffsBefore:0}).splitters};function g(e,t,i,o,n,l,h,d,u=a){if((0,s.default)(o))return l;const[,..._]=o;if(h<n.level){const o=[0]
;for(let e=0;e<_.length;e++)o.push(o[o.length-1]+l[e].percent);return _.map(((a,m)=>{const S=l[m];if((0,s.default)(a))return S;if(!d&&m!==n.indexes[h])return S;const v=S?.percent??1/_.length,f=p(e,m,t,o[m],v,_.length,c,l);return{percent:S.percent,substate:g(f,t,i,a,n,(0,r.ensureDefined)(S.substate),h+1,d,u)}}))}{const[t]=o;if(t!==n.orientation||l.length<2)return l;const s=Math.min(n.indexes[h],l.length-2),r="v"===t?e.height:e.width,a=i/r,c=l[s].percent+l[s+1].percent;return l[s].percent+=a,l[s].percent=Math.min(c-u,Math.max(u,l[s].percent)),l[s+1].percent-=a,l[s+1].percent=Math.min(c-u,Math.max(u,l[s+1].percent)),l}}function S(e,t){if(1===e.length)return t;{const[i,...s]=e;return S(s,(0,r.ensureDefined)(t[i].substate))}}function v(e,t,i,n,a){if((0,s.default)(e))return i;const[,...l]=e;if(a<t.level)return l.map(((e,o)=>{const l=i?.[o];return(0,s.default)(e)?l:{percent:l.percent,substate:v(e,t,(0,r.ensureDefined)(l.substate),n,a+1)}}));{const e=t.indexes[a];if(n.length<i.length){const e=(0,o.default)(n),t=e[e.length-1].percent,s=i.length-e.length,r=t/(s+1);e[e.length-1].percent=r;for(let t=0;t<s;t++)e.push({percent:r});n=e}else if(n.length>i.length){const t=(0,o.default)(n);if(e>=i.length-1){const e=n.length-i.length;for(let i=0;i<e;i++)t[e].percent+=t[i].percent;t.splice(0,e)}else{for(let e=i.length;e<n.length;e++)t[i.length-1].percent+=t[e].percent;t.splice(i.length)}n=t}return i.forEach(((e,t)=>e.percent=n[t].percent)),i}}return{indices:i,smallestIndex:_,sizer:(e,t,i,s,o)=>{let r,n,a,l=0,h=0,d=0;for(let e=0;e<u.length;e++){const s=u[e];s.smallestIndex>=i||(s.indices.has(t)&&(r=s,a=o?.[e].substate,o&&(d=o[e].percent),n=l),l++,o&&0===d&&(h+=o[e].percent))}const _=p(e,n,s,h,d,l,c,o);return r.sizer(_,t,i,s,a)},splitters:(t,i,s)=>m(t,i,e,0,[],"",s),resizeApplier:(t,i,s,o,r,n,a)=>g(t,i,s,e,o,r,0,n,a),syncSublayoutsBySplitter:function(t,i){const s=S(t.indexes,i);return v(e,t,i,s,0)}}}function c(e,t,i,s){const o=function(e,t){const i=l(e,t);0;return{count:i.indices.size,sizer:i.sizer,splitters:i.splitters,resizeApplier:i.resizeApplier,syncSublayoutsBySplitter:i.syncSublayoutsBySplitter,expression:e}}(e,s);return{...o,title:i,layoutType:t}}function h(e){const[,...t]=e;return function(e){const t=1/e.length;return e.map((e=>({percent:t,substate:(0,s.default)(e)?void 0:h(e)})))}(t)}function d(e,t,i,s){return{left:e,top:t,width:i,height:s}}},948660:(e,t,i)=>{"use strict";i.d(t,{isMultipleLayout:()=>c,isSupportedLayout:()=>h,layouts:()=>a,tryGuessingTheMostSuitableLayout:()=>d});var s=i(539403),o=i(465907);const r={s:{title:"1 chart",count:1,layoutType:"s",sizer:(e,t)=>{if(0!==t)throw new RangeError("invalid index");return e},splitters:()=>[],resizeApplier:(e,t,i,s,o)=>o,syncSublayoutsBySplitter:(e,t)=>t,expression:["h",0]}};let n;{const e=e=>s[e];n={"2h":(0,o.createLayout)(e("2h"),"2h","2-up horizontal"),"2v":(0,o.createLayout)(e("2v"),"2v","2-up vertical"),"3h":(0,o.createLayout)(e("3h"),"3h","3-up horizontal"),"3v":(0,o.createLayout)(e("3v"),"3v","3-up vertical"),"3s":(0,o.createLayout)(e("3s"),"3s","3-up stacked"),"3r":(0,
o.createLayout)(e("3r"),"3r","3-up stacked left"),"2-1":(0,o.createLayout)(e("2-1"),"2-1","2 at top and 1 at bottom"),"1-2":(0,o.createLayout)(e("1-2"),"1-2","1 at top and 2 at bottom"),4:(0,o.createLayout)(e("4"),"4","4-up"),"4v":(0,o.createLayout)(e("4v"),"4v","4-up vertical"),"4h":(0,o.createLayout)(e("4h"),"4h","4-up horizontal"),"4s":(0,o.createLayout)(e("4s"),"4s","4-up stacked"),"4s-l":(0,o.createLayout)(e("4s-l"),"4s-l","4-up stacked left"),"1-3":(0,o.createLayout)(e("1-3"),"1-3","1 at top and 3 at bottom"),"3-1":(0,o.createLayout)(e("3-1"),"3-1","3 at top and 1 at bottom"),"2-2-l":(0,o.createLayout)(e("2-2-l"),"2-2-l","2 at left and 2 at right"),"2-2-r":(0,o.createLayout)(e("2-2-r"),"2-2-r","2 at right and 2 at left"),"2-2":(0,o.createLayout)(e("2-2"),"2-2","2 at top and 2 at bottom"),"1-4":(0,o.createLayout)(e("1-4"),"1-4","1 at top and 4 at bottom"),"5h":(0,o.createLayout)(e("5h"),"5h","5-up horizontal"),"5v":(0,o.createLayout)(e("5v"),"5v","5-up vertical"),"5s":(0,o.createLayout)(e("5s"),"5s","5-up stacked"),"5s-l":(0,o.createLayout)(e("5s-l"),"5s-l","5-up stacked left"),"2-3":(0,o.createLayout)(e("2-3"),"2-3","2 at top and 3 at bottom"),"3-2":(0,o.createLayout)(e("3-2"),"3-2","3 at top and 2 at bottom"),"4-1":(0,o.createLayout)(e("4-1"),"4-1","4 at top and 1 at bottom"),"2-3-l":(0,o.createLayout)(e("2-3-l"),"2-3-l","2 at left and 3 at right"),"2-3-r":(0,o.createLayout)(e("2-3-r"),"2-3-r","2 at right and 3 at left"),6:(0,o.createLayout)(e("6"),"6","6-up"),"6h":(0,o.createLayout)(e("6h"),"6h","6-up horizontal"),"6v":(0,o.createLayout)(e("6v"),"6v","6-up vertical"),"6c":(0,o.createLayout)(e("6c"),"6c","6-up in two columns"),"2-4":(0,o.createLayout)(e("2-4"),"2-4","2 at top and 4 at bottom"),"4-2":(0,o.createLayout)(e("4-2"),"4-2","4 at top and 2 at bottom"),"4-3":(0,o.createLayout)(e("4-3"),"4-3","4 at top and 3 at bottom"),"7h":(0,o.createLayout)(e("7h"),"7h","7-up horizontal"),"7s":(0,o.createLayout)(e("7s"),"7s","7-up stacked"),8:(0,o.createLayout)(e("8"),"8","8-up"),"8c":(0,o.createLayout)(e("8c"),"8c","8-up in two columns"),"8h":(0,o.createLayout)(e("8h"),"8h","8-up horizontal"),"8v":(0,o.createLayout)(e("8v"),"8v","8-up vertical"),"9s":(0,o.createLayout)(e("9s"),"9s","3x3 square"),"5-4":(0,o.createLayout)(e("5-4"),"5-4","5 at top and 4 at bottom"),"9h":(0,o.createLayout)(e("9h"),"9h","9-up horizontal"),"9v":(0,o.createLayout)(e("9v"),"9v","9-up vertical"),"10c5":(0,o.createLayout)(e("10c5"),"10c5","2-up in 5 columns"),"10h":(0,o.createLayout)(e("10h"),"10h","10-up horizontal"),"10v":(0,o.createLayout)(e("10v"),"10v","10-up vertical"),"12c6":(0,o.createLayout)(e("12c6"),"12c6","2-up in 6 columns"),"12c4":(0,o.createLayout)(e("12c4"),"12c4","3-up in 4 columns"),"12h":(0,o.createLayout)(e("12h"),"12h","12-up horizontal"),"14c7":(0,o.createLayout)(e("14c7"),"14c7","2-up in 7 columns"),"16c8":(0,o.createLayout)(e("16c8"),"16c8","2-up in 8 columns"),"16c4":(0,o.createLayout)(e("16c4"),"16c4","4-up in 4 columns")}}const a={...r,...n};function l(e){return"s"===e}function c(e){return!l(e)}function h(e){
return l(e)||n.hasOwnProperty(e)}function d(e){const t=/(\d)-(\d)/.exec(e);let i=1;for(i=3===t?.length?parseInt(t[1])+parseInt(t[2]):parseInt(e);i>1;){const e=Object.keys(n).find((e=>n[e].count===i));if(e)return e;i--}return"s"}},318068:(e,t,i)=>{"use strict";i.d(t,{lineToolsSelectHotkeys:()=>o});i(686923);var s=i(277637);const o={LineToolFibRetracement:{hash:s.Modifiers.Alt+70,action:"setTool",description:"Draw Fib Retracement"},LineToolHorzLine:{hash:s.Modifiers.Alt+72,action:"drawRightThere",description:"Draw Horizontal Line here"},LineToolHorzRay:{hash:s.Modifiers.Alt+74,action:"drawRightThere",description:"Draw Horizontal Ray here"},LineToolRectangle:{hash:s.Modifiers.Alt+s.Modifiers.Shift+82,action:"setTool",description:"Draw Rectangle"},LineToolTrendLine:{hash:s.Modifiers.Alt+84,action:"setTool",description:"Draw Trend Line"},LineToolVertLine:{hash:s.Modifiers.Alt+86,action:"drawRightThere",description:"Draw Vertical Line here"},LineToolCrossLine:{hash:s.Modifiers.Alt+67,action:"drawRightThere",description:"Draw Cross Line here"}}},211948:(e,t,i)=>{"use strict";i.d(t,{actualBehavior:()=>a,availableValues:()=>n,navigationButtonsVisibilityKey:()=>o,property:()=>r,restoreNavigationButtonsVisibilitySettingsValue:()=>l});var s=i(5109);const o="NavigationButtons.visibility",{property:r,availableValues:n,actualBehavior:a,restoreDefaultValue:l}=(0,s.createVisibilityController)(o)},286592:(e,t,i)=>{"use strict";i.d(t,{actualBehavior:()=>a,availableValues:()=>n,property:()=>r,restorePaneButtonsVisibilitySettingsValue:()=>l});var s=i(5109),o=i(211948);const{property:r,availableValues:n,actualBehavior:a,restoreDefaultValue:l}=(0,s.createVisibilityController)("PaneButtons.visibility",o.navigationButtonsVisibilityKey)},635262:(e,t,i)=>{"use strict";i.d(t,{performanceTestMode:()=>l});var s=i(788312),o=i(376596),r=i(702203);const n=navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&-1===navigator.userAgent.toLowerCase().indexOf("edge"),a=new Set(["en","uk","de_DE","fr","es","it","pl","ja","ca","ru"]),l=n&&!o.CheckMobile.any()&&!(0,r.isOnMobileAppPage)("any")&&!window.TVD&&!(0,o.onWidget)()&&(0,s.isFeatureEnabled)("performance_test_mode")&&!window.matchMedia("(prefers-reduced-motion)").matches&&a.has(window.locale)},416464:(e,t,i)=>{"use strict";i.d(t,{showStudiesLimitGoProDialog:()=>h});var s=i(797001),o=i(376596),r=i(822707),n=i(961531),a=i(44408),l=i(870720);const c=["pro_premium_expert","pro_premium_expert_trial"];function h(e,t){const i=c.includes(window.user.pro_plan);switch(t.reason){case"child":(0,r.openPaywall)({feature:"studyOnStudy",isMaxPlan:i});break;case"fundamental":const t=e.allStudies().filter(a.isFundamentalStudy).map((e=>e.title(l.TitleDisplayTarget.StatusLine)));(0,r.openPaywall)({feature:"fundamentalsOnChart",forceCloseButton:i,hidePromotedFeatures:i,fundamentals:t});break;default:(0,s.trackGoProFeature)("studyLimit");const c=e.listUserStudies({dontCountVolume:!0,dontCountOverlay:!0,dontCountCompare:!0});(0,o.onWidget)()?(0,n.showGoToTradingViewReferralDialog)({feature:"indicators"}):(0,
r.openPaywall)({feature:"studyLimit",studiesList:c,isMaxPlan:i})}}},519862:(e,t,i)=>{"use strict";i.d(t,{DataProblemModel:()=>h});var s=i(77357),o=i(131890),r=i(167481),n=i(690522),a=i(385955),l=i(726395);const c=(0,s.getLogger)("Chart.DataProblemModel");class h{constructor(e,t){this._mainDataProblem=new n.WatchedObject(null),this._supportPortalProblems=new n.WatchedObject([]),this._allDataProblems=new n.WatchedObject([]),this._pushStreamHandler=null,this._destroyed=!1,this._quotesProvider=e,this._quotesProvider.quotesUpdate().subscribe(this,this._update.bind(this)),this._symbolInfo=t,this._symbolInfo.subscribe((e=>{e||this._mainDataProblem.setValue(null)})),this._mainDataProblem.subscribe((()=>this._updateAllDataProblems())),this._supportPortalProblems.subscribe((()=>this._updateAllDataProblems())),this._requestSupportPortalProblems()}destroy(){this._quotesProvider.quotesUpdate().unsubscribeAll(this),this._symbolInfo.release(),null!==this._pushStreamHandler&&l.pushStreamMultiplexer.off("support-portal-problem",this._pushStreamHandler),this._destroyed=!0}dataProblems(){return this._allDataProblems}_resetStatus(){this._mainDataProblem.setValue(null)}_update(e){void 0===e.values||void 0===e.values.data_problem?this._resetStatus():this._mainDataProblem.setValue((0,a.clone)(e.values.data_problem))}_updateAllDataProblems(){const e=this._mainDataProblem.value(),t=this._supportPortalProblems.value();this._allDataProblems.setValue(null===e?t:[e,...t])}async _requestSupportPortalProblems(){{const e=await(0,o.fetch)(`${r.supportPortalProblemsHost}/support/support-portal-problems/?language=${window.locale}`);if(this._destroyed)return;if(!e.ok)return void c.logWarn("Couldn't load support portal problems");const t=(await e.json()).issues,i=()=>{const e=t.filter((e=>e.show_on_chart&&!1!==e.is_active&&(void 0===e.language||e.language.some((e=>e===window.locale||"all"===e))))).map((e=>({severity:"low",title:e.title,text:e.description})));this._supportPortalProblems.setValue(e)};i(),this._pushStreamHandler=e=>{switch(e.action){case"created":t.push(e.data);break;case"modified":{const i=t.findIndex((t=>t.id===e.data.id));-1!==i?t[i]={...t[i],...e.data}:t.push(e.data);break}case"deleted":{const i=t.findIndex((t=>t.id===e.data.id));-1!==i&&t.splice(i,1);break}}i()},l.pushStreamMultiplexer.on("support-portal-problem",this._pushStreamHandler)}}}},330473:(e,t,i)=>{"use strict";i.d(t,{DataUpdatedModeModel:()=>S});var s=i(185842),o=i(77357),r=i(690522),n=i(224079),a=i(446087),l=i(111516);async function c(e){if(window.user.declared_status!==a.UserStatus.Pro)return!1;if(await(window.pro?.updateShopConf())){const t=window.pro?.getPaidExchangesForProfessional().map((e=>e.exchange.toUpperCase()));if(!t?.includes(e.listed_exchange.toUpperCase())&&!t?.includes(e.pro_perm.toUpperCase()))return!1}return async function(e){try{return(await(0,l.isSignedExchangeAgreement)({exchange:e.pro_perm})).response}catch{return!1}}(e)}var h=i(521928),d=i.n(h);var u=i(70346),_=i(244007);const p=(0,o.getLogger)("Chart.Definitions.Series");function m(e,t){
return"TickByTick"===e?{mode:e,updatePeriod:t}:{mode:e}}async function g(e,t,i){const s=[];return(0,n.isDelay)(e.delay)?async function(e){const t=[];return(0,n.witoutRealtime)(e)?t.push(m("DelayNoRealtime")):(0,n.isDelayForGuest)("TFEX",e)?t.push(m("TFEXDelayForGuest")):(0,n.isDelayForGuest)("ICESG",e)?t.push(m("ICESGDelayForGuest")):(0,n.isDelayForGuest)("TURQUOISE",e)?t.push(m("TURQUOISEDelayForGuest")):(0,n.isDelayForGuest)("ADX",e)?t.push(m("ADXDelayForGuest")):(0,n.isDelayForGuest)("LUXSE",e)?t.push(m("LUXSEDelayForGuest")):(0,n.isDelayForGuest)("NSENG",e)?t.push(m("NSENGDelayForGuest")):(0,n.isDelayForGuest)("FINRA",e)?t.push(m("FINRADelayForGuest")):(0,n.isDelayForGuest)("AQUIS",e)?t.push(m("AQUISDelayForGuest")):(0,n.isDelayForGuest)("TRADEGATE",e)?t.push(m("TRADEGATEDelayForGuest")):["DUS","HAM","HAN","MUN"].some((t=>(0,n.isDelayForGuest)(t,e)))?t.push(m("DEForGuest")):["MIL"].some((t=>(0,n.isDelayForGuest)(t,e)))?t.push(m("MILDelayForGuest")):await c(e)?t.push(m("DelayToRealtime")):(0,n.isDelayWithoutMarketAgreement)(e)?t.push(m("DelayWithoutMarketAgreement")):t.push(m("DelayToRealtime")),t}(e):(0,n.isEod)(e,t)?((0,n.isEodWithRealtime)(e.listed_exchange)?s.push(m("EODToRealtime")):s.push(m("EOD")),s):((0,n.isTickByTick)(e,t)&&0!==i&&s.push(m("TickByTick",i)),function(e){return d().hasBatsSymbols(e.full_name)}(e)&&s.push(m("BATSToRealtime")),(0,n.isOvernightQuotes)(e)&&s.push(m("OvernightQuotes")),s)}class S{constructor(e,t,i){this._dataUpdatedInfoStatus=new r.WatchedObject(null),this._symbolInfo=e,this._status=t,this._updatePeriod=i,this._symbolInfo.subscribe(this._update.bind(this)),this._status.subscribe(this._update.bind(this)),this._updatePeriod.subscribe(this._update.bind(this))}destroy(){this._symbolInfo.release(),this._status.release(),this._updatePeriod.release()}status(){return this._dataUpdatedInfoStatus.readonly()}symbolName(){const e=this._symbolInfo.value();return null!==e?e.name:""}time(){const e=this._symbolInfo.value(),t=null!==e&&e.delay&&e.delay>0?e.delay:900;return Math.round(t/60)}listedExchange(){const e=this._symbolInfo.value();return null!==e?(0,u.getSymbolListedExchange)(e):""}async description(){const e=this._symbolInfo.value();if(null===e)return"";let t={};try{t=(0,s.ensureNotNull)(await(0,n.getExchange)(e))}catch(e){p.logWarn(`Cannot get exchange ${(0,_.errorToString)(e)}`)}return t.description||e.listed_exchange}tradedExchange(){const e=this._symbolInfo.value();return null!==e?(0,u.getSymbolTradedExchange)(e):""}proName(){const e=this._symbolInfo.value();return null!==e?e.pro_name:""}country(){return this._symbolInfo.value()?.country||""}proPerm(){const e=this._symbolInfo.value();return null!==e?e.pro_perm:""}firstReplacedByBatsExchange(){const e=this._symbolInfo.value();return e&&(0,n.firstReplacedByBatsExchange)(e)}isSpread(){const e=this._symbolInfo.value();return null!==e&&"spread"===e.type}isDelay(){const e=this._symbolInfo.value();return Boolean(e?.delay)}async _update(){const e=this._symbolInfo.value();if(null===e)return void this._dataUpdatedInfoStatus.setValue(null)
;const t=this._status.value();if("string"==typeof t)return void this._dataUpdatedInfoStatus.setValue(null);if(2===t||1===t)return;const i=await g(e,t,this._updatePeriod.value());0!==i.length?this._dataUpdatedInfoStatus.setValue(i):this._dataUpdatedInfoStatus.setValue(null)}}},148983:(e,t,i)=>{"use strict";i.d(t,{restoreShowMarketOpenStatusProperty:()=>c,showMarketOpenStatusProperty:()=>l});var s=i(8914),o=i(950808);const r="Chart.ShowMarketOpenStatus",n=!0;function a(){return o.getBool(r,n)}const l=(0,s.createPrimitiveProperty)(a());function c(){l.setValue(n),o.remove(r)}o.onSync.subscribe(null,(()=>l.setValue(a()))),l.subscribe(null,(()=>o.setValue(r,l.value())))},112203:(e,t,i)=>{"use strict";i.d(t,{MarketStatusModel:()=>u});var s=i(185842),o=i(605678),r=i(168509),n=i(18107),a=i(312014),l=i(70346);class c{constructor(e,t){this._utcTime=new r.WatchedValue(null),this._expired=new r.WatchedValue(!1),this._sessionSpec=new r.WatchedValue(null),this._sessionSpecCache=null,this._utcDayStart=new Date(0),this._timeoutId=null,this._expiredBySymbolInfoTypespecs=!1,this._expiredByQuotesTypespecs=null,this._marketStatusSpawn=e.spawn(),this._quotesUpdate=t,this._quotesUpdate.subscribe(this,this._onQuotesUpdate)}destroy(){this._marketStatusSpawn.destroy(),this._clearTimeoutIfNeeded(),this._quotesUpdate.unsubscribeAll(this)}reset(){this._expiredBySymbolInfoTypespecs=!1,this._expiredByQuotesTypespecs=null,this._utcTime.setValue(null),this._expired.setValue(!1)}utcTime(){return this._utcTime.readonly()}expired(){return this._expired.readonly()}utcDayStart(){return this._utcDayStart}sessionSpec(){return this._sessionSpec.readonly()}setSymbolInfo(e){if(this._clearTimeoutIfNeeded(),null===e||!(0,l.isFuturesContractSymbol)(e)||void 0===e.expiration)return this._utcTime.setValue(null),void this._expired.setValue(!1);null!==this._sessionSpecCache&&this._sessionSpecCache.timezone===e.timezone&&this._sessionSpecCache.session===e.session&&this._sessionSpecCache.corrections===e.corrections&&this._sessionSpecCache.holidays===e.session_holidays||(this._sessionSpecCache={timezone:e.timezone,session:e.session,corrections:e.corrections,holidays:e.session_holidays,spec:new a.SessionsSpec(e.timezone,e.session,e.session_holidays,e.corrections)},this._sessionSpec.setValue(null));const t=this._sessionSpecCache.spec;this._utcDayStart=function(e){const t=Math.floor(e/1e4)%1e4,i=Math.floor(e/100)%100-1,s=e%100;return new Date(Date.UTC(t,i,s))}(e.expiration);const i=t.bordersOfDailyBar(this._utcDayStart);if(null===i)return this._utcTime.setValue(null),this._expired.setValue(!1),void this._sessionSpec.setValue(t);const s=(0,o.get_timezone)(e.timezone);this._utcTime.setValue((0,o.cal_to_utc)(s,i.to)+1e3),this._sessionSpec.setValue(t),this._expiredBySymbolInfoTypespecs=Boolean(e.typespecs?.includes("expired")),this._updateExpired()}_updateExpired(){this._clearTimeoutIfNeeded();const e=this._utcTime.value();if(null===e)return;if(this._expiredByQuotesTypespecs||this._expiredBySymbolInfoTypespecs)return void this._expired.setValue(!0)
;const t=window.ChartApiInstance.serverTime();let i;switch(this._marketStatusSpawn.value()){case"out_of_session":case"holiday":i=e-3e5-t;break;case"market":case"pre_market":case"post_market":i=e+3e5-t;break;default:i=e-t}i>0&&(this._timeoutId=setTimeout((()=>this._updateExpired()),Math.min(2e9,i))),this._expired.setValue(i<=0)}_clearTimeoutIfNeeded(){null!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null)}_onQuotesUpdate(e,t){let i=!1;if(null===this._expiredByQuotesTypespecs)this._expiredByQuotesTypespecs=Boolean(e.values.typespecs?.includes("expired")),i=this._expiredByQuotesTypespecs;else if(void 0!==t.values.typespecs){const e=Boolean(t.values.typespecs?.includes("expired"));i=this._expiredByQuotesTypespecs!==e,this._expiredByQuotesTypespecs=e}i&&null!==this._utcTime.value()&&this._updateExpired()}}function h(e){return window.ChartApiInstance.serverTime()/1e3-e}function d(e,t,i){const s=t+1e3;return e<=i?t<=i?1/0:s/1e3:Math.min(e,s)/1e3}class u{constructor(e){this._currentSession=new r.WatchedValue(null),this._delistedByTypespecs=new r.WatchedValue(!1),this._sessionsSpec=null,this._nextSessionEdgeInternal=null,this._nextSessionEdge=new r.WatchedValue(null),this._recalcNextSessionEdgeTimerId=null,this._delay=0,this._futuresContractExpirationTime=null,this._quotesProvider=e;const{current_session:t}=e.quotes().value()??{};t&&this._currentSession.setValue(t),this._futuresContractExpirationTime=new c(this._currentSession.readonly(),e.quotesUpdate()),e.quoteSymbolChanged().subscribe(this,(()=>{(0,s.ensureNotNull)(this._futuresContractExpirationTime).reset(),this._nextSessionEdgeInternal=null,this._recalculateNextSessionEdge()})),this._marketStatus=(0,n.combine)(((e,t,i)=>null===e?e:t?"delisted":i?"expired":function(e){switch(e){case"market":return"market";case"pre_market":return"pre_market";case"post_market":return"post_market";case"out_of_session":return"out_of_session";case"holiday":return"holiday"}(0,s.ensureNever)(e)}(e)),this._currentSession.weakReference(),this._delistedByTypespecs.weakReference(),(this._futuresContractExpirationTime?.expired()??new r.WatchedValue(!1)).weakReference()),e.quotesUpdate().subscribe(this,(e=>{this._currentSession.setValue(e?.values.current_session??null)})),e.quoteSymbolChanged().subscribe(this,(()=>{this._currentSession.setValue(null)}))}destroy(){this._quotesProvider.quotesUpdate().unsubscribeAll(this),this._quotesProvider.quoteSymbolChanged().unsubscribeAll(this),null!==this._recalcNextSessionEdgeTimerId&&clearTimeout(this._recalcNextSessionEdgeTimerId),(0,s.ensureNotNull)(this._futuresContractExpirationTime).destroy(),this._marketStatus.destroy()}futuresContractExpirationTime(){return this._futuresContractExpirationTime}setSymbolInfo(e){if((0,s.ensureNotNull)(this._futuresContractExpirationTime).setSymbolInfo(e),this._nextSessionEdgeInternal=null,null===e)return void(this._sessionsSpec=null);this._delay=(0,l.getSymbolDelaySeconds)(e);const t=new a.SessionsSpec(e.timezone,e.session_display??e.session,e.session_holidays,e.corrections);let i,o
;const r=e.subsessions?.find((e=>"premarket"===e.id)),n=e.subsessions?.find((e=>"postmarket"===e.id));void 0!==r&&(i=new a.SessionsSpec(e.timezone,r["session-display"]??r.session,e.session_holidays,r["session-correction"])),void 0!==n&&(o=new a.SessionsSpec(e.timezone,n["session-display"]??n.session,e.session_holidays,n["session-correction"])),this._delistedByTypespecs.setValue(Boolean(e.typespecs?.includes("discontinued"))),this._sessionsSpec={general:t,preMarket:i,postMarket:o},this._recalculateNextSessionEdge()}status(){return this._marketStatus}currentSession(){return this._currentSession}nextSessionEdge(){return this._nextSessionEdge}_getNextSessionEdgeInternal(){if(null===this._sessionsSpec)return null;const e=1e3*h(this._delay);if(null===this._nextSessionEdgeInternal||(this._nextSessionEdgeInternal.timestamp??1/0)<=e/1e3){const{general:t,preMarket:i,postMarket:s}=this._sessionsSpec,r=(0,o.get_timezone)(t.timezone()),n=(0,o.utc_to_cal)(r,e),a=d((0,o.cal_to_utc)(r,t.alignToNearestSessionStart(n,1)),(0,o.cal_to_utc)(r,t.alignToNearestSessionEnd(n,1)),e),l=d(void 0!==i?(0,o.cal_to_utc)(r,i.alignToNearestSessionStart(n,1)):1/0,void 0!==i?(0,o.cal_to_utc)(r,i.alignToNearestSessionEnd(n,1)):1/0,e),c=d(void 0!==s?(0,o.cal_to_utc)(r,s.alignToNearestSessionStart(n,1)):1/0,void 0!==s?(0,o.cal_to_utc)(r,s.alignToNearestSessionEnd(n,1)):1/0,e);let u=Math.min(a,l,c);if(u===1/0){const e=h(this._delay),i=6e4,s=new Date(Math.round(new Date(1e3*e).getTime()/i)*i).getTime()+i,n=(0,o.utc_to_cal)(r,s),a=d((0,o.cal_to_utc)(r,t.alignToNearestSessionStart(n,1)),(0,o.cal_to_utc)(r,t.alignToNearestSessionEnd(n,1)),s),_=Math.min(a,l,c);_!==1/0?(this._nextSessionEdgeInternal={timestamp:u},u=_):this._nextSessionEdgeInternal={timestamp:null}}this._nextSessionEdgeInternal=u===c?{timestamp:u,status:"post_market"}:u===l?{timestamp:u,status:"pre_market"}:{timestamp:u}}return this._nextSessionEdgeInternal}_recalculateNextSessionEdge(){const e=this._getNextSessionEdgeInternal();if(null===e||null===e.timestamp)return void this._nextSessionEdge.setValue(null);const t={status:e.status,remainingSeconds:Math.max(0,e.timestamp-h(this._delay))};if(null===this._recalcNextSessionEdgeTimerId){const e=Number.isFinite(t.remainingSeconds)?Math.ceil(t.remainingSeconds%60):1;this._recalcNextSessionEdgeTimerId=setTimeout((()=>this._recalculateNextSessionEdgeByTimer()),1e3*e)}this._nextSessionEdge.setValue(t)}_recalculateNextSessionEdgeByTimer(){this._recalcNextSessionEdgeTimerId=null,this._recalculateNextSessionEdge()}}},224079:(e,t,i)=>{"use strict";i.d(t,{crucialRealtimeBats:()=>p,delayWithoutAgreement:()=>m,firstReplacedByBatsExchange:()=>g,getExchange:()=>P,isAmexToCboeMigratedSymbol:()=>M,isDelay:()=>f,isDelayForGuest:()=>w,isDelayWithoutMarketAgreement:()=>C,isEod:()=>S,isEodWithRealtime:()=>v,isOvernightQuotes:()=>T,isTickByTick:()=>y,witoutRealtime:()=>b});var s=i(185842),o=i(521928),r=i.n(o),n=i(537244),a=i(298147)
;const l=["DJ","BELEX"],c=["NZX"],h=["BIVA"],d=["BOATS"],u=["NSE"],_=["LME"],p=["AMEX","NASDAQ","NYSE"],m=["ICESG","TURQUOISE","AQUIS","DFM",...u,"FINRA","FINRA_ATDS_BONDS","FINRA_BTDS_BONDS"];function g(e){const t=r().getExchanges(e.pro_name),i=r().getExchanges(e.full_name);for(let e=0;e<i.length;++e)if("BATS"===i[e].toUpperCase())return t[e];return null}function S(e,t){return r().hasEodSymbols(e.full_name)||6===t}function v(e){return _.includes(e)}function f(e){return void 0!==e&&e>0}function b(e){return"index"===e.type&&l.includes(e.listed_exchange)||"futures"===e.type&&c.includes(e.listed_exchange)||h.includes(e.listed_exchange)}function y(e,t){return!((0,n.enabled)("TICK_BY_TICK_PUSH_DATA")||f(e.delay)||u.includes(e.listed_exchange)||S(e,t)||(0,a.hasCryptoTypespec)(e.typespecs||[]))}function w(e,t){return t.listed_exchange===e&&!window.is_authenticated}function C(e){return m.includes(e.listed_exchange)}function T(e){const t=e.listed_exchange.toUpperCase();if(!d.includes(t))return!1;return!(window.pro?.getUserPaidExchanges().map((e=>e.exchange.toUpperCase()))||[]).includes(t)}async function P(e){{const t=(0,s.ensureDefined)(window.pro);await new Promise((e=>{t.runOrUpdate(e)}));const i=t.getProduct(function(e){return`exchange-${e.pro_perm}`}(e)),o=function(e){let t;if(!window.pro)throw new Error("Pro module not defined");t=window.pro.getProductsByType(window.pro.PRODUCT_TYPES.exchange).find((t=>Boolean(t.included_exchanges?.includes(e))));return t||null}(i.exchange||"");return o&&["cme-full","us-stocks","finra","euronext"].includes(o.exchange)?i:o||i}}function M(e,t){return"amex"===t&&"CBOE"===e}},491628:(e,t,i)=>{"use strict";i.d(t,{actionMap:()=>Z,classNameMap:()=>H,countdownFnMap:()=>K,iconMap:()=>z,marketStatusDescription:()=>q,titleColorMap:()=>j,titleMap:()=>G,tooltipMap:()=>U});var s=i(823291),o=i(729193),r=i(570860),n=i(589981),a=i(598328),l=i(500764),c=i(65774),h=i(579661),d=i(767483),u=i(405818),_=i(272198),p=i(547685),m=i(518094),g=i(611555),S=i(447330),v=i(841270)
;const f=o.t(null,void 0,i(969449)),b=o.t(null,void 0,i(428809)),y=o.t(null,void 0,i(14890)),w=o.t(null,void 0,i(82983)),C=o.t(null,void 0,i(499507)),T=o.t(null,void 0,i(777920)),P=o.t(null,void 0,i(295586)),M=o.t(null,void 0,i(448671)),x=o.t(null,void 0,i(215998)),I=o.t(null,void 0,i(743689)),L=o.t(null,void 0,i(842276)),A=o.t(null,void 0,i(281386)),k=o.t(null,void 0,i(361920)),E=o.t(null,void 0,i(631438)),D=o.t(null,void 0,i(40454)),B=o.t(null,void 0,i(779340)),R=new Map([["market",new Map([["small",n],["medium",a],["large",n]])],["pre_market",new Map([["small",d],["medium",u],["large",d]])],["post_market",new Map([["small",c],["medium",h],["large",c]])],["out_of_session",new Map([["small",r],["medium",r],["large",r]])],["holiday",new Map([["small",l],["medium",l],["large",l]])]]),V=new Map([["market",v.marketStatusOpen],["pre_market",v.marketStatusPre],["post_market",v.marketStatusPost],["out_of_session",v.marketStatusClose],["holiday",v.marketStatusHoliday]]),O=new Map([["market",f],["pre_market",b],["post_market",y],["out_of_session",w],["holiday",C]]),N=new Map([["market",f],["pre_market",b],["post_market",y],["out_of_session",w],["holiday",C]]),W=new Map([["market",s.colorsPalette["color-market-open"]],["pre_market",s.colorsPalette["color-pre-market"]],["post_market",s.colorsPalette["color-post-market"]],["out_of_session",s.colorsPalette["color-market-closed"]],["holiday",s.colorsPalette["color-market-holiday"]]]),F=new Map([["market",T],["pre_market",P],["post_market",M],["out_of_session",x],["holiday",I]]);R.set("delisted",new Map([["small",_],["medium",p],["large",m]])),R.set("expired",new Map([["small",S],["medium",g],["large",g]])),V.set("delisted",v.marketStatusDelisted),V.set("expired",v.marketStatusExpired),O.set("delisted",o.t(null,void 0,i(341458))),O.set("expired",o.t(null,void 0,i(89919))),N.set("delisted",o.t(null,void 0,i(377335))),N.set("expired",o.t(null,void 0,i(89919))),W.set("delisted",s.colorsPalette["color-delisted-symbol"]),W.set("expired",s.colorsPalette["color-market-expired"]),F.set("delisted","This is no longer publicly trading so no new data will be added. But you can explore the historicals here."),F.set("expired",o.t(null,void 0,i(225869)));const z=R,H=V,U=O,G=N,j=W,q=F;function $(e){const t=Math.floor(e/86400),s=Math.floor((e-86400*t)/3600),r=Math.floor((e-86400*t-3600*s)/60);if(0===t&&0===s&&0===r)return L;if(t>0){const e=o.t(null,{plural:"{number} days",count:t,replace:{number:`${t}`},context:"Market opens in n days and n hours"},i(268166)),r=o.t(null,{plural:"{number} hours",count:s,replace:{number:`${s}`},context:"Market opens in n days and n hours"},i(298234));return o.t(null,{replace:{days:e,hours:r}},i(70251))}if(s>0){const e=o.t(null,{plural:"{number} hours",count:s,replace:{number:`${s}`},context:"Market opens in n hours and n minutes"},i(142101)),t=o.t(null,{plural:"{number} minutes",count:r,replace:{number:`${r}`},context:"Market opens in n hours and n minutes"},i(32145));return o.t(null,{replace:{hours:e,minutes:t}},i(794895))}return o.t(null,{
plural:"{number} minutes",count:r,replace:{number:`${r}`,context:"Market opens in n minutes"}},i(704958))}const K={market:e=>("post_market"===e.status?D:E).format({remainingTime:$(e.remainingSeconds)}),pre_market:e=>k.format({remainingTime:$(e.remainingSeconds)}),post_market:e=>E.format({remainingTime:$(e.remainingSeconds)}),out_of_session:e=>("pre_market"===e.status?B:A).format({remainingTime:$(e.remainingSeconds)}),holiday:e=>("pre_market"===e.status?B:A).format({remainingTime:$(e.remainingSeconds)}),delisted:e=>"",expired:e=>""},Z=new Map([["market",null],["pre_market",null],["post_market",null],["out_of_session",null],["holiday",null],["delisted",null]])},579454:(e,t,i)=>{"use strict";i.d(t,{canShowSpreadActions:()=>o,globalKeypressMatches:()=>r});i(266150);var s=i(522750);function o(){let e=!1;return e="cme"!==window.TradingView.widgetCustomer&&"bovespa"!==window.TradingView.widgetCustomer,e}function r(e){if(e.ctrlKey)return!1;if(e.metaKey)return!1;if(!e.charCode)return!1;if(!e.which||e.which<=32)return!1;const t=e.target;return(!t||!/^(input|textarea)$/i.test(t.tagName)&&"listbox"!==t.getAttribute("role"))&&!(0,s.isOpenedModals)()}},949903:(e,t,i)=>{"use strict";function s(){return Promise.all([i.e(19878),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(46680),i.e(74528),i.e(31788),i.e(45448),i.e(27848),i.e(6406),i.e(19133),i.e(22066),i.e(92597),i.e(18257),i.e(86834),i.e(98729),i.e(27688),i.e(56752),i.e(20432),i.e(35424),i.e(33160),i.e(92568),i.e(12559),i.e(60627),i.e(96872),i.e(73133),i.e(52253),i.e(44589),i.e(93541),i.e(92118),i.e(75649),i.e(65790),i.e(68805),i.e(59717),i.e(63935),i.e(29984),i.e(4050),i.e(30796),i.e(5246),i.e(80387),i.e(75174),i.e(6784),i.e(87795),i.e(57350),i.e(16803),i.e(26729),i.e(37865),i.e(93807),i.e(4058),i.e(25947),i.e(96840),i.e(23616),i.e(2527),i.e(85225),i.e(43552),i.e(47865),i.e(87580),i.e(80928),i.e(90128),i.e(21148),i.e(78399),i.e(32078),i.e(87410),i.e(63726),i.e(51493),i.e(76037),i.e(69e3),i.e(9325),i.e(88481),i.e(92642),i.e(77141),i.e(79405),i.e(32387),i.e(36295),i.e(80915),i.e(53121),i.e(17686),i.e(67890),i.e(53233),i.e(13349),i.e(98784),i.e(10443),i.e(12796),i.e(74607),i.e(82106),i.e(6877),i.e(41494),i.e(2243),i.e(40401),i.e(68481)]).then(i.bind(i,161773))}i.d(t,{loadNewSymbolSearch:()=>s})},994014:(e,t,i)=>{"use strict";i.d(t,{addPlusButtonProperty:()=>u,restoreAddPlusButtonSettingsValue:()=>_,showPlusButtonOnCursor:()=>h});var s=i(284278),o=(i(266150),i(950808)),r=i(8914),n=i(168509);const a="add_plus_button";function l(){const e=s.keyboardPressedKeysState.value();return void 0!==e&&(Boolean(e.modifiers&s.Modifiers.Alt&&e.modifiers&s.Modifiers.Mod)&&(void 0===e.code||e.altOrOptionCode()||e.controlOrMetaCode()))}const c=new n.WatchedValue(l());s.keyboardPressedKeysState.subscribe((()=>c.setValue(l())));const h=c.readonly();function d(){return o.getBool(a,!0)}const u=(0,r.createPrimitiveProperty)(d());function _(){u.setValue(!0),o.remove(a)}
o.onSync.subscribe(null,(()=>u.setValue(d()))),u.subscribe(null,(()=>{o.setValue(a,u.value())}))},901649:(e,t,i)=>{"use strict";i.d(t,{actualAutoLogButtonsVisibility:()=>a,autoLogButtonsVisibilityOptions:()=>r,autoLogButtonsVisibilityProperty:()=>o,restoreAutoLogButtonsVisibilitySettingsValue:()=>n});var s=i(5109);const{property:o,availableValues:r,restoreDefaultValue:n,actualBehavior:a}=(0,s.createVisibilityController)("PriceAxisAutoLogButtons.visibility")},991321:(e,t,i)=>{"use strict";i.d(t,{BarsRange:()=>o});var s=i(185842);class o{constructor(e,t){(0,s.assert)(e<=t,"The last bar in the bars range should be greater than or equal to the first bar"),this._firstBar=e,this._lastBar=t}firstBar(){return this._firstBar}lastBar(){return this._lastBar}count(){return this._lastBar-this._firstBar+1}contains(e){return this._firstBar<=e&&e<=this._lastBar}unite(e){return null===e?this:new o(Math.min(this._firstBar,e.firstBar()),Math.max(this._lastBar,e.lastBar()))}equals(e){return this._firstBar===e.firstBar()&&this._lastBar===e.lastBar()}static compare(e,t){return null===e||null===t?e===t:e.equals(t)}}},151515:(e,t,i)=>{"use strict";i.d(t,{ComputedTimePointWeights:()=>n});var s=i(188485);function o(e,t){for(let i=0;i<t;i+=1)e.push({timePointIndex:NaN,left:NaN,center:NaN,right:NaN})}class r{constructor(){this._invalidatedFromIndex=0,this._maxIndexWithWeight=null,this._items=[],this._weightsMap=new Map}setWeight(e,t){this._invalidatedFromIndex=Math.min(this._invalidatedFromIndex,e),this._weightsMap.set(e,t),null===this._maxIndexWithWeight?this._maxIndexWithWeight=e:this._maxIndexWithWeight=Math.max(this._maxIndexWithWeight,e)}deleteItemByIndex(e){this._weightsMap.delete(e)&&(this._invalidatedFromIndex=Math.min(this._invalidatedFromIndex,e))}totalWeight(e){if(null===this._maxIndexWithWeight)return e;const t=e%1>=.5?Math.ceil(e):Math.floor(e),i=e-t;if(t>=this._invalidatedFromIndex){const e=this._invalidatedFromIndex;let i=this._items[e-1];const s=Math.min(this._maxIndexWithWeight,t);this._createItems(s);for(let t=e;t<=s;++t)i=this._fillItem(t,i);this._invalidatedFromIndex=s+1}if(t>this._maxIndexWithWeight){return this._items[this._maxIndexWithWeight].barEndTotal+(t-this._maxIndexWithWeight-.5)+i}const s=this._items[t];return s.barCenterTotal+s.weight*i}rangeWeight(e,t){const i=[];if(null===this._maxIndexWithWeight)return[{index:e,barStartTotal:e-.5,barCenterTotal:e,barEndTotal:e+.5,weight:1}];if(e<this._invalidatedFromIndex){const s=Math.min(this._invalidatedFromIndex-1,t);for(let t=e;t<=s;t+=1)i.push(this._items[t])}if(t>=this._invalidatedFromIndex){const s=this._invalidatedFromIndex;let o=this._items[s-1];const r=Math.min(this._maxIndexWithWeight,t);this._createItems(r);for(let t=s;t<=r;++t)o=this._fillItem(t,o),t>=e&&i.push(o);this._invalidatedFromIndex=r+1}return 0===i.length&&i.push(this._items[this._maxIndexWithWeight]),i}index(e){if(null===this._maxIndexWithWeight)return e;if(0!==this._invalidatedFromIndex&&this._items[this._invalidatedFromIndex-1].barEndTotal-.001>=e){const t=(0,
s.lowerbound)(this._items,e,((e,t)=>e.barEndTotal-.001<t),0,this._invalidatedFromIndex),i=this._items[t];return t+(e-i.barCenterTotal)/i.weight}if(this._invalidatedFromIndex<=this._maxIndexWithWeight){const t=this._invalidatedFromIndex;let i=this._items[t-1];this._createItems(this._maxIndexWithWeight);for(let s=t;s<=this._maxIndexWithWeight;++s)if(i=this._fillItem(s,i),i.barEndTotal>e)return this._invalidatedFromIndex=s+1,s+(e-i.barCenterTotal)/i.weight;this._invalidatedFromIndex=this._maxIndexWithWeight+1}const t=this._items[this._maxIndexWithWeight];return this._maxIndexWithWeight+.5+e-t.barEndTotal}state(e){return{maxIndexWithWeight:this._maxIndexWithWeight,items:this._items.slice(),weightsMap:Array.from(this._weightsMap.entries())}}restoreState(e){this._maxIndexWithWeight=e.maxIndexWithWeight,this._items=e.items.slice(),this._weightsMap=new Map(e.weightsMap)}_createItems(e){const t=e-(this._items.length-1);if(t>0){const e=this._items.length;this._items=this._items.concat(Array.from({length:t},((t,i)=>({barStartTotal:1,barCenterTotal:1,barEndTotal:1,weight:1,index:i+e}))))}}_fillItem(e,t){const i=this._items[e],s=this._weightsMap.get(e)??1;return i.weight=s,i.barCenterTotal=void 0===t?0:t.barEndTotal+s/2,i.barStartTotal=i.barCenterTotal-s/2,i.barEndTotal=i.barCenterTotal+s/2,i}}class n{constructor(){this._baseIndex=0,this._preBaseIndexWeights=new r,this._postBaseIndexWeights=new r,this._weightsMap=new Map}setBaseIndex(e){this._baseIndex=e,this._preBaseIndexWeights=new r,this._postBaseIndexWeights=new r;for(const[e,t]of this._weightsMap)this.setWeight(e,t)}indexToTotalWeight(e){const t=e-this._baseIndex;return t<0?-this._preBaseIndexWeights.totalWeight(-t):this._postBaseIndexWeights.totalWeight(t)}totalWeightToIndex(e){return e<0?this._baseIndex-this._preBaseIndexWeights.index(-e):this._baseIndex+this._postBaseIndexWeights.index(e)}clear(){this._preBaseIndexWeights=new r,this._postBaseIndexWeights=new r,this._weightsMap.clear()}setWeight(e,t){const i=e-this._baseIndex;i<=0&&this._preBaseIndexWeights.setWeight(-i,t),i>=0&&this._postBaseIndexWeights.setWeight(i,t),this._weightsMap.set(e,t)}indexRangeToWeights(e,t,i){const s=e-this._baseIndex,r=t-this._baseIndex;let n=0;if(i=i??[],s<0){const e=this._preBaseIndexWeights.rangeWeight(Math.max(1,-r),-s),t=e.length-i.length;t>0&&o(i,t);for(let t=e.length-1;t>=0;t-=1){const s=e[t],o=i[n];o.center=-s.barCenterTotal,o.left=-s.barEndTotal,o.right=-s.barStartTotal,o.timePointIndex=this._baseIndex-s.index,n+=1}}if(r>=0){const e=this._postBaseIndexWeights.rangeWeight(Math.max(0,s),r),t=e.length+n-i.length;t>0&&o(i,t);for(const t of e){const e=i[n];e.center=t.barCenterTotal,e.left=t.barStartTotal,e.right=t.barEndTotal,e.timePointIndex=this._baseIndex+t.index,n+=1}}return i.slice(0,n)}moveData(e){const t=new Map;for(const i of e){const e=this._weightsMap.get(i.old);if(void 0!==e){t.set(i.new,e),this._weightsMap.delete(i.old);const s=i.old-this._baseIndex;s<=0&&this._preBaseIndexWeights.deleteItemByIndex(-s),s>=0&&this._postBaseIndexWeights.deleteItemByIndex(s)}}
for(const[e,i]of t)this.setWeight(e,i)}state(e){return{type:"computed",state:{baseIndex:this._baseIndex,preBaseIndexWeights:this._preBaseIndexWeights.state(e),postBaseIndexWeights:this._postBaseIndexWeights.state(e),weightsMap:Array.from(this._weightsMap.entries())}}}restoreState(e){this._baseIndex=e.state.baseIndex,this._weightsMap=new Map(e.state.weightsMap),this._preBaseIndexWeights.restoreState(e.state.preBaseIndexWeights),this._postBaseIndexWeights.restoreState(e.state.postBaseIndexWeights)}needAdjustingOnDataRestoring(){return!0}}},873073:(e,t,i)=>{"use strict";i.d(t,{dateFormatProperty:()=>l,restoreDateFormatSettingsValue:()=>c});var s=i(950808),o=i(8914),r=i(855303);const n="date_format";function a(){return s.getValue(n,(0,r.defaultDateFormat)())}const l=(0,o.createPrimitiveProperty)(a());function c(){l.setValue((0,r.defaultDateFormat)()),s.remove(n)}s.onSync.subscribe(null,(()=>l.setValue(a()))),l.subscribe(null,(()=>s.setValue(n,l.value())))},407760:(e,t,i)=>{"use strict";i.d(t,{DeferredStudies:()=>n});var s=i(222993);const o=[],r=[];class n{constructor(e){this._studies={},this._deferreds={},this._container=e,o.push(e),r.push(this)}add(e,t){this._deferreds[e]&&(this._deferreds[e].resolve(t),delete this._deferreds[e]),this._studies[e]=t}get(e){return this._studies[e]?Promise.resolve(this._studies[e]):(this._deferreds[e]||(this._deferreds[e]=(0,s.createDeferredPromise)()),this._deferreds[e].promise)}delete(e){delete this._studies[e],delete this._deferreds[e]}reset(){const e=o.indexOf(this._container);~e&&(o.splice(e,1),r.splice(e,1))}static instance(e){const t=o.indexOf(e);return~t?r[t]:new n(e)}static ready(){for(const e of r)if(Object.keys(e._deferreds).length>0)return!1;return!0}}},232339:(e,t,i)=>{"use strict";i.d(t,{EmptyPaneView:()=>s});class s{renderer(e){return null}update(e){}static instance(){return this._instance=this._instance??new s,this._instance}}s._instance=null},45726:(e,t,i)=>{"use strict";i.d(t,{EnvironmentState:()=>o});var s=i(376596);class o{constructor(e,t=!1){this._shift=!1,this._mod=!1,this._alt=!1,void 0!==e&&(this._shift=Boolean(e.shiftKey),this._mod=Boolean((0,s.isMac)()?e.metaKey:e.ctrlKey),this._alt=Boolean(e.altKey)),this._isApiEvent=t}shift(){return this._shift}mod(){return this._mod}alt(){return this._alt}shiftOnly(){return this._shift&&!this._mod&&!this._alt}modOnly(){return this._mod&&!this._shift&&!this._alt}altOnly(){return this._alt&&!this._shift&&!this._mod}modShift(){return this._shift&&this._mod&&!this._alt}isApiEvent(){return this._isApiEvent}static create(e=!1,t=!1,i=!1){return new o({shiftKey:e,ctrlKey:t,metaKey:t,altKey:i})}}},943462:(e,t,i)=>{"use strict";i.d(t,{DateTimeWithTzFormatter:()=>c});var s=i(605678),o=i(837575),r=i(273497),n=i(149274),a=i(540768);const l={dateFormat:"MMM dd",timeFormat:r.hourMinuteFormat};class c{constructor(e={}){const{dateFormat:t,timeFormat:i,timezone:o}={...l,...e};t&&i?this._dateFormatter=new n.DateTimeFormatter({dateFormat:t,timeFormat:i}):t?this._dateFormatter=new a.DateFormatter(t):i&&(this._dateFormatter=new r.TimeFormatter(i)),
this._timezone=(0,s.get_timezone)(o??"Etc/UTC")}format(e){const t=1e3*e,i=(0,o.parseTzOffset)(this._timezone.name(),t).string;return void 0===this._dateFormatter?i:`${this._dateFormatter.format((0,s.utc_to_cal)(this._timezone,t))} ${i}`}setTimezone(e){this._timezone=(0,s.get_timezone)(e)}}},974266:(e,t,i)=>{"use strict";i.d(t,{TimeSpanFormatter:()=>n});var s=i(729193),o=i(128556),r=i(65280);class n{format(e,t){const n=e<0;e=Math.abs(e);const a=Math.floor(e/86400);e-=86400*a;const l=Math.floor(e/3600);e-=3600*l;const c=Math.floor(e/60);e-=60*c;let h="";if(a){const e=(0,r.getNumberFormat)(t?.ignoreLocaleNumberFormat);h+=(0,o.formatNumber)(a,e)+s.t(null,{context:"dates"},i(230492))+" "}return l&&(h+=l+s.t(null,{context:"dates"},i(122053))+" "),c&&(h+=c+s.t(null,{context:"dates"},i(164516))+" "),e&&(h+=e+s.t(null,{context:"dates"},i(262205))+" "),n&&(h="-"+h),h.trim()}}},449206:(e,t,i)=>{"use strict";i.d(t,{FutureBarsPaneView:()=>l});var s=i(185842),o=i(851682),r=i(253443);const n={0:{background:"rgba(242, 54, 69, 0.15)",line:"#F23645"},1:{background:"rgba(255, 152, 0, 0.15)",line:"#FF9800"},2:{background:"rgba(8, 153, 129, 0.15)",line:"#089981"}};class a extends o.MediaCoordinatesPaneRenderer{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}hitTest(){return null}_drawImpl(e){if(null===this._data)return;const t=n[this._data.predictionCode],i=e.context;i.fillStyle=t.background,i.fillRect(Math.max(0,this._data.startX),0,e.mediaSize.width,e.mediaSize.height),i.strokeStyle=t.line,i.beginPath(),i.lineWidth=1;const s=Math.round(this._data.startX);i.moveTo(s,0),i.lineTo(s,e.mediaSize.height),i.stroke()}}class l{constructor(e,t,i,s){this._renderer=new a,this._startX=0,this._series=t,this._timeScale=e,this._lastKnownBarIndex=i,this._direction=s}update(){this._startX=this._timeScale.indexToCoordinate(this._lastKnownBarIndex)+.5*this._timeScale.barSpacing()+1}renderer(){const e=(0,r.barFunction)("close"),t=this._series.data().bars(),i=e((0,s.ensureNotNull)(t.valueAt(this._lastKnownBarIndex))),o=e((0,s.ensureNotNull)(t.last()).value);let n=0;o>i?n=1:o<i&&(n=2);let a=1;return 0!==this._direction&&(a=this._direction===n?2:0),this._renderer.setData({startX:this._startX,predictionCode:a}),this._renderer}}},153599:(e,t,i)=>{"use strict";var s;i.d(t,{CreateLineToolSyncMode:()=>s}),function(e){e[e.Default=0]="Default",e[e.ForceOn=1]="ForceOn",e[e.ForceOff=2]="ForceOff"}(s||(s={}))},870720:(e,t,i)=>{"use strict";var s;i.d(t,{TitleDisplayTarget:()=>s}),function(e){e[e.DataWindow=1]="DataWindow",e[e.StatusLine=2]="StatusLine",e[e.Alerts=3]="Alerts"}(s||(s={}))},781434:(e,t,i)=>{"use strict";var s;i.d(t,{PaneMode:()=>s}),function(e){e[e.Regular=0]="Regular",e[e.Widget=1]="Widget"}(s||(s={}))},167972:(e,t,i)=>{"use strict";function s(e){return Boolean(e.showInObjectTree)}i.d(t,{isDataSource:()=>s})},658273:(e,t,i)=>{"use strict";function s(e){return e.isSeries}i.d(t,{isSeries:()=>s})},516590:(e,t,i)=>{"use strict";i.d(t,{isStudyStrategyStub:()=>o});var s=i(422872);function o(e){return(0,
s.isObject)(e)&&"isStrategyStub"in e&&e.isStrategyStub}},968105:(e,t,i)=>{"use strict";i.d(t,{CircleRenderer:()=>n});var s=i(691069),o=i(141463),r=i(515338);class n{constructor(e){this._data=e??null}setData(e){this._data=e}draw(e,t){if(null===this._data)return;const{center:i,radius:s,lineWidth:o,color:r,backColor:n}=this._data;e.save();const{horizontalPixelRatio:a,verticalPixelRatio:l}=t,c=Math.max(1,Math.floor(a)),h=c%2/2,d=Math.round(i.x*a)+h,u=Math.round(i.y*l)+h,_=Math.round(d+s*a),p=Math.max(1,Math.floor(o*a)),m=_-d-p;m>0&&(e.fillStyle=n,e.beginPath(),e.moveTo(d+m,u),e.arc(d,u,m,0,2*Math.PI,!1),e.fill());const g=Math.max(c/2,_-d-p/2);e.strokeStyle=r,e.lineWidth=p,e.beginPath(),e.moveTo(d+g,u),e.arc(d,u,g,0,2*Math.PI,!1),e.stroke(),e.restore()}hitTest(e){if(null===this._data||this._data.disableInteractions)return null;const{center:t,radius:i,backgroundHitTarget:n}=this._data,a=(0,r.interactionTolerance)().curve;if(!(0,s.pointInCircle)(e,t,i+a))return null;const l=i>a&&(0,s.pointInCircle)(e,t,i-a)?n??o.HitTarget.MovePointBackground:o.HitTarget.MovePoint;return new o.HitTestResult(l)}}},35289:(e,t,i)=>{"use strict";i.d(t,{createIdeaLineToolByUrl:()=>m,isIdeaAuthorProfileImageUrl:()=>_,isIdeaUrl:()=>u});var s=i(185842),o=i(950808),r=i(133674),n=i(584104),a=i(808463),l=i(241181);const c=/^\/chart\/.+?\/([0-9a-zA-Z]{8})(-[-\w]+)?\/?$/;const h=e=>"https:"===e.protocol&&e.hostname.endsWith(".tradingview.com"),d=e=>!(0,r.isProd)()&&e.hostname.endsWith(window.location.hostname);function u(e){try{const t=new URL(e);return(h(t)||d(t))&&c.test(t.pathname)}catch(e){return!1}}function _(e){if(e.startsWith("data:image/svg+xml,"))return!0;try{const t=new URL(e),i=new URL(window.AWS_S3_CDN);return t.protocol===i.protocol&&t.hostname===i.hostname&&t.pathname.includes("/userpics/")}catch(e){return!1}}async function p(e){const t=new URL(`/api/v1/ideas/${i=e,(0,s.ensureNotNull)(c.exec(new URL(i).pathname))[1]}/`,location.href);var i;return fetch(t.toString()).then((e=>{if(!e.ok)throw new Error(`Error processing idea: ${e.statusText}`);return e.json()}))}async function m(e,t,i=!1){const r=await(0,l.getLineTool)("LineToolIdea");return p(e).then((async e=>{const l=function(e){const t=(0,s.ensureDefined)(e.user);let i;t.avatars&&_(t.avatars.small)&&(i=t.avatars.small.startsWith("data:image/svg+xml,")?t.avatars.small:`${t.avatars.small.replace(window.AWS_S3_CDN,"")}?resetCache=true`);const o={avatarUrl:i,badges:t.badges?.map((e=>e.name)),username:t.username};return{createdAt:e.created_timestamp,direction:e.direction,name:(0,a.clean)(e.name,!0),author:o,uuid:e.uuid}}(e),c={price:0,time_t:l.createdAt,offset:0},h=t.mainSeries(),d=(0,s.ensureNotNull)(t.model().paneForSource(h)),u=d.newLineToolZOrder(!0),p=r.createProperties(t.model().backgroundTheme().spawnOwnership()),m=p.state();p.destroy(),m.interval||(m.interval="1");const g={type:"drawing",source:{id:(0,n.randomHashN)(6),zorder:u,type:"LineToolIdea",position:50,state:m,ideaData:l,symbol:h.symbol(),ownerSource:h.id(),points:[c]},geometry:[],modelId:t.model().id()
},S=await t.pasteLineTool(d,g,!0,!0);return i&&o.setValue("hint.pasteIdea",!0,{forceFlush:!0}),S.pointAdded().subscribe(null,(()=>t.scrollToLineTool(S)),!0),S}))}},545672:(e,t,i)=>{"use strict";i.d(t,{blobImageFilter:()=>_,checkImageSize:()=>g,generateLink:()=>m,getMaxImageSizeInBytes:()=>v,getMaxImageSizeLabel:()=>f,imageIsOversized:()=>p,uploadImage:()=>S});var s=i(425860),o=i(131890),r=i(729193),n=i(77357);const a="/charts/uploads/generate-link/",l=(0,s.size)({width:2e3,height:2e3});function c(e){return e.width>l.width||e.height>l.height}const h=(0,n.getLogger)("Chart.Uploader");async function d(e){const t=new FormData,i="name"in e?e.name:"image.png";t.append("content_type",e.type),t.append("filename",i),t.append("size",""+e.size);try{const e=await(0,o.fetch)(a,{method:"POST",body:t});if(!e.ok)throw new Error(`Error generating upload link: ${e.status}`);return e.json()}catch(t){throw h.logError(`Error generating upload link: ${t}. blob.type: ${e.type} blob.size: ${e.size} filename: ${i}`),t}}async function u(e){return new Promise(((t,i)=>{const s=new FileReader;s.onload=e=>{const s=new Image;s.src=e.target?.result,s.onload=()=>{t(!c(s))},s.onerror=i},s.onerror=i,s.readAsDataURL(e)}))}function _(e){return"image/png"===e.type||"image/jpeg"===e.type||"image/webp"===e.type}function p(e){return c(e)}async function m(e){return d(e)}async function g(e){return u(e)}async function S(e){return async function(e){if(!await u(e))throw new Error(r.t(null,void 0,i(601703)));try{const t=await d(e),i=t.data.fields,s=new FormData;for(const e of Object.keys(i))s.append(e,i[e]);s.append("file",e);const r=await(0,o.fetch)(t.data.url,{method:"POST",body:s});if(r.ok)return t.data.url+t.filepath;throw new Error(`Upload response is not ok: ${r.status}`)}catch(e){throw new Error(`Error uploading image: ${e.message}`)}}(e)}function v(){return 2e6}function f(){return"2MB"}},791401:(e,t,i)=>{"use strict";i.d(t,{createTweetLineToolByUrl:()=>u,isTwitterProfileImageUrl:()=>d,isTwitterUrl:()=>h});var s=i(185842),o=i(950808),r=i(584104),n=i(808463),a=i(788312),l=i(241181);const c=(0,a.isFeatureEnabled)("mock_tweet_data_for_tests");function h(e){try{const t=new URL(e);return("twitter.com"===t.hostname||t.hostname.endsWith(".twitter.com")||"x.com"===t.hostname||t.hostname.endsWith(".x.com"))&&"https:"===t.protocol}catch(e){return!1}}function d(e){try{const t=new URL(e);return"pbs.twimg.com"===t.hostname&&"https:"===t.protocol&&t.pathname.startsWith("/profile_images/")}catch(e){return!1}}async function u(e,t,i=!1){const a=await(0,l.getLineTool)("LineToolTweet");return async function(e){if(c)return{id:0x853cb08cfe8b,created_at:1768200221,text:" \r\rAlways do your own research.",username:"tradingview",user:"TradingView",profile_image_url:"https://pbs.twimg.com/profile_images/1598328471729704963/D7slFVZN_400x400.jpg",tweet_url:"https://twitter.com/tradingview/status/1464957065621872641?s=20"};const t=new URL("/api/v1/get-tweet-data/",location.href);return t.searchParams.append("tweet_url",e),fetch(t.toString()).then((e=>{
if(!e.ok)throw new Error(`Error processing tweet: ${e.statusText}`);return e.json()}))}(e).then((async l=>{const c=function(e,t){return{id:e.id,createdAt:e.created_at,text:(0,n.clean)(e.text,!0),username:`@${e.username}`,user:e.user,profileImageUrl:e.profile_image_url,tweetUrl:e.tweet_url??t}}(l,e),h={price:0,time_t:c.createdAt,offset:0},d=t.mainSeries(),u=(0,s.ensureNotNull)(t.model().paneForSource(d)),_=u.newLineToolZOrder(!0),p=a.createProperties(t.model().backgroundTheme().spawnOwnership()),m=p.state();p.destroy(),m.interval||(m.interval="1");const g={type:"drawing",source:{id:(0,r.randomHashN)(6),zorder:_,type:"LineToolTweet",position:50,state:m,tweetData:c,symbol:d.symbol(),ownerSource:d.id(),points:[h]},geometry:[],modelId:t.model().id()},S=await t.pasteLineTool(u,g,!0,!0);return i&&o.setValue("hint.pasteTweet",!0,{forceFlush:!0}),S.pointAdded().subscribe(null,(()=>t.scrollToLineTool(S)),!0),S}))}},478420:(e,t,i)=>{"use strict";i.d(t,{RectangleRenderer:()=>u});var s=i(185842),o=i(657415),r=i(691069),n=i(717086),a=i(275925),l=i(141463),c=i(575199),h=i(138264),d=i(550837);class u extends d.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=null,this._forceOverrideTransparency=Boolean(e)}setData(e){this._data=e}hitTest(e,t){if(null===this._data||this._data.points.length<2||this._data.disableInteractions)return null;const i=t.mediaSize.width,s=(0,o.box)(...this._data.points),r=s.min,a=s.max,c=new o.Point(a.x,r.y),h=new o.Point(r.x,a.y),d=this._extendAndHitTestLineSegment(e,r,c,i);if(null!==d)return d;const u=this._extendAndHitTestLineSegment(e,h,a,i);if(null!==u)return u;let _=(0,n.distanceToSegment)(c,a,e);if(_.distance<=3)return new l.HitTestResult(l.HitTarget.MovePoint);if(_=(0,n.distanceToSegment)(r,h,e),_.distance<=3)return new l.HitTestResult(l.HitTarget.MovePoint);if(this._data.middleLine){const t=s.min.add(s.max).scaled(.5),r=this._extendAndHitTestLineSegment(e,new o.Point(s.min.x,t.y),new o.Point(s.max.x,t.y),i);if(null!==r)return r}return this._data.fillBackground?this._hitTestBackground(e,r,a,i):null}getColor(){const e=(0,s.ensure)(this._data);return void 0===e.transparency?e.backcolor:(0,a.generateColor)(e.backcolor,e.transparency,this._forceOverrideTransparency)}visibleRectSegment(e){const t=this._data;if(null===t)return null;const i=(0,o.box)(...t.points),s=i.min,r=i.max,n=e.width,a=e.height,l=t.extendLeft?0:Math.max(s.x,0),c=t.extendRight?n:Math.min(r.x,n);if(l>c||c<=0||l>=n)return null;const h=Math.max(s.y,0),d=Math.min(r.y,a);return h>d||d<=0||h>a?null:[new o.Point(l,h),new o.Point(c,d)]}_drawImpl(e){if(null===this._data||this._data.points.length<2||this._data.linewidth<=0&&!this._data.fillBackground)return;const{horizontalPixelRatio:t,verticalPixelRatio:i,bitmapSize:s}=e,{extendLeft:r,extendRight:n,linewidth:a,middleLine:l}=this._data,d=(0,
o.box)(...this._data.points),u=this._data.linewidth?Math.max(1,Math.floor(this._data.linewidth*t)):0,_=this._data.fillBackground?this.getColor():void 0,p=Math.max(1,Math.floor(t)),m=r?-a:Math.round(d.min.x*t),g=n?s.width+a:Math.round(d.max.x*t),S=Math.round(d.min.y*i),v=Math.round(d.max.y*i);(0,h.fillRectWithBorder)(e,m,S,g,v,p,void 0===_?void 0:{color:_},0===u?void 0:{color:this._data.color,lineStyle:this._data.linestyle??c.LineStyle.Solid,borderWidth:u,borderMode:"center",rightToLeftStroke:r&&!n},l?{...l,lineWidth:Math.max(1,Math.floor(l.lineWidth*i))}:void 0)}_extendAndHitTestLineSegment(e,t,i,s){const o=this._extendAndClipLineSegment(t,i,s);if(null!==o){if((0,n.distanceToSegment)(o[0],o[1],e).distance<=3)return new l.HitTestResult(l.HitTarget.MovePoint)}return null}_extendAndClipLineSegment(e,t,i){const r=(0,s.ensureNotNull)(this._data);if((0,o.equalPoints)(e,t)&&!r.extendLeft&&!r.extendRight)return null;const n=Math.min(e.x,t.x),a=Math.max(e.x,t.x),l=r.extendLeft?0:Math.max(n,0),c=r.extendRight?i:Math.min(a,i);return l>c||c<=0||l>=i?null:[new o.Point(l,e.y),new o.Point(c,t.y)]}_hitTestBackground(e,t,i,s){const n=this._extendAndClipLineSegment(t,i,s);return null!==n&&(0,r.pointInBox)(e,(0,o.box)(n[0],n[1]))?new l.HitTestResult(this._data?.backgroundHitTarget??l.HitTarget.MovePointBackground):null}}},669899:(e,t,i)=>{"use strict";i.d(t,{TrendLineRenderer:()=>_,drawArrow:()=>u});var s=i(185842),o=i(717086),r=i(603581),n=i(141463),a=i(138264),l=i(515338),c=i(320093),h=i(515834);function d(e,t,i,s,o){t.save(),t.fillStyle="#000000",t.beginPath(),t.arc(e.x*o,e.y*o,i*o,0,2*Math.PI,!1),t.fill(),s.strokeWidth&&(t.lineWidth=s.strokeWidth,t.stroke()),t.restore()}function u(e,t,i,s,o,r=!1){if(t.subtract(e).length()<1)return;const n=(0,l.getArrowPoints)(e,t,s,r,!0).slice(0,2);let a=null;const{horizontalPixelRatio:c,verticalPixelRatio:h}=o;for(let e=0;e<n.length;++e){const t=n[e][0],s=n[e][1];(null===a||a.subtract(t).length()>1)&&i.moveTo(t.x*c,t.y*h),i.lineTo(s.x*c,s.y*h),a=s}}class _{constructor(){this._data=null,this._hittest=new n.HitTestResult(n.HitTarget.MovePoint)}setData(e){this._data=e}setHitTest(e){this._hittest=e}draw(e,t){const i=this._data;if(null===i)return;if("points"in i&&i.points.length<2)return;const{horizontalPixelRatio:s}=t;if(void 0!==i.excludeBoundaries){e.save();for(const s of i.excludeBoundaries)(0,c.addExclusionArea)(e,t,s)}const{linestyle:o,lineCap:r=(o===h.LINESTYLE_SOLID?"round":"butt")}=i;e.lineCap=r,e.lineJoin="round",e.strokeStyle=i.color,e.lineWidth=Math.max(1,Math.floor(i.linewidth*s)),(0,a.setLineStyle)(e,o);const n=i.points[0],l=i.points[1];let d=[];e.beginPath(),i.overlayLineEndings?d=[n.clone(),l.clone()]:this._drawEnds(e,[n,l],i.linewidth,t);const u=this._extendAndClipLineSegment(n,l,t);null!==u&&i.linewidth>0&&(0,a.addPixelPerfectLineToPath)(e,u[0].x,u[0].y,u[1].x,u[1].y,t),i.overlayLineEndings&&this._drawEnds(e,d,i.linewidth,t),e.stroke(),void 0!==i.excludeBoundaries&&e.restore()}hitTest(e,t){const i=this._data;if(null===i)return null;if("points"in i&&i.points.length<2)return null
;const s=(i.hitTestTolerance??(0,l.interactionTolerance)().line)+i.linewidth/2,r=i.points[0],n=i.points[1],a=this._extendAndClipLineSegment(r,n,t);if(null!==a){if((0,o.distanceToSegment)(a[0],a[1],e).distance<=s)return this._hittest}return null}_extendAndClipLineSegment(e,t,i){const o=(0,s.ensureNotNull)(this._data);return(0,l.extendAndClipLineSegment)(e,t,i.mediaSize.width,i.mediaSize.height,o.extendleft,o.extendright)}_drawEnds(e,t,i,o){const n=t[0],a=t[1],l=(0,s.ensureNotNull)(this._data);switch(l.leftend){case r.LineEnd.Arrow:u(a,n,e,i,o);break;case r.LineEnd.Circle:d(n,e,i,(0,s.ensureDefined)(l.endstyle),o.horizontalPixelRatio)}switch(l.rightend){case r.LineEnd.Arrow:u(n,a,e,i,o);break;case r.LineEnd.Circle:d(a,e,i,(0,s.ensureDefined)(l.endstyle),o.horizontalPixelRatio)}}}},923242:(e,t,i)=>{"use strict";i.d(t,{ProjectionSeriesPriceAxisView:()=>l});var s=i(185842),o=i(115676),r=i(700387),n=i(540089),a=i(275925);class l extends r.SeriesPriceAxisView{lastPrice(){return this._getSource().data().lastProjectionPrice}_updateRendererData(e,t,i){e.visible=!1,t.visible=!1;const r=this._getModel(),l=this._getSource(),c=l.priceScale(),h=r.timeScale(),d=this.lastPrice();if(h.isEmpty()||c.isEmpty()||void 0===d)return;const u=h.visibleBarsStrictRange();if(null===u)return;const _=u.firstBar(),p=u.lastBar(),m=l.data(),g=m.search(p,o.PlotRowSearchMode.NearestLeft);if(null===g)return;const S=l.nearestIndex(_,o.PlotRowSearchMode.NearestRight);if(void 0===S)return;const v=l.model().properties().childs().scalesProperties.childs(),f=(0,s.ensureNotNull)(m.valueAt(S))[4];let b=i.background,y=v.showSeriesLastValue.value(),w=!1,C=!1,T=!1;const P=l.lastValueData(4,!1),M=l.properties().childs();if(8===M.style.value()&&M.haStyle.childs().showRealLastPrice.value()){const e=l.lastValueData(4,!0);if(e.noData||e.color===i.background||(b=(0,a.resetTransparency)(e.color)),!e.noData&&!P.noData){const t=e.index===P.index;w=t&&v.showSymbolLabels.value(),C=v.seriesLastValueMode.value()===n.PriceAxisLastValueMode.LastPriceAndPercentageValue,y=y&&t,T=t&&this._isCountdownEnabled()&&M.showCountdown.value()}}else{const e=l.barColorer().barStyle(g.index,!0);b=(0,a.resetTransparency)(e.barColor)}if(i.background=b,i.textColor=this.generateTextColor(b),i.secondLineTextColor=i.textColor,i.thirdLineTextColor=(0,a.generateColor)(i.textColor,25),i.coordinate=c.priceToCoordinate(d,f),e.visible=y||T,!P.noData){const i=l.priceScale().isPercentage();P.formattedPriceAbsolute=c.formatPriceAbsolute(d),P.formattedPricePercentage=c.formatPricePercentage(d,f,{signPositive:!0}),P.text=i?P.formattedPricePercentage:P.formattedPriceAbsolute,e.text=this._axisFirstLineText(P,y),e.secondLine=y&&C?i?P.formattedPriceAbsolute:P.formattedPricePercentage:"",e.thirdLine=T?this._countdownText():"",t.text=this._paneText(w)}t.visible=w,e.selectedMarkColor=r.selection().isSelected(l)?b:void 0}}},954863:(e,t,i)=>{"use strict";i.d(t,{compareResolutions:()=>a,getApplicableIntervalForFrequency:()=>l,maxResolutionValues:()=>o});var s=i(357966);const o={[s.ResolutionKind.Ticks]:1,
[s.ResolutionKind.Seconds]:60,[s.ResolutionKind.Minutes]:1440,[s.SpecialResolutionKind.Hours]:24,[s.ResolutionKind.Days]:365,[s.ResolutionKind.Weeks]:52,[s.ResolutionKind.Months]:12,[s.ResolutionKind.Range]:1e6,[s.ResolutionKind.Invalid]:NaN},r={[s.ResolutionKind.Ticks]:0,[s.ResolutionKind.Seconds]:1,[s.ResolutionKind.Minutes]:2,[s.SpecialResolutionKind.Hours]:3,[s.ResolutionKind.Days]:4,[s.ResolutionKind.Weeks]:5,[s.ResolutionKind.Months]:6,[s.ResolutionKind.Range]:7,[s.ResolutionKind.Invalid]:8};function n(e){const t=s.Interval.parse(e),i=t.multiplier()||1;return t.isMinuteHours()?[s.SpecialResolutionKind.Hours,i/60]:[t.kind(),i]}function a(e,t){if(e===t)return 0;const[i,s]=n(e),[o,a]=n(t);return i!==o?r[i]-r[o]:s-a}function l(e,t){return a(t,e)>=0?t:e}},958734:(e,t,i)=>{"use strict";i.d(t,{allPriceScaleSelectionStrategyInfo:()=>c,createPriceScaleSelectionStrategy:()=>l});var s=i(185842),o=i(729193),r=i(44408);class n{constructor(e){this._priceScalesLimit=8,this._metaInfo=e}metaInfo(){return this._metaInfo}findSuitableScale(e,t,i,s){if(void 0!==s)return this._tryToGetDesiredPriceScale(e,t,s,i);if((0,r.isStudy)(t)){const s=t.metaInfo();if("Volume"===s.shortId&&e.containsMainSeries())return e.createPriceScaleAtPosition("overlay");const o=t.desiredPriceScalePosition();if(null!==o)return this._tryToGetDesiredPriceScale(e,t,o,i);if(void 0!==i&&((0,r.isStudy)(i)||e.isMainPane().value())&&s.is_price_study)return this._getPriceScaleTheSameAsForSource(i,e)}let o=!1;if((0,r.isStudy)(t)){const i=t.metaInfo().groupingKey;if(void 0!==i){const t=e.model().findNonOverlayStudyWithGroupingKey(i,e);if(null!==t)return this._getPriceScaleTheSameAsForSource(t.study,t.pane)}o=Boolean(t.metaInfo().is_price_study)}else t===e.model().mainSeries()&&(o=!0);if(o){const t=this._findFirstScaleForPriceStudy(e);if(null!==t)return t}return this.createNewPriceScaleIfPossible(e)}canCreateNewPriceScale(e){return e.leftPriceScales().length+e.rightPriceScales().length<this._priceScalesLimit}_getPriceScaleTheSameAsForSource(e,t){return t.isOverlay(e)?t.createPriceScaleAtPosition("overlay"):(0,s.ensureNotNull)(e.priceScale())}_priceScaleIsPrice(e,t){const i=e.mainSource();return!!i&&(i===t.mainSeries()||!!(0,r.isStudy)(i)&&Boolean(i.metaInfo().is_price_study))}_findFirstScaleForPriceStudy(e){const t=e.model();for(let i=0;i<this._priceScalesLimit;i++){if(e.rightPriceScales().length>i&&this._priceScaleIsPrice(e.rightPriceScales()[i],t))return e.rightPriceScales()[i];if(e.leftPriceScales().length>i&&this._priceScaleIsPrice(e.leftPriceScales()[i],t))return e.leftPriceScales()[i]}return null}_targetPriceScaleIndex(e,t){if(e.mainSource()===t.mainSeries())return 0}_tryToGetDesiredPriceScale(e,t,i,o){switch(i){case"left":return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("left"):e.createPriceScaleAtPosition("overlay");case"right":return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("right"):e.createPriceScaleAtPosition("overlay");case"as-series":return void 0!==o?(0,s.ensureNotNull)(o.priceScale()):e.isMainPane().value()?(0,
s.ensureNotNull)((0,s.ensureNotNull)(e.mainDataSource()).priceScale()):this.createNewPriceScaleIfPossible(e);case"overlay":return e.createPriceScaleAtPosition("overlay")}}}const a=[{name:"left",title:o.t(null,void 0,i(37905)),ctor:class extends n{constructor(e){super(e)}apply(e){const t=e.model();e.rightPriceScales().slice(0).forEach((i=>e.movePriceScale(i,"left",this._targetPriceScaleIndex(i,t))))}createNewPriceScaleIfPossible(e){return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("left"):e.createPriceScaleAtPosition("overlay")}}},{name:"right",title:o.t(null,void 0,i(279977)),ctor:class extends n{constructor(e){super(e)}apply(e){const t=e.model();e.leftPriceScales().slice(0).forEach((i=>e.movePriceScale(i,"right",this._targetPriceScaleIndex(i,t))))}createNewPriceScaleIfPossible(e){return this.canCreateNewPriceScale(e)?e.createPriceScaleAtPosition("right"):e.createPriceScaleAtPosition("overlay")}}},{name:"auto",title:o.t(null,void 0,i(228013)),ctor:class extends n{constructor(e){super(e)}apply(e){if(e.containsMainSeries()){const t=(0,s.ensureNotNull)((0,s.ensureNotNull)(e.mainDataSource()).priceScale());e.movePriceScale(t,"right",0)}const t=e.model();for(;e.leftPriceScales().length>e.rightPriceScales().length;){const i=e.leftPriceScales()[e.leftPriceScales().length-1];e.movePriceScale(i,"right",this._targetPriceScaleIndex(i,t))}for(;e.rightPriceScales().length-e.leftPriceScales().length>1;){const i=e.rightPriceScales()[e.rightPriceScales().length-1];e.movePriceScale(i,"left",this._targetPriceScaleIndex(i,t))}}createNewPriceScaleIfPossible(e){if(!this.canCreateNewPriceScale(e))return e.createPriceScaleAtPosition("overlay");const t=e.leftPriceScales().length<e.rightPriceScales().length?"left":"right";return e.createPriceScaleAtPosition(t)}}}];function l(e){const t=(0,s.ensureDefined)(a.find((t=>t.name===e)));return new t.ctor(t)}function c(){return a}},52623:(e,t,i)=>{"use strict";i.d(t,{chartStylePermissions:()=>s});const s=new Map([[18,{feature:"TPO_PERIODIC",featureName:"TPOChartStyle"}],[17,{feature:"VOLUME_FOOTPRINT",featureName:"volumeFootprint"}],[19,{feature:"VOLUME_CANDLES",featureName:"volumeCandles"}],[20,{feature:"SESSION_VOLUME_PROFILE",featureName:"SVPChartStyle"}]])},622767:(e,t,i)=>{"use strict";i.d(t,{PrevCloseSeriesPriceAxisView:()=>n});var s=i(816570),o=i(323197),r=i(275925);class n extends s.PriceAxisView{constructor(e,t){super(),this._source=e,this._model=t}_updateRendererData(e,t,i){e.visible=!1;const s=this._source;if(!this._model.properties().childs().scalesProperties.childs().showSeriesPrevCloseValue.value()||this._model.isInReplay().value())return;if(s.isDWM())return;const n=s.prevClose();if(null===n)return;const a=(0,r.resetTransparency)(this._source.properties().childs().prevClosePriceLineColor.value());i.background=a,i.textColor=this.generateTextColor(a),i.coordinate=n.coordinate,e.text=(0,o.getCurrentModePriceText)(s.priceScale(),n),e.visible=!0,e.selectedMarkColor=this._model.selection().isSelected(this._source)?a:void 0}}},700387:(e,t,i)=>{"use strict";i.d(t,{
SeriesPriceAxisView:()=>v});var s=i(185842),o=i(266150),r=i(275925),n=(i(357966),i(816570)),a=i(540089),l=i(605678),c=i(888988);function h(e,t=Date.now()/1e3){let i=Math.ceil(e-t);if(i<=0)return"";if(i<3600){const e=Math.floor(i/60),t=Math.ceil(i%60);return`${(0,c.addLeadingZero)(e)}:${(0,c.addLeadingZero)(t)}`}if(i<86400){const e=Math.floor(i/3600);i%=3600;const t=Math.floor(i/60);i%=60;const s=Math.ceil(i);return`${(0,c.addLeadingZero)(e)}:${(0,c.addLeadingZero)(t)}:${(0,c.addLeadingZero)(s)}`}{const s=new Date(1e3*e),o=new Date(1e3*t),r=(0,l.get_year)(s),n=(0,l.get_year)(o),a=(0,l.get_month)(s),c=(0,l.get_month)(o),h=(0,l.get_day_of_month)(o),u=d(s)-d(o)>=0?0:-1;let _=12*(r-n)+(a-c)+u;if(_>0){const t=(0,l.get_days_in_month)(c,n);!function(e,t){const i=(0,l.get_day_of_month)(e);e.setUTCMonth((0,l.get_month)(e)+t),(0,l.get_day_of_month)(e)!==i&&e.setUTCDate(0)}(o,_);const i=(0,l.get_days_in_month)((0,l.get_month)(o),(0,l.get_year)(o)),s=h!==t&&i===(0,l.get_day_of_month)(o)?t-h:0;let r=Math.ceil((e-o.getTime()/1e3)/86400)+s;return r>=i&&(_++,r=0),`${_}M ${r}d`}if(-1===u){if((0,l.get_days_in_month)(c,n)-i/86400<1/24)return"1M 0d"}let p=Math.floor(i/86400);i%=86400;let m=Math.ceil(i/3600);return 24===m&&(m=0,p+=1),p===(0,l.get_days_in_month)(a,r)?"1M 0d":`${p}d ${m}h`}}function d(e){return 86400*e.getUTCDate()+3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()}var u=i(70346),_=i(323197),p=i(316746);const m=(0,o.isFeaturesetEnabled)("force_exchange_as_title"),g=(0,o.isFeaturesetEnabled)("chart_style_hilo_last_price");const S={alwaysShowGlobalLast:!1,visibleOnHistoryOnly:!1,showCountdown:!0,showSymbolLabel:!0,useSolidBodyColor:!0};class v extends n.PriceAxisView{constructor(e,t,i){super(),this._previousCountdown="",this._source=e,this._model=t,this._options={...S,...i}}updateCountdown(){this._countdownText()!==this._previousCountdown&&(this.update((0,p.sourceChangeEvent)(this._source.id())),this._model.updateSourcePriceScale(this._source))}_getSource(){return this._source}_getModel(){return this._model}_isCountdownEnabled(){return this._options.showCountdown}_countdownText(){{const e=this._source.barCloseTime();return null===e?"":h(e,this._currentTime()/1e3)}}_updateRendererData(e,t,i){if(e.visible=!1,t.visible=!1,!this._source.isVisible())return;const o=this._source.properties().childs();if(!g&&12===o.style.value())return;const n=this._model.timeScale().visibleBarsStrictRange(),l=this._source.data().last();if(null===n||null===l)return;if(this._options.visibleOnHistoryOnly&&n.contains(l.index))return;const c=this._model.properties().childs().scalesProperties.childs();let h=c.showSeriesLastValue.value(),d=this._isCountdownEnabled()&&o.showCountdown.value()&&(12===(p=o.style.value())?g:(0,u.isTimeBasedStyle)(p))&&(this._options.alwaysShowGlobalLast||n.contains(l.index));var p;let m=this._options.showSymbolLabel&&c.showSymbolLabels.value();const S=c.seriesLastValueMode.value()===a.PriceAxisLastValueMode.LastPriceAndPercentageValue,v=this._source.lastValueData(void 0,this._options.alwaysShowGlobalLast)
;if(v.noData)return;const f=8===o.style.value();if((h||d||m)&&f&&o.haStyle.childs().showRealLastPrice.value()){const e=this._source.lastValueData(void 0,!1),t=this._source.lastValueData(void 0,!0);e.noData||t.noData||e.index!==t.index||(h=!1,d=!1,m=!1)}const b=(0,r.resetTransparency)(this._source.priceLineColor(v.color));if(this._options.useSolidBodyColor?(i.background=b,i.borderColor=void 0):(i.background=this._model.backgroundColorAtYPercentFromTop((i.fixedCoordinate??i.coordinate)/(0,s.ensureNotNull)(this._model.paneForSource(this._source)).height()),i.borderColor=b),i.coordinate=v.coordinate,h||d){const t=this._axisFirstLineText(v,h);e.text=t,this._options.useSolidBodyColor?(i.textColor=this.generateTextColor(i.background),e.borderVisible=!1):(e.borderVisible=!0,i.textColor=b),e.textColor=i.textColor;const s=h&&S?(0,_.getOppositeModePriceText)(this._source.priceScale(),v):"";e.secondLine=s,i.secondLineTextColor=i.textColor;const o=d?this._countdownText():"";this._previousCountdown=o,e.thirdLine=o,i.thirdLineTextColor=(0,r.generateColor)(i.textColor,25),0===t.length&&0===s.length&&0===o.length||(e.visible=!0)}m&&(t.text=this._paneText(m),t.visible=t.text.length>0),e.selectedMarkColor=this._model.selection().isSelected(this._source)?b:void 0}_paneText(e){let t="";const i=this._source.aliasSymbolInfo();return m?t=(0,u.displayedSymbolExchange)(i):e&&(t=(0,u.displayedSymbolName)(i)),t}_axisFirstLineText(e,t){return t?(0,_.getCurrentModePriceText)(this._source.priceScale(),e):""}_currentTime(){return window.ChartApiInstance.serverTime()}}},90885:(e,t,i)=>{"use strict";i.d(t,{SeriesStudiesBindings:()=>V});var s=i(875500),o=i(385955),r=i(834905),n=i(185842),a=i(729193),l=i(913947),c=i(316746);class h{constructor(e){this._study=null,this._destroyStudy=null,this._onStatusChanged=new s.Delegate,this._series=e}destroy(){this._destroyStudy?.()}properties(){return this._study?.properties().childs()}paneViews(e){return this._study?.paneViews(e)??[]}widgetSideAreaViews(e){return this._study?.widgetSideAreaViews?.(e)??null}stop(){this._study?.stop()}restart(){this._study?.restart?.(!0)}moveData(e){this._study?.moveData?.(e)}clearData(){this._study?.clearData()}updateAllViews(e){this._study?.updateAllViews(e)}async syncStudy(e){if(e===this.requiredStyle()){this._destroyStudy?.();const e=new AbortController;let t;this._destroyStudy=()=>{e?.abort()};try{t=await this._createStudy(e.signal)}catch{return}this._study=t,this._applySeriesPropertiesToStudy(),t.properties().subscribe(this,this._applyStudyPropertiesToSeries),this._applyStudyPropertiesToSeries();const i=e=>{this._status=e,this._onStatusChanged.fire()};t.onStatusChanged().subscribe(this,i),i(t.status());const s=this._series.model().alertsWatcher();s?.syncSourceAlertLabels(t),this._destroyStudy=()=>{t.properties().unsubscribeAll(this),t.onStatusChanged().unsubscribeAll(this),t.stop(),t.destroy?.(),this._status=void 0,this._onStatusChanged.fire(),this._study=null,this._destroyStudy=null,s?.removeSourceAlertLabels(t)},
this._series.style()===this.requiredStyle()&&this._study.start()}else this._destroyStudy?.()}wasCompletedBefore(){return Boolean(this._study?.wasCompletedBefore())}status(){return this._status}onStatusChanged(){return this._onStatusChanged}legendValuesProvider(){return null}dataWindowValuesProvider(){return null}tableViewValuesProvider(){return null}state(e){return{}}restoreState(e,t){}priceRange(e){return this._study?.priceRange({...e,scaleSeriesOnly:!1,targetPriceScale:this._series.priceScale()})??null}autoScaleInfo(e){return this._study?.autoScaleInfo(e)}requestMoreDataIndex(){return null}study(){return this._study}}class d extends h{constructor(){super(...arguments),this._updateSummaryVisibility=()=>{const e=this._series.model();if(e.isInRestoreState())return;const t=this._isSummaryPaneVisible(),i=this._getSummaryDataSource();t&&this._series.style()===this.requiredStyle()?t&&!i&&this._createSummaryPane():i&&e.removeSource(i)},this._saveSummaryPosition=()=>{const e=this._series.model(),t=this._getSummaryDataSource();if(!t)return;const i=e.paneForSource(t),s=e.paneForSource(this._series);if(!i||!s)return;const o=e.panes().indexOf(s),r=e.panes().indexOf(i);this._getSummaryPanePositionProperty().setValue(r>o)},this._updateSummaryInfo=()=>{const e=this._series.model();if(e.isInRestoreState())return;const t=this._getSummaryDataSource();if(!t)return;const i=e.paneForSource(t);i&&e.recalculatePane(i,(0,c.sourceChangeEvent)(t.id()))}}async syncStudy(e){await super.syncStudy(e);const t=this.study();if(t&&(this._series.model().onRearrangePanes().subscribe(this,this._saveSummaryPosition),this._subscribeToPropertiesThatAffectVisibility(),setTimeout((()=>this._updateSummaryVisibility()),0),this._applyStateToStudy(),t.onDataUpdated().subscribe(this,this._updateSummaryInfo),this._destroyStudy)){const e=this._destroyStudy;this._destroyStudy=()=>{e(),this._series.model().onRearrangePanes().unsubscribeAll(this),this._unsubscribeFromPropertiesThatAffectVisibility(),t.onDataUpdated().unsubscribeAll(this)}}}}var u=i(496934),_=i(123817),p=i(582569),m=i(978802),g=i(386228),S=i(115676),v=i(502643),f=i(920948),b=i(592893);const y={exchange:"Exchange","America/Argentina/Buenos_Aires":"America/Argentina/Buenos Aires","America/El_Salvador":"America/El Salvador","America/Los_Angeles":"America/Los Angeles","America/Mexico_City":"America/Mexico City","America/New_York":"America/New York","America/Sao_Paulo":"America/Sao Paulo","Asia/Ho_Chi_Minh":"Asia/Ho_Chi Minh","Asia/Hong_Kong":"Asia/Hong Kong","Asia/Kuala_Lumpur":"Asia/Kuala Lumpur"};function w(e,t){const i=y[e]??e,s=t.inputById("customSessionTZ");return s.options?.includes(i)?i:"Exchange"}class C extends p.UndoCommand{constructor(e,t,s,o,r){super(new l.TranslatedString("TPO Reset all splits and merges",a.t(null,void 0,i(652114)))),this._binding=e,this._splitsAndMerges=o,this._keyFilter=r}redo(){const e=this._binding.state(!1),t=e.splitsAndMerges;t&&Object.keys(t).filter(this._keyFilter).forEach((e=>{delete t[e]})),this._binding.restoreState(e)}undo(){const e=this._binding.state(!1)
;e.splitsAndMerges=this._splitsAndMerges,this._binding.restoreState(e)}}function T(e,t,i){"state"in e?(e.customFields&&t?.restoreStateCustomFields(e.customFields),e.data&&i&&t?.restoreData(e.data)):t?.restoreStateCustomFields(e)}class P extends d{constructor(e){super(e),this._state={},this._inputBarBuilder=null,e.model().properties().childs().timezone.subscribe(this,(()=>{"sessions"===this._calcTargetStudy(e.properties())&&this._study?.properties().childs().inputs.childs().customSessionTZ.setValue(w(e.model().timezone(),this._study.metaInfo()))}))}destroy(){this._targetStudyWV.destroy();const e=this._series.properties().childs().tpoStyle;e.unsubscribeAll(this),e.childs().summary.unsubscribeAll(this),this._series.model().properties().childs().timezone.unsubscribeAll(this),super.destroy()}bindToSeriesProperties(e){const t=e.childs().tpoStyle;t.subscribe(this,(()=>{null!==this._study&&this._study.properties().mergeAndFire((0,u.prepareStudyPropertiesState)(t.state()))})),t.childs().summary.subscribe(this,(()=>{this._series.model().fullUpdate()})),this._targetStudyWV=(0,b.createWVFromGetterAndSubscription)((()=>this._calcTargetStudy(e)),e.childs().tpoStyle.childs().inputs),this._targetStudyWV.subscribe((()=>this.syncStudy(this._series.style())))}requiredStyle(){return 18}state(e){return e?this._study?.state(!0)??null:this._study?.stateCustomFields()??("state"in this._state?this._state.customFields??{}:this._state)}restoreState(e,t){this._state=e,this._withData=t,T(e,this._study,t)}requestMoreDataIndex(){const e=this._series.symbolInfo(),t=this._series.bars().firstIndex(),i=this._series.model().timeScale().logicalRange(),s=this._series.syncModel();if(!e||null===t||!i||!s)return null;const o=Math.floor(i.left()),r=this._series.bars().search(o,S.PlotRowSearchMode.NearestRight);if(!r)return null;const a=this._series.properties().childs().tpoStyle.childs().inputs.childs(),l=function(e,t){switch(e){case"Day":return`${t}D`;case"Week":return`${t}W`;case"Month":return`${t}M`}(0,n.ensureNever)(e)}(a.period.value(),a.periodsNum.value());if(null===this._inputBarBuilder||this._inputBarBuilder.symbolInfo!==e||this._inputBarBuilder.inputResolution!==l){const t=new m.SessionInfo(e.timezone,e.session,e.session_holidays);this._inputBarBuilder={symbolInfo:e,inputResolution:l,barBuilder:(0,g.newBarBuilder)(l,t,t)}}const c=this._inputBarBuilder.barBuilder,h=1e3*r.value[0];c.moveTo(h);const d=c.startOfBar(0);return o-(0,v.extrapolateBarsFrontToTime)(s.barBuilder(),d,h,1e3).count}async _createStudy(e){const[t,s]=await Promise.all([(0,_.respectAbort)(e,Promise.all([i.e(87941),i.e(26492),i.e(93868),i.e(67618),i.e(2253),i.e(66866)]).then(i.bind(i,737686))),(0,_.respectAbort)(e,Promise.all([i.e(87941),i.e(26492),i.e(93868),i.e(67618),i.e(2253),i.e(66866)]).then(i.bind(i,790490)))]),o="periodic"===this._targetStudyWV.value()?await t.createTpoPeriodicStudy(this._series.model(),C.bind(this,this)):await s.createTpoSessionsStudy(this._series.model(),C.bind(this,this));if(e.aborted)throw o.stop(),o.destroy?.(),(0,_.createAbortError)();return o}
_applySeriesPropertiesToStudy(){this._study?.properties().mergeAndFire((0,u.prepareStudyPropertiesState)(this._series.properties().childs().tpoStyle.state())),"sessions"===this._targetStudyWV.value()&&this._study?.properties().childs().inputs.childs().customSessionTZ.setValue(w(this._series.model().timezone(),this._study.metaInfo()))}_applyStudyPropertiesToSeries(){const e=(0,n.ensureNotNull)(this._study).properties().childs().inputs.childs(),t=this._series.properties().childs().tpoStyle.childs().inputs.childs();t.mergePoints.setValue(e.mergePoints.value()),t.ticksPerRow.setValue(e.ticksPerRow.value())}_subscribeToPropertiesThatAffectVisibility(){this._series.properties().childs().tpoStyle.childs().summary.childs().visible.subscribe(this,this._updateSummaryVisibility),this._series.properties().childs().style.subscribe(this,this._updateSummaryVisibility)}_unsubscribeFromPropertiesThatAffectVisibility(){this._series.properties().childs().tpoStyle.childs().summary.childs().visible.unsubscribeAll(this),this._series.properties().childs().style.unsubscribeAll(this)}_applyStateToStudy(){T(this._state,this._study,this._withData)}_getSummaryDataSource(){return this._series.model().dataSourceForId(f.tpoSummaryDataSourceId)}_createSummaryPane(){const e=this._series.model();e.getTpoSummaryPane().insertDataSource(new f.TpoSummaryDataSource(e),null,0)}_isSummaryPaneVisible(){return this._series.properties().childs().tpoStyle.childs().summary.childs().visible.value()}_getSummaryPanePositionProperty(){return this._series.properties().childs().tpoStyle.childs().summary.childs().belowSeries}_calcTargetStudy(e){const t=e.childs().tpoStyle.childs().inputs.childs();return"Day"===t.period.value()&&1===t.periodsNum.value()?"sessions":"periodic"}}var M=i(655178),x=i(276280);function I(e,t,i){e?.customFields&&t?.restoreStateCustomFields(e.customFields),e?.data&&i&&t?.restoreData(e.data)}class L extends d{destroy(){const e=this._series.properties().childs().volFootprintStyle;e.childs().inputs.unsubscribeAll(this),e.childs().showSummary.unsubscribeAll(this),e.childs().extendedSummary.unsubscribeAll(this),super.destroy()}bindToSeriesProperties(e){const t=e.childs().volFootprintStyle;t.childs().inputs.subscribe(this,this._applyStudyPropertiesToSeries),t.childs().showSummary.subscribe(this,(()=>{this._applyStudyPropertiesToSeries(),this._series.model().fullUpdate()})),t.childs().extendedSummary.subscribe(this,(()=>{this._applyStudyPropertiesToSeries(),this._series.model().fullUpdate()}))}requiredStyle(){return 17}state(e){return this._study?.state(e)??null}restoreState(e,t){this._state=e,this._withData=t,I(e,this._study,t)}async _createStudy(e){const t=await(0,_.respectAbort)(e,Promise.all([i.e(59708),i.e(26492),i.e(93868),i.e(67618),i.e(7908),i.e(12227)]).then(i.bind(i,507908))),s=await t.createVolumeFootprintStudy(this._series.model());if(e.aborted)throw s.stop(),s.destroy?.(),(0,_.createAbortError)();return I(this._state,s,this._withData),s}_applySeriesPropertiesToStudy(){
this._study?.properties().childs().inputs.mergeAndFire(this._series.properties().childs().volFootprintStyle.childs().inputs.state())}_applyStudyPropertiesToSeries(){this._study?.properties().childs().inputs.mergeAndFire((0,x.prepareStudyInputsPropertiesState)(this._series.properties().childs().volFootprintStyle.state()))}_subscribeToPropertiesThatAffectVisibility(){this._series.properties().childs().volFootprintStyle.childs().showSummary.subscribe(this,this._updateSummaryVisibility),this._series.properties().childs().volFootprintStyle.childs().summaryMode.subscribe(this,this._updateSummaryVisibility),this._series.properties().childs().style.subscribe(this,this._updateSummaryVisibility)}_unsubscribeFromPropertiesThatAffectVisibility(){this._series.properties().childs().volFootprintStyle.childs().showSummary.unsubscribeAll(this),this._series.properties().childs().volFootprintStyle.childs().summaryMode.unsubscribeAll(this),this._series.properties().childs().style.unsubscribeAll(this)}_applyStateToStudy(){I(this._state,this._study,this._withData)}_getSummaryDataSource(){return this._series.model().dataSourceForId(M.volumeFootpringSummaryDataSourceId)}_createSummaryPane(){const e=this._series.model();e.getVolumeFootprintSummaryPane().insertDataSource(new M.VolumeFootprintSummaryDataSource(e),null,0)}_isSummaryPaneVisible(){const e=this._series.properties().childs().volFootprintStyle;return e.childs().showSummary.value()&&1===e.childs().summaryMode.value()}_getSummaryPanePositionProperty(){return this._series.properties().childs().volFootprintStyle.childs().extendedSummary.childs().belowSeries}}var A=i(671658),k=i(460137),E=i(740608),D=i(132618);function B(e,t,i){e?.data&&i&&t?.restoreData(e.data)}class R extends h{constructor(e){super(e),this._inputBarBuilder=null,this._legendValuesProvider=null,this._dataWindowValuesProvider=null,this._tableViewValuesProvider=null,e.model().properties().childs().timezone.subscribe(this,(()=>{this._study?.properties().childs().inputs.childs().customSessionTZ.setValue(w(e.model().timezone(),this._study.metaInfo()))}))}bindToSeriesProperties(e){e.childs().svpStyle.subscribe(this,(()=>{this._applySeriesPropertiesToStudy()}))}requiredStyle(){return 20}requestMoreDataIndex(){if(this._series.intervalObj().value().isDWM())return null;const e=this._series.symbolInfo(),t=this._series.bars().firstIndex(),i=this._series.model().timeScale().logicalRange(),s=this._series.syncModel();if(!e||null===t||!i||!s)return null;const o=Math.floor(i.left()),r=this._series.bars().search(o,S.PlotRowSearchMode.NearestRight);if(!r)return null;if(null===this._inputBarBuilder||this._inputBarBuilder.symbolInfo!==e){const t=new m.SessionInfo(e.timezone,e.session,e.session_holidays);this._inputBarBuilder={symbolInfo:e,barBuilder:(0,g.newBarBuilder)("1D",t,t)}}const n=this._inputBarBuilder.barBuilder,a=1e3*r.value[0];n.moveTo(a);const l=n.startOfBar(0);return o-(0,v.extrapolateBarsFrontToTime)(s.barBuilder(),l,a,1e3).count}legendValuesProvider(){return this._legendValuesProvider}dataWindowValuesProvider(){
return this._dataWindowValuesProvider}tableViewValuesProvider(){return this._tableViewValuesProvider}state(e){return this._study?.state(e)??null}restoreState(e,t){this._state=e,this._withData=t,B(e,this._study,t)}async _createStudy(e){const t=await(0,_.respectAbort)(e,Promise.all([i.e(39618),i.e(26492),i.e(93868),i.e(67618),i.e(15196)]).then(i.bind(i,212735))),s=await t.createSessionVolumeStudy(this._series.model());if(e.aborted)throw s.stop(),s.destroy?.(),(0,_.createAbortError)();B(this._state,s,this._withData);const o=this._series.model(),r=o.properties().childs().paneProperties.childs().legendProperties.childs().showSeriesOHLC;return this._legendValuesProvider=new k.StudyLegendValuesProvider(s,o,!0,r),this._dataWindowValuesProvider=new E.StudyDataWindowValuesProvider(s,o),this._tableViewValuesProvider=new D.StudyTableViewValuesProvider(s,o),s}_applySeriesPropertiesToStudy(){this._study?.properties().mergeAndFire((0,A.prepareStudyPropertiesState)(this._series.properties().childs().svpStyle.state())),this._study?.properties().childs().inputs.childs().customSessionTZ.setValue(w(this._series.model().timezone(),this._study.metaInfo()))}_applyStudyPropertiesToSeries(){}}class V{constructor(e){this._onStatusChanged=new s.Delegate,this._bindings=[new P(e),new L(e),new R(e)],this._bindings.forEach((e=>e.onStatusChanged().subscribe(this,(()=>this._onStatusChanged.fire())))),this._series=e}destroy(){this._bindings.forEach((e=>e.destroy()))}bindToSeriesProperties(e){this._bindings.forEach((t=>t.bindToSeriesProperties(e)))}paneViews(e){return this._bindings.reduce(((t,i)=>t.concat(i.paneViews(e))),[])}widgetSideAreaViews(e){return this._bindings.reduce(((t,i)=>t.concat(i.widgetSideAreaViews?.(e)??[])),[])}stop(){this._bindings.forEach((e=>e.stop()))}restart(){this._activeBinding()?.restart()}moveData(e){this._activeBinding()?.moveData(e)}clearData(){this._bindings.forEach((e=>e.clearData()))}updateAllViews(e){"hover-change"!==e.type?this._bindings.forEach((t=>t.updateAllViews(e))):this._bindings.filter((e=>e instanceof P||e instanceof L)).forEach((t=>t.updateAllViews(e)))}syncStudy(e){this._bindings.forEach((t=>t.syncStudy(e)))}onStatusChanged(){return this._onStatusChanged}wasCompletedBefore(){return this._activeBinding()?.wasCompletedBefore()??!0}dataWindowValuesProvider(){return this._activeBinding()?.dataWindowValuesProvider()??null}tableViewValuesProvider(){return this._activeBinding()?.tableViewValuesProvider()??null}legendValuesProvider(){return this._activeBinding()?.legendValuesProvider()??null}status(){return this._activeBinding()?.status()}priceRange(e){return(0,r.mergePriceRanges)(this._bindings.map((t=>t.priceRange(e))))}requestMoreDataIndex(){return this._activeBinding()?.requestMoreDataIndex()??null}getInputsInfoProperties(){return this._activeBinding()?.properties()?.inputs}state(e){return this._bindings.reduce(((t,i)=>(t[i.requiredStyle()]=i.state(e),t)),{})}restoreState(e,t){for(const i of this._bindings){const s=e[i.requiredStyle()];s&&i.restoreState(s,t)}}autoScaleInfos(e){
return this._bindings.map((t=>t.autoScaleInfo(e))).filter(o.isExistent)}activeStudy(){return this._activeBinding()?.study()??null}_activeBinding(){return this._bindings.find((e=>e.requiredStyle()===this._series.style()))??null}}},840047:(e,t,i)=>{"use strict";i.d(t,{SeriesJapChartsPaneView:()=>c,SeriesProjectionJapBarsPaneView:()=>h});var s=i(185842),o=i(657415),r=i(266150),n=i(272432),a=i(141463);class l{constructor(e,t){this._bars=[],this._invalidated=!0,this._isMarkersEnabled=(0,r.isFeaturesetEnabled)("source_selection_markers"),this._selectionData=null,this._blockSize=0,this._series=e,this._model=t,this._selectionIndexer=new n.SelectionIndexes(t.timeScale())}update(){this._invalidated=!0}nearestIndex(e,t){return this.bars().search(e,t)?.index??null}items(){return this._bars}_updateImpl(){if(this._bars=[],6===this._series.properties().childs().style.value()&&!this._series.data().boxSize)return;const e=this._series.priceScale(),t=this._model.timeScale();if(t.isEmpty()||e.isEmpty())return;const i=t.visibleStrictDataRange(this.bars());if(null===i)return;if(0===this.bars().size())return;let r=i.firstBar();const n=i.lastBar(),l=this._series.firstValue();if(null===l)return;for(;r<=n;r++){if(null!==this.bars().valueAt(r))break}if(r>n)return;const c=this.bars().range(r,n),h={},d=this._series.properties().childs().style.value(),u=6===d?(0,s.ensureDefined)(this._series.data().boxSize):0;if(c.each(((e,t)=>{h.value=t;const i=this._barItem(h,t,e);return null===i||(h.previousValue=t,this._bars.push(i)),!1})),6===d&&(this._blockSize=(e.priceToCoordinate(0,l)-e.priceToCoordinate(500,l))/500*u),e.barPricesToCoordinates(this._bars,l),t.fillBarBorders(this._bars),this._model.selection().isSelected(this._series)){const i=this._selectionIndexer.indexes();this._selectionData={points:[],bgColors:[],visible:!0,barSpacing:t.barSpacing(),hittestResult:a.HitTarget.Regular};const r=(0,s.ensureNotNull)(this._model.paneForSource(this._series)).height();this._selectionData.hittestResult=a.HitTarget.Regular;for(let s=0;s<i.length;s++){const n=i[s],a=this._series.bars().valueAt(n);if(null===a)continue;const c=a[1],h=a[4];if(null==c||null==h)continue;const d=.5*(c+h),u=t.indexToCoordinate(n),_=e.priceToCoordinate(d,l);this._selectionData.points.push({point:new o.Point(u,_)}),this._selectionData.bgColors.push(this._model.backgroundColorAtYPercentFromTop(_/r))}}else this._selectionIndexer.clear()}_barItem(e,t,i){const s=t[1],o=t[2],r=t[3],n=t[4];if(void 0===s||void 0===o||void 0===r||void 0===n||null===s||null===o||null===r||null===n)return null;const a=this._series.barColorer(),l=this.isProjection(),c=a.barStyle(i,l,e);return{open:s,high:o,low:r,close:n,color:c.barColor,borderColor:c.barBorderColor,wickColor:c.barWickColor,isUp:c.isBarUp,hollow:null,center:NaN,left:NaN,right:NaN,timePointIndex:Math.round(i)}}}class c extends l{bars(){return this._series.bars()}isProjection(){return!1}}class h extends l{bars(){return this._series.nsBars()}isProjection(){return!0}}},656785:(e,t,i)=>{"use strict";i.d(t,{generateSplitTitleForGui:()=>_,
generateTitleForGui:()=>p});var s=i(904003),o=i(185842),r=i(729193),n=i(482498),a=i(332157),l=i(905350),c=i(466269);function h(e,t){return(Math.round(e*Math.pow(10,t))/Math.pow(10,t)).toString()||""}function d(e){switch(e.style){case"ATR":return r.t(null,{context:"input",replace:{atrValue:String(e.atrLength)}},i(870915));case"PercentageLTP":return r.t(null,{context:"input",replace:{percentageLTPValue:String(e.percentageLTP)}},i(995235));case"Traditional":return r.t(null,{context:"input"},i(411974));default:return e.style??""}}const u=(0,s.default)((e=>{const[,t="",i="",s="",o=""]=Array.from(e.match(/^(\d\d)(\d\d)-(\d\d)(\d\d)/)||[]);return`${t}:${i}${s}:${o}`}));function _(e){const t="QUANDL"===(e=e||{}).listedExchange,s={title:"",description:"",interval:"",listedExchange:"",provider:"",chartStyle:"",sessionDescription:"",priceSource:"",adjustment:"",backadjustment:"",settlement:""};let c="";if(e.description&&t)if(2===e.description.split("/").length)c=e.description.split("/")[1];else{e.description.split("'").filter((e=>e.length)).forEach((e=>{let t=[];t=e&&("/"===e[0]||/\d+\/\(?/.test(e))?[e]:e.split("/").filter((e=>e.length)),c+=t[2===t.length?1:0]}))}else c=e.description?e.description:e.symbol;if(e.ticker?(s.title=e.ticker,s.description=m(c)):s.title=m(c),e.interval&&(s.interval=(0,a.translatedIntervalString)(e.interval,e.forceIntervalShortKind)),t&&e.description){const t=/[\w_]+\/[\w_]+/.exec(e.description);t&&t[0]?s.provider=m(t[0].split("/")[0]):s.provider=m(e.description.split("/")[0])}return e.listedExchange&&(s.listedExchange=m(e.listedExchange)),e.style&&(s.chartStyle=m(function(e){const t=e.inputs;switch(e.style){case 4:const s=d(t),a=(0,o.ensureDefined)(e.boxSize||t.boxSize);return`${r.t(null,void 0,i(88999))} [${s}, ${h(a,4)}]`;case 7:return`${r.t(null,void 0,i(103617))} [${t.lb}]`;case 5:const c=d(t),_=e.reversalAmount||t.reversalAmount,p=void 0!==_?`, ${h(_,8)}`:"";return`${r.t(null,void 0,i(909224))} [${c}${p}]`;case 6:const m=d(t),g=e.boxSize||t.boxSize;return`${r.t(null,void 0,i(954041))} [${m}, ${h((0,o.ensureDefined)(g),8)}, ${t.reversalAmount}]`;case 18:return`${r.t(null,void 0,i(873035))} [${t.periodsNum}, ${t.period}, ${t.blockSize}, ${t.ticksPerRow}]`;case 17:{const e="Auto"===t.rowSize?`ATR ${t.atrLength}`:`Manual ${t.ticksPerRow}`;let s;switch((0,o.ensureDefined)(t.type)){case l.VolumeFootprintTypeValues.BuyAndSell:s=r.t(null,void 0,i(135523));break;case l.VolumeFootprintTypeValues.Delta:s=r.t(null,void 0,i(340927));break;case l.VolumeFootprintTypeValues.Total:s=r.t(null,void 0,i(623546));break;case l.VolumeFootprintTypeValues.Ladder:s=r.t(null,void 0,i(87461))}return`${r.t(null,void 0,i(487242))} [${e}, ${s}]`}case 20:{const e=(0,n.getTranslatedInputTitle)((0,o.ensureDefined)(t.profilesSessions)),s=(0,n.getTranslatedInputTitle)((0,o.ensureDefined)(t.volume)),a=(0,n.getTranslatedInputTitle)((0,o.ensureDefined)(t.rowsLayout));let l="";return"All"!==t.profilesSessions&&(l=`${u((0,o.ensureDefined)(t.customSession))}, ${t.customSessionTZ}, `),
`${r.t(null,void 0,i(627104))} [${e}, ${l}${s}, ${t.vaVolume}, ${a}, ${t.rows}]`}}return 11===e.style?r.t(null,void 0,i(990213)):8===e.style?r.t(null,void 0,i(748182)):""}(e))),e.sessionDescription&&(s.sessionDescription=m(e.sessionDescription)),void 0!==e.priceSource&&(s.priceSource=m(e.priceSource)),e.adjustment&&"dividends"===e.adjustment&&(s.adjustment=r.t(null,{context:"adjustments"},i(786978))),void 0!==e.backadjustment&&(s.backadjustment=r.t(null,{context:"adjustments"},i(730840))),e["settlement-as-close"]&&(s.settlement=r.t(null,{context:"adjustments"},i(337957))),s}function p(e){const t=_(e),i=t.interval?(0,c.formatDirectionalResolution)(t.interval):"";return(e.ticker?t.description:t.title)+i+function(e,t=", "){return(e.provider?`${t}${e.provider}`:"")+(e.listedExchange?`${t}${e.listedExchange}`:"")+(e.chartStyle?`${t}${e.chartStyle}`:"")+(e.adjustment?`${t}${e.adjustment}`:"")+(e.backadjustment?`${t}${e.backadjustment}`:"")+(e.settlement?`${t}${e.settlement}`:"")+(e.sessionDescription?`${t}${e.sessionDescription}`:"")+(e.priceSource?`${t}${e.priceSource}`:"")}(t)}function m(e){return e.replace(/'/g,"")}},601109:(e,t,i)=>{"use strict";i.d(t,{SeriesHeikenAshiPaneView:()=>l});var s=i(449938),o=i(515338),r=i(186777),n=i(426820),a=i(853557);class l extends a.SeriesCandlesPaneView{renderer(){this._invalidated&&(this._updateImpl(null),this._invalidated=!1);const e=this._source.priceScale();if(!e)return null;const t=this._source.properties().childs().haStyle.childs(),i=this._model.timeScale().barSpacing(),a={bars:this._bars,barSpacing:i,bodyVisible:t.drawBody.value(),borderVisible:t.drawBorder.value(),borderColor:t.borderColor.value(),wickColor:t.wickColor.value(),barWidth:(0,o.optimalBarWidth)(i),wickVisible:t.drawWick.value(),isPriceScaleInverted:e.isInverted()},l=new s.CompositeRenderer;return l.append(new n.PaneRendererCandles(a)),this._model.selection().isSelected(this._source)&&this._isMarkersEnabled&&this._selectionData&&l.append(new r.SelectionRenderer(this._selectionData)),l}}},420425:(e,t,i)=>{"use strict";i.d(t,{createHighLowViews:()=>v});var s=i(729193),o=i(969185),r=i(786775),n=i(823291),a=i(515834);const l={light:{lineStyle:a.LINESTYLE_DOTTED,lineWidth:1,backgroundColor:n.colorsPalette["color-tv-blue-50"],lineColor:n.colorsPalette["color-cold-gray-500"]},dark:{lineStyle:a.LINESTYLE_DOTTED,lineWidth:1,backgroundColor:n.colorsPalette["color-tv-blue-a800"],lineColor:n.colorsPalette["color-cold-gray-500"]}};function c(e){return e?l.dark:l.light}class h extends r.HorizontalLinePaneView{constructor(e,t,i){super(),this._model=e,this._isVisible=t.lineVisible,this._lineColor=t.lineColor,this._lineWidth=t.lineWidth,this._getValue=i}_updateImpl(){const e=this._lineRendererData;if(e.visible=!1,!this._isVisible.value())return;const t=this._model.mainSeries(),i=t.priceScale(),s=t.firstValue(),o=this._getValue();if(null===s||null===o)return;const r=c(this._model.dark().value()),n=this._lineColor.value()||r.lineColor,a=this._lineWidth.value()||r.lineWidth;e.visible=!0,e.y=i.priceToCoordinate(o,s),
e.linestyle=r.lineStyle,e.linewidth=a,e.color=n}}var d=i(816570),u=i(275925);class _ extends d.PriceAxisView{constructor(e,t,i,s){super(),this._model=e,this._label=t,this._isVisible=i.labelVisible,this._backgroundColor=i.lineColor,this._getValue=s}_updateRendererData(e,t,i){if(e.visible=!1,t.visible=!1,!this._isVisible.value())return;const s=this._model.mainSeries(),o=s.priceScale(),r=s.firstValue(),n=this._getValue();if(null===r||null===n)return;const a=c(this._model.dark().value()),l=(0,u.resetTransparency)(this._backgroundColor.value()||a.backgroundColor);e.visible=!0,t.visible=!0,e.text=o.formatPriceAbsolute(n),t.text=this._label,i.coordinate=o.priceToCoordinate(n,r),i.background=l,i.textColor=this.generateTextColor(l),e.selectedMarkColor=this._model.selection().isSelected(s)?l:void 0}}var p=i(15474);class m extends p.PriceLineAxisView{constructor(e,t,i){super(),this._model=e,this._isLineVisible=t,this._getValue=i}_isVisible(){return this._isLineVisible.value()}_lineWidth(){return c(this._model.dark().value()).lineWidth}_lineStyle(){return c(this._model.dark().value()).lineStyle}_priceLineColor(e){return c(this._model.dark().value()).lineColor}_value(){const e=this._model.mainSeries(),t=e.priceScale(),i=e.firstValue(),s=this._getValue();if(null===i||null===s)return{noData:!0};return{noData:!1,coordinate:t.priceToCoordinate(s,i),color:"",formattedPricePercentage:"",formattedPriceAbsolute:"",formattedPriceIndexedTo100:"",text:"",index:0}}}const g=s.t(null,void 0,i(845563)),S=s.t(null,void 0,i(888678));function v(e,t,i,s){const o=i.childs(),r=f(e,t,{label:g,labelVisible:o.highLowPriceLabelsVisible,lineVisible:o.highLowPriceLinesVisible,lineColor:o.highLowPriceLinesColor,lineWidth:o.highLowPriceLinesWidth},(()=>s(0))),n=f(e,t,{label:S,labelVisible:o.highLowPriceLabelsVisible,lineVisible:o.highLowPriceLinesVisible,lineColor:o.highLowPriceLinesColor,lineWidth:o.highLowPriceLinesWidth},(()=>s(1)));return{paneViews:[r.paneView,n.paneView],panePriceAxisViews:[r.panePriceAxisView,n.panePriceAxisView],priceAxisViews:[r.priceAxisView,n.priceAxisView],priceLineAxisViews:[r.priceLineAxisView,n.priceLineAxisView]}}function f(e,t,i,s){const r=new h(e,i,s),n=new _(e,i.label,i,s);return{paneView:r,panePriceAxisView:new o.PanePriceAxisView(n,t,e),priceAxisView:n,priceLineAxisView:new m(e,i.lineVisible,s)}}},91255:(e,t,i)=>{"use strict";i.d(t,{SeriesKagiPaneView:()=>u,SeriesProjectionKagiPaneView:()=>_});var s=i(393418),o=i(185842),r=i(449938),n=i(186777),a=i(840047),l=i(515338),c=i(379980);class h extends c.PaneRendererSeriesBase{constructor(e){super(),this._bars=e.bars,this._barSpacing=e.barSpacing,this._barLineWidth=Math.max(1,(0,l.optimalBarWidth)(e.barSpacing,1))}_drawImpl(e){const{context:t,horizontalPixelRatio:i,verticalPixelRatio:s}=e;let o,r,n;t.save(),t.lineCap="square";const a=Math.floor(i)%2?1:0;for(const e of this._bars){const l=Math.round(i*this._barLineWidth*.5),c=Math.round(i*e.center-l),h=void 0===r||e.isUp?Math.round(s*e.high-l):r,d=2*l;let u;if(e.isTwoColorBar){
const i=Math.round(s*e.additionalPrice-s*e.high+l),r=h+i,n=Math.round(s*e.low-s*e.additionalPrice+l),_=void 0!==o&&e.isUp?o:r+n;t.fillStyle=e.upColor,t.fillRect(c,h,d+a,i),t.fillStyle=e.downColor,t.fillRect(c,r,d+a,_+l-r+1),u=_}else{const i=Math.round(s*e.low-s*e.high+l),r=void 0!==o&&e.isUp?o:h+i;t.fillStyle=e.color,t.fillRect(c,h,d+a,r+l-h+1),u=r}if(!e.combinedWithProjection){e.isTwoColorBar?t.fillStyle=e.isUp?e.downColor:e.upColor:t.fillStyle=e.color;const o=void 0===n?Math.round((e.center-this._barSpacing)*i+l):n+2*l,c=Math.round(e.center*i-l)-o+1,h=2*l+a;if(e.isUp)t.fillRect(o,u-l+1-a,c,h);else{const i=void 0===r?Math.round(e.open*s-l):r;t.fillRect(o,i,c,h)}}n=c,o=u,r=h}t.restore()}_getTolerance(){return(0,l.interactionTolerance)().series+this._barLineWidth/4}}function d(e,t){const i={};return i.upColor=e.upColor,i.downColor=e.downColor,i.isTwoColorBar=e.isTwoColorBar,(0,s.default)(t)&&(i.additionalPrice=t),i}class u extends a.SeriesJapChartsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()},t=new r.CompositeRenderer;return t.append(new h(e)),this._model.selection().isSelected(this._series)&&this._isMarkersEnabled&&this._selectionData&&t.append(new n.SelectionRenderer(this._selectionData)),t}_barItem(e,t,i){const s=super._barItem(e,t,i);if(null===s)return null;const o=d(this._series.barColorer().barStyle(i,!1,e),t[6]);return{...s,...o}}}class _ extends a.SeriesProjectionJapBarsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()};return new h(e)}_barItem(e,t,i){const r=super._barItem(e,t,i);if(null===r)return null;const n=this._series.barColorer().barStyle(i,!0,e),a=t[6],l=d(n,a);return(0,s.default)(a)&&r.timePointIndex===(0,o.ensureNotNull)(this.bars().lastIndex())&&(l.combinedWithProjection=!0),{...r,...l}}}},22901:(e,t,i)=>{"use strict";i.d(t,{LastPriceCirclePaneView:()=>_});var s=i(657415),o=i(275925);class r{constructor(){this._data=null}setData(e){this._data=e}data(){return this._data}draw(e,t){const i=this._data;if(null===i)return;const{horizontalPixelRatio:s,verticalPixelRatio:o}=t;e.save();const r=Math.max(1,Math.floor(s)),n=r%2/2,a=Math.round(i.center.x*s)+n,l=i.center.y*o;e.fillStyle=i.seriesLineColor,e.beginPath();const c=Math.max(2,1.5*i.seriesLineWidth)*s;e.arc(a,l,c,0,2*Math.PI,!1),e.fill(),e.fillStyle=i.fillColor,e.beginPath(),e.arc(a,l,i.radius*s,0,2*Math.PI,!1),e.fill(),e.lineWidth=r,e.strokeStyle=i.strokeColor,e.beginPath(),e.arc(a,l,i.radius*s+r/2,0,2*Math.PI,!1),e.stroke(),e.restore()}hitTest(e){return null}}var n=i(823291);function a(e){return e}const l=[{start:0,end:.25,startRadius:4,endRadius:10,startFillAlpha:.25,endFillAlpha:0,startStrokeAlpha:.4,endStrokeAlpha:.8,easing:a},{start:.25,end:.525,startRadius:10,endRadius:14,startFillAlpha:0,endFillAlpha:0,startStrokeAlpha:.8,endStrokeAlpha:0,easing:a},{start:.525,end:1,startRadius:14,endRadius:14,startFillAlpha:0,endFillAlpha:0,
startStrokeAlpha:0,endStrokeAlpha:0,easing:a}];function c(e,t,i,s){const r=i+(s-i)*t;return(0,o.applyTransparency)(e,(0,o.alphaToTransparency)(r))}const h=(0,n.getHexColorByName)("color-minty-green-400"),d=(0,n.getHexColorByName)("color-ripe-red-500");function u(e,t,i){const s=e%2600/2600;let o;for(const e of l)if(s>=e.start&&s<=e.end){o=e;break}if(void 0===o)throw new Error("Last price animation internal logic error");const r=o.easing((s-o.start)/(o.end-o.start));return{fillColor:c(i,r,o.startFillAlpha,o.endFillAlpha),strokeColor:c(i,r,o.startStrokeAlpha,o.endStrokeAlpha),radius:(n=r,a=o.startRadius,h=o.endRadius,a+(h-a)*n)};var n,a,h}class _{constructor(e){this._renderer=new r,this._invalidated=!0,this._stageInvalidated=!0,this._startTime=performance.now(),this._endTime=this._startTime-1,this._prevRenderedPrice=null,this._series=e}update(e){if(this._invalidated=!0,"data-source-change"===e.type&&e.sourceId===this._series.id()&&e.realtime&&this._series.seriesLoaded()){const e=performance.now(),t=this._endTime-e;if(t>0)return void(t<650&&(this._endTime+=2600));this._startTime=e,this._endTime=e+2600}}invalidateStage(){this._stageInvalidated=!0}animationActive(){return performance.now()<=this._endTime}stopAnimation(){this._endTime=this._startTime-1}renderer(e){return this._invalidated?(this._updateImpl(e),this._invalidated=!1,this._stageInvalidated=!1):this._stageInvalidated&&(this._updateRendererDataStage(),this._stageInvalidated=!1),this._renderer}_updateImpl(e){this._renderer.setData(null);const t=this._series.model().timeScale(),i=t.visibleBarsStrictRange(),o=this._series.firstValue(),r=this._series.lastValueData(void 0,!0,!0);if(null===i||null===o||void 0===r.index||void 0===r.price||!i.contains(r.index))return;const n=new s.Point(t.indexToCoordinate(r.index),this._series.priceScale().priceToCoordinate(r.price,o)),a=r.color,l=this._series.properties().childs();let c;switch(this._series.style()){case 3:c=l.areaStyle.childs().linewidth.value();break;case 10:const t=l.baselineStyle,i=Math.round(e.mediaSize.height*(Math.abs(100-t.childs().baseLevelPercentage.value())/100));c=n.y<=i?t.childs().topLineWidth.value():t.childs().bottomLineWidth.value();break;case 14:c=l.lineWithMarkersStyle.childs().linewidth.value();break;case 15:c=l.steplineStyle.childs().linewidth.value();break;default:c=l.lineStyle.childs().linewidth.value()}this._lastBaseColor=null===this._prevRenderedPrice||this._prevRenderedPrice===r.price?a:this._prevRenderedPrice<r.price?h:d;const _=u(this._duration(),0,this._lastBaseColor);this._renderer.setData({seriesLineColor:a,seriesLineWidth:c,fillColor:_.fillColor,strokeColor:_.strokeColor,radius:_.radius,center:n}),this._prevRenderedPrice=r.price}_updateRendererDataStage(){const e=this._renderer.data();if(null!==e){const t=u(this._duration(),e.seriesLineColor,this._lastBaseColor);e.fillColor=t.fillColor,e.strokeColor=t.strokeColor,e.radius=t.radius}}_duration(){return this.animationActive()?performance.now()-this._startTime:2599}}},266512:(e,t,i)=>{"use strict";i.d(t,{SeriesPnFPaneView:()=>u,
SeriesProjectionPnFPaneView:()=>_});var s,o=i(185842),r=i(449938),n=i(186777),a=i(840047),l=i(515338),c=i(379980);!function(e){e[e.EllipseWidth=.9]="EllipseWidth",e[e.EllipseRadius=.95]="EllipseRadius",e[e.SimplifiedEllipseWidth=.86]="SimplifiedEllipseWidth"}(s||(s={}));class h extends c.PaneRendererSeriesBase{constructor(e){super(),this._bars=e.bars,this._barSpacing=e.barSpacing,this._barWidth=e.barSpacing}_drawImpl(e){const{context:t,horizontalPixelRatio:i,verticalPixelRatio:s}=e;if(0===this._bars.length)return;t.save();const o=this._bars.reduce(((e,t)=>Math.max(e,Math.abs(t.low-t.high)/t.additionalNum)),0);this._barSpacing>1&&o>=1?this._drawFillSigns(t,i,s):this._drawSimplified(t,i,s),t.restore()}_getTolerance(){return(0,l.interactionTolerance)().series+this._barWidth/8}_drawBarCross(e,t,i,s){!function(e,t,i,s,o){e.moveTo(t,i),e.lineTo(t+s,i+o),e.moveTo(t+s,i),e.lineTo(t,i+o)}(e,t.center-.5*this._barWidth,t.high+s*i,this._barWidth,i)}_drawBarEllipse(e,t,i,o){!function(e,t,i,o,r){e.save(),e.translate(t+o/2,i+r/2),e.scale(o/2,r/2),e.moveTo(s.EllipseRadius,0),e.arc(0,0,s.EllipseRadius,0,2*Math.PI,!1),e.restore()}(e,t.center-this._barWidth*s.EllipseWidth*.5,t.high+o*i,this._barWidth*s.EllipseWidth,i)}_drawFillSigns(e,t,i){e.scale(t,i),e.lineCap="butt",e.lineWidth=1;for(const t of this._bars){const i=(t.low-t.high)/t.additionalNum;if(t.isMergedBar&&(e.beginPath(),t.isUp?this._drawBarEllipse(e,t,i,t.additionalNum-1):this._drawBarCross(e,t,i,0),e.strokeStyle=t.isUp?t.downColor:t.upColor,e.stroke()),e.beginPath(),t.isUp)for(let s=t.additionalNum-1-(t.isMergedBar?1:0);s>-1;s--)this._drawBarCross(e,t,i,s);else for(let s=t.isMergedBar?1:0;s<t.additionalNum;s++)this._drawBarEllipse(e,t,i,s);e.strokeStyle=t.color,e.stroke()}}_drawSimplified(e,t,i){for(const o of this._bars){const r=o.isUp?1:s.SimplifiedEllipseWidth,n=(o.center-.5*this._barWidth*r)*t,a=(o.center+.5*this._barWidth*r)*t,l=Math.max(1,a-n);let c=o.high*i;const h=o.low*i,d=o.high*i;let u=Math.max(1,h-d);if(o.isMergedBar){e.fillStyle=o.isUp?o.downColor:o.upColor;const t=(o.low-o.high)/o.additionalNum,i=Math.max(1,Math.round(t));o.isUp?(e.fillRect(n,c,l,i),c+=i):(e.fillRect(n,c+l-i,l,i),u-=i)}e.fillStyle=o.color,e.fillRect(n,c,l,u)}}}function d(e,t,i,s){const o={};return o.low=s-.5*t,o.high=i+.5*t,o.upColor=e.upColor,o.downColor=e.downColor,o.isMergedBar=e.isMergedBar,o.additionalNum=Math.round(1+(i-s)/t),o}class u extends a.SeriesJapChartsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()},t=new r.CompositeRenderer;return t.append(new h(e)),this._model.selection().isSelected(this._series)&&this._isMarkersEnabled&&this._selectionData&&t.append(new n.SelectionRenderer(this._selectionData)),t}_barItem(e,t,i){const s=super._barItem(e,t,i);if(null===s)return null;const r=d(this._series.barColorer().barStyle(i,!1,e),(0,o.ensureDefined)(this._series.data().boxSize),s.high,s.low);return{...s,isUp:(0,o.ensureDefined)(s.isUp),...r}}}
class _ extends a.SeriesProjectionJapBarsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,barSpacing:this._model.timeScale().barSpacing()};return new h(e)}_barItem(e,t,i){const s=super._barItem(e,t,i);if(null===s)return null;const r=d(this._series.barColorer().barStyle(i,!0,e),(0,o.ensureDefined)(this._series.data().boxSize),s.high,s.low);return{...s,isUp:(0,o.ensureDefined)(s.isUp),...r}}}},860211:(e,t,i)=>{"use strict";i.d(t,{SeriesProjectionRangeBarsPaneView:()=>a,SeriesProjectionRangeCandlesPaneView:()=>l});var s=i(855714),o=i(426820),r=i(515338),n=i(840047);class a extends n.SeriesProjectionJapBarsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e=this._series.properties().childs(),t=e.rangeStyle.childs(),i={bars:this._bars,thinBars:t.thinBars.value(),dontDrawOpen:e.barStyle.childs().dontDrawOpen.value()};return new s.PaneRendererBars(i)}}class l extends n.SeriesProjectionJapBarsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e=this._model.timeScale().barSpacing(),t={bars:this._bars,barWidth:(0,r.optimalBarWidth)(e),barSpacing:this._model.timeScale().barSpacing(),bodyVisible:!0,borderVisible:!0,wickVisible:!0,isPriceScaleInverted:this._series.priceScale().isInverted()};return new o.PaneRendererCandles(t)}_barItem(e,t,i){const s=super._barItem(e,t,i);if(null===s)return null;const o=this._series.barColorer().barStyle(i,!0,e);return s.wickColor=o.wickColor,s.hollow=null,s}}},276706:(e,t,i)=>{"use strict";i.d(t,{PaneRendererRenkoPB:()=>n});var s=i(515338),o=i(379980),r=i(138264);class n extends o.PaneRendererSeriesBase{constructor(e){super(),this._barSpacing=1,this._barWidth=1,this._isPriceScaleInverted=!1,this._bars=e.bars,this._barSpacing=e.barSpacing,this._isPriceScaleInverted=e.isPriceScaleInverted}_drawImpl(e){const{context:t,horizontalPixelRatio:i,verticalPixelRatio:s}=e;t.save(),this._barWidth=Math.round(this._barSpacing*i),this._drawWicks(t,i,s),this._drawBorder(t,i,s),this._drawBars(t,i,s)}_getTolerance(){return(0,s.interactionTolerance)().series+.5}_drawBars(e,t,i){let s="",o=null;const r=this._calculateBorderWidth(t);for(const n of this._bars){if(this._barWidth<=2*r)continue;let a=Math.round(Math.min(n.open,n.close)*i),l=Math.round(Math.max(n.open,n.close)*i),c=Math.round(n.center*t)-Math.floor(.5*this._barWidth),h=c+this._barWidth-1;if(n.color!==s){const t=n.color;e.fillStyle=t,s=t}null!==o&&(c=Math.max(o+1,c-1),c=Math.min(c,h)),o=h,c+=r,a+=r,h-=r,l-=r,a>l||e.fillRect(c,a,h-c+1,l-a+1)}}_drawBorder(e,t,i){const s=this._calculateBorderWidth(t);let o="",n=null;for(const a of this._bars){a.borderColor!==o&&(e.fillStyle=a.borderColor,o=a.borderColor);let l=Math.round(a.center*t)-Math.floor(.5*this._barWidth);const c=l+this._barWidth-1,h=Math.round(Math.min(a.open,a.close)*i),d=Math.round(Math.max(a.open,a.close)*i);if(null!==n&&(l=Math.max(n+1,l-1),l=Math.min(l,c)),this._barSpacing*t>2*s)(0,r.fillRectInnerBorder)(e,l,h,c-l+1,d-h+1,s);else{const t=c-l+1;e.fillRect(l,h,t,d-h+1)}
n=c}}_drawWicks(e,t,i){const s=this._bars;let o=Math.min(Math.floor(t),Math.floor(this._barSpacing*t));o=Math.max(Math.floor(t),Math.min(o,this._barWidth));const r=Math.floor(.5*o);let n="";for(const a of s){a.wickColor!==n&&(e.fillStyle=a.wickColor,n=a.wickColor);let s=Math.round(Math.min(a.open,a.close)*i),l=Math.round(Math.max(a.open,a.close)*i);this._isPriceScaleInverted&&([l,s]=[s,l]);const c=Math.round(a.high*i),h=Math.round(a.low*i),d=Math.round(t*a.center)-r,u=d+o-1-d+1;e.fillRect(d,c,u,s-c),h!==l&&e.fillRect(d,l+1,u,h-l-1)}}_calculateBorderWidth(e){let t=Math.floor(e);this._barWidth<=2*t&&(t=Math.floor(.5*(this._barWidth-1)));const i=Math.max(Math.floor(e),t);return this._barWidth<=2*i?Math.floor(e):i}}},780414:(e,t,i)=>{"use strict";i.d(t,{SeriesPriceBreakPaneView:()=>a,SeriesProjectionPriceBreakPaneView:()=>l});var s=i(449938),o=i(186777),r=i(840047),n=i(276706);class a extends r.SeriesJapChartsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,barSpacing:.9*this._model.timeScale().barSpacing(),isPriceScaleInverted:this._series.priceScale().isInverted()},t=new s.CompositeRenderer;return t.append(new n.PaneRendererRenkoPB(e)),this._model.selection().isSelected(this._series)&&this._isMarkersEnabled&&this._selectionData&&t.append(new o.SelectionRenderer(this._selectionData)),t}}class l extends r.SeriesProjectionJapBarsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,barSpacing:.9*this._model.timeScale().barSpacing(),isPriceScaleInverted:this._series.priceScale().isInverted()};return new n.PaneRendererRenkoPB(e)}}},622778:(e,t,i)=>{"use strict";i.d(t,{SeriesProjectionRenkoPaneView:()=>l,SeriesRenkoPaneView:()=>a});var s=i(449938),o=i(186777),r=i(840047),n=i(276706);class a extends r.SeriesJapChartsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,barSpacing:this._model.timeScale().barSpacing(),isPriceScaleInverted:this._series.priceScale().isInverted()},t=new s.CompositeRenderer;return t.append(new n.PaneRendererRenkoPB(e)),this._model.selection().isSelected(this._series)&&this._isMarkersEnabled&&this._selectionData&&t.append(new o.SelectionRenderer(this._selectionData)),t}}class l extends r.SeriesProjectionJapBarsPaneView{renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,barSpacing:this._model.timeScale().barSpacing(),isPriceScaleInverted:this._series.priceScale().isInverted()};return new n.PaneRendererRenkoPB(e)}}},884695:(e,t,i)=>{"use strict";i.d(t,{SeriesChartFloatingTooltipValuesProvider:()=>o});var s=i(777729);class o extends s.SeriesLegendValuesProvider{_showOHLC(){return!0}_showLastDayChange(){return!1}}},59090:(e,t,i)=>{"use strict";i.d(t,{SeriesChartFloatingTooltipView:()=>n});var s=i(44408),o=i(613816),r=i(644592);class n{constructor(e){this._items=[],this._invalidated=!0,this._seriesValuesProvider=null,this._model=e}destroy(){}items(){return this._invalidated&&(this._updateImpl(),
this._invalidated=!1),this._items}update(e){this._invalidated=!0}_updateImpl(){const e=this._model.mainSeries();this._seriesValuesProvider||(this._seriesValuesProvider=new o.SeriesValuesProvider(e,this._model));const t=this._model.crosshairSource().appliedIndex(),i=e.chartFloatingTooltipValuesProvider(),n=this._seriesValuesProvider.getValues(t),a=r.priceSourceTitles[e.priceSource()??"close"],l=!!this._model.mainPane()?.priceDataSources().some((e=>(0,s.isStudy)(e)&&"Volume@tv-basicstudies"===e.metaInfo().id)),c=(e,t)=>7===t?e||l:e;this._items=i.getValues(t).map(((e,t)=>({...e,title:4===t?a:n[t].title,visible:c(e.visible,t)}))).filter((e=>e.visible)).map((e=>({titleText:e.title,titleInputs:"",value:e.value,valueColor:e.color})))}}},601066:(e,t,i)=>{"use strict";i.d(t,{SeriesDataWindowView:()=>p});var s=i(197486),o=i(266150),r=i(376596),n=i(719456),a=i(332157),l=i(49833),c=i(70346),h=i(187614),d=i(196768);const u=r.CheckMobile.any(),_=(0,o.isFeaturesetEnabled)("hide_resolution_in_legend");class p extends n.DataWindowView{constructor(e,t){super(),this._invalidated=!0,this._series=e,this._model=t,this.update()}update(){this._invalidated=!0}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}series(){return this._series}canShowItems(){return!!this._model.mainPane()?.maximized().value()||void 0===this._model.panes().find((e=>e.maximized().value()))}_updateImpl(){const e=this._getValuesProvider();this._valuesProvider!==e&&(this._valuesProvider=e,this._items=this._valuesProvider.getItems().map((e=>new n.DataWindowItem(e.id,e.title,"",e.unimportant))));const t=this._series.aliasSymbolInfo();if(t){const e=[t.name];_||e.push((0,d.forceRTLStr)((0,a.translatedIntervalString)(this._series.interval()))),e.push((0,c.getSymbolListedExchange)(t)),this._header=e.join(` ${c.symbolTitleSeparator} `),this._title=t.description}else this._header=this._series.symbolOrAlias();let i=this._model.crosshairSource().appliedIndex();(0,o.isFeaturesetEnabled)("use_last_visible_bar_value_in_legend")&&!(0,s.isNumber)(i)&&(i=this._model.timeScale().visibleBarsStrictRange()?.lastBar()??NaN);const r=this._valuesProvider.getValues(i);for(let e=0;e<r.length;++e){const t=r[e],i=this._items[e];i.setValue(t.value),i.setVisible(t.visible),i.setColor(t.color),i.setTitle(t.title)}}_getValuesProvider(){return this._series.dataWindowValuesProvider()}_showLastPriceAndChangeOnly(){return u&&(null===this._model.crosshairSource().pane||(0,h.isLineToolName)(l.tool.value())||null!==this._model.lineBeingEdited())}}},203695:(e,t,i)=>{"use strict";i.d(t,{SeriesHorizontalBaseLinePaneView:()=>o});var s=i(288329);class o extends s.SeriesHorizontalLinePaneView{constructor(e){super(e)}_updateImpl(){this._lineRendererData.visible=!1;const e=this._series.priceScale().mode();if(!e.percentage&&!e.indexedTo100)return;const t=this._series.firstValue();null!==t&&(this._lineRendererData.visible=!0,this._lineRendererData.y=this._series.priceScale().priceToCoordinate(t,t),
this._lineRendererData.color=this._series.properties().childs().baseLineColor.value())}}},288329:(e,t,i)=>{"use strict";i.d(t,{SeriesHorizontalLinePaneView:()=>o});var s=i(786775);class o extends s.HorizontalLinePaneView{constructor(e){super(),this._series=e,this._model=e.model()}}},777729:(e,t,i)=>{"use strict";i.d(t,{SeriesLegendValuesProvider:()=>c});var s=i(729193),o=i(376596),r=i(613816),n=i(70346);const a={open:s.t(null,{context:"in_legend"},i(960513)),high:s.t(null,{context:"in_legend"},i(954614)),low:s.t(null,{context:"in_legend"},i(839463)),close:s.t(null,{context:"in_legend"},i(229994)),hl2:s.t(null,{context:"in_legend"},i(666730)),hlc3:s.t(null,{context:"in_legend"},i(10034)),ohlc4:s.t(null,{context:"in_legend"},i(143815))},l=o.CheckMobile.any();class c extends r.SeriesValuesProvider{constructor(e,t){super(e,t);const i=t.properties().childs().paneProperties.childs().legendProperties.childs();this._showBarChangeProp=i.showBarChange,this._showLastDayChangeProp=i.showLastDayChange,this._showSeriesOHLCProp=i.showSeriesOHLC,this._showVolumeProp=i.showVolume,this._showSeriesLegendCloseOnMobile=i.showSeriesLegendCloseOnMobile,this._seriesStyleProp=e.properties().childs().style;const s=this._emptyValues[0],o=this._emptyValues[1],r=this._emptyValues[2];s.title=a.open,o.title=a.high,r.title=a.low,s.unimportant=!0,o.unimportant=!0,r.unimportant=!0,this._emptyValues[6].title="",this._emptyValues[8].title="",this._emptyValues[4].title=""}getValues(e){const t=super.getValues(e),i=this._series.style(),s=12!==i,o=this._showOHLC(),r=s&&this._showBarChangeProp.value(),c=s&&this._showLastDayChange(),h=!l||this._showSeriesLegendCloseOnMobile.value(),d=this._mobileNonTrackingMode();if(this._showLastPriceAndChangeOnly()){const e=t[5];return e.visible=e.visible&&o&&h&&d,t[8].visible&&=r,t[6].visible=!1,t}const u=12!==i&&16!==i&&21!==i,_=12!==i,p=this._series.intervalObj().value().is1Tick(),m=t[7];m.visible=m.visible&&this._showVolumeProp.value();const g=(0,n.isPriceSourceStyle)(this._seriesStyleProp.value()),S=o&&!g,v=o&&g;if(t[0].visible=S&&u&&!p,t[1].visible=S&&!p,t[2].visible=S&&!p,t[3].visible=S&&_,t[3].title=p?"":a.close,t[4].visible=v,t[6].visible&&=r,t[8].visible&&=c,16===i){const e=this._series.properties().childs().hlcAreaStyle.childs();t[1].color=e.highLineColor.value(),t[2].color=e.lowLineColor.value(),t[3].color=e.closeLineColor.value()}return t}_showOHLC(){return this._showSeriesOHLCProp.value()}_showLastDayChange(){return this._showLastDayChangeProp.value()}}},240512:(e,t,i)=>{"use strict";i.d(t,{SeriesLegendView:()=>a});var s=i(729193),o=i(601066),r=i(960096);const n=s.t(null,void 0,i(159063));class a extends o.SeriesDataWindowView{constructor(e,t){super(e,t),this._backgroundColorSpawn=t.backgroundTopColor().spawn(),this._backgroundColorSpawn.subscribe(this.update.bind(this));const i=t.properties().childs().paneProperties.childs().legendProperties.childs();this._visibilityProperty=(0,
r.combineProperty)(((e,t,i,s,o)=>`${e}:${t}:${i}:${s}:${o}`),i.showBarChange.weakReference(),i.showSeriesOHLC.weakReference(),i.showVolume.weakReference(),i.showLastDayChange.weakReference(),i.showSeriesLegendCloseOnMobile.weakReference()),this._visibilityProperty.subscribe(this,this.update)}areValuesVisible(){return this._visibilityProperty.value().includes("true")}additional(){const e=this._series.dataPoweredBy();return null!==e&&e.length>0?s.t(null,void 0,i(367538))+" "+e:null}marketTitle(){const e=this._series.marketStatusModel().status().value();return this._showLastPriceAndChangeOnly()&&("pre_market"===e||"post_market"===e)?`${n}:`:""}destroy(){this._backgroundColorSpawn.destroy(),this._visibilityProperty.destroy()}_getValuesProvider(){return this._series.legendValuesProvider()}}},632549:(e,t,i)=>{"use strict";i.d(t,{SeriesPrevClosePriceLinePaneView:()=>r});var s=i(288329),o=i(515834);class r extends s.SeriesHorizontalLinePaneView{constructor(e){super(e),this._lineRendererData.linestyle=o.LINESTYLE_DOTTED}_updateImpl(){this._lineRendererData.visible=!1;const e=this._series.properties().childs();if(!e.showPrevClosePriceLine.value()||this._model.isInReplay().value())return;if(this._series.isDWM())return;const t=this._series.prevClose();null!==t&&(this._lineRendererData.visible=!0,this._lineRendererData.y=t.coordinate,this._lineRendererData.color=e.prevClosePriceLineColor.value(),this._lineRendererData.linewidth=e.prevClosePriceLineWidth.value())}}},329750:(e,t,i)=>{"use strict";i.d(t,{SeriesPriceLinePaneView:()=>a});var s=i(266150),o=i(288329),r=i(515834);const n=(0,s.isFeaturesetEnabled)("chart_style_hilo_last_price");class a extends o.SeriesHorizontalLinePaneView{constructor(e){super(e),this._lineRendererData.linestyle=r.LINESTYLE_DOTTED}_updateImpl(){this._lineRendererData.visible=!1;const e=this._series.properties().childs();if(!e.showPriceLine.value())return;if(!n&&12===e.style.value())return;const t=8===e.style.value()&&e.haStyle.childs().showRealLastPrice.value(),i=this._series.lastValueData(t?4:void 0,!0);if(i.noData)return;let s=i.coordinate;if(t){const e=this._series.firstValue(),t=this._series.data().lastProjectionPrice;if(null===e||void 0===t)return;s=this._series.priceScale().priceToCoordinate(t,e)}this._lineRendererData.visible=!0,this._lineRendererData.y=s,this._lineRendererData.color=this._series.priceLineColor(i.color),this._lineRendererData.linewidth=e.priceLineWidth.value()}}},118756:(e,t,i)=>{"use strict";i.d(t,{SeriesPropertiesImpl:()=>S});var s=i(209539),o=i(578519),r=i(185842),n=i(653048),a=i(886470),l=i(193867),c=i(253193),h=i(603550),d=i(507982),u=i(725408),_=i(863922);const p=(0,l.extractThemedColors)(n.lightTheme.content.mainSourceProperties,n.darkTheme.content.mainSourceProperties),m="chartproperties.mainSeriesProperties",g=(0,o.default)((()=>{const e=(0,u.createPropertySchema)((0,s.default)((0,c.factoryDefaults)(m),a.light.content.mainSourceProperties),7);return(0,s.default)(e,{subschema:{priceAxisProperties:{subschema:{lockScale:{saveFlags:6},percentage:{saveFlags:6},
percentageDisabled:{saveFlags:6},indexedTo100:{saveFlags:6},log:{saveFlags:6},logDisabled:{saveFlags:6},isInverted:{saveFlags:6},autoScaleDisabled:{saveFlags:6}}},visible:{type:u.DataTypes.BOOLEAN,saveFlags:2},symbol:{type:u.DataTypes.STRING,saveFlags:2},shortName:{type:u.DataTypes.STRING,saveFlags:2},timeframe:{type:u.DataTypes.STRING,saveFlags:2},interval:{type:u.DataTypes.STRING,saveFlags:2},currencyId:{type:u.DataTypes.STRING,saveFlags:2,nullable:!0},unitId:{type:u.DataTypes.STRING,saveFlags:2,nullable:!0},metricId:{type:u.DataTypes.STRING,saveFlags:2,nullable:!0},style:{type:u.DataTypes.NUMBER,saveFlags:6},sessionId:{type:u.DataTypes.STRING,saveFlags:2}}}),e}));class S extends l.DefaultProperty{constructor(){super({defaultName:m,themedColors:p,schema:g()}),this.hasChild("timeframe")||this.merge({timeframe:""}),this.hasChild("shortName")||this.merge({shortName:""}),this.hasChild("currencyId")||this.addChild("currencyId",new h.Property(null)),this.hasChild("unitId")||this.addChild("unitId",new h.Property(null)),this.hasChild("metricId")||this.addChild("metricId",new h.Property(null));const e=this.childs();if(this.hasChild("extendedHours")){(0,r.ensureDefined)(e.extendedHours).value()&&!this.hasChild("sessionId")&&this.addChild("sessionId",new h.Property("extended")),this.removeProperty("extendedHours")}this.hasChild("sessionId")||this.addChild("sessionId",new h.Property(_.SubsessionId.Regular)),(0,d.allChartStyles)().includes(e.style.value())||e.style.setValueSilently(2);const t=e.lineStyle.childs();if(e.lineStyle.hasChild("styleType")){let i,s;const o=t.styleType.value();0===o&&(s=14,i=e.lineWithMarkersStyle.childs()),1===o&&(s=15,i=e.steplineStyle.childs()),i&&(i.color.setValueSilently(t.color.value()),i.linestyle.setValueSilently(t.linestyle.value()),i.linewidth.setValueSilently(t.linewidth.value()),i.priceSource.setValueSilently(t.priceSource.value())),void 0!==s&&2===e.style.value()&&e.style.setValue(s),e.lineStyle.removeProperty("styleType")}const i=e.volFootprintStyle.childs();if(i.extendedSummary){const e=i.extendedSummary.childs();e.futuresBlockInfo&&(e.extendedOpenInterestBlockInfo.childs().openInterestLow.childs().visible.setValueSilently(e.futuresBlockInfo.childs().openInterestLow.childs().visible.value()),e.extendedOpenInterestBlockInfo.childs().openInterestHigh.childs().visible.setValueSilently(e.futuresBlockInfo.childs().openInterestHigh.childs().visible.value()))}}loadThemeState(e){if(e.volFootprintStyle&&"extendedSummary"in e.volFootprintStyle){const t=e.volFootprintStyle.extendedSummary;t.futuresBlockInfo&&(t.extendedOpenInterestBlockInfo.openInterestHigh.visible=t.futuresBlockInfo.openInterestHigh.visible??!0,t.extendedOpenInterestBlockInfo.openInterestLow.visible=t.futuresBlockInfo.openInterestLow.visible??!0)}this.mergeAndFire(e)}}},611445:(e,t,i)=>{"use strict";i.d(t,{SeriesStatusProvider:()=>_});var s=i(729193),o=i(266150),r=i(70346),n=i(640156),a=i(163949),l=i(656785),c=i(273969);const h=s.t(null,void 0,i(72052)),d=s.t(null,void 0,i(846598)),u=(0,
o.isFeaturesetEnabled)("hide_unresolved_symbols_in_legend");class _ extends a.StatusProviderBase{constructor(e,t,i){super(),this._series=e,this._statusViewProperties=t,this._options=i||{}}text(){return(0,l.generateTitleForGui)(this._getTitleGenerationOptions())}getSplitTitle(){const e=8===this._series.properties().childs().style.value();return(0,l.generateSplitTitleForGui)(this._getTitleGenerationOptions(e))}getInputsTitles(){return null}bold(){return!1}size(){return this._statusViewProperties.childs().fontSize.value()+"px"}errorStatus(){const e=this._series.unsupportedResolutionState().value(),t=e?(0,c.getErrorFromUnsupportedResolutionState)(e):this._series.seriesErrorMessage();return null!==t?{error:t,title:e?d:h}:null}_getTitleGenerationOptions(e){const t=this._series.symbolInfo(),i=this._statusViewProperties.childs(),s=this._series.symbolTextSourceProxyProperty().value();let o;i.showExchange.value()&&t&&(o=(0,r.getSymbolListedExchange)(t));const n=this._series.getInputsProperties().state();17===this._series.style()&&(n.type=this._series.properties().childs().volFootprintStyle.childs().type.value());const a=this._series.aliasSymbolInfo();return{description:m(s,a),listedExchange:o,symbol:u&&null===a?"":this._series.symbolOrAlias(),interval:i.showInterval.value()&&!this._options.hideResolution?this._series.interval():void 0,style:e?void 0:this._series.properties().childs().style.value(),inputs:n,boxSize:this._series.data().boxSize,reversalAmount:this._series.data().reversalAmount,ticker:p(s,a),priceSource:undefined}}}function p(e,t){return"ticker-and-description"!==e?"":null!==t?t.name:void 0}function m(e,t){if(null!==t)return"ticker"===e?t.name:"long-description"===e&&void 0!==t.long_description?t.long_description:(0,n.getTranslatedSymbolDescription)({pro_name:t.pro_name||void 0,short_name:t.name||void 0,description:t.description||void 0,short_description:t.short_description||void 0,local_description:t.local_description||void 0,language:t.language||void 0})}},324585:(e,t,i)=>{"use strict";i.d(t,{SeriesStatusView:()=>r});var s=i(888427),o=i(611445);class r extends s.StatusView{constructor(e,t,i){super(new o.SeriesStatusProvider(e,t,i)),this._invalidated=!0,this._series=e,this._series.onRestarted().subscribe(this,this.update),this._series.dataEvents().symbolResolved().subscribe(this,this.update),this._series.dataEvents().completed().subscribe(this,this.update),this._series.boxSizeValue().subscribe(this.update.bind(this)),t.childs().symbolTextSource.subscribe(this,this.update)}getSeriesPrecision(){let e=4;const t=this._series.symbolInfo();return t&&t.pricescale&&(e=Math.round(Math.log(t.pricescale)/Math.log(10))),e}round(e){const t=this.getSeriesPrecision(),i=Math.round(e*Math.pow(10,t))/Math.pow(10,t);return i?i.toString():""}update(){this._invalidated=!0}text(){return this._updateImpl(),super.text()}bold(){return this._updateImpl(),super.bold()}size(){return this._updateImpl(),super.size()}getSplitTitle(){return this._updateImpl(),this._statusProvider.getSplitTitle()}_updateImpl(){
this._invalidated&&(this._bold=this._statusProvider.bold(),this._size=this._statusProvider.size(),this._text=this._statusProvider.text(),this._invalidated=!1)}}},273969:(e,t,i)=>{"use strict";i.d(t,{getErrorFromUnsupportedResolutionState:()=>c,getResolutionUnsupportedReason:()=>h});var s=i(729193),o=i(357966),r=i(466269);const n=s.t(null,void 0,i(38283)),a=s.t(null,void 0,i(479416)),l=s.t(null,void 0,i(288432));function c(e,t=!1){const i=t?`<b>${e.ticker}</b>`:e.ticker;switch(e.reason){case"unsupported_resolution":{const s=t?`<b>${e.supportedResolutions.join(", ")}</b>`:e.supportedResolutions.join(", ");return n.format({ticker:i,availableResolutions:s})}case"unsupported_ticks":return a.format({ticker:i});case"less_than_frequency":{const s=t?`<b>${e.applicableResolution}</b>`:e.applicableResolution;return l.format({ticker:i,resolution:s})}}}function h(e,t){if(null===e)return null;const i=e.data_frequency;if(void 0!==i){if((0,r.getApplicableIntervalForFrequency)(i,t)!==t)return"less_than_frequency"}return o.Interval.isIntraday(t)&&!e.has_intraday?"unsupported_resolution":o.Interval.isTicks(t)&&!e["is-tickbars-available"]?"unsupported_ticks":null}},872687:(e,t,i)=>{"use strict";i.d(t,{restoreShowNewsNotificationSettingsValue:()=>l,showNewsNotificationsProperty:()=>a});var s=i(950808),o=i(8914);const r="show_news_upd_notif";function n(){return s.getBool(r,!1)}const a=(0,o.createPrimitiveProperty)(n());function l(){a.setValue(!1),s.remove(r)}a.subscribe(null,(()=>s.setValue(r,a.value()))),s.onSync.subscribe(null,(()=>a.setValue(n())))},56770:(e,t,i)=>{"use strict";var s;i.d(t,{StudyStatusType:()=>s}),function(e){e[e.Undefined=0]="Undefined",e[e.Loading=1]="Loading",e[e.Completed=2]="Completed",e[e.Error=3]="Error"}(s||(s={}))},86304:(e,t,i)=>{"use strict";var s;i.d(t,{InsertionErrorCode:()=>s}),function(e){e.StudyCannotBeChild="cannot_be_child",e.StubWasRemoved="stub_was_removed",e.CannotGetMetainfo="cannot_get_metainfo",e.CannotCompilePub="cannot_compile_pub",e.Cancelled="cancelled",e.Unknown="unknown"}(s||(s={}))},143644:(e,t,i)=>{"use strict";i.d(t,{getReplayStrategyMetaInfo:()=>r});var s=i(127985),o=i(830213);function r(){return(0,o.studyMetaInfoRepository)().findById({type:"java",studyId:s.replayStrategyStudyId})}},532180:(e,t,i)=>{"use strict";i.d(t,{ChartColorDependentStudyInputNames:()=>r,InputDisplayFlags:()=>s,RangeDependentStudyInputNames:()=>o,areStudyInputsEqual:()=>d,editableStudyInputs:()=>p,getInputValue:()=>c,isExtendedInput:()=>a,isExtendedInputBool:()=>S,isExtendedInputSource:()=>l,isStudyInputDependsOnChart:()=>g,isStudyInputDependsOnChartColors:()=>m,isStudyInputOptionsInfo:()=>h,isTimeOrPriceNotHiddenInput:()=>_,rangeDependentStudyInputsToTimeRange:()=>u});var s,o,r,n=i(849084);function a(e){return(0,n.default)(e)}function l(e){return"source"===e.t}function c(e){return a(e)?e.v:e}function h(e){return["text","integer","float","price","session","resolution"].includes(e.type)&&e.hasOwnProperty("options")}function d(e,t,i){for(const s of e)if(t[s.id]!==i[s.id])return!1;return!0}function u(e){return{
from:Math.round(e.first_visible_bar_time/1e3),to:Math.round(e.last_visible_bar_time/1e3)}}function _(e){return("time"===e.type||"price"===e.type)&&!0!==e.isHidden}function p(e){const t=e.filter(_);if(0===t.length)return[];const i=new Map,s=[];t.forEach((e=>{const{group:t,inline:o}=e;if(void 0===o)return void s.push(e);const r=o+(t||"");if(i.has(r))i.get(r)?.push(e);else{const t=[e];i.set(r,t),s.push(t)}}));const o=[];for(let e=0;e<s.length;e++){const t=s[e];Array.isArray(t)?2===t.length&&t[0].type!==t[1].type?o.push(t):o.push(...t):o.push(t)}return o}function m(e){return Object.values(r).map((e=>e)).includes(e.id)}function g(e){return!!m(e)||Object.values(o).map((e=>e)).includes(e.id)}function S(e){return(0,n.default)(e)&&"t"in e&&"bool"===e.t&&"v"in e&&"boolean"==typeof e.v}!function(e){e[e.None=0]="None",e[e.DataWindow=2]="DataWindow",e[e.StatusLine=8]="StatusLine",e[e.All=15]="All"}(s||(s={})),function(e){e.FirstBar="first_visible_bar_time",e.LastBar="last_visible_bar_time",e.Realtime="subscribeRealtime"}(o||(o={})),function(e){e.FgColor="__chart_fgcolor",e.BgColor="__chart_bgcolor"}(r||(r={}))},97063:(e,t,i)=>{"use strict";i.d(t,{StudyLineToolStub:()=>n,isStudyLineToolStub:()=>r});var s=i(168509),o=i(252792);function r(e){return e instanceof n}class n extends o.StudyStub{constructor(e,t,i){super(e,{...t,ownFirstValue:null},i),this._linkKey=new s.WatchedValue(t.linkKey??null)}linkKey(){return this._linkKey}}},289625:(e,t,i)=>{"use strict";i.d(t,{applyOverridesToStudyDefaults:()=>d});var s=i(185842),o=i(321582),r=i(77357);const n={line:o.LineStudyPlotStyle.Line,histogram:o.LineStudyPlotStyle.Histogram,cross:o.LineStudyPlotStyle.Cross,area:o.LineStudyPlotStyle.Area,columns:o.LineStudyPlotStyle.Columns,circles:o.LineStudyPlotStyle.Circles,line_with_breaks:o.LineStudyPlotStyle.LineWithBreaks,area_with_breaks:o.LineStudyPlotStyle.AreaWithBreaks,step_line:o.LineStudyPlotStyle.StepLine,step_line_with_breaks:o.LineStudyPlotStyle.StepLineWithBreaks,step_line_with_diamonds:o.LineStudyPlotStyle.StepLineWithDiamonds},a=(0,r.getLogger)("Chart.Model.StudyPropertiesOverrider");var l,c;function h(e,t,i,s){const o=i.split(".");if(0===o.length||0===o[0].length)return;const r=function(e){const t=e.split(":");return{name:t[0],type:2===t.length?t[1]:null}}(o[0]),n=r.name,h=r.type,d=null!==h,u=!d||"band"===h,_=!d||"area"===h,p=!d||"input"===h,m=!d||"plot"===h?c.getPlotIdByTitle(e,n):null,g=u?c.getBandIndexByName(e,n):null,S=_?c.getFilledAreaIdByTitle(e,n):null,v=p?c.getInputByName(e,n):null,f=t.hasOwnProperty(n);if((null!==m?1:0)+(null!==g?1:0)+(null!==S?1:0)+(null!==v?1:0)+(f?1:0)>1)return void a.logWarn(`Study '${e.description}' has ambiguous identifier '${n}'`);const b=o[1];if(null!==m){if(1===o.length)return void a.logWarn(`Path of sub-property of '${n}' plot for study '${e.description}' must be not empty`);const i=o.slice(1);l.applyPlotProperty(e,t,m,i,s)}else if(null!==v)l.applyInputValue(t,v,s);else if(null!==g){if(void 0===b)return void a.logWarn(`Property name of '${n}' band for study '${e.description}' must be set`)
;l.applyBandProperty(t,g,b,s)}else if(null!==S){if(void 0===b)return void a.logWarn(`Property name of '${n}' area for study '${e.description}' must be set`);l.applyFilledAreaProperty(t,S,b,s)}else f?l.setRootProperty(t,o,s):a.logWarn(`Study '${e.description}' has no plot or input '${n}'`)}function d(e,t,i){for(const s in e){if(!e.hasOwnProperty(s))continue;const o=s.indexOf(".");if(-1===o)continue;const r=s.substring(0,o),n=c.getMetaInfoByDescription(t,r);if(null===n){a.logWarn(`There is no such study ${r}`);continue}const l=i(n);null!==l?h(n,l,s.substring(o+1),e[s]):a.logWarn(`Cannot apply overrides for study ${r}`)}}!function(e){e.applyPlotProperty=function(e,t,i,r,l){if(void 0===t.styles)return void a.logWarn("Study does not have styles");const c=r[0];if("color"===c){const n=function(e,t,i){if(void 0===e.plots)return null;for(const s of e.plots){if(!(0,o.isPaletteColorerPlot)(s)||void 0===t.palettes)continue;const e=t.palettes[s.palette];if(s.target===i&&void 0!==e)return e}return null}(e,t,i);return void function(e,t,i,o,r){void 0!==e.styles?null===t&&!isNaN(o)&&o>0?a.logWarn(`Study plot does not have color #${o}`):((0===o||isNaN(o))&&((0,s.ensureDefined)(e.styles[i]).color=String(r),o=0),null!==t&&((0,s.ensureDefined)(t.colors?.[o]).color=String(r))):a.logWarn("Study does not have styles")}(t,n,i,r.length>1?parseInt(r[1]):NaN,l)}const h=t.styles[i];if(void 0!==h&&h.hasOwnProperty(c)){if("plottype"===c){const e=n[String(l)];if(void 0===e)return void a.logWarn(`Unsupported plot type for plot: ${l}`);l=e}h[c]=l}else a.logWarn(`Study plot does not have property '${c}'`)},e.applyBandProperty=function(e,t,i,s){if(void 0===e.bands)return void a.logWarn("Study does not have bands");const o=e.bands[t];if(void 0!==o&&o.hasOwnProperty(i)){if("plottype"===i){const e=n[String(s)];if(void 0===e)return void a.logWarn(`Unsupported plot type for band: ${s}`);s=e}o[i]=s}else a.logWarn(`Study band does not have property '${i}'`)},e.applyFilledAreaProperty=function(e,t,i,s){if(void 0===e.filledAreasStyle)return void a.logWarn("Study does not have areas");const o=e.filledAreasStyle[t];void 0!==o&&o.hasOwnProperty(i)?o[i]=s:a.logWarn(`Study area does not have property '${i}'`)},e.applyInputValue=function(e,t,i){void 0!==e.inputs&&e.inputs.hasOwnProperty(t)?e.inputs[t]=i:a.logWarn(`Study does not have input '${t}'`)},e.setRootProperty=function(e,t,i){if(0===t.length)return;let s=e;for(const e of t.slice(0,-1)){if(null==s||!s.hasOwnProperty(e))break;s=s[e]}const o=t[t.length-1];null!=s&&s.hasOwnProperty(o)?s[o]=i:a.logWarn(`Study does not have property ${t.join(".")}`)}}(l||(l={})),function(e){e.getInputByName=function(e,t){if(void 0===e.inputs)return null;t=t.toLowerCase();for(const i of e.inputs)if(i.name.toLowerCase()===t)return i.id;return null},e.getPlotIdByTitle=function(e,t){if(void 0===e.styles)return null;t=t.toLowerCase();for(const i in e.styles){const s=e.styles[i];if((void 0!==s&&void 0!==s.title?s.title:i).toLowerCase()===t)return i}return null},e.getFilledAreaIdByTitle=function(e,t){if(void 0===e.filledAreas)return null
;t=t.toLowerCase();for(const i of e.filledAreas)if(i.title.toLowerCase()===t)return i.id;return null},e.getBandIndexByName=function(e,t){if(void 0===e.bands)return null;t=t.toLowerCase();for(let i=0;i<e.bands.length;++i)if(e.bands[i].name.toLowerCase()===t)return i;return null},e.getMetaInfoByDescription=function(e,t){t=t.toLowerCase();for(const i of e)if(i.description.toLowerCase()===t||i.shortDescription.toLowerCase()===t)return i;return null}}(c||(c={}))},45587:(e,t,i)=>{"use strict";i.d(t,{translateSessionDescription:()=>r,translateSessionExtendedDescription:()=>l,translateSessionShortDescription:()=>a});var s=i(729193);const o=new Map([["premarket",s.t(null,{context:"sessions"},i(572014))],["postmarket",s.t(null,{context:"sessions"},i(671294))],["regular trading hours",s.t(null,{context:"sessions"},i(845067))],["extended trading hours",s.t(null,{context:"sessions"},i(422252))],["electronic trading hours",s.t(null,{context:"sessions"},i(427985))]]);function r(e){return o.get(e.toLowerCase())??e}const n=new Map([["premarket",s.t(null,{context:"sessions"},i(867555))],["postmarket",s.t(null,{context:"sessions"},i(900516))],["regular trading hours",s.t(null,{context:"sessions"},i(925526))],["extended trading hours",s.t(null,{context:"sessions"},i(689965))],["electronic trading hours",s.t(null,{context:"sessions"},i(689965))]]);function a(e){return n.get(e.toLowerCase())??e}function l(e){return o.get(e.toLowerCase())??e}},530282:(e,t,i)=>{"use strict";i.d(t,{restoreTimeHoursFormatSettingsValue:()=>l,timeHoursFormatProperty:()=>a});var s=i(950808),o=i(8914);const r="time_hours_format";function n(){return s.getValue(r,"24-hours")}const a=(0,o.createPrimitiveProperty)(n());function l(){a.setValue("24-hours"),s.remove(r)}s.onSync.subscribe(null,(()=>a.setValue(n()))),a.subscribe(null,(()=>s.setValue(r,a.value())))},561201:(e,t,i)=>{"use strict";i.d(t,{SyncModel:()=>l});var s=i(978802),o=i(386228),r=i(502643),n=i(584104);let a=0;class l{constructor(e,t){this._extrapolatedData=[],this._cacheForFuture=!1,this._modelId=a++,this._builderCache=null,this._uniqueId=(0,n.randomHashN)(6),this._resolution=t,this._symbolInfo=e,this._valid=Boolean(e.timezone)&&Boolean(e.session),this._session=new s.SessionInfo(e.timezone,e.session,e.session_holidays,e.corrections)}syncSourceTarget(){return{uniqueId:this._uniqueId,resolution:this._resolution,session:this._session.state()}}getSymbolInfo(){return this._symbolInfo}getSession(){return this._session}getResolution(){return this._resolution}uniqueId(){return this._modelId}distance(e,t){if(!this.isValid())return{success:!1};if(e>t)return{success:!1};if(e===t)return{success:!0,result:0};let i=this._extrapolatedData.length,s=0!==i?this._extrapolatedData[0]:null,o=null!==s?this._extrapolatedData[i-1]:null;const n=e<t;if(1e3*e===s&&this._cacheForFuture===n||(this._extrapolatedData=[1e3*e],i=1,s=null,o=null),null===s||null!==o&&1e3*t>o){const s=(0,r.extrapolateBarsFrontToTime)(this.barBuilder(),o||1e3*e,1e3*t,2e3,!0);this._extrapolatedData=this._extrapolatedData.concat(s.times),
i=this._extrapolatedData.length,this._cacheForFuture=n}if(o=this._extrapolatedData[i-1],o<1e3*t)return{success:!1};const a=this._extrapolatedData.indexOf(1e3*t);return-1===a?{success:!1}:{success:!0,result:a}}projectTime(e,t){if(!this.isValid())return e;let i=this._extrapolatedData.length,s=i>0?this._extrapolatedData[0]:null,o=null!==s?this._extrapolatedData[i-1]:null;const n=t>=0;1e3*e===s&&this._cacheForFuture===n||(this._extrapolatedData=[1e3*e],i=1,s=null,o=null);const a=Math.abs(t);if(null===s||a>=i){const s=(0,r.extrapolateBarsFrontByCount)(this.barBuilder(),o||1e3*e,Math.sign(t)*(a-i+1),!0);this._extrapolatedData=this._extrapolatedData.concat(s.times),i=this._extrapolatedData.length,this._cacheForFuture=n}return i<a?e:this._extrapolatedData[a]/1e3}isValid(){return this._valid}dataSize(){return this._extrapolatedData.length}createNewModelWithResolution(e){return new l(this._symbolInfo,e)}barBuilder(){return null===this._builderCache&&(this._builderCache=(0,o.newBarBuilder)(this._resolution,this._session,this._session)),this._builderCache}}},766332:(e,t,i)=>{"use strict";i.d(t,{forceTradingObjVisibilityOnScreenshot:()=>h,restoreShowOnScreenshotSettingsValue:()=>c,showOnScreenshotProperty:()=>l});var s=i(950808),o=i(168509),r=i(8914);const n="trading_drawings_on_screenshot";function a(){return s.getBool(n,!1)}const l=(0,r.createPrimitiveProperty)(a());function c(){l.setValue(!1),s.remove(n)}s.onSync.subscribe(null,(()=>l.setValue(a()))),l.subscribe(null,(()=>s.setValue(n,l.value())));const h=new o.WatchedValue(null)},332157:(e,t,i)=>{"use strict";i.d(t,{translatedIntervalString:()=>o});var s=i(466269);function o(e,t){const i=(0,s.getTranslatedResolutionModel)(e,!0);return null===i?e:i.multiplier+(i.mayOmitShortKind&&!t?"":i.shortKind)}},988079:(e,t,i)=>{"use strict";i.d(t,{ExcludeLineToolsFromGroupUndoCommand:()=>h});var s=i(185842),o=(i(686923),i(729193)),r=i(913947),n=i(385955),a=i(582569),l=i(965947);const c=new r.TranslatedString("exclude line tools from group {group}",o.t(null,void 0,i(288570)));class h extends a.UndoCommand{constructor(e,t,i){super(c.format({group:t.name().value()}),void 0,!l.lineToolsDoNotAffectChartInvalidation),this._model=e,this._groupId=t.id,this._groupName=t.name().value(),this._lineToolsIds=i.map((e=>e.id()))}redo(){const e=(0,s.ensureNotNull)(this._model.lineToolsGroupModel().groupForId(this._groupId)),t=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))).filter(n.notNull);e.excludeLineTools(t),0===e.lineTools().length&&this._model.lineToolsGroupModel().removeGroup(e)}undo(){const e=this._lineToolsIds.map((e=>this._model.dataSourceForId(e))),t=this._model.lineToolsGroupModel().groupForId(this._groupId);null!==t?t.addLineTools(e):this._model.lineToolsGroupModel().createGroup(e,this._groupName,this._groupId)}}},302500:(e,t,i)=>{"use strict";i.d(t,{InsertStudyCommand:()=>d});var s=i(185842),o=i(17147),r=i(3135),n=i(537244),a=i(44408),l=i(461592),c=i(582569),h=i(858328);class d extends c.UndoCommand{constructor(e){
const{chartModel:t,studyMetaInfo:i,inputs:s,props:o,addAsOverlay:r,parentSources:n,preferredPriceScale:a,allowChangeCurrency:l,allowChangeUnit:c,allowChangeMetric:h,paneSize:d,targetZOrder:u,studyId:_,targetScaleMode:p,undoText:m,eventSource:g}=e;super(m??null),this._paneState=null,this._studyInserResult=null,this._additionalStudiesInsertResults=[],this._hasAlreadyBeenUndone=!1,this._chartModel=t,this._studyMetaInfo=i,this._props=o,this._addAsOverlay=r,this._parentIds=n?.map((e=>e.id())),this._inputs=s,this._targetZOrder=u,this._preferredPriceScale=a,this._allowChangeCurrency=l,this._allowChangeUnit=c,this._allowChangeMetric=h,this._paneSize=d,this._studyId=_??null,this._targetScaleMode=p??null,this._eventSource=g}redo(){const e=this._parentIds?.map((e=>this._chartModel.dataSourceForId(e)));this._studyInserResult=this._chartModel.insertStudyWithParams({studyMetaInfo:this._studyMetaInfo,inputs:this._inputs,targetZOrder:this._targetZOrder,propsState:this._props,forceOverlay:this._addAsOverlay,parentSources:e,preferredPriceScale:this._preferredPriceScale,allowChangeCurrency:this._allowChangeCurrency,allowChangeUnit:this._allowChangeUnit,allowChangeMetric:this._allowChangeMetric,paneSize:this._paneSize,targetScaleMode:this._targetScaleMode??void 0,id:this._studyId??void 0}),this._studyInserResult.study.then((e=>{if((0,l.isSymbolSource)(e)){null!==e.symbolInfo()?this._createCopiesOfExistingFundamentalsForNewStock(e):e.symbolResolved().subscribe(this,(()=>this._createCopiesOfExistingFundamentalsForNewStock(e)),!0)}else(0,a.isFundamentalStudy)(e)&&this._createCopiesOfNewFundamentalForAllStocks(e);this._studyId=e.id(),e.childStudyByRebind().subscribe(null,(()=>(0,h.trackEvent)("SOS","Apply SOS","Rebind SOS")));{const t=this._hasAlreadyBeenUndone?this._eventSource?`redo_${this._eventSource}`:"redo":this._eventSource;(0,o.trackStudies)(e.metaInfo(),e.model(),"add",t)}if(this._chartModel.setShouldBeSavedEvenIfHidden(!0),null!==this._paneState){(0,s.ensureNotNull)(this._chartModel.paneForSource(e)).restoreState({state:this._paneState,withData:!1,version:this._chartModel.version()}),this._paneState=null}}))}undo(){const e=(0,s.ensureNotNull)(this._studyInserResult),t=e.entityId();let i=null,r=null;if(null!==t){i=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(t));const o=e.originalScaleMode();null!==o&&i.priceScale()?.setMode(o),(0,l.isSymbolSource)(i)&&i.symbolResolved().unsubscribeAll(this),r=(0,s.ensureNotNull)(this._chartModel.paneForSource(i)).state()}else e.cancel();this._studyInserResult?.cancel();for(const e of this._additionalStudiesInsertResults){const t=e.entityId();null!==t?this._chartModel.removeSource((0,s.ensureNotNull)(this._chartModel.dataSourceForId(t))):e.cancel()}this._additionalStudiesInsertResults=[],null!==i&&this._chartModel.removeSource(i)&&(this._paneState=r),i&&(0,o.trackStudies)(i.metaInfo(),i.model(),"remove","undo"),this._hasAlreadyBeenUndone=!0}insertedStudy(){return(0,s.ensureNotNull)(this._studyInserResult)}_createCopiesOfNewFundamentalForAllStocks(e){let t=(0,s.ensureNotNull)((0,
n.getConfig)("FUNDAMENTALS_ON_CHART")).limit-this._chartModel.chartApi().getFundamentalCounter();e.isStarted()||(t-=1);const i=this._studyMetaInfo.symbolInputId(),o=this._chartModel.symbolSources();for(const n of o){if(t<=0)break;if(!n.isVisible()||n===e.symbolSource())continue;const o=n.symbolInfo();if(null!==o&&(0,r.isStockSymbol)(o.type,o.typespecs)){const e={};e[(0,s.ensureNotNull)(i)]=n.symbol();const o=this._chartModel.insertStudyWithParams({studyMetaInfo:this._studyMetaInfo,inputs:e,targetZOrder:null,propsState:this._props,forceOverlay:!1});this._additionalStudiesInsertResults.push(o),t-=1}}}_createCopiesOfExistingFundamentalsForNewStock(e){let t=(0,s.ensureNotNull)((0,n.getConfig)("FUNDAMENTALS_ON_CHART")).limit-this._chartModel.chartApi().getFundamentalCounter();const i=e.symbolInfo();if(null!==i&&(0,r.isStockSymbol)(i.type,i.typespecs)){const i=new Set,o=this._chartModel.allStudies(!0).filter((e=>(0,a.isFundamentalStudy)(e)&&e.isVisible()));for(const r of o){if(t<=0)break;const o=r.metaInfo();if(!i.has(o.fullId)){const r={};r[(0,s.ensureNotNull)(o.symbolInputId())]=e.symbol();const n=this._chartModel.insertStudyWithParams({studyMetaInfo:o,inputs:r,targetZOrder:null,propsState:this._props,forceOverlay:!1});this._additionalStudiesInsertResults.push(n),t-=1,i.add(o.fullId)}}}}}},741529:(e,t,i)=>{"use strict";i.d(t,{LineToolSynchronizeUndoCommand:()=>o});var s=i(582569);class o extends s.UndoCommand{constructor(e,t,i,s=!0){super(t,i,s),this._invalidateViaSync=!1,this._chartModel=e,this._invalidateViaSync=e.lineToolsSynchronizer().invalidateViaSync()}redo(){this._invalidateViaSync?this._chartModel.lineToolsSynchronizer().executeSynchronizationInLayoutAction((async()=>this._redo())):this._redo()}undo(){this._invalidateViaSync?this._chartModel.lineToolsSynchronizer().executeSynchronizationInLayoutAction((async()=>this._undo())):this._undo()}}},43977:(e,t,i)=>{"use strict";i.d(t,{MergeDownUndoCommand:()=>l,MergeToTargetPane:()=>c,MergeUpUndoCommand:()=>a});var s=i(185842),o=i(781434),r=i(75266);class n extends r.MoveSourceUndoCommand{constructor(e,t,i,s){super(e,t,i),this._restorePane=!1,this._keepZOrder=s??!1,this._initialZOrder=t.zorder()}redo(){const e=this._chartModel.panes().length,t=this._chartModel.panes()[this._targetPaneIndex()],i=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),o=(0,s.ensureNotNull)(this._chartModel.paneForSource(i)),r=this._chartModel.children(i,!0,!0).sort(((e,t)=>e.zorder()-t.zorder()));o.bulkActionMacro((()=>{r.forEach((e=>this._chartModel.detachSource(e))),this._restorePane=this._chartModel.detachSource(i)}));const n="overlay"===this._initialPriceScalePosition?this._initialPriceScalePosition:void 0,a=t.findSuitableScale(i,void 0,n),l=0===a.dataSources().length;if(t.bulkActionMacro((()=>{t.addDataSource(i,a,this._keepZOrder),r.forEach((e=>t.addDataSource(e,a,this._keepZOrder)))})),i===this._chartModel.mainSeries()){const e=t.priceScalePosition(a);t.movePriceScale(a,e,0)}if(l){const e=(0,s.ensureNotNull)(i.priceScale())
;e.restoreState(this._newPriceScaleState(t.isOverlay(i))),e.setHeight(t.height())}this._chartModel.fullUpdate(),e!==this._chartModel.panes().length&&this._chartModel.setShouldBeSavedEvenIfHidden(!0)}undo(){let e;e=this._restorePane?this._chartModel.createPane(this._initialPaneIndex):this._chartModel.panes()[this._initialPaneIndex];const t=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),i=(0,s.ensureNotNull)(this._chartModel.paneForSource(t)),o=this._chartModel.children(t,!0,!0).sort(((e,t)=>e.zorder()-t.zorder()));i.bulkActionMacro((()=>{o.forEach((e=>this._chartModel.detachSource(e))),this._chartModel.detachSource(t)}));let r=e.getPriceScaleById(this._initialPriceScaleId);null===r&&(r=e.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex)),e.bulkActionMacro((()=>{t.setZorder(this._initialZOrder),e.addDataSource(t,r,!0),o.forEach((t=>e.addDataSource(t,r,!1)))}));const n=(0,s.ensureNotNull)(t.priceScale());n.restoreState(this._originalPriceScaleState()),n.setHeight(e.height()),this._chartModel.fullUpdate()}}class a extends n{constructor(e,t,i){super(e,t,i)}_targetPaneIndex(){const e=this._chartModel.panes();for(let t=this._initialPaneIndex-1;t>=0;t--)if(e[t].mode()===o.PaneMode.Regular)return t;throw new Error("No regular pane found above for merging")}}class l extends n{constructor(e,t,i){super(e,t,i)}_targetPaneIndex(){const e=this._chartModel.panes();for(let t=this._initialPaneIndex+1;t<e.length;t++)if(e[t].mode()===o.PaneMode.Regular)return t;throw new Error("No regular pane found below for merging")}}class c extends n{constructor(e,t,i,s,o){super(e,t,s,o),this._targetPane=i}_targetPaneIndex(){return this._targetPane}}},75266:(e,t,i)=>{"use strict";i.d(t,{MoveSourceUndoCommand:()=>r});var s=i(185842),o=i(582569);class r extends o.UndoCommand{constructor(e,t,i){super(i),this._chartModel=e,this._sourceId=t.id();const o=(0,s.ensureNotNull)(t.priceScale());this._initialPriceScaleId=o.id(),this._initialPriceScaleState=(0,s.ensureNotNull)(t.priceScale()).state();const r=(0,s.ensureNotNull)(e.paneForSource(t));this._initialPriceScalePosition=r.priceScalePosition(o),this._initialPriceScaleIndex=r.priceScaleIndex(o,this._initialPriceScalePosition),this._initialPaneIndex=e.panes().indexOf(r)}_newPriceScaleState(e){const t={...this._initialPriceScaleState};return delete t.m_isLockScale,delete t.id,delete t.m_topMargin,delete t.m_bottomMargin,delete t.hasCalculatedPriceRange,t}_originalPriceScaleState(){return this._initialPriceScaleState}}},112511:(e,t,i)=>{"use strict";i.d(t,{MoveToExistingPriceScaleUndoCommand:()=>a,MoveToNewPriceScaleUndoCommand:()=>n});var s=i(185842),o=i(75266);class r extends o.MoveSourceUndoCommand{constructor(e,t,i,s){super(e,t,s),this._sourcePaneRemoved=!1,this._targetPaneIndex=e.panes().indexOf(i)}redo(){const e=this._chartModel.panes()[this._initialPaneIndex],t=this._chartModel.panes()[this._targetPaneIndex],i=e!==t,o=this._targetPriceScale(t),r=(0,
s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId)),n=this._chartModel.children(r,!0,!0);for(const e of n)i?(this._chartModel.detachSource(e),t.addDataSource(e,o,!1)):t.move(e,o);i?(this._sourcePaneRemoved=this._chartModel.detachSource(r),t.addDataSource(r,o,!1)):t.move(r,o);const a=t.priceScalePosition(o);t.movePriceScale(o,a,this._targetPriceScaleIndex(r)),this._chartModel.fullUpdate()}undo(){this._sourcePaneRemoved&&this._chartModel.createPane(this._initialPaneIndex);const e=this._chartModel.panes()[this._initialPaneIndex],t=e!==this._chartModel.panes()[this._targetPaneIndex],i=(0,s.ensureNotNull)(this._chartModel.dataSourceForId(this._sourceId));let o=e.getPriceScaleById(this._initialPriceScaleId);null===o&&(o=e.createPriceScaleAtPosition(this._initialPriceScalePosition,this._initialPriceScaleIndex));const r=this._chartModel.children(i,!0,!0);for(const i of r)t?(this._chartModel.detachSource(i),e.addDataSource(i,o,!1)):e.move(i,o);t?(this._chartModel.detachSource(i),e.addDataSource(i,o,!1)):e.move(i,o);const n=(0,s.ensureNotNull)(i.priceScale());n.restoreState(this._originalPriceScaleState()),n.setHeight(e.height()),this._chartModel.fullUpdate()}}class n extends r{constructor(e,t,i,s,o){super(e,t,i,o),this._targetPriceScalePosition=s}_targetPriceScale(e){const t=e.createPriceScaleAtPosition(this._targetPriceScalePosition);return t.restoreState(this._newPriceScaleState("overlay"===this._targetPriceScalePosition)),t.setHeight(e.height()),t}_targetPriceScaleIndex(e){return e===this._chartModel.mainSeries()?0:void 0}}class a extends r{constructor(e,t,i,s,o){super(e,t,i,o),this._targetPriceScaleId=s.id()}_targetPriceScale(e){return(0,s.ensureNotNull)(e.getPriceScaleById(this._targetPriceScaleId))}_targetPriceScaleIndex(e){}}},782486:(e,t,i)=>{"use strict";i.d(t,{RemoveSourcesUndoCommand:()=>f});var s=i(185842),o=i(77357),r=i(729193),n=i(913947),a=i(17147),l=i(741529),c=i(430916),h=i(44408),d=i(965947),u=i(988079);class _ extends l.LineToolSynchronizeUndoCommand{constructor({chartModel:e,title:t,lineDataSourceIds:i}){super(e,t,void 0,!d.lineToolsDoNotAffectChartInvalidation),this._excludeLineToolsFromGroupUndoCommands=[],this._undoState=[],this._lineDataSourceIds=i}_redo(){const e=this._lineDataSourceIds.map((e=>(0,s.ensureNotNull)(this._chartModel.dataSourceForId(e))));this._groupLineToolsByGroups(e).forEach(((e,t)=>{const i=new u.ExcludeLineToolsFromGroupUndoCommand(this._chartModel,t,e);i.redo(),this._excludeLineToolsFromGroupUndoCommands.push(i)})),e.forEach((e=>{this._undoState.push({state:e.state(!1),paneIndex:this._chartModel.panes().indexOf((0,s.ensureNotNull)(this._chartModel.paneForSource(e))),sharingMode:e.sharingMode().value()}),this._chartModel.removeSource(e)}))}_undo(){for(let e=this._undoState.shift();e;e=this._undoState.shift())this._chartModel.restoreSource(!1,e.paneIndex,null,e.state,null)?.share(e.sharingMode);this._excludeLineToolsFromGroupUndoCommands.forEach((e=>e.undo()))}_groupLineToolsByGroups(e){const t=this._chartModel.lineToolsGroupModel();return e.reduce(((e,i)=>{
const s=t.groupForLineTool(i);if(null!==s){const t=e.get(s)||[];t.push(i),e.set(s,t)}return e}),new Map)}}var p=i(252792),m=i(863091),g=i(127985);const S=(0,o.getLogger)("Chart.RemoveSourcesUndoCommand"),v=new n.TranslatedString("remove line data sources",r.t(null,void 0,i(541659)));class f extends l.LineToolSynchronizeUndoCommand{constructor(e,t,i){super(e,i,void 0,(0,m.sourcesAffectState)(t)),this._removeLineDataSourcesUndoCommand=null,this._initialPriceScaleMode=null;const[o,r]=(0,c.sourcesAndLineTools)(e,t);this._sourceIds=o,this._lineDataSourceIds=r,this._sourceStates=[],this._paneIndexes=[],this._priceScalePositionIds=[],this._paneStates=[],this._restorePanes=[];const n=t[0];1===t.length&&(0,h.isStudy)(n)&&(this._initialPriceScaleMode=(0,s.ensureNotNull)(n.priceScale()).mode())}removedIds(){return[...this._sourceIds,...this._lineDataSourceIds]}_redo(){const e=this._chartModel.panes().length,t=this._sourceIds.map((e=>(0,s.ensureNotNull)(this._chartModel.dataSourceForId(e))));this._sourceStates=t.map((e=>{const t=e.state(!1);return null===t&&(0,h.isStudyStub)(e)?e.getDescriptor():t}));const i=t.map((e=>(0,s.ensureNotNull)(this._chartModel.paneForSource(e))));this._paneIndexes=i.map((e=>this._chartModel.panes().indexOf(e))),this._lineDataSourceIds.length>0&&(this._removeLineDataSourcesUndoCommand=new _({title:v,chartModel:this._chartModel,lineDataSourceIds:this._lineDataSourceIds}),this._removeLineDataSourcesUndoCommand.redo()),this._priceScalePositionIds=t.map(((e,t)=>{const s=e.priceScale();if(null===s)return null;const o=i[t].priceScalePosition(s);return{id:s.id(),position:o,priceScaleIndex:i[t].priceScaleIndex(s,o)}}));const o=new Set;t.forEach(((e,t)=>{o.add(this._paneIndexes[t])})),this._paneStates=t.map(((e,t)=>{const s=this._paneIndexes[t];return o.has(s)?i[t].state({includeSources:!1,withData:!0}):null})),this._restorePanes=t.map((e=>this._chartModel.removeSource(e))),t.forEach((e=>{(0,h.isStudy)(e)&&(0,a.trackStudies)(e.metaInfo(),e.model(),"remove")})),e!==this._chartModel.panes().length&&this._chartModel.setShouldBeSavedEvenIfHidden(!0)}_undo(){const e=[];for(let t=this._sourceStates.length-1;t>=0;t--){const i=this._sourceStates[t];if(null!==i){let s=null;s=(0,p.isStudyStubDescriptor)(i)?this._chartModel.restoreStudyStub(i):this._chartModel.restoreSource(this._restorePanes[t],this._paneIndexes[t],this._paneStates[t],i,this._priceScalePositionIds[t]),s&&(e.push(s),((0,h.isStudy)(s)||(0,h.isStudyStub)(s))&&(0,a.trackStudies)(new g.StudyMetaInfo(i.metaInfo),s.model(),"add","undo"))}}e.some(((t,i)=>t.id()!==this._sourceIds[e.length-i-1]))&&S.logError("Source was restored improperly - source ids does not match"),null!==this._initialPriceScaleMode&&(0,s.ensureNotNull)(e[0].priceScale()).setMode(this._initialPriceScaleMode),this._removeLineDataSourcesUndoCommand&&this._removeLineDataSourcesUndoCommand.undo()}}},580837:(e,t,i)=>{"use strict";i.d(t,{SetPropertyUndoCommand:()=>d,prepareDependentValues:()=>l,restoreDependentValues:()=>c});var s=i(582569),o=i(193867),r=i(316746),n=i(153987);function a(e){return{
val:e.value(),dependenValues:e.dependents?.().map(a)??[]}}function l(e){return(e.dependents?.()??[]).map(a)}function c(e,t){(e.dependents?.()??[]).forEach(((e,i)=>{e.setValue(t[i].val),(e.dependents?.()??[]).forEach((e=>c(e,t[i].dependenValues)))}))}function h(e,t){return"string"==typeof t?(0,n.propertyByPath)(e,t):t}class d extends s.UndoCommand{constructor(e,t,i,s,o=!0){super(i,void 0,o);const r=e.pathToRoot();this._targetObj=(0,n.isRootPath)(r)?r:e,this._newValue=t,this._oldValue=e.value(),this._dependentValues=l(e),this._model=s}redo(e){(0,o.allowSavingDefaults)(!0),h(e.chartWidgetCollection,this._targetObj).setValue(this._newValue),(0,o.allowSavingDefaults)(!1),this._model.recalculateAllPanes((0,r.globalChangeEvent)()),this._model.lightUpdate()}undo(e){(0,o.allowSavingDefaults)(!0);const t=h(e.chartWidgetCollection,this._targetObj);t.setValue(this._oldValue),c(t,this._dependentValues),(0,o.allowSavingDefaults)(!1),this._model.recalculateAllPanes((0,r.globalChangeEvent)()),this._model.lightUpdate()}}},430916:(e,t,i)=>{"use strict";i.d(t,{closeSourcesSet:()=>n,removeAllSourcesWithDependencies:()=>l,sourcesAndLineTools:()=>a});var s=i(385955),o=i(727724);function r(e,t,i){let s=[];const o=e.children(t,!1,i);for(let t=0;t<o.length;t++)s=s.concat(r(e,o[t],i));return s.push(t),s}function n(e,t,i){const s=new Set,o=t=>{e.children(t,!1,i).forEach((e=>{s.has(e)||(s.add(e),o(e))}))};return t.forEach(o),t.filter((e=>!s.has(e))).map((t=>r(e,t,i))).reduce(((e,t)=>e.concat(t)),[])}function a(e,t){return n(e,t,!0).reduce(((e,t)=>((0,o.isLineTool)(t)?e[1].push(t.id()):e[0].push(t.id()),e)),[[],[]])}function l(e,t){a(e,t).reverse().forEach((t=>{t.map((t=>e.dataSourceForId(t))).filter(s.notNull).forEach((t=>{(0,o.isLineTool)(t)&&e.lineToolsGroupModel().removeLineTools([t]),e.removeSource(t)}))}))}},864210:(e,t,i)=>{"use strict";i.d(t,{VolumeBasedTimePointWeights:()=>o});var s=i(151515);class o extends s.ComputedTimePointWeights{constructor(e){super(),this._middleVolume=e,this._minValidVolume=.9*e}setVolume(e,t){this.setWeight(e,1+Math.log2(Math.max(t,this._minValidVolume)/this._middleVolume))}}},466008:(e,t,i)=>{"use strict";i.d(t,{restoreWithWeekdaySettingsValue:()=>l,withWeekdayProperty:()=>a});var s=i(950808),o=i(8914);const r="date_format_with_weekday";function n(){return s.getBool(r,!0)}const a=(0,o.createPrimitiveProperty)(n());function l(){a.setValue(!0),s.remove(r)}a.subscribe(null,(()=>s.setValue(r,a.value()))),s.onSync.subscribe(null,(()=>a.setValue(n())))},917273:(e,t,i)=>{"use strict";i.d(t,{moveAfterSource:()=>D,moveBeforeSource:()=>B,newLineToolZOrder:()=>T,newStudyZOrder:()=>P,prepareZOrderFixIfRequired:()=>R,reorderDataSourcesStateZOrder:()=>y});var s=i(668278),o=i(185842),r=i(101458),n=i(44408),a=i(658273),l=i(149497),c=i(188485);function h(e){return(0,r.isLineTool)(e)&&!e.isSpeciallyZOrderedSource()}function d(e){return(0,n.isStudy)(e)&&!e.isSpeciallyZOrderedSource()||(0,n.isStudyStub)(e)}function u(e,t){return e.zorder-t.zorder}function _(e,t){(0,l.isMainSeriesState)(e)?e.zorder=0:e.zorder=t}function p(e,t){
e.setZorder(t)}function m(e){return e.zorder()}function g(e){return Math.round(1e3*e)/1e3}function S(e,t){const i=Math.max(e,t),s=Math.min(e,t);return Math.max(0,Math.ceil(i)-Math.floor(s)-1)}function v(e,t,i){let s=0;const o=function(e,t){const i=1e3;return Math.abs(t*i-e*i)/i}(t,e);var r;return o>i?(e=Math.trunc(e),s=Math.floor(o/(i+1))):(r=o/(i+1),s=Math.floor(1e3*r)/1e3),{startZOrder:e,zOrderStep:s}}function f(e,t,i,s){let o=e.length,r=t;for(let t=e.length-1;t>=-1;t--)if(-1===t||s(e[t])){const s=t;let n=x(r);if(o-1===s)s>=0&&i(e[s],n);else{const t=S(o,s);let a=0;for(;0===a;){const e=v(r,n,t);r=e.startZOrder,a=e.zOrderStep,0===a&&(n-=1e4,0===n&&(n-=1e4))}let l=o-1;for(;l>s;){const t=g(r-a);i(e[l],t),r=t,l--}s>=0&&i(e[s],n)}r=n,o=s}}function b(e,t,i,s){let o=-1,r=t;for(let t=0;t<=e.length;t++)if(t===e.length||s(e[t])){const s=t;let n=M(r);if(o+1===s)s<=e.length-1&&i(e[s],n);else{const t=S(o,s);let a=0;for(;0===a;){const e=v(r,n,t);r=e.startZOrder,a=e.zOrderStep,0===a&&(n+=1e4,0===n&&(n+=1e4))}let l=o+1;for(;l<=s-1;){const t=g(r+a);i(e[l],t),r=t,l++}s<=e.length-1&&i(e[s],n)}r=n,o=s}}function y(e){!function(e,t,i,s,o,r){let n=null;const a=[];for(const o of e)t(o)?(a.push(o),n=o):(i(o)||s(o))&&a.push(o);a.sort(r),null!==n&&o(n,0);const l=null===n?-1:a.indexOf(n);-1!==l?(f(a.slice(0,l),0,o,i),b(a.slice(l+1),0,o,i)):b(a,0,o,i)}(e,l.isMainSeriesState,l.isStudyState,l.isLineToolState,_,u)}function w(e,t){const i=Math.floor(e/1e4);let s=t.get(i);return void 0===s&&(s=[],t.set(i,s)),s}function C(e,t,i,s,o,r){let n=-1/0,a=1/0,l=-1/0,c=0;const h=new Map;for(let s=0;s<e.length;++s){const r=e[s],d=o(r);t(r)?(n=Math.max(n,d),w(d,h).push(r)):i(r)&&(d<0&&(a=Math.min(a,d),l=Math.max(l,d)),c=Math.max(c,d))}if(r){const e=Math.max(c,n),t=v(e,M(e),1);return g(t.startZOrder+t.zOrderStep)}if(n===-1/0){const e=a===1/0?0:a,t=v(x(e),e,1);return g(t.startZOrder+t.zOrderStep)}const d=v(n,M(n),1);if(0!==d.zOrderStep)return g(d.startZOrder+d.zOrderStep);const u=w(n,h).sort(((e,t)=>o(e)-o(t)));let _=x(o(u[0]));const p=M(_),m=v(_,p,u.length+1).zOrderStep;return 0!==m?(u.forEach((e=>{const t=g(_+m);s(e,t),_=t})),g(_+m)):g(p+5e3)}function T(e,t){return C(e,h,d,p,m,t)}function P(e){let t=-1e4;for(const i of e)d(i)&&(t=Math.min(t,i.zorder()-1e4));return 0===t?-1e4:t}function M(e){const t=1e4*Math.ceil(e/1e4);return t===e?t+1e4:t}function x(e){const t=1e4*Math.floor(e/1e4);return t===e?t-1e4:t}function I(e,t,i,s,o,r,n){const a=t.length,{newItems:l,movedItemsStartIndex:h}=i>0?(0,c.moveAfter)(e,t,i-1):(0,c.moveBefore)(e,t,0);let d=!1;for(let t=h;t<h+a;t++)if(l[t]!==e[t]){d=!0;break}if(!d)return;if(s(t[0]))return void(i<e.length&&n(e[i])<0?b(l.slice(h+1),0,r,o):f(l.slice(0,h),0,r,o));t.some((e=>o(e)))?function(e,t,i,s,o,r){let n,a,l=-1,c=-1;0===i?(c=L(e,i+t,s),a=r(e[c])):i+t===e.length?(l=A(e,i-1,s),n=r(e[l])):(l=A(e,i-1,s),n=r(e[l]),c=L(e,i+t,s),a=r(e[c]));if((void 0===n||n<0)&&void 0!==a&&a<=0)f(e.slice(0,c),a,o,s);else if((void 0===a||a>0)&&void 0!==n&&n>=0)b(e.slice(l+1),n,o,s);else{
i+t<e.length-i?f(e.slice(0,i+t),r(e[i+t]),o,s):b(e.slice(i),r(e[i-1]),o,s)}}(l,a,h,o,r,n):function(e,t,i,s,o,r,n){let a,l;0===i?l=n(e[i+t]):i+t===e.length?a=n(e[i-1]):(a=n(e[i-1]),l=n(e[i+t]));let c=0,h=0,d=0,u=0,_=0;if((void 0===a||a<0)&&void 0!==l&&l<=0){c=l;const e=v(c,void 0!==a?a:x(l),t);c=e.startZOrder,_=e.zOrderStep,d=i+t-1,u=d-t,h=-1}else if((void 0===l||l>0)&&void 0!==a&&a>=0){c=a;const e=v(c,void 0!==l?l:M(a),t);c=e.startZOrder,_=e.zOrderStep,d=i,u=d+t,h=1}if(0!==_)for(;d!==u;){const t=g(c+h*_);r(e[d],t),c=t,d+=h}else{const t=e.findIndex((e=>o(e)));-1!==t?(f(e.slice(0,t),0,r,s),b(e.slice(t+1),0,r,s)):b(e,0,r,s)}}(l,a,h,o,s,r,n)}function L(e,t,i){for(;t<e.length&&i(e[t]);)t++;return Math.min(t,e.length-1)}function A(e,t,i){for(;t>=0&&i(e[t]);)t--;return Math.max(0,t)}function k(e,t,i,s,o,r,n){const a=e.indexOf(i)+1;I(e,t,a,s,o,r,n)}function E(e,t,i,s,o,r,n){const a=e.indexOf(i);I(e,t,a,s,o,r,n)}function D(e,t,i){k(e,t,i,a.isSeries,d,p,m)}function B(e,t,i){E(e,t,i,a.isSeries,d,p,m)}function R(e){const t=function(e){const t=new Map;for(const i of e.panes)for(const e of i.lines)t.set(e.id,{pane:i,line:e});return t}(e),i=new Map;for(const r of e.groups){const e=new Set(r.tools),n=r.tools.map((e=>(0,o.ensureDefined)(t.get(e)))).map((e=>e.line.zOrder)),a=Math.max(...n),l=(0,o.ensureDefined)(t.get(r.tools[0])).pane,c=(0,s.default)(l.lines,(t=>t.zOrder<a&&!e.has(t.id)))?.zOrder??-1/0,h=r.tools.filter((e=>(0,o.ensureDefined)(t.get(e)).line.zOrder<c)).reverse();for(let e=0;e<h.length;e++){const s=c+e+1;i.set(h[e],s);const r=(0,o.ensureDefined)(t.get(h[e]));r.line.zOrder=s;let n=-1,a=-1;for(let e=0;e<l.lines.length;e++){const t=l.lines[e];if(t.id===r.line.id&&(n=e),t.zOrder>s&&(a=e),n>=0&&a>=0)break}l.lines.splice(-1===a?1/0:a,0,r.line),l.lines.splice(n,1)}}return i}},259165:(e,t,i)=>{var s;e=i.nmd(e),"undefined"!=typeof window&&(s=window.TVScript=window.TVScript||{}),(s=s||{}).Access={},s.Access.ACCESS_OPEN_NO_AUTH="open_no_auth",s.Access.ACCESS_CLOSED_NO_AUTH="closed_no_auth",s.Access.ACCESS_CLOSED_NEEDS_AUTH="closed_needs_auth",s.Access.MAP_ID_TO_NAME={1:s.Access.ACCESS_OPEN_NO_AUTH,2:s.Access.ACCESS_CLOSED_NO_AUTH,3:s.Access.ACCESS_CLOSED_NEEDS_AUTH},s.Access.MAP_NAME_TO_ID={},Object.keys(s.Access.MAP_ID_TO_NAME).forEach((function(e){s.Access.MAP_NAME_TO_ID[s.Access.MAP_ID_TO_NAME[e]]=e})),s.PinePrefix={},s.PinePrefix.USER="USER;",s.PinePrefix.PUB="PUB;",s.PinePrefix.STD="STD;",s.PinePrefix.TV="TV_",s.PinePrefix.EDGR="EDGR_",s.PineType={},s.PineType.UserSaved="PineType_UserSaved",s.PineType.UserPublished="PineType_UserPublished",s.PineType.BuiltIn="PineType_BuiltIn",s.PineType.Addon="PineType_Addon",s.Type=s.Type||function(){},s.Type.VOID="void",s.Type.INTEGER="integer",s.Type.FLOAT="float",s.Type.STRING="string",s.Type.BOOL="bool",s.Type.COLOR="color",s.Type.SERIES="series",s.Type.PLOT="plot",s.Type.HLINE="hline",s.Type.BARCOLOR="barcolor",s.Type.BGCOLOR="bgcolor",s.Type.PLOTSHAPES="plotshape",s.Type.PLOTCHARS="plotchar",s.Type.PLOTARROWS="plotarrow",s.Type.NA="na",s.Type.ARRAY="array",
s.TranslatorDefaultVersion=1,s.TranslatorReferenceVersioningIntroduced=4,s.TranslatorLastVersion=6,s.pineType=function(e){return e.startsWith(s.PinePrefix.USER)?s.PineType.UserSaved:e.startsWith(s.PinePrefix.PUB)?s.PineType.UserPublished:e.startsWith(s.PinePrefix.STD)||e.startsWith(s.PinePrefix.TV)||e.startsWith(s.PinePrefix.EDGR)?s.PineType.BuiltIn:s.PineType.Addon},s.patchILTemplate=function(e,t,i){var o=i||{};return s._patchTemplate(/<(in_\d+)>/g,e,t,o)},s.decorateQuotes=function(e){if(!e)return e;var t=/([^\\']+?)(')[^']*?/g,i="$1\\$2",s=e;return"'"==s.charAt(0)&&"'"==s.charAt(s.length-1)?"'"+(s=s.substr(1,s.length-2)).replace(t,i)+"'":s.replace(t,i)},s.patchInputs=function(e,t){var i={};for(var s in e)if(e.hasOwnProperty(s)){var o,r=e[s];o=r.isFake?{v:t[r.id],f:!0,t:r.type}:t[r.id],i[r.id]=o}return i},s._patchTemplate=function(e,t,i,o){var r=o||{};return t.replace(e,(function(e,t){for(var o=(t in r?r[t]:i.defaults.inputs[t]),n=0;n<i.inputs.length;++n)if(i.inputs[n].id===t)if("bool"===i.inputs[n].type)o=o?"1.0":"0.0";else if(["text","symbol","resolution","session"].indexOf(i.inputs[n].type)>=0)o="'"+s.decorateQuotes(o)+"'";else if("source"===i.inputs[n].type){var a=o.split("$");a[0]="'"+a[0]+"'",o="source("+a.join(",")+")"}return o}))},s.isStrategy=function(e){return/^\s*strategy\s*\(/m.test(e)};var o=/^\s*\/\/\s*?@version\s*?=\s*?(\S*?)\s*?$/gm,r=/^[0-9]+$/;s.extractVersion=function(e){o.lastIndex=0;var t=o.exec(e);if(null===t)return 1;var i=t[1],n=r.test(i)?Number(i):NaN;return isNaN(n)?1:Math.max(s.TranslatorDefaultVersion,Math.min(n,s.TranslatorLastVersion))},s.canUpgradeVersion=function(e){return e>=3&&e<s.TranslatorLastVersion},s.canDowngradeVersion=function(e){return e>=4&&e<=s.TranslatorLastVersion},e&&e.exports&&(e.exports=s)},526067:(e,t,i)=>{"use strict";i.d(t,{getChartAlertsFacade:()=>s.getChartAlertsFacade});var s=i(134106)},976071:(e,t,i)=>{"use strict";i.d(t,{hasUsualAlertPlots:()=>a,isFirstAlertPlotUsual:()=>n});var s=i(658273),o=i(44408),r=i(123081);function n(e){if((0,s.isSeries)(e))return!0;if((0,o.isStudy)(e)&&!(0,o.isStudyStrategy)(e)){const t=(0,r.plotsForAlert)(e.metaInfo(),e.offset.bind(e));return!e.metaInfo().hasAlertFunction&&t.every((e=>"alertcondition"!==e.type))}return!1}function a(e){if((0,s.isSeries)(e))return!0;if((0,o.isStudy)(e)&&!(0,o.isStudyStrategy)(e)){return(0,r.plotsForAlert)(e.metaInfo(),e.offset.bind(e)).some((e=>"alertcondition"!==e.type))}return!1}},431595:(e,t,i)=>{"use strict";i.d(t,{trackAlertCreationAttempt:()=>r});var s=i(637581),o=i(940043);async function r(e,t,i){const r=await(0,s.getTracker)();r?.trackAlertCreationEvent({action:"creation_attempt",symbol:e,method:t,source:i,platform:(0,o.getPlatform)()})}},109294:(e,t,i)=>{"use strict";i.d(t,{confirmDatasourceRemoving:()=>a});var s=i(729193),o=i(474422);const r=s.t(null,void 0,i(111968)),n=s.t(null,void 0,i(228141));function a(e,t){const{hasLockedSources:i,text:s=(i?n:r),onConfirm:a,onClose:l}=e;return new Promise((i=>(0,o.showConfirm)({...e,text:s,onConfirm:e=>{a?.(e),i(!0),e.dialogClose()},onClose:()=>{l?.(),
i(!1)}},t)))}},922174:(e,t,i)=>{"use strict";i.d(t,{getSeriesDangerReason:()=>o});var s=i(174582);function o(e){const[t]=function(e){const t=new Set;e.isSpread()&&t.add(s.DataSourceDangerReason.Spread);const i=e.symbolInfo();return"CRYPTOCAP"===i?.exchange&&t.add(s.DataSourceDangerReason.CryptoCap),t}(e);return t??null}},995659:(e,t,i)=>{"use strict";function s(e){return r().then((t=>t.hasUserAccessToDataSource(e)))}function o(e){return r().then((t=>t.filterAccessibleDataSources(e)))}i.d(t,{filterAccessibleDataSources:()=>o,hasUserAccessToDataSource:()=>s});const r=()=>Promise.all([i.e(43279),i.e(77998),i.e(44408),i.e(43458)]).then(i.bind(i,390750))},953574:(e,t,i)=>{"use strict";var s;i.d(t,{AlertEditorAbortReason:()=>s}),function(e){e.AlertIsInvalid="alert-is-invalid",e.AlertsMaintenance="alerts-maintenance",e.ChartModelNotFound="chart-model-not-found",e.IsAlreadyPresent="is-already-present",e.MainSeriesIsATR="main-series-is-atr",e.MainSeriesIsPercentageLTP="main-series-is-percentage-ltp",e.MainSeriesIsInReplay="main-series-is-in-replay",e.MainSeriesIsOffline="main-series-is-offline",e.SourceIsDangerous="source-is-dangerous",e.SymbolInfoTimeout="symbol-info-timeout",e.SymbolIsInvalid="symbol-is-invalid",e.SymbolCurrencyConverted="symbol-currency-converted",e.SymbolUnitConverted="symbol-unit-converted",e.SymbolCurrencyAndUnitConverted="symbol-currency-and-unit-converted",e.SymbolIsEconomics="symbol-is-economics",e.SymbolWithMetrics="symbol-with-metrics",e.UnsupportedResolution="unsupported-resolution",e.ManualAbort="manual-abort",e.MisleadingPriceScale="misleading-price-scale",e.ResolutionIsTicks="resolution-is-ticks"}(s||(s={}))},60523:(e,t,i)=>{"use strict";i.d(t,{AlertEditorInvocationMode:()=>a.AlertEditorInvocationMode,invokeAlertEditor:()=>c});var s=i(185842),o=i(77357),r=i(995659),n=i(953574),a=i(574113);const l=(0,o.getLogger)("Alerts.Price.InvokeAlertEditor");async function c(e){
const[{getAlertsTrackers:t},{getInvocationMode:o,shouldAbortAlertEditor:r,showAbortExplainingDialog:a},{lockEditorInvocation:c}]=await Promise.all([Promise.all([i.e(26395),i.e(79476)]).then(i.bind(i,550505)),Promise.all([i.e(70911),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(24977),i.e(5709),i.e(46680),i.e(31788),i.e(15365),i.e(27848),i.e(6406),i.e(22066),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(12559),i.e(96872),i.e(73133),i.e(93541),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(16803),i.e(26729),i.e(66548),i.e(31403),i.e(37865),i.e(4058),i.e(6437),i.e(25947),i.e(83754),i.e(63470),i.e(5449),i.e(34295),i.e(66985),i.e(33269),i.e(78399),i.e(16531),i.e(22783),i.e(39656),i.e(32078),i.e(63726),i.e(81562),i.e(34666),i.e(27024),i.e(35897),i.e(81968),i.e(52316),i.e(63504),i.e(53550),i.e(64760),i.e(32387),i.e(36295),i.e(66958),i.e(17686),i.e(53233),i.e(63056),i.e(28435),i.e(70438),i.e(26492),i.e(93868),i.e(67618),i.e(49894),i.e(60802),i.e(40760),i.e(3535),i.e(8106),i.e(8046),i.e(12014),i.e(77998),i.e(82426),i.e(92384),i.e(53701),i.e(71677),i.e(44408),i.e(76325),i.e(2253),i.e(92041),i.e(44026),i.e(30076),i.e(70532)]).then(i.bind(i,377101)),Promise.all([i.e(70911),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(24977),i.e(5709),i.e(46680),i.e(31788),i.e(15365),i.e(27848),i.e(6406),i.e(22066),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(12559),i.e(96872),i.e(73133),i.e(93541),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(16803),i.e(26729),i.e(66548),i.e(31403),i.e(37865),i.e(4058),i.e(6437),i.e(25947),i.e(83754),i.e(63470),i.e(5449),i.e(34295),i.e(66985),i.e(33269),i.e(78399),i.e(16531),i.e(22783),i.e(39656),i.e(32078),i.e(63726),i.e(81562),i.e(34666),i.e(27024),i.e(35897),i.e(81968),i.e(52316),i.e(63504),i.e(53550),i.e(64760),i.e(32387),i.e(36295),i.e(66958),i.e(17686),i.e(53233),i.e(63056),i.e(28435),i.e(70438),i.e(26492),i.e(93868),i.e(67618),i.e(49894),i.e(60802),i.e(40760),i.e(3535),i.e(8106),i.e(8046),i.e(12014),i.e(77998),i.e(82426),i.e(92384),i.e(53701),i.e(71677),i.e(44408),i.e(76325),i.e(2253),i.e(92041),i.e(44026),i.e(30076),i.e(70532)]).then(i.bind(i,486352))]),d=t().maintenance;d.syncOnUserAction();const u=r(e,d);if(null!==u)return u!==n.AlertEditorAbortReason.IsAlreadyPresent&&a(u,o(e)),l.logWarn(`Aborted: ${u}`),void e.onAborted?.(u);const[_,p]=c(e);try{
const[{getAlertSession:t},{invokeDialogAlertEditor:o,invokeSilentAlertEditor:r,convertOptionsForSilentInvoker:n,convertOptionsForDialogInvoker:a},l]=await Promise.all([Promise.all([i.e(78034),i.e(85057)]).then(i.bind(i,152684)),Promise.all([i.e(70911),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(24977),i.e(5709),i.e(46680),i.e(31788),i.e(15365),i.e(27848),i.e(6406),i.e(22066),i.e(98729),i.e(27688),i.e(48011),i.e(56752),i.e(20432),i.e(35424),i.e(36810),i.e(12559),i.e(96872),i.e(73133),i.e(93541),i.e(59717),i.e(63935),i.e(15074),i.e(29984),i.e(4050),i.e(30796),i.e(16803),i.e(26729),i.e(66548),i.e(31403),i.e(37865),i.e(4058),i.e(6437),i.e(25947),i.e(83754),i.e(63470),i.e(5449),i.e(34295),i.e(66985),i.e(33269),i.e(78399),i.e(16531),i.e(22783),i.e(39656),i.e(32078),i.e(63726),i.e(81562),i.e(34666),i.e(27024),i.e(35897),i.e(81968),i.e(52316),i.e(63504),i.e(53550),i.e(64760),i.e(32387),i.e(36295),i.e(66958),i.e(17686),i.e(53233),i.e(63056),i.e(28435),i.e(70438),i.e(26492),i.e(93868),i.e(67618),i.e(49894),i.e(60802),i.e(40760),i.e(3535),i.e(8106),i.e(8046),i.e(12014),i.e(77998),i.e(82426),i.e(92384),i.e(53701),i.e(71677),i.e(44408),i.e(76325),i.e(2253),i.e(92041),i.e(44026),i.e(30076),i.e(70532)]).then(i.bind(i,336552)),h(p)]),c=(0,s.ensureNotNull)(t().user.value());e.silent?r(n(l),c):o(a(l),c)}catch(e){_()}}async function h(e){const t={...e};return t.series&&!await(0,r.hasUserAccessToDataSource)(t.series)&&(delete t.series,delete t.value),t}},478311:(e,t,i)=>{"use strict";function s(e,t,i){return e*(1-i)+t*i}i.d(t,{doAnimate:()=>n,lerp:()=>s});const o={from:0,duration:250,easing:i(947110).easingFunc.easeOutCubic};class r{constructor(e){this._doing=!0,this._completed=!1,this._options={...o,...e};const t=performance.now();window.requestAnimationFrame((e=>{this._animation(t,this._options.from,e)}))}stop(){this._doing=!1}completed(){return this._completed}_animation(e,t,i){if(!this._doing)return void this._finishAnimation();const o=(i=!i||i<1e12?performance.now():i)-e,r=o>=this._options.duration||t===this._options.to,n=s(this._options.from,this._options.to,this._options.easing(o/this._options.duration)),a=r?this._options.to:n,l=a-t;this._options.onStep(l,a),r?this._finishAnimation():window.requestAnimationFrame((t=>{this._animation(e,a,t)}))}_finishAnimation(){this._options.onComplete&&this._options.onComplete(),this._completed=!0}}function n(e){return new r(e)}},573477:(e,t,i)=>{"use strict";i.d(t,{GradientColorCache:()=>o});var s=i(275925);class o{constructor(){this._color1="",this._color2="",this._colors=new Map}gradientColor(e,t,i){if(t===e)return t;i=Math.max(0,Math.min(100,Math.round(100*i))),this._color1===e&&this._color2===t||(this._colors.clear(),this._color1=e,this._color2=t);let o=this._colors.get(i);return void 0===o&&(o=(0,s.gradientColorAtPercent)(e,t,i/100),this._colors.set(i,o)),o}}},920174:(e,t,i)=>{"use strict";i.d(t,{getPersistentLogger:()=>o,setPersistentLogger:()=>r});let s=null;function o(){return s}function r(e){s=e}},338866:(e,t,i)=>{
"use strict";function s(){return Promise.all([i.e(40528),i.e(64116),i.e(98115),i.e(57032),i.e(50865),i.e(15365),i.e(48011),i.e(57759),i.e(32387),i.e(99331),i.e(46772)]).then(i.bind(i,403330))}i.d(t,{loadChangeIntervalDialog:()=>s})},952892:(e,t,i)=>{"use strict";i.d(t,{showChangeIntervalDialogAsync:()=>r});var s=i(338866);let o=null;function r(e){const t=o=(0,s.loadChangeIntervalDialog)().then((i=>{t===o&&i.showChangeIntervalDialog(e)}));return t}},930871:(e,t,i)=>{"use strict";function s(e){return Promise.all([i.e(64922),i.e(64116),i.e(98115),i.e(57032),i.e(1967),i.e(46970),i.e(50865),i.e(48072),i.e(63665),i.e(75828),i.e(97627),i.e(74354),i.e(24977),i.e(5709),i.e(15365),i.e(48011),i.e(15074),i.e(33269),i.e(22783),i.e(81562),i.e(66446),i.e(35897),i.e(81968),i.e(63504),i.e(43243),i.e(32387),i.e(99331),i.e(63056),i.e(8046),i.e(92041),i.e(83252),i.e(28718)]).then(i.bind(i,513048)).then((t=>t.showGoToDateDialog(e)))}i.d(t,{showGoToDateDialog:()=>s})},522750:(e,t,i)=>{"use strict";i.d(t,{isOpenedModals:()=>o,openedModals:()=>s});const s=[];function o(){return 0!==s.length}},102727:(e,t,i)=>{"use strict";i.r(t),i.d(t,{createNoticeDialog:()=>o,showNoticeDialog:()=>r});var s=i(729193);async function o(e){return(await Promise.all([i.e(87238),i.e(11087),i.e(52682),i.e(66920),i.e(68120),i.e(15215),i.e(72113),i.e(30567),i.e(77831),i.e(58291),i.e(38994),i.e(57343),i.e(10704)]).then(i.bind(i,938994))).createDialog({width:400,destroyOnClose:!0,title:s.t(null,void 0,i(561600)),content:s.t(null,void 0,i(72363)),contentWrapTemplate:'<div class="tv-dialog__section tv-dialog__section--no-border"><div class="tv-text"><p></p></div></div>',actionsWrapTemplate:'<div class="tv-dialog__section tv-dialog__section--actions tv-dialog__section--no-border">',actions:[{name:"ok",type:"primary",text:s.t(null,void 0,i(208078)),method:"close",key:[13,32]}],...e})}function r(e){o(e).then((e=>e.open()))}},302358:(e,t,i)=>{"use strict";i.d(t,{runOrSigninWithFeature:()=>o});i(574908);var s=i(702203);const o=async(e,t,o={})=>{{if(window.is_authenticated)return void e();if((0,s.isOnMobileAppPage)("any"))return void window.runOrSignIn(e,{source:t.source,feature:t.feature});const{regwalls:r}=await Promise.all([i.e(82200),i.e(46970),i.e(48072),i.e(27848),i.e(98729),i.e(52694),i.e(54478),i.e(83066),i.e(83576),i.e(32387),i.e(93489),i.e(2284)]).then(i.bind(i,928943));r.open({...t,onSigninSuccess:e},o)}}},446849:(e,t,i)=>{"use strict";i.d(t,{DeleteLockedLineToolReason:()=>s,confirmRemovingLockedLineTools:()=>d,showDeleteLockedLineToolsConfirm:()=>h});var s,o=i(729193),r=i(474422),n=i(367011),a=i(996002);!function(e){e[e.RemoveSelected=0]="RemoveSelected",e[e.RemoveAll=1]="RemoveAll"}(s||(s={}));const l=o.t(null,void 0,i(505985)),c=o.t(null,void 0,i(505985));async function h(e,t,h){if(n.doNotShowDeleteLockedLineConfirmProperty.value())return void t(a.deleteLockedLineToolsProperty.value());const{getContent:d}=await Promise.all([i.e(69694),i.e(22066),i.e(56752),i.e(21673),i.e(30663),i.e(93340)]).then(i.bind(i,276726));(0,r.showConfirm)({
title:o.t(null,void 0,i(232919)),content:d(e===s.RemoveSelected?l:c),id:`${n.doNotShowDeleteLockedLineKey}-confirm`,mainButtonText:o.t(null,void 0,i(985826)),mainButtonIntent:"danger",cancelButtonText:o.t(null,void 0,i(219069)),onConfirm:({dialogClose:e})=>{n.doNotShowDeleteLockedLineConfirmProperty.value()&&a.deleteLockedLineToolsProperty.setValue(!0),t(!0),e()},onCancel:({dialogClose:e})=>{n.doNotShowDeleteLockedLineConfirmProperty.value()&&a.deleteLockedLineToolsProperty.setValue(!1),t(!1),e()}},h)}function d(e,t){return new Promise((i=>{h(e,i,t)}))}},108425:(e,t,i)=>{"use strict";i.d(t,{showDeleteStudyTreeConfirm:()=>n});var s=i(729193),o=i(474422);const r=5;function n(e,t){let n,a="";if(e.length>r){const t=e.length-r+1;n=e.slice(0,r-1),a=s.t(null,{plural:"and {nameCount} more indicators.",count:t},i(2597)).format({nameCount:t.toString()})}else n=e;const l='<ul style="padding-left:20px">'+n.map((e=>`<li>${e}</li>`)).join("")+"</ul>"+a,c=s.t(null,void 0,i(412117))+l;(0,o.showConfirm)({title:s.t(null,void 0,i(150897)),html:c,mainButtonText:s.t(null,void 0,i(91126)),mainButtonIntent:"danger",cancelButtonText:s.t(null,void 0,i(743563)),onConfirm:({dialogClose:e})=>{t(),e()}})}},446087:(e,t,i)=>{"use strict";i.d(t,{UserStatus:()=>s});var s,o=i(945592),r=i(911500);!function(e){e.NonPro="non_pro",e.Pro="pro"}(s||(s={}));(0,r.memoize)((()=>window.user.is_trial&&window.user.pro_plan?window.user.is_expert||window.user.declared_status!==s.Pro?o.WEEKLY_SUBSCRIPTION_DAYS_LEN:o.MONTHLY_SUBSCRIPTION_DAYS_LEN:o.WEEKLY_SUBSCRIPTION_DAYS_LEN))},199862:(e,t,i)=>{"use strict";async function s(e,t){const s=window.widgetbar,o=s?.model("pine-dialog-button"),r=o?.visible.value();if(!(window.widgetbar?.isVisible()&&r&&o))return;const n=i.e(54160).then(i.bind(i,634631));await(await n).showPineDialog({chartPageGrid:window.widgetbar?.chartPageGrid,chartWidgetCollection:window.widgetbar?.chartWidgetCollection,scriptInfo:e,openSourceId:t})}i.d(t,{activatePineEditor:()=>s})},940043:(e,t,i)=>{"use strict";i.d(t,{getPlatform:()=>r});var s=i(702203),o=i(376596);function r(){return(0,o.isDesktopApp)()?"desktop":(0,s.isOnMobileAppPage)("old")?"ios":(0,s.isOnMobileAppPage)("new")?"android":"web"}},519639:(e,t,i)=>{"use strict";function s(e){let t=e;const i=()=>{window.removeEventListener("online",i),t&&t()};return window.addEventListener("online",i),()=>{t=null}}i.d(t,{callWhenOnline:()=>s})},713620:(e,t,i)=>{"use strict";i.d(t,{disable:()=>c,enable:()=>h,pushBackListener:()=>l});var s=i(584104);const o=[];let r=null;function n(e){for(let t=0;t<o.length;t++)if(o[t].name===e)return t;return-1}function a(e){if(!r)for(let t=o.length-1;t>=0&&!0!==o[t].func(e);t--);}function l(e,t){const i={name:e,func:t},s=n(i.name);s>-1&&o.splice(s,1),o.unshift(i)}function c(){return r?null:(r=(0,s.randomHashN)(4),r)}function h(e){if(e!==r)throw Error("Lock id is outdated");r=null}window.addEventListener("keypress",a,!1)},911500:(e,t,i)=>{"use strict";function s(e,t){const i=new Map;return function(...s){const o=""+(t?t.apply(null,s):s[0]);if(!i.has(o)){
const t=e.apply(this,s);return i.set(o,t),t}return i.get(o)}}i.d(t,{memoize:()=>s})},199715:(e,t,i)=>{"use strict";function s(e){return e.reduce((function(e,t,i){return~e.indexOf(t)||e.push(t),e}),[])}i.d(t,{uniq:()=>s})},609344:(e,t,i)=>{"use strict";i.d(t,{Worker:()=>s});class s extends Worker{constructor(e,t){super(function(e){const t=new URL(e),s=new Blob(["self.WEBPACK_PUBLIC_PATH=",JSON.stringify(new URL(i.p,location.href).href),";\n","self.locale=",JSON.stringify(i.g.locale),";\n",window.language?`self.language=${JSON.stringify(window.language)};\n`:"","importScripts(",JSON.stringify(t.href),");"],{type:"application/javascript"});return URL.createObjectURL(s)}(e),t)}}},36321:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="m19.54 4.5 3.96 4.32-.74.68-3.96-4.32.74-.68ZM7.46 4.5 3.5 8.82l.74.68L8.2 5.18l-.74-.68ZM19.74 10.33A7.5 7.5 0 0 1 21 14.5v.5h1v-.5a8.5 8.5 0 1 0-8.5 8.5h.5v-1h-.5a7.5 7.5 0 1 1 6.24-11.67Z"/><path fill="currentColor" d="M13 9v5h-3v1h4V9h-1ZM19 20v-4h1v4h4v1h-4v4h-1v-4h-4v-1h4Z"/></svg>'},685023:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M20.1 4 25 9.32l-.73.68-4.9-5.32.73-.68ZM7.9 4 3 9.32l.73.68 4.91-5.32L7.91 4ZM14 15v-5h1v6h-4v-1h3Z"/><path fill="currentColor" d="M5 15a9 9 0 1 1 18 0 9 9 0 0 1-18 0Zm9-8a8 8 0 1 0 0 16 8 8 0 0 0 0-16Z"/></svg>'},418986:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M15 16.3V5h-1v11.3l-3.15-3.15-.7.7 4 4 .35.36.35-.36 4-4-.7-.7L15 16.29zm-8 4.2V16H6v4.5c0 .83.67 1.5 1.5 1.5h14c.83 0 1.5-.67 1.5-1.5V16h-1v4.5a.5.5 0 0 1-.5.5h-14a.5.5 0 0 1-.5-.5z"/></svg>'},779851:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="currentColor"><path fill-rule="evenodd" d="M18 14a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm-1 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/><path fill-rule="evenodd" d="M8.5 5h11l5 9-5 9h-11l-5-9 5-9Zm-3.86 9L9.1 6h9.82l4.45 8-4.45 8H9.1l-4.45-8Z"/></svg>'},436875:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M16.73 6.56a2.5 2.5 0 0 1 3.54 0l1.17 1.17a2.5 2.5 0 0 1 0 3.54l-.59.58-9 9-1 1-.14.15H6v-4.7l.15-.15 1-1 9-9 .58-.59Zm2.83.7a1.5 1.5 0 0 0-2.12 0l-.23.24 3.29 3.3.23-.24a1.5 1.5 0 0 0 0-2.12l-1.17-1.17Zm.23 4.24L16.5 8.2l-8.3 8.3 3.3 3.3 8.3-8.3Zm-9 9L7.5 17.2l-.5.5V21h3.3l.5-.5Z"/></svg>'},962494:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M18 7h5v1h-2.01l-1.33 14.64a1.5 1.5 0 0 1-1.5 1.36H9.84a1.5 1.5 0 0 1-1.49-1.36L7.01 8H5V7h5V6c0-1.1.9-2 2-2h4a2 2 0 0 1 2 2v1Zm-6-2a1 1 0 0 0-1 1v1h6V6a1 1 0 0 0-1-1h-4ZM8.02 8l1.32 14.54a.5.5 0 0 0 .5.46h8.33a.5.5 0 0 0 .5-.46L19.99 8H8.02Z"/></svg>'},428864:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" d="m17.13 9.74 7.37.9-5.44 5.06L20.4 23 14 19.38 7.6 23l1.34-7.3-5.44-5.06 7.37-.9L14 3l3.13 6.74Zm5.11 1.63-4.26 3.97 1.04 5.74L14 18.24l-5.02 2.84 1.04-5.74-4.26-3.97 5.79-.7L14 5.37l2.45 5.3 5.8.7Z"/></svg>'},534756:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M15 5H6.5C5.67 5 5 5.67 5 6.5v15c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5V16h1v5.5a2.5 2.5 0 0 1-2.5 2.5h-15A2.5 2.5 0 0 1 4 21.5v-15A2.5 2.5 0 0 1 6.5 4H15v1Zm7.41-.3a2 2 0 0 0-2.82 0l-.94.95-7.5 7.5-1 1-.15.14V19h4.7l.15-.15 1-1 7.5-7.5.94-.94a2 2 0 0 0 0-2.82L22.41 4.7Zm-2.12.71a1 1 0 0 1 1.42 0l1.88 1.88a1 1 0 0 1 0 1.42l-.59.58-1.65-1.64L19.71 6l.58-.59Zm.36 2.94L22.29 10l-6.79 6.8-1.65-1.65-1.64-1.65L19 6.7l1.65 1.65Zm-7.5 7.5 1.64 1.65-.5.5H11v-3.3l.5-.5 1.65 1.65Z"/></svg>'},592753:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" d="M14 3c6.075 0 11 4.925 11 11s-4.925 11-11 11S3 20.076 3 14 7.925 3 14 3m0 1C8.477 4 4 8.477 4 14s4.477 10 10 10 10-4.477 10-10S19.524 4 14 4m1 16h-1v-7h-2v-1h3zM14 8a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg>'},232717:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" d="M25 17.225 14 24 3 17.357l.508-.867L14 22.873l10.498-6.51zM14 5c.171 0 .344.04.498.128l9.985 5.753a1 1 0 0 1-.016 1.741l-9.983 5.522a1 1 0 0 1-.968-.001l-9.984-5.545a1 1 0 0 1-.012-1.742l9.98-5.728A1 1 0 0 1 13.999 5m-9.982 6.724L14 17.269l9.982-5.522L14 5.994z"/></svg>'},560203:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" d="M23 13h-1V4H6v19.476L14 20l3.008 1.307-.42.907L14 21.09 5 25V3h18zm0 6h4v1h-4v4h-1v-4h-4v-1h4v-4h1zm-6-3H9v-1h8zm2-4H9v-1h10zm0-4.005H9v-1h10z"/></svg>'},518094:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M14 22a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm5-9H9v2h10v-2Z"/></svg>'},570860:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><rect width="10" height="4" fill="currentColor" rx="2" x="4" y="7"/></svg>'},547685:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22" width="22" height="22"><path fill="currentColor" d="M6 10h10v3H6v-3Z"/></svg>'},272198:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M5 8h8v2H5V8Z"/></svg>'},598328:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><circle fill="currentColor" cx="9" cy="9" r="5"/></svg>'},589981:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18" fill="none"><circle fill="currentColor" cx="9" cy="9" r="4"/></svg>'},447330:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" d="M4.74 3.26a4.62 4.62 0 0 0 1.8 5.3l.67.44-.66.44a4.63 4.63 0 0 0-1.81 5.3c.05.15.2.26.36.26h7.8c.17 0 .31-.1.37-.26a4.62 4.62 0 0 0-1.82-5.3L10.8 9l.66-.44a4.63 4.63 0 0 0 1.82-5.3.39.39 0 0 0-.37-.26H5.1c-.17 0-.31.1-.36.26ZM9 8.32l1.58-1.06a3.06 3.06 0 0 0 1.36-2.7H6.06a3.06 3.06 0 0 0 1.36 2.7L9 8.32Z"/></svg>'},611555:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M18.1 15.28A6.58 6.58 0 0 1 19.67 22H8.34a6.58 6.58 0 0 1 1.55-6.72c.5-.5 1.1-.89 1.69-1.28-.6-.4-1.19-.77-1.69-1.28A6.58 6.58 0 0 1 8.34 6h11.32c.8 2.39.16 4.98-1.55 6.72-.5.5-1.1.89-1.69 1.28.6.4 1.19.77 1.69 1.28ZM14 13.2l1.94-1.28A4.58 4.58 0 0 0 18 8h-8a4.58 4.58 0 0 0 2.06 3.92L14 13.2Z"/></svg>'},500764:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M9.3 9l.9-4.53a1.23 1.23 0 1 0-2.4 0L8.7 9l-.9 4.53a1.23 1.23 0 1 0 2.4 0L9.3 9z"/><path fill="currentColor" d="M9.15 9.26l4.38-1.48a1.23 1.23 0 1 0-1.21-2.09L8.85 8.74l-4.38 1.48a1.23 1.23 0 1 0 1.21 2.09l3.47-3.05z"/><path fill="currentColor" d="M9.15 8.74L5.68 5.69a1.23 1.23 0 1 0-1.2 2.09l4.37 1.48 3.47 3.05a1.23 1.23 0 1 0 1.2-2.09L9.16 8.74z"/></svg>'},579661:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M13.29 4.8h-.09a4.2 4.2 0 1 0 .09 8.4 6 6 0 1 1 0-8.4z"/></svg>'},405818:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M12.58 12.1A3.86 3.86 0 0 0 9 6.75a3.87 3.87 0 0 0-3.58 5.33 7.74 7.74 0 0 1 7.16 0zM3.64 9.93l-2.3-.62.37-1.38 2.3.62-.37 1.38zM6.1 6.07L5.07 3.92l1.3-.6 1 2.15-1.29.6zM10.62 5.47l1-2.16 1.3.6-1.01 2.16-1.3-.6zM13.99 8.55l2.3-.62.36 1.38-2.3.62L14 8.55z"/></svg>'},387638:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M6 5h1v18H6V5ZM16 14V9h1v5h5v1h-5v5h-1v-5h-5v-1h5Z"/></svg>'},514216:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M22 6H6a1 1 0 0 0-1 1v14a1 1 0 0 0 1 1h10v1H6a2 2 0 0 1-2-2V7c0-1.1.9-2 2-2h16a2 2 0 0 1 2 2v8h-1V7a1 1 0 0 0-1-1m-6 6.77-3.41-2.48-.6.81 4 2.9 4-2.9-.58-.8zm-4 2.47L8.59 17.7l-.6-.8L12 14 16 16.9l-.59.81zM21 17v3h-3v1h3v3h1v-3h3v-1h-3v-3z"/></svg>'},713140:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M23 6v1H5V6h18ZM14 16v-5h1v5h5v1h-5v5h-1v-5H9v-1h5Z"/></svg>'},697085:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M17.5 7A3 3 0 0 1 15 9.96V14h5v1h-5v7.98a6.97 6.97 0 0 0 3.57-1.32A4.5 4.5 0 0 0 20.5 18h1a5.5 5.5 0 0 1-2.32 4.46A7.98 7.98 0 0 1 14.5 24c-1.6 0-3.33-.53-4.68-1.54A5.5 5.5 0 0 1 7.5 18h1c0 1.56.78 2.8 1.93 3.66A6.97 6.97 0 0 0 14 22.98V15H9v-1h5V9.96A3 3 0 1 1 17.5 7Zm-3 2a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/></svg>'},192751:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 7 5" width="7" height="5" fill="none"><path stroke="currentColor" stroke-width="1.2" d="M1 1.5l2.5 2 2.5-2"/></svg>'},190355:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M5 2H4v3H1v1h3v3h1V6h3V5H5V2Z"/><path fill="currentColor" fill-rule="evenodd" d="M17.5 11h-7a1.5 1.5 0 0 0 0 3h7a1.5 1.5 0 0 0 0-3Zm-7-1a2.5 2.5 0 0 0 0 5h7a2.5 2.5 0 0 0 0-5h-7Z"/><path fill="currentColor" d="M8 18h12v1H8v-1Z"/><path fill="currentColor" d="M21.5 6H10V5h11.5A2.5 2.5 0 0 1 24 7.5v14a2.5 2.5 0 0 1-2.5 2.5h-15A2.5 2.5 0 0 1 4 21.5V11h1v10.5c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5v-14c0-.83-.67-1.5-1.5-1.5Z"/></svg>'},570362:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M17.5 7H17v6h-3v-3H9v6H5v6h17V7h-4.5zm.5 14h3V8h-3v13zm-1 0v-7h-3v7h3zm-4-7.5V21h-3V11h3v2.5zM9 21v-4H6v4h3z"/></svg>'},4570:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="backgroundColor" d="M5 7V6a4 4 0 1 1 8 0v1a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9c0-1.1.9-2 2-2Z"/><path fill="lineColor" fill-rule="evenodd" d="M9 3a3 3 0 0 0-3 3v1h6V6a3 3 0 0 0-3-3ZM5 6v1a2 2 0 0 0-2 2v5c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2V6a4 4 0 0 0-8 0Zm0 2a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1H5Zm4 2a1 1 0 0 0-1 1v1a1 1 0 1 0 2 0v-1a1 1 0 0 0-1-1Z"/></svg>'},765353:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(6 3)"><rect width="15" height="12" rx="2" x=".5" y="8.5"/><path stroke-linecap="round" stroke-width="2" d="M8 15v2"/><path d="M11.5 4a3.5 3.5 0 0 0-7 0v4.5"/></g></svg>'},466341:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 13" width="15" height="13"><path fill="currentColor" fill-rule="evenodd" d="M4.1 1 1.14 6.5 4.1 12h6.8l2.96-5.5L10.9 1H4.1ZM15 6.5 11.5 0h-8L0 6.5 3.5 13h8L15 6.5ZM7.5 8a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm0 1a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/></svg>'},807563:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor"><path d="M6.5 15A8.5 8.5 0 1 0 15 6.5H8.5"/><path d="M12 10L8.5 6.5 12 3"/></g></svg>'},51867:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(3 6)"><path d="M.964 8C3 4 6.679.5 11 .5 15.32.5 19 4 21.036 8 19 12 15.32 15.5 11 15.5 6.679 15.5 3 12 .964 8z"/><circle cx="11" cy="8" r="3.5"/></g></svg>'},812084:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 16.6205C19.7396 16.8955 19.3241 16.9285 19.044 16.6948L14.3924 12.8117L14.072 12.5442L13.7516 12.8117L9.10009 16.6947C8.82008 16.9285 8.40456 16.8955 8.16495 16.6205C7.92467 16.3447 7.94981 15.9272 8.22144 15.6822L14.0721 10.4057L19.9227 15.6822C20.1943 15.9272 20.2195 16.3447 19.9792 16.6205ZM18.4032 17.4624C19.1009 18.0448 20.1362 17.9626 20.7332 17.2774C21.3318 16.5902 21.2692 15.55 20.5924 14.9396L14.407 9.36109L14.0721 9.05908L13.7373 9.36109L7.55171 14.9396C6.87492 15.55 6.81229 16.5902 7.41096 17.2774C8.00796 17.9626 9.04326 18.0448 9.74094 17.4624L14.072 13.8468L18.4032 17.4624Z"/></svg>'},609096:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 12.2892C19.7396 12.0142 19.3241 11.9812 19.044 12.2149L14.3924 16.098L14.072 16.3655L13.7516 16.098L9.10009 12.2149C8.82008 11.9812 8.40456 12.0142 8.16495 12.2892C7.92467 12.565 7.94981 12.9825 8.22144 13.2275L14.0721 18.504L19.9227 13.2275C20.1943 12.9825 20.2195 12.565 19.9792 12.2892ZM18.4032 11.4472C19.1009 10.8648 20.1362 10.9471 20.7332 11.6323C21.3318 12.3195 21.2692 13.3597 20.5924 13.9701L14.407 19.5486L14.0721 19.8506L13.7373 19.5486L7.55171 13.9701C6.87492 13.3597 6.81229 12.3195 7.41096 11.6323C8.00796 10.9471 9.04326 10.8648 9.74094 11.4473L14.072 15.0628L18.4032 11.4472Z"/></svg>'},290044:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor"><path stroke-linecap="square" d="M11.5 21.5v-7m3 7v-5m3 5v-3m-9 3v-5"/><path d="M5.5 22v-3"/><path stroke-linecap="square" d="M5.5 13.5l4.297-4.297a2.406 2.406 0 0 1 3.406 0l2.594 2.594c.94.94 2.463.943 3.406 0L23.5 7.5M22.5 12.5v6m-3-3h6"/></g></svg>'},631963:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="square" d="M6.145 11.968L14 5.5l7.855 6.468a.3.3 0 0 1-.191.532H6.336a.3.3 0 0 1-.19-.532zm0 4.064L14 22.5l7.855-6.468a.3.3 0 0 0-.191-.532H6.336a.3.3 0 0 0-.19.532z"/></svg>'},214186:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" transform="translate(4 5)"><path fill="currentColor" d="M3 1h1v13.5H3z"/><circle stroke="currentColor" cx="3.5" cy="16.5" r="2"/><path fill="currentColor" d="M5.5 16H18v1H5.5z"/><path stroke="currentColor" d="M0 4L3.5.5 7 4m8 9l3.5 3.5L15 20"/></g></svg>'},816953:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><g fill="currentColor" fill-rule="nonzero"><path d="M4 15h8.5v-1h-8.5zM16.5 15h8.5v-1h-8.5z"/><path d="M14.5 16c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5zm0 1c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5 2.5 1.119 2.5 2.5-1.119 2.5-2.5 2.5z"/></g></svg>'},230252:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><path fill="currentColor" d="M18.15 7.02A9.05 9.05 0 0014 6c-3.45 0-6.08 2-7.8 3.92a18.18 18.18 0 00-2.64 3.84v.02h-.01L4 14l-.45-.21-.1.21.1.21L4 14l-.45.21.01.03a5.85 5.85 0 00.16.32c.11.2.28.51.5.87a18.18 18.18 0 002.4 3.12l.71-.71A17.18 17.18 0 014.56 14a10.05 10.05 0 01.52-.91c.41-.69 1.04-1.6 1.85-2.5C8.58 8.75 10.95 7 14 7a8 8 0 013.4.77l.75-.75zm-3.11 3.12a4 4 0 00-4.9 4.9l.86-.87V14a3 3 0 013.17-3l.87-.86zm1.96 3.7l.86-.88a4 4 0 01-4.9 4.9l.87-.86A3 3 0 0017 13.83zm-6.4 6.4A8 8 0 0014 21c3.05 0 5.42-1.76 7.07-3.58A17.18 17.18 0 0023.44 14a9.47 9.47 0 00-.52-.91 17.18 17.18 0 00-2.25-2.93l.7-.7a18.18 18.18 0 013.06 4.3l.02.02L24 14l.45.21-.01.03a7.03 7.03 0 01-.16.32c-.11.2-.28.51-.5.87-.44.72-1.1 1.69-1.97 2.65C20.08 20.01 17.45 22 14 22c-1.55 0-2.94-.4-4.15-1.02l.75-.75zM24 14l.45-.21.1.21-.1.21L24 14zM22.2 6.5L6.5 22.2l-.7-.7L21.5 5.8l.7.7z"/></svg>'},867174:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><g fill="none" fill-rule="evenodd" stroke="currentColor" transform="translate(6 4)"><rect width="15" height="12" rx="2" x=".5" y="7.5"/><path stroke-linecap="round" stroke-width="2" d="M8 14v2"/><path d="M11.5 7.5V4a3.5 3.5 0 0 0-7 0v3.5"/></g></svg>'},124e3:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 162 28" width="162" height="28"><path fill="currentColor" d="M130.37 7.21c0 .99-.83 1.78-1.87 1.78-1 0-1.84-.8-1.84-1.78s.85-1.77 1.84-1.77c1.04 0 1.87.8 1.87 1.77M130 21h-3V10h3zM84.54 9.02c1.04 0 1.87-.8 1.87-1.77 0-.99-.83-1.78-1.87-1.78-1 0-1.84.8-1.84 1.78s.85 1.77 1.84 1.77M83 21h3V10h-3zM46 21h-3V9h-4V6h11v3h-4zM53 21l-3 .02V10h3v1.88c.36-1 1.34-1.75 2.53-1.75h.03c.3 0 .6 0 .94.1v2.84a4 4 0 0 0-1.31-.2c-1.38 0-2.19 1-2.19 2.7zM91 21h-3V10.01l3-.01v1q.85-1.22 2.9-1.21c2.57 0 4.1 1.8 4.1 4.45V21h-3v-6c0-1.47-.56-2.66-1.77-2.66-1.36 0-2.23.93-2.23 2.89zM120 21l6-15h-3.5l-4 10.5L114 6h-3.5l6.5 15zM156.45 21h-2.93l-2.02-6.25-2 6.25h-2.93L143 10h3.14l2.05 7.04 2.17-7.04h2.26l2.2 7.04 2.02-7.04H160zM61.92 21.24c1.52 0 2.57-.77 3.08-1.47V21h3V10h-3v1.23a3.8 3.8 0 0 0-3.08-1.47c-2.93 0-5.17 2.64-5.17 5.74s2.24 5.74 5.17 5.74m.64-2.75c-1.68 0-2.78-1.25-2.78-2.99s1.1-3 2.78-3 2.77 1.26 2.77 3-1.1 3-2.77 3M78 19.77c-.5.7-1.56 1.47-3.08 1.47-2.93 0-5.17-2.64-5.17-5.74s2.24-5.74 5.17-5.74c1.52 0 2.57.77 3.08 1.47V6h3v15h-3zm-5.22-4.27c0 1.74 1.1 3 2.78 3s2.77-1.26 2.77-3-1.1-3-2.77-3c-1.68 0-2.78 1.26-2.78 3M105.23 25.82c3.36 0 5.77-1.72 5.77-5.68V10h-3v1.23a3.6 3.6 0 0 0-3.06-1.47c-2.88 0-5.2 2.46-5.2 5.56 0 3.08 2.32 5.68 5.2 5.68a3.8 3.8 0 0 0 3.06-1.58v.74c0 1.76-1.04 3.02-2.82 3.02a4.8 4.8 0 0 1-3.43-1.37l-1.65 2.25c1.25 1.2 3.21 1.76 5.13 1.76m.35-7.68a2.75 2.75 0 0 1-2.8-2.82c0-1.69 1.28-2.81 2.8-2.81s2.8 1.12 2.8 2.81a2.75 2.75 0 0 1-2.8 2.82M142.78 18.72a6 6 0 0 1-5.1 2.47c-3.28 0-5.83-2.27-5.83-5.74a5.6 5.6 0 0 1 5.78-5.75c2.89 0 5.42 1.83 5.42 5.42v.16c0 .25 0 .6-.05.97h-8.23c.18 1.47 1.48 2.19 2.93 2.19 1.39 0 2.33-.62 2.84-1.39zm-5.23-6.53c-1.13 0-2.38.57-2.67 1.91h5.15c-.26-1.32-1.36-1.91-2.48-1.91M14 6H2v6h6v9h6zm12 15h-7l6-15h7zm-7-9a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/></svg>'},16242:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M13.5 24a9.5 9.5 0 1 0 0-19 9.5 9.5 0 0 0 0 19zm0 1a10.5 10.5 0 1 0 0-21 10.5 10.5 0 0 0 0 21zM11 10h1v9h-1v-9zm5 0h-1v9h1v-9z"/></svg>'},52108:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M23 14.5a9.5 9.5 0 1 1-19 0 9.5 9.5 0 0 1 19 0zm1 0a10.5 10.5 0 1 1-21 0 10.5 10.5 0 0 1 21 0zM11.3 9.6l-.8-.6v11l.8-.6 6-4.5.53-.4-.53-.4-6-4.5zm4.87 4.9L11.5 18v-7l4.67 3.5z"/></svg>'},740008:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none"><path stroke="currentColor" d="M5.5 16.5c1 3 7 7 11 7 2-4 2-8.5 2-8.5s-1-3.5-2-4-4.5.5-4.5.5-3 3.5-6.5 5z"/><path stroke="currentColor" d="M15.5 11l3-6s.5-1 1.5-.5.5 1.5.5 1.5l-3 6M12 11.5l6.5 3.5M7.5 19c2-.5 4-2.5 4-2.5m0 5.5c2-1 3-3.5 3-3.5"/></svg>'},651124:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" fill-rule="evenodd" d="M7 6h4a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1ZM5 7c0-1.1.9-2 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7Zm12-1h4a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1Zm-2 1c0-1.1.9-2 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2V7Zm-4 9H7a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1Zm-4-1a2 2 0 0 0-2 2v4c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2H7Zm10 1h4a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1Zm-2 1c0-1.1.9-2 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-4Z"/></svg>'},435730:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><rect width="18" height="18" fill="#EC407A" rx="9" opacity=".15"/><path fill="#C2185B" d="M13.4 5.9c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.45-1.96-.45-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.71.4-.48.86-.72 1.4-.72.56 0 1.31.16 2.27.46.95.3 1.62.45 2.01.45.64 0 1.06-.3 1.27-.9h1.03zm0 3.87c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.46-1.96-.46-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.7.4-.48.86-.72 1.4-.72.56 0 1.31.15 2.27.46.95.3 1.62.44 2.01.44.64 0 1.06-.3 1.27-.9h1.03z"/></svg>'},258567:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M5.5 6C4.67 6 4 6.67 4 7.5V20.5c0 .83.67 1.5 1.5 1.5H16v-1H5.5a.5.5 0 0 1-.5-.5V12h16v1h1V9.5c0-.83-.67-1.5-1.5-1.5h-8.8L9.86 6.15 9.71 6H5.5zM21 11H5V7.5c0-.28.22-.5.5-.5h3.8l1.85 1.85.14.15h9.21c.28 0 .5.22.5.5V11zm1 11v-3h3v-1h-3v-3h-1v3h-3v1h3v3h1z"/></svg>'},539403:e=>{"use strict"
;e.exports=JSON.parse('{"4":["v",["h",0,2],["h",1,3]],"6":["v",["h",0,2,4],["h",1,3,5]],"8":["v",["h",0,2,4,6],["h",1,3,5,7]],"s":0,"2h":["h",0,1],"2v":["v",0,1],"3h":["h",0,1,2],"3v":["v",0,1,2],"3s":["h",0,["v",1,2]],"3r":["h",["v",0,1],2],"2-1":["v",["h",0,2],1],"1-2":["v",0,["h",1,2]],"4v":["v",0,1,2,3],"4h":["h",0,1,2,3],"4s":["h",0,["v",1,2,3]],"4s-l":["h",["v",1,2,3],0],"1-3":["v",0,["h",1,2,3]],"3-1":["v",["h",0,1,2],3],"2-2-l":["h",0,1,["v",2,3]],"2-2-r":["h",["v",0,1],2,3],"2-2":["v",["h",0,1],["v",2,3]],"1-4":["v",0,["h",1,2,3,4]],"5h":["h",0,1,2,3,4],"5v":["v",0,1,2,3,4],"5s":["h",0,["v",1,2,3,4]],"5s-l":["h",["v",1,2,3,4],0],"2-3":["v",["h",0,1],["h",2,3,4]],"3-2":["v",["h",0,1,2],["h",3,4]],"4-1":["v",["h",0,1,2,3],4],"2-3-l":["h",0,1,["v",2,3,4]],"2-3-r":["h",["v",0,1,2],3,4],"6h":["h",0,1,2,3,4,5],"6v":["v",0,1,2,3,4,5],"6c":["v",["h",0,1],["h",2,3],["h",4,5]],"2-4":["v",["h",0,1],["h",2,3,4,5]],"4-2":["v",["h",0,1,2,3],["h",4,5]],"4-3":["v",["h",0,1,2,3],["h",4,5,6]],"7h":["h",0,1,2,3,4,5,6],"7s":["h",0,["v",1,2,3,4,5,6]],"8c":["v",["h",0,1],["h",2,3],["h",4,5],["h",6,7]],"8h":["h",0,1,2,3,4,5,6,7],"8v":["v",0,1,2,3,4,5,6,7],"9s":["v",["h",0,1,2],["h",3,4,5],["h",6,7,8]],"5-4":["v",["h",0,1,2,3,4],["h",5,6,7,8]],"9h":["h",0,1,2,3,4,5,6,7,8],"9v":["v",0,1,2,3,4,5,6,7,8],"10c5":["v",["h",0,2,4,6,8],["h",1,3,5,7,9]],"10h":["h",0,1,2,3,4,5,6,7,8,9],"10v":["v",0,1,2,3,4,5,6,7,8,9],"12c6":["v",["h",0,2,4,6,8,10],["h",1,3,5,7,9,11]],"12c4":["v",["h",0,4,8],["h",1,5,9],["h",2,6,10],["h",3,7,11]],"12h":["h",0,1,2,3,4,5,6,7,8,9,10,11],"14c7":["v",["h",0,2,4,6,8,10,12],["h",1,3,5,7,9,11,13]],"16c8":["v",["h",0,2,4,6,8,10,12,14],["h",1,3,5,7,9,11,13,15]],"16c4":["v",["h",0,4,8,12],["h",1,5,9,13],["h",2,6,10,14],["h",3,7,11,15]]}')}}]);